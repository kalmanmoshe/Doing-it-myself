import { Context } from "./utils/context";
import { keyboardAutoReplaceHebrewToEnglishTriggers } from "./staticData/mathParserStaticData";
import { setSelectionToNextTabstop } from "./snippets/snippet_management";
import { runSnippets } from "./features/run_snippets";
import { getLatexSuiteConfig } from "./snippets/codemirror/config";
import { runAutoFraction } from "./features/autofraction";
import { runMatrixShortcuts } from "./features/matrix_shortcuts";
import { shouldTaboutByCloseBracket, tabout } from "./features/tabout";
import { handleMathTooltip } from "./editor_extensions/math_tooltip";
import { removeAllTabstops } from "./snippets/codemirror/tabstops_state_field";
import { clearSnippetQueue } from "./snippets/codemirror/snippet_queue_state_field";
import { handleUndoRedo } from "./snippets/codemirror/history";
import { suggestor } from "./suggestor";
import { Direction, getCharacterAtPos, isComposing, replaceRange, setCursor } from "./utils/editor_utils";
/*
class="cm-gutters" aria-hidden="true" style="min-height: 7865px; position: sticky;"
spellcheck="false" autocorrect="off" translate="no" contenteditable="true"

*/
export const onScroll = (event, view) => {
    suggestor.updatePositionFromView(view);
};
export const onMove = (event, view) => {
    if (!suggestor.isSuggesterDeployed()) {
        return;
    }
    const suggestionItems = document.body.querySelectorAll(".suggestion-item");
    const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (clickedSuggestion) {
        const index = Array.from(suggestionItems).indexOf(clickedSuggestion);
        suggestor.setSelectionIndex(index);
    }
};
export const onClick = (event, view) => {
    if (!suggestor.isSuggesterDeployed()) {
        return;
    }
    const suggestionItems = document.body.querySelectorAll(".suggestion-item");
    // Check if the click is on a suggestion item
    const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (clickedSuggestion) {
        suggestor.selectDropdownItem(view);
    }
    const dropdownItem = document.body.querySelector(".suggestion-dropdown");
    const clickedDropdown = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (!clickedDropdown) {
        suggestor.close();
    }
};
export const onKeydown = (event, view) => {
    let key = event.key;
    let trigger;
    const ctx = Context.fromView(view);
    if (!(event.ctrlKey || event.metaKey) && ctx.shouldTranslate()) {
        trigger = keyboardAutoReplaceHebrewToEnglishTriggers.find((trigger2) => trigger2.key === event.key && trigger2.code === event.code);
        key = (trigger === null || trigger === void 0 ? void 0 : trigger.replacement) || key;
    }
    if (suggestor.isSuggesterDeployed()) {
        suggestor.handleDropdownNavigation(event, view);
    }
    const success = handleKeydown(key, event.shiftKey, event.ctrlKey || event.metaKey, isComposing(view, event), view, ctx);
    if (success)
        event.preventDefault();
    else if (key !== event.key && trigger) {
        event.preventDefault();
        key = trigger.replacement;
        replaceRange(view, view.state.selection.main.from, view.state.selection.main.to, key);
        setCursor(view, view.state.selection.main.from + key.length);
    }
};
export const onTransaction = (update) => {
    if (update.transactions[0] && update.transactions[0].docChanged) {
        const ctx = Context.fromView(update.view);
        if (ctx.codeblockLanguage === "tikz") {
            suggestor.open(ctx, update.view);
        }
    }
    const settings = getLatexSuiteConfig(update.state);
    // The math tooltip handler is driven by view updates because it utilizes
    // information about visual line, which is not available in EditorState
    if (settings.mathPreviewEnabled) {
        handleMathTooltip(update);
    }
    handleUndoRedo(update);
};
export const handleKeydown = (key, shiftKey, ctrlKey, isIME, view, ctx) => {
    const settings = getLatexSuiteConfig(view);
    let success = false;
    /*
    * When backspace is pressed, if the cursor is inside an empty inline math,
    * delete both $ symbols, not just the first one.
    */
    if (settings.autoDelete$ && key === "Backspace" && ctx.mode.inMath()) {
        const charAtPos = getCharacterAtPos(view, ctx.pos);
        const charAtPrevPos = getCharacterAtPos(view, ctx.pos - 1);
        if (charAtPos === "$" && charAtPrevPos === "$") {
            replaceRange(view, ctx.pos - 1, ctx.pos + 1, "");
            // Note: not sure if removeAllTabstops is necessary
            removeAllTabstops(view);
            return true;
        }
    }
    if (settings.snippetsEnabled) {
        // Prevent IME from triggering keydown events.
        if (settings.suppressSnippetTriggerOnIME && isIME)
            return;
        // Allows Ctrl + z for undo, instead of triggering a snippet ending with z
        if (!ctrlKey) {
            try {
                success = runSnippets(view, ctx, key);
                if (success)
                    return true;
            }
            catch (e) {
                clearSnippetQueue(view);
                console.error(e);
            }
        }
    }
    if (key === "Tab") {
        success = setSelectionToNextTabstop(view);
        if (success)
            return true;
    }
    if (ctx.mode.strictlyInMath()) {
        if (key === "/") {
            success = runAutoFraction(view, ctx);
            if (success)
                return true;
        }
    }
    if (settings.matrixShortcutsEnabled && ctx.mode.blockMath) {
        if (["Tab", "Enter"].contains(key)) {
            success = runMatrixShortcuts(view, ctx, key, shiftKey);
            if (success)
                return true;
        }
    }
    if (key === "Tab" && shiftKey) {
        success = tabout(view, ctx, Direction.Backward);
        if (success)
            return true;
    }
    if (key === "Tab" || shouldTaboutByCloseBracket(view, key)) {
        success = tabout(view, ctx, Direction.Forward);
        if (success)
            return true;
    }
    return false;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiIGlucHV0TW9uaXRvcnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvIGlucHV0TW9uaXRvcnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSwwQ0FBMEMsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQy9GLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsbUJBQW1CLEVBQWdDLE1BQU0sOEJBQThCLENBQUM7QUFDakcsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzFELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ2pFLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUN2RSxPQUFPLEVBQThDLGlCQUFpQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFDakgsT0FBTyxFQUFFLGlCQUFpQixFQUFzQixNQUFNLDRDQUE0QyxDQUFDO0FBQ25HLE9BQU8sRUFBRSxpQkFBaUIsRUFBMEIsTUFBTSxpREFBaUQsQ0FBQztBQUM1RyxPQUFPLEVBQUUsY0FBYyxFQUEwQixNQUFNLCtCQUErQixDQUFDO0FBQ3ZGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTFHOzs7O0VBSUU7QUFFRixNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUMsQ0FBQyxLQUFZLEVBQUMsSUFBZ0IsRUFBQyxFQUFFO0lBQ3RELFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJ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QUUsQ0FBQztRQUMzRCxJQUFJLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3BDLE9BQU8sR0FBRyxrQkFBa0IsQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUN2RCxJQUFJLE9BQU87Z0JBQUUsT0FBTyxJQUFJLENBQUM7UUFDMUIsQ0FBQztJQUNGLENBQUM7SUFDRCxJQUFJLEdBQUcsS0FBSyxLQUFLLElBQUUsUUFBUSxFQUFFLENBQUM7UUFDN0IsT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUMvQyxJQUFJLE9BQU87WUFBRSxPQUFPLElBQUksQ0FBQztJQUMxQixDQUFDO0lBQ0QsSUFBSSxHQUFHLEtBQUssS0FBSyxJQUFJLDBCQUEwQixDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQzVELE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBQyxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDOUMsSUFBSSxPQUFPO1lBQUUsT0FBTyxJQUFJLENBQUM7SUFDMUIsQ0FBQztJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2QsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IEVkaXRvclZpZXcsIFZpZXdQbHVnaW4sIFZpZXdVcGRhdGUgIH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcclxuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCIuL3V0aWxzL2NvbnRleHRcIjtcclxuaW1wb3J0IHsga2V5Ym9hcmRBdXRvUmVwbGFjZUhlYnJld1RvRW5nbGlzaFRyaWdnZXJzIH0gZnJvbSBcIi4vc3RhdGljRGF0YS9tYXRoUGFyc2VyU3RhdGljRGF0YVwiO1xyXG5pbXBvcnQgeyBzZXRTZWxlY3Rpb25Ub05leHRUYWJzdG9wIH0gZnJvbSBcIi4vc25pcHBldHMvc25pcHBldF9tYW5hZ2VtZW50XCI7IFxyXG5pbXBvcnQgeyBydW5TbmlwcGV0cyB9IGZyb20gXCIuL2ZlYXR1cmVzL3J1bl9zbmlwcGV0c1wiO1xyXG5pbXBvcnQgeyBnZXRMYXRleFN1aXRlQ29uZmlnLCBnZXRMYXRleFN1aXRlQ29uZmlnRXh0ZW5zaW9uIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9jb25maWdcIjtcclxuaW1wb3J0IHsgcnVuQXV0b0ZyYWN0aW9uIH0gZnJvbSBcIi4vZmVhdHVyZXMvYXV0b2ZyYWN0aW9uXCI7XHJcbmltcG9ydCB7IHJ1bk1hdHJpeFNob3J0Y3V0cyB9IGZyb20gXCIuL2ZlYXR1cmVzL21hdHJpeF9zaG9ydGN1dHNcIjtcclxuaW1wb3J0IHsgc2hvdWxkVGFib3V0QnlDbG9zZUJyYWNrZXQsIHRhYm91dCB9IGZyb20gXCIuL2ZlYXR1cmVzL3RhYm91dFwiO1xyXG5pbXBvcnQgeyBjdXJzb3JUb29sdGlwQmFzZVRoZW1lLCBjdXJzb3JUb29sdGlwRmllbGQsIGhhbmRsZU1hdGhUb29sdGlwIH0gZnJvbSBcIi4vZWRpdG9yX2V4dGVuc2lvbnMvbWF0aF90b29sdGlwXCI7XHJcbmltcG9ydCB7IHJlbW92ZUFsbFRhYnN0b3BzLCB0YWJzdG9wc1N0YXRlRmllbGQgfSBmcm9tIFwiLi9zbmlwcGV0cy9jb2RlbWlycm9yL3RhYnN0b3BzX3N0YXRlX2ZpZWxkXCI7XHJcbmltcG9ydCB7IGNsZWFyU25pcHBldFF1ZXVlLCBzbmlwcGV0UXVldWVTdGF0ZUZpZWxkIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XHJcbmltcG9ydCB7IGhhbmRsZVVuZG9SZWRvLCBzbmlwcGV0SW52ZXJ0ZWRFZmZlY3RzIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9oaXN0b3J5XCI7XHJcbmltcG9ydCB7IHN1Z2dlc3RvciB9IGZyb20gXCIuL3N1Z2dlc3RvclwiO1xyXG5pbXBvcnQgeyBEaXJlY3Rpb24sIGdldENoYXJhY3RlckF0UG9zLCBpc0NvbXBvc2luZywgcmVwbGFjZVJhbmdlLCBzZXRDdXJzb3IgfSBmcm9tIFwiLi91dGlscy9lZGl0b3JfdXRpbHNcIjtcclxuXHJcbi8qXHJcbmNsYXNzPVwiY20tZ3V0dGVyc1wiIGFyaWEtaGlkZGVuPVwidHJ1ZVwiIHN0eWxlPVwibWluLWhlaWdodDogNzg2NXB4OyBwb3NpdGlvbjogc3RpY2t5O1wiXHJcbnNwZWxsY2hlY2s9XCJmYWxzZVwiIGF1dG9jb3JyZWN0PVwib2ZmXCIgdHJhbnNsYXRlPVwibm9cIiBjb250ZW50ZWRpdGFibGU9XCJ0cnVlXCJcclxuXHJcbiovXHJcblxyXG5leHBvcnQgY29uc3Qgb25TY3JvbGw9KGV2ZW50OiBFdmVudCx2aWV3OiBFZGl0b3JWaWV3KT0+e1xyXG5cdHN1Z2dlc3Rvci51cGRhdGVQb3NpdGlvbkZyb21WaWV3KHZpZXcpO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IG9uTW92ZT0oZXZlbnQ6IE1vdXNlRXZlbnQsdmlldzogRWRpdG9yVmlldyk9PntcclxuXHRpZighc3VnZ2VzdG9yLmlzU3VnZ2VzdGVyRGVwbG95ZWQoKSl7cmV0dXJufVxyXG5cdGNvbnN0IHN1Z2dlc3Rpb25JdGVtcyA9IGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIik7XHJcblx0Y29uc3QgY2xpY2tlZFN1Z2dlc3Rpb24gPSBBcnJheS5mcm9tKHN1Z2dlc3Rpb25JdGVtcykuZmluZCgoaXRlbSkgPT5cclxuXHRcdGl0ZW0uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpXHJcblx0KTtcclxuXHRpZiAoY2xpY2tlZFN1Z2dlc3Rpb24pIHtcclxuXHRcdGNvbnN0IGluZGV4ID0gQXJyYXkuZnJvbShzdWdnZXN0aW9uSXRlbXMpLmluZGV4T2YoY2xpY2tlZFN1Z2dlc3Rpb24pO1xyXG5cdFx0c3VnZ2VzdG9yLnNldFNlbGVjdGlvbkluZGV4KGluZGV4KVxyXG5cdH1cclxufVxyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBvbkNsaWNrPShldmVudDogTW91c2VFdmVudCx2aWV3OiBFZGl0b3JWaWV3KT0+e1xyXG5cdGlmKCFzdWdnZXN0b3IuaXNTdWdnZXN0ZXJEZXBsb3llZCgpKXtyZXR1cm59XHJcblx0Y29uc3Qgc3VnZ2VzdGlvbkl0ZW1zID0gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yQWxsKFwiLnN1Z2dlc3Rpb24taXRlbVwiKTtcclxuXHJcblx0Ly8gQ2hlY2sgaWYgdGhlIGNsaWNrIGlzIG9uIGEgc3VnZ2VzdGlvbiBpdGVtXHJcblx0Y29uc3QgY2xpY2tlZFN1Z2dlc3Rpb24gPSBBcnJheS5mcm9tKHN1Z2dlc3Rpb25JdGVtcykuZmluZCgoaXRlbSkgPT5cclxuXHRcdGl0ZW0uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpXHJcblx0KTtcclxuXHRpZiAoY2xpY2tlZFN1Z2dlc3Rpb24pIHtcclxuXHRcdHN1Z2dlc3Rvci5zZWxlY3REcm9wZG93bkl0ZW0odmlldyk7XHJcblx0fVxyXG5cdGNvbnN0IGRyb3Bkb3duSXRlbSA9IGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcihcIi5zdWdnZXN0aW9uLWRyb3Bkb3duXCIpO1xyXG5cdGNvbnN0IGNsaWNrZWREcm9wZG93biA9IEFycmF5LmZyb20oc3VnZ2VzdGlvbkl0ZW1zKS5maW5kKChpdGVtKSA9PlxyXG5cdFx0aXRlbS5jb250YWlucyhldmVudC50YXJnZXQgYXMgTm9kZSlcclxuXHQpO1xyXG5cdGlmKCFjbGlja2VkRHJvcGRvd24pe1xyXG5cdFx0c3VnZ2VzdG9yLmNsb3NlKClcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBvbktleWRvd24gPSAoZXZlbnQ6IEtleWJvYXJkRXZlbnQsIHZpZXc6IEVkaXRvclZpZXcpID0+IHtcclxuXHRsZXQga2V5ID0gZXZlbnQua2V5O1xyXG5cdGxldCB0cmlnZ2VyXHJcblx0Y29uc3QgY3R4ID0gQ29udGV4dC5mcm9tVmlldyh2aWV3KTtcclxuXHRpZiAoIShldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpICYmIGN0eC5zaG91bGRUcmFuc2xhdGUoKSkge1xyXG5cdCAgdHJpZ2dlciA9IGtleWJvYXJkQXV0b1JlcGxhY2VIZWJyZXdUb0VuZ2xpc2hUcmlnZ2Vycy5maW5kKCh0cmlnZ2VyMikgPT4gdHJpZ2dlcjIua2V5ID09PSBldmVudC5rZXkgJiYgdHJpZ2dlcjIuY29kZSA9PT0gZXZlbnQuY29kZSk7XHJcblx0ICBrZXkgPSB0cmlnZ2VyPy5yZXBsYWNlbWVudHx8a2V5O1xyXG5cdH1cclxuXHRpZihzdWdnZXN0b3IuaXNTdWdnZXN0ZXJEZXBsb3llZCgpKXtcclxuXHRcdHN1Z2dlc3Rvci5oYW5kbGVEcm9wZG93bk5hdmlnYXRpb24oZXZlbnQsdmlldylcclxuXHR9XHJcblx0XHJcblx0Y29uc3Qgc3VjY2VzcyA9IGhhbmRsZUtleWRvd24oa2V5LCBldmVudC5zaGlmdEtleSwgZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5LCBpc0NvbXBvc2luZyh2aWV3LCBldmVudCksIHZpZXcsY3R4KTtcclxuXHRpZiAoc3VjY2VzcylcclxuXHQgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0ZWxzZSBpZiAoa2V5ICE9PSBldmVudC5rZXkmJnRyaWdnZXIpIHtcclxuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0XHRrZXkgPSB0cmlnZ2VyLnJlcGxhY2VtZW50O1xyXG5cdFx0cmVwbGFjZVJhbmdlKHZpZXcsdmlldy5zdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tLHZpZXcuc3RhdGUuc2VsZWN0aW9uLm1haW4udG8sa2V5KVxyXG5cdFx0c2V0Q3Vyc29yKHZpZXcsdmlldy5zdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tK2tleS5sZW5ndGgpXHJcbiAgfVxyXG59O1xyXG5leHBvcnQgY29uc3Qgb25UcmFuc2FjdGlvbiA9ICh1cGRhdGU6IFZpZXdVcGRhdGUpID0+IHtcclxuXHRpZih1cGRhdGUudHJhbnNhY3Rpb25zWzBdJiZ1cGRhdGUudHJhbnNhY3Rpb25zWzBdLmRvY0NoYW5nZWQpe1xyXG5cdFx0Y29uc3QgY3R4PUNvbnRleHQuZnJvbVZpZXcodXBkYXRlLnZpZXcpO1xyXG5cdFx0aWYoY3R4LmNvZGVibG9ja0xhbmd1YWdlPT09XCJ0aWt6XCIpe1xyXG5cdFx0XHRzdWdnZXN0b3Iub3BlbihjdHgsdXBkYXRlLnZpZXcpXHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRjb25zdCBzZXR0aW5ncyA9IGdldExhdGV4U3VpdGVDb25maWcodXBkYXRlLnN0YXRlKTtcclxuXHJcblx0Ly8gVGhlIG1hdGggdG9vbHRpcCBoYW5kbGVyIGlzIGRyaXZlbiBieSB2aWV3IHVwZGF0ZXMgYmVjYXVzZSBpdCB1dGlsaXplc1xyXG5cdC8vIGluZm9ybWF0aW9uIGFib3V0IHZpc3VhbCBsaW5lLCB3aGljaCBpcyBub3QgYXZhaWxhYmxlIGluIEVkaXRvclN0YXRlXHJcblx0aWYgKHNldHRpbmdzLm1hdGhQcmV2aWV3RW5hYmxlZCkge1xyXG5cdFx0aGFuZGxlTWF0aFRvb2x0aXAodXBkYXRlKTtcclxuXHR9XHJcblxyXG5cdGhhbmRsZVVuZG9SZWRvKHVwZGF0ZSk7XHJcblxyXG59XHJcblxyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBoYW5kbGVLZXlkb3duID0gKGtleTogc3RyaW5nLCBzaGlmdEtleTogYm9vbGVhbiwgY3RybEtleTogYm9vbGVhbiwgaXNJTUU6IGJvb2xlYW4sIHZpZXc6IEVkaXRvclZpZXcsIGN0eDogQ29udGV4dCkgPT4ge1xyXG5cdGNvbnN0IHNldHRpbmdzID0gZ2V0TGF0ZXhTdWl0ZUNvbmZpZyh2aWV3KTtcclxuXHJcblx0bGV0IHN1Y2Nlc3MgPSBmYWxzZTtcclxuXHJcblx0LypcclxuXHQqIFdoZW4gYmFja3NwYWNlIGlzIHByZXNzZWQsIGlmIHRoZSBjdXJzb3IgaXMgaW5zaWRlIGFuIGVtcHR5IGlubGluZSBtYXRoLFxyXG5cdCogZGVsZXRlIGJvdGggJCBzeW1ib2xzLCBub3QganVzdCB0aGUgZmlyc3Qgb25lLlxyXG5cdCovXHJcblx0aWYgKHNldHRpbmdzLmF1dG9EZWxldGUkICYmIGtleSA9PT0gXCJCYWNrc3BhY2VcIiAmJiBjdHgubW9kZS5pbk1hdGgoKSkge1xyXG5cdFx0Y29uc3QgY2hhckF0UG9zID0gZ2V0Q2hhcmFjdGVyQXRQb3ModmlldywgY3R4LnBvcyk7XHJcblx0XHRjb25zdCBjaGFyQXRQcmV2UG9zID0gZ2V0Q2hhcmFjdGVyQXRQb3ModmlldywgY3R4LnBvcyAtIDEpO1xyXG5cclxuXHRcdGlmIChjaGFyQXRQb3MgPT09IFwiJFwiICYmIGNoYXJBdFByZXZQb3MgPT09IFwiJFwiKSB7XHJcblx0XHRcdHJlcGxhY2VSYW5nZSh2aWV3LCBjdHgucG9zIC0gMSwgY3R4LnBvcyArIDEsIFwiXCIpO1xyXG5cdFx0XHQvLyBOb3RlOiBub3Qgc3VyZSBpZiByZW1vdmVBbGxUYWJzdG9wcyBpcyBuZWNlc3NhcnlcclxuXHRcdFx0cmVtb3ZlQWxsVGFic3RvcHModmlldyk7XHJcblx0XHRcdHJldHVybiB0cnVlO1xyXG5cdFx0fVxyXG5cdH1cclxuXHRcclxuXHRpZiAoc2V0dGluZ3Muc25pcHBldHNFbmFibGVkKSB7XHJcblxyXG5cdFx0Ly8gUHJldmVudCBJTUUgZnJvbSB0cmlnZ2VyaW5nIGtleWRvd24gZXZlbnRzLlxyXG5cdFx0aWYgKHNldHRpbmdzLnN1cHByZXNzU25pcHBldFRyaWdnZXJPbklNRSAmJiBpc0lNRSkgcmV0dXJuO1xyXG5cclxuXHRcdC8vIEFsbG93cyBDdHJsICsgeiBmb3IgdW5kbywgaW5zdGVhZCBvZiB0cmlnZ2VyaW5nIGEgc25pcHBldCBlbmRpbmcgd2l0aCB6XHJcblx0XHRpZiAoIWN0cmxLZXkpIHtcclxuXHRcdFx0dHJ5IHtcclxuXHRcdFx0XHRzdWNjZXNzID0gcnVuU25pcHBldHModmlldywgY3R4LCBrZXkpO1xyXG5cdFx0XHRcdGlmIChzdWNjZXNzKSByZXR1cm4gdHJ1ZTtcclxuXHRcdFx0fVxyXG5cdFx0XHRjYXRjaCAoZSkge1xyXG5cdFx0XHRcdGNsZWFyU25pcHBldFF1ZXVlKHZpZXcpO1xyXG5cdFx0XHRcdGNvbnNvbGUuZXJyb3IoZSk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGlmIChrZXkgPT09IFwiVGFiXCIpIHtcclxuXHRcdHN1Y2Nlc3MgPSBzZXRTZWxlY3Rpb25Ub05leHRUYWJzdG9wKHZpZXcpO1xyXG5cdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHJcblx0aWYgKGN0eC5tb2RlLnN0cmljdGx5SW5NYXRoKCkpIHtcclxuXHRcdGlmIChrZXkgPT09IFwiL1wiKSB7XHJcblx0XHRcdHN1Y2Nlc3MgPSBydW5BdXRvRnJhY3Rpb24odmlldywgY3R4KTtcclxuXHRcdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0aWYgKHNldHRpbmdzLm1hdHJpeFNob3J0Y3V0c0VuYWJsZWQgJiYgY3R4Lm1vZGUuYmxvY2tNYXRoKSB7XHJcblx0XHRpZiAoW1wiVGFiXCIsIFwiRW50ZXJcIl0uY29udGFpbnMoa2V5KSkge1xyXG5cdFx0XHRzdWNjZXNzID0gcnVuTWF0cml4U2hvcnRjdXRzKHZpZXcsIGN0eCwga2V5LCBzaGlmdEtleSk7XHJcblx0XHRcdGlmIChzdWNjZXNzKSByZXR1cm4gdHJ1ZTtcclxuXHRcdH1cclxuXHR9XHJcblx0aWYgKGtleSA9PT0gXCJUYWJcIiYmc2hpZnRLZXkpIHtcclxuXHRcdHN1Y2Nlc3MgPSB0YWJvdXQodmlldywgY3R4LERpcmVjdGlvbi5CYWNrd2FyZCk7XHJcblx0XHRpZiAoc3VjY2VzcykgcmV0dXJuIHRydWU7XHJcblx0fVxyXG5cdGlmIChrZXkgPT09IFwiVGFiXCIgfHwgc2hvdWxkVGFib3V0QnlDbG9zZUJyYWNrZXQodmlldywga2V5KSkge1xyXG5cdFx0c3VjY2VzcyA9IHRhYm91dCh2aWV3LCBjdHgsRGlyZWN0aW9uLkZvcndhcmQpO1xyXG5cdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHRyZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcbiJdfQ==