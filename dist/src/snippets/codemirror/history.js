import { StateEffect } from "@codemirror/state";
import { invertedEffects, undo, redo } from "@codemirror/commands";
import { removeAllTabstops } from "./tabstops_state_field";
// Effects that mark the beginning and end of transactions to insert snippets
export const startSnippet = StateEffect.define();
export const endSnippet = StateEffect.define();
export const undidStartSnippet = StateEffect.define();
export const undidEndSnippet = StateEffect.define();
// Enables undoing and redoing snippets, taking care of the tabstops
export const snippetInvertedEffects = invertedEffects.of(tr => {
    const effects = [];
    for (const effect of tr.effects) {
        if (effect.is(startSnippet)) {
            effects.push(undidStartSnippet.of(null));
        }
        else if (effect.is(undidStartSnippet)) {
            effects.push(startSnippet.of(null));
        }
        else if (effect.is(endSnippet)) {
            effects.push(undidEndSnippet.of(null));
        }
        else if (effect.is(undidEndSnippet)) {
            effects.push(endSnippet.of(null));
        }
    }
    return effects;
});
export const handleUndoRedo = (update) => {
    const undoTr = update.transactions.find(tr => tr.isUserEvent("undo"));
    const redoTr = update.transactions.find(tr => tr.isUserEvent("redo"));
    for (const tr of update.transactions) {
        for (const effect of tr.effects) {
            if (effect.is(startSnippet)) {
                if (redoTr) {
                    // Redo the tabstop expansion and selection
                    redo(update.view);
                }
            }
            else if (effect.is(undidEndSnippet)) {
                if (undoTr) {
                    // Undo the tabstop expansion and selection
                    undo(update.view);
                }
            }
        }
    }
    if (undoTr) {
        removeAllTabstops(update.view);
    }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlzdG9yeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9zbmlwcGV0cy9jb2RlbWlycm9yL2hpc3RvcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxlQUFlLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ25FLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTNELDZFQUE2RTtBQUM3RSxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ2pELE1BQU0sQ0FBQyxNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDL0MsTUFBTSxDQUFDLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3RELE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBRyxXQUFXLENBQUMsTUFBTSxFQUFFLENBQUM7QUFHcEQsb0VBQW9FO0FBQ3BFLE1BQU0sQ0FBQyxNQUFNLHNCQUFzQixHQUFHLGVBQWUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUU7SUFDN0QsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBRW5CLEtBQUssTUFBTSxNQUFNLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQ2pDLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO1lBQzdCLE9BQU8sQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDMUMsQ0FBQzthQUNJLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxFQUFFLENBQUM7WUFDdkMsT0FBTyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckMsQ0FBQzthQUNJLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsRUFBRSxDQUFDO1lBQ2hDLE9BQU8sQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3hDLENBQUM7YUFDSSxJQUFJLE1BQU0sQ0FBQyxFQUFFLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQztZQUNyQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUNuQyxDQUFDO0lBQ0YsQ0FBQztJQUdELE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUMsQ0FBQyxDQUFDO0FBR0gsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLENBQUMsTUFBa0IsRUFBRSxFQUFFO0lBQ3BELE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3RFLE1BQU0sTUFBTSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBR3RFLEtBQUssTUFBTSxFQUFFLElBQUksTUFBTSxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3RDLEtBQUssTUFBTSxNQUFNLElBQUksRUFBRSxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBRWpDLElBQUksTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLENBQUMsRUFBRSxDQUFDO2dCQUM3QixJQUFJLE1BQU0sRUFBRSxDQUFDO29CQUNaLDJDQUEyQztvQkFDM0MsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDbkIsQ0FBQztZQUNGLENBQUM7aUJBQ0ksSUFBSSxNQUFNLENBQUMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7Z0JBQ3JDLElBQUksTUFBTSxFQUFFLENBQUM7b0JBQ1osMkNBQTJDO29CQUMzQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNuQixDQUFDO1lBQ0YsQ0FBQztRQUNGLENBQUM7SUFDRixDQUFDO0lBRUQsSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUNaLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNoQyxDQUFDO0FBQ0YsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVmlld1VwZGF0ZSB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IFN0YXRlRWZmZWN0IH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XHJcbmltcG9ydCB7IGludmVydGVkRWZmZWN0cywgdW5kbywgcmVkbyB9IGZyb20gXCJAY29kZW1pcnJvci9jb21tYW5kc1wiO1xyXG5pbXBvcnQgeyByZW1vdmVBbGxUYWJzdG9wcyB9IGZyb20gXCIuL3RhYnN0b3BzX3N0YXRlX2ZpZWxkXCI7XHJcblxyXG4vLyBFZmZlY3RzIHRoYXQgbWFyayB0aGUgYmVnaW5uaW5nIGFuZCBlbmQgb2YgdHJhbnNhY3Rpb25zIHRvIGluc2VydCBzbmlwcGV0c1xyXG5leHBvcnQgY29uc3Qgc3RhcnRTbmlwcGV0ID0gU3RhdGVFZmZlY3QuZGVmaW5lKCk7XHJcbmV4cG9ydCBjb25zdCBlbmRTbmlwcGV0ID0gU3RhdGVFZmZlY3QuZGVmaW5lKCk7XHJcbmV4cG9ydCBjb25zdCB1bmRpZFN0YXJ0U25pcHBldCA9IFN0YXRlRWZmZWN0LmRlZmluZSgpO1xyXG5leHBvcnQgY29uc3QgdW5kaWRFbmRTbmlwcGV0ID0gU3RhdGVFZmZlY3QuZGVmaW5lKCk7XHJcblxyXG5cclxuLy8gRW5hYmxlcyB1bmRvaW5nIGFuZCByZWRvaW5nIHNuaXBwZXRzLCB0YWtpbmcgY2FyZSBvZiB0aGUgdGFic3RvcHNcclxuZXhwb3J0IGNvbnN0IHNuaXBwZXRJbnZlcnRlZEVmZmVjdHMgPSBpbnZlcnRlZEVmZmVjdHMub2YodHIgPT4ge1xyXG5cdGNvbnN0IGVmZmVjdHMgPSBbXTtcclxuXHJcblx0Zm9yIChjb25zdCBlZmZlY3Qgb2YgdHIuZWZmZWN0cykge1xyXG5cdFx0aWYgKGVmZmVjdC5pcyhzdGFydFNuaXBwZXQpKSB7XHJcblx0XHRcdGVmZmVjdHMucHVzaCh1bmRpZFN0YXJ0U25pcHBldC5vZihudWxsKSk7XHJcblx0XHR9XHJcblx0XHRlbHNlIGlmIChlZmZlY3QuaXModW5kaWRTdGFydFNuaXBwZXQpKSB7XHJcblx0XHRcdGVmZmVjdHMucHVzaChzdGFydFNuaXBwZXQub2YobnVsbCkpO1xyXG5cdFx0fVxyXG5cdFx0ZWxzZSBpZiAoZWZmZWN0LmlzKGVuZFNuaXBwZXQpKSB7XHJcblx0XHRcdGVmZmVjdHMucHVzaCh1bmRpZEVuZFNuaXBwZXQub2YobnVsbCkpO1xyXG5cdFx0fVxyXG5cdFx0ZWxzZSBpZiAoZWZmZWN0LmlzKHVuZGlkRW5kU25pcHBldCkpIHtcclxuXHRcdFx0ZWZmZWN0cy5wdXNoKGVuZFNuaXBwZXQub2YobnVsbCkpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblxyXG5cdHJldHVybiBlZmZlY3RzO1xyXG59KTtcclxuXHJcblxyXG5leHBvcnQgY29uc3QgaGFuZGxlVW5kb1JlZG8gPSAodXBkYXRlOiBWaWV3VXBkYXRlKSA9PiB7XHJcblx0Y29uc3QgdW5kb1RyID0gdXBkYXRlLnRyYW5zYWN0aW9ucy5maW5kKHRyID0+IHRyLmlzVXNlckV2ZW50KFwidW5kb1wiKSk7XHJcblx0Y29uc3QgcmVkb1RyID0gdXBkYXRlLnRyYW5zYWN0aW9ucy5maW5kKHRyID0+IHRyLmlzVXNlckV2ZW50KFwicmVkb1wiKSk7XHJcblxyXG5cclxuXHRmb3IgKGNvbnN0IHRyIG9mIHVwZGF0ZS50cmFuc2FjdGlvbnMpIHtcclxuXHRcdGZvciAoY29uc3QgZWZmZWN0IG9mIHRyLmVmZmVjdHMpIHtcclxuXHJcblx0XHRcdGlmIChlZmZlY3QuaXMoc3RhcnRTbmlwcGV0KSkge1xyXG5cdFx0XHRcdGlmIChyZWRvVHIpIHtcclxuXHRcdFx0XHRcdC8vIFJlZG8gdGhlIHRhYnN0b3AgZXhwYW5zaW9uIGFuZCBzZWxlY3Rpb25cclxuXHRcdFx0XHRcdHJlZG8odXBkYXRlLnZpZXcpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlIGlmIChlZmZlY3QuaXModW5kaWRFbmRTbmlwcGV0KSkge1xyXG5cdFx0XHRcdGlmICh1bmRvVHIpIHtcclxuXHRcdFx0XHRcdC8vIFVuZG8gdGhlIHRhYnN0b3AgZXhwYW5zaW9uIGFuZCBzZWxlY3Rpb25cclxuXHRcdFx0XHRcdHVuZG8odXBkYXRlLnZpZXcpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0aWYgKHVuZG9Ucikge1xyXG5cdFx0cmVtb3ZlQWxsVGFic3RvcHModXBkYXRlLnZpZXcpO1xyXG5cdH1cclxufTtcclxuIl19