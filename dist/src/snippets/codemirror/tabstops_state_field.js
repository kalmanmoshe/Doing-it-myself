import { EditorView, Decoration } from "@codemirror/view";
import { StateEffect, StateField } from "@codemirror/state";
const addTabstopsEffect = StateEffect.define();
const removeAllTabstopsEffect = StateEffect.define();
export const tabstopsStateField = StateField.define({
    create() {
        return [];
    },
    update(value, transaction) {
        let tabstopGroups = value;
        tabstopGroups.forEach(grp => grp.map(transaction.changes));
        for (const effect of transaction.effects) {
            if (effect.is(addTabstopsEffect)) {
                tabstopGroups.unshift(...effect.value);
            }
            else if (effect.is(removeAllTabstopsEffect)) {
                tabstopGroups = [];
            }
        }
        // Remove the tabstop groups that the cursor has passed. This scenario
        // happens when the user manually moves the cursor using arrow keys or mouse
        if (transaction.selection) {
            const currTabstopGroupIndex = getCurrentTabstopGroupIndex(tabstopGroups, transaction.selection);
            tabstopGroups = tabstopGroups.slice(currTabstopGroupIndex);
            if (tabstopGroups.length <= 1) {
                // Clear all tabstop groups if there's just one remaining
                tabstopGroups = [];
            }
            else {
                tabstopGroups[0].hideFromEditor();
            }
        }
        return tabstopGroups;
    },
    provide: (field) => {
        return EditorView.decorations.of(view => {
            // "Flatten" the array of DecorationSets to produce a single DecorationSet
            const tabstopGroups = view.state.field(field);
            const decos = [];
            for (const tabstopGroup of tabstopGroups) {
                if (!tabstopGroup.hidden)
                    decos.push(...tabstopGroup.getRanges());
            }
            return Decoration.set(decos, true);
        });
    }
});
function getCurrentTabstopGroupIndex(tabstopGroups, sel) {
    for (let i = 0; i < tabstopGroups.length; i++) {
        const tabstopGroup = tabstopGroups[i];
        if (tabstopGroup.containsSelection(sel))
            return i;
    }
    return tabstopGroups.length;
}
export function getTabstopGroupsFromView(view) {
    const currentTabstopGroups = view.state.field(tabstopsStateField);
    return currentTabstopGroups;
}
export function addTabstops(view, tabstopGroups) {
    view.dispatch({
        effects: [addTabstopsEffect.of(tabstopGroups)],
    });
}
export function removeAllTabstops(view) {
    view.dispatch({
        effects: [removeAllTabstopsEffect.of(null)],
    });
}
// const COLORS = ["lightskyblue", "orange", "lime"];
const N_COLORS = 3;
export function getNextTabstopColor(view) {
    const field = view.state.field(tabstopsStateField);
    const existingColors = field.map(tabstopGroup => tabstopGroup.color);
    const uniqueExistingColors = new Set(existingColors);
    for (let i = 0; i < N_COLORS; i++) {
        if (!uniqueExistingColors.has(i))
            return i;
    }
    return 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFic3RvcHNfc3RhdGVfZmllbGQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc25pcHBldHMvY29kZW1pcnJvci90YWJzdG9wc19zdGF0ZV9maWVsZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzFELE9BQU8sRUFBbUIsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRzdFLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBa0IsQ0FBQztBQUMvRCxNQUFNLHVCQUF1QixHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVyRCxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFpQjtJQUVuRSxNQUFNO1FBQ0wsT0FBTyxFQUFFLENBQUM7SUFDWCxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssRUFBRSxXQUFXO1FBQ3hCLElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztRQUMxQixhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUUzRCxLQUFLLE1BQU0sTUFBTSxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUMxQyxJQUFJLE1BQU0sQ0FBQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO2dCQUNsQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hDLENBQUM7aUJBQ0ksSUFBSSxNQUFNLENBQUMsRUFBRSxDQUFDLHVCQUF1QixDQUFDLEVBQUUsQ0FBQztnQkFDN0MsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUNwQixDQUFDO1FBQ0YsQ0FBQztRQUVELHNFQUFzRTtR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QUFJLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUVyRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsT0FBTyxDQUFDLENBQUM7QUFDVixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldywgRGVjb3JhdGlvbiB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IEVkaXRvclNlbGVjdGlvbiwgU3RhdGVFZmZlY3QsIFN0YXRlRmllbGQgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgVGFic3RvcEdyb3VwIH0gZnJvbSBcIi4uL3RhYnN0b3BcIjtcclxuXHJcbmNvbnN0IGFkZFRhYnN0b3BzRWZmZWN0ID0gU3RhdGVFZmZlY3QuZGVmaW5lPFRhYnN0b3BHcm91cFtdPigpO1xyXG5jb25zdCByZW1vdmVBbGxUYWJzdG9wc0VmZmVjdCA9IFN0YXRlRWZmZWN0LmRlZmluZSgpO1xyXG5cclxuZXhwb3J0IGNvbnN0IHRhYnN0b3BzU3RhdGVGaWVsZCA9IFN0YXRlRmllbGQuZGVmaW5lPFRhYnN0b3BHcm91cFtdPih7XHJcblxyXG5cdGNyZWF0ZSgpIHtcclxuXHRcdHJldHVybiBbXTtcclxuXHR9LFxyXG5cclxuXHR1cGRhdGUodmFsdWUsIHRyYW5zYWN0aW9uKSB7XHJcblx0XHRsZXQgdGFic3RvcEdyb3VwcyA9IHZhbHVlO1xyXG5cdFx0dGFic3RvcEdyb3Vwcy5mb3JFYWNoKGdycCA9PiBncnAubWFwKHRyYW5zYWN0aW9uLmNoYW5nZXMpKTtcclxuXHJcblx0XHRmb3IgKGNvbnN0IGVmZmVjdCBvZiB0cmFuc2FjdGlvbi5lZmZlY3RzKSB7XHJcblx0XHRcdGlmIChlZmZlY3QuaXMoYWRkVGFic3RvcHNFZmZlY3QpKSB7XHJcblx0XHRcdFx0dGFic3RvcEdyb3Vwcy51bnNoaWZ0KC4uLmVmZmVjdC52YWx1ZSk7XHJcblx0XHRcdH1cclxuXHRcdFx0ZWxzZSBpZiAoZWZmZWN0LmlzKHJlbW92ZUFsbFRhYnN0b3BzRWZmZWN0KSkge1xyXG5cdFx0XHRcdHRhYnN0b3BHcm91cHMgPSBbXTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cclxuXHRcdC8vIFJlbW92ZSB0aGUgdGFic3RvcCBncm91cHMgdGhhdCB0aGUgY3Vyc29yIGhhcyBwYXNzZWQuIFRoaXMgc2NlbmFyaW9cclxuXHRcdC8vIGhhcHBlbnMgd2hlbiB0aGUgdXNlciBtYW51YWxseSBtb3ZlcyB0aGUgY3Vyc29yIHVzaW5nIGFycm93IGtleXMgb3IgbW91c2VcclxuXHRcdGlmICh0cmFuc2FjdGlvbi5zZWxlY3Rpb24pIHtcclxuXHRcdFx0Y29uc3QgY3VyclRhYnN0b3BHcm91cEluZGV4ID0gZ2V0Q3VycmVudFRhYnN0b3BHcm91cEluZGV4KFxyXG5cdFx0XHRcdHRhYnN0b3BHcm91cHMsXHJcblx0XHRcdFx0dHJhbnNhY3Rpb24uc2VsZWN0aW9uXHJcblx0XHRcdCk7XHJcblx0XHRcdHRhYnN0b3BHcm91cHMgPSB0YWJzdG9wR3JvdXBzLnNsaWNlKGN1cnJUYWJzdG9wR3JvdXBJbmRleCk7XHJcblx0XHRcdFxyXG5cdFx0XHRpZiAodGFic3RvcEdyb3Vwcy5sZW5ndGggPD0gMSkge1xyXG5cdFx0XHRcdC8vIENsZWFyIGFsbCB0YWJzdG9wIGdyb3VwcyBpZiB0aGVyZSdzIGp1c3Qgb25lIHJlbWFpbmluZ1xyXG5cdFx0XHRcdHRhYnN0b3BHcm91cHMgPSBbXTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHR0YWJzdG9wR3JvdXBzWzBdLmhpZGVGcm9tRWRpdG9yKCk7XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHRyZXR1cm4gdGFic3RvcEdyb3VwcztcclxuXHR9LFxyXG5cclxuXHRwcm92aWRlOiAoZmllbGQpID0+IHtcclxuXHRcdHJldHVybiBFZGl0b3JWaWV3LmRlY29yYXRpb25zLm9mKHZpZXcgPT4ge1xyXG5cdFx0XHQvLyBcIkZsYXR0ZW5cIiB0aGUgYXJyYXkgb2YgRGVjb3JhdGlvblNldHMgdG8gcHJvZHVjZSBhIHNpbmdsZSBEZWNvcmF0aW9uU2V0XHJcblx0XHRcdGNvbnN0IHRhYnN0b3BHcm91cHMgPSB2aWV3LnN0YXRlLmZpZWxkKGZpZWxkKTtcclxuXHRcdFx0Y29uc3QgZGVjb3MgPSBbXTtcclxuXHJcblx0XHRcdGZvciAoY29uc3QgdGFic3RvcEdyb3VwIG9mIHRhYnN0b3BHcm91cHMpIHtcclxuXHRcdFx0XHRpZiAoIXRhYnN0b3BHcm91cC5oaWRkZW4pXHJcblx0XHRcdFx0XHRkZWNvcy5wdXNoKC4uLnRhYnN0b3BHcm91cC5nZXRSYW5nZXMoKSk7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdHJldHVybiBEZWNvcmF0aW9uLnNldChkZWNvcywgdHJ1ZSk7XHJcblx0XHR9KTtcclxuXHR9XHJcbn0pO1xyXG5cclxuZnVuY3Rpb24gZ2V0Q3VycmVudFRhYnN0b3BHcm91cEluZGV4KFxyXG5cdHRhYnN0b3BHcm91cHM6IFRhYnN0b3BHcm91cFtdLFxyXG5cdHNlbDogRWRpdG9yU2VsZWN0aW9uXHJcbik6IG51bWJlciB7XHJcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCB0YWJzdG9wR3JvdXBzLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRjb25zdCB0YWJzdG9wR3JvdXAgPSB0YWJzdG9wR3JvdXBzW2ldO1xyXG5cdFx0aWYgKHRhYnN0b3BHcm91cC5jb250YWluc1NlbGVjdGlvbihzZWwpKSByZXR1cm4gaTtcclxuXHR9XHJcblx0cmV0dXJuIHRhYnN0b3BHcm91cHMubGVuZ3RoO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0VGFic3RvcEdyb3Vwc0Zyb21WaWV3KHZpZXc6IEVkaXRvclZpZXcpIHtcclxuXHRjb25zdCBjdXJyZW50VGFic3RvcEdyb3VwcyA9IHZpZXcuc3RhdGUuZmllbGQodGFic3RvcHNTdGF0ZUZpZWxkKTtcclxuXHJcblx0cmV0dXJuIGN1cnJlbnRUYWJzdG9wR3JvdXBzO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gYWRkVGFic3RvcHModmlldzogRWRpdG9yVmlldywgdGFic3RvcEdyb3VwczogVGFic3RvcEdyb3VwW10pIHtcclxuXHR2aWV3LmRpc3BhdGNoKHtcclxuXHRcdGVmZmVjdHM6IFthZGRUYWJzdG9wc0VmZmVjdC5vZih0YWJzdG9wR3JvdXBzKV0sXHJcblx0fSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiByZW1vdmVBbGxUYWJzdG9wcyh2aWV3OiBFZGl0b3JWaWV3KSB7XHJcblx0dmlldy5kaXNwYXRjaCh7XHJcblx0XHRlZmZlY3RzOiBbcmVtb3ZlQWxsVGFic3RvcHNFZmZlY3Qub2YobnVsbCldLFxyXG5cdH0pO1xyXG59XHJcblxyXG4vLyBjb25zdCBDT0xPUlMgPSBbXCJsaWdodHNreWJsdWVcIiwgXCJvcmFuZ2VcIiwgXCJsaW1lXCJdO1xyXG5jb25zdCBOX0NPTE9SUyA9IDM7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmV4dFRhYnN0b3BDb2xvcih2aWV3OiBFZGl0b3JWaWV3KSB7XHJcblx0Y29uc3QgZmllbGQgPSB2aWV3LnN0YXRlLmZpZWxkKHRhYnN0b3BzU3RhdGVGaWVsZCk7XHJcblx0Y29uc3QgZXhpc3RpbmdDb2xvcnMgPSBmaWVsZC5tYXAodGFic3RvcEdyb3VwID0+IHRhYnN0b3BHcm91cC5jb2xvcik7XHJcblx0Y29uc3QgdW5pcXVlRXhpc3RpbmdDb2xvcnMgPSBuZXcgU2V0KGV4aXN0aW5nQ29sb3JzKTtcclxuXHJcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBOX0NPTE9SUzsgaSsrKSB7XHJcblx0XHRpZiAoIXVuaXF1ZUV4aXN0aW5nQ29sb3JzLmhhcyhpKSkgcmV0dXJuIGk7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gMDtcclxufVxyXG4iXX0=