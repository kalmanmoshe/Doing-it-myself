import { EditorView, Decoration } from "@codemirror/view";
import { StateEffect, StateField } from "@codemirror/state";
const addTabstopsEffect = StateEffect.define();
const removeAllTabstopsEffect = StateEffect.define();
export const tabstopsStateField = StateField.define({
    create() {
        return [];
    },
    update(value, transaction) {
        let tabstopGroups = value;
        tabstopGroups.forEach(grp => grp.map(transaction.changes));
        for (const effect of transaction.effects) {
            if (effect.is(addTabstopsEffect)) {
                tabstopGroups.unshift(...effect.value);
            }
            else if (effect.is(removeAllTabstopsEffect)) {
                tabstopGroups = [];
            }
        }
        // Remove the tabstop groups that the cursor has passed. This scenario
        // happens when the user manually moves the cursor using arrow keys or mouse
        if (transaction.selection) {
            const currTabstopGroupIndex = getCurrentTabstopGroupIndex(tabstopGroups, transaction.selection);
            tabstopGroups = tabstopGroups.slice(currTabstopGroupIndex);
            if (tabstopGroups.length <= 1) {
                // Clear all tabstop groups if there's just one remaining
                tabstopGroups = [];
            }
            else {
                tabstopGroups[0].hideFromEditor();
            }
        }
        return tabstopGroups;
    },
    provide: (field) => {
        return EditorView.decorations.of(view => {
            // "Flatten" the array of DecorationSets to produce a single DecorationSet
            const tabstopGroups = view.state.field(field);
            const decos = [];
            for (const tabstopGroup of tabstopGroups) {
                if (!tabstopGroup.hidden)
                    decos.push(...tabstopGroup.getRanges());
            }
            return Decoration.set(decos, true);
        });
    }
});
function getCurrentTabstopGroupIndex(tabstopGroups, sel) {
    for (let i = 0; i < tabstopGroups.length; i++) {
        const tabstopGroup = tabstopGroups[i];
        if (tabstopGroup.containsSelection(sel))
            return i;
    }
    return tabstopGroups.length;
}
export function getTabstopGroupsFromView(view) {
    const currentTabstopGroups = view.state.field(tabstopsStateField);
    return currentTabstopGroups;
}
export function addTabstops(view, tabstopGroups) {
    view.dispatch({
        effects: [addTabstopsEffect.of(tabstopGroups)],
    });
}
export function removeAllTabstops(view) {
    view.dispatch({
        effects: [removeAllTabstopsEffect.of(null)],
    });
}
// const COLORS = ["lightskyblue", "orange", "lime"];
const N_COLORS = 3;
export function getNextTabstopColor(view) {
    const field = view.state.field(tabstopsStateField);
    const existingColors = field.map(tabstopGroup => tabstopGroup.color);
    const uniqueExistingColors = new Set(existingColors);
    for (let i = 0; i < N_COLORS; i++) {
        if (!uniqueExistingColors.has(i))
            return i;
    }
    return 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFic3RvcHNfc3RhdGVfZmllbGQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvc25pcHBldHMvY29kZW1pcnJvci90YWJzdG9wc19zdGF0ZV9maWVsZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzFELE9BQU8sRUFBbUIsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRzdFLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBa0IsQ0FBQztBQUMvRCxNQUFNLHVCQUF1QixHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVyRCxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFpQjtJQUVuRSxNQUFNO1FBQ0wsT0FBTyxFQUFFLENBQUM7SUFDWCxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssRUFBRSxXQUFXO1FBQ3hCLElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztRQUMxQixhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUUzRCxLQUFLLE1BQU0sTUFBTSxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUMxQyxJQUFJLE1BQU0sQ0FBQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO2dCQUNsQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hDLENBQUM7aUJBQ0ksSUFBSSxNQUFNLENBQUMsRUFBRSxDQUFDLHVCQUF1QixDQUFDLEVBQUUsQ0FBQztnQkFDN0MsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUNwQixDQUFDO1FBQ0YsQ0FBQztRQUVELHNFQUFzRTtR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QUFJLEdBQUcsQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUVyRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsT0FBTyxDQUFDLENBQUM7QUFDVixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldywgRGVjb3JhdGlvbiB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XG5pbXBvcnQgeyBFZGl0b3JTZWxlY3Rpb24sIFN0YXRlRWZmZWN0LCBTdGF0ZUZpZWxkIH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XG5pbXBvcnQgeyBUYWJzdG9wR3JvdXAgfSBmcm9tIFwiLi4vdGFic3RvcFwiO1xuXG5jb25zdCBhZGRUYWJzdG9wc0VmZmVjdCA9IFN0YXRlRWZmZWN0LmRlZmluZTxUYWJzdG9wR3JvdXBbXT4oKTtcbmNvbnN0IHJlbW92ZUFsbFRhYnN0b3BzRWZmZWN0ID0gU3RhdGVFZmZlY3QuZGVmaW5lKCk7XG5cbmV4cG9ydCBjb25zdCB0YWJzdG9wc1N0YXRlRmllbGQgPSBTdGF0ZUZpZWxkLmRlZmluZTxUYWJzdG9wR3JvdXBbXT4oe1xuXG5cdGNyZWF0ZSgpIHtcblx0XHRyZXR1cm4gW107XG5cdH0sXG5cblx0dXBkYXRlKHZhbHVlLCB0cmFuc2FjdGlvbikge1xuXHRcdGxldCB0YWJzdG9wR3JvdXBzID0gdmFsdWU7XG5cdFx0dGFic3RvcEdyb3Vwcy5mb3JFYWNoKGdycCA9PiBncnAubWFwKHRyYW5zYWN0aW9uLmNoYW5nZXMpKTtcblxuXHRcdGZvciAoY29uc3QgZWZmZWN0IG9mIHRyYW5zYWN0aW9uLmVmZmVjdHMpIHtcblx0XHRcdGlmIChlZmZlY3QuaXMoYWRkVGFic3RvcHNFZmZlY3QpKSB7XG5cdFx0XHRcdHRhYnN0b3BHcm91cHMudW5zaGlmdCguLi5lZmZlY3QudmFsdWUpO1xuXHRcdFx0fVxuXHRcdFx0ZWxzZSBpZiAoZWZmZWN0LmlzKHJlbW92ZUFsbFRhYnN0b3BzRWZmZWN0KSkge1xuXHRcdFx0XHR0YWJzdG9wR3JvdXBzID0gW107XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0Ly8gUmVtb3ZlIHRoZSB0YWJzdG9wIGdyb3VwcyB0aGF0IHRoZSBjdXJzb3IgaGFzIHBhc3NlZC4gVGhpcyBzY2VuYXJpb1xuXHRcdC8vIGhhcHBlbnMgd2hlbiB0aGUgdXNlciBtYW51YWxseSBtb3ZlcyB0aGUgY3Vyc29yIHVzaW5nIGFycm93IGtleXMgb3IgbW91c2Vcblx0XHRpZiAodHJhbnNhY3Rpb24uc2VsZWN0aW9uKSB7XG5cdFx0XHRjb25zdCBjdXJyVGFic3RvcEdyb3VwSW5kZXggPSBnZXRDdXJyZW50VGFic3RvcEdyb3VwSW5kZXgoXG5cdFx0XHRcdHRhYnN0b3BHcm91cHMsXG5cdFx0XHRcdHRyYW5zYWN0aW9uLnNlbGVjdGlvblxuXHRcdFx0KTtcblx0XHRcdHRhYnN0b3BHcm91cHMgPSB0YWJzdG9wR3JvdXBzLnNsaWNlKGN1cnJUYWJzdG9wR3JvdXBJbmRleCk7XG5cdFx0XHRcblx0XHRcdGlmICh0YWJzdG9wR3JvdXBzLmxlbmd0aCA8PSAxKSB7XG5cdFx0XHRcdC8vIENsZWFyIGFsbCB0YWJzdG9wIGdyb3VwcyBpZiB0aGVyZSdzIGp1c3Qgb25lIHJlbWFpbmluZ1xuXHRcdFx0XHR0YWJzdG9wR3JvdXBzID0gW107XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHR0YWJzdG9wR3JvdXBzWzBdLmhpZGVGcm9tRWRpdG9yKCk7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRhYnN0b3BHcm91cHM7XG5cdH0sXG5cblx0cHJvdmlkZTogKGZpZWxkKSA9PiB7XG5cdFx0cmV0dXJuIEVkaXRvclZpZXcuZGVjb3JhdGlvbnMub2YodmlldyA9PiB7XG5cdFx0XHQvLyBcIkZsYXR0ZW5cIiB0aGUgYXJyYXkgb2YgRGVjb3JhdGlvblNldHMgdG8gcHJvZHVjZSBhIHNpbmdsZSBEZWNvcmF0aW9uU2V0XG5cdFx0XHRjb25zdCB0YWJzdG9wR3JvdXBzID0gdmlldy5zdGF0ZS5maWVsZChmaWVsZCk7XG5cdFx0XHRjb25zdCBkZWNvcyA9IFtdO1xuXG5cdFx0XHRmb3IgKGNvbnN0IHRhYnN0b3BHcm91cCBvZiB0YWJzdG9wR3JvdXBzKSB7XG5cdFx0XHRcdGlmICghdGFic3RvcEdyb3VwLmhpZGRlbilcblx0XHRcdFx0XHRkZWNvcy5wdXNoKC4uLnRhYnN0b3BHcm91cC5nZXRSYW5nZXMoKSk7XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBEZWNvcmF0aW9uLnNldChkZWNvcywgdHJ1ZSk7XG5cdFx0fSk7XG5cdH1cbn0pO1xuXG5mdW5jdGlvbiBnZXRDdXJyZW50VGFic3RvcEdyb3VwSW5kZXgoXG5cdHRhYnN0b3BHcm91cHM6IFRhYnN0b3BHcm91cFtdLFxuXHRzZWw6IEVkaXRvclNlbGVjdGlvblxuKTogbnVtYmVyIHtcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCB0YWJzdG9wR3JvdXBzLmxlbmd0aDsgaSsrKSB7XG5cdFx0Y29uc3QgdGFic3RvcEdyb3VwID0gdGFic3RvcEdyb3Vwc1tpXTtcblx0XHRpZiAodGFic3RvcEdyb3VwLmNvbnRhaW5zU2VsZWN0aW9uKHNlbCkpIHJldHVybiBpO1xuXHR9XG5cdHJldHVybiB0YWJzdG9wR3JvdXBzLmxlbmd0aDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRhYnN0b3BHcm91cHNGcm9tVmlldyh2aWV3OiBFZGl0b3JWaWV3KSB7XG5cdGNvbnN0IGN1cnJlbnRUYWJzdG9wR3JvdXBzID0gdmlldy5zdGF0ZS5maWVsZCh0YWJzdG9wc1N0YXRlRmllbGQpO1xuXG5cdHJldHVybiBjdXJyZW50VGFic3RvcEdyb3Vwcztcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZFRhYnN0b3BzKHZpZXc6IEVkaXRvclZpZXcsIHRhYnN0b3BHcm91cHM6IFRhYnN0b3BHcm91cFtdKSB7XG5cdHZpZXcuZGlzcGF0Y2goe1xuXHRcdGVmZmVjdHM6IFthZGRUYWJzdG9wc0VmZmVjdC5vZih0YWJzdG9wR3JvdXBzKV0sXG5cdH0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlQWxsVGFic3RvcHModmlldzogRWRpdG9yVmlldykge1xuXHR2aWV3LmRpc3BhdGNoKHtcblx0XHRlZmZlY3RzOiBbcmVtb3ZlQWxsVGFic3RvcHNFZmZlY3Qub2YobnVsbCldLFxuXHR9KTtcbn1cblxuLy8gY29uc3QgQ09MT1JTID0gW1wibGlnaHRza3libHVlXCIsIFwib3JhbmdlXCIsIFwibGltZVwiXTtcbmNvbnN0IE5fQ09MT1JTID0gMztcblxuZXhwb3J0IGZ1bmN0aW9uIGdldE5leHRUYWJzdG9wQ29sb3IodmlldzogRWRpdG9yVmlldykge1xuXHRjb25zdCBmaWVsZCA9IHZpZXcuc3RhdGUuZmllbGQodGFic3RvcHNTdGF0ZUZpZWxkKTtcblx0Y29uc3QgZXhpc3RpbmdDb2xvcnMgPSBmaWVsZC5tYXAodGFic3RvcEdyb3VwID0+IHRhYnN0b3BHcm91cC5jb2xvcik7XG5cdGNvbnN0IHVuaXF1ZUV4aXN0aW5nQ29sb3JzID0gbmV3IFNldChleGlzdGluZ0NvbG9ycyk7XG5cblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBOX0NPTE9SUzsgaSsrKSB7XG5cdFx0aWYgKCF1bmlxdWVFeGlzdGluZ0NvbG9ycy5oYXMoaSkpIHJldHVybiBpO1xuXHR9XG5cblx0cmV0dXJuIDA7XG59XG4iXX0=