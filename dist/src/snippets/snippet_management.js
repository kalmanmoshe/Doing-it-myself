import { ChangeSet } from "@codemirror/state";
import { startSnippet } from "./codemirror/history";
import { isolateHistory } from "@codemirror/commands";
import { tabstopSpecsToTabstopGroups } from "./tabstop";
import { addTabstops, getTabstopGroupsFromView, getNextTabstopColor, tabstopsStateField } from "./codemirror/tabstops_state_field";
import { clearSnippetQueue, snippetQueueStateField } from "./codemirror/snippet_queue_state_field";
import { resetCursorBlink } from "src/utils/editor_utils";
export function expandSnippets(view) {
    const snippetsToExpand = view.state.field(snippetQueueStateField);
    if (snippetsToExpand.length === 0)
        return false;
    const originalDocLength = view.state.doc.length;
    handleUndoKeypresses(view, snippetsToExpand);
    const tabstopsToAdd = computeTabstops(view, snippetsToExpand, originalDocLength);
    // Insert any tabstops
    if (tabstopsToAdd.length === 0) {
        clearSnippetQueue(view);
        return true;
    }
    markTabstops(view, tabstopsToAdd);
    expandTabstops(view, tabstopsToAdd);
    clearSnippetQueue(view);
    return true;
}
function handleUndoKeypresses(view, snippets) {
    const originalDoc = view.state.doc;
    const originalDocLength = originalDoc.length;
    const keyPresses = [];
    for (const snippet of snippets) {
        if (snippet.keyPressed && (snippet.keyPressed.length === 1)) {
            // Use prevChar so that cursors are placed at the end of the added text
            const prevChar = view.state.doc.sliceString(snippet.to - 1, snippet.to);
            const from = snippet.to === 0 ? 0 : snippet.to - 1;
            keyPresses.push({ from: from, to: snippet.to, insert: prevChar + snippet.keyPressed });
        }
    }
    // Insert the keypresses
    // Use isolateHistory to allow users to undo the triggering of a snippet,
    // but keep the text inserted by the trigger key
    view.dispatch({
        changes: keyPresses,
        annotations: isolateHistory.of("full")
    });
    // Undo the keypresses, and insert the replacements
    const undoKeyPresses = ChangeSet.of(keyPresses, originalDocLength).invert(originalDoc);
    const changesAsChangeSet = ChangeSet.of(snippets, originalDocLength);
    const combinedChanges = undoKeyPresses.compose(changesAsChangeSet);
    // Mark the transaction as the beginning of a snippet (for undo/history purposes)
    view.dispatch({
        changes: combinedChanges,
        effects: startSnippet.of(null)
    });
}
function computeTabstops(view, snippets, originalDocLength) {
    // Find the positions of the cursors in the new document
    const changeSet = ChangeSet.of(snippets, originalDocLength);
    const oldPositions = snippets.map(change => change.from);
    const newPositions = oldPositions.map(pos => changeSet.mapPos(pos));
    const tabstopsToAdd = [];
    for (let i = 0; i < snippets.length; i++) {
        tabstopsToAdd.push(...snippets[i].getTabstops(view, newPositions[i]));
    }
    return tabstopsToAdd;
}
function markTabstops(view, tabstops) {
    const color = getNextTabstopColor(view);
    const tabstopGroups = tabstopSpecsToTabstopGroups(tabstops, color);
    addTabstops(view, tabstopGroups);
}
function expandTabstops(view, tabstops) {
    // Insert the replacements
    const changes = tabstops.map((tabstop) => {
        return { from: tabstop.from, to: tabstop.to, insert: tabstop.replacement };
    });
    view.dispatch({
        changes: changes
    });
    // Select the first tabstop
    const firstGrp = getTabstopGroupsFromView(view)[0];
    firstGrp.select(view, false, true); // "true" here marks the transaction as the end of the snippet (for undo/history purposes)
}
// Returns true if the transaction was dispatched
export function setSelectionToNextTabstop(view) {
    const tabstopGroups = view.state.field(tabstopsStateField);
    function aux(nextGrpIndex) {
        const nextGrp = tabstopGroups[nextGrpIndex];
        if (!nextGrp)
            return false;
        const currSel = view.state.selection;
        // If the current selection lies within the next tabstop(s), move the cursor
        // to the endpoint(s) of the next tabstop(s)
        let nextGrpSel = nextGrp.toEditorSelection();
        if (nextGrp.containsSelection(currSel)) {
            nextGrpSel = nextGrp.toEditorSelection(true);
        }
        if (currSel.eq(nextGrpSel))
            return aux(nextGrpIndex + 1);
        view.dispatch({
            selection: nextGrpSel,
        });
        resetCursorBlink();
        return true;
    }
    return aux(1);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25pcHBldF9tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NuaXBwZXRzL3NuaXBwZXRfbWFuYWdlbWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN0RCxPQUFPLEVBQWUsMkJBQTJCLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDckUsT0FBTyxFQUFFLFdBQVcsRUFBRSx3QkFBd0IsRUFBRSxtQkFBbUIsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ25JLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBRW5HLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTFELE1BQU0sVUFBVSxjQUFjLENBQUMsSUFBZ0I7SUFDOUMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ2xFLElBQUksZ0JBQWdCLENBQUMsTUFBTSxLQUFLLENBQUM7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUVoRCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztJQUVoRCxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUU3QyxNQUFNLGFBQWEsR0FBRyxlQUFlLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFFakYsc0JBQXNCO0lBQ3RCLElBQUksYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNoQyxpQkFB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YSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFFM0QsU0FBUyxHQUFHLENBQUMsWUFBb0I7UUFDaEMsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFFM0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDckMsNEVBQTRFO1FBQzVFLDRDQUE0QztRQUM1QyxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUM3QyxJQUFJLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ3hDLFVBQVUsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELElBQUksT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUM7WUFDekIsT0FBTyxHQUFHLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTlCLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDYixTQUFTLEVBQUUsVUFBVTtTQUNyQixDQUFDLENBQUM7UUFDSCxnQkFBZ0IsRUFBRSxDQUFDO1FBRW5CLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVELE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclZpZXcgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xyXG5pbXBvcnQgeyBDaGFuZ2VTZXQgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgc3RhcnRTbmlwcGV0IH0gZnJvbSBcIi4vY29kZW1pcnJvci9oaXN0b3J5XCI7XHJcbmltcG9ydCB7IGlzb2xhdGVIaXN0b3J5IH0gZnJvbSBcIkBjb2RlbWlycm9yL2NvbW1hbmRzXCI7XHJcbmltcG9ydCB7IFRhYnN0b3BTcGVjLCB0YWJzdG9wU3BlY3NUb1RhYnN0b3BHcm91cHMgfSBmcm9tIFwiLi90YWJzdG9wXCI7XHJcbmltcG9ydCB7IGFkZFRhYnN0b3BzLCBnZXRUYWJzdG9wR3JvdXBzRnJvbVZpZXcsIGdldE5leHRUYWJzdG9wQ29sb3IsIHRhYnN0b3BzU3RhdGVGaWVsZCB9IGZyb20gXCIuL2NvZGVtaXJyb3IvdGFic3RvcHNfc3RhdGVfZmllbGRcIjtcclxuaW1wb3J0IHsgY2xlYXJTbmlwcGV0UXVldWUsIHNuaXBwZXRRdWV1ZVN0YXRlRmllbGQgfSBmcm9tIFwiLi9jb2RlbWlycm9yL3NuaXBwZXRfcXVldWVfc3RhdGVfZmllbGRcIjtcclxuaW1wb3J0IHsgU25pcHBldENoYW5nZVNwZWMgfSBmcm9tIFwiLi9jb2RlbWlycm9yL3NuaXBwZXRfY2hhbmdlX3NwZWNcIjtcclxuaW1wb3J0IHsgcmVzZXRDdXJzb3JCbGluayB9IGZyb20gXCJzcmMvdXRpbHMvZWRpdG9yX3V0aWxzXCI7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZXhwYW5kU25pcHBldHModmlldzogRWRpdG9yVmlldyk6Ym9vbGVhbiB7XHJcblx0Y29uc3Qgc25pcHBldHNUb0V4cGFuZCA9IHZpZXcuc3RhdGUuZmllbGQoc25pcHBldFF1ZXVlU3RhdGVGaWVsZCk7XHJcblx0aWYgKHNuaXBwZXRzVG9FeHBhbmQubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XHJcblxyXG5cdGNvbnN0IG9yaWdpbmFsRG9jTGVuZ3RoID0gdmlldy5zdGF0ZS5kb2MubGVuZ3RoO1xyXG5cclxuXHRoYW5kbGVVbmRvS2V5cHJlc3Nlcyh2aWV3LCBzbmlwcGV0c1RvRXhwYW5kKTtcclxuXHJcblx0Y29uc3QgdGFic3RvcHNUb0FkZCA9IGNvbXB1dGVUYWJzdG9wcyh2aWV3LCBzbmlwcGV0c1RvRXhwYW5kLCBvcmlnaW5hbERvY0xlbmd0aCk7XHJcblxyXG5cdC8vIEluc2VydCBhbnkgdGFic3RvcHNcclxuXHRpZiAodGFic3RvcHNUb0FkZC5sZW5ndGggPT09IDApIHtcclxuXHRcdGNsZWFyU25pcHBldFF1ZXVlKHZpZXcpO1xyXG5cdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cclxuXHRtYXJrVGFic3RvcHModmlldywgdGFic3RvcHNUb0FkZCk7XHJcblx0ZXhwYW5kVGFic3RvcHModmlldywgdGFic3RvcHNUb0FkZCk7XHJcblxyXG5cdGNsZWFyU25pcHBldFF1ZXVlKHZpZXcpO1xyXG5cdHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBoYW5kbGVVbmRvS2V5cHJlc3Nlcyh2aWV3OiBFZGl0b3JWaWV3LCBzbmlwcGV0czogU25pcHBldENoYW5nZVNwZWNbXSkge1xyXG5cdGNvbnN0IG9yaWdpbmFsRG9jID0gdmlldy5zdGF0ZS5kb2M7XHJcblx0Y29uc3Qgb3JpZ2luYWxEb2NMZW5ndGggPSBvcmlnaW5hbERvYy5sZW5ndGg7XHJcblxyXG5cdGNvbnN0IGtleVByZXNzZXM6IHtmcm9tOiBudW1iZXIsIHRvOiBudW1iZXIsIGluc2VydDogc3RyaW5nfVtdID0gW107XHJcblx0Zm9yIChjb25zdCBzbmlwcGV0IG9mIHNuaXBwZXRzKSB7XHJcblx0XHRpZiAoc25pcHBldC5rZXlQcmVzc2VkICYmIChzbmlwcGV0LmtleVByZXNzZWQubGVuZ3RoID09PSAxKSkge1xyXG5cdFx0XHQvLyBVc2UgcHJldkNoYXIgc28gdGhhdCBjdXJzb3JzIGFyZSBwbGFjZWQgYXQgdGhlIGVuZCBvZiB0aGUgYWRkZWQgdGV4dFxyXG5cdFx0XHRjb25zdCBwcmV2Q2hhciA9IHZpZXcuc3RhdGUuZG9jLnNsaWNlU3RyaW5nKHNuaXBwZXQudG8tMSwgc25pcHBldC50byk7XHJcblxyXG5cdFx0XHRjb25zdCBmcm9tID0gc25pcHBldC50byA9PT0gMCA/IDAgOiBzbmlwcGV0LnRvLTE7XHJcblx0XHRcdGtleVByZXNzZXMucHVzaCh7ZnJvbTogZnJvbSwgdG86IHNuaXBwZXQudG8sIGluc2VydDogcHJldkNoYXIgKyBzbmlwcGV0LmtleVByZXNzZWR9KTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdC8vIEluc2VydCB0aGUga2V5cHJlc3Nlc1xyXG5cdC8vIFVzZSBpc29sYXRlSGlzdG9yeSB0byBhbGxvdyB1c2VycyB0byB1bmRvIHRoZSB0cmlnZ2VyaW5nIG9mIGEgc25pcHBldCxcclxuXHQvLyBidXQga2VlcCB0aGUgdGV4dCBpbnNlcnRlZCBieSB0aGUgdHJpZ2dlciBrZXlcclxuXHR2aWV3LmRpc3BhdGNoKHtcclxuXHRcdGNoYW5nZXM6IGtleVByZXNzZXMsXHJcblx0XHRhbm5vdGF0aW9uczogaXNvbGF0ZUhpc3Rvcnkub2YoXCJmdWxsXCIpXHJcblx0fSk7XHJcblxyXG5cdC8vIFVuZG8gdGhlIGtleXByZXNzZXMsIGFuZCBpbnNlcnQgdGhlIHJlcGxhY2VtZW50c1xyXG5cdGNvbnN0IHVuZG9LZXlQcmVzc2VzID0gQ2hhbmdlU2V0Lm9mKGtleVByZXNzZXMsIG9yaWdpbmFsRG9jTGVuZ3RoKS5pbnZlcnQob3JpZ2luYWxEb2MpO1xyXG5cdGNvbnN0IGNoYW5nZXNBc0NoYW5nZVNldCA9IENoYW5nZVNldC5vZihzbmlwcGV0cywgb3JpZ2luYWxEb2NMZW5ndGgpO1xyXG5cdGNvbnN0IGNvbWJpbmVkQ2hhbmdlcyA9IHVuZG9LZXlQcmVzc2VzLmNvbXBvc2UoY2hhbmdlc0FzQ2hhbmdlU2V0KTtcclxuXHJcblx0Ly8gTWFyayB0aGUgdHJhbnNhY3Rpb24gYXMgdGhlIGJlZ2lubmluZyBvZiBhIHNuaXBwZXQgKGZvciB1bmRvL2hpc3RvcnkgcHVycG9zZXMpXHJcblx0dmlldy5kaXNwYXRjaCh7XHJcblx0XHRjaGFuZ2VzOiBjb21iaW5lZENoYW5nZXMsXHJcblx0XHRlZmZlY3RzOiBzdGFydFNuaXBwZXQub2YobnVsbClcclxuXHR9KTtcclxufVxyXG5cclxuZnVuY3Rpb24gY29tcHV0ZVRhYnN0b3BzKHZpZXc6IEVkaXRvclZpZXcsIHNuaXBwZXRzOiBTbmlwcGV0Q2hhbmdlU3BlY1tdLCBvcmlnaW5hbERvY0xlbmd0aDogbnVtYmVyKSB7XHJcblx0Ly8gRmluZCB0aGUgcG9zaXRpb25zIG9mIHRoZSBjdXJzb3JzIGluIHRoZSBuZXcgZG9jdW1lbnRcclxuXHRjb25zdCBjaGFuZ2VTZXQgPSBDaGFuZ2VTZXQub2Yoc25pcHBldHMsIG9yaWdpbmFsRG9jTGVuZ3RoKTtcclxuXHRjb25zdCBvbGRQb3NpdGlvbnMgPSBzbmlwcGV0cy5tYXAoY2hhbmdlID0+IGNoYW5nZS5mcm9tKTtcclxuXHRjb25zdCBuZXdQb3NpdGlvbnMgPSBvbGRQb3NpdGlvbnMubWFwKHBvcyA9PiBjaGFuZ2VTZXQubWFwUG9zKHBvcykpO1xyXG5cclxuXHRjb25zdCB0YWJzdG9wc1RvQWRkOlRhYnN0b3BTcGVjW10gPSBbXTtcclxuXHRmb3IgKGxldCBpID0gMDsgaSA8IHNuaXBwZXRzLmxlbmd0aDsgaSsrKSB7XHJcblx0XHR0YWJzdG9wc1RvQWRkLnB1c2goLi4uc25pcHBldHNbaV0uZ2V0VGFic3RvcHModmlldywgbmV3UG9zaXRpb25zW2ldKSk7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gdGFic3RvcHNUb0FkZDtcclxufVxyXG5cclxuZnVuY3Rpb24gbWFya1RhYnN0b3BzKHZpZXc6IEVkaXRvclZpZXcsIHRhYnN0b3BzOiBUYWJzdG9wU3BlY1tdKSB7XHJcblx0Y29uc3QgY29sb3IgPSBnZXROZXh0VGFic3RvcENvbG9yKHZpZXcpO1xyXG5cdGNvbnN0IHRhYnN0b3BHcm91cHMgPSB0YWJzdG9wU3BlY3NUb1RhYnN0b3BHcm91cHModGFic3RvcHMsIGNvbG9yKTtcclxuXHRhZGRUYWJzdG9wcyh2aWV3LCB0YWJzdG9wR3JvdXBzKTtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGV4cGFuZFRhYnN0b3BzKHZpZXc6IEVkaXRvclZpZXcsIHRhYnN0b3BzOiBUYWJzdG9wU3BlY1tdKSB7XHJcblx0Ly8gSW5zZXJ0IHRoZSByZXBsYWNlbWVudHNcclxuXHRjb25zdCBjaGFuZ2VzID0gdGFic3RvcHMubWFwKCh0YWJzdG9wOiBUYWJzdG9wU3BlYykgPT4ge1xyXG5cdFx0cmV0dXJuIHtmcm9tOiB0YWJzdG9wLmZyb20sIHRvOiB0YWJzdG9wLnRvLCBpbnNlcnQ6IHRhYnN0b3AucmVwbGFjZW1lbnR9XHJcblx0fSk7XHJcblxyXG5cdHZpZXcuZGlzcGF0Y2goe1xyXG5cdFx0Y2hhbmdlczogY2hhbmdlc1xyXG5cdH0pO1xyXG5cclxuXHQvLyBTZWxlY3QgdGhlIGZpcnN0IHRhYnN0b3BcclxuXHRjb25zdCBmaXJzdEdycCA9IGdldFRhYnN0b3BHcm91cHNGcm9tVmlldyh2aWV3KVswXTtcclxuXHRmaXJzdEdycC5zZWxlY3QodmlldywgZmFsc2UsIHRydWUpOyAvLyBcInRydWVcIiBoZXJlIG1hcmtzIHRoZSB0cmFuc2FjdGlvbiBhcyB0aGUgZW5kIG9mIHRoZSBzbmlwcGV0IChmb3IgdW5kby9oaXN0b3J5IHB1cnBvc2VzKVxyXG59XHJcblxyXG4vLyBSZXR1cm5zIHRydWUgaWYgdGhlIHRyYW5zYWN0aW9uIHdhcyBkaXNwYXRjaGVkXHJcbmV4cG9ydCBmdW5jdGlvbiBzZXRTZWxlY3Rpb25Ub05leHRUYWJzdG9wKHZpZXc6IEVkaXRvclZpZXcpOiBib29sZWFuIHtcclxuXHRjb25zdCB0YWJzdG9wR3JvdXBzID0gdmlldy5zdGF0ZS5maWVsZCh0YWJzdG9wc1N0YXRlRmllbGQpO1xyXG5cclxuXHRmdW5jdGlvbiBhdXgobmV4dEdycEluZGV4OiBudW1iZXIpIHtcclxuXHRcdGNvbnN0IG5leHRHcnAgPSB0YWJzdG9wR3JvdXBzW25leHRHcnBJbmRleF07XHJcblx0XHRpZiAoIW5leHRHcnApIHJldHVybiBmYWxzZTtcclxuXHJcblx0XHRjb25zdCBjdXJyU2VsID0gdmlldy5zdGF0ZS5zZWxlY3Rpb247XHJcblx0XHQvLyBJZiB0aGUgY3VycmVudCBzZWxlY3Rpb24gbGllcyB3aXRoaW4gdGhlIG5leHQgdGFic3RvcChzKSwgbW92ZSB0aGUgY3Vyc29yXHJcblx0XHQvLyB0byB0aGUgZW5kcG9pbnQocykgb2YgdGhlIG5leHQgdGFic3RvcChzKVxyXG5cdFx0bGV0IG5leHRHcnBTZWwgPSBuZXh0R3JwLnRvRWRpdG9yU2VsZWN0aW9uKCk7XHJcblx0XHRpZiAobmV4dEdycC5jb250YWluc1NlbGVjdGlvbihjdXJyU2VsKSkge1xyXG5cdFx0XHRuZXh0R3JwU2VsID0gbmV4dEdycC50b0VkaXRvclNlbGVjdGlvbih0cnVlKTtcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoY3VyclNlbC5lcShuZXh0R3JwU2VsKSlcclxuXHRcdFx0cmV0dXJuIGF1eChuZXh0R3JwSW5kZXggKyAxKTtcclxuXHJcblx0XHR2aWV3LmRpc3BhdGNoKHtcclxuXHRcdFx0c2VsZWN0aW9uOiBuZXh0R3JwU2VsLFxyXG5cdFx0fSk7XHJcblx0XHRyZXNldEN1cnNvckJsaW5rKCk7XHJcblxyXG5cdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gYXV4KDEpO1xyXG59XHJcbiJdfQ==