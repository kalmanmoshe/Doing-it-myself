import { ChangeSet } from "@codemirror/state";
import { startSnippet } from "./codemirror/history";
import { isolateHistory } from "@codemirror/commands";
import { tabstopSpecsToTabstopGroups } from "./tabstop";
import { addTabstops, getTabstopGroupsFromView, getNextTabstopColor, tabstopsStateField } from "./codemirror/tabstops_state_field";
import { clearSnippetQueue, snippetQueueStateField } from "./codemirror/snippet_queue_state_field";
import { resetCursorBlink } from "src/utils/editor_utils";
export function expandSnippets(view) {
    const snippetsToExpand = view.state.field(snippetQueueStateField);
    if (snippetsToExpand.length === 0)
        return false;
    const originalDocLength = view.state.doc.length;
    handleUndoKeypresses(view, snippetsToExpand);
    const tabstopsToAdd = computeTabstops(view, snippetsToExpand, originalDocLength);
    // Insert any tabstops
    if (tabstopsToAdd.length === 0) {
        clearSnippetQueue(view);
        return true;
    }
    markTabstops(view, tabstopsToAdd);
    expandTabstops(view, tabstopsToAdd);
    clearSnippetQueue(view);
    return true;
}
function handleUndoKeypresses(view, snippets) {
    const originalDoc = view.state.doc;
    const originalDocLength = originalDoc.length;
    const keyPresses = [];
    for (const snippet of snippets) {
        if (snippet.keyPressed && (snippet.keyPressed.length === 1)) {
            // Use prevChar so that cursors are placed at the end of the added text
            const prevChar = view.state.doc.sliceString(snippet.to - 1, snippet.to);
            const from = snippet.to === 0 ? 0 : snippet.to - 1;
            keyPresses.push({ from: from, to: snippet.to, insert: prevChar + snippet.keyPressed });
        }
    }
    // Insert the keypresses
    // Use isolateHistory to allow users to undo the triggering of a snippet,
    // but keep the text inserted by the trigger key
    view.dispatch({
        changes: keyPresses,
        annotations: isolateHistory.of("full")
    });
    // Undo the keypresses, and insert the replacements
    const undoKeyPresses = ChangeSet.of(keyPresses, originalDocLength).invert(originalDoc);
    const changesAsChangeSet = ChangeSet.of(snippets, originalDocLength);
    const combinedChanges = undoKeyPresses.compose(changesAsChangeSet);
    // Mark the transaction as the beginning of a snippet (for undo/history purposes)
    view.dispatch({
        changes: combinedChanges,
        effects: startSnippet.of(null)
    });
}
function computeTabstops(view, snippets, originalDocLength) {
    // Find the positions of the cursors in the new document
    const changeSet = ChangeSet.of(snippets, originalDocLength);
    const oldPositions = snippets.map(change => change.from);
    const newPositions = oldPositions.map(pos => changeSet.mapPos(pos));
    const tabstopsToAdd = [];
    for (let i = 0; i < snippets.length; i++) {
        tabstopsToAdd.push(...snippets[i].getTabstops(view, newPositions[i]));
    }
    return tabstopsToAdd;
}
function markTabstops(view, tabstops) {
    const color = getNextTabstopColor(view);
    const tabstopGroups = tabstopSpecsToTabstopGroups(tabstops, color);
    addTabstops(view, tabstopGroups);
}
function expandTabstops(view, tabstops) {
    // Insert the replacements
    const changes = tabstops.map((tabstop) => {
        return { from: tabstop.from, to: tabstop.to, insert: tabstop.replacement };
    });
    view.dispatch({
        changes: changes
    });
    // Select the first tabstop
    const firstGrp = getTabstopGroupsFromView(view)[0];
    firstGrp.select(view, false, true); // "true" here marks the transaction as the end of the snippet (for undo/history purposes)
}
// Returns true if the transaction was dispatched
export function setSelectionToNextTabstop(view) {
    const tabstopGroups = view.state.field(tabstopsStateField);
    function aux(nextGrpIndex) {
        const nextGrp = tabstopGroups[nextGrpIndex];
        if (!nextGrp)
            return false;
        const currSel = view.state.selection;
        // If the current selection lies within the next tabstop(s), move the cursor
        // to the endpoint(s) of the next tabstop(s)
        let nextGrpSel = nextGrp.toEditorSelection();
        if (nextGrp.containsSelection(currSel)) {
            nextGrpSel = nextGrp.toEditorSelection(true);
        }
        if (currSel.eq(nextGrpSel))
            return aux(nextGrpIndex + 1);
        view.dispatch({
            selection: nextGrpSel,
        });
        resetCursorBlink();
        return true;
    }
    return aux(1);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25pcHBldF9tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NuaXBwZXRzL3NuaXBwZXRfbWFuYWdlbWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN0RCxPQUFPLEVBQWUsMkJBQTJCLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDckUsT0FBTyxFQUFFLFdBQVcsRUFBRSx3QkFBd0IsRUFBRSxtQkFBbUIsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ25JLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBRW5HLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTFELE1BQU0sVUFBVSxjQUFjLENBQUMsSUFBZ0I7SUFDOUMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ2xFLElBQUksZ0JBQWdCLENBQUMsTUFBTSxLQUFLLENBQUM7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUVoRCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztJQUVoRCxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUU3QyxNQUFNLGFBQWEsR0FBRyxlQUFlLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFFakYsc0JBQXNCO0lBQ3RCLElBQUksYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNoQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QixPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxZQUFZLENBQUMsSUFBSSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQ2xDLGNBQWMsQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUM7SUFFcEMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDeEIsT0FBTyxJQUFJLENBQUM7QUFDYixDQUFDO0FBRUQsU0FBUyxvQkFBb0IsQ0FBQyxJQUFnQixFQUFFLFFBQTZCO0lBQzVFLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQ25DLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQztJQUU3QyxNQUFNLFVBQVUsR0FBaUQsRUFBRSxDQUFDO0lBQ3BFLEtBQUssTUFBTSxPQUFPLElBQUksUUFBUSxFQUFFLENBQUM7UUFDaEMsSUFBSSxPQUFPLENBQUMsVUFBVSxJQUFJLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUM3RCx1RUFBdUU7WUFDdkUsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxFQUFFLEdBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUV0RSxNQUFNLElBQUksR0FBRyxPQUFPLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsRUFBRSxHQUFDLENBQUMsQ0FBQztZQUNqRCxVQUFVLENBQUMsSUFBSSxDQUFDLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsT0FBTyxDQUFDLEVBQUUsRUFBRSxNQUFNLEVBQUUsUUFBUSxHQUFHLE9BQU8sQ0FBQyxVQUFVLEVBQUMsQ0FBQyxDQUFDO1FBQ3RGLENBQUM7SUFDRixDQUFDO0lBRUQsd0JBQXdCO0lBQ3hCLHlFQUF5RTtJQUN6RSxnREFBZ0Q7SUFDaEQsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUNiLE9BQU8sRUFBRSxVQUFVO1FBQ25CLFdBQVcsRUFBRSxjQUFjLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQztLQUN0QyxDQUFDLENBQUM7SUFFSCxtREFBbUQ7SUFDbkQsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDLEVBQUUsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQyxNQUFNLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDdkYsTUFBTSxrQkFBa0IsR0FBRyxTQUFTLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO0lBQ3JFLE1BQU0sZUFBZSxHQUFHLGNBQWMsQ0FBQyxPQUFPLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUVuRSxpRkFBaUY7SUFDakYsSUFBSSxDQUFDLFFBQVEsQ0FBQztRQUNiLE9BQU8sRUFBRSxlQUFlO1FBQ3hCLE9BQU8sRUFBRSxZQUFZLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQztLQUM5QixDQUFDLENBQUM7QUFDSixDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsSUFBZ0IsRUFBRSxRQUE2QixFQUFFLGlCQUF5QjtJQUNsRyx3REFBd0Q7SUFDeEQsTUFBTSxTQUFTLEdBQUcsU0FBUyxDQUFDLEVBQUUsQ0FBQyxRQUFRLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztJQUM1RCxNQUFNLFlBQVksR0FBRyxRQUFRLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3pELE1BQU0sWUFBWSxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFFcEUsTUFBTSxhQUFhLEdBQWlCLEVBQUUsQ0FBQztJQUN2QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQzFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZFLENBQUM7SUFFRCxPQUFPLGFBQWEsQ0FBQztBQUN0QixDQUFDO0FBRUQsU0FBUyxZQUFZLENBQUMsSUFBZ0IsRUFBRSxRQUF1QjtJQUM5RCxNQUFNLEtBQUssR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN4QyxNQUFNLGFBQWEsR0FBRywyQkFBMkIsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFFbkUsV0FBVyxDQUFDLElBQUksRUFBRSxhQUFhLENBQUMsQ0FBQztBQUNsQyxDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsSUFBZ0IsRUFBRSxRQUF1QjtJQUNoRSwwQkFBMEI7SUFDMUIsTUFBTSxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE9BQW9CLEVBQUUsRUFBRTtRQUNyRCxPQUFPLEVBQUMsSUFBSSxFQUFFLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE9BQU8sQ0FBQyxFQUFFLEVBQUUsTUFBTSxFQUFFLE9BQU8sQ0FBQyxXQUFXLEVBQUMsQ0FBQTtJQUN6RSxDQUFDLENBQUMsQ0FBQztJQUVILElBQUksQ0FBQyxRQUFRLENBQUM7UUFDYixPQUFPLEVBQUUsT0FBTztLQUNoQixDQUFDLENBQUM7SUFFSCwyQkFBMkI7SUFDM0IsTUFBTSxRQUFRLEdBQUcsd0JBQXdCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkQsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsMEZBQTBGO0FBQy9ILENBQUM7QUFFRCxpREFBaUQ7QUFDakQsTUFBTSxVQUFVLHlCQUF5QixDQUFDLElBQWdCO0lBQ3pELE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFFM0QsU0FBUyxHQUFHLENBQUMsWUFBb0I7UUFDaEMsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFFM0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDckMsNEVBQTRFO1FBQzVFLDRDQUE0QztRQUM1QyxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUM3QyxJQUFJLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ3hDLFVBQVUsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELElBQUksT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUM7WUFDekIsT0FBTyxHQUFHLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTlCLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDYixTQUFTLEVBQUUsVUFBVTtTQUNyQixDQUFDLENBQUM7UUFDSCxnQkFBZ0IsRUFBRSxDQUFDO1FBRW5CLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVELE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclZpZXcgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xuaW1wb3J0IHsgQ2hhbmdlU2V0IH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XG5pbXBvcnQgeyBzdGFydFNuaXBwZXQgfSBmcm9tIFwiLi9jb2RlbWlycm9yL2hpc3RvcnlcIjtcbmltcG9ydCB7IGlzb2xhdGVIaXN0b3J5IH0gZnJvbSBcIkBjb2RlbWlycm9yL2NvbW1hbmRzXCI7XG5pbXBvcnQgeyBUYWJzdG9wU3BlYywgdGFic3RvcFNwZWNzVG9UYWJzdG9wR3JvdXBzIH0gZnJvbSBcIi4vdGFic3RvcFwiO1xuaW1wb3J0IHsgYWRkVGFic3RvcHMsIGdldFRhYnN0b3BHcm91cHNGcm9tVmlldywgZ2V0TmV4dFRhYnN0b3BDb2xvciwgdGFic3RvcHNTdGF0ZUZpZWxkIH0gZnJvbSBcIi4vY29kZW1pcnJvci90YWJzdG9wc19zdGF0ZV9maWVsZFwiO1xuaW1wb3J0IHsgY2xlYXJTbmlwcGV0UXVldWUsIHNuaXBwZXRRdWV1ZVN0YXRlRmllbGQgfSBmcm9tIFwiLi9jb2RlbWlycm9yL3NuaXBwZXRfcXVldWVfc3RhdGVfZmllbGRcIjtcbmltcG9ydCB7IFNuaXBwZXRDaGFuZ2VTcGVjIH0gZnJvbSBcIi4vY29kZW1pcnJvci9zbmlwcGV0X2NoYW5nZV9zcGVjXCI7XG5pbXBvcnQgeyByZXNldEN1cnNvckJsaW5rIH0gZnJvbSBcInNyYy91dGlscy9lZGl0b3JfdXRpbHNcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGV4cGFuZFNuaXBwZXRzKHZpZXc6IEVkaXRvclZpZXcpOmJvb2xlYW4ge1xuXHRjb25zdCBzbmlwcGV0c1RvRXhwYW5kID0gdmlldy5zdGF0ZS5maWVsZChzbmlwcGV0UXVldWVTdGF0ZUZpZWxkKTtcblx0aWYgKHNuaXBwZXRzVG9FeHBhbmQubGVuZ3RoID09PSAwKSByZXR1cm4gZmFsc2U7XG5cblx0Y29uc3Qgb3JpZ2luYWxEb2NMZW5ndGggPSB2aWV3LnN0YXRlLmRvYy5sZW5ndGg7XG5cblx0aGFuZGxlVW5kb0tleXByZXNzZXModmlldywgc25pcHBldHNUb0V4cGFuZCk7XG5cblx0Y29uc3QgdGFic3RvcHNUb0FkZCA9IGNvbXB1dGVUYWJzdG9wcyh2aWV3LCBzbmlwcGV0c1RvRXhwYW5kLCBvcmlnaW5hbERvY0xlbmd0aCk7XG5cblx0Ly8gSW5zZXJ0IGFueSB0YWJzdG9wc1xuXHRpZiAodGFic3RvcHNUb0FkZC5sZW5ndGggPT09IDApIHtcblx0XHRjbGVhclNuaXBwZXRRdWV1ZSh2aWV3KTtcblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdG1hcmtUYWJzdG9wcyh2aWV3LCB0YWJzdG9wc1RvQWRkKTtcblx0ZXhwYW5kVGFic3RvcHModmlldywgdGFic3RvcHNUb0FkZCk7XG5cblx0Y2xlYXJTbmlwcGV0UXVldWUodmlldyk7XG5cdHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiBoYW5kbGVVbmRvS2V5cHJlc3Nlcyh2aWV3OiBFZGl0b3JWaWV3LCBzbmlwcGV0czogU25pcHBldENoYW5nZVNwZWNbXSkge1xuXHRjb25zdCBvcmlnaW5hbERvYyA9IHZpZXcuc3RhdGUuZG9jO1xuXHRjb25zdCBvcmlnaW5hbERvY0xlbmd0aCA9IG9yaWdpbmFsRG9jLmxlbmd0aDtcblxuXHRjb25zdCBrZXlQcmVzc2VzOiB7ZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyLCBpbnNlcnQ6IHN0cmluZ31bXSA9IFtdO1xuXHRmb3IgKGNvbnN0IHNuaXBwZXQgb2Ygc25pcHBldHMpIHtcblx0XHRpZiAoc25pcHBldC5rZXlQcmVzc2VkICYmIChzbmlwcGV0LmtleVByZXNzZWQubGVuZ3RoID09PSAxKSkge1xuXHRcdFx0Ly8gVXNlIHByZXZDaGFyIHNvIHRoYXQgY3Vyc29ycyBhcmUgcGxhY2VkIGF0IHRoZSBlbmQgb2YgdGhlIGFkZGVkIHRleHRcblx0XHRcdGNvbnN0IHByZXZDaGFyID0gdmlldy5zdGF0ZS5kb2Muc2xpY2VTdHJpbmcoc25pcHBldC50by0xLCBzbmlwcGV0LnRvKTtcblxuXHRcdFx0Y29uc3QgZnJvbSA9IHNuaXBwZXQudG8gPT09IDAgPyAwIDogc25pcHBldC50by0xO1xuXHRcdFx0a2V5UHJlc3Nlcy5wdXNoKHtmcm9tOiBmcm9tLCB0bzogc25pcHBldC50bywgaW5zZXJ0OiBwcmV2Q2hhciArIHNuaXBwZXQua2V5UHJlc3NlZH0pO1xuXHRcdH1cblx0fVxuXG5cdC8vIEluc2VydCB0aGUga2V5cHJlc3Nlc1xuXHQvLyBVc2UgaXNvbGF0ZUhpc3RvcnkgdG8gYWxsb3cgdXNlcnMgdG8gdW5kbyB0aGUgdHJpZ2dlcmluZyBvZiBhIHNuaXBwZXQsXG5cdC8vIGJ1dCBrZWVwIHRoZSB0ZXh0IGluc2VydGVkIGJ5IHRoZSB0cmlnZ2VyIGtleVxuXHR2aWV3LmRpc3BhdGNoKHtcblx0XHRjaGFuZ2VzOiBrZXlQcmVzc2VzLFxuXHRcdGFubm90YXRpb25zOiBpc29sYXRlSGlzdG9yeS5vZihcImZ1bGxcIilcblx0fSk7XG5cblx0Ly8gVW5kbyB0aGUga2V5cHJlc3NlcywgYW5kIGluc2VydCB0aGUgcmVwbGFjZW1lbnRzXG5cdGNvbnN0IHVuZG9LZXlQcmVzc2VzID0gQ2hhbmdlU2V0Lm9mKGtleVByZXNzZXMsIG9yaWdpbmFsRG9jTGVuZ3RoKS5pbnZlcnQob3JpZ2luYWxEb2MpO1xuXHRjb25zdCBjaGFuZ2VzQXNDaGFuZ2VTZXQgPSBDaGFuZ2VTZXQub2Yoc25pcHBldHMsIG9yaWdpbmFsRG9jTGVuZ3RoKTtcblx0Y29uc3QgY29tYmluZWRDaGFuZ2VzID0gdW5kb0tleVByZXNzZXMuY29tcG9zZShjaGFuZ2VzQXNDaGFuZ2VTZXQpO1xuXG5cdC8vIE1hcmsgdGhlIHRyYW5zYWN0aW9uIGFzIHRoZSBiZWdpbm5pbmcgb2YgYSBzbmlwcGV0IChmb3IgdW5kby9oaXN0b3J5IHB1cnBvc2VzKVxuXHR2aWV3LmRpc3BhdGNoKHtcblx0XHRjaGFuZ2VzOiBjb21iaW5lZENoYW5nZXMsXG5cdFx0ZWZmZWN0czogc3RhcnRTbmlwcGV0Lm9mKG51bGwpXG5cdH0pO1xufVxuXG5mdW5jdGlvbiBjb21wdXRlVGFic3RvcHModmlldzogRWRpdG9yVmlldywgc25pcHBldHM6IFNuaXBwZXRDaGFuZ2VTcGVjW10sIG9yaWdpbmFsRG9jTGVuZ3RoOiBudW1iZXIpIHtcblx0Ly8gRmluZCB0aGUgcG9zaXRpb25zIG9mIHRoZSBjdXJzb3JzIGluIHRoZSBuZXcgZG9jdW1lbnRcblx0Y29uc3QgY2hhbmdlU2V0ID0gQ2hhbmdlU2V0Lm9mKHNuaXBwZXRzLCBvcmlnaW5hbERvY0xlbmd0aCk7XG5cdGNvbnN0IG9sZFBvc2l0aW9ucyA9IHNuaXBwZXRzLm1hcChjaGFuZ2UgPT4gY2hhbmdlLmZyb20pO1xuXHRjb25zdCBuZXdQb3NpdGlvbnMgPSBvbGRQb3NpdGlvbnMubWFwKHBvcyA9PiBjaGFuZ2VTZXQubWFwUG9zKHBvcykpO1xuXG5cdGNvbnN0IHRhYnN0b3BzVG9BZGQ6VGFic3RvcFNwZWNbXSA9IFtdO1xuXHRmb3IgKGxldCBpID0gMDsgaSA8IHNuaXBwZXRzLmxlbmd0aDsgaSsrKSB7XG5cdFx0dGFic3RvcHNUb0FkZC5wdXNoKC4uLnNuaXBwZXRzW2ldLmdldFRhYnN0b3BzKHZpZXcsIG5ld1Bvc2l0aW9uc1tpXSkpO1xuXHR9XG5cblx0cmV0dXJuIHRhYnN0b3BzVG9BZGQ7XG59XG5cbmZ1bmN0aW9uIG1hcmtUYWJzdG9wcyh2aWV3OiBFZGl0b3JWaWV3LCB0YWJzdG9wczogVGFic3RvcFNwZWNbXSkge1xuXHRjb25zdCBjb2xvciA9IGdldE5leHRUYWJzdG9wQ29sb3Iodmlldyk7XG5cdGNvbnN0IHRhYnN0b3BHcm91cHMgPSB0YWJzdG9wU3BlY3NUb1RhYnN0b3BHcm91cHModGFic3RvcHMsIGNvbG9yKTtcblxuXHRhZGRUYWJzdG9wcyh2aWV3LCB0YWJzdG9wR3JvdXBzKTtcbn1cblxuZnVuY3Rpb24gZXhwYW5kVGFic3RvcHModmlldzogRWRpdG9yVmlldywgdGFic3RvcHM6IFRhYnN0b3BTcGVjW10pIHtcblx0Ly8gSW5zZXJ0IHRoZSByZXBsYWNlbWVudHNcblx0Y29uc3QgY2hhbmdlcyA9IHRhYnN0b3BzLm1hcCgodGFic3RvcDogVGFic3RvcFNwZWMpID0+IHtcblx0XHRyZXR1cm4ge2Zyb206IHRhYnN0b3AuZnJvbSwgdG86IHRhYnN0b3AudG8sIGluc2VydDogdGFic3RvcC5yZXBsYWNlbWVudH1cblx0fSk7XG5cblx0dmlldy5kaXNwYXRjaCh7XG5cdFx0Y2hhbmdlczogY2hhbmdlc1xuXHR9KTtcblxuXHQvLyBTZWxlY3QgdGhlIGZpcnN0IHRhYnN0b3Bcblx0Y29uc3QgZmlyc3RHcnAgPSBnZXRUYWJzdG9wR3JvdXBzRnJvbVZpZXcodmlldylbMF07XG5cdGZpcnN0R3JwLnNlbGVjdCh2aWV3LCBmYWxzZSwgdHJ1ZSk7IC8vIFwidHJ1ZVwiIGhlcmUgbWFya3MgdGhlIHRyYW5zYWN0aW9uIGFzIHRoZSBlbmQgb2YgdGhlIHNuaXBwZXQgKGZvciB1bmRvL2hpc3RvcnkgcHVycG9zZXMpXG59XG5cbi8vIFJldHVybnMgdHJ1ZSBpZiB0aGUgdHJhbnNhY3Rpb24gd2FzIGRpc3BhdGNoZWRcbmV4cG9ydCBmdW5jdGlvbiBzZXRTZWxlY3Rpb25Ub05leHRUYWJzdG9wKHZpZXc6IEVkaXRvclZpZXcpOiBib29sZWFuIHtcblx0Y29uc3QgdGFic3RvcEdyb3VwcyA9IHZpZXcuc3RhdGUuZmllbGQodGFic3RvcHNTdGF0ZUZpZWxkKTtcblxuXHRmdW5jdGlvbiBhdXgobmV4dEdycEluZGV4OiBudW1iZXIpIHtcblx0XHRjb25zdCBuZXh0R3JwID0gdGFic3RvcEdyb3Vwc1tuZXh0R3JwSW5kZXhdO1xuXHRcdGlmICghbmV4dEdycCkgcmV0dXJuIGZhbHNlO1xuXG5cdFx0Y29uc3QgY3VyclNlbCA9IHZpZXcuc3RhdGUuc2VsZWN0aW9uO1xuXHRcdC8vIElmIHRoZSBjdXJyZW50IHNlbGVjdGlvbiBsaWVzIHdpdGhpbiB0aGUgbmV4dCB0YWJzdG9wKHMpLCBtb3ZlIHRoZSBjdXJzb3Jcblx0XHQvLyB0byB0aGUgZW5kcG9pbnQocykgb2YgdGhlIG5leHQgdGFic3RvcChzKVxuXHRcdGxldCBuZXh0R3JwU2VsID0gbmV4dEdycC50b0VkaXRvclNlbGVjdGlvbigpO1xuXHRcdGlmIChuZXh0R3JwLmNvbnRhaW5zU2VsZWN0aW9uKGN1cnJTZWwpKSB7XG5cdFx0XHRuZXh0R3JwU2VsID0gbmV4dEdycC50b0VkaXRvclNlbGVjdGlvbih0cnVlKTtcblx0XHR9XG5cblx0XHRpZiAoY3VyclNlbC5lcShuZXh0R3JwU2VsKSlcblx0XHRcdHJldHVybiBhdXgobmV4dEdycEluZGV4ICsgMSk7XG5cblx0XHR2aWV3LmRpc3BhdGNoKHtcblx0XHRcdHNlbGVjdGlvbjogbmV4dEdycFNlbCxcblx0XHR9KTtcblx0XHRyZXNldEN1cnNvckJsaW5rKCk7XG5cblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdHJldHVybiBhdXgoMSk7XG59XG4iXX0=