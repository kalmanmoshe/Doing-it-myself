import { ChangeSet } from "@codemirror/state";
import { startSnippet } from "src/codemirror/history";
import { isolateHistory } from "@codemirror/commands";
import { tabstopSpecsToTabstopGroups } from "./tabstop";
import { addTabstops, getTabstopGroupsFromView, getNextTabstopColor, tabstopsStateField } from "src/codemirror/tabstops_state_field";
import { clearSnippetQueue, snippetQueueStateField } from "src/codemirror/snippet_queue_state_field";
import { resetCursorBlink } from "src/editor utilities/editor_utils";
export function expandSnippets(view) {
    const snippetsToExpand = view.state.field(snippetQueueStateField);
    if (snippetsToExpand.length === 0)
        return false;
    const originalDocLength = view.state.doc.length;
    handleUndoKeypresses(view, snippetsToExpand);
    const tabstopsToAdd = computeTabstops(view, snippetsToExpand, originalDocLength);
    // Insert any tabstops
    if (tabstopsToAdd.length === 0) {
        clearSnippetQueue(view);
        return true;
    }
    markTabstops(view, tabstopsToAdd);
    expandTabstops(view, tabstopsToAdd);
    clearSnippetQueue(view);
    return true;
}
function handleUndoKeypresses(view, snippets) {
    const originalDoc = view.state.doc;
    const originalDocLength = originalDoc.length;
    const keyPresses = [];
    for (const snippet of snippets) {
        if (snippet.keyPressed && (snippet.keyPressed.length === 1)) {
            // Use prevChar so that cursors are placed at the end of the added text
            const prevChar = view.state.doc.sliceString(snippet.to - 1, snippet.to);
            const from = snippet.to === 0 ? 0 : snippet.to - 1;
            keyPresses.push({ from: from, to: snippet.to, insert: prevChar + snippet.keyPressed });
        }
    }
    // Insert the keypresses
    // Use isolateHistory to allow users to undo the triggering of a snippet,
    // but keep the text inserted by the trigger key
    view.dispatch({
        changes: keyPresses,
        annotations: isolateHistory.of("full")
    });
    // Undo the keypresses, and insert the replacements
    const undoKeyPresses = ChangeSet.of(keyPresses, originalDocLength).invert(originalDoc);
    const changesAsChangeSet = ChangeSet.of(snippets, originalDocLength);
    const combinedChanges = undoKeyPresses.compose(changesAsChangeSet);
    // Mark the transaction as the beginning of a snippet (for undo/history purposes)
    view.dispatch({
        changes: combinedChanges,
        effects: startSnippet.of(null)
    });
}
function computeTabstops(view, snippets, originalDocLength) {
    // Find the positions of the cursors in the new document
    const changeSet = ChangeSet.of(snippets, originalDocLength);
    const oldPositions = snippets.map(change => change.from);
    const newPositions = oldPositions.map(pos => changeSet.mapPos(pos));
    const tabstopsToAdd = [];
    for (let i = 0; i < snippets.length; i++) {
        tabstopsToAdd.push(...snippets[i].getTabstops(view, newPositions[i]));
    }
    return tabstopsToAdd;
}
function markTabstops(view, tabstops) {
    const color = getNextTabstopColor(view);
    const tabstopGroups = tabstopSpecsToTabstopGroups(tabstops, color);
    addTabstops(view, tabstopGroups);
}
function expandTabstops(view, tabstops) {
    // Insert the replacements
    const changes = tabstops.map((tabstop) => {
        return { from: tabstop.from, to: tabstop.to, insert: tabstop.replacement };
    });
    view.dispatch({
        changes: changes
    });
    // Select the first tabstop
    const firstGrp = getTabstopGroupsFromView(view)[0];
    firstGrp.select(view, false, true); // "true" here marks the transaction as the end of the snippet (for undo/history purposes)
}
// Returns true if the transaction was dispatched
export function setSelectionToNextTabstop(view) {
    console.log('view.state.field', view.state);
    const tabstopGroups = view.state.field(tabstopsStateField);
    console.log('tabstopGroups', tabstopGroups);
    function aux(nextGrpIndex) {
        const nextGrp = tabstopGroups[nextGrpIndex];
        if (!nextGrp)
            return false;
        const currSel = view.state.selection;
        // If the current selection lies within the next tabstop(s), move the cursor
        // to the endpoint(s) of the next tabstop(s)
        let nextGrpSel = nextGrp.toEditorSelection();
        if (nextGrp.containsSelection(currSel)) {
            nextGrpSel = nextGrp.toEditorSelection(true);
        }
        if (currSel.eq(nextGrpSel))
            return aux(nextGrpIndex + 1);
        view.dispatch({
            selection: nextGrpSel,
        });
        resetCursorBlink();
        return true;
    }
    return aux(1);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25pcHBldF9tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3NuaXBwZXRzL3NuaXBwZXRfbWFuYWdlbWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDOUMsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQ3RELE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUN0RCxPQUFPLEVBQWUsMkJBQTJCLEVBQUUsTUFBTSxXQUFXLENBQUM7QUFDckUsT0FBTyxFQUFFLFdBQVcsRUFBRSx3QkFBd0IsRUFBRSxtQkFBbUIsRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBQ3JJLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBRXJHLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBRXJFLE1BQU0sVUFBVSxjQUFjLENBQUMsSUFBZ0I7SUFDOUMsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxDQUFDO0lBQ2xFLElBQUksZ0JBQWdCLENBQUMsTUFBTSxLQUFLLENBQUM7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUVoRCxNQUFNLGlCQUFpQixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQztJQUVoRCxvQkFBb0IsQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztJQUU3QyxNQUFNLGFBQWEsR0FBRyxlQUFlLENBQUMsSUFBSSxFQUFFLGdCQUFnQixFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFFakYsc0JBQXNCO0lBQ3RCLElBQUksYUFBYSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUNoQyxpQkFB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QyxHQUFHLENBQUMsa0JBQWtCLEVBQUMsSUFBSSxDQUFDLEtBQUssQ0FBRSxDQUFBO0lBQzlDLE1BQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDeEQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUMsYUFBYSxDQUFDLENBQUE7SUFDN0MsU0FBUyxHQUFHLENBQUMsWUFBb0I7UUFDaEMsTUFBTSxPQUFPLEdBQUcsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxPQUFPO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFFM0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDckMsNEVBQTRFO1FBQzVFLDRDQUE0QztRQUM1QyxJQUFJLFVBQVUsR0FBRyxPQUFPLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztRQUM3QyxJQUFJLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ3hDLFVBQVUsR0FBRyxPQUFPLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDOUMsQ0FBQztRQUVELElBQUksT0FBTyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUM7WUFDekIsT0FBTyxHQUFHLENBQUMsWUFBWSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRTlCLElBQUksQ0FBQyxRQUFRLENBQUM7WUFDYixTQUFTLEVBQUUsVUFBVTtTQUNyQixDQUFDLENBQUM7UUFDSCxnQkFBZ0IsRUFBRSxDQUFDO1FBRW5CLE9BQU8sSUFBSSxDQUFDO0lBQ2IsQ0FBQztJQUVELE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQ2YsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclZpZXcgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xyXG5pbXBvcnQgeyBDaGFuZ2VTZXQgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgc3RhcnRTbmlwcGV0IH0gZnJvbSBcInNyYy9jb2RlbWlycm9yL2hpc3RvcnlcIjtcclxuaW1wb3J0IHsgaXNvbGF0ZUhpc3RvcnkgfSBmcm9tIFwiQGNvZGVtaXJyb3IvY29tbWFuZHNcIjtcclxuaW1wb3J0IHsgVGFic3RvcFNwZWMsIHRhYnN0b3BTcGVjc1RvVGFic3RvcEdyb3VwcyB9IGZyb20gXCIuL3RhYnN0b3BcIjtcclxuaW1wb3J0IHsgYWRkVGFic3RvcHMsIGdldFRhYnN0b3BHcm91cHNGcm9tVmlldywgZ2V0TmV4dFRhYnN0b3BDb2xvciwgdGFic3RvcHNTdGF0ZUZpZWxkIH0gZnJvbSBcInNyYy9jb2RlbWlycm9yL3RhYnN0b3BzX3N0YXRlX2ZpZWxkXCI7XHJcbmltcG9ydCB7IGNsZWFyU25pcHBldFF1ZXVlLCBzbmlwcGV0UXVldWVTdGF0ZUZpZWxkIH0gZnJvbSBcInNyYy9jb2RlbWlycm9yL3NuaXBwZXRfcXVldWVfc3RhdGVfZmllbGRcIjtcclxuaW1wb3J0IHsgU25pcHBldENoYW5nZVNwZWMgfSBmcm9tIFwic3JjL2NvZGVtaXJyb3Ivc25pcHBldF9jaGFuZ2Vfc3BlY1wiO1xyXG5pbXBvcnQgeyByZXNldEN1cnNvckJsaW5rIH0gZnJvbSBcInNyYy9lZGl0b3IgdXRpbGl0aWVzL2VkaXRvcl91dGlsc1wiO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4cGFuZFNuaXBwZXRzKHZpZXc6IEVkaXRvclZpZXcpOmJvb2xlYW4ge1xyXG5cdGNvbnN0IHNuaXBwZXRzVG9FeHBhbmQgPSB2aWV3LnN0YXRlLmZpZWxkKHNuaXBwZXRRdWV1ZVN0YXRlRmllbGQpO1xyXG5cdGlmIChzbmlwcGV0c1RvRXhwYW5kLmxlbmd0aCA9PT0gMCkgcmV0dXJuIGZhbHNlO1xyXG5cclxuXHRjb25zdCBvcmlnaW5hbERvY0xlbmd0aCA9IHZpZXcuc3RhdGUuZG9jLmxlbmd0aDtcclxuXHJcblx0aGFuZGxlVW5kb0tleXByZXNzZXModmlldywgc25pcHBldHNUb0V4cGFuZCk7XHJcblxyXG5cdGNvbnN0IHRhYnN0b3BzVG9BZGQgPSBjb21wdXRlVGFic3RvcHModmlldywgc25pcHBldHNUb0V4cGFuZCwgb3JpZ2luYWxEb2NMZW5ndGgpO1xyXG5cclxuXHQvLyBJbnNlcnQgYW55IHRhYnN0b3BzXHJcblx0aWYgKHRhYnN0b3BzVG9BZGQubGVuZ3RoID09PSAwKSB7XHJcblx0XHRjbGVhclNuaXBwZXRRdWV1ZSh2aWV3KTtcclxuXHRcdHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHJcblx0bWFya1RhYnN0b3BzKHZpZXcsIHRhYnN0b3BzVG9BZGQpO1xyXG5cdGV4cGFuZFRhYnN0b3BzKHZpZXcsIHRhYnN0b3BzVG9BZGQpO1xyXG5cclxuXHRjbGVhclNuaXBwZXRRdWV1ZSh2aWV3KTtcclxuXHRyZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGFuZGxlVW5kb0tleXByZXNzZXModmlldzogRWRpdG9yVmlldywgc25pcHBldHM6IFNuaXBwZXRDaGFuZ2VTcGVjW10pIHtcclxuXHRjb25zdCBvcmlnaW5hbERvYyA9IHZpZXcuc3RhdGUuZG9jO1xyXG5cdGNvbnN0IG9yaWdpbmFsRG9jTGVuZ3RoID0gb3JpZ2luYWxEb2MubGVuZ3RoO1xyXG5cclxuXHRjb25zdCBrZXlQcmVzc2VzOiB7ZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyLCBpbnNlcnQ6IHN0cmluZ31bXSA9IFtdO1xyXG5cdGZvciAoY29uc3Qgc25pcHBldCBvZiBzbmlwcGV0cykge1xyXG5cdFx0aWYgKHNuaXBwZXQua2V5UHJlc3NlZCAmJiAoc25pcHBldC5rZXlQcmVzc2VkLmxlbmd0aCA9PT0gMSkpIHtcclxuXHRcdFx0Ly8gVXNlIHByZXZDaGFyIHNvIHRoYXQgY3Vyc29ycyBhcmUgcGxhY2VkIGF0IHRoZSBlbmQgb2YgdGhlIGFkZGVkIHRleHRcclxuXHRcdFx0Y29uc3QgcHJldkNoYXIgPSB2aWV3LnN0YXRlLmRvYy5zbGljZVN0cmluZyhzbmlwcGV0LnRvLTEsIHNuaXBwZXQudG8pO1xyXG5cclxuXHRcdFx0Y29uc3QgZnJvbSA9IHNuaXBwZXQudG8gPT09IDAgPyAwIDogc25pcHBldC50by0xO1xyXG5cdFx0XHRrZXlQcmVzc2VzLnB1c2goe2Zyb206IGZyb20sIHRvOiBzbmlwcGV0LnRvLCBpbnNlcnQ6IHByZXZDaGFyICsgc25pcHBldC5rZXlQcmVzc2VkfSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHQvLyBJbnNlcnQgdGhlIGtleXByZXNzZXNcclxuXHQvLyBVc2UgaXNvbGF0ZUhpc3RvcnkgdG8gYWxsb3cgdXNlcnMgdG8gdW5kbyB0aGUgdHJpZ2dlcmluZyBvZiBhIHNuaXBwZXQsXHJcblx0Ly8gYnV0IGtlZXAgdGhlIHRleHQgaW5zZXJ0ZWQgYnkgdGhlIHRyaWdnZXIga2V5XHJcblx0dmlldy5kaXNwYXRjaCh7XHJcblx0XHRjaGFuZ2VzOiBrZXlQcmVzc2VzLFxyXG5cdFx0YW5ub3RhdGlvbnM6IGlzb2xhdGVIaXN0b3J5Lm9mKFwiZnVsbFwiKVxyXG5cdH0pO1xyXG5cclxuXHQvLyBVbmRvIHRoZSBrZXlwcmVzc2VzLCBhbmQgaW5zZXJ0IHRoZSByZXBsYWNlbWVudHNcclxuXHRjb25zdCB1bmRvS2V5UHJlc3NlcyA9IENoYW5nZVNldC5vZihrZXlQcmVzc2VzLCBvcmlnaW5hbERvY0xlbmd0aCkuaW52ZXJ0KG9yaWdpbmFsRG9jKTtcclxuXHRjb25zdCBjaGFuZ2VzQXNDaGFuZ2VTZXQgPSBDaGFuZ2VTZXQub2Yoc25pcHBldHMsIG9yaWdpbmFsRG9jTGVuZ3RoKTtcclxuXHRjb25zdCBjb21iaW5lZENoYW5nZXMgPSB1bmRvS2V5UHJlc3Nlcy5jb21wb3NlKGNoYW5nZXNBc0NoYW5nZVNldCk7XHJcblxyXG5cdC8vIE1hcmsgdGhlIHRyYW5zYWN0aW9uIGFzIHRoZSBiZWdpbm5pbmcgb2YgYSBzbmlwcGV0IChmb3IgdW5kby9oaXN0b3J5IHB1cnBvc2VzKVxyXG5cdHZpZXcuZGlzcGF0Y2goe1xyXG5cdFx0Y2hhbmdlczogY29tYmluZWRDaGFuZ2VzLFxyXG5cdFx0ZWZmZWN0czogc3RhcnRTbmlwcGV0Lm9mKG51bGwpXHJcblx0fSk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbXB1dGVUYWJzdG9wcyh2aWV3OiBFZGl0b3JWaWV3LCBzbmlwcGV0czogU25pcHBldENoYW5nZVNwZWNbXSwgb3JpZ2luYWxEb2NMZW5ndGg6IG51bWJlcikge1xyXG5cdC8vIEZpbmQgdGhlIHBvc2l0aW9ucyBvZiB0aGUgY3Vyc29ycyBpbiB0aGUgbmV3IGRvY3VtZW50XHJcblx0Y29uc3QgY2hhbmdlU2V0ID0gQ2hhbmdlU2V0Lm9mKHNuaXBwZXRzLCBvcmlnaW5hbERvY0xlbmd0aCk7XHJcblx0Y29uc3Qgb2xkUG9zaXRpb25zID0gc25pcHBldHMubWFwKGNoYW5nZSA9PiBjaGFuZ2UuZnJvbSk7XHJcblx0Y29uc3QgbmV3UG9zaXRpb25zID0gb2xkUG9zaXRpb25zLm1hcChwb3MgPT4gY2hhbmdlU2V0Lm1hcFBvcyhwb3MpKTtcclxuXHJcblx0Y29uc3QgdGFic3RvcHNUb0FkZDpUYWJzdG9wU3BlY1tdID0gW107XHJcblx0Zm9yIChsZXQgaSA9IDA7IGkgPCBzbmlwcGV0cy5sZW5ndGg7IGkrKykge1xyXG5cdFx0dGFic3RvcHNUb0FkZC5wdXNoKC4uLnNuaXBwZXRzW2ldLmdldFRhYnN0b3BzKHZpZXcsIG5ld1Bvc2l0aW9uc1tpXSkpO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIHRhYnN0b3BzVG9BZGQ7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIG1hcmtUYWJzdG9wcyh2aWV3OiBFZGl0b3JWaWV3LCB0YWJzdG9wczogVGFic3RvcFNwZWNbXSkge1xyXG5cdGNvbnN0IGNvbG9yID0gZ2V0TmV4dFRhYnN0b3BDb2xvcih2aWV3KTtcclxuXHRjb25zdCB0YWJzdG9wR3JvdXBzID0gdGFic3RvcFNwZWNzVG9UYWJzdG9wR3JvdXBzKHRhYnN0b3BzLCBjb2xvcik7XHJcblxyXG5cdGFkZFRhYnN0b3BzKHZpZXcsIHRhYnN0b3BHcm91cHMpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBleHBhbmRUYWJzdG9wcyh2aWV3OiBFZGl0b3JWaWV3LCB0YWJzdG9wczogVGFic3RvcFNwZWNbXSkge1xyXG5cdC8vIEluc2VydCB0aGUgcmVwbGFjZW1lbnRzXHJcblx0Y29uc3QgY2hhbmdlcyA9IHRhYnN0b3BzLm1hcCgodGFic3RvcDogVGFic3RvcFNwZWMpID0+IHtcclxuXHRcdHJldHVybiB7ZnJvbTogdGFic3RvcC5mcm9tLCB0bzogdGFic3RvcC50bywgaW5zZXJ0OiB0YWJzdG9wLnJlcGxhY2VtZW50fVxyXG5cdH0pO1xyXG5cclxuXHR2aWV3LmRpc3BhdGNoKHtcclxuXHRcdGNoYW5nZXM6IGNoYW5nZXNcclxuXHR9KTtcclxuXHJcblx0Ly8gU2VsZWN0IHRoZSBmaXJzdCB0YWJzdG9wXHJcblx0Y29uc3QgZmlyc3RHcnAgPSBnZXRUYWJzdG9wR3JvdXBzRnJvbVZpZXcodmlldylbMF07XHJcblx0Zmlyc3RHcnAuc2VsZWN0KHZpZXcsIGZhbHNlLCB0cnVlKTsgLy8gXCJ0cnVlXCIgaGVyZSBtYXJrcyB0aGUgdHJhbnNhY3Rpb24gYXMgdGhlIGVuZCBvZiB0aGUgc25pcHBldCAoZm9yIHVuZG8vaGlzdG9yeSBwdXJwb3NlcylcclxufVxyXG5cclxuLy8gUmV0dXJucyB0cnVlIGlmIHRoZSB0cmFuc2FjdGlvbiB3YXMgZGlzcGF0Y2hlZFxyXG5leHBvcnQgZnVuY3Rpb24gc2V0U2VsZWN0aW9uVG9OZXh0VGFic3RvcCh2aWV3OiBFZGl0b3JWaWV3KTogYm9vbGVhbiB7XHJcbiAgICBjb25zb2xlLmxvZygndmlldy5zdGF0ZS5maWVsZCcsdmlldy5zdGF0ZSwpXHJcblx0Y29uc3QgdGFic3RvcEdyb3VwcyA9IHZpZXcuc3RhdGUuZmllbGQodGFic3RvcHNTdGF0ZUZpZWxkKTtcclxuICAgIGNvbnNvbGUubG9nKCd0YWJzdG9wR3JvdXBzJyx0YWJzdG9wR3JvdXBzKVxyXG5cdGZ1bmN0aW9uIGF1eChuZXh0R3JwSW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xyXG5cdFx0Y29uc3QgbmV4dEdycCA9IHRhYnN0b3BHcm91cHNbbmV4dEdycEluZGV4XTtcclxuXHRcdGlmICghbmV4dEdycCkgcmV0dXJuIGZhbHNlO1xyXG5cclxuXHRcdGNvbnN0IGN1cnJTZWwgPSB2aWV3LnN0YXRlLnNlbGVjdGlvbjtcclxuXHRcdC8vIElmIHRoZSBjdXJyZW50IHNlbGVjdGlvbiBsaWVzIHdpdGhpbiB0aGUgbmV4dCB0YWJzdG9wKHMpLCBtb3ZlIHRoZSBjdXJzb3JcclxuXHRcdC8vIHRvIHRoZSBlbmRwb2ludChzKSBvZiB0aGUgbmV4dCB0YWJzdG9wKHMpXHJcblx0XHRsZXQgbmV4dEdycFNlbCA9IG5leHRHcnAudG9FZGl0b3JTZWxlY3Rpb24oKTtcclxuXHRcdGlmIChuZXh0R3JwLmNvbnRhaW5zU2VsZWN0aW9uKGN1cnJTZWwpKSB7XHJcblx0XHRcdG5leHRHcnBTZWwgPSBuZXh0R3JwLnRvRWRpdG9yU2VsZWN0aW9uKHRydWUpO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmIChjdXJyU2VsLmVxKG5leHRHcnBTZWwpKVxyXG5cdFx0XHRyZXR1cm4gYXV4KG5leHRHcnBJbmRleCArIDEpO1xyXG5cclxuXHRcdHZpZXcuZGlzcGF0Y2goe1xyXG5cdFx0XHRzZWxlY3Rpb246IG5leHRHcnBTZWwsXHJcblx0XHR9KTtcclxuXHRcdHJlc2V0Q3Vyc29yQmxpbmsoKTtcclxuXHJcblx0XHRyZXR1cm4gdHJ1ZTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBhdXgoMSk7XHJcbn0iXX0=