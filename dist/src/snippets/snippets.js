/**
 * in visual snippets, if the replacement is a string, this is the magic substring to indicate the selection.
 */
export const VISUAL_SNIPPET_MAGIC_SELECTION_PLACEHOLDER = "${VISUAL}";
/**
 * a snippet instance contains all the information necessary to run a snippet.
 * snippet data specific to a certain type of snippet is in its `data` property.
 */
export class Snippet {
    constructor(type, trigger, replacement, options, priority, description, excludedEnvironments) {
        this.type = type;
        // @ts-ignore
        this.data = { trigger, replacement };
        this.options = options;
        this.priority = priority;
        this.description = description;
        this.excludedEnvironments = excludedEnvironments !== null && excludedEnvironments !== void 0 ? excludedEnvironments : [];
    }
    // we need to explicitly type the return value here so the derived classes,
    // have the getter typed properly for the particular <T> the derived class extends
    get trigger() { return this.data.trigger; }
    get replacement() { return this.data.replacement; }
    toString() {
        return serializeSnippetLike({
            type: this.type,
            trigger: this.trigger,
            replacement: this.replacement,
            options: this.options,
            priority: this.priority,
            description: this.description,
            excludedEnvironments: this.excludedEnvironments,
        });
    }
}
export class VisualSnippet extends Snippet {
    constructor({ trigger, replacement, options, priority, description, excludedEnvironments }) {
        super("visual", trigger, replacement, options, priority, description, excludedEnvironments);
    }
    process(effectiveLine, range, sel) {
        const hasSelection = !!sel;
        // visual snippets only run when there is a selection
        if (!hasSelection) {
            return null;
        }
        // check whether the trigger text was typed
        if (!(effectiveLine.endsWith(this.trigger))) {
            return null;
        }
        const triggerPos = range.from;
        let replacement;
        if (typeof this.replacement === "string") {
            replacement = this.replacement.replace(VISUAL_SNIPPET_MAGIC_SELECTION_PLACEHOLDER, sel);
        }
        else {
            replacement = this.replacement(sel);
            // sanity check - if this.replacement was a function,
            // we have no way to validate beforehand that it really does return a string
            if (typeof replacement !== "string") {
                return null;
            }
        }
        return { triggerPos, replacement };
    }
}
export class RegexSnippet extends Snippet {
    constructor({ trigger, replacement, options, priority, description, excludedEnvironments }) {
        super("regex", trigger, replacement, options, priority, description, excludedEnvironments);
    }
    process(effectiveLine, range, sel) {
        const hasSelection = !!sel;
        // non-visual snippets only run when there is no selection
        if (hasSelection) {
            return null;
        }
        const result = this.trigger.exec(effectiveLine);
        if (result === null) {
            return null;
        }
        const triggerPos = result.index;
        let replacement;
        if (typeof this.replacement === "string") {
            // Compute the replacement string
            // result.length - 1 = the number of capturing groups
            const nCaptureGroups = result.length - 1;
            replacement = Array.from({ length: nCaptureGroups })
                .map((_, i) => i + 1)
                .reduce((replacement, i) => replacement.replaceAll(`[[${i - 1}]]`, result[i]), this.replacement);
        }
        else {
            replacement = this.replacement(result);
            // sanity check - if this.replacement was a function,
            // we have no way to validate beforehand that it really does return a string
            if (typeof replacement !== "string") {
                return null;
            }
        }
        return { triggerPos, replacement };
    }
}
export class StringSnippet extends Snippet {
    constructor({ trigger, replacement, options, priority, description, excludedEnvironments: excludeIn }) {
        super("string", trigger, replacement, options, priority, description, excludeIn);
    }
    process(effectiveLine, range, sel) {
        const hasSelection = !!sel;
        // non-visual snippets only run when there is no selection
        if (hasSelection) {
            return null;
        }
        // Check whether the trigger text was typed
        if (!(effectiveLine.endsWith(this.trigger))) {
            return null;
        }
        const triggerPos = effectiveLine.length - this.trigger.length;
        const replacement = typeof this.replacement === "string"
            ? this.replacement
            : this.replacement(this.trigger);
        // sanity check - if replacement was a function,
        // we have no way to validate beforehand that it really does return a string
        if (typeof replacement !== "string") {
            return null;
        }
        return { triggerPos, replacement };
    }
}
/**
 * replacer function for serializing snippets
 * @param k
 * @param v
 * @returns
 */
function replacer(k, v) {
    if (typeof v === "function") {
        return "[[Function]]";
    }
    if (v instanceof RegExp) {
        return `[[RegExp]]: ${v.toString()}`;
    }
    return v;
}
/**
 * serialize a snippet-like object.
 */
export function serializeSnippetLike(snippetLike) {
    return JSON.stringify(snippetLike, replacer, 2);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic25pcHBldHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvc25pcHBldHMvc25pcHBldHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBSUE7O0dBRUc7QUFDSCxNQUFNLENBQUMsTUFBTSwwQ0FBMEMsR0FBRyxXQUFXLENBQUM7QUF1Q3RFOzs7R0FHRztBQUNILE1BQU0sT0FBZ0IsT0FBTztJQVM1QixZQUNDLElBQU8sRUFDUCxPQUFrQyxFQUNsQyxXQUEwQyxFQUMxQyxPQUFnQixFQUNoQixRQUE2QixFQUM3QixXQUFnQyxFQUNoQyxvQkFBb0M7UUFFcEMsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7UUFDakIsYUFBYTtRQUNiLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLENBQUM7UUFDckMsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxDQUFDLFFBQVEsR0FBRyxRQUFRLENBQUM7UUFDekIsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7UUFDL0IsSUFBSSxDQUFDLG9CQUFvQixHQUFHLG9CQUFvQixhQUFwQixvQkFBb0IsY0FBcEIsb0JBQW9CLEdBQUksRUFBRSxDQUFDO0lBQ3hELENBQUM7SUFFRCwyRUFBMkU7SUFDM0Usa0ZBQWtGO0lBQ2xGLElBQUksT0FBTyxLQUFnQyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUN0RSxJQUFJLFdBQVcsS0FBb0MsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7SUFJbEYsUUFBUTtRQUNQLE9BQU8sb0JBQW9CLENBQUM7WUFDM0IsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJO1lBQ2YsT0FBTyxFQUFFLElBQUksQ0FBQyxPQUFPO1lBQ3JCLFdBQVcsRUFBRSxJQUFJLENBQUMsV0FBVztZQUM3QixPQUFPLEVBQUUsSUFBSSxD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SSxDQUFDLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQztZQUFDLE9BQU8sSUFBSSxDQUFDO1FBQUMsQ0FBQztRQUU3RCxNQUFNLFVBQVUsR0FBRyxhQUFhLENBQUMsTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQzlELE1BQU0sV0FBVyxHQUFHLE9BQU8sSUFBSSxDQUFDLFdBQVcsS0FBSyxRQUFRO1lBQ3ZELENBQUMsQ0FBQyxJQUFJLENBQUMsV0FBVztZQUNsQixDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7UUFFbEMsZ0RBQWdEO1FBQ2hELDRFQUE0RTtRQUM1RSxJQUFJLE9BQU8sV0FBVyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQUMsT0FBTyxJQUFJLENBQUM7UUFBQyxDQUFDO1FBRXJELE9BQU8sRUFBRSxVQUFVLEVBQUUsV0FBVyxFQUFFLENBQUM7SUFDcEMsQ0FBQztDQUNEO0FBRUQ7Ozs7O0dBS0c7QUFDSCxTQUFTLFFBQVEsQ0FBQyxDQUFTLEVBQUUsQ0FBVTtJQUN0QyxJQUFJLE9BQU8sQ0FBQyxLQUFLLFVBQVUsRUFBRSxDQUFDO1FBQUMsT0FBTyxjQUFjLENBQUM7SUFBQyxDQUFDO0lBQ3ZELElBQUksQ0FBQyxZQUFZLE1BQU0sRUFBRSxDQUFDO1FBQUMsT0FBTyxlQUFlLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDO0lBQUMsQ0FBQztJQUNsRSxPQUFPLENBQUMsQ0FBQztBQUNWLENBQUM7QUFVRDs7R0FFRztBQUNILE1BQU0sVUFBVSxvQkFBb0IsQ0FBQyxXQUFvQjtJQUN4RCxPQUFPLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztBQUNqRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU2VsZWN0aW9uUmFuZ2UgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgT3B0aW9ucyB9IGZyb20gXCIuL29wdGlvbnNcIjtcclxuaW1wb3J0IHsgRW52aXJvbm1lbnQgfSBmcm9tIFwiLi9lbnZpcm9ubWVudFwiO1xyXG5cclxuLyoqXHJcbiAqIGluIHZpc3VhbCBzbmlwcGV0cywgaWYgdGhlIHJlcGxhY2VtZW50IGlzIGEgc3RyaW5nLCB0aGlzIGlzIHRoZSBtYWdpYyBzdWJzdHJpbmcgdG8gaW5kaWNhdGUgdGhlIHNlbGVjdGlvbi5cclxuICovXHJcbmV4cG9ydCBjb25zdCBWSVNVQUxfU05JUFBFVF9NQUdJQ19TRUxFQ1RJT05fUExBQ0VIT0xERVIgPSBcIiR7VklTVUFMfVwiO1xyXG5cclxuLyoqXHJcbiAqIHRoZXJlIGFyZSAzIGRpc3RpbmN0IHR5cGVzIG9mIHNuaXBwZXRzOlxyXG4gKlxyXG4gKiBgdmlzdWFsYCBzbmlwcGV0cyBvbmx5IHRyaWdnZXIgb24gdGV4dCBzZWxlY3Rpb25zLlxyXG4gKiB2aXN1YWwgc25pcHBldHMgc3VwcG9ydCBvbmx5IChzaW5nbGUtY2hhcmFjdGVyKSBzdHJpbmcgdHJpZ2dlcnMsIGFuZCBzdHJpbmcgb3IgZnVuY3Rpb24gcmVwbGFjZW1lbnRzLlxyXG4gKiB2aXN1YWwgcmVwbGFjZW1lbnQgZnVuY3Rpb25zIHRha2UgaW4gdGhlIHRleHQgc2VsZWN0aW9uIGFuZCByZXR1cm4gYSBzdHJpbmcsIG9yIGBmYWxzZWAgdG8gaW5kaWNhdGUgdG8gYWN0dWFsbHkgbm90IGRvIGFueXRoaW5nLlxyXG4gKlxyXG4gKiBgcmVnZXhgIHNuaXBwZXRzIHN1cHBvcnQgc3RyaW5nICh3aXRoIHRoZSBcInJcIiByYXcgb3B0aW9uIHNldCkgb3IgcmVnZXggdHJpZ2dlcnMsIGFuZCBzdHJpbmcgb3IgZnVuY3Rpb24gcmVwbGFjZW1lbnRzLlxyXG4gKiByZWdleCByZXBsYWNlbWVudCBmdW5jdGlvbnMgdGFrZSBpbiB0aGUgcmVnZXggbWF0Y2ggYW5kIHJldHVybiBhIHN0cmluZy5cclxuICpcclxuICogYHN0cmluZ2Agc25pcHBldHMgc3VwcG9ydCBzdHJpbmcgdHJpZ2dlcnMgKHdoZW4gbm8gXCJyXCIgcmF3IG9wdGlvbiBzZXQpLCBhbmQgc3RyaW5nIG9yIGZ1bmN0aW9uIHJlcGxhY2VtZW50cy5cclxuICogc3RyaW5nIHJlcGxhY2VtZW50IGZ1bmN0aW9ucyB0YWtlIGluIHRoZSBtYXRjaGVkIHN0cmluZyBhbmQgcmV0dXJuIGEgc3RyaW5nLlxyXG4gKi9cclxuZXhwb3J0IHR5cGUgU25pcHBldFR5cGUgPVxyXG5cdHwgXCJ2aXN1YWxcIlxyXG5cdHwgXCJyZWdleFwiXHJcblx0fCBcInN0cmluZ1wiXHJcblxyXG5leHBvcnQgdHlwZSBTbmlwcGV0RGF0YTxUIGV4dGVuZHMgU25pcHBldFR5cGU+ID0ge1xyXG5cdHZpc3VhbDoge1xyXG5cdFx0dHJpZ2dlcjogc3RyaW5nO1xyXG5cdFx0cmVwbGFjZW1lbnQ6IHN0cmluZyB8ICgoc2VsZWN0aW9uOiBzdHJpbmcpID0+IHN0cmluZyB8IGZhbHNlKTtcclxuXHR9O1xyXG5cdHJlZ2V4OiB7XHJcblx0XHR0cmlnZ2VyOiBSZWdFeHA7XHJcblx0XHRyZXBsYWNlbWVudDogc3RyaW5nIHwgKChtYXRjaDogUmVnRXhwRXhlY0FycmF5KSA9PiBzdHJpbmcpO1xyXG5cdH07XHJcblx0c3RyaW5nOiB7XHJcblx0XHR0cmlnZ2VyOiBzdHJpbmc7XHJcblx0XHRyZXBsYWNlbWVudDogc3RyaW5nIHwgKChtYXRjaDogc3RyaW5nKSA9PiBzdHJpbmcpO1xyXG5cdH07XHJcbn1bVF1cclxuXHJcbmV4cG9ydCB0eXBlIFByb2Nlc3NTbmlwcGV0UmVzdWx0ID1cclxuXHR8IHsgdHJpZ2dlclBvczogbnVtYmVyLCByZXBsYWNlbWVudDogc3RyaW5nIH1cclxuXHR8IG51bGxcclxuXHJcbi8qKlxyXG4gKiBhIHNuaXBwZXQgaW5zdGFuY2UgY29udGFpbnMgYWxsIHRoZSBpbmZvcm1hdGlvbiBuZWNlc3NhcnkgdG8gcnVuIGEgc25pcHBldC5cclxuICogc25pcHBldCBkYXRhIHNwZWNpZmljIHRvIGEgY2VydGFpbiB0eXBlIG9mIHNuaXBwZXQgaXMgaW4gaXRzIGBkYXRhYCBwcm9wZXJ0eS5cclxuICovXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBTbmlwcGV0PFQgZXh0ZW5kcyBTbmlwcGV0VHlwZSA9IFNuaXBwZXRUeXBlPiB7XHJcblx0dHlwZTogVDtcclxuXHRkYXRhOiBTbmlwcGV0RGF0YTxUPjtcclxuXHRvcHRpb25zOiBPcHRpb25zO1xyXG5cdHByaW9yaXR5PzogbnVtYmVyO1xyXG5cdGRlc2NyaXB0aW9uPzogc3RyaW5nO1xyXG5cclxuXHRleGNsdWRlZEVudmlyb25tZW50czogRW52aXJvbm1lbnRbXTtcclxuXHJcblx0Y29uc3RydWN0b3IoXHJcblx0XHR0eXBlOiBULFxyXG5cdFx0dHJpZ2dlcjogU25pcHBldERhdGE8VD5bXCJ0cmlnZ2VyXCJdLFxyXG5cdFx0cmVwbGFjZW1lbnQ6IFNuaXBwZXREYXRhPFQ+W1wicmVwbGFjZW1lbnRcIl0sXHJcblx0XHRvcHRpb25zOiBPcHRpb25zLFxyXG5cdFx0cHJpb3JpdHk/OiBudW1iZXIgfCB1bmRlZmluZWQsXHJcblx0XHRkZXNjcmlwdGlvbj86IHN0cmluZyB8IHVuZGVmaW5lZCxcclxuXHRcdGV4Y2x1ZGVkRW52aXJvbm1lbnRzPzogRW52aXJvbm1lbnRbXSxcclxuXHQpIHtcclxuXHRcdHRoaXMudHlwZSA9IHR5cGU7XHJcblx0XHQvLyBAdHMtaWdub3JlXHJcblx0XHR0aGlzLmRhdGEgPSB7IHRyaWdnZXIsIHJlcGxhY2VtZW50IH07XHJcblx0XHR0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xyXG5cdFx0dGhpcy5wcmlvcml0eSA9IHByaW9yaXR5O1xyXG5cdFx0dGhpcy5kZXNjcmlwdGlvbiA9IGRlc2NyaXB0aW9uO1xyXG5cdFx0dGhpcy5leGNsdWRlZEVudmlyb25tZW50cyA9IGV4Y2x1ZGVkRW52aXJvbm1lbnRzID8/IFtdO1xyXG5cdH1cclxuXHJcblx0Ly8gd2UgbmVlZCB0byBleHBsaWNpdGx5IHR5cGUgdGhlIHJldHVybiB2YWx1ZSBoZXJlIHNvIHRoZSBkZXJpdmVkIGNsYXNzZXMsXHJcblx0Ly8gaGF2ZSB0aGUgZ2V0dGVyIHR5cGVkIHByb3Blcmx5IGZvciB0aGUgcGFydGljdWxhciA8VD4gdGhlIGRlcml2ZWQgY2xhc3MgZXh0ZW5kc1xyXG5cdGdldCB0cmlnZ2VyKCk6IFNuaXBwZXREYXRhPFQ+W1widHJpZ2dlclwiXSB7IHJldHVybiB0aGlzLmRhdGEudHJpZ2dlcjsgfVxyXG5cdGdldCByZXBsYWNlbWVudCgpOiBTbmlwcGV0RGF0YTxUPltcInJlcGxhY2VtZW50XCJdIHsgcmV0dXJuIHRoaXMuZGF0YS5yZXBsYWNlbWVudDsgfVxyXG5cclxuXHRhYnN0cmFjdCBwcm9jZXNzKGVmZmVjdGl2ZUxpbmU6IHN0cmluZywgcmFuZ2U6IFNlbGVjdGlvblJhbmdlLCBzZWw6IHN0cmluZyk6IFByb2Nlc3NTbmlwcGV0UmVzdWx0O1xyXG5cclxuXHR0b1N0cmluZygpIHtcclxuXHRcdHJldHVybiBzZXJpYWxpemVTbmlwcGV0TGlrZSh7XHJcblx0XHRcdHR5cGU6IHRoaXMudHlwZSxcclxuXHRcdFx0dHJpZ2dlcjogdGhpcy50cmlnZ2VyLFxyXG5cdFx0XHRyZXBsYWNlbWVudDogdGhpcy5yZXBsYWNlbWVudCxcclxuXHRcdFx0b3B0aW9uczogdGhpcy5vcHRpb25zLFxyXG5cdFx0XHRwcmlvcml0eTogdGhpcy5wcmlvcml0eSxcclxuXHRcdFx0ZGVzY3JpcHRpb246IHRoaXMuZGVzY3JpcHRpb24sXHJcblx0XHRcdGV4Y2x1ZGVkRW52aXJvbm1lbnRzOiB0aGlzLmV4Y2x1ZGVkRW52aXJvbm1lbnRzLFxyXG5cdFx0fSk7XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgVmlzdWFsU25pcHBldCBleHRlbmRzIFNuaXBwZXQ8XCJ2aXN1YWxcIj4ge1xyXG5cdGNvbnN0cnVjdG9yKHsgdHJpZ2dlciwgcmVwbGFjZW1lbnQsIG9wdGlvbnMsIHByaW9yaXR5LCBkZXNjcmlwdGlvbiwgZXhjbHVkZWRFbnZpcm9ubWVudHMgfTogQ3JlYXRlU25pcHBldDxcInZpc3VhbFwiPikge1xyXG5cdFx0c3VwZXIoXCJ2aXN1YWxcIiwgdHJpZ2dlciwgcmVwbGFjZW1lbnQsIG9wdGlvbnMsIHByaW9yaXR5LCBkZXNjcmlwdGlvbiwgZXhjbHVkZWRFbnZpcm9ubWVudHMpO1xyXG5cdH1cclxuXHJcblx0cHJvY2VzcyhlZmZlY3RpdmVMaW5lOiBzdHJpbmcsIHJhbmdlOiBTZWxlY3Rpb25SYW5nZSwgc2VsOiBzdHJpbmcpOiBQcm9jZXNzU25pcHBldFJlc3VsdCB7XHJcblx0XHRjb25zdCBoYXNTZWxlY3Rpb24gPSAhIXNlbDtcclxuXHRcdC8vIHZpc3VhbCBzbmlwcGV0cyBvbmx5IHJ1biB3aGVuIHRoZXJlIGlzIGEgc2VsZWN0aW9uXHJcblx0XHRpZiAoIWhhc1NlbGVjdGlvbikgeyByZXR1cm4gbnVsbDsgfVxyXG5cclxuXHRcdC8vIGNoZWNrIHdoZXRoZXIgdGhlIHRyaWdnZXIgdGV4dCB3YXMgdHlwZWRcclxuXHRcdGlmICghKGVmZmVjdGl2ZUxpbmUuZW5kc1dpdGgodGhpcy50cmlnZ2VyKSkpIHsgcmV0dXJuIG51bGw7IH1cclxuXHJcblx0XHRjb25zdCB0cmlnZ2VyUG9zID0gcmFuZ2UuZnJvbTtcclxuXHRcdGxldCByZXBsYWNlbWVudDtcclxuXHRcdGlmICh0eXBlb2YgdGhpcy5yZXBsYWNlbWVudCA9PT0gXCJzdHJpbmdcIikge1xyXG5cdFx0XHRyZXBsYWNlbWVudCA9IHRoaXMucmVwbGFjZW1lbnQucmVwbGFjZShWSVNVQUxfU05JUFBFVF9NQUdJQ19TRUxFQ1RJT05fUExBQ0VIT0xERVIsIHNlbCk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRyZXBsYWNlbWVudCA9IHRoaXMucmVwbGFjZW1lbnQoc2VsKTtcclxuXHJcblx0XHRcdC8vIHNhbml0eSBjaGVjayAtIGlmIHRoaXMucmVwbGFjZW1lbnQgd2FzIGEgZnVuY3Rpb24sXHJcblx0XHRcdC8vIHdlIGhhdmUgbm8gd2F5IHRvIHZhbGlkYXRlIGJlZm9yZWhhbmQgdGhhdCBpdCByZWFsbHkgZG9lcyByZXR1cm4gYSBzdHJpbmdcclxuXHRcdFx0aWYgKHR5cGVvZiByZXBsYWNlbWVudCAhPT0gXCJzdHJpbmdcIikgeyByZXR1cm4gbnVsbDsgfVxyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiB7IHRyaWdnZXJQb3MsIHJlcGxhY2VtZW50IH07XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgUmVnZXhTbmlwcGV0IGV4dGVuZHMgU25pcHBldDxcInJlZ2V4XCI+IHtcclxuXHJcblx0Y29uc3RydWN0b3IoeyB0cmlnZ2VyLCByZXBsYWNlbWVudCwgb3B0aW9ucywgcHJpb3JpdHksIGRlc2NyaXB0aW9uLCBleGNsdWRlZEVudmlyb25tZW50cyB9OiBDcmVhdGVTbmlwcGV0PFwicmVnZXhcIj4pIHtcclxuXHRcdHN1cGVyKFwicmVnZXhcIiwgdHJpZ2dlciwgcmVwbGFjZW1lbnQsIG9wdGlvbnMsIHByaW9yaXR5LCBkZXNjcmlwdGlvbiwgZXhjbHVkZWRFbnZpcm9ubWVudHMpO1xyXG5cdH1cclxuXHJcblx0cHJvY2VzcyhlZmZlY3RpdmVMaW5lOiBzdHJpbmcsIHJhbmdlOiBTZWxlY3Rpb25SYW5nZSwgc2VsOiBzdHJpbmcpOiBQcm9jZXNzU25pcHBldFJlc3VsdCB7XHJcblx0XHRjb25zdCBoYXNTZWxlY3Rpb24gPSAhIXNlbDtcclxuXHRcdC8vIG5vbi12aXN1YWwgc25pcHBldHMgb25seSBydW4gd2hlbiB0aGVyZSBpcyBubyBzZWxlY3Rpb25cclxuXHRcdGlmIChoYXNTZWxlY3Rpb24pIHsgcmV0dXJuIG51bGw7IH1cclxuXHJcblx0XHRjb25zdCByZXN1bHQgPSB0aGlzLnRyaWdnZXIuZXhlYyhlZmZlY3RpdmVMaW5lKTtcclxuXHRcdGlmIChyZXN1bHQgPT09IG51bGwpIHsgcmV0dXJuIG51bGw7IH1cclxuXHJcblx0XHRjb25zdCB0cmlnZ2VyUG9zID0gcmVzdWx0LmluZGV4O1xyXG5cclxuXHRcdGxldCByZXBsYWNlbWVudDtcclxuXHRcdGlmICh0eXBlb2YgdGhpcy5yZXBsYWNlbWVudCA9PT0gXCJzdHJpbmdcIikge1xyXG5cdFx0XHQvLyBDb21wdXRlIHRoZSByZXBsYWNlbWVudCBzdHJpbmdcclxuXHRcdFx0Ly8gcmVzdWx0Lmxlbmd0aCAtIDEgPSB0aGUgbnVtYmVyIG9mIGNhcHR1cmluZyBncm91cHNcclxuXHJcblx0XHRcdGNvbnN0IG5DYXB0dXJlR3JvdXBzID0gcmVzdWx0Lmxlbmd0aCAtIDE7XHJcblx0XHRcdHJlcGxhY2VtZW50ID0gQXJyYXkuZnJvbSh7IGxlbmd0aDogbkNhcHR1cmVHcm91cHMgfSlcclxuXHRcdFx0XHQubWFwKChfLCBpKSA9PiBpICsgMSlcclxuXHRcdFx0XHQucmVkdWNlKFxyXG5cdFx0XHRcdFx0KHJlcGxhY2VtZW50LCBpKSA9PiByZXBsYWNlbWVudC5yZXBsYWNlQWxsKGBbWyR7aSAtIDF9XV1gLCByZXN1bHRbaV0pLFxyXG5cdFx0XHRcdFx0dGhpcy5yZXBsYWNlbWVudFxyXG5cdFx0XHRcdCk7XHJcblx0XHR9IGVsc2Uge1xyXG5cdFx0XHRyZXBsYWNlbWVudCA9IHRoaXMucmVwbGFjZW1lbnQocmVzdWx0KTtcclxuXHJcblx0XHRcdC8vIHNhbml0eSBjaGVjayAtIGlmIHRoaXMucmVwbGFjZW1lbnQgd2FzIGEgZnVuY3Rpb24sXHJcblx0XHRcdC8vIHdlIGhhdmUgbm8gd2F5IHRvIHZhbGlkYXRlIGJlZm9yZWhhbmQgdGhhdCBpdCByZWFsbHkgZG9lcyByZXR1cm4gYSBzdHJpbmdcclxuXHRcdFx0aWYgKHR5cGVvZiByZXBsYWNlbWVudCAhPT0gXCJzdHJpbmdcIikgeyByZXR1cm4gbnVsbDsgfVxyXG5cdFx0fVxyXG5cclxuXHRcdHJldHVybiB7IHRyaWdnZXJQb3MsIHJlcGxhY2VtZW50IH07XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgU3RyaW5nU25pcHBldCBleHRlbmRzIFNuaXBwZXQ8XCJzdHJpbmdcIj4ge1xyXG5cdGRlY2xhcmUgZGF0YTogU25pcHBldERhdGE8XCJzdHJpbmdcIj47XHJcblxyXG5cdGNvbnN0cnVjdG9yKHsgdHJpZ2dlciwgcmVwbGFjZW1lbnQsIG9wdGlvbnMsIHByaW9yaXR5LCBkZXNjcmlwdGlvbiwgZXhjbHVkZWRFbnZpcm9ubWVudHM6IGV4Y2x1ZGVJbiB9OiBDcmVhdGVTbmlwcGV0PFwic3RyaW5nXCI+KSB7XHJcblx0XHRzdXBlcihcInN0cmluZ1wiLCB0cmlnZ2VyLCByZXBsYWNlbWVudCwgb3B0aW9ucywgcHJpb3JpdHksIGRlc2NyaXB0aW9uLCBleGNsdWRlSW4pO1xyXG5cdH1cclxuXHJcblx0cHJvY2VzcyhlZmZlY3RpdmVMaW5lOiBzdHJpbmcsIHJhbmdlOiBTZWxlY3Rpb25SYW5nZSwgc2VsOiBzdHJpbmcpOiBQcm9jZXNzU25pcHBldFJlc3VsdCB7XHJcblx0XHRjb25zdCBoYXNTZWxlY3Rpb24gPSAhIXNlbDtcclxuXHRcdC8vIG5vbi12aXN1YWwgc25pcHBldHMgb25seSBydW4gd2hlbiB0aGVyZSBpcyBubyBzZWxlY3Rpb25cclxuXHRcdGlmIChoYXNTZWxlY3Rpb24pIHsgcmV0dXJuIG51bGw7IH1cclxuXHJcblx0XHQvLyBDaGVjayB3aGV0aGVyIHRoZSB0cmlnZ2VyIHRleHQgd2FzIHR5cGVkXHJcblx0XHRpZiAoIShlZmZlY3RpdmVMaW5lLmVuZHNXaXRoKHRoaXMudHJpZ2dlcikpKSB7IHJldHVybiBudWxsOyB9XHJcblxyXG5cdFx0Y29uc3QgdHJpZ2dlclBvcyA9IGVmZmVjdGl2ZUxpbmUubGVuZ3RoIC0gdGhpcy50cmlnZ2VyLmxlbmd0aDtcclxuXHRcdGNvbnN0IHJlcGxhY2VtZW50ID0gdHlwZW9mIHRoaXMucmVwbGFjZW1lbnQgPT09IFwic3RyaW5nXCJcclxuXHRcdFx0PyB0aGlzLnJlcGxhY2VtZW50XHJcblx0XHRcdDogdGhpcy5yZXBsYWNlbWVudCh0aGlzLnRyaWdnZXIpO1xyXG5cclxuXHRcdC8vIHNhbml0eSBjaGVjayAtIGlmIHJlcGxhY2VtZW50IHdhcyBhIGZ1bmN0aW9uLFxyXG5cdFx0Ly8gd2UgaGF2ZSBubyB3YXkgdG8gdmFsaWRhdGUgYmVmb3JlaGFuZCB0aGF0IGl0IHJlYWxseSBkb2VzIHJldHVybiBhIHN0cmluZ1xyXG5cdFx0aWYgKHR5cGVvZiByZXBsYWNlbWVudCAhPT0gXCJzdHJpbmdcIikgeyByZXR1cm4gbnVsbDsgfVxyXG5cclxuXHRcdHJldHVybiB7IHRyaWdnZXJQb3MsIHJlcGxhY2VtZW50IH07XHJcblx0fVxyXG59XHJcblxyXG4vKipcclxuICogcmVwbGFjZXIgZnVuY3Rpb24gZm9yIHNlcmlhbGl6aW5nIHNuaXBwZXRzXHJcbiAqIEBwYXJhbSBrXHJcbiAqIEBwYXJhbSB2XHJcbiAqIEByZXR1cm5zXHJcbiAqL1xyXG5mdW5jdGlvbiByZXBsYWNlcihrOiBzdHJpbmcsIHY6IHVua25vd24pIHtcclxuXHRpZiAodHlwZW9mIHYgPT09IFwiZnVuY3Rpb25cIikgeyByZXR1cm4gXCJbW0Z1bmN0aW9uXV1cIjsgfVxyXG5cdGlmICh2IGluc3RhbmNlb2YgUmVnRXhwKSB7IHJldHVybiBgW1tSZWdFeHBdXTogJHt2LnRvU3RyaW5nKCl9YDsgfVxyXG5cdHJldHVybiB2O1xyXG59XHJcblxyXG50eXBlIENyZWF0ZVNuaXBwZXQ8VCBleHRlbmRzIFNuaXBwZXRUeXBlPiA9IHtcclxuXHRvcHRpb25zOiBPcHRpb25zO1xyXG5cdHByaW9yaXR5PzogbnVtYmVyO1xyXG5cdGRlc2NyaXB0aW9uPzogc3RyaW5nO1xyXG5cdGV4Y2x1ZGVkRW52aXJvbm1lbnRzPzogRW52aXJvbm1lbnRbXTtcclxufSAmIFNuaXBwZXREYXRhPFQ+XHJcblxyXG5cclxuLyoqXHJcbiAqIHNlcmlhbGl6ZSBhIHNuaXBwZXQtbGlrZSBvYmplY3QuXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gc2VyaWFsaXplU25pcHBldExpa2Uoc25pcHBldExpa2U6IHVua25vd24pIHtcclxuXHRyZXR1cm4gSlNPTi5zdHJpbmdpZnkoc25pcHBldExpa2UsIHJlcGxhY2VyLCAyKTtcclxufSJdfQ==