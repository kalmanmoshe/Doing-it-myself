import { EditorSelection } from "@codemirror/state";
import { Decoration } from "@codemirror/view";
import { resetCursorBlink } from "src/editor utilities/editor_utils";
import { endSnippet } from "src/codemirror/history";
const LATEX_SUITE_TABSTOP_DECO_CLASS = "latex-suite-snippet-placeholder";
function getMarkerDecoration(from, to, color) {
    const className = `${LATEX_SUITE_TABSTOP_DECO_CLASS} ${LATEX_SUITE_TABSTOP_DECO_CLASS}-${color}`;
    return Decoration.mark({
        inclusive: true,
        color: color,
        class: className,
    }).range(from, to);
}
export class TabstopGroup {
    decos;
    color;
    hidden;
    constructor(tabstopSpecs, color) {
        const decos = tabstopSpecs.map(spec => getMarkerDecoration(spec.from, spec.to, color));
        this.decos = Decoration.set(decos, true);
        this.color = color;
        this.hidden = false;
    }
    select(view, selectEndpoints, isEndSnippet) {
        const sel = this.toEditorSelection();
        const toSelect = selectEndpoints ? getEditorSelectionEndpoints(sel) : sel;
        view.dispatch({
            selection: toSelect,
            effects: isEndSnippet ? endSnippet.of(null) : undefined
        });
        resetCursorBlink();
        this.hideFromEditor();
    }
    toSelectionRanges() {
        const ranges = [];
        const cur = this.decos.iter();
        while (cur.value != null) {
            ranges.push(EditorSelection.range(cur.from, cur.to));
            cur.next();
        }
        return ranges;
    }
    toEditorSelection(endpoints = false) {
        let sel = EditorSelection.create(this.toSelectionRanges());
        if (endpoints)
            sel = getEditorSelectionEndpoints(sel);
        return sel;
    }
    containsSelection(selection) {
        function rangeLiesWithinSelection(range, sel) {
            for (const selRange of sel) {
                if (selRange.from <= range.from && selRange.to >= range.to) {
                    return true;
                }
            }
            return false;
        }
        const tabstopRanges = this.toSelectionRanges();
        let result = true;
        for (const range of selection.ranges) {
            if (!rangeLiesWithinSelection(range, tabstopRanges)) {
                result = false;
                break;
            }
        }
        return result;
    }
    hideFromEditor() {
        this.hidden = true;
    }
    map(changes) {
        this.decos = this.decos.map(changes);
    }
    getRanges() {
        const ranges = [];
        const cur = this.decos.iter();
        while (cur.value != null) {
            if (cur.from != cur.to) {
                ranges.push(cur.value.range(cur.from, cur.to));
            }
            cur.next();
        }
        return ranges;
    }
}
export function tabstopSpecsToTabstopGroups(tabstops, color) {
    const tabstopsByNumber = {};
    for (const tabstop of tabstops) {
        const n = String(tabstop.number);
        if (tabstopsByNumber[n]) {
            tabstopsByNumber[n].push(tabstop);
        }
        else {
            tabstopsByNumber[n] = [tabstop];
        }
    }
    const result = [];
    const numbers = Object.keys(tabstopsByNumber);
    numbers.sort((a, b) => parseInt(a) - parseInt(b));
    for (const number of numbers) {
        const grp = new TabstopGroup(tabstopsByNumber[number], color);
        result.push(grp);
    }
    return result;
}
export function getEditorSelectionEndpoints(sel) {
    const endpoints = sel.ranges.map(range => EditorSelection.range(range.to, range.to));
    return EditorSelection.create(endpoints);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFic3RvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zbmlwcGV0cy90YWJzdG9wLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxlQUFlLEVBQWtCLE1BQU0sbUJBQW1CLENBQUM7QUFDaEYsT0FBTyxFQUFFLFVBQVUsRUFBNkIsTUFBTSxrQkFBa0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUNyRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFFcEQsTUFBTSw4QkFBOEIsR0FBRyxpQ0FBaUMsQ0FBQztBQVN6RSxTQUFTLG1CQUFtQixDQUFDLElBQVksRUFBRSxFQUFVLEVBQUUsS0FBYTtJQUNoRSxNQUFNLFNBQVMsR0FBRyxHQUFHLDhCQUE4QixJQUFJLDhCQUE4QixJQUFJLEtBQUssRUFBRSxDQUFDO0lBRWpHLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQztRQUNuQixTQUFTLEVBQUUsSUFBSTtRQUNmLEtBQUssRUFBRSxLQUFLO1FBQ1osS0FBSyxFQUFFLFNBQVM7S0FDbkIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQUVELE1BQU0sT0FBTyxZQUFZO0lBQ3JCLEtBQUssQ0FBZ0I7SUFDckIsS0FBSyxDQUFTO0lBQ2QsTUFBTSxDQUFVO0lBRWhCLFlBQVksWUFBMkIsRUFBRSxLQUFhO1FBQ2xELE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pD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QU0sR0FBRyxHQUFHLElBQUksWUFBWSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzlELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQUVKLE9BQU8sTUFBTSxDQUFDO0FBQ2YsQ0FBQztBQUVELE1BQU0sVUFBVSwyQkFBMkIsQ0FBQyxHQUFvQjtJQUM1RCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVyRixPQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDN0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURlc2MsIEVkaXRvclNlbGVjdGlvbiwgU2VsZWN0aW9uUmFuZ2UgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgRGVjb3JhdGlvbiwgRGVjb3JhdGlvblNldCwgRWRpdG9yVmlldyB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IHJlc2V0Q3Vyc29yQmxpbmsgfSBmcm9tIFwic3JjL2VkaXRvciB1dGlsaXRpZXMvZWRpdG9yX3V0aWxzXCI7XHJcbmltcG9ydCB7IGVuZFNuaXBwZXQgfSBmcm9tIFwic3JjL2NvZGVtaXJyb3IvaGlzdG9yeVwiO1xyXG5cclxuY29uc3QgTEFURVhfU1VJVEVfVEFCU1RPUF9ERUNPX0NMQVNTID0gXCJsYXRleC1zdWl0ZS1zbmlwcGV0LXBsYWNlaG9sZGVyXCI7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFRhYnN0b3BTcGVjIHtcclxuICAgIG51bWJlcjogbnVtYmVyLFxyXG4gICAgZnJvbTogbnVtYmVyLFxyXG4gICAgdG86IG51bWJlcixcclxuICAgIHJlcGxhY2VtZW50OiBzdHJpbmdcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0TWFya2VyRGVjb3JhdGlvbihmcm9tOiBudW1iZXIsIHRvOiBudW1iZXIsIGNvbG9yOiBudW1iZXIpIHtcclxuICAgIGNvbnN0IGNsYXNzTmFtZSA9IGAke0xBVEVYX1NVSVRFX1RBQlNUT1BfREVDT19DTEFTU30gJHtMQVRFWF9TVUlURV9UQUJTVE9QX0RFQ09fQ0xBU1N9LSR7Y29sb3J9YDtcclxuXHJcbiAgICByZXR1cm4gRGVjb3JhdGlvbi5tYXJrKHtcclxuICAgICAgICBpbmNsdXNpdmU6IHRydWUsXHJcbiAgICAgICAgY29sb3I6IGNvbG9yLFxyXG4gICAgICAgIGNsYXNzOiBjbGFzc05hbWUsXHJcbiAgICB9KS5yYW5nZShmcm9tLCB0byk7XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBUYWJzdG9wR3JvdXAge1xyXG4gICAgZGVjb3M6IERlY29yYXRpb25TZXQ7XHJcbiAgICBjb2xvcjogbnVtYmVyO1xyXG4gICAgaGlkZGVuOiBib29sZWFuO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHRhYnN0b3BTcGVjczogVGFic3RvcFNwZWNbXSwgY29sb3I6IG51bWJlcikge1xyXG4gICAgICAgIGNvbnN0IGRlY29zID0gdGFic3RvcFNwZWNzLm1hcChzcGVjID0+IGdldE1hcmtlckRlY29yYXRpb24oc3BlYy5mcm9tLCBzcGVjLnRvLCBjb2xvcikpO1xyXG4gICAgICAgIHRoaXMuZGVjb3MgPSBEZWNvcmF0aW9uLnNldChkZWNvcywgdHJ1ZSk7XHJcbiAgICAgICAgdGhpcy5jb2xvciA9IGNvbG9yO1xyXG4gICAgICAgIHRoaXMuaGlkZGVuID0gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0KHZpZXc6IEVkaXRvclZpZXcsIHNlbGVjdEVuZHBvaW50czogYm9vbGVhbiwgaXNFbmRTbmlwcGV0OiBib29sZWFuKSB7XHJcbiAgICAgICAgY29uc3Qgc2VsID0gdGhpcy50b0VkaXRvclNlbGVjdGlvbigpO1xyXG4gICAgICAgIGNvbnN0IHRvU2VsZWN0ID0gc2VsZWN0RW5kcG9pbnRzID8gZ2V0RWRpdG9yU2VsZWN0aW9uRW5kcG9pbnRzKHNlbCkgOiBzZWw7XHJcblxyXG4gICAgICAgIHZpZXcuZGlzcGF0Y2goe1xyXG4gICAgICAgICAgICBzZWxlY3Rpb246IHRvU2VsZWN0LFxyXG4gICAgICAgICAgICBlZmZlY3RzOiBpc0VuZFNuaXBwZXQgPyBlbmRTbmlwcGV0Lm9mKG51bGwpIDogdW5kZWZpbmVkXHJcbiAgICAgICAgfSlcclxuICAgICAgICByZXNldEN1cnNvckJsaW5rKCk7XHJcblxyXG4gICAgICAgIHRoaXMuaGlkZUZyb21FZGl0b3IoKTtcclxuICAgIH1cclxuXHJcbiAgICB0b1NlbGVjdGlvblJhbmdlcygpIHtcclxuICAgICAgICBjb25zdCByYW5nZXMgPSBbXTtcclxuICAgICAgICBjb25zdCBjdXIgPSB0aGlzLmRlY29zLml0ZXIoKTtcclxuICAgIFxyXG4gICAgICAgIHdoaWxlIChjdXIudmFsdWUgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICByYW5nZXMucHVzaChFZGl0b3JTZWxlY3Rpb24ucmFuZ2UoY3VyLmZyb20sIGN1ci50bykpO1xyXG4gICAgICAgICAgICBjdXIubmV4dCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJhbmdlcztcclxuICAgIH1cclxuXHJcbiAgICB0b0VkaXRvclNlbGVjdGlvbihlbmRwb2ludHMgPSBmYWxzZSkge1xyXG4gICAgICAgIGxldCBzZWwgPSBFZGl0b3JTZWxlY3Rpb24uY3JlYXRlKHRoaXMudG9TZWxlY3Rpb25SYW5nZXMoKSk7XHJcbiAgICAgICAgaWYgKGVuZHBvaW50cylcclxuICAgICAgICAgICAgc2VsID0gZ2V0RWRpdG9yU2VsZWN0aW9uRW5kcG9pbnRzKHNlbCk7XHJcbiAgICAgICAgcmV0dXJuIHNlbDtcclxuICAgIH1cclxuXHJcbiAgICBjb250YWluc1NlbGVjdGlvbihzZWxlY3Rpb246IEVkaXRvclNlbGVjdGlvbikge1xyXG4gICAgICAgIGZ1bmN0aW9uIHJhbmdlTGllc1dpdGhpblNlbGVjdGlvbihyYW5nZTogU2VsZWN0aW9uUmFuZ2UsIHNlbDogU2VsZWN0aW9uUmFuZ2VbXSkge1xyXG4gICAgICAgICAgICBmb3IgKGNvbnN0IHNlbFJhbmdlIG9mIHNlbCkge1xyXG4gICAgICAgICAgICAgICAgaWYgKHNlbFJhbmdlLmZyb20gPD0gcmFuZ2UuZnJvbSAmJiBzZWxSYW5nZS50byA+PSByYW5nZS50bykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICBcclxuICAgICAgICBjb25zdCB0YWJzdG9wUmFuZ2VzID0gdGhpcy50b1NlbGVjdGlvblJhbmdlcygpO1xyXG4gICAgICAgIGxldCByZXN1bHQgPSB0cnVlO1xyXG4gICAgXHJcbiAgICAgICAgZm9yIChjb25zdCByYW5nZSBvZiBzZWxlY3Rpb24ucmFuZ2VzKSB7XHJcbiAgICAgICAgICAgIGlmICghcmFuZ2VMaWVzV2l0aGluU2VsZWN0aW9uKHJhbmdlLCB0YWJzdG9wUmFuZ2VzKSkge1xyXG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7XHJcbiAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzdWx0O1xyXG4gICAgfVxyXG5cclxuICAgIGhpZGVGcm9tRWRpdG9yKCkge1xyXG4gICAgICAgIHRoaXMuaGlkZGVuID0gdHJ1ZTtcclxuICAgIH1cclxuXHJcbiAgICBtYXAoY2hhbmdlczogQ2hhbmdlRGVzYykge1xyXG4gICAgICAgIHRoaXMuZGVjb3MgPSB0aGlzLmRlY29zLm1hcChjaGFuZ2VzKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgZ2V0UmFuZ2VzKCkge1xyXG4gICAgICAgIGNvbnN0IHJhbmdlcyA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGN1ciA9IHRoaXMuZGVjb3MuaXRlcigpO1xyXG5cclxuICAgICAgICB3aGlsZSAoY3VyLnZhbHVlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgaWYgKGN1ci5mcm9tICE9IGN1ci50byl7XHJcbiAgICAgICAgICAgICAgICByYW5nZXMucHVzaChjdXIudmFsdWUucmFuZ2UoY3VyLmZyb20sIGN1ci50bykpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGN1ci5uZXh0KCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gcmFuZ2VzO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdGFic3RvcFNwZWNzVG9UYWJzdG9wR3JvdXBzKHRhYnN0b3BzOiBUYWJzdG9wU3BlY1tdLCBjb2xvcjogbnVtYmVyKTpUYWJzdG9wR3JvdXBbXSB7XHJcbiAgICBjb25zdCB0YWJzdG9wc0J5TnVtYmVyOiB7W246IHN0cmluZ106IFRhYnN0b3BTcGVjW119ID0ge307XHJcblxyXG4gICAgZm9yIChjb25zdCB0YWJzdG9wIG9mIHRhYnN0b3BzKSB7XHJcbiAgICAgICAgY29uc3QgbiA9IFN0cmluZyh0YWJzdG9wLm51bWJlcik7XHJcblxyXG4gICAgICAgIGlmICh0YWJzdG9wc0J5TnVtYmVyW25dKSB7XHJcbiAgICAgICAgICAgIHRhYnN0b3BzQnlOdW1iZXJbbl0ucHVzaCh0YWJzdG9wKTtcclxuXHRcdH1cclxuXHRcdGVsc2Uge1xyXG4gICAgICAgICAgICB0YWJzdG9wc0J5TnVtYmVyW25dID0gW3RhYnN0b3BdO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcbiAgICBjb25zdCByZXN1bHQgPSBbXTtcclxuICAgIGNvbnN0IG51bWJlcnMgPSBPYmplY3Qua2V5cyh0YWJzdG9wc0J5TnVtYmVyKTtcclxuICAgIG51bWJlcnMuc29ydCgoYSxiKSA9PiBwYXJzZUludChhKSAtIHBhcnNlSW50KGIpKTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IG51bWJlciBvZiBudW1iZXJzKSB7XHJcbiAgICAgICAgY29uc3QgZ3JwID0gbmV3IFRhYnN0b3BHcm91cCh0YWJzdG9wc0J5TnVtYmVyW251bWJlcl0sIGNvbG9yKTtcclxuICAgICAgICByZXN1bHQucHVzaChncnApO1xyXG4gICAgfVxyXG5cclxuXHRyZXR1cm4gcmVzdWx0O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZ2V0RWRpdG9yU2VsZWN0aW9uRW5kcG9pbnRzKHNlbDogRWRpdG9yU2VsZWN0aW9uKSB7XHJcbiAgICBjb25zdCBlbmRwb2ludHMgPSBzZWwucmFuZ2VzLm1hcChyYW5nZSA9PiBFZGl0b3JTZWxlY3Rpb24ucmFuZ2UocmFuZ2UudG8sIHJhbmdlLnRvKSk7XHJcblxyXG4gICAgcmV0dXJuIEVkaXRvclNlbGVjdGlvbi5jcmVhdGUoZW5kcG9pbnRzKTtcclxufSJdfQ==