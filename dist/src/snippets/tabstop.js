import { EditorSelection } from "@codemirror/state";
import { Decoration } from "@codemirror/view";
import { resetCursorBlink } from "src/utils/editor_utils";
import { endSnippet } from "./codemirror/history";
const LATEX_SUITE_TABSTOP_DECO_CLASS = "latex-suite-snippet-placeholder";
function getMarkerDecoration(from, to, color) {
    const className = `${LATEX_SUITE_TABSTOP_DECO_CLASS} ${LATEX_SUITE_TABSTOP_DECO_CLASS}-${color}`;
    return Decoration.mark({
        inclusive: true,
        color: color,
        class: className,
    }).range(from, to);
}
export class TabstopGroup {
    constructor(tabstopSpecs, color) {
        const decos = tabstopSpecs.map(spec => getMarkerDecoration(spec.from, spec.to, color));
        this.decos = Decoration.set(decos, true);
        this.color = color;
        this.hidden = false;
    }
    select(view, selectEndpoints, isEndSnippet) {
        const sel = this.toEditorSelection();
        const toSelect = selectEndpoints ? getEditorSelectionEndpoints(sel) : sel;
        view.dispatch({
            selection: toSelect,
            effects: isEndSnippet ? endSnippet.of(null) : undefined
        });
        resetCursorBlink();
        this.hideFromEditor();
    }
    toSelectionRanges() {
        const ranges = [];
        const cur = this.decos.iter();
        while (cur.value != null) {
            ranges.push(EditorSelection.range(cur.from, cur.to));
            cur.next();
        }
        return ranges;
    }
    toEditorSelection(endpoints = false) {
        let sel = EditorSelection.create(this.toSelectionRanges());
        if (endpoints)
            sel = getEditorSelectionEndpoints(sel);
        return sel;
    }
    containsSelection(selection) {
        function rangeLiesWithinSelection(range, sel) {
            for (const selRange of sel) {
                if (selRange.from <= range.from && selRange.to >= range.to) {
                    return true;
                }
            }
            return false;
        }
        const tabstopRanges = this.toSelectionRanges();
        let result = true;
        for (const range of selection.ranges) {
            if (!rangeLiesWithinSelection(range, tabstopRanges)) {
                result = false;
                break;
            }
        }
        return result;
    }
    hideFromEditor() {
        this.hidden = true;
    }
    map(changes) {
        this.decos = this.decos.map(changes);
    }
    getRanges() {
        const ranges = [];
        const cur = this.decos.iter();
        while (cur.value != null) {
            if (cur.from != cur.to) {
                ranges.push(cur.value.range(cur.from, cur.to));
            }
            cur.next();
        }
        return ranges;
    }
}
export function tabstopSpecsToTabstopGroups(tabstops, color) {
    const tabstopsByNumber = {};
    for (const tabstop of tabstops) {
        const n = String(tabstop.number);
        if (tabstopsByNumber[n]) {
            tabstopsByNumber[n].push(tabstop);
        }
        else {
            tabstopsByNumber[n] = [tabstop];
        }
    }
    const result = [];
    const numbers = Object.keys(tabstopsByNumber);
    numbers.sort((a, b) => parseInt(a) - parseInt(b));
    for (const number of numbers) {
        const grp = new TabstopGroup(tabstopsByNumber[number], color);
        result.push(grp);
    }
    return result;
}
export function getEditorSelectionEndpoints(sel) {
    const endpoints = sel.ranges.map(range => EditorSelection.range(range.to, range.to));
    return EditorSelection.create(endpoints);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFic3RvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zbmlwcGV0cy90YWJzdG9wLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxlQUFlLEVBQWtCLE1BQU0sbUJBQW1CLENBQUM7QUFDaEYsT0FBTyxFQUFFLFVBQVUsRUFBNkIsTUFBTSxrQkFBa0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFbEQsTUFBTSw4QkFBOEIsR0FBRyxpQ0FBaUMsQ0FBQztBQVN6RSxTQUFTLG1CQUFtQixDQUFDLElBQVksRUFBRSxFQUFVLEVBQUUsS0FBYTtJQUNoRSxNQUFNLFNBQVMsR0FBRyxHQUFHLDhCQUE4QixJQUFJLDhCQUE4QixJQUFJLEtBQUssRUFBRSxDQUFDO0lBRWpHLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQztRQUNuQixTQUFTLEVBQUUsSUFBSTtRQUNmLEtBQUssRUFBRSxLQUFLO1FBQ1osS0FBSyxFQUFFLFNBQVM7S0FDbkIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQUVELE1BQU0sT0FBTyxZQUFZO0lBS3JCLFlBQVksWUFBMkIsRUFBRSxLQUFhO1FBQ2xELE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO1FBQ25CLElBQUksQ0FBQyxN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QyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzlELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQUVKLE9BQU8sTUFBTSxDQUFDO0FBQ2YsQ0FBQztBQUVELE1BQU0sVUFBVSwyQkFBMkIsQ0FBQyxHQUFvQjtJQUM1RCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVyRixPQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDN0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURlc2MsIEVkaXRvclNlbGVjdGlvbiwgU2VsZWN0aW9uUmFuZ2UgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgRGVjb3JhdGlvbiwgRGVjb3JhdGlvblNldCwgRWRpdG9yVmlldyB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IHJlc2V0Q3Vyc29yQmxpbmsgfSBmcm9tIFwic3JjL3V0aWxzL2VkaXRvcl91dGlsc1wiO1xyXG5pbXBvcnQgeyBlbmRTbmlwcGV0IH0gZnJvbSBcIi4vY29kZW1pcnJvci9oaXN0b3J5XCI7XHJcblxyXG5jb25zdCBMQVRFWF9TVUlURV9UQUJTVE9QX0RFQ09fQ0xBU1MgPSBcImxhdGV4LXN1aXRlLXNuaXBwZXQtcGxhY2Vob2xkZXJcIjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgVGFic3RvcFNwZWMge1xyXG4gICAgbnVtYmVyOiBudW1iZXIsXHJcbiAgICBmcm9tOiBudW1iZXIsXHJcbiAgICB0bzogbnVtYmVyLFxyXG4gICAgcmVwbGFjZW1lbnQ6IHN0cmluZ1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRNYXJrZXJEZWNvcmF0aW9uKGZyb206IG51bWJlciwgdG86IG51bWJlciwgY29sb3I6IG51bWJlcikge1xyXG4gICAgY29uc3QgY2xhc3NOYW1lID0gYCR7TEFURVhfU1VJVEVfVEFCU1RPUF9ERUNPX0NMQVNTfSAke0xBVEVYX1NVSVRFX1RBQlNUT1BfREVDT19DTEFTU30tJHtjb2xvcn1gO1xyXG5cclxuICAgIHJldHVybiBEZWNvcmF0aW9uLm1hcmsoe1xyXG4gICAgICAgIGluY2x1c2l2ZTogdHJ1ZSxcclxuICAgICAgICBjb2xvcjogY29sb3IsXHJcbiAgICAgICAgY2xhc3M6IGNsYXNzTmFtZSxcclxuICAgIH0pLnJhbmdlKGZyb20sIHRvKTtcclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIFRhYnN0b3BHcm91cCB7XHJcbiAgICBkZWNvczogRGVjb3JhdGlvblNldDtcclxuICAgIGNvbG9yOiBudW1iZXI7XHJcbiAgICBoaWRkZW46IGJvb2xlYW47XHJcblxyXG4gICAgY29uc3RydWN0b3IodGFic3RvcFNwZWNzOiBUYWJzdG9wU3BlY1tdLCBjb2xvcjogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgZGVjb3MgPSB0YWJzdG9wU3BlY3MubWFwKHNwZWMgPT4gZ2V0TWFya2VyRGVjb3JhdGlvbihzcGVjLmZyb20sIHNwZWMudG8sIGNvbG9yKSk7XHJcbiAgICAgICAgdGhpcy5kZWNvcyA9IERlY29yYXRpb24uc2V0KGRlY29zLCB0cnVlKTtcclxuICAgICAgICB0aGlzLmNvbG9yID0gY29sb3I7XHJcbiAgICAgICAgdGhpcy5oaWRkZW4gPSBmYWxzZTtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3QodmlldzogRWRpdG9yVmlldywgc2VsZWN0RW5kcG9pbnRzOiBib29sZWFuLCBpc0VuZFNuaXBwZXQ6IGJvb2xlYW4pIHtcclxuICAgICAgICBjb25zdCBzZWwgPSB0aGlzLnRvRWRpdG9yU2VsZWN0aW9uKCk7XHJcbiAgICAgICAgY29uc3QgdG9TZWxlY3QgPSBzZWxlY3RFbmRwb2ludHMgPyBnZXRFZGl0b3JTZWxlY3Rpb25FbmRwb2ludHMoc2VsKSA6IHNlbDtcclxuICAgICAgICBcclxuICAgICAgICB2aWV3LmRpc3BhdGNoKHtcclxuICAgICAgICAgICAgc2VsZWN0aW9uOiB0b1NlbGVjdCxcclxuICAgICAgICAgICAgZWZmZWN0czogaXNFbmRTbmlwcGV0ID8gZW5kU25pcHBldC5vZihudWxsKSA6IHVuZGVmaW5lZFxyXG4gICAgICAgIH0pXHJcbiAgICAgICAgcmVzZXRDdXJzb3JCbGluaygpO1xyXG5cclxuICAgICAgICB0aGlzLmhpZGVGcm9tRWRpdG9yKCk7XHJcbiAgICB9XHJcblxyXG4gICAgdG9TZWxlY3Rpb25SYW5nZXMoKSB7XHJcbiAgICAgICAgY29uc3QgcmFuZ2VzID0gW107XHJcbiAgICAgICAgY29uc3QgY3VyID0gdGhpcy5kZWNvcy5pdGVyKCk7XHJcbiAgICBcclxuICAgICAgICB3aGlsZSAoY3VyLnZhbHVlICE9IG51bGwpIHtcclxuICAgICAgICAgICAgcmFuZ2VzLnB1c2goRWRpdG9yU2VsZWN0aW9uLnJhbmdlKGN1ci5mcm9tLCBjdXIudG8pKTtcclxuICAgICAgICAgICAgY3VyLm5leHQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiByYW5nZXM7XHJcbiAgICB9XHJcblxyXG4gICAgdG9FZGl0b3JTZWxlY3Rpb24oZW5kcG9pbnRzID0gZmFsc2UpIHtcclxuICAgICAgICBsZXQgc2VsID0gRWRpdG9yU2VsZWN0aW9uLmNyZWF0ZSh0aGlzLnRvU2VsZWN0aW9uUmFuZ2VzKCkpO1xyXG4gICAgICAgIGlmIChlbmRwb2ludHMpXHJcbiAgICAgICAgICAgIHNlbCA9IGdldEVkaXRvclNlbGVjdGlvbkVuZHBvaW50cyhzZWwpO1xyXG4gICAgICAgIHJldHVybiBzZWw7XHJcbiAgICB9XHJcblxyXG4gICAgY29udGFpbnNTZWxlY3Rpb24oc2VsZWN0aW9uOiBFZGl0b3JTZWxlY3Rpb24pIHtcclxuICAgICAgICBmdW5jdGlvbiByYW5nZUxpZXNXaXRoaW5TZWxlY3Rpb24ocmFuZ2U6IFNlbGVjdGlvblJhbmdlLCBzZWw6IFNlbGVjdGlvblJhbmdlW10pIHtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBzZWxSYW5nZSBvZiBzZWwpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzZWxSYW5nZS5mcm9tIDw9IHJhbmdlLmZyb20gJiYgc2VsUmFuZ2UudG8gPj0gcmFuZ2UudG8pIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgXHJcbiAgICAgICAgY29uc3QgdGFic3RvcFJhbmdlcyA9IHRoaXMudG9TZWxlY3Rpb25SYW5nZXMoKTtcclxuICAgICAgICBsZXQgcmVzdWx0ID0gdHJ1ZTtcclxuICAgIFxyXG4gICAgICAgIGZvciAoY29uc3QgcmFuZ2Ugb2Ygc2VsZWN0aW9uLnJhbmdlcykge1xyXG4gICAgICAgICAgICBpZiAoIXJhbmdlTGllc1dpdGhpblNlbGVjdGlvbihyYW5nZSwgdGFic3RvcFJhbmdlcykpIHtcclxuICAgICAgICAgICAgICAgIHJlc3VsdCA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICBoaWRlRnJvbUVkaXRvcigpIHtcclxuICAgICAgICB0aGlzLmhpZGRlbiA9IHRydWU7XHJcbiAgICB9XHJcblxyXG4gICAgbWFwKGNoYW5nZXM6IENoYW5nZURlc2MpIHtcclxuICAgICAgICB0aGlzLmRlY29zID0gdGhpcy5kZWNvcy5tYXAoY2hhbmdlcyk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIGdldFJhbmdlcygpIHtcclxuICAgICAgICBjb25zdCByYW5nZXMgPSBbXTtcclxuICAgICAgICBjb25zdCBjdXIgPSB0aGlzLmRlY29zLml0ZXIoKTtcclxuXHJcbiAgICAgICAgd2hpbGUgKGN1ci52YWx1ZSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIGlmIChjdXIuZnJvbSAhPSBjdXIudG8pe1xyXG4gICAgICAgICAgICAgICAgcmFuZ2VzLnB1c2goY3VyLnZhbHVlLnJhbmdlKGN1ci5mcm9tLCBjdXIudG8pKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjdXIubmV4dCgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHJhbmdlcztcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHRhYnN0b3BTcGVjc1RvVGFic3RvcEdyb3Vwcyh0YWJzdG9wczogVGFic3RvcFNwZWNbXSwgY29sb3I6IG51bWJlcik6VGFic3RvcEdyb3VwW10ge1xyXG4gICAgY29uc3QgdGFic3RvcHNCeU51bWJlcjoge1tuOiBzdHJpbmddOiBUYWJzdG9wU3BlY1tdfSA9IHt9O1xyXG5cclxuICAgIGZvciAoY29uc3QgdGFic3RvcCBvZiB0YWJzdG9wcykge1xyXG4gICAgICAgIGNvbnN0IG4gPSBTdHJpbmcodGFic3RvcC5udW1iZXIpO1xyXG5cclxuICAgICAgICBpZiAodGFic3RvcHNCeU51bWJlcltuXSkge1xyXG4gICAgICAgICAgICB0YWJzdG9wc0J5TnVtYmVyW25dLnB1c2godGFic3RvcCk7XHJcblx0XHR9XHJcblx0XHRlbHNlIHtcclxuICAgICAgICAgICAgdGFic3RvcHNCeU51bWJlcltuXSA9IFt0YWJzdG9wXTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG4gICAgY29uc3QgcmVzdWx0ID0gW107XHJcbiAgICBjb25zdCBudW1iZXJzID0gT2JqZWN0LmtleXModGFic3RvcHNCeU51bWJlcik7XHJcbiAgICBudW1iZXJzLnNvcnQoKGEsYikgPT4gcGFyc2VJbnQoYSkgLSBwYXJzZUludChiKSk7XHJcblxyXG4gICAgZm9yIChjb25zdCBudW1iZXIgb2YgbnVtYmVycykge1xyXG4gICAgICAgIGNvbnN0IGdycCA9IG5ldyBUYWJzdG9wR3JvdXAodGFic3RvcHNCeU51bWJlcltudW1iZXJdLCBjb2xvcik7XHJcbiAgICAgICAgcmVzdWx0LnB1c2goZ3JwKTtcclxuICAgIH1cclxuXHJcblx0cmV0dXJuIHJlc3VsdDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEVkaXRvclNlbGVjdGlvbkVuZHBvaW50cyhzZWw6IEVkaXRvclNlbGVjdGlvbikge1xyXG4gICAgY29uc3QgZW5kcG9pbnRzID0gc2VsLnJhbmdlcy5tYXAocmFuZ2UgPT4gRWRpdG9yU2VsZWN0aW9uLnJhbmdlKHJhbmdlLnRvLCByYW5nZS50bykpO1xyXG5cclxuICAgIHJldHVybiBFZGl0b3JTZWxlY3Rpb24uY3JlYXRlKGVuZHBvaW50cyk7XHJcbn1cclxuIl19