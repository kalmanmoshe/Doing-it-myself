import { EditorSelection } from "@codemirror/state";
import { Decoration } from "@codemirror/view";
import { resetCursorBlink } from "src/utils/editor_utils";
import { endSnippet } from "./codemirror/history";
const LATEX_SUITE_TABSTOP_DECO_CLASS = "latex-suite-snippet-placeholder";
function getMarkerDecoration(from, to, color) {
    const className = `${LATEX_SUITE_TABSTOP_DECO_CLASS} ${LATEX_SUITE_TABSTOP_DECO_CLASS}-${color}`;
    return Decoration.mark({
        inclusive: true,
        color: color,
        class: className,
    }).range(from, to);
}
export class TabstopGroup {
    decos;
    color;
    hidden;
    constructor(tabstopSpecs, color) {
        const decos = tabstopSpecs.map(spec => getMarkerDecoration(spec.from, spec.to, color));
        this.decos = Decoration.set(decos, true);
        this.color = color;
        this.hidden = false;
    }
    select(view, selectEndpoints, isEndSnippet) {
        const sel = this.toEditorSelection();
        const toSelect = selectEndpoints ? getEditorSelectionEndpoints(sel) : sel;
        view.dispatch({
            selection: toSelect,
            effects: isEndSnippet ? endSnippet.of(null) : undefined
        });
        resetCursorBlink();
        this.hideFromEditor();
    }
    toSelectionRanges() {
        const ranges = [];
        const cur = this.decos.iter();
        while (cur.value != null) {
            ranges.push(EditorSelection.range(cur.from, cur.to));
            cur.next();
        }
        return ranges;
    }
    toEditorSelection(endpoints = false) {
        let sel = EditorSelection.create(this.toSelectionRanges());
        if (endpoints)
            sel = getEditorSelectionEndpoints(sel);
        return sel;
    }
    containsSelection(selection) {
        function rangeLiesWithinSelection(range, sel) {
            for (const selRange of sel) {
                if (selRange.from <= range.from && selRange.to >= range.to) {
                    return true;
                }
            }
            return false;
        }
        const tabstopRanges = this.toSelectionRanges();
        let result = true;
        for (const range of selection.ranges) {
            if (!rangeLiesWithinSelection(range, tabstopRanges)) {
                result = false;
                break;
            }
        }
        return result;
    }
    hideFromEditor() {
        this.hidden = true;
    }
    map(changes) {
        this.decos = this.decos.map(changes);
    }
    getRanges() {
        const ranges = [];
        const cur = this.decos.iter();
        while (cur.value != null) {
            if (cur.from != cur.to) {
                ranges.push(cur.value.range(cur.from, cur.to));
            }
            cur.next();
        }
        return ranges;
    }
}
export function tabstopSpecsToTabstopGroups(tabstops, color) {
    const tabstopsByNumber = {};
    for (const tabstop of tabstops) {
        const n = String(tabstop.number);
        if (tabstopsByNumber[n]) {
            tabstopsByNumber[n].push(tabstop);
        }
        else {
            tabstopsByNumber[n] = [tabstop];
        }
    }
    const result = [];
    const numbers = Object.keys(tabstopsByNumber);
    numbers.sort((a, b) => parseInt(a) - parseInt(b));
    for (const number of numbers) {
        const grp = new TabstopGroup(tabstopsByNumber[number], color);
        result.push(grp);
    }
    return result;
}
export function getEditorSelectionEndpoints(sel) {
    const endpoints = sel.ranges.map(range => EditorSelection.range(range.to, range.to));
    return EditorSelection.create(endpoints);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFic3RvcC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zbmlwcGV0cy90YWJzdG9wLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBYyxlQUFlLEVBQWtCLE1BQU0sbUJBQW1CLENBQUM7QUFDaEYsT0FBTyxFQUFFLFVBQVUsRUFBNkIsTUFBTSxrQkFBa0IsQ0FBQztBQUN6RSxPQUFPLEVBQUUsZ0JBQWdCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMxRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFbEQsTUFBTSw4QkFBOEIsR0FBRyxpQ0FBaUMsQ0FBQztBQVN6RSxTQUFTLG1CQUFtQixDQUFDLElBQVksRUFBRSxFQUFVLEVBQUUsS0FBYTtJQUNoRSxNQUFNLFNBQVMsR0FBRyxHQUFHLDhCQUE4QixJQUFJLDhCQUE4QixJQUFJLEtBQUssRUFBRSxDQUFDO0lBRWpHLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQztRQUNuQixTQUFTLEVBQUUsSUFBSTtRQUNmLEtBQUssRUFBRSxLQUFLO1FBQ1osS0FBSyxFQUFFLFNBQVM7S0FDbkIsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7QUFDdkIsQ0FBQztBQUVELE1BQU0sT0FBTyxZQUFZO0lBQ3JCLEtBQUssQ0FBZ0I7SUFDckIsS0FBSyxDQUFTO0lBQ2QsTUFBTSxDQUFVO0lBRWhCLFlBQVksWUFBMkIsRUFBRSxLQUFhO1FBQ2xELE1BQU0sS0FBSyxHQUFHLFlBQVksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztRQUN2RixJQUFJLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQ3pD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QU0sR0FBRyxHQUFHLElBQUksWUFBWSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzlELE1BQU0sQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDckIsQ0FBQztJQUVKLE9BQU8sTUFBTSxDQUFDO0FBQ2YsQ0FBQztBQUVELE1BQU0sVUFBVSwyQkFBMkIsQ0FBQyxHQUFvQjtJQUM1RCxNQUFNLFNBQVMsR0FBRyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLGVBQWUsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVyRixPQUFPLGVBQWUsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDN0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENoYW5nZURlc2MsIEVkaXRvclNlbGVjdGlvbiwgU2VsZWN0aW9uUmFuZ2UgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcbmltcG9ydCB7IERlY29yYXRpb24sIERlY29yYXRpb25TZXQsIEVkaXRvclZpZXcgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xuaW1wb3J0IHsgcmVzZXRDdXJzb3JCbGluayB9IGZyb20gXCJzcmMvdXRpbHMvZWRpdG9yX3V0aWxzXCI7XG5pbXBvcnQgeyBlbmRTbmlwcGV0IH0gZnJvbSBcIi4vY29kZW1pcnJvci9oaXN0b3J5XCI7XG5cbmNvbnN0IExBVEVYX1NVSVRFX1RBQlNUT1BfREVDT19DTEFTUyA9IFwibGF0ZXgtc3VpdGUtc25pcHBldC1wbGFjZWhvbGRlclwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIFRhYnN0b3BTcGVjIHtcbiAgICBudW1iZXI6IG51bWJlcixcbiAgICBmcm9tOiBudW1iZXIsXG4gICAgdG86IG51bWJlcixcbiAgICByZXBsYWNlbWVudDogc3RyaW5nXG59XG5cbmZ1bmN0aW9uIGdldE1hcmtlckRlY29yYXRpb24oZnJvbTogbnVtYmVyLCB0bzogbnVtYmVyLCBjb2xvcjogbnVtYmVyKSB7XG4gICAgY29uc3QgY2xhc3NOYW1lID0gYCR7TEFURVhfU1VJVEVfVEFCU1RPUF9ERUNPX0NMQVNTfSAke0xBVEVYX1NVSVRFX1RBQlNUT1BfREVDT19DTEFTU30tJHtjb2xvcn1gO1xuXG4gICAgcmV0dXJuIERlY29yYXRpb24ubWFyayh7XG4gICAgICAgIGluY2x1c2l2ZTogdHJ1ZSxcbiAgICAgICAgY29sb3I6IGNvbG9yLFxuICAgICAgICBjbGFzczogY2xhc3NOYW1lLFxuICAgIH0pLnJhbmdlKGZyb20sIHRvKTtcbn1cblxuZXhwb3J0IGNsYXNzIFRhYnN0b3BHcm91cCB7XG4gICAgZGVjb3M6IERlY29yYXRpb25TZXQ7XG4gICAgY29sb3I6IG51bWJlcjtcbiAgICBoaWRkZW46IGJvb2xlYW47XG5cbiAgICBjb25zdHJ1Y3Rvcih0YWJzdG9wU3BlY3M6IFRhYnN0b3BTcGVjW10sIGNvbG9yOiBudW1iZXIpIHtcbiAgICAgICAgY29uc3QgZGVjb3MgPSB0YWJzdG9wU3BlY3MubWFwKHNwZWMgPT4gZ2V0TWFya2VyRGVjb3JhdGlvbihzcGVjLmZyb20sIHNwZWMudG8sIGNvbG9yKSk7XG4gICAgICAgIHRoaXMuZGVjb3MgPSBEZWNvcmF0aW9uLnNldChkZWNvcywgdHJ1ZSk7XG4gICAgICAgIHRoaXMuY29sb3IgPSBjb2xvcjtcbiAgICAgICAgdGhpcy5oaWRkZW4gPSBmYWxzZTtcbiAgICB9XG5cbiAgICBzZWxlY3QodmlldzogRWRpdG9yVmlldywgc2VsZWN0RW5kcG9pbnRzOiBib29sZWFuLCBpc0VuZFNuaXBwZXQ6IGJvb2xlYW4pIHtcbiAgICAgICAgY29uc3Qgc2VsID0gdGhpcy50b0VkaXRvclNlbGVjdGlvbigpO1xuICAgICAgICBjb25zdCB0b1NlbGVjdCA9IHNlbGVjdEVuZHBvaW50cyA/IGdldEVkaXRvclNlbGVjdGlvbkVuZHBvaW50cyhzZWwpIDogc2VsO1xuICAgICAgICBcbiAgICAgICAgdmlldy5kaXNwYXRjaCh7XG4gICAgICAgICAgICBzZWxlY3Rpb246IHRvU2VsZWN0LFxuICAgICAgICAgICAgZWZmZWN0czogaXNFbmRTbmlwcGV0ID8gZW5kU25pcHBldC5vZihudWxsKSA6IHVuZGVmaW5lZFxuICAgICAgICB9KVxuICAgICAgICByZXNldEN1cnNvckJsaW5rKCk7XG5cbiAgICAgICAgdGhpcy5oaWRlRnJvbUVkaXRvcigpO1xuICAgIH1cblxuICAgIHRvU2VsZWN0aW9uUmFuZ2VzKCkge1xuICAgICAgICBjb25zdCByYW5nZXMgPSBbXTtcbiAgICAgICAgY29uc3QgY3VyID0gdGhpcy5kZWNvcy5pdGVyKCk7XG4gICAgXG4gICAgICAgIHdoaWxlIChjdXIudmFsdWUgIT0gbnVsbCkge1xuICAgICAgICAgICAgcmFuZ2VzLnB1c2goRWRpdG9yU2VsZWN0aW9uLnJhbmdlKGN1ci5mcm9tLCBjdXIudG8pKTtcbiAgICAgICAgICAgIGN1ci5uZXh0KCk7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gcmFuZ2VzO1xuICAgIH1cblxuICAgIHRvRWRpdG9yU2VsZWN0aW9uKGVuZHBvaW50cyA9IGZhbHNlKSB7XG4gICAgICAgIGxldCBzZWwgPSBFZGl0b3JTZWxlY3Rpb24uY3JlYXRlKHRoaXMudG9TZWxlY3Rpb25SYW5nZXMoKSk7XG4gICAgICAgIGlmIChlbmRwb2ludHMpXG4gICAgICAgICAgICBzZWwgPSBnZXRFZGl0b3JTZWxlY3Rpb25FbmRwb2ludHMoc2VsKTtcbiAgICAgICAgcmV0dXJuIHNlbDtcbiAgICB9XG5cbiAgICBjb250YWluc1NlbGVjdGlvbihzZWxlY3Rpb246IEVkaXRvclNlbGVjdGlvbikge1xuICAgICAgICBmdW5jdGlvbiByYW5nZUxpZXNXaXRoaW5TZWxlY3Rpb24ocmFuZ2U6IFNlbGVjdGlvblJhbmdlLCBzZWw6IFNlbGVjdGlvblJhbmdlW10pIHtcbiAgICAgICAgICAgIGZvciAoY29uc3Qgc2VsUmFuZ2Ugb2Ygc2VsKSB7XG4gICAgICAgICAgICAgICAgaWYgKHNlbFJhbmdlLmZyb20gPD0gcmFuZ2UuZnJvbSAmJiBzZWxSYW5nZS50byA+PSByYW5nZS50bykge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICBcbiAgICAgICAgY29uc3QgdGFic3RvcFJhbmdlcyA9IHRoaXMudG9TZWxlY3Rpb25SYW5nZXMoKTtcbiAgICAgICAgbGV0IHJlc3VsdCA9IHRydWU7XG4gICAgXG4gICAgICAgIGZvciAoY29uc3QgcmFuZ2Ugb2Ygc2VsZWN0aW9uLnJhbmdlcykge1xuICAgICAgICAgICAgaWYgKCFyYW5nZUxpZXNXaXRoaW5TZWxlY3Rpb24ocmFuZ2UsIHRhYnN0b3BSYW5nZXMpKSB7XG4gICAgICAgICAgICAgICAgcmVzdWx0ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBoaWRlRnJvbUVkaXRvcigpIHtcbiAgICAgICAgdGhpcy5oaWRkZW4gPSB0cnVlO1xuICAgIH1cblxuICAgIG1hcChjaGFuZ2VzOiBDaGFuZ2VEZXNjKSB7XG4gICAgICAgIHRoaXMuZGVjb3MgPSB0aGlzLmRlY29zLm1hcChjaGFuZ2VzKTtcbiAgICB9XG4gICAgXG4gICAgZ2V0UmFuZ2VzKCkge1xuICAgICAgICBjb25zdCByYW5nZXMgPSBbXTtcbiAgICAgICAgY29uc3QgY3VyID0gdGhpcy5kZWNvcy5pdGVyKCk7XG5cbiAgICAgICAgd2hpbGUgKGN1ci52YWx1ZSAhPSBudWxsKSB7XG4gICAgICAgICAgICBpZiAoY3VyLmZyb20gIT0gY3VyLnRvKXtcbiAgICAgICAgICAgICAgICByYW5nZXMucHVzaChjdXIudmFsdWUucmFuZ2UoY3VyLmZyb20sIGN1ci50bykpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY3VyLm5leHQoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiByYW5nZXM7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdGFic3RvcFNwZWNzVG9UYWJzdG9wR3JvdXBzKHRhYnN0b3BzOiBUYWJzdG9wU3BlY1tdLCBjb2xvcjogbnVtYmVyKTpUYWJzdG9wR3JvdXBbXSB7XG4gICAgY29uc3QgdGFic3RvcHNCeU51bWJlcjoge1tuOiBzdHJpbmddOiBUYWJzdG9wU3BlY1tdfSA9IHt9O1xuXG4gICAgZm9yIChjb25zdCB0YWJzdG9wIG9mIHRhYnN0b3BzKSB7XG4gICAgICAgIGNvbnN0IG4gPSBTdHJpbmcodGFic3RvcC5udW1iZXIpO1xuXG4gICAgICAgIGlmICh0YWJzdG9wc0J5TnVtYmVyW25dKSB7XG4gICAgICAgICAgICB0YWJzdG9wc0J5TnVtYmVyW25dLnB1c2godGFic3RvcCk7XG5cdFx0fVxuXHRcdGVsc2Uge1xuICAgICAgICAgICAgdGFic3RvcHNCeU51bWJlcltuXSA9IFt0YWJzdG9wXTtcblx0XHR9XG5cdH1cblxuICAgIGNvbnN0IHJlc3VsdCA9IFtdO1xuICAgIGNvbnN0IG51bWJlcnMgPSBPYmplY3Qua2V5cyh0YWJzdG9wc0J5TnVtYmVyKTtcbiAgICBudW1iZXJzLnNvcnQoKGEsYikgPT4gcGFyc2VJbnQoYSkgLSBwYXJzZUludChiKSk7XG5cbiAgICBmb3IgKGNvbnN0IG51bWJlciBvZiBudW1iZXJzKSB7XG4gICAgICAgIGNvbnN0IGdycCA9IG5ldyBUYWJzdG9wR3JvdXAodGFic3RvcHNCeU51bWJlcltudW1iZXJdLCBjb2xvcik7XG4gICAgICAgIHJlc3VsdC5wdXNoKGdycCk7XG4gICAgfVxuXG5cdHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRFZGl0b3JTZWxlY3Rpb25FbmRwb2ludHMoc2VsOiBFZGl0b3JTZWxlY3Rpb24pIHtcbiAgICBjb25zdCBlbmRwb2ludHMgPSBzZWwucmFuZ2VzLm1hcChyYW5nZSA9PiBFZGl0b3JTZWxlY3Rpb24ucmFuZ2UocmFuZ2UudG8sIHJhbmdlLnRvKSk7XG5cbiAgICByZXR1cm4gRWRpdG9yU2VsZWN0aW9uLmNyZWF0ZShlbmRwb2ludHMpO1xufVxuIl19