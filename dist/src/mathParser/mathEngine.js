import { degreesToRadians } from "./mathUtilities";
import { findParenIndex, Paren, findDeepestParenthesesScope } from "../utils/tokenUtensils";
import { getMathJaxOperatorsByPriority, getValuesWithKeysBySide, searchMathJaxOperators } from "../utils/dataManager";
import { MathGroup, MathJaxOperator, Token, BasicMathJaxTokens, ensureAcceptableFormatForMathGroupItems, deepSearchWithPath } from "./mathJaxTokens";
const greekLetters = [
    'Alpha', 'alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta',
    'Iota', 'Kappa', 'Lambda', 'Mu', 'mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho',
    'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'
];
/*const latexOperators=[
    'tan', 'sin', 'cos', 'binom', 'frac', 'asin', 'acos',
    'atan', 'arccos', 'arcsin', 'arctan', 'cdot','sqrt'
]*/
export function findConsecutiveSequences(arr) {
    const sequences = [];
    let start = 0;
    for (let i = 1; i <= arr.length; i++) {
        if (arr[i] !== arr[i - 1] + 1) {
            if (i - start > 1) {
                sequences.push(arr.slice(start, i));
            }
            start = i;
        }
    }
    return sequences;
}
const operatorsForMathinfo = {
    bothButRightBracket: ["^"],
    rightBracketAndRequiresSlash: ["sqrt"],
    both: ["+", "-", "*"],
    special: ["="],
    RightParenAndRequiresSlash: ["sin", "cos", "tan", "asin", "acos", "atan", "arcsin", "arccos", "arctan"],
    doubleRightButBracket: ["frac", "binom", "/"]
};
export class MathInfo {
    debugInfo = "";
    solutionInfo = [];
    mathInfo = [];
    graph = "";
    mathSnapshots = [];
    addGraphInfo(value) {
        this.graph += value;
    }
    addDebugInfo(msg, value) {
        this.debugInfo += (typeof msg === "object" ? JSON.stringify(msg, null, 1) : msg) + " : " + (typeof value === "object" ? JSON.stringify(value, null, 1) : value) + "\n ";
    }
    addSolutionInfo(mes) {
        this.solutionInfo.push(mes);
        this.addDebugInfo("Solved", mes);
    }
    addMathInfo(msg) {
        this.mathInfo.push(msg);
    }
    addMathSnapshot(math) {
        this.mathSnapshots.push(math);
        const result = deepSearchWithPath(math, (item) => item instanceof MathJaxOperator && item.solution !== undefined);
        if (!result)
            return;
        const customFormatter = (check, string) => {
            if (check instanceof MathJaxOperator && check.solution !== undefined) {
                return `{\\color{red}${string}}`;
            }
            return string;
        };
        this.mathInfo.push(math.toString(customFormatter));
        console.log(result.item);
        this.solutionInfo.push(result.item.toStringSolution());
    }
}
function rearrangeEquation(tokens, tokenToisolate) {
}
function isolateMultiplication(tokens, isolatToken) {
}
export class Position {
    operator;
    index;
    start;
    end;
    transition;
    specialChar;
    groups;
    constructor(tokens, index) {
        this.index = index;
        this.transition = this.index;
        this.start = this.index;
        this.end = this.index;
        this.position(tokens);
    }
    position(tokens) {
        this.operator = tokens[this.index].value;
        const metadata = searchMathJaxOperators(this.operator);
        if (!metadata)
            throw new Error(`Operator ${this.operator} not found in metadata`);
        const beforeIndex = [];
        const afterIndex = [];
        getValuesWithKeysBySide(metadata.associativity.positions, true).forEach(() => {
            const item = this.applyPosition(tokens, this.start, true);
            beforeIndex.push(item.mathGroup);
            this.start = item.lastItemOfPrevious;
        });
        getValuesWithKeysBySide(metadata.associativity.positions, false).forEach(() => {
            const item = this.applyPosition(tokens, this.end, false);
            afterIndex.push(item.mathGroup);
            this.end = item.lastItemOfPrevious;
        });
        this.groups = beforeIndex.reverse().concat(afterIndex);
    }
    applyPosition(tokens, index, isLeft) {
        let breakChar = index;
        let target;
        const modifiedIndex = index + (isLeft ? -1 : 1);
        if ((isLeft && index <= 0) || (!isLeft && index >= tokens.length - 1) || !tokens[modifiedIndex]) {
            throw new Error("at applyPosition: \"index wasn't valid\" index: " + index);
        }
        if (tokens[modifiedIndex] instanceof Paren) {
            const parenIndex = findParenIndex(tokens[modifiedIndex], tokens);
            breakChar = isLeft ? parenIndex.open : parenIndex.close + 1;
            // Insure proper formatting removed everything including parentheses
            target = ensureAcceptableFormatForMathGroupItems(tokens.slice(parenIndex.open, parenIndex.close + 1));
        }
        else {
            breakChar = modifiedIndex;
            target = ensureAcceptableFormatForMathGroupItems(tokens[breakChar]);
        }
        if (target?.length === 0) {
            throw new Error(`at applyPosition: couldn't find target token for direction ${isLeft ? 'left' : 'right'} and operator"${tokens[index].value}"`);
        }
        //Make sure we don't create duplicate interlocked math groups
        if (target?.length && target?.length === 1 && target[0] instanceof MathGroup) {
            target = target[0];
            target.tryRemoveUnnecessaryNested();
        }
        return {
            mathGroup: new MathGroup(target),
            lastItemOfPrevious: breakChar,
        };
    }
}
function parseSafetyChecks(operator) {
    if (operator.groupNum !== operator.groups.length) {
        throw new Error(`Invalid number of groups for operator ${operator.operator} expected ${operator.groupNum} but got ${operator.groups.length}`);
    }
}
export function parseOperator(operator) {
    parseSafetyChecks(operator);
    function getOperableValue(group) {
        if (!group || !group.isOperable())
            return null;
        return group.getOperableValue();
    }
    const group1 = getOperableValue(operator.groups[0]);
    const group2 = getOperableValue(operator.groups[1]);
    if (group1 === null || (group2 === null && operator.groups.length > 1))
        return false;
    switch (operator.operator) {
        case "Sine":
            operator.solution = new MathGroup([new Token(Math.sin(degreesToRadians(group1)))]);
            break;
        case "SquareRoot":
            if (group1 < 0) {
                throw new Error("Cannot calculate the square root of a negative number.");
            }
            operator.solution = new MathGroup([new Token(Math.pow(group1, 0.5))]);
            break;
        case "Fraction": {
            if (group2 === 0) {
                throw new Error("Division by zero is not allowed");
            }
            operator.solution = new MathGroup([new Token(group1 / group2)]);
            break;
        }
        case "Power": {
            operator.solution = new MathGroup([new Token(Math.pow(group1, group2))]);
            break;
        }
        case "Multiplication": {
            operator.solution = new MathGroup([new Token(group1 * group2)]);
            break;
        }
        default:
            throw new Error(`Unknown operator type in parseOperator: ${operator.operator}`);
    }
    return true;
}
function operationsOrder(tokens) {
    function findOperatorIndex(begin, end, tokens, regex) {
        const index = tokens.slice(begin, end).findIndex((token) => token.type === "operator" && regex.test(token.value));
        return index > -1 ? index + begin : null;
    }
    const { begin, end } = findDeepestParenthesesScope(tokens);
    let priority = null;
    for (let i = 1; i <= 6; i++) {
        priority = findOperatorIndex(begin, end, tokens, getMathJaxOperatorsByPriority(i, true));
        if (priority !== null)
            break;
    }
    return { start: begin, end: end, specificOperatorIndex: priority };
}
export class MathPraiser {
    input = "";
    tokens;
    solution;
    mathInfo = new MathInfo();
    constructor(input) {
        this.input = input;
        this.processInput();
        const tokens = new BasicMathJaxTokens();
        tokens.addInput(this.input);
        const basicTokens = tokens.tokens;
        this.convertBasicMathJaxTokenaToMathGroup(basicTokens);
        this.addDebugInfo("convertBasicMathJaxTokenaToMathGroup", this.tokens);
        this.input = this.tokens.toString();
        this.controller();
        this.solution = this.tokens;
        this.addDebugInfo("solution", this.solution);
    }
    parse(tokens) {
        const operatorIndex = tokens.getItems().findIndex(t => t instanceof MathJaxOperator && t.isOperable);
        if (operatorIndex < 0)
            return;
        const operator = tokens.getItems()[operatorIndex];
        operator.groups.forEach(group => {
            this.parse(group);
        });
        parseOperator(operator);
        if (!operator.solution) {
            operator.isOperable = false;
            return;
        }
        this.mathInfo.addMathSnapshot(this.tokens.clone());
        tokens.setItem(operator.solution, operatorIndex);
    }
    controller() {
        this.parse(this.tokens);
        combineSimilarValues(this.tokens);
        this.tokens.removeNested();
        this.tokens.combineSimilarValues();
    }
    solutionToString() {
        return (this.tokens.toString()) || "";
    }
    addDebugInfo(mes, value) {
        this.mathInfo.addDebugInfo(mes, value);
    }
    processInput() {
        this.input = this.input
            .replace(/(Math.|\\|\s|left|right)/g, "")
            .replace(/{/g, "(")
            .replace(/}/g, ")");
        //.replace(/(?<!\\|[a-zA-Z])(tan|sin|cos|binom|frac|asin|acos|atan|arccos|arcsin|arctan|cdot)/g, "\\$1");
    }
    finalReturn() {
        // return this.tokens.reconstruct()
    }
    defineGroupsAndOperators(tokens) {
        const range = operationsOrder(tokens);
        if (range.start === null || range.end === null)
            return false;
        if (range.specificOperatorIndex === null && range.start === 0 && range.end === tokens.length)
            return true;
        let newMathGroupSuccess = null;
        if (range.specificOperatorIndex !== null)
            newMathGroupSuccess = this.createOperatorItemFromTokens(tokens, range.specificOperatorIndex);
        else
            newMathGroupSuccess = this.createMathGroupInsertFromTokens(tokens, range.start, range.end);
        if (!newMathGroupSuccess)
            return false;
        return this.defineGroupsAndOperators(tokens);
    }
    convertBasicMathJaxTokenaToMathGroup(basicTokens) {
        const success = this.defineGroupsAndOperators(basicTokens);
        if (!success)
            return;
        this.tokens = new MathGroup(ensureAcceptableFormatForMathGroupItems(basicTokens));
    }
    createMathGroupInsertFromTokens(tokens, start, end) {
        const newMathGroup = new MathGroup(ensureAcceptableFormatForMathGroupItems(tokens.slice(start, end + 1)));
        tokens.splice(start, (end - start) + 1, newMathGroup);
        return true;
    }
    createOperatorItemFromTokens(tokens, index) {
        const metadata = searchMathJaxOperators(tokens[index].value);
        if (!metadata)
            throw new Error(`Operator ${tokens[index].value} not found in metadata`);
        const position = new Position(tokens, index);
        const c = deepClone(tokens);
        const newOperator = new MathJaxOperator(position.operator, metadata.associativity.numPositions, position.groups);
        tokens.splice(position.start, (position.end - position.start) + 1, newOperator);
        return true;
    }
}
function deepClone(items) {
    let clone = [];
    items.forEach(item => {
        clone.push(item instanceof Array ? deepClone(item) : item.clone());
    });
    return clone;
}
function combineSimilarValues(math) {
    const op = math.getItems().find(t => t instanceof MathJaxOperator);
    if (!op)
        return;
    /*const a=new MathOverview()
    a.defineGlobalOverview(math.getItems())
    a.separateIntoIndividuals()*/
}
class mathVariables {
}
export function flattenArray(arr) {
    let result = [];
    let stack = Array.isArray(arr) ? [...arr] : [arr];
    while (stack.length) {
        const next = stack.pop();
        if (Array.isArray(next)) {
            stack.push(...next);
        }
        else {
            result.push(next);
        }
    }
    return result.reverse();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aEVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYXRoUGFyc2VyL21hdGhFbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUF1QyxnQkFBZ0IsRUFBc0MsTUFBTSxpQkFBaUIsQ0FBQztBQUk1SCxPQUFPLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBNkIsMkJBQTJCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN2SCxPQUFPLEVBQTJCLDZCQUE2QixFQUErQix1QkFBdUIsRUFBMEQsc0JBQXNCLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNwTyxPQUFPLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsa0JBQWtCLEVBQXFCLHVDQUF1QyxFQUFFLGtCQUFrQixFQUFpQixNQUFNLGlCQUFpQixDQUFDO0FBR3ZMLE1BQU0sWUFBWSxHQUFHO0lBQ2pCLE9BQU8sRUFBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsT0FBTztJQUM1RSxNQUFNLEVBQUUsT0FBTyxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxLQUFLO0lBQ3hFLE9BQU8sRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE9BQU87Q0FDMUQsQ0FBQztBQUNGOzs7R0FHRztBQUVILE1BQU0sVUFBVSx3QkFBd0IsQ0FBQyxHQUFVO0lBQy9DLE1BQU0sU0FBUyxHQUFHLEVBQUUsQ0FBQztJQUNyQixJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7SUFDZCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FB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QUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUN0QixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDeEIsQ0FBQzthQUFNLENBQUM7WUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLENBQUM7SUFDTCxDQUFDO0lBQ0QsT0FBTyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyBxdWFkLGNhbGN1bGF0ZUJpbm9tLHJvdW5kQnlTZXR0aW5ncyAsZGVncmVlc1RvUmFkaWFucyxyYWRpYW5zVG9EZWdyZWVzLCBjYWxjdWxhdGVGYWN0b3JpYWx9IGZyb20gXCIuL21hdGhVdGlsaXRpZXNcIjtcclxuaW1wb3J0IHsgZXhwYW5kRXhwcmVzc2lvbixjdXJseUJyYWNrZXRzUmVnZXggfSBmcm9tIFwiLi4vaW1WZXJ5TGF6eVwiO1xyXG5pbXBvcnQgeyBhcnJUb1JlZ2V4U3RyaW5nLCBBeGlzLCByZWdFeHAgfSBmcm9tIFwiLi4vdGlrempheC90aWt6amF4XCI7XHJcbmltcG9ydCB7IEFzc29jaWF0aXZpdHkgfSBmcm9tIFwic3JjL3V0aWxzL3N0YXRpY0RhdGFcIjtcclxuaW1wb3J0IHsgZmluZFBhcmVuSW5kZXgsIFBhcmVuLGlkUGFyZW50aGVzZXMsIGlzT3BlblBhcmVuLCBmaW5kRGVlcGVzdFBhcmVudGhlc2VzU2NvcGUgfSBmcm9tIFwiLi4vdXRpbHMvdG9rZW5VdGVuc2lsc1wiO1xyXG5pbXBvcnQgeyBnZXRBbGxNYXRoSmF4UmVmZXJlbmNlcywgZ2V0TWF0aEpheE9wZXJhdG9yc0J5UHJpb3JpdHksIGdldE9wZXJhdG9yc0J5QXNzb2NpYXRpdml0eSwgZ2V0VmFsdWVzV2l0aEtleXNCeVNpZGUsIGhhc0ltcGxpY2l0TXVsdGlwbGljYXRpb24sIGlzT3BlcmF0b3JXaXRoQXNzb2NpYXRpdml0eSwgc2VhcmNoTWF0aEpheE9wZXJhdG9ycyB9IGZyb20gXCIuLi91dGlscy9kYXRhTWFuYWdlclwiO1xyXG5pbXBvcnQgeyBNYXRoR3JvdXAsIE1hdGhKYXhPcGVyYXRvciwgVG9rZW4sIEJhc2ljTWF0aEpheFRva2VucywgQmFzaWNNYXRoSmF4VG9rZW4sIGVuc3VyZUFjY2VwdGFibGVGb3JtYXRGb3JNYXRoR3JvdXBJdGVtcywgZGVlcFNlYXJjaFdpdGhQYXRoLCBNYXRoR3JvdXBJdGVtIH0gZnJvbSBcIi4vbWF0aEpheFRva2Vuc1wiO1xyXG5pbXBvcnQgeyBzdGFydCB9IGZyb20gXCJyZXBsXCI7XHJcbmltcG9ydCB7IGdyb3VwIH0gZnJvbSBcImNvbnNvbGVcIjtcclxuY29uc3QgZ3JlZWtMZXR0ZXJzID0gW1xyXG4gICAgJ0FscGhhJywnYWxwaGEnLCAnQmV0YScsICdHYW1tYScsICdEZWx0YScsICdFcHNpbG9uJywgJ1pldGEnLCAnRXRhJywgJ1RoZXRhJywgXHJcbiAgICAnSW90YScsICdLYXBwYScsICdMYW1iZGEnLCAnTXUnLCdtdScsICdOdScsICdYaScsICdPbWljcm9uJywgJ1BpJywgJ1JobycsIFxyXG4gICAgJ1NpZ21hJywgJ1RhdScsICdVcHNpbG9uJywgJ1BoaScsICdDaGknLCAnUHNpJywgJ09tZWdhJ1xyXG5dO1xyXG4vKmNvbnN0IGxhdGV4T3BlcmF0b3JzPVtcclxuICAgICd0YW4nLCAnc2luJywgJ2NvcycsICdiaW5vbScsICdmcmFjJywgJ2FzaW4nLCAnYWNvcycsIFxyXG4gICAgJ2F0YW4nLCAnYXJjY29zJywgJ2FyY3NpbicsICdhcmN0YW4nLCAnY2RvdCcsJ3NxcnQnXHJcbl0qL1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRDb25zZWN1dGl2ZVNlcXVlbmNlcyhhcnI6IGFueVtdKSB7XHJcbiAgICBjb25zdCBzZXF1ZW5jZXMgPSBbXTtcclxuICAgIGxldCBzdGFydCA9IDA7XHJcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBhcnIubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpZiAoYXJyW2ldICE9PSBhcnJbaSAtIDFdICsgMSkge1xyXG4gICAgICAgICAgICBpZiAoaSAtIHN0YXJ0ID4gMSkge1xyXG4gICAgICAgICAgICAgICAgc2VxdWVuY2VzLnB1c2goYXJyLnNsaWNlKHN0YXJ0LCBpKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3RhcnQgPSBpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBzZXF1ZW5jZXM7XHJcbn1cclxuXHJcblxyXG5jb25zdCBvcGVyYXRvcnNGb3JNYXRoaW5mbyA9IHtcclxuICAgIGJvdGhCdXRSaWdodEJyYWNrZXQ6IFtcIl5cIl0sXHJcbiAgICByaWdodEJyYWNrZXRBbmRSZXF1aXJlc1NsYXNoOiBbXCJzcXJ0XCJdLFxyXG4gICAgYm90aDogW1wiK1wiLCBcIi1cIiwgXCIqXCJdLFxyXG4gICAgc3BlY2lhbDogW1wiPVwiXSxcclxuICAgIFJpZ2h0UGFyZW5BbmRSZXF1aXJlc1NsYXNoOiBbXCJzaW5cIiwgXCJjb3NcIiwgXCJ0YW5cIiwgXCJhc2luXCIsIFwiYWNvc1wiLCBcImF0YW5cIiwgXCJhcmNzaW5cIiwgXCJhcmNjb3NcIiwgXCJhcmN0YW5cIl0sXHJcbiAgICBkb3VibGVSaWdodEJ1dEJyYWNrZXQ6IFtcImZyYWNcIiwgXCJiaW5vbVwiLFwiL1wiXVxyXG59O1xyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBNYXRoSW5mb3tcclxuICAgIGRlYnVnSW5mbzogc3RyaW5nPVwiXCI7XHJcbiAgICBzb2x1dGlvbkluZm86IGFueVtdPVtdO1xyXG4gICAgbWF0aEluZm86IGFueVtdPVtdXHJcbiAgICBncmFwaDogc3RyaW5nPVwiXCI7XHJcbiAgICBtYXRoU25hcHNob3RzOiBNYXRoR3JvdXBbXT1bXVxyXG4gICAgYWRkR3JhcGhJbmZvKHZhbHVlOiBzdHJpbmcpe1xyXG4gICAgICAgIHRoaXMuZ3JhcGgrPXZhbHVlO1xyXG4gICAgfVxyXG4gICAgYWRkRGVidWdJbmZvKG1zZzogc3RyaW5nLCB2YWx1ZTogYW55KXtcclxuICAgICAgICB0aGlzLmRlYnVnSW5mbys9KHR5cGVvZiBtc2c9PT1cIm9iamVjdFwiP0pTT04uc3RyaW5naWZ5KG1zZyxudWxsLDEpOm1zZykrXCIgOiBcIisodHlwZW9mIHZhbHVlPT09XCJvYmplY3RcIj9KU09OLnN0cmluZ2lmeSh2YWx1ZSxudWxsLDEpOnZhbHVlKSsgXCJcXG4gXCI7XHJcbiAgICB9XHJcbiAgICBhZGRTb2x1dGlvbkluZm8obWVzOiBzdHJpbmcpe1xyXG4gICAgICAgIHRoaXMuc29sdXRpb25JbmZvLnB1c2gobWVzKTtcclxuICAgICAgICB0aGlzLmFkZERlYnVnSW5mbyhcIlNvbHZlZFwiLG1lcyk7XHJcbiAgICB9XHJcbiAgICBhZGRNYXRoSW5mbyhtc2c6IHN0cmluZyl7XHJcbiAgICAgICAgdGhpcy5tYXRoSW5mby5wdXNoKG1zZylcclxuICAgIH1cclxuICAgIGFkZE1hdGhTbmFwc2hvdChtYXRoOiBNYXRoR3JvdXApe1xyXG4gICAgICAgIHRoaXMubWF0aFNuYXBzaG90cy5wdXNoKG1hdGgpXHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gZGVlcFNlYXJjaFdpdGhQYXRoKFxyXG4gICAgICAgICAgICBtYXRoLFxyXG4gICAgICAgICAgICAoaXRlbSkgPT4gaXRlbSBpbnN0YW5jZW9mIE1hdGhKYXhPcGVyYXRvciAmJiBpdGVtLnNvbHV0aW9uICE9PSB1bmRlZmluZWRcclxuICAgICAgICApO1xyXG4gICAgICAgIGlmKCFyZXN1bHQpcmV0dXJuXHJcblxyXG4gICAgICAgIGNvbnN0IGN1c3RvbUZvcm1hdHRlciA9IChjaGVjazogYW55LHN0cmluZzogc3RyaW5nKTogc3RyaW5nID0+IHtcclxuICAgICAgICAgICAgaWYgKGNoZWNrIGluc3RhbmNlb2YgTWF0aEpheE9wZXJhdG9yICYmIGNoZWNrLnNvbHV0aW9uICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBge1xcXFxjb2xvcntyZWR9JHtzdHJpbmd9fWA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5tYXRoSW5mby5wdXNoKG1hdGgudG9TdHJpbmcoY3VzdG9tRm9ybWF0dGVyKSlcclxuICAgICAgICBjb25zb2xlLmxvZyhyZXN1bHQuaXRlbSlcclxuICAgICAgICB0aGlzLnNvbHV0aW9uSW5mby5wdXNoKHJlc3VsdC5pdGVtLnRvU3RyaW5nU29sdXRpb24oKSlcclxuICAgICAgICBcclxuICAgIH1cclxuXHJcbn1cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5mdW5jdGlvbiByZWFycmFuZ2VFcXVhdGlvbih0b2tlbnM6IGFueSx0b2tlblRvaXNvbGF0ZTogYW55KXtcclxuICAgIFxyXG59XHJcblxyXG5mdW5jdGlvbiBpc29sYXRlTXVsdGlwbGljYXRpb24odG9rZW5zOiBhbnksaXNvbGF0VG9rZW46IFRva2VuKXsvKlxyXG4gICAgY29uc3QgaW5kZXg9b3BlcmF0aW9uc09yZGVyKHRva2VucylcclxuICAgIGNvbnN0IElzb2xhdGVkPXRva2Vucy50b2tlbnMuZmluZCgodG9rZW46IGFueSwgaWR4OiBudW1iZXIpPT5pZHg8aW5kZXgpXHJcbiAgICBjb25zdCBmcmFjPWNyZWF0ZUZyYWModG9rZW5zLmxpc3Quc2xpY2UoaW5kZXggKyAxKSxuZXcgVG9rZW4oSXNvbGF0ZWQudmFsdWUpKVxyXG4gICAgSXNvbGF0ZWQudmFsdWU9MTtcclxuICAgIHRva2Vucy5pbnNlcnRUb2tlbnMoaW5kZXgrMSx0b2tlbnMudG9rZW5zLmxlbmd0aC1pbmRleCsxLGZyYWMpKi9cclxufVxyXG5cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgUG9zaXRpb24ge1xyXG4gICAgb3BlcmF0b3I6IHN0cmluZztcclxuICAgIGluZGV4OiBudW1iZXI7XHJcbiAgICBzdGFydDogbnVtYmVyO1xyXG4gICAgZW5kOiBudW1iZXI7XHJcbiAgICB0cmFuc2l0aW9uOiBudW1iZXI7XHJcbiAgICBzcGVjaWFsQ2hhcjogc3RyaW5nO1xyXG4gICAgXHJcbiAgICBncm91cHM6IE1hdGhHcm91cFtdO1xyXG4gICAgY29uc3RydWN0b3IodG9rZW5zOiBhbnlbXSwgaW5kZXg6IG51bWJlcil7XHJcbiAgICAgICAgdGhpcy5pbmRleCA9IGluZGV4O1xyXG4gICAgICAgIHRoaXMudHJhbnNpdGlvbiA9IHRoaXMuaW5kZXg7XHJcbiAgICAgICAgdGhpcy5zdGFydCA9IHRoaXMuaW5kZXg7XHJcbiAgICAgICAgdGhpcy5lbmQgPSB0aGlzLmluZGV4O1xyXG4gICAgICAgIHRoaXMucG9zaXRpb24odG9rZW5zKVxyXG4gICAgfVxyXG4gICAgcG9zaXRpb24odG9rZW5zOiBhbnlbXSkge1xyXG4gICAgICAgIHRoaXMub3BlcmF0b3IgPSB0b2tlbnNbdGhpcy5pbmRleF0udmFsdWU7XHJcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBzZWFyY2hNYXRoSmF4T3BlcmF0b3JzKHRoaXMub3BlcmF0b3IpO1xyXG4gICAgICAgIGlmICghbWV0YWRhdGEpIHRocm93IG5ldyBFcnJvcihgT3BlcmF0b3IgJHt0aGlzLm9wZXJhdG9yfSBub3QgZm91bmQgaW4gbWV0YWRhdGFgKTtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IGJlZm9yZUluZGV4OiBNYXRoR3JvdXBbXSA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGFmdGVySW5kZXg6ICBNYXRoR3JvdXBbXSA9IFtdO1xyXG4gICAgXHJcbiAgICAgICAgZ2V0VmFsdWVzV2l0aEtleXNCeVNpZGUobWV0YWRhdGEuYXNzb2NpYXRpdml0eS5wb3NpdGlvbnMsIHRydWUpLmZvckVhY2goKCkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtID0gdGhpcy5hcHBseVBvc2l0aW9uKHRva2VucywgdGhpcy5zdGFydCwgdHJ1ZSk7XHJcbiAgICAgICAgICAgIGJlZm9yZUluZGV4LnB1c2goaXRlbS5tYXRoR3JvdXApO1xyXG4gICAgICAgICAgICB0aGlzLnN0YXJ0ID0gaXRlbS5sYXN0SXRlbU9mUHJldmlvdXM7XHJcbiAgICAgICAgfSk7XHJcbiAgICBcclxuICAgIFxyXG4gICAgICAgIGdldFZhbHVlc1dpdGhLZXlzQnlTaWRlKG1ldGFkYXRhLmFzc29jaWF0aXZpdHkucG9zaXRpb25zLCBmYWxzZSkuZm9yRWFjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLmFwcGx5UG9zaXRpb24odG9rZW5zLCB0aGlzLmVuZCwgZmFsc2UpO1xyXG4gICAgICAgICAgICBhZnRlckluZGV4LnB1c2goaXRlbS5tYXRoR3JvdXApO1xyXG4gICAgICAgICAgICB0aGlzLmVuZCA9IGl0ZW0ubGFzdEl0ZW1PZlByZXZpb3VzO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIHRoaXMuZ3JvdXBzID0gYmVmb3JlSW5kZXgucmV2ZXJzZSgpLmNvbmNhdChhZnRlckluZGV4KTtcclxuICAgIH1cclxuICAgIGFwcGx5UG9zaXRpb24odG9rZW5zOiBhbnlbXSwgaW5kZXg6ICBudW1iZXIsIGlzTGVmdDogYm9vbGVhbikge1xyXG4gICAgICAgIGxldCBicmVha0NoYXI9aW5kZXhcclxuICAgICAgICBsZXQgdGFyZ2V0OiBhbnk7XHJcbiAgICAgICAgY29uc3QgbW9kaWZpZWRJbmRleCA9ICBpbmRleCsoaXNMZWZ0Py0gMSA6ICAxKTtcclxuXHJcbiAgICAgICAgaWYgKChpc0xlZnQgJiYgaW5kZXggPD0gMCkgfHwgKCFpc0xlZnQgJiYgaW5kZXggPj0gdG9rZW5zLmxlbmd0aCAtIDEpIHx8ICF0b2tlbnNbbW9kaWZpZWRJbmRleF0pIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYXQgYXBwbHlQb3NpdGlvbjogXFxcImluZGV4IHdhc24ndCB2YWxpZFxcXCIgaW5kZXg6IFwiK2luZGV4KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICh0b2tlbnNbbW9kaWZpZWRJbmRleF0gaW5zdGFuY2VvZiBQYXJlbikge1xyXG4gICAgICAgICAgICBjb25zdCBwYXJlbkluZGV4ID0gZmluZFBhcmVuSW5kZXgodG9rZW5zW21vZGlmaWVkSW5kZXhdLHRva2Vucyk7XHJcbiAgICAgICAgICAgIGJyZWFrQ2hhciA9ICBpc0xlZnQgPyBwYXJlbkluZGV4Lm9wZW4gOiBwYXJlbkluZGV4LmNsb3NlKzE7XHJcbiAgICAgICAgICAgIC8vIEluc3VyZSBwcm9wZXIgZm9ybWF0dGluZyByZW1vdmVkIGV2ZXJ5dGhpbmcgaW5jbHVkaW5nIHBhcmVudGhlc2VzXHJcbiAgICAgICAgICAgIHRhcmdldCA9IGVuc3VyZUFjY2VwdGFibGVGb3JtYXRGb3JNYXRoR3JvdXBJdGVtcyh0b2tlbnMuc2xpY2UocGFyZW5JbmRleC5vcGVuLCBwYXJlbkluZGV4LmNsb3NlKzEpKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBicmVha0NoYXI9bW9kaWZpZWRJbmRleDtcclxuICAgICAgICAgICAgdGFyZ2V0ID0gZW5zdXJlQWNjZXB0YWJsZUZvcm1hdEZvck1hdGhHcm91cEl0ZW1zKHRva2Vuc1ticmVha0NoYXJdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRhcmdldD8ubGVuZ3RoPT09MCkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGF0IGFwcGx5UG9zaXRpb246IGNvdWxkbid0IGZpbmQgdGFyZ2V0IHRva2VuIGZvciBkaXJlY3Rpb24gJHtpc0xlZnQ/J2xlZnQnOidyaWdodCd9IGFuZCBvcGVyYXRvclwiJHt0b2tlbnNbaW5kZXhdLnZhbHVlfVwiYCwpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy9NYWtlIHN1cmUgd2UgZG9uJ3QgY3JlYXRlIGR1cGxpY2F0ZSBpbnRlcmxvY2tlZCBtYXRoIGdyb3Vwc1xyXG4gICAgICAgIGlmKHRhcmdldD8ubGVuZ3RoJiZ0YXJnZXQ/Lmxlbmd0aD09PTEmJnRhcmdldFswXWluc3RhbmNlb2YgTWF0aEdyb3VwKXtcclxuICAgICAgICAgICAgdGFyZ2V0PXRhcmdldFswXVxyXG4gICAgICAgICAgICB0YXJnZXQudHJ5UmVtb3ZlVW5uZWNlc3NhcnlOZXN0ZWQoKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIG1hdGhHcm91cDogbmV3IE1hdGhHcm91cCh0YXJnZXQpLFxyXG4gICAgICAgICAgICBsYXN0SXRlbU9mUHJldmlvdXM6IGJyZWFrQ2hhcixcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBwYXJzZVNhZmV0eUNoZWNrcyhvcGVyYXRvcjogTWF0aEpheE9wZXJhdG9yKXtcclxuICAgIGlmIChvcGVyYXRvci5ncm91cE51bSE9PW9wZXJhdG9yLmdyb3Vwcy5sZW5ndGgpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgbnVtYmVyIG9mIGdyb3VwcyBmb3Igb3BlcmF0b3IgJHtvcGVyYXRvci5vcGVyYXRvcn0gZXhwZWN0ZWQgJHtvcGVyYXRvci5ncm91cE51bX0gYnV0IGdvdCAke29wZXJhdG9yLmdyb3Vwcy5sZW5ndGh9YCk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBwYXJzZU9wZXJhdG9yKG9wZXJhdG9yOiBNYXRoSmF4T3BlcmF0b3IpOiBib29sZWFuIHtcclxuICAgIHBhcnNlU2FmZXR5Q2hlY2tzKG9wZXJhdG9yKTsgXHJcbiAgICBmdW5jdGlvbiBnZXRPcGVyYWJsZVZhbHVlKGdyb3VwOiBNYXRoR3JvdXApOiBudW1iZXIgfCBudWxsIHtcclxuICAgICAgICBpZiAoIWdyb3VwfHwhZ3JvdXAuaXNPcGVyYWJsZSgpKSByZXR1cm4gbnVsbDtcclxuICAgICAgICByZXR1cm4gZ3JvdXAuZ2V0T3BlcmFibGVWYWx1ZSgpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZ3JvdXAxID0gZ2V0T3BlcmFibGVWYWx1ZShvcGVyYXRvci5ncm91cHNbMF0pO1xyXG4gICAgY29uc3QgZ3JvdXAyID0gZ2V0T3BlcmFibGVWYWx1ZShvcGVyYXRvci5ncm91cHNbMV0pO1xyXG4gICAgaWYgKGdyb3VwMSA9PT0gbnVsbHx8KGdyb3VwMj09PW51bGwmJm9wZXJhdG9yLmdyb3Vwcy5sZW5ndGg+MSkpIHJldHVybiBmYWxzZTtcclxuICAgIFxyXG4gICAgc3dpdGNoIChvcGVyYXRvci5vcGVyYXRvcikge1xyXG4gICAgICAgIGNhc2UgXCJTaW5lXCI6XHJcbiAgICAgICAgICAgIG9wZXJhdG9yLnNvbHV0aW9uID0gbmV3IE1hdGhHcm91cChbbmV3IFRva2VuKE1hdGguc2luKGRlZ3JlZXNUb1JhZGlhbnMoZ3JvdXAxKSkpXSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgXCJTcXVhcmVSb290XCI6XHJcbiAgICAgICAgICAgIGlmIChncm91cDEgPCAwKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgY2FsY3VsYXRlIHRoZSBzcXVhcmUgcm9vdCBvZiBhIG5lZ2F0aXZlIG51bWJlci5cIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgb3BlcmF0b3Iuc29sdXRpb24gPSBuZXcgTWF0aEdyb3VwKFtuZXcgVG9rZW4oTWF0aC5wb3coZ3JvdXAxLDAuNSkpXSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGNhc2UgXCJGcmFjdGlvblwiOiB7XHJcbiAgICAgICAgICAgIGlmIChncm91cDIgPT09IDApIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRpdmlzaW9uIGJ5IHplcm8gaXMgbm90IGFsbG93ZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgb3BlcmF0b3Iuc29sdXRpb24gPSBuZXcgTWF0aEdyb3VwKFtuZXcgVG9rZW4oZ3JvdXAxIC8gZ3JvdXAyISldKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgXCJQb3dlclwiOiB7XHJcbiAgICAgICAgICAgIG9wZXJhdG9yLnNvbHV0aW9uID0gbmV3IE1hdGhHcm91cChbbmV3IFRva2VuKE1hdGgucG93KGdyb3VwMSxncm91cDIhKSldKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNhc2UgXCJNdWx0aXBsaWNhdGlvblwiOiB7XHJcbiAgICAgICAgICAgIG9wZXJhdG9yLnNvbHV0aW9uID0gbmV3IE1hdGhHcm91cChbbmV3IFRva2VuKGdyb3VwMSAqIGdyb3VwMiEpXSk7XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIH1cclxuICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXHJcbiAgICAgICAgICAgICAgICBgVW5rbm93biBvcGVyYXRvciB0eXBlIGluIHBhcnNlT3BlcmF0b3I6ICR7b3BlcmF0b3Iub3BlcmF0b3J9YFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgICAgICBcclxuICAgIH1cclxuICAgIHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5cclxuXHJcblxyXG5mdW5jdGlvbiBvcGVyYXRpb25zT3JkZXIodG9rZW5zOiBhbnlbXSkge1xyXG4gICAgZnVuY3Rpb24gZmluZE9wZXJhdG9ySW5kZXgoYmVnaW46IG51bWJlciwgZW5kOiBudW1iZXIsIHRva2VuczogYW55LCByZWdleD86IGFueSkge1xyXG4gICAgICAgIGNvbnN0IGluZGV4PXRva2Vucy5zbGljZShiZWdpbiwgZW5kKS5maW5kSW5kZXgoKHRva2VuOiB7IHR5cGU6IHN0cmluZzsgdmFsdWU6IGFueTsgfSkgPT4gdG9rZW4udHlwZSA9PT0gXCJvcGVyYXRvclwiICYmIHJlZ2V4LnRlc3QodG9rZW4udmFsdWUpKTtcclxuICAgICAgICByZXR1cm4gaW5kZXg+LTE/aW5kZXgrYmVnaW46bnVsbDtcclxuICAgIH1cclxuICAgIGNvbnN0IHsgYmVnaW4sIGVuZCB9ID0gZmluZERlZXBlc3RQYXJlbnRoZXNlc1Njb3BlKHRva2Vucyk7XHJcbiAgICBsZXQgcHJpb3JpdHk9bnVsbFxyXG4gICAgZm9yIChsZXQgaT0xO2k8PTY7aSsrKXtcclxuICAgICAgICBwcmlvcml0eSA9IGZpbmRPcGVyYXRvckluZGV4KGJlZ2luICwgZW5kLHRva2VucywgZ2V0TWF0aEpheE9wZXJhdG9yc0J5UHJpb3JpdHkoaSx0cnVlKSk7XHJcbiAgICAgICAgaWYocHJpb3JpdHkhPT1udWxsKWJyZWFrO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHtzdGFydDogYmVnaW4sZW5kOiBlbmQsc3BlY2lmaWNPcGVyYXRvckluZGV4OiBwcmlvcml0eX1cclxufVxyXG5cclxuZXhwb3J0IGNsYXNzIE1hdGhQcmFpc2Vye1xyXG4gICAgaW5wdXQ9XCJcIjtcclxuICAgIHRva2VuczogTWF0aEdyb3VwO1xyXG4gICAgc29sdXRpb246IGFueTtcclxuICAgIG1hdGhJbmZvPW5ldyBNYXRoSW5mbygpO1xyXG4gICAgY29uc3RydWN0b3IoaW5wdXQ6IHN0cmluZyl7XHJcbiAgICAgICAgdGhpcy5pbnB1dD1pbnB1dDtcclxuICAgICAgICB0aGlzLnByb2Nlc3NJbnB1dCgpO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHRva2Vucz1uZXcgQmFzaWNNYXRoSmF4VG9rZW5zKCk7XHJcbiAgICAgICAgdG9rZW5zLmFkZElucHV0KHRoaXMuaW5wdXQpXHJcbiAgICAgICAgY29uc3QgYmFzaWNUb2tlbnM9dG9rZW5zLnRva2Vuc1xyXG4gICAgICAgIFxyXG4gICAgICAgIHRoaXMuY29udmVydEJhc2ljTWF0aEpheFRva2VuYVRvTWF0aEdyb3VwKGJhc2ljVG9rZW5zKVxyXG4gICAgICAgIHRoaXMuYWRkRGVidWdJbmZvKFwiY29udmVydEJhc2ljTWF0aEpheFRva2VuYVRvTWF0aEdyb3VwXCIsdGhpcy50b2tlbnMpXHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5pbnB1dD10aGlzLnRva2Vucy50b1N0cmluZygpXHJcbiAgICAgICAgdGhpcy5jb250cm9sbGVyKCk7XHJcbiAgICAgICAgdGhpcy5zb2x1dGlvbj10aGlzLnRva2Vuc1xyXG4gICAgICAgIHRoaXMuYWRkRGVidWdJbmZvKFwic29sdXRpb25cIix0aGlzLnNvbHV0aW9uKTtcclxuICAgIH1cclxuXHJcbiAgICBcclxuICAgIHBhcnNlKHRva2VuczogTWF0aEdyb3VwKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3Qgb3BlcmF0b3JJbmRleD10b2tlbnMuZ2V0SXRlbXMoKS5maW5kSW5kZXgoXHJcbiAgICAgICAgICAgIHQgPT4gdCBpbnN0YW5jZW9mIE1hdGhKYXhPcGVyYXRvciAmJiB0LmlzT3BlcmFibGVcclxuICAgICAgICApIDtcclxuICAgICAgICBpZiAob3BlcmF0b3JJbmRleDwwKSByZXR1cm47XHJcbiAgICAgICAgY29uc3Qgb3BlcmF0b3IgPSB0b2tlbnMuZ2V0SXRlbXMoKVtvcGVyYXRvckluZGV4XSBhcyBNYXRoSmF4T3BlcmF0b3JcclxuICAgIFxyXG4gICAgICAgIFxyXG4gICAgICAgIG9wZXJhdG9yLmdyb3Vwcy5mb3JFYWNoKGdyb3VwID0+IHtcclxuICAgICAgICAgICAgdGhpcy5wYXJzZShncm91cCk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgcGFyc2VPcGVyYXRvcihvcGVyYXRvcilcclxuICAgICAgICBpZiAoIW9wZXJhdG9yLnNvbHV0aW9uKSB7XHJcbiAgICAgICAgICAgIG9wZXJhdG9yLmlzT3BlcmFibGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm1hdGhJbmZvLmFkZE1hdGhTbmFwc2hvdCh0aGlzLnRva2Vucy5jbG9uZSgpKVxyXG4gICAgICAgIHRva2Vucy5zZXRJdGVtKG9wZXJhdG9yLnNvbHV0aW9uLG9wZXJhdG9ySW5kZXgpOyBcclxuICAgIH1cclxuICAgIFxyXG4gICAgY29udHJvbGxlcigpOiBhbnl7XHJcbiAgICAgICAgdGhpcy5wYXJzZSh0aGlzLnRva2VucylcclxuICAgICAgICBjb21iaW5lU2ltaWxhclZhbHVlcyh0aGlzLnRva2VucylcclxuICAgICAgICB0aGlzLnRva2Vucy5yZW1vdmVOZXN0ZWQoKVxyXG4gICAgICAgIHRoaXMudG9rZW5zLmNvbWJpbmVTaW1pbGFyVmFsdWVzKClcclxuXHJcbiAgICB9XHJcbiAgICBzb2x1dGlvblRvU3RyaW5nKCl7XHJcbiAgICAgICAgcmV0dXJuICh0aGlzLnRva2Vucy50b1N0cmluZygpKXx8XCJcIlxyXG4gICAgfVxyXG5cclxuICAgIGFkZERlYnVnSW5mbyhtZXM6IHN0cmluZyx2YWx1ZTogYW55KXtcclxuICAgICAgICB0aGlzLm1hdGhJbmZvLmFkZERlYnVnSW5mbyhtZXMsdmFsdWUpXHJcbiAgICB9XHJcbiAgICBwcm9jZXNzSW5wdXQoKXtcclxuICAgICAgICB0aGlzLmlucHV0PXRoaXMuaW5wdXRcclxuICAgICAgICAucmVwbGFjZSgvKE1hdGgufFxcXFx8XFxzfGxlZnR8cmlnaHQpL2csIFwiXCIpIFxyXG4gICAgICAgIC5yZXBsYWNlKC97L2csIFwiKFwiKVxyXG4gICAgICAgIC5yZXBsYWNlKC99L2csIFwiKVwiKVxyXG4gICAgICAgIC8vLnJlcGxhY2UoLyg/PCFcXFxcfFthLXpBLVpdKSh0YW58c2lufGNvc3xiaW5vbXxmcmFjfGFzaW58YWNvc3xhdGFufGFyY2Nvc3xhcmNzaW58YXJjdGFufGNkb3QpL2csIFwiXFxcXCQxXCIpO1xyXG4gICAgfVxyXG4gICAgZmluYWxSZXR1cm4oKXtcclxuICAgICAgIC8vIHJldHVybiB0aGlzLnRva2Vucy5yZWNvbnN0cnVjdCgpXHJcbiAgICB9XHJcbiAgICBkZWZpbmVHcm91cHNBbmRPcGVyYXRvcnModG9rZW5zOiBBcnJheTxhbnk+KTpib29sZWFufHRoaXN7XHJcbiAgICAgICAgY29uc3QgcmFuZ2U9b3BlcmF0aW9uc09yZGVyKHRva2Vucyk7XHJcbiAgICAgICAgaWYocmFuZ2Uuc3RhcnQ9PT1udWxsfHxyYW5nZS5lbmQ9PT1udWxsKXJldHVybiBmYWxzZTtcclxuICAgICAgICBpZihyYW5nZS5zcGVjaWZpY09wZXJhdG9ySW5kZXg9PT1udWxsJiZyYW5nZS5zdGFydD09PTAmJnJhbmdlLmVuZD09PXRva2Vucy5sZW5ndGgpcmV0dXJuIHRydWU7XHJcbiAgICAgICAgbGV0IG5ld01hdGhHcm91cFN1Y2Nlc3M9bnVsbFxyXG4gICAgICAgIGlmIChyYW5nZS5zcGVjaWZpY09wZXJhdG9ySW5kZXghPT1udWxsKVxyXG4gICAgICAgICAgICBuZXdNYXRoR3JvdXBTdWNjZXNzPXRoaXMuY3JlYXRlT3BlcmF0b3JJdGVtRnJvbVRva2Vucyh0b2tlbnMscmFuZ2Uuc3BlY2lmaWNPcGVyYXRvckluZGV4KVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICBuZXdNYXRoR3JvdXBTdWNjZXNzPXRoaXMuY3JlYXRlTWF0aEdyb3VwSW5zZXJ0RnJvbVRva2Vucyh0b2tlbnMscmFuZ2Uuc3RhcnQscmFuZ2UuZW5kKVxyXG4gICAgICAgIGlmKCFuZXdNYXRoR3JvdXBTdWNjZXNzKXJldHVybiBmYWxzZTtcclxuICAgICAgICByZXR1cm4gdGhpcy5kZWZpbmVHcm91cHNBbmRPcGVyYXRvcnModG9rZW5zKTtcclxuICAgIH1cclxuICAgIGNvbnZlcnRCYXNpY01hdGhKYXhUb2tlbmFUb01hdGhHcm91cChiYXNpY1Rva2VuczogQXJyYXk8QmFzaWNNYXRoSmF4VG9rZW58UGFyZW4+KTp2b2lke1xyXG4gICAgICAgIGNvbnN0IHN1Y2Nlc3M9dGhpcy5kZWZpbmVHcm91cHNBbmRPcGVyYXRvcnMoYmFzaWNUb2tlbnMpXHJcbiAgICAgICAgaWYoIXN1Y2Nlc3MpcmV0dXJuXHJcbiAgICAgICAgdGhpcy50b2tlbnM9bmV3IE1hdGhHcm91cChlbnN1cmVBY2NlcHRhYmxlRm9ybWF0Rm9yTWF0aEdyb3VwSXRlbXMoYmFzaWNUb2tlbnMpKVxyXG4gICAgfVxyXG4gICAgY3JlYXRlTWF0aEdyb3VwSW5zZXJ0RnJvbVRva2Vucyh0b2tlbnM6IEFycmF5PGFueT4sc3RhcnQ6IG51bWJlcixlbmQ6IG51bWJlcik6Ym9vbGVhbntcclxuICAgICAgICBjb25zdCBuZXdNYXRoR3JvdXA9bmV3IE1hdGhHcm91cChlbnN1cmVBY2NlcHRhYmxlRm9ybWF0Rm9yTWF0aEdyb3VwSXRlbXModG9rZW5zLnNsaWNlKHN0YXJ0LGVuZCsxKSkpO1xyXG4gICAgICAgIHRva2Vucy5zcGxpY2Uoc3RhcnQsKGVuZC1zdGFydCkrMSxuZXdNYXRoR3JvdXApO1xyXG4gICAgICAgIHJldHVybiB0cnVlXHJcbiAgICB9XHJcbiAgICBjcmVhdGVPcGVyYXRvckl0ZW1Gcm9tVG9rZW5zKHRva2VuczogQXJyYXk8YW55PixpbmRleDogbnVtYmVyKTpib29sZWFue1xyXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gc2VhcmNoTWF0aEpheE9wZXJhdG9ycyh0b2tlbnNbaW5kZXhdLnZhbHVlKTtcclxuICAgICAgICBpZighbWV0YWRhdGEpdGhyb3cgbmV3IEVycm9yKGBPcGVyYXRvciAke3Rva2Vuc1tpbmRleF0udmFsdWV9IG5vdCBmb3VuZCBpbiBtZXRhZGF0YWApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uPW5ldyBQb3NpdGlvbih0b2tlbnMsaW5kZXgpXHJcbiAgICAgICAgY29uc3QgYz1kZWVwQ2xvbmUodG9rZW5zKVxyXG4gICAgICAgIGNvbnN0IG5ld09wZXJhdG9yPW5ldyBNYXRoSmF4T3BlcmF0b3IocG9zaXRpb24ub3BlcmF0b3IsbWV0YWRhdGEuYXNzb2NpYXRpdml0eS5udW1Qb3NpdGlvbnMscG9zaXRpb24uZ3JvdXBzLClcclxuICAgICAgICB0b2tlbnMuc3BsaWNlKHBvc2l0aW9uLnN0YXJ0LChwb3NpdGlvbi5lbmQtcG9zaXRpb24uc3RhcnQpKzEsbmV3T3BlcmF0b3IpO1xyXG4gICAgICAgIHJldHVybiB0cnVlXHJcbiAgICB9XHJcbn1cclxuZnVuY3Rpb24gZGVlcENsb25lKGl0ZW1zOiBhbnlbXSkge1xyXG4gICAgbGV0IGNsb25lOiBhbnlbXSA9IFtdO1xyXG4gICAgaXRlbXMuZm9yRWFjaChpdGVtID0+IHtcclxuICAgICAgICBjbG9uZS5wdXNoKGl0ZW0gaW5zdGFuY2VvZiBBcnJheSA/IGRlZXBDbG9uZShpdGVtKSA6IGl0ZW0uY2xvbmUoKSk7XHJcbiAgICB9KTtcclxuICAgIHJldHVybiBjbG9uZTtcclxufVxyXG5cclxuZnVuY3Rpb24gY29tYmluZVNpbWlsYXJWYWx1ZXMobWF0aDogTWF0aEdyb3VwKXtcclxuICAgIFxyXG4gICAgY29uc3Qgb3A9bWF0aC5nZXRJdGVtcygpLmZpbmQodD0+dCBpbnN0YW5jZW9mIE1hdGhKYXhPcGVyYXRvcilcclxuICAgIGlmKCFvcClyZXR1cm5cclxuICAgIC8qY29uc3QgYT1uZXcgTWF0aE92ZXJ2aWV3KClcclxuICAgIGEuZGVmaW5lR2xvYmFsT3ZlcnZpZXcobWF0aC5nZXRJdGVtcygpKVxyXG4gICAgYS5zZXBhcmF0ZUludG9JbmRpdmlkdWFscygpKi9cclxuXHJcbn1cclxuXHJcblxyXG5jbGFzcyBtYXRoVmFyaWFibGVze1xyXG5cclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmxhdHRlbkFycmF5KGFycjogYW55KSB7XHJcbiAgICBsZXQgcmVzdWx0ID0gW107XHJcbiAgICBsZXQgc3RhY2sgPSBBcnJheS5pc0FycmF5KGFycikgPyBbLi4uYXJyXSA6IFthcnJdO1xyXG5cclxuICAgIHdoaWxlIChzdGFjay5sZW5ndGgpIHtcclxuICAgICAgICBjb25zdCBuZXh0ID0gc3RhY2sucG9wKCk7XHJcbiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobmV4dCkpIHtcclxuICAgICAgICAgICAgc3RhY2sucHVzaCguLi5uZXh0KTsgXHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgcmVzdWx0LnB1c2gobmV4dCk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgcmV0dXJuIHJlc3VsdC5yZXZlcnNlKCk7XHJcbn1cclxuIl19