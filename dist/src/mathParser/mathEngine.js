import { degreesToRadians } from "./mathUtilities";
import { findParenIndex, Paren, findDeepestParenthesesScope } from "../utils/ParenUtensils";
import { getMathJaxOperatorsByPriority, getValuesWithKeysBySide, mahtjaxAssociativitymetadata, searchMathJaxOperators } from "../staticData/dataManager";
import { MathGroup, MathJaxOperator, Token, ensureAcceptableFormatForMathGroupItems, deepSearchWithPath, stringToBasicMathJaxTokens } from "./mathJaxTokens";
const greekLetters = [
    'Alpha', 'alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta',
    'Iota', 'Kappa', 'Lambda', 'Mu', 'mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho',
    'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'
];
/*const latexOperators=[
    'tan', 'sin', 'cos', 'binom', 'frac', 'asin', 'acos',
    'atan', 'arccos', 'arcsin', 'arctan', 'cdot','sqrt'
]*/
export function findConsecutiveSequences(arr) {
    const sequences = [];
    let start = 0;
    for (let i = 1; i <= arr.length; i++) {
        if (arr[i] !== arr[i - 1] + 1) {
            if (i - start > 1) {
                sequences.push(arr.slice(start, i));
            }
            start = i;
        }
    }
    return sequences;
}
export class MathInfo {
    constructor() {
        this.debugInfo = "";
        this.solutionInfo = [];
        this.mathInfo = [];
        this.graph = "";
        this.mathSnapshots = [];
    }
    addGraphInfo(value) {
        this.graph += value;
    }
    addDebugInfo(msg, value) {
        this.debugInfo += (typeof msg === "object" ? JSON.stringify(msg, null, 1) : msg) + " : " + (typeof value === "object" ? JSON.stringify(value, null, 1) : value) + "\n ";
    }
    addSolutionInfo(mes) {
        this.solutionInfo.push(mes);
        this.addDebugInfo("Solved", mes);
    }
    addMathInfo(msg) {
        this.mathInfo.push(msg);
    }
    addMathSnapshot(math) {
        this.mathSnapshots.push(math);
        const result = deepSearchWithPath(math, (item) => item instanceof MathJaxOperator && item.solution !== undefined);
        if (!result)
            return;
        const customFormatter = (check, string) => {
            if (check instanceof MathJaxOperator && check.solution !== undefined) {
                return `{\\color{red}${string}}`;
            }
            return string;
        };
        this.mathInfo.push(math.toString(customFormatter));
        this.solutionInfo.push(result.item.toStringSolution());
    }
}
function rearrangeEquation(tokens, tokenToisolate) {
}
function isolateMultiplication(tokens, isolatToken) {
}
export class Position {
    constructor(tokens, index) {
        this.index = index;
        this.transition = this.index;
        this.start = this.index;
        this.end = this.index;
        this.position(tokens);
    }
    position(tokens) {
        this.operator = tokens[this.index].value;
        const metadata = searchMathJaxOperators(this.operator);
        if (!metadata)
            throw new Error(`Operator ${this.operator} not found in metadata`);
        const beforeIndex = [];
        const afterIndex = [];
        getValuesWithKeysBySide(mahtjaxAssociativitymetadata(metadata).positions, true).forEach(() => {
            const item = this.applyPosition(tokens, this.start, true);
            beforeIndex.push(item.mathGroup);
            this.start = item.lastItemOfPrevious;
        });
        getValuesWithKeysBySide(mahtjaxAssociativitymetadata(metadata).positions, false).forEach(() => {
            const item = this.applyPosition(tokens, this.end, false);
            afterIndex.push(item.mathGroup);
            this.end = item.lastItemOfPrevious;
        });
        this.groups = beforeIndex.reverse().concat(afterIndex);
    }
    applyPosition(tokens, index, isLeft) {
        let breakChar = index;
        let target;
        const modifiedIndex = index + (isLeft ? -1 : 1);
        if ((isLeft && index <= 0) || (!isLeft && index >= tokens.length - 1) || !tokens[modifiedIndex]) {
            throw new Error("at applyPosition: \"index wasn't valid\" index: " + index);
        }
        if (tokens[modifiedIndex] instanceof Paren) {
            const parenIndex = findParenIndex(tokens[modifiedIndex], tokens);
            breakChar = isLeft ? parenIndex.open : parenIndex.close + 1;
            // Insure proper formatting removed everything including parentheses
            target = ensureAcceptableFormatForMathGroupItems(tokens.slice(parenIndex.open, parenIndex.close + 1));
        }
        else {
            breakChar = modifiedIndex;
            target = ensureAcceptableFormatForMathGroupItems(tokens[breakChar]);
        }
        if ((target === null || target === void 0 ? void 0 : target.length) === 0) {
            throw new Error(`at applyPosition: couldn't find target token for direction ${isLeft ? 'left' : 'right'} and operator"${tokens[index].value}"`);
        }
        return {
            mathGroup: new MathGroup(target),
            lastItemOfPrevious: breakChar,
        };
    }
}
function parseSafetyChecks(operator) {
    if ((operator.commutative && operator.groups.length < operator.groupNum) || (!operator.commutative && operator.groups.length !== operator.groupNum)) {
        throw new Error(`Invalid number of groups for operator ${operator.operator} expected ${operator.groupNum} but got ${operator.groups.length}`);
    }
}
export function parseOperator(operator) {
    parseSafetyChecks(operator);
    function getOperableValue(group) {
        if (!group || !group.isOperable())
            return null;
        return group.getOperableValue();
    }
    const group1 = getOperableValue(operator.groups[0]);
    const group2 = getOperableValue(operator.groups[1]);
    if (group1 === null || (group2 === null && operator.groups.length > 1))
        return false;
    switch (operator.operator) {
        case "Sine":
            operator.solution = new MathGroup([new Token(Math.sin(degreesToRadians(group1)))]);
            break;
        case "SquareRoot":
            if (group1 < 0) {
                throw new Error("Cannot calculate the square root of a negative number.");
            }
            operator.solution = new MathGroup([new Token(Math.pow(group1, 0.5))]);
            break;
        case "Fraction": {
            if (group2 === 0) {
                throw new Error("Division by zero is not allowed");
            }
            operator.solution = new MathGroup([new Token(group1 / group2)]);
            break;
        }
        case "Power": {
            operator.solution = new MathGroup([new Token(Math.pow(group1, group2))]);
            break;
        }
        default:
            throw new Error(`Unknown operator type in parseOperator: ${operator.operator}`);
    }
    return true;
}
function basicMathJaxTokensToMathGroup(basicTokens) {
    const defineGroupsAndOperators = (tokens) => {
        const range = operationsOrder(tokens);
        if (range.start === null || range.end === null)
            return false;
        if (range.specificOperatorIndex === null && range.start === 0 && range.end === tokens.length)
            return true;
        let newMathGroupSuccess = null;
        if (range.specificOperatorIndex !== null)
            newMathGroupSuccess = createOperatorItemFromTokens(tokens, range.specificOperatorIndex);
        else
            newMathGroupSuccess = createMathGroupInsertFromTokens(tokens, range.start, range.end);
        if (!newMathGroupSuccess)
            return false;
        return defineGroupsAndOperators(tokens);
    };
    const createMathGroupInsertFromTokens = (tokens, start, end) => {
        const newMathGroup = new MathGroup(ensureAcceptableFormatForMathGroupItems(tokens.slice(start, end + 1)));
        tokens.splice(start, (end - start) + 1, newMathGroup);
        return true;
    };
    const createOperatorItemFromTokens = (tokens, index) => {
        const metadata = searchMathJaxOperators(tokens[index].value);
        if (!metadata)
            throw new Error(`Operator ${tokens[index].value} not found in metadata`);
        const position = new Position(tokens, index);
        const newOperator = MathJaxOperator.create(position.operator, mahtjaxAssociativitymetadata(metadata).numPositions, position.groups);
        tokens.splice(position.start, (position.end - position.start) + 1, newOperator);
        return true;
    };
    const success = defineGroupsAndOperators(basicTokens);
    if (!success)
        return;
    const GroupedBasicTokens = basicTokens.filter((t) => !(t instanceof Paren));
    return new MathGroup(GroupedBasicTokens);
}
function stringToMathGroup(string) {
    const basicTokens = stringToBasicMathJaxTokens(string);
    const mathGroup = basicMathJaxTokensToMathGroup(basicTokens);
    return mathGroup;
}
function operationsOrder(tokens) {
    function findOperatorIndex(begin, end, tokens, regex) {
        const index = tokens.slice(begin, end).findIndex((token) => token.type === "operator" && regex.test(token.value));
        return index > -1 ? index + begin : null;
    }
    const { begin, end } = findDeepestParenthesesScope(tokens);
    let priority = null;
    for (let i = 1; i <= 6; i++) {
        priority = findOperatorIndex(begin, end, tokens, getMathJaxOperatorsByPriority(i, true));
        if (priority !== null)
            break;
    }
    return { start: begin, end: end, specificOperatorIndex: priority };
}
export class MathPraiser {
    constructor(input, mathGroup, solution, mathInfo) {
        this.input = "";
        this.mathInfo = new MathInfo();
        if (input)
            this.input = input;
        if (mathGroup)
            this.mathGroup = mathGroup;
        if (solution)
            this.solution = solution;
        if (mathInfo)
            this.mathInfo = mathInfo;
    }
    setInput(input) {
        this.input = input;
        this.processInput();
        console.log(this.input);
        const mathGroup = stringToMathGroup(this.input);
        if (!mathGroup)
            throw new Error("Invalid input");
        this.mathGroup = mathGroup;
        console.log('this.mathGroup', this.mathGroup.toString(), this.mathGroup);
    }
    toStringLatex() { return this.mathGroup.toStringLatex(); }
    addSolution() {
        this.input = this.mathGroup.toString();
        this.controller();
        this.solution = this.mathGroup;
        this.addDebugInfo("solution", this.solution);
    }
    getMathGroup() { return this.mathGroup; }
    parse(tokens) {
        const operatorIndex = tokens.getItems().findIndex(t => t instanceof MathJaxOperator && t.isOperable);
        if (operatorIndex < 0)
            return;
        const operator = tokens.getItems()[operatorIndex];
        operator.groups.forEach(group => {
            this.parse(group);
        });
        operator.parseMathjaxOperator();
        if (!operator.solution) {
            operator.isOperable = false;
            return;
        }
        this.mathInfo.addMathSnapshot(this.mathGroup.clone());
        tokens.replaceItemCell(operator.solution, operatorIndex);
    }
    controller() {
        this.parse(this.mathGroup);
        combineSimilarValues(this.mathGroup);
        this.mathGroup.combiningLikeTerms();
    }
    solutionToString() {
        return (this.mathGroup.toString()) || "";
    }
    addDebugInfo(mes, value) {
        this.mathInfo.addDebugInfo(mes, value);
    }
    processInput() {
        this.input = this.input
            .replace(/(Math.|\\|\s|left|right)/g, "")
            .replace(/{/g, "(")
            .replace(/}/g, ")");
        //.replace(/(?<!\\|[a-zA-Z])(tan|sin|cos|binom|frac|asin|acos|atan|arccos|arcsin|arctan|cdot)/g, "\\$1");
    }
    finalReturn() {
        // return this.tokens.reconstruct()
    }
}
function deepClone(items) {
    let clone = [];
    items.forEach(item => {
        clone.push(item instanceof Array ? deepClone(item) : item.clone());
    });
    return clone;
}
function combineSimilarValues(math) {
    const op = math.getItems().find(t => t instanceof MathJaxOperator);
    if (!op)
        return;
    /*const a=new MathOverview()
    a.defineGlobalOverview(math.getItems())
    a.separateIntoIndividuals()*/
}
class mathVariables {
}
export function flattenArray(arr) {
    let result = [];
    let stack = Array.isArray(arr) ? [...arr] : [arr];
    while (stack.length) {
        const next = stack.pop();
        if (Array.isArray(next)) {
            stack.push(...next);
        }
        else {
            result.push(next);
        }
    }
    return result.reverse();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aEVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYXRoUGFyc2VyL21hdGhFbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUF1QyxnQkFBZ0IsRUFBc0MsTUFBTSxpQkFBaUIsQ0FBQztBQUU1SCxPQUFPLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBZ0IsMkJBQTJCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMxRyxPQUFPLEVBQTJCLDZCQUE2QixFQUErQix1QkFBdUIsRUFBMEQsNEJBQTRCLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN2USxPQUFPLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsdUNBQXVDLEVBQUUsa0JBQWtCLEVBQWlCLDBCQUEwQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFNUssTUFBTSxZQUFZLEdBQUc7SUFDakIsT0FBTyxFQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPO0lBQzVFLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUs7SUFDeEUsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTztDQUMxRCxDQUFDO0FBQ0Y7OztHQUdHO0FBRUgsTUFBTSxVQUFVLHdCQUF3QixDQUFDLEdBQVU7SUFDL0MsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztJQUNkLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxF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QUFDLEVBQUUsQ0FBQztZQUN0QixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDeEIsQ0FBQzthQUFNLENBQUM7WUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLENBQUM7SUFDTCxDQUFDO0lBQ0QsT0FBTyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyBxdWFkLGNhbGN1bGF0ZUJpbm9tLHJvdW5kQnlTZXR0aW5ncyAsZGVncmVlc1RvUmFkaWFucyxyYWRpYW5zVG9EZWdyZWVzLCBjYWxjdWxhdGVGYWN0b3JpYWx9IGZyb20gXCIuL21hdGhVdGlsaXRpZXNcIjtcclxuXHJcbmltcG9ydCB7IGZpbmRQYXJlbkluZGV4LCBQYXJlbixpZFBhcmVudGhlc2VzLCBmaW5kRGVlcGVzdFBhcmVudGhlc2VzU2NvcGUgfSBmcm9tIFwiLi4vdXRpbHMvUGFyZW5VdGVuc2lsc1wiO1xyXG5pbXBvcnQgeyBnZXRBbGxNYXRoSmF4UmVmZXJlbmNlcywgZ2V0TWF0aEpheE9wZXJhdG9yc0J5UHJpb3JpdHksIGdldE9wZXJhdG9yc0J5QXNzb2NpYXRpdml0eSwgZ2V0VmFsdWVzV2l0aEtleXNCeVNpZGUsIGhhc0ltcGxpY2l0TXVsdGlwbGljYXRpb24sIGlzT3BlcmF0b3JXaXRoQXNzb2NpYXRpdml0eSwgbWFodGpheEFzc29jaWF0aXZpdHltZXRhZGF0YSwgc2VhcmNoTWF0aEpheE9wZXJhdG9ycyB9IGZyb20gXCIuLi9zdGF0aWNEYXRhL2RhdGFNYW5hZ2VyXCI7XHJcbmltcG9ydCB7IE1hdGhHcm91cCwgTWF0aEpheE9wZXJhdG9yLCBUb2tlbiwgZW5zdXJlQWNjZXB0YWJsZUZvcm1hdEZvck1hdGhHcm91cEl0ZW1zLCBkZWVwU2VhcmNoV2l0aFBhdGgsIE1hdGhHcm91cEl0ZW0sIHN0cmluZ1RvQmFzaWNNYXRoSmF4VG9rZW5zIH0gZnJvbSBcIi4vbWF0aEpheFRva2Vuc1wiO1xyXG5pbXBvcnQgeyBCYXNpY01hdGhKYXhUb2tlbiB9IGZyb20gXCJzcmMvbWF0aFBhcnNlci9iYXNpY1Rva2VuXCI7XHJcbmNvbnN0IGdyZWVrTGV0dGVycyA9IFtcclxuICAgICdBbHBoYScsJ2FscGhhJywgJ0JldGEnLCAnR2FtbWEnLCAnRGVsdGEnLCAnRXBzaWxvbicsICdaZXRhJywgJ0V0YScsICdUaGV0YScsIFxyXG4gICAgJ0lvdGEnLCAnS2FwcGEnLCAnTGFtYmRhJywgJ011JywnbXUnLCAnTnUnLCAnWGknLCAnT21pY3JvbicsICdQaScsICdSaG8nLCBcclxuICAgICdTaWdtYScsICdUYXUnLCAnVXBzaWxvbicsICdQaGknLCAnQ2hpJywgJ1BzaScsICdPbWVnYSdcclxuXTtcclxuLypjb25zdCBsYXRleE9wZXJhdG9ycz1bXHJcbiAgICAndGFuJywgJ3NpbicsICdjb3MnLCAnYmlub20nLCAnZnJhYycsICdhc2luJywgJ2Fjb3MnLCBcclxuICAgICdhdGFuJywgJ2FyY2NvcycsICdhcmNzaW4nLCAnYXJjdGFuJywgJ2Nkb3QnLCdzcXJ0J1xyXG5dKi9cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kQ29uc2VjdXRpdmVTZXF1ZW5jZXMoYXJyOiBhbnlbXSkge1xyXG4gICAgY29uc3Qgc2VxdWVuY2VzID0gW107XHJcbiAgICBsZXQgc3RhcnQgPSAwO1xyXG4gICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gYXJyLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKGFycltpXSAhPT0gYXJyW2kgLSAxXSArIDEpIHtcclxuICAgICAgICAgICAgaWYgKGkgLSBzdGFydCA+IDEpIHtcclxuICAgICAgICAgICAgICAgIHNlcXVlbmNlcy5wdXNoKGFyci5zbGljZShzdGFydCwgaSkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHN0YXJ0ID0gaTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc2VxdWVuY2VzO1xyXG59XHJcblxyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBNYXRoSW5mb3tcclxuICAgIGRlYnVnSW5mbzogc3RyaW5nPVwiXCI7XHJcbiAgICBzb2x1dGlvbkluZm86IGFueVtdPVtdO1xyXG4gICAgbWF0aEluZm86IGFueVtdPVtdXHJcbiAgICBncmFwaDogc3RyaW5nPVwiXCI7XHJcbiAgICBtYXRoU25hcHNob3RzOiBNYXRoR3JvdXBbXT1bXVxyXG4gICAgYWRkR3JhcGhJbmZvKHZhbHVlOiBzdHJpbmcpe1xyXG4gICAgICAgIHRoaXMuZ3JhcGgrPXZhbHVlO1xyXG4gICAgfVxyXG4gICAgYWRkRGVidWdJbmZvKG1zZzogc3RyaW5nLCB2YWx1ZTogYW55KXtcclxuICAgICAgICB0aGlzLmRlYnVnSW5mbys9KHR5cGVvZiBtc2c9PT1cIm9iamVjdFwiP0pTT04uc3RyaW5naWZ5KG1zZyxudWxsLDEpOm1zZykrXCIgOiBcIisodHlwZW9mIHZhbHVlPT09XCJvYmplY3RcIj9KU09OLnN0cmluZ2lmeSh2YWx1ZSxudWxsLDEpOnZhbHVlKSsgXCJcXG4gXCI7XHJcbiAgICB9XHJcbiAgICBhZGRTb2x1dGlvbkluZm8obWVzOiBzdHJpbmcpe1xyXG4gICAgICAgIHRoaXMuc29sdXRpb25JbmZvLnB1c2gobWVzKTtcclxuICAgICAgICB0aGlzLmFkZERlYnVnSW5mbyhcIlNvbHZlZFwiLG1lcyk7XHJcbiAgICB9XHJcbiAgICBhZGRNYXRoSW5mbyhtc2c6IHN0cmluZyl7XHJcbiAgICAgICAgdGhpcy5tYXRoSW5mby5wdXNoKG1zZylcclxuICAgIH1cclxuICAgIGFkZE1hdGhTbmFwc2hvdChtYXRoOiBNYXRoR3JvdXApe1xyXG4gICAgICAgIHRoaXMubWF0aFNuYXBzaG90cy5wdXNoKG1hdGgpXHJcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gZGVlcFNlYXJjaFdpdGhQYXRoKFxyXG4gICAgICAgICAgICBtYXRoLFxyXG4gICAgICAgICAgICAoaXRlbSkgPT4gaXRlbSBpbnN0YW5jZW9mIE1hdGhKYXhPcGVyYXRvciAmJiBpdGVtLnNvbHV0aW9uICE9PSB1bmRlZmluZWRcclxuICAgICAgICApO1xyXG4gICAgICAgIGlmKCFyZXN1bHQpcmV0dXJuXHJcbiAgICAgICAgXHJcblxyXG4gICAgICAgIGNvbnN0IGN1c3RvbUZvcm1hdHRlciA9IChjaGVjazogYW55LHN0cmluZzogc3RyaW5nKTogc3RyaW5nID0+IHtcclxuICAgICAgICAgICAgaWYgKGNoZWNrIGluc3RhbmNlb2YgTWF0aEpheE9wZXJhdG9yICYmIGNoZWNrLnNvbHV0aW9uICE9PSB1bmRlZmluZWQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBge1xcXFxjb2xvcntyZWR9JHtzdHJpbmd9fWA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHN0cmluZ1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgdGhpcy5tYXRoSW5mby5wdXNoKG1hdGgudG9TdHJpbmcoY3VzdG9tRm9ybWF0dGVyKSlcclxuICAgICAgICB0aGlzLnNvbHV0aW9uSW5mby5wdXNoKHJlc3VsdC5pdGVtLnRvU3RyaW5nU29sdXRpb24oKSlcclxuICAgICAgICBcclxuICAgIH1cclxuXHJcbn1cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5mdW5jdGlvbiByZWFycmFuZ2VFcXVhdGlvbih0b2tlbnM6IGFueSx0b2tlblRvaXNvbGF0ZTogYW55KXtcclxuICAgIFxyXG59XHJcblxyXG5mdW5jdGlvbiBpc29sYXRlTXVsdGlwbGljYXRpb24odG9rZW5zOiBhbnksaXNvbGF0VG9rZW46IFRva2VuKXsvKlxyXG4gICAgY29uc3QgaW5kZXg9b3BlcmF0aW9uc09yZGVyKHRva2VucylcclxuICAgIGNvbnN0IElzb2xhdGVkPXRva2Vucy50b2tlbnMuZmluZCgodG9rZW46IGFueSwgaWR4OiBudW1iZXIpPT5pZHg8aW5kZXgpXHJcbiAgICBjb25zdCBmcmFjPWNyZWF0ZUZyYWModG9rZW5zLmxpc3Quc2xpY2UoaW5kZXggKyAxKSxuZXcgVG9rZW4oSXNvbGF0ZWQudmFsdWUpKVxyXG4gICAgSXNvbGF0ZWQudmFsdWU9MTtcclxuICAgIHRva2Vucy5pbnNlcnRUb2tlbnMoaW5kZXgrMSx0b2tlbnMudG9rZW5zLmxlbmd0aC1pbmRleCsxLGZyYWMpKi9cclxufVxyXG5cclxuXHJcblxyXG5leHBvcnQgY2xhc3MgUG9zaXRpb24ge1xyXG4gICAgb3BlcmF0b3I6IHN0cmluZztcclxuICAgIGluZGV4OiBudW1iZXI7XHJcbiAgICBzdGFydDogbnVtYmVyO1xyXG4gICAgZW5kOiBudW1iZXI7XHJcbiAgICB0cmFuc2l0aW9uOiBudW1iZXI7XHJcbiAgICBzcGVjaWFsQ2hhcjogc3RyaW5nO1xyXG4gICAgXHJcbiAgICBncm91cHM6IE1hdGhHcm91cFtdO1xyXG4gICAgY29uc3RydWN0b3IodG9rZW5zOiBhbnlbXSwgaW5kZXg6IG51bWJlcil7ICBcclxuICAgICAgICB0aGlzLmluZGV4ID0gaW5kZXg7XHJcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uID0gdGhpcy5pbmRleDtcclxuICAgICAgICB0aGlzLnN0YXJ0ID0gdGhpcy5pbmRleDtcclxuICAgICAgICB0aGlzLmVuZCA9IHRoaXMuaW5kZXg7XHJcbiAgICAgICAgdGhpcy5wb3NpdGlvbih0b2tlbnMpXHJcbiAgICB9XHJcblxyXG4gICAgXHJcblxyXG4gICAgcG9zaXRpb24odG9rZW5zOiBhbnlbXSkge1xyXG4gICAgICAgIHRoaXMub3BlcmF0b3IgPSB0b2tlbnNbdGhpcy5pbmRleF0udmFsdWU7XHJcbiAgICAgICAgY29uc3QgbWV0YWRhdGEgPSBzZWFyY2hNYXRoSmF4T3BlcmF0b3JzKHRoaXMub3BlcmF0b3IpO1xyXG4gICAgICAgIGlmICghbWV0YWRhdGEpIHRocm93IG5ldyBFcnJvcihgT3BlcmF0b3IgJHt0aGlzLm9wZXJhdG9yfSBub3QgZm91bmQgaW4gbWV0YWRhdGFgKTtcclxuICAgIFxyXG4gICAgICAgIGNvbnN0IGJlZm9yZUluZGV4OiBNYXRoR3JvdXBbXSA9IFtdO1xyXG4gICAgICAgIGNvbnN0IGFmdGVySW5kZXg6ICBNYXRoR3JvdXBbXSA9IFtdO1xyXG4gICAgXHJcbiAgICAgICAgZ2V0VmFsdWVzV2l0aEtleXNCeVNpZGUobWFodGpheEFzc29jaWF0aXZpdHltZXRhZGF0YShtZXRhZGF0YSkucG9zaXRpb25zLCB0cnVlKS5mb3JFYWNoKCgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuYXBwbHlQb3NpdGlvbih0b2tlbnMsIHRoaXMuc3RhcnQsIHRydWUpO1xyXG4gICAgICAgICAgICBiZWZvcmVJbmRleC5wdXNoKGl0ZW0ubWF0aEdyb3VwKTtcclxuICAgICAgICAgICAgdGhpcy5zdGFydCA9IGl0ZW0ubGFzdEl0ZW1PZlByZXZpb3VzO1xyXG4gICAgICAgIH0pO1xyXG4gICAgXHJcbiAgICBcclxuICAgICAgICBnZXRWYWx1ZXNXaXRoS2V5c0J5U2lkZShtYWh0amF4QXNzb2NpYXRpdml0eW1ldGFkYXRhKG1ldGFkYXRhKS5wb3NpdGlvbnMsIGZhbHNlKS5mb3JFYWNoKCgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuYXBwbHlQb3NpdGlvbih0b2tlbnMsIHRoaXMuZW5kLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIGFmdGVySW5kZXgucHVzaChpdGVtLm1hdGhHcm91cCk7XHJcbiAgICAgICAgICAgIHRoaXMuZW5kID0gaXRlbS5sYXN0SXRlbU9mUHJldmlvdXM7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5ncm91cHMgPSBiZWZvcmVJbmRleC5yZXZlcnNlKCkuY29uY2F0KGFmdGVySW5kZXgpO1xyXG4gICAgfVxyXG4gICAgYXBwbHlQb3NpdGlvbih0b2tlbnM6IGFueVtdLCBpbmRleDogIG51bWJlciwgaXNMZWZ0OiBib29sZWFuKSB7XHJcbiAgICAgICAgbGV0IGJyZWFrQ2hhcj1pbmRleFxyXG4gICAgICAgIGxldCB0YXJnZXQ6IGFueTtcclxuICAgICAgICBjb25zdCBtb2RpZmllZEluZGV4ID0gIGluZGV4Kyhpc0xlZnQ/LSAxIDogIDEpO1xyXG5cclxuICAgICAgICBpZiAoKGlzTGVmdCAmJiBpbmRleCA8PSAwKSB8fCAoIWlzTGVmdCAmJiBpbmRleCA+PSB0b2tlbnMubGVuZ3RoIC0gMSkgfHwgIXRva2Vuc1ttb2RpZmllZEluZGV4XSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJhdCBhcHBseVBvc2l0aW9uOiBcXFwiaW5kZXggd2Fzbid0IHZhbGlkXFxcIiBpbmRleDogXCIraW5kZXgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRva2Vuc1ttb2RpZmllZEluZGV4XSBpbnN0YW5jZW9mIFBhcmVuKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVuSW5kZXggPSBmaW5kUGFyZW5JbmRleCh0b2tlbnNbbW9kaWZpZWRJbmRleF0sdG9rZW5zKTtcclxuICAgICAgICAgICAgYnJlYWtDaGFyID0gIGlzTGVmdCA/IHBhcmVuSW5kZXgub3BlbiA6IHBhcmVuSW5kZXguY2xvc2UrMTtcclxuICAgICAgICAgICAgLy8gSW5zdXJlIHByb3BlciBmb3JtYXR0aW5nIHJlbW92ZWQgZXZlcnl0aGluZyBpbmNsdWRpbmcgcGFyZW50aGVzZXNcclxuICAgICAgICAgICAgdGFyZ2V0ID0gZW5zdXJlQWNjZXB0YWJsZUZvcm1hdEZvck1hdGhHcm91cEl0ZW1zKHRva2Vucy5zbGljZShwYXJlbkluZGV4Lm9wZW4sIHBhcmVuSW5kZXguY2xvc2UrMSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGJyZWFrQ2hhcj1tb2RpZmllZEluZGV4O1xyXG4gICAgICAgICAgICB0YXJnZXQgPSBlbnN1cmVBY2NlcHRhYmxlRm9ybWF0Rm9yTWF0aEdyb3VwSXRlbXModG9rZW5zW2JyZWFrQ2hhcl0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGFyZ2V0Py5sZW5ndGg9PT0wKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgYXQgYXBwbHlQb3NpdGlvbjogY291bGRuJ3QgZmluZCB0YXJnZXQgdG9rZW4gZm9yIGRpcmVjdGlvbiAke2lzTGVmdD8nbGVmdCc6J3JpZ2h0J30gYW5kIG9wZXJhdG9yXCIke3Rva2Vuc1tpbmRleF0udmFsdWV9XCJgLCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBtYXRoR3JvdXA6IG5ldyBNYXRoR3JvdXAodGFyZ2V0KSxcclxuICAgICAgICAgICAgbGFzdEl0ZW1PZlByZXZpb3VzOiBicmVha0NoYXIsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VTYWZldHlDaGVja3Mob3BlcmF0b3I6IE1hdGhKYXhPcGVyYXRvcil7XHJcbiAgICBpZiAoKG9wZXJhdG9yLmNvbW11dGF0aXZlJiZvcGVyYXRvci5ncm91cHMubGVuZ3RoPG9wZXJhdG9yLmdyb3VwTnVtKXx8KCFvcGVyYXRvci5jb21tdXRhdGl2ZSYmb3BlcmF0b3IuZ3JvdXBzLmxlbmd0aCE9PW9wZXJhdG9yLmdyb3VwTnVtKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBudW1iZXIgb2YgZ3JvdXBzIGZvciBvcGVyYXRvciAke29wZXJhdG9yLm9wZXJhdG9yfSBleHBlY3RlZCAke29wZXJhdG9yLmdyb3VwTnVtfSBidXQgZ290ICR7b3BlcmF0b3IuZ3JvdXBzLmxlbmd0aH1gKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlT3BlcmF0b3Iob3BlcmF0b3I6IE1hdGhKYXhPcGVyYXRvcik6IGJvb2xlYW4ge1xyXG4gICAgcGFyc2VTYWZldHlDaGVja3Mob3BlcmF0b3IpOyBcclxuICAgIGZ1bmN0aW9uIGdldE9wZXJhYmxlVmFsdWUoZ3JvdXA6IE1hdGhHcm91cCk6IG51bWJlciB8IG51bGwge1xyXG4gICAgICAgIGlmICghZ3JvdXB8fCFncm91cC5pc09wZXJhYmxlKCkpIHJldHVybiBudWxsO1xyXG4gICAgICAgIHJldHVybiBncm91cC5nZXRPcGVyYWJsZVZhbHVlKCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBncm91cDEgPSBnZXRPcGVyYWJsZVZhbHVlKG9wZXJhdG9yLmdyb3Vwc1swXSk7XHJcbiAgICBjb25zdCBncm91cDIgPSBnZXRPcGVyYWJsZVZhbHVlKG9wZXJhdG9yLmdyb3Vwc1sxXSk7XHJcbiAgICBpZiAoZ3JvdXAxID09PSBudWxsfHwoZ3JvdXAyPT09bnVsbCYmb3BlcmF0b3IuZ3JvdXBzLmxlbmd0aD4xKSkgcmV0dXJuIGZhbHNlO1xyXG4gICAgXHJcbiAgICBzd2l0Y2ggKG9wZXJhdG9yLm9wZXJhdG9yKSB7XHJcbiAgICAgICAgY2FzZSBcIlNpbmVcIjpcclxuICAgICAgICAgICAgb3BlcmF0b3Iuc29sdXRpb24gPSBuZXcgTWF0aEdyb3VwKFtuZXcgVG9rZW4oTWF0aC5zaW4oZGVncmVlc1RvUmFkaWFucyhncm91cDEpKSldKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBcIlNxdWFyZVJvb3RcIjpcclxuICAgICAgICAgICAgaWYgKGdyb3VwMSA8IDApIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBjYWxjdWxhdGUgdGhlIHNxdWFyZSByb290IG9mIGEgbmVnYXRpdmUgbnVtYmVyLlwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcGVyYXRvci5zb2x1dGlvbiA9IG5ldyBNYXRoR3JvdXAoW25ldyBUb2tlbihNYXRoLnBvdyhncm91cDEsMC41KSldKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBcIkZyYWN0aW9uXCI6IHtcclxuICAgICAgICAgICAgaWYgKGdyb3VwMiA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRGl2aXNpb24gYnkgemVybyBpcyBub3QgYWxsb3dlZFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcGVyYXRvci5zb2x1dGlvbiA9IG5ldyBNYXRoR3JvdXAoW25ldyBUb2tlbihncm91cDEgLyBncm91cDIhKV0pO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSBcIlBvd2VyXCI6IHtcclxuICAgICAgICAgICAgb3BlcmF0b3Iuc29sdXRpb24gPSBuZXcgTWF0aEdyb3VwKFtuZXcgVG9rZW4oTWF0aC5wb3coZ3JvdXAxLGdyb3VwMiEpKV0pO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgYFVua25vd24gb3BlcmF0b3IgdHlwZSBpbiBwYXJzZU9wZXJhdG9yOiAke29wZXJhdG9yLm9wZXJhdG9yfWBcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgXHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuXHJcbmZ1bmN0aW9uIGJhc2ljTWF0aEpheFRva2Vuc1RvTWF0aEdyb3VwKGJhc2ljVG9rZW5zOiBBcnJheTxCYXNpY01hdGhKYXhUb2tlbnxQYXJlbj4pOiBNYXRoR3JvdXB8dW5kZWZpbmVke1xyXG4gICAgY29uc3QgZGVmaW5lR3JvdXBzQW5kT3BlcmF0b3JzPSh0b2tlbnM6IEFycmF5PGFueT4pOmJvb2xlYW49PntcclxuICAgICAgICBjb25zdCByYW5nZT1vcGVyYXRpb25zT3JkZXIodG9rZW5zKTtcclxuICAgICAgICBpZihyYW5nZS5zdGFydD09PW51bGx8fHJhbmdlLmVuZD09PW51bGwpcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIGlmKHJhbmdlLnNwZWNpZmljT3BlcmF0b3JJbmRleD09PW51bGwmJnJhbmdlLnN0YXJ0PT09MCYmcmFuZ2UuZW5kPT09dG9rZW5zLmxlbmd0aClyZXR1cm4gdHJ1ZTtcclxuICAgICAgICBsZXQgbmV3TWF0aEdyb3VwU3VjY2Vzcz1udWxsXHJcbiAgICAgICAgaWYgKHJhbmdlLnNwZWNpZmljT3BlcmF0b3JJbmRleCE9PW51bGwpXHJcbiAgICAgICAgICAgIG5ld01hdGhHcm91cFN1Y2Nlc3M9Y3JlYXRlT3BlcmF0b3JJdGVtRnJvbVRva2Vucyh0b2tlbnMscmFuZ2Uuc3BlY2lmaWNPcGVyYXRvckluZGV4KVxyXG4gICAgICAgIGVsc2VcclxuICAgICAgICBuZXdNYXRoR3JvdXBTdWNjZXNzPWNyZWF0ZU1hdGhHcm91cEluc2VydEZyb21Ub2tlbnModG9rZW5zLHJhbmdlLnN0YXJ0LHJhbmdlLmVuZClcclxuICAgICAgICBpZighbmV3TWF0aEdyb3VwU3VjY2VzcylyZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgcmV0dXJuIGRlZmluZUdyb3Vwc0FuZE9wZXJhdG9ycyh0b2tlbnMpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgY3JlYXRlTWF0aEdyb3VwSW5zZXJ0RnJvbVRva2Vucz0odG9rZW5zOiBBcnJheTxhbnk+LHN0YXJ0OiBudW1iZXIsZW5kOiBudW1iZXIpOmJvb2xlYW49PntcclxuICAgICAgICBjb25zdCBuZXdNYXRoR3JvdXA9bmV3IE1hdGhHcm91cChlbnN1cmVBY2NlcHRhYmxlRm9ybWF0Rm9yTWF0aEdyb3VwSXRlbXModG9rZW5zLnNsaWNlKHN0YXJ0LGVuZCsxKSkpO1xyXG4gICAgICAgIHRva2Vucy5zcGxpY2Uoc3RhcnQsKGVuZC1zdGFydCkrMSxuZXdNYXRoR3JvdXApO1xyXG4gICAgICAgIHJldHVybiB0cnVlXHJcbiAgICB9XHJcbiAgICBjb25zdCBjcmVhdGVPcGVyYXRvckl0ZW1Gcm9tVG9rZW5zPSh0b2tlbnM6IEFycmF5PGFueT4saW5kZXg6IG51bWJlcik6Ym9vbGVhbj0+e1xyXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gc2VhcmNoTWF0aEpheE9wZXJhdG9ycyh0b2tlbnNbaW5kZXhdLnZhbHVlKTtcclxuICAgICAgICBpZighbWV0YWRhdGEpdGhyb3cgbmV3IEVycm9yKGBPcGVyYXRvciAke3Rva2Vuc1tpbmRleF0udmFsdWV9IG5vdCBmb3VuZCBpbiBtZXRhZGF0YWApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uPW5ldyBQb3NpdGlvbih0b2tlbnMsaW5kZXgpXHJcbiAgICAgICAgY29uc3QgbmV3T3BlcmF0b3I9TWF0aEpheE9wZXJhdG9yLmNyZWF0ZShwb3NpdGlvbi5vcGVyYXRvcixtYWh0amF4QXNzb2NpYXRpdml0eW1ldGFkYXRhKG1ldGFkYXRhKS5udW1Qb3NpdGlvbnMscG9zaXRpb24uZ3JvdXBzKVxyXG4gICAgICAgIHRva2Vucy5zcGxpY2UocG9zaXRpb24uc3RhcnQsKHBvc2l0aW9uLmVuZC1wb3NpdGlvbi5zdGFydCkrMSxuZXdPcGVyYXRvcik7XHJcbiAgICAgICAgcmV0dXJuIHRydWVcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdWNjZXNzPWRlZmluZUdyb3Vwc0FuZE9wZXJhdG9ycyhiYXNpY1Rva2VucylcclxuICAgIGlmKCFzdWNjZXNzKXJldHVyblxyXG4gICAgY29uc3QgR3JvdXBlZEJhc2ljVG9rZW5zOiBNYXRoR3JvdXBJdGVtW109KGJhc2ljVG9rZW5zLmZpbHRlcigodCkgPT4gISh0IGluc3RhbmNlb2YgUGFyZW4pKWFzIGFueSlcclxuICAgIHJldHVybiBuZXcgTWF0aEdyb3VwKEdyb3VwZWRCYXNpY1Rva2VucylcclxufVxyXG5cclxuZnVuY3Rpb24gc3RyaW5nVG9NYXRoR3JvdXAoc3RyaW5nOiBTdHJpbmcpOk1hdGhHcm91cHx1bmRlZmluZWR7XHJcbiAgICBjb25zdCBiYXNpY1Rva2Vucz1zdHJpbmdUb0Jhc2ljTWF0aEpheFRva2VucyhzdHJpbmcpO1xyXG4gICAgY29uc3QgbWF0aEdyb3VwID0gYmFzaWNNYXRoSmF4VG9rZW5zVG9NYXRoR3JvdXAoYmFzaWNUb2tlbnMpXHJcbiAgICByZXR1cm4gbWF0aEdyb3VwXHJcbn1cclxuXHJcblxyXG5cclxuZnVuY3Rpb24gb3BlcmF0aW9uc09yZGVyKHRva2VuczogYW55W10pIHtcclxuICAgIGZ1bmN0aW9uIGZpbmRPcGVyYXRvckluZGV4KGJlZ2luOiBudW1iZXIsIGVuZDogbnVtYmVyLCB0b2tlbnM6IGFueSwgcmVnZXg/OiBhbnkpIHtcclxuICAgICAgICBjb25zdCBpbmRleD10b2tlbnMuc2xpY2UoYmVnaW4sIGVuZCkuZmluZEluZGV4KCh0b2tlbjogeyB0eXBlOiBzdHJpbmc7IHZhbHVlOiBhbnk7IH0pID0+IHRva2VuLnR5cGUgPT09IFwib3BlcmF0b3JcIiAmJiByZWdleC50ZXN0KHRva2VuLnZhbHVlKSk7XHJcbiAgICAgICAgcmV0dXJuIGluZGV4Pi0xP2luZGV4K2JlZ2luOm51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCB7IGJlZ2luLCBlbmQgfSA9IGZpbmREZWVwZXN0UGFyZW50aGVzZXNTY29wZSh0b2tlbnMpO1xyXG4gICAgbGV0IHByaW9yaXR5PW51bGxcclxuICAgIGZvciAobGV0IGk9MTtpPD02O2krKyl7XHJcbiAgICAgICAgcHJpb3JpdHkgPSBmaW5kT3BlcmF0b3JJbmRleChiZWdpbiAsIGVuZCx0b2tlbnMsIGdldE1hdGhKYXhPcGVyYXRvcnNCeVByaW9yaXR5KGksdHJ1ZSkpO1xyXG4gICAgICAgIGlmKHByaW9yaXR5IT09bnVsbClicmVhaztcclxuICAgIH1cclxuICAgIHJldHVybiB7c3RhcnQ6IGJlZ2luLGVuZDogZW5kLHNwZWNpZmljT3BlcmF0b3JJbmRleDogcHJpb3JpdHl9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBNYXRoUHJhaXNlcntcclxuICAgIHByaXZhdGUgaW5wdXQ9XCJcIjtcclxuICAgIHByaXZhdGUgbWF0aEdyb3VwOiBNYXRoR3JvdXA7XHJcbiAgICBzb2x1dGlvbjogYW55O1xyXG4gICAgbWF0aEluZm89bmV3IE1hdGhJbmZvKCk7XHJcbiAgICBjb25zdHJ1Y3RvcihpbnB1dD86IHN0cmluZyxtYXRoR3JvdXA/OiBNYXRoR3JvdXAsc29sdXRpb24/OiBhbnksbWF0aEluZm8/OiBNYXRoSW5mbyl7XHJcbiAgICAgICAgaWYoaW5wdXQpdGhpcy5pbnB1dD1pbnB1dDtcclxuICAgICAgICBpZihtYXRoR3JvdXApdGhpcy5tYXRoR3JvdXA9bWF0aEdyb3VwO1xyXG4gICAgICAgIGlmKHNvbHV0aW9uKXRoaXMuc29sdXRpb249c29sdXRpb247XHJcbiAgICAgICAgaWYobWF0aEluZm8pdGhpcy5tYXRoSW5mbz1tYXRoSW5mbztcclxuICAgIH1cclxuICAgIHNldElucHV0KGlucHV0OiBzdHJpbmcpe1xyXG4gICAgICAgIHRoaXMuaW5wdXQ9aW5wdXQ7XHJcbiAgICAgICAgdGhpcy5wcm9jZXNzSW5wdXQoKTtcclxuICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmlucHV0KTtcclxuICAgICAgICBjb25zdCBtYXRoR3JvdXA9c3RyaW5nVG9NYXRoR3JvdXAodGhpcy5pbnB1dCk7XHJcbiAgICAgICAgaWYoIW1hdGhHcm91cCl0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGlucHV0XCIpO1xyXG4gICAgICAgIHRoaXMubWF0aEdyb3VwPW1hdGhHcm91cDtcclxuICAgICAgICBjb25zb2xlLmxvZygndGhpcy5tYXRoR3JvdXAnLHRoaXMubWF0aEdyb3VwLnRvU3RyaW5nKCksdGhpcy5tYXRoR3JvdXApO1xyXG4gICAgfVxyXG4gICAgdG9TdHJpbmdMYXRleCgpe3JldHVybiB0aGlzLm1hdGhHcm91cC50b1N0cmluZ0xhdGV4KCl9XHJcbiAgICBhZGRTb2x1dGlvbigpe1xyXG4gICAgICAgIHRoaXMuaW5wdXQ9dGhpcy5tYXRoR3JvdXAudG9TdHJpbmcoKVxyXG4gICAgICAgIHRoaXMuY29udHJvbGxlcigpO1xyXG4gICAgICAgIHRoaXMuc29sdXRpb249dGhpcy5tYXRoR3JvdXBcclxuICAgICAgICB0aGlzLmFkZERlYnVnSW5mbyhcInNvbHV0aW9uXCIsdGhpcy5zb2x1dGlvbik7XHJcbiAgICB9XHJcbiAgICBnZXRNYXRoR3JvdXAoKXtyZXR1cm4gdGhpcy5tYXRoR3JvdXB9XHJcblxyXG4gICAgXHJcbiAgICBwYXJzZSh0b2tlbnM6IE1hdGhHcm91cCk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IG9wZXJhdG9ySW5kZXg9dG9rZW5zLmdldEl0ZW1zKCkuZmluZEluZGV4KFxyXG4gICAgICAgICAgICB0ID0+IHQgaW5zdGFuY2VvZiBNYXRoSmF4T3BlcmF0b3IgJiYgdC5pc09wZXJhYmxlXHJcbiAgICAgICAgKSA7XHJcbiAgICAgICAgaWYgKG9wZXJhdG9ySW5kZXg8MCkgcmV0dXJuO1xyXG4gICAgICAgIGNvbnN0IG9wZXJhdG9yID0gdG9rZW5zLmdldEl0ZW1zKClbb3BlcmF0b3JJbmRleF0gYXMgTWF0aEpheE9wZXJhdG9yXHJcbiAgICBcclxuICAgICAgICBcclxuICAgICAgICBvcGVyYXRvci5ncm91cHMuZm9yRWFjaChncm91cCA9PiB7XHJcbiAgICAgICAgICAgIHRoaXMucGFyc2UoZ3JvdXApO1xyXG4gICAgICAgIH0pO1xyXG4gICAgICAgIG9wZXJhdG9yLnBhcnNlTWF0aGpheE9wZXJhdG9yKClcclxuICAgICAgICBpZiAoIW9wZXJhdG9yLnNvbHV0aW9uKSB7XHJcbiAgICAgICAgICAgIG9wZXJhdG9yLmlzT3BlcmFibGUgPSBmYWxzZTtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLm1hdGhJbmZvLmFkZE1hdGhTbmFwc2hvdCh0aGlzLm1hdGhHcm91cC5jbG9uZSgpKVxyXG4gICAgICAgIHRva2Vucy5yZXBsYWNlSXRlbUNlbGwob3BlcmF0b3Iuc29sdXRpb24sb3BlcmF0b3JJbmRleCk7IFxyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjb250cm9sbGVyKCk6IGFueXtcclxuICAgICAgICB0aGlzLnBhcnNlKHRoaXMubWF0aEdyb3VwKVxyXG4gICAgICAgIGNvbWJpbmVTaW1pbGFyVmFsdWVzKHRoaXMubWF0aEdyb3VwKVxyXG4gICAgICAgIHRoaXMubWF0aEdyb3VwLmNvbWJpbmluZ0xpa2VUZXJtcygpXHJcblxyXG4gICAgfVxyXG4gICAgc29sdXRpb25Ub1N0cmluZygpe1xyXG4gICAgICAgIHJldHVybiAodGhpcy5tYXRoR3JvdXAudG9TdHJpbmcoKSl8fFwiXCJcclxuICAgIH1cclxuXHJcbiAgICBhZGREZWJ1Z0luZm8obWVzOiBzdHJpbmcsdmFsdWU6IGFueSl7XHJcbiAgICAgICAgdGhpcy5tYXRoSW5mby5hZGREZWJ1Z0luZm8obWVzLHZhbHVlKVxyXG4gICAgfVxyXG4gICAgcHJvY2Vzc0lucHV0KCl7XHJcbiAgICAgICAgdGhpcy5pbnB1dD10aGlzLmlucHV0XHJcbiAgICAgICAgLnJlcGxhY2UoLyhNYXRoLnxcXFxcfFxcc3xsZWZ0fHJpZ2h0KS9nLCBcIlwiKSBcclxuICAgICAgICAucmVwbGFjZSgvey9nLCBcIihcIilcclxuICAgICAgICAucmVwbGFjZSgvfS9nLCBcIilcIilcclxuICAgICAgICAvLy5yZXBsYWNlKC8oPzwhXFxcXHxbYS16QS1aXSkodGFufHNpbnxjb3N8Ymlub218ZnJhY3xhc2lufGFjb3N8YXRhbnxhcmNjb3N8YXJjc2lufGFyY3RhbnxjZG90KS9nLCBcIlxcXFwkMVwiKTtcclxuICAgIH1cclxuICAgIGZpbmFsUmV0dXJuKCl7XHJcbiAgICAgICAvLyByZXR1cm4gdGhpcy50b2tlbnMucmVjb25zdHJ1Y3QoKVxyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBkZWVwQ2xvbmUoaXRlbXM6IGFueVtdKSB7XHJcbiAgICBsZXQgY2xvbmU6IGFueVtdID0gW107XHJcbiAgICBpdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xyXG4gICAgICAgIGNsb25lLnB1c2goaXRlbSBpbnN0YW5jZW9mIEFycmF5ID8gZGVlcENsb25lKGl0ZW0pIDogaXRlbS5jbG9uZSgpKTtcclxuICAgIH0pO1xyXG4gICAgcmV0dXJuIGNsb25lO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb21iaW5lU2ltaWxhclZhbHVlcyhtYXRoOiBNYXRoR3JvdXApe1xyXG4gICAgXHJcbiAgICBjb25zdCBvcD1tYXRoLmdldEl0ZW1zKCkuZmluZCh0PT50IGluc3RhbmNlb2YgTWF0aEpheE9wZXJhdG9yKVxyXG4gICAgaWYoIW9wKXJldHVyblxyXG4gICAgLypjb25zdCBhPW5ldyBNYXRoT3ZlcnZpZXcoKVxyXG4gICAgYS5kZWZpbmVHbG9iYWxPdmVydmlldyhtYXRoLmdldEl0ZW1zKCkpXHJcbiAgICBhLnNlcGFyYXRlSW50b0luZGl2aWR1YWxzKCkqL1xyXG5cclxufVxyXG5cclxuXHJcbmNsYXNzIG1hdGhWYXJpYWJsZXN7XHJcblxyXG59XHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmbGF0dGVuQXJyYXkoYXJyOiBhbnkpIHtcclxuICAgIGxldCByZXN1bHQgPSBbXTtcclxuICAgIGxldCBzdGFjayA9IEFycmF5LmlzQXJyYXkoYXJyKSA/IFsuLi5hcnJdIDogW2Fycl07XHJcblxyXG4gICAgd2hpbGUgKHN0YWNrLmxlbmd0aCkge1xyXG4gICAgICAgIGNvbnN0IG5leHQgPSBzdGFjay5wb3AoKTtcclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShuZXh0KSkge1xyXG4gICAgICAgICAgICBzdGFjay5wdXNoKC4uLm5leHQpOyBcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICByZXN1bHQucHVzaChuZXh0KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICByZXR1cm4gcmVzdWx0LnJldmVyc2UoKTtcclxufVxyXG4iXX0=