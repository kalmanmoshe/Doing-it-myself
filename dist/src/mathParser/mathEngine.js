import { degreesToRadians } from "./mathUtilities";
import { findParenIndex, Paren, findDeepestParenthesesScope } from "../utils/ParenUtensils";
import { getMathJaxOperatorsByPriority, getValuesWithKeysBySide, searchMathJaxOperators } from "../staticData/dataManager";
import { MathGroup, MathJaxOperator, Token, ensureAcceptableFormatForMathGroupItems, deepSearchWithPath, stringToBasicMathJaxTokens } from "./mathJaxTokens";
const greekLetters = [
    'Alpha', 'alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta',
    'Iota', 'Kappa', 'Lambda', 'Mu', 'mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho',
    'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'
];
/*const latexOperators=[
    'tan', 'sin', 'cos', 'binom', 'frac', 'asin', 'acos',
    'atan', 'arccos', 'arcsin', 'arctan', 'cdot','sqrt'
]*/
export function findConsecutiveSequences(arr) {
    const sequences = [];
    let start = 0;
    for (let i = 1; i <= arr.length; i++) {
        if (arr[i] !== arr[i - 1] + 1) {
            if (i - start > 1) {
                sequences.push(arr.slice(start, i));
            }
            start = i;
        }
    }
    return sequences;
}
export class MathInfo {
    debugInfo = "";
    solutionInfo = [];
    mathInfo = [];
    graph = "";
    mathSnapshots = [];
    addGraphInfo(value) {
        this.graph += value;
    }
    addDebugInfo(msg, value) {
        this.debugInfo += (typeof msg === "object" ? JSON.stringify(msg, null, 1) : msg) + " : " + (typeof value === "object" ? JSON.stringify(value, null, 1) : value) + "\n ";
    }
    addSolutionInfo(mes) {
        this.solutionInfo.push(mes);
        this.addDebugInfo("Solved", mes);
    }
    addMathInfo(msg) {
        this.mathInfo.push(msg);
    }
    addMathSnapshot(math) {
        this.mathSnapshots.push(math);
        const result = deepSearchWithPath(math, (item) => item instanceof MathJaxOperator && item.solution !== undefined);
        if (!result)
            return;
        const customFormatter = (check, string) => {
            if (check instanceof MathJaxOperator && check.solution !== undefined) {
                return `{\\color{red}${string}}`;
            }
            return string;
        };
        this.mathInfo.push(math.toString(customFormatter));
        this.solutionInfo.push(result.item.toStringSolution());
    }
}
function rearrangeEquation(tokens, tokenToisolate) {
}
function isolateMultiplication(tokens, isolatToken) {
}
export class Position {
    operator;
    index;
    start;
    end;
    transition;
    specialChar;
    groups;
    constructor(tokens, index) {
        this.index = index;
        this.transition = this.index;
        this.start = this.index;
        this.end = this.index;
        this.position(tokens);
    }
    position(tokens) {
        this.operator = tokens[this.index].value;
        const metadata = searchMathJaxOperators(this.operator);
        if (!metadata)
            throw new Error(`Operator ${this.operator} not found in metadata`);
        const beforeIndex = [];
        const afterIndex = [];
        getValuesWithKeysBySide(metadata.associativity.positions, true).forEach(() => {
            const item = this.applyPosition(tokens, this.start, true);
            beforeIndex.push(item.mathGroup);
            this.start = item.lastItemOfPrevious;
        });
        getValuesWithKeysBySide(metadata.associativity.positions, false).forEach(() => {
            const item = this.applyPosition(tokens, this.end, false);
            afterIndex.push(item.mathGroup);
            this.end = item.lastItemOfPrevious;
        });
        this.groups = beforeIndex.reverse().concat(afterIndex);
    }
    applyPosition(tokens, index, isLeft) {
        let breakChar = index;
        let target;
        const modifiedIndex = index + (isLeft ? -1 : 1);
        if ((isLeft && index <= 0) || (!isLeft && index >= tokens.length - 1) || !tokens[modifiedIndex]) {
            throw new Error("at applyPosition: \"index wasn't valid\" index: " + index);
        }
        if (tokens[modifiedIndex] instanceof Paren) {
            const parenIndex = findParenIndex(tokens[modifiedIndex], tokens);
            breakChar = isLeft ? parenIndex.open : parenIndex.close + 1;
            // Insure proper formatting removed everything including parentheses
            target = ensureAcceptableFormatForMathGroupItems(tokens.slice(parenIndex.open, parenIndex.close + 1));
        }
        else {
            breakChar = modifiedIndex;
            target = ensureAcceptableFormatForMathGroupItems(tokens[breakChar]);
        }
        if (target?.length === 0) {
            throw new Error(`at applyPosition: couldn't find target token for direction ${isLeft ? 'left' : 'right'} and operator"${tokens[index].value}"`);
        }
        return {
            mathGroup: new MathGroup(target),
            lastItemOfPrevious: breakChar,
        };
    }
}
function parseSafetyChecks(operator) {
    if ((operator.commutative && operator.groups.length < operator.groupNum) || (!operator.commutative && operator.groups.length !== operator.groupNum)) {
        throw new Error(`Invalid number of groups for operator ${operator.operator} expected ${operator.groupNum} but got ${operator.groups.length}`);
    }
}
export function parseOperator(operator) {
    parseSafetyChecks(operator);
    function getOperableValue(group) {
        if (!group || !group.isOperable())
            return null;
        return group.getOperableValue();
    }
    const group1 = getOperableValue(operator.groups[0]);
    const group2 = getOperableValue(operator.groups[1]);
    if (group1 === null || (group2 === null && operator.groups.length > 1))
        return false;
    switch (operator.operator) {
        case "Sine":
            operator.solution = new MathGroup([new Token(Math.sin(degreesToRadians(group1)))]);
            break;
        case "SquareRoot":
            if (group1 < 0) {
                throw new Error("Cannot calculate the square root of a negative number.");
            }
            operator.solution = new MathGroup([new Token(Math.pow(group1, 0.5))]);
            break;
        case "Fraction": {
            if (group2 === 0) {
                throw new Error("Division by zero is not allowed");
            }
            operator.solution = new MathGroup([new Token(group1 / group2)]);
            break;
        }
        case "Power": {
            operator.solution = new MathGroup([new Token(Math.pow(group1, group2))]);
            break;
        }
        default:
            throw new Error(`Unknown operator type in parseOperator: ${operator.operator}`);
    }
    return true;
}
function basicMathJaxTokensToMathGroup(basicTokens) {
    const defineGroupsAndOperators = (tokens) => {
        const range = operationsOrder(tokens);
        if (range.start === null || range.end === null)
            return false;
        if (range.specificOperatorIndex === null && range.start === 0 && range.end === tokens.length)
            return true;
        let newMathGroupSuccess = null;
        if (range.specificOperatorIndex !== null)
            newMathGroupSuccess = createOperatorItemFromTokens(tokens, range.specificOperatorIndex);
        else
            newMathGroupSuccess = createMathGroupInsertFromTokens(tokens, range.start, range.end);
        if (!newMathGroupSuccess)
            return false;
        return defineGroupsAndOperators(tokens);
    };
    const createMathGroupInsertFromTokens = (tokens, start, end) => {
        const newMathGroup = new MathGroup(ensureAcceptableFormatForMathGroupItems(tokens.slice(start, end + 1)));
        tokens.splice(start, (end - start) + 1, newMathGroup);
        return true;
    };
    const createOperatorItemFromTokens = (tokens, index) => {
        const metadata = searchMathJaxOperators(tokens[index].value);
        if (!metadata)
            throw new Error(`Operator ${tokens[index].value} not found in metadata`);
        const position = new Position(tokens, index);
        const newOperator = MathJaxOperator.create(position.operator, metadata.associativity.numPositions, position.groups);
        tokens.splice(position.start, (position.end - position.start) + 1, newOperator);
        return true;
    };
    const success = defineGroupsAndOperators(basicTokens);
    if (!success)
        return;
    const GroupedBasicTokens = basicTokens.filter((t) => !(t instanceof Paren));
    return new MathGroup(GroupedBasicTokens);
}
function stringToMathGroup(string) {
    const basicTokens = stringToBasicMathJaxTokens(string);
    const mathGroup = basicMathJaxTokensToMathGroup(basicTokens);
    return mathGroup;
}
function operationsOrder(tokens) {
    function findOperatorIndex(begin, end, tokens, regex) {
        const index = tokens.slice(begin, end).findIndex((token) => token.type === "operator" && regex.test(token.value));
        return index > -1 ? index + begin : null;
    }
    const { begin, end } = findDeepestParenthesesScope(tokens);
    let priority = null;
    for (let i = 1; i <= 6; i++) {
        priority = findOperatorIndex(begin, end, tokens, getMathJaxOperatorsByPriority(i, true));
        if (priority !== null)
            break;
    }
    return { start: begin, end: end, specificOperatorIndex: priority };
}
export class MathPraiser {
    input = "";
    mathGroup;
    solution;
    mathInfo = new MathInfo();
    constructor(input, mathGroup, solution, mathInfo) {
        if (input)
            this.input = input;
        if (mathGroup)
            this.mathGroup = mathGroup;
        if (solution)
            this.solution = solution;
        if (mathInfo)
            this.mathInfo = mathInfo;
    }
    setInput(input) {
        this.input = input;
        this.processInput();
        const mathGroup = stringToMathGroup(this.input);
        if (!mathGroup)
            throw new Error("Invalid input");
        this.mathGroup = mathGroup;
    }
    addSolution() {
        this.input = this.mathGroup.toString();
        this.controller();
        this.solution = this.mathGroup;
        this.addDebugInfo("solution", this.solution);
    }
    parse(tokens) {
        const operatorIndex = tokens.getItems().findIndex(t => t instanceof MathJaxOperator && t.isOperable);
        if (operatorIndex < 0)
            return;
        const operator = tokens.getItems()[operatorIndex];
        operator.groups.forEach(group => {
            this.parse(group);
        });
        operator.parseMathjaxOperator();
        if (!operator.solution) {
            operator.isOperable = false;
            return;
        }
        this.mathInfo.addMathSnapshot(this.mathGroup.clone());
        tokens.replaceItemCell(operator.solution, operatorIndex);
    }
    controller() {
        this.parse(this.mathGroup);
        combineSimilarValues(this.mathGroup);
        this.mathGroup.combiningLikeTerms();
    }
    solutionToString() {
        return (this.mathGroup.toString()) || "";
    }
    addDebugInfo(mes, value) {
        this.mathInfo.addDebugInfo(mes, value);
    }
    processInput() {
        this.input = this.input
            .replace(/(Math.|\\|\s|left|right)/g, "")
            .replace(/{/g, "(")
            .replace(/}/g, ")");
        //.replace(/(?<!\\|[a-zA-Z])(tan|sin|cos|binom|frac|asin|acos|atan|arccos|arcsin|arctan|cdot)/g, "\\$1");
    }
    finalReturn() {
        // return this.tokens.reconstruct()
    }
}
function deepClone(items) {
    let clone = [];
    items.forEach(item => {
        clone.push(item instanceof Array ? deepClone(item) : item.clone());
    });
    return clone;
}
function combineSimilarValues(math) {
    const op = math.getItems().find(t => t instanceof MathJaxOperator);
    if (!op)
        return;
    /*const a=new MathOverview()
    a.defineGlobalOverview(math.getItems())
    a.separateIntoIndividuals()*/
}
class mathVariables {
}
export function flattenArray(arr) {
    let result = [];
    let stack = Array.isArray(arr) ? [...arr] : [arr];
    while (stack.length) {
        const next = stack.pop();
        if (Array.isArray(next)) {
            stack.push(...next);
        }
        else {
            result.push(next);
        }
    }
    return result.reverse();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aEVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYXRoUGFyc2VyL21hdGhFbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUF1QyxnQkFBZ0IsRUFBc0MsTUFBTSxpQkFBaUIsQ0FBQztBQUU1SCxPQUFPLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBZ0IsMkJBQTJCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMxRyxPQUFPLEVBQTJCLDZCQUE2QixFQUErQix1QkFBdUIsRUFBMEQsc0JBQXNCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6TyxPQUFPLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsdUNBQXVDLEVBQUUsa0JBQWtCLEVBQWlCLDBCQUEwQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFNUssTUFBTSxZQUFZLEdBQUc7SUFDakIsT0FBTyxFQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPO0lBQzVFLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUs7SUFDeEUsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTztDQUMxRCxDQUFDO0FBQ0Y7OztHQUdHO0FBRUgsTUFBTSxVQUFVLHdCQUF3QixDQUFDLEdBQVU7SUFDL0MsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztJQUNkLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFD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WyJcbmltcG9ydCB7IHF1YWQsY2FsY3VsYXRlQmlub20scm91bmRCeVNldHRpbmdzICxkZWdyZWVzVG9SYWRpYW5zLHJhZGlhbnNUb0RlZ3JlZXMsIGNhbGN1bGF0ZUZhY3RvcmlhbH0gZnJvbSBcIi4vbWF0aFV0aWxpdGllc1wiO1xuXG5pbXBvcnQgeyBmaW5kUGFyZW5JbmRleCwgUGFyZW4saWRQYXJlbnRoZXNlcywgZmluZERlZXBlc3RQYXJlbnRoZXNlc1Njb3BlIH0gZnJvbSBcIi4uL3V0aWxzL1BhcmVuVXRlbnNpbHNcIjtcbmltcG9ydCB7IGdldEFsbE1hdGhKYXhSZWZlcmVuY2VzLCBnZXRNYXRoSmF4T3BlcmF0b3JzQnlQcmlvcml0eSwgZ2V0T3BlcmF0b3JzQnlBc3NvY2lhdGl2aXR5LCBnZXRWYWx1ZXNXaXRoS2V5c0J5U2lkZSwgaGFzSW1wbGljaXRNdWx0aXBsaWNhdGlvbiwgaXNPcGVyYXRvcldpdGhBc3NvY2lhdGl2aXR5LCBzZWFyY2hNYXRoSmF4T3BlcmF0b3JzIH0gZnJvbSBcIi4uL3N0YXRpY0RhdGEvZGF0YU1hbmFnZXJcIjtcbmltcG9ydCB7IE1hdGhHcm91cCwgTWF0aEpheE9wZXJhdG9yLCBUb2tlbiwgZW5zdXJlQWNjZXB0YWJsZUZvcm1hdEZvck1hdGhHcm91cEl0ZW1zLCBkZWVwU2VhcmNoV2l0aFBhdGgsIE1hdGhHcm91cEl0ZW0sIHN0cmluZ1RvQmFzaWNNYXRoSmF4VG9rZW5zIH0gZnJvbSBcIi4vbWF0aEpheFRva2Vuc1wiO1xuaW1wb3J0IHsgQmFzaWNNYXRoSmF4VG9rZW4gfSBmcm9tIFwic3JjL2Jhc2ljVG9rZW5cIjtcbmNvbnN0IGdyZWVrTGV0dGVycyA9IFtcbiAgICAnQWxwaGEnLCdhbHBoYScsICdCZXRhJywgJ0dhbW1hJywgJ0RlbHRhJywgJ0Vwc2lsb24nLCAnWmV0YScsICdFdGEnLCAnVGhldGEnLCBcbiAgICAnSW90YScsICdLYXBwYScsICdMYW1iZGEnLCAnTXUnLCdtdScsICdOdScsICdYaScsICdPbWljcm9uJywgJ1BpJywgJ1JobycsIFxuICAgICdTaWdtYScsICdUYXUnLCAnVXBzaWxvbicsICdQaGknLCAnQ2hpJywgJ1BzaScsICdPbWVnYSdcbl07XG4vKmNvbnN0IGxhdGV4T3BlcmF0b3JzPVtcbiAgICAndGFuJywgJ3NpbicsICdjb3MnLCAnYmlub20nLCAnZnJhYycsICdhc2luJywgJ2Fjb3MnLCBcbiAgICAnYXRhbicsICdhcmNjb3MnLCAnYXJjc2luJywgJ2FyY3RhbicsICdjZG90Jywnc3FydCdcbl0qL1xuXG5leHBvcnQgZnVuY3Rpb24gZmluZENvbnNlY3V0aXZlU2VxdWVuY2VzKGFycjogYW55W10pIHtcbiAgICBjb25zdCBzZXF1ZW5jZXMgPSBbXTtcbiAgICBsZXQgc3RhcnQgPSAwO1xuICAgIGZvciAobGV0IGkgPSAxOyBpIDw9IGFyci5sZW5ndGg7IGkrKykge1xuICAgICAgICBpZiAoYXJyW2ldICE9PSBhcnJbaSAtIDFdICsgMSkge1xuICAgICAgICAgICAgaWYgKGkgLSBzdGFydCA+IDEpIHtcbiAgICAgICAgICAgICAgICBzZXF1ZW5jZXMucHVzaChhcnIuc2xpY2Uoc3RhcnQsIGkpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHN0YXJ0ID0gaTtcbiAgICAgICAgfVxuICAgIH1cbiAgICByZXR1cm4gc2VxdWVuY2VzO1xufVxuXG5cblxuZXhwb3J0IGNsYXNzIE1hdGhJbmZve1xuICAgIGRlYnVnSW5mbzogc3RyaW5nPVwiXCI7XG4gICAgc29sdXRpb25JbmZvOiBhbnlbXT1bXTtcbiAgICBtYXRoSW5mbzogYW55W109W11cbiAgICBncmFwaDogc3RyaW5nPVwiXCI7XG4gICAgbWF0aFNuYXBzaG90czogTWF0aEdyb3VwW109W11cbiAgICBhZGRHcmFwaEluZm8odmFsdWU6IHN0cmluZyl7XG4gICAgICAgIHRoaXMuZ3JhcGgrPXZhbHVlO1xuICAgIH1cbiAgICBhZGREZWJ1Z0luZm8obXNnOiBzdHJpbmcsIHZhbHVlOiBhbnkpe1xuICAgICAgICB0aGlzLmRlYnVnSW5mbys9KHR5cGVvZiBtc2c9PT1cIm9iamVjdFwiP0pTT04uc3RyaW5naWZ5KG1zZyxudWxsLDEpOm1zZykrXCIgOiBcIisodHlwZW9mIHZhbHVlPT09XCJvYmplY3RcIj9KU09OLnN0cmluZ2lmeSh2YWx1ZSxudWxsLDEpOnZhbHVlKSsgXCJcXG4gXCI7XG4gICAgfVxuICAgIGFkZFNvbHV0aW9uSW5mbyhtZXM6IHN0cmluZyl7XG4gICAgICAgIHRoaXMuc29sdXRpb25JbmZvLnB1c2gobWVzKTtcbiAgICAgICAgdGhpcy5hZGREZWJ1Z0luZm8oXCJTb2x2ZWRcIixtZXMpO1xuICAgIH1cbiAgICBhZGRNYXRoSW5mbyhtc2c6IHN0cmluZyl7XG4gICAgICAgIHRoaXMubWF0aEluZm8ucHVzaChtc2cpXG4gICAgfVxuICAgIGFkZE1hdGhTbmFwc2hvdChtYXRoOiBNYXRoR3JvdXApe1xuICAgICAgICB0aGlzLm1hdGhTbmFwc2hvdHMucHVzaChtYXRoKVxuICAgICAgICBjb25zdCByZXN1bHQgPSBkZWVwU2VhcmNoV2l0aFBhdGgoXG4gICAgICAgICAgICBtYXRoLFxuICAgICAgICAgICAgKGl0ZW0pID0+IGl0ZW0gaW5zdGFuY2VvZiBNYXRoSmF4T3BlcmF0b3IgJiYgaXRlbS5zb2x1dGlvbiAhPT0gdW5kZWZpbmVkXG4gICAgICAgICk7XG4gICAgICAgIGlmKCFyZXN1bHQpcmV0dXJuXG4gICAgICAgIFxuXG4gICAgICAgIGNvbnN0IGN1c3RvbUZvcm1hdHRlciA9IChjaGVjazogYW55LHN0cmluZzogc3RyaW5nKTogc3RyaW5nID0+IHtcbiAgICAgICAgICAgIGlmIChjaGVjayBpbnN0YW5jZW9mIE1hdGhKYXhPcGVyYXRvciAmJiBjaGVjay5zb2x1dGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGB7XFxcXGNvbG9ye3JlZH0ke3N0cmluZ319YDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBzdHJpbmdcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5tYXRoSW5mby5wdXNoKG1hdGgudG9TdHJpbmcoY3VzdG9tRm9ybWF0dGVyKSlcbiAgICAgICAgdGhpcy5zb2x1dGlvbkluZm8ucHVzaChyZXN1bHQuaXRlbS50b1N0cmluZ1NvbHV0aW9uKCkpXG4gICAgICAgIFxuICAgIH1cblxufVxuXG5cblxuXG5cblxuXG5cbmZ1bmN0aW9uIHJlYXJyYW5nZUVxdWF0aW9uKHRva2VuczogYW55LHRva2VuVG9pc29sYXRlOiBhbnkpe1xuICAgIFxufVxuXG5mdW5jdGlvbiBpc29sYXRlTXVsdGlwbGljYXRpb24odG9rZW5zOiBhbnksaXNvbGF0VG9rZW46IFRva2VuKXsvKlxuICAgIGNvbnN0IGluZGV4PW9wZXJhdGlvbnNPcmRlcih0b2tlbnMpXG4gICAgY29uc3QgSXNvbGF0ZWQ9dG9rZW5zLnRva2Vucy5maW5kKCh0b2tlbjogYW55LCBpZHg6IG51bWJlcik9PmlkeDxpbmRleClcbiAgICBjb25zdCBmcmFjPWNyZWF0ZUZyYWModG9rZW5zLmxpc3Quc2xpY2UoaW5kZXggKyAxKSxuZXcgVG9rZW4oSXNvbGF0ZWQudmFsdWUpKVxuICAgIElzb2xhdGVkLnZhbHVlPTE7XG4gICAgdG9rZW5zLmluc2VydFRva2VucyhpbmRleCsxLHRva2Vucy50b2tlbnMubGVuZ3RoLWluZGV4KzEsZnJhYykqL1xufVxuXG5cblxuZXhwb3J0IGNsYXNzIFBvc2l0aW9uIHtcbiAgICBvcGVyYXRvcjogc3RyaW5nO1xuICAgIGluZGV4OiBudW1iZXI7XG4gICAgc3RhcnQ6IG51bWJlcjtcbiAgICBlbmQ6IG51bWJlcjtcbiAgICB0cmFuc2l0aW9uOiBudW1iZXI7XG4gICAgc3BlY2lhbENoYXI6IHN0cmluZztcbiAgICBcbiAgICBncm91cHM6IE1hdGhHcm91cFtdO1xuICAgIGNvbnN0cnVjdG9yKHRva2VuczogYW55W10sIGluZGV4OiBudW1iZXIpeyAgXG4gICAgICAgIHRoaXMuaW5kZXggPSBpbmRleDtcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uID0gdGhpcy5pbmRleDtcbiAgICAgICAgdGhpcy5zdGFydCA9IHRoaXMuaW5kZXg7XG4gICAgICAgIHRoaXMuZW5kID0gdGhpcy5pbmRleDtcbiAgICAgICAgdGhpcy5wb3NpdGlvbih0b2tlbnMpXG4gICAgfVxuXG4gICAgXG5cbiAgICBwb3NpdGlvbih0b2tlbnM6IGFueVtdKSB7XG4gICAgICAgIHRoaXMub3BlcmF0b3IgPSB0b2tlbnNbdGhpcy5pbmRleF0udmFsdWU7XG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gc2VhcmNoTWF0aEpheE9wZXJhdG9ycyh0aGlzLm9wZXJhdG9yKTtcbiAgICAgICAgaWYgKCFtZXRhZGF0YSkgdGhyb3cgbmV3IEVycm9yKGBPcGVyYXRvciAke3RoaXMub3BlcmF0b3J9IG5vdCBmb3VuZCBpbiBtZXRhZGF0YWApO1xuICAgIFxuICAgICAgICBjb25zdCBiZWZvcmVJbmRleDogTWF0aEdyb3VwW10gPSBbXTtcbiAgICAgICAgY29uc3QgYWZ0ZXJJbmRleDogIE1hdGhHcm91cFtdID0gW107XG4gICAgXG4gICAgICAgIGdldFZhbHVlc1dpdGhLZXlzQnlTaWRlKG1ldGFkYXRhLmFzc29jaWF0aXZpdHkucG9zaXRpb25zLCB0cnVlKS5mb3JFYWNoKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLmFwcGx5UG9zaXRpb24odG9rZW5zLCB0aGlzLnN0YXJ0LCB0cnVlKTtcbiAgICAgICAgICAgIGJlZm9yZUluZGV4LnB1c2goaXRlbS5tYXRoR3JvdXApO1xuICAgICAgICAgICAgdGhpcy5zdGFydCA9IGl0ZW0ubGFzdEl0ZW1PZlByZXZpb3VzO1xuICAgICAgICB9KTtcbiAgICBcbiAgICBcbiAgICAgICAgZ2V0VmFsdWVzV2l0aEtleXNCeVNpZGUobWV0YWRhdGEuYXNzb2NpYXRpdml0eS5wb3NpdGlvbnMsIGZhbHNlKS5mb3JFYWNoKCgpID0+IHtcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLmFwcGx5UG9zaXRpb24odG9rZW5zLCB0aGlzLmVuZCwgZmFsc2UpO1xuICAgICAgICAgICAgYWZ0ZXJJbmRleC5wdXNoKGl0ZW0ubWF0aEdyb3VwKTtcbiAgICAgICAgICAgIHRoaXMuZW5kID0gaXRlbS5sYXN0SXRlbU9mUHJldmlvdXM7XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLmdyb3VwcyA9IGJlZm9yZUluZGV4LnJldmVyc2UoKS5jb25jYXQoYWZ0ZXJJbmRleCk7XG4gICAgfVxuICAgIGFwcGx5UG9zaXRpb24odG9rZW5zOiBhbnlbXSwgaW5kZXg6ICBudW1iZXIsIGlzTGVmdDogYm9vbGVhbikge1xuICAgICAgICBsZXQgYnJlYWtDaGFyPWluZGV4XG4gICAgICAgIGxldCB0YXJnZXQ6IGFueTtcbiAgICAgICAgY29uc3QgbW9kaWZpZWRJbmRleCA9ICBpbmRleCsoaXNMZWZ0Py0gMSA6ICAxKTtcblxuICAgICAgICBpZiAoKGlzTGVmdCAmJiBpbmRleCA8PSAwKSB8fCAoIWlzTGVmdCAmJiBpbmRleCA+PSB0b2tlbnMubGVuZ3RoIC0gMSkgfHwgIXRva2Vuc1ttb2RpZmllZEluZGV4XSkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiYXQgYXBwbHlQb3NpdGlvbjogXFxcImluZGV4IHdhc24ndCB2YWxpZFxcXCIgaW5kZXg6IFwiK2luZGV4KTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0b2tlbnNbbW9kaWZpZWRJbmRleF0gaW5zdGFuY2VvZiBQYXJlbikge1xuICAgICAgICAgICAgY29uc3QgcGFyZW5JbmRleCA9IGZpbmRQYXJlbkluZGV4KHRva2Vuc1ttb2RpZmllZEluZGV4XSx0b2tlbnMpO1xuICAgICAgICAgICAgYnJlYWtDaGFyID0gIGlzTGVmdCA/IHBhcmVuSW5kZXgub3BlbiA6IHBhcmVuSW5kZXguY2xvc2UrMTtcbiAgICAgICAgICAgIC8vIEluc3VyZSBwcm9wZXIgZm9ybWF0dGluZyByZW1vdmVkIGV2ZXJ5dGhpbmcgaW5jbHVkaW5nIHBhcmVudGhlc2VzXG4gICAgICAgICAgICB0YXJnZXQgPSBlbnN1cmVBY2NlcHRhYmxlRm9ybWF0Rm9yTWF0aEdyb3VwSXRlbXModG9rZW5zLnNsaWNlKHBhcmVuSW5kZXgub3BlbiwgcGFyZW5JbmRleC5jbG9zZSsxKSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBicmVha0NoYXI9bW9kaWZpZWRJbmRleDtcbiAgICAgICAgICAgIHRhcmdldCA9IGVuc3VyZUFjY2VwdGFibGVGb3JtYXRGb3JNYXRoR3JvdXBJdGVtcyh0b2tlbnNbYnJlYWtDaGFyXSk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHRhcmdldD8ubGVuZ3RoPT09MCkge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBhdCBhcHBseVBvc2l0aW9uOiBjb3VsZG4ndCBmaW5kIHRhcmdldCB0b2tlbiBmb3IgZGlyZWN0aW9uICR7aXNMZWZ0PydsZWZ0JzoncmlnaHQnfSBhbmQgb3BlcmF0b3JcIiR7dG9rZW5zW2luZGV4XS52YWx1ZX1cImAsKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICBtYXRoR3JvdXA6IG5ldyBNYXRoR3JvdXAodGFyZ2V0KSxcbiAgICAgICAgICAgIGxhc3RJdGVtT2ZQcmV2aW91czogYnJlYWtDaGFyLFxuICAgICAgICB9O1xuICAgIH1cbn1cblxuZnVuY3Rpb24gcGFyc2VTYWZldHlDaGVja3Mob3BlcmF0b3I6IE1hdGhKYXhPcGVyYXRvcil7XG4gICAgaWYgKChvcGVyYXRvci5jb21tdXRhdGl2ZSYmb3BlcmF0b3IuZ3JvdXBzLmxlbmd0aDxvcGVyYXRvci5ncm91cE51bSl8fCghb3BlcmF0b3IuY29tbXV0YXRpdmUmJm9wZXJhdG9yLmdyb3Vwcy5sZW5ndGghPT1vcGVyYXRvci5ncm91cE51bSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIG51bWJlciBvZiBncm91cHMgZm9yIG9wZXJhdG9yICR7b3BlcmF0b3Iub3BlcmF0b3J9IGV4cGVjdGVkICR7b3BlcmF0b3IuZ3JvdXBOdW19IGJ1dCBnb3QgJHtvcGVyYXRvci5ncm91cHMubGVuZ3RofWApO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlT3BlcmF0b3Iob3BlcmF0b3I6IE1hdGhKYXhPcGVyYXRvcik6IGJvb2xlYW4ge1xuICAgIHBhcnNlU2FmZXR5Q2hlY2tzKG9wZXJhdG9yKTsgXG4gICAgZnVuY3Rpb24gZ2V0T3BlcmFibGVWYWx1ZShncm91cDogTWF0aEdyb3VwKTogbnVtYmVyIHwgbnVsbCB7XG4gICAgICAgIGlmICghZ3JvdXB8fCFncm91cC5pc09wZXJhYmxlKCkpIHJldHVybiBudWxsO1xuICAgICAgICByZXR1cm4gZ3JvdXAuZ2V0T3BlcmFibGVWYWx1ZSgpO1xuICAgIH1cbiAgICBjb25zdCBncm91cDEgPSBnZXRPcGVyYWJsZVZhbHVlKG9wZXJhdG9yLmdyb3Vwc1swXSk7XG4gICAgY29uc3QgZ3JvdXAyID0gZ2V0T3BlcmFibGVWYWx1ZShvcGVyYXRvci5ncm91cHNbMV0pO1xuICAgIGlmIChncm91cDEgPT09IG51bGx8fChncm91cDI9PT1udWxsJiZvcGVyYXRvci5ncm91cHMubGVuZ3RoPjEpKSByZXR1cm4gZmFsc2U7XG4gICAgXG4gICAgc3dpdGNoIChvcGVyYXRvci5vcGVyYXRvcikge1xuICAgICAgICBjYXNlIFwiU2luZVwiOlxuICAgICAgICAgICAgb3BlcmF0b3Iuc29sdXRpb24gPSBuZXcgTWF0aEdyb3VwKFtuZXcgVG9rZW4oTWF0aC5zaW4oZGVncmVlc1RvUmFkaWFucyhncm91cDEpKSldKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwiU3F1YXJlUm9vdFwiOlxuICAgICAgICAgICAgaWYgKGdyb3VwMSA8IDApIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJDYW5ub3QgY2FsY3VsYXRlIHRoZSBzcXVhcmUgcm9vdCBvZiBhIG5lZ2F0aXZlIG51bWJlci5cIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvcGVyYXRvci5zb2x1dGlvbiA9IG5ldyBNYXRoR3JvdXAoW25ldyBUb2tlbihNYXRoLnBvdyhncm91cDEsMC41KSldKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwiRnJhY3Rpb25cIjoge1xuICAgICAgICAgICAgaWYgKGdyb3VwMiA9PT0gMCkge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkRpdmlzaW9uIGJ5IHplcm8gaXMgbm90IGFsbG93ZWRcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBvcGVyYXRvci5zb2x1dGlvbiA9IG5ldyBNYXRoR3JvdXAoW25ldyBUb2tlbihncm91cDEgLyBncm91cDIhKV0pO1xuICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBcIlBvd2VyXCI6IHtcbiAgICAgICAgICAgIG9wZXJhdG9yLnNvbHV0aW9uID0gbmV3IE1hdGhHcm91cChbbmV3IFRva2VuKE1hdGgucG93KGdyb3VwMSxncm91cDIhKSldKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgICAgICAgYFVua25vd24gb3BlcmF0b3IgdHlwZSBpbiBwYXJzZU9wZXJhdG9yOiAke29wZXJhdG9yLm9wZXJhdG9yfWBcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICBcbiAgICB9XG4gICAgcmV0dXJuIHRydWU7XG59XG5cblxuZnVuY3Rpb24gYmFzaWNNYXRoSmF4VG9rZW5zVG9NYXRoR3JvdXAoYmFzaWNUb2tlbnM6IEFycmF5PEJhc2ljTWF0aEpheFRva2VufFBhcmVuPik6IE1hdGhHcm91cHx1bmRlZmluZWR7XG4gICAgY29uc3QgZGVmaW5lR3JvdXBzQW5kT3BlcmF0b3JzPSh0b2tlbnM6IEFycmF5PGFueT4pOmJvb2xlYW49PntcbiAgICAgICAgY29uc3QgcmFuZ2U9b3BlcmF0aW9uc09yZGVyKHRva2Vucyk7XG4gICAgICAgIGlmKHJhbmdlLnN0YXJ0PT09bnVsbHx8cmFuZ2UuZW5kPT09bnVsbClyZXR1cm4gZmFsc2U7XG4gICAgICAgIGlmKHJhbmdlLnNwZWNpZmljT3BlcmF0b3JJbmRleD09PW51bGwmJnJhbmdlLnN0YXJ0PT09MCYmcmFuZ2UuZW5kPT09dG9rZW5zLmxlbmd0aClyZXR1cm4gdHJ1ZTtcbiAgICAgICAgbGV0IG5ld01hdGhHcm91cFN1Y2Nlc3M9bnVsbFxuICAgICAgICBpZiAocmFuZ2Uuc3BlY2lmaWNPcGVyYXRvckluZGV4IT09bnVsbClcbiAgICAgICAgICAgIG5ld01hdGhHcm91cFN1Y2Nlc3M9Y3JlYXRlT3BlcmF0b3JJdGVtRnJvbVRva2Vucyh0b2tlbnMscmFuZ2Uuc3BlY2lmaWNPcGVyYXRvckluZGV4KVxuICAgICAgICBlbHNlXG4gICAgICAgIG5ld01hdGhHcm91cFN1Y2Nlc3M9Y3JlYXRlTWF0aEdyb3VwSW5zZXJ0RnJvbVRva2Vucyh0b2tlbnMscmFuZ2Uuc3RhcnQscmFuZ2UuZW5kKVxuICAgICAgICBpZighbmV3TWF0aEdyb3VwU3VjY2VzcylyZXR1cm4gZmFsc2U7XG4gICAgICAgIHJldHVybiBkZWZpbmVHcm91cHNBbmRPcGVyYXRvcnModG9rZW5zKTtcbiAgICB9XG4gICAgY29uc3QgY3JlYXRlTWF0aEdyb3VwSW5zZXJ0RnJvbVRva2Vucz0odG9rZW5zOiBBcnJheTxhbnk+LHN0YXJ0OiBudW1iZXIsZW5kOiBudW1iZXIpOmJvb2xlYW49PntcbiAgICAgICAgY29uc3QgbmV3TWF0aEdyb3VwPW5ldyBNYXRoR3JvdXAoZW5zdXJlQWNjZXB0YWJsZUZvcm1hdEZvck1hdGhHcm91cEl0ZW1zKHRva2Vucy5zbGljZShzdGFydCxlbmQrMSkpKTtcbiAgICAgICAgdG9rZW5zLnNwbGljZShzdGFydCwoZW5kLXN0YXJ0KSsxLG5ld01hdGhHcm91cCk7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIGNvbnN0IGNyZWF0ZU9wZXJhdG9ySXRlbUZyb21Ub2tlbnM9KHRva2VuczogQXJyYXk8YW55PixpbmRleDogbnVtYmVyKTpib29sZWFuPT57XG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gc2VhcmNoTWF0aEpheE9wZXJhdG9ycyh0b2tlbnNbaW5kZXhdLnZhbHVlKTtcbiAgICAgICAgaWYoIW1ldGFkYXRhKXRocm93IG5ldyBFcnJvcihgT3BlcmF0b3IgJHt0b2tlbnNbaW5kZXhdLnZhbHVlfSBub3QgZm91bmQgaW4gbWV0YWRhdGFgKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uPW5ldyBQb3NpdGlvbih0b2tlbnMsaW5kZXgpXG4gICAgICAgIGNvbnN0IG5ld09wZXJhdG9yPU1hdGhKYXhPcGVyYXRvci5jcmVhdGUocG9zaXRpb24ub3BlcmF0b3IsbWV0YWRhdGEuYXNzb2NpYXRpdml0eS5udW1Qb3NpdGlvbnMscG9zaXRpb24uZ3JvdXBzKVxuICAgICAgICB0b2tlbnMuc3BsaWNlKHBvc2l0aW9uLnN0YXJ0LChwb3NpdGlvbi5lbmQtcG9zaXRpb24uc3RhcnQpKzEsbmV3T3BlcmF0b3IpO1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cblxuICAgIGNvbnN0IHN1Y2Nlc3M9ZGVmaW5lR3JvdXBzQW5kT3BlcmF0b3JzKGJhc2ljVG9rZW5zKVxuICAgIGlmKCFzdWNjZXNzKXJldHVyblxuICAgIGNvbnN0IEdyb3VwZWRCYXNpY1Rva2VuczogTWF0aEdyb3VwSXRlbVtdPShiYXNpY1Rva2Vucy5maWx0ZXIoKHQpID0+ICEodCBpbnN0YW5jZW9mIFBhcmVuKSlhcyBhbnkpXG4gICAgcmV0dXJuIG5ldyBNYXRoR3JvdXAoR3JvdXBlZEJhc2ljVG9rZW5zKVxufVxuXG5mdW5jdGlvbiBzdHJpbmdUb01hdGhHcm91cChzdHJpbmc6IFN0cmluZyk6TWF0aEdyb3VwfHVuZGVmaW5lZHtcbiAgICBjb25zdCBiYXNpY1Rva2Vucz1zdHJpbmdUb0Jhc2ljTWF0aEpheFRva2VucyhzdHJpbmcpO1xuICAgIGNvbnN0IG1hdGhHcm91cCA9IGJhc2ljTWF0aEpheFRva2Vuc1RvTWF0aEdyb3VwKGJhc2ljVG9rZW5zKVxuICAgIHJldHVybiBtYXRoR3JvdXBcbn1cblxuXG5cbmZ1bmN0aW9uIG9wZXJhdGlvbnNPcmRlcih0b2tlbnM6IGFueVtdKSB7XG4gICAgZnVuY3Rpb24gZmluZE9wZXJhdG9ySW5kZXgoYmVnaW46IG51bWJlciwgZW5kOiBudW1iZXIsIHRva2VuczogYW55LCByZWdleD86IGFueSkge1xuICAgICAgICBjb25zdCBpbmRleD10b2tlbnMuc2xpY2UoYmVnaW4sIGVuZCkuZmluZEluZGV4KCh0b2tlbjogeyB0eXBlOiBzdHJpbmc7IHZhbHVlOiBhbnk7IH0pID0+IHRva2VuLnR5cGUgPT09IFwib3BlcmF0b3JcIiAmJiByZWdleC50ZXN0KHRva2VuLnZhbHVlKSk7XG4gICAgICAgIHJldHVybiBpbmRleD4tMT9pbmRleCtiZWdpbjpudWxsO1xuICAgIH1cbiAgICBjb25zdCB7IGJlZ2luLCBlbmQgfSA9IGZpbmREZWVwZXN0UGFyZW50aGVzZXNTY29wZSh0b2tlbnMpO1xuICAgIGxldCBwcmlvcml0eT1udWxsXG4gICAgZm9yIChsZXQgaT0xO2k8PTY7aSsrKXtcbiAgICAgICAgcHJpb3JpdHkgPSBmaW5kT3BlcmF0b3JJbmRleChiZWdpbiAsIGVuZCx0b2tlbnMsIGdldE1hdGhKYXhPcGVyYXRvcnNCeVByaW9yaXR5KGksdHJ1ZSkpO1xuICAgICAgICBpZihwcmlvcml0eSE9PW51bGwpYnJlYWs7XG4gICAgfVxuICAgIHJldHVybiB7c3RhcnQ6IGJlZ2luLGVuZDogZW5kLHNwZWNpZmljT3BlcmF0b3JJbmRleDogcHJpb3JpdHl9XG59XG5cbmV4cG9ydCBjbGFzcyBNYXRoUHJhaXNlcntcbiAgICBwcml2YXRlIGlucHV0PVwiXCI7XG4gICAgcHJpdmF0ZSBtYXRoR3JvdXA6IE1hdGhHcm91cDtcbiAgICBzb2x1dGlvbjogYW55O1xuICAgIG1hdGhJbmZvPW5ldyBNYXRoSW5mbygpO1xuICAgIGNvbnN0cnVjdG9yKGlucHV0Pzogc3RyaW5nLG1hdGhHcm91cD86IE1hdGhHcm91cCxzb2x1dGlvbj86IGFueSxtYXRoSW5mbz86IE1hdGhJbmZvKXtcbiAgICAgICAgaWYoaW5wdXQpdGhpcy5pbnB1dD1pbnB1dDtcbiAgICAgICAgaWYobWF0aEdyb3VwKXRoaXMubWF0aEdyb3VwPW1hdGhHcm91cDtcbiAgICAgICAgaWYoc29sdXRpb24pdGhpcy5zb2x1dGlvbj1zb2x1dGlvbjtcbiAgICAgICAgaWYobWF0aEluZm8pdGhpcy5tYXRoSW5mbz1tYXRoSW5mbztcbiAgICB9XG4gICAgc2V0SW5wdXQoaW5wdXQ6IHN0cmluZyl7XG4gICAgICAgIHRoaXMuaW5wdXQ9aW5wdXQ7XG4gICAgICAgIHRoaXMucHJvY2Vzc0lucHV0KCk7XG4gICAgICAgIGNvbnN0IG1hdGhHcm91cD1zdHJpbmdUb01hdGhHcm91cCh0aGlzLmlucHV0KTtcbiAgICAgICAgaWYoIW1hdGhHcm91cCl0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGlucHV0XCIpO1xuICAgICAgICB0aGlzLm1hdGhHcm91cD1tYXRoR3JvdXA7XG4gICAgfVxuICAgIGFkZFNvbHV0aW9uKCl7XG4gICAgICAgIHRoaXMuaW5wdXQ9dGhpcy5tYXRoR3JvdXAudG9TdHJpbmcoKVxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIoKTtcbiAgICAgICAgdGhpcy5zb2x1dGlvbj10aGlzLm1hdGhHcm91cFxuICAgICAgICB0aGlzLmFkZERlYnVnSW5mbyhcInNvbHV0aW9uXCIsdGhpcy5zb2x1dGlvbik7XG4gICAgfVxuXG4gICAgXG4gICAgcGFyc2UodG9rZW5zOiBNYXRoR3JvdXApOiB2b2lkIHtcbiAgICAgICAgY29uc3Qgb3BlcmF0b3JJbmRleD10b2tlbnMuZ2V0SXRlbXMoKS5maW5kSW5kZXgoXG4gICAgICAgICAgICB0ID0+IHQgaW5zdGFuY2VvZiBNYXRoSmF4T3BlcmF0b3IgJiYgdC5pc09wZXJhYmxlXG4gICAgICAgICkgO1xuICAgICAgICBpZiAob3BlcmF0b3JJbmRleDwwKSByZXR1cm47XG4gICAgICAgIGNvbnN0IG9wZXJhdG9yID0gdG9rZW5zLmdldEl0ZW1zKClbb3BlcmF0b3JJbmRleF0gYXMgTWF0aEpheE9wZXJhdG9yXG4gICAgXG4gICAgICAgIFxuICAgICAgICBvcGVyYXRvci5ncm91cHMuZm9yRWFjaChncm91cCA9PiB7XG4gICAgICAgICAgICB0aGlzLnBhcnNlKGdyb3VwKTtcbiAgICAgICAgfSk7XG4gICAgICAgIG9wZXJhdG9yLnBhcnNlTWF0aGpheE9wZXJhdG9yKClcbiAgICAgICAgaWYgKCFvcGVyYXRvci5zb2x1dGlvbikge1xuICAgICAgICAgICAgb3BlcmF0b3IuaXNPcGVyYWJsZSA9IGZhbHNlO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMubWF0aEluZm8uYWRkTWF0aFNuYXBzaG90KHRoaXMubWF0aEdyb3VwLmNsb25lKCkpXG4gICAgICAgIHRva2Vucy5yZXBsYWNlSXRlbUNlbGwob3BlcmF0b3Iuc29sdXRpb24sb3BlcmF0b3JJbmRleCk7IFxuICAgIH1cbiAgICBcbiAgICBjb250cm9sbGVyKCk6IGFueXtcbiAgICAgICAgdGhpcy5wYXJzZSh0aGlzLm1hdGhHcm91cClcbiAgICAgICAgY29tYmluZVNpbWlsYXJWYWx1ZXModGhpcy5tYXRoR3JvdXApXG4gICAgICAgIHRoaXMubWF0aEdyb3VwLmNvbWJpbmluZ0xpa2VUZXJtcygpXG5cbiAgICB9XG4gICAgc29sdXRpb25Ub1N0cmluZygpe1xuICAgICAgICByZXR1cm4gKHRoaXMubWF0aEdyb3VwLnRvU3RyaW5nKCkpfHxcIlwiXG4gICAgfVxuXG4gICAgYWRkRGVidWdJbmZvKG1lczogc3RyaW5nLHZhbHVlOiBhbnkpe1xuICAgICAgICB0aGlzLm1hdGhJbmZvLmFkZERlYnVnSW5mbyhtZXMsdmFsdWUpXG4gICAgfVxuICAgIHByb2Nlc3NJbnB1dCgpe1xuICAgICAgICB0aGlzLmlucHV0PXRoaXMuaW5wdXRcbiAgICAgICAgLnJlcGxhY2UoLyhNYXRoLnxcXFxcfFxcc3xsZWZ0fHJpZ2h0KS9nLCBcIlwiKSBcbiAgICAgICAgLnJlcGxhY2UoL3svZywgXCIoXCIpXG4gICAgICAgIC5yZXBsYWNlKC99L2csIFwiKVwiKVxuICAgICAgICAvLy5yZXBsYWNlKC8oPzwhXFxcXHxbYS16QS1aXSkodGFufHNpbnxjb3N8Ymlub218ZnJhY3xhc2lufGFjb3N8YXRhbnxhcmNjb3N8YXJjc2lufGFyY3RhbnxjZG90KS9nLCBcIlxcXFwkMVwiKTtcbiAgICB9XG4gICAgZmluYWxSZXR1cm4oKXtcbiAgICAgICAvLyByZXR1cm4gdGhpcy50b2tlbnMucmVjb25zdHJ1Y3QoKVxuICAgIH1cbn1cblxuZnVuY3Rpb24gZGVlcENsb25lKGl0ZW1zOiBhbnlbXSkge1xuICAgIGxldCBjbG9uZTogYW55W10gPSBbXTtcbiAgICBpdGVtcy5mb3JFYWNoKGl0ZW0gPT4ge1xuICAgICAgICBjbG9uZS5wdXNoKGl0ZW0gaW5zdGFuY2VvZiBBcnJheSA/IGRlZXBDbG9uZShpdGVtKSA6IGl0ZW0uY2xvbmUoKSk7XG4gICAgfSk7XG4gICAgcmV0dXJuIGNsb25lO1xufVxuXG5mdW5jdGlvbiBjb21iaW5lU2ltaWxhclZhbHVlcyhtYXRoOiBNYXRoR3JvdXApe1xuICAgIFxuICAgIGNvbnN0IG9wPW1hdGguZ2V0SXRlbXMoKS5maW5kKHQ9PnQgaW5zdGFuY2VvZiBNYXRoSmF4T3BlcmF0b3IpXG4gICAgaWYoIW9wKXJldHVyblxuICAgIC8qY29uc3QgYT1uZXcgTWF0aE92ZXJ2aWV3KClcbiAgICBhLmRlZmluZUdsb2JhbE92ZXJ2aWV3KG1hdGguZ2V0SXRlbXMoKSlcbiAgICBhLnNlcGFyYXRlSW50b0luZGl2aWR1YWxzKCkqL1xuXG59XG5cblxuY2xhc3MgbWF0aFZhcmlhYmxlc3tcblxufVxuXG5cblxuXG5cblxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW5BcnJheShhcnI6IGFueSkge1xuICAgIGxldCByZXN1bHQgPSBbXTtcbiAgICBsZXQgc3RhY2sgPSBBcnJheS5pc0FycmF5KGFycikgPyBbLi4uYXJyXSA6IFthcnJdO1xuXG4gICAgd2hpbGUgKHN0YWNrLmxlbmd0aCkge1xuICAgICAgICBjb25zdCBuZXh0ID0gc3RhY2sucG9wKCk7XG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5leHQpKSB7XG4gICAgICAgICAgICBzdGFjay5wdXNoKC4uLm5leHQpOyBcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5leHQpO1xuICAgICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQucmV2ZXJzZSgpO1xufVxuIl19