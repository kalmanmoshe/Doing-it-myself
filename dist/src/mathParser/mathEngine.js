import { degreesToRadians } from "./mathUtilities";
import { findParenIndex, Paren, findDeepestParenthesesScope } from "../utils/ParenUtensils";
import { getMathJaxOperatorsByPriority, getValuesWithKeysBySide, searchMathJaxOperators } from "../staticData/dataManager";
import { MathGroup, MathJaxOperator, Token, BasicMathJaxTokens, ensureAcceptableFormatForMathGroupItems, deepSearchWithPath } from "./mathJaxTokens";
const greekLetters = [
    'Alpha', 'alpha', 'Beta', 'Gamma', 'Delta', 'Epsilon', 'Zeta', 'Eta', 'Theta',
    'Iota', 'Kappa', 'Lambda', 'Mu', 'mu', 'Nu', 'Xi', 'Omicron', 'Pi', 'Rho',
    'Sigma', 'Tau', 'Upsilon', 'Phi', 'Chi', 'Psi', 'Omega'
];
/*const latexOperators=[
    'tan', 'sin', 'cos', 'binom', 'frac', 'asin', 'acos',
    'atan', 'arccos', 'arcsin', 'arctan', 'cdot','sqrt'
]*/
export function findConsecutiveSequences(arr) {
    const sequences = [];
    let start = 0;
    for (let i = 1; i <= arr.length; i++) {
        if (arr[i] !== arr[i - 1] + 1) {
            if (i - start > 1) {
                sequences.push(arr.slice(start, i));
            }
            start = i;
        }
    }
    return sequences;
}
export class MathInfo {
    debugInfo = "";
    solutionInfo = [];
    mathInfo = [];
    graph = "";
    mathSnapshots = [];
    addGraphInfo(value) {
        this.graph += value;
    }
    addDebugInfo(msg, value) {
        this.debugInfo += (typeof msg === "object" ? JSON.stringify(msg, null, 1) : msg) + " : " + (typeof value === "object" ? JSON.stringify(value, null, 1) : value) + "\n ";
    }
    addSolutionInfo(mes) {
        this.solutionInfo.push(mes);
        this.addDebugInfo("Solved", mes);
    }
    addMathInfo(msg) {
        this.mathInfo.push(msg);
    }
    addMathSnapshot(math) {
        this.mathSnapshots.push(math);
        const result = deepSearchWithPath(math, (item) => item instanceof MathJaxOperator && item.solution !== undefined);
        if (!result)
            return;
        const customFormatter = (check, string) => {
            if (check instanceof MathJaxOperator && check.solution !== undefined) {
                return `{\\color{red}${string}}`;
            }
            return string;
        };
        this.mathInfo.push(math.toString(customFormatter));
        this.solutionInfo.push(result.item.toStringSolution());
    }
}
function rearrangeEquation(tokens, tokenToisolate) {
}
function isolateMultiplication(tokens, isolatToken) {
}
export class Position {
    operator;
    index;
    start;
    end;
    transition;
    specialChar;
    groups;
    constructor(tokens, index) {
        this.index = index;
        this.transition = this.index;
        this.start = this.index;
        this.end = this.index;
        this.position(tokens);
    }
    position(tokens) {
        this.operator = tokens[this.index].value;
        const metadata = searchMathJaxOperators(this.operator);
        if (!metadata)
            throw new Error(`Operator ${this.operator} not found in metadata`);
        const beforeIndex = [];
        const afterIndex = [];
        getValuesWithKeysBySide(metadata.associativity.positions, true).forEach(() => {
            const item = this.applyPosition(tokens, this.start, true);
            beforeIndex.push(item.mathGroup);
            this.start = item.lastItemOfPrevious;
        });
        getValuesWithKeysBySide(metadata.associativity.positions, false).forEach(() => {
            const item = this.applyPosition(tokens, this.end, false);
            afterIndex.push(item.mathGroup);
            this.end = item.lastItemOfPrevious;
        });
        this.groups = beforeIndex.reverse().concat(afterIndex);
    }
    applyPosition(tokens, index, isLeft) {
        let breakChar = index;
        let target;
        const modifiedIndex = index + (isLeft ? -1 : 1);
        if ((isLeft && index <= 0) || (!isLeft && index >= tokens.length - 1) || !tokens[modifiedIndex]) {
            throw new Error("at applyPosition: \"index wasn't valid\" index: " + index);
        }
        if (tokens[modifiedIndex] instanceof Paren) {
            const parenIndex = findParenIndex(tokens[modifiedIndex], tokens);
            breakChar = isLeft ? parenIndex.open : parenIndex.close + 1;
            // Insure proper formatting removed everything including parentheses
            target = ensureAcceptableFormatForMathGroupItems(tokens.slice(parenIndex.open, parenIndex.close + 1));
        }
        else {
            breakChar = modifiedIndex;
            target = ensureAcceptableFormatForMathGroupItems(tokens[breakChar]);
        }
        if (target?.length === 0) {
            throw new Error(`at applyPosition: couldn't find target token for direction ${isLeft ? 'left' : 'right'} and operator"${tokens[index].value}"`);
        }
        return {
            mathGroup: new MathGroup(target),
            lastItemOfPrevious: breakChar,
        };
    }
}
function parseSafetyChecks(operator) {
    if ((operator.commutative && operator.groups.length < operator.groupNum) || (!operator.commutative && operator.groups.length !== operator.groupNum)) {
        throw new Error(`Invalid number of groups for operator ${operator.operator} expected ${operator.groupNum} but got ${operator.groups.length}`);
    }
}
export function parseOperator(operator) {
    parseSafetyChecks(operator);
    function getOperableValue(group) {
        if (!group || !group.isOperable())
            return null;
        return group.getOperableValue();
    }
    const group1 = getOperableValue(operator.groups[0]);
    const group2 = getOperableValue(operator.groups[1]);
    if (group1 === null || (group2 === null && operator.groups.length > 1))
        return false;
    switch (operator.operator) {
        case "Sine":
            operator.solution = new MathGroup([new Token(Math.sin(degreesToRadians(group1)))]);
            break;
        case "SquareRoot":
            if (group1 < 0) {
                throw new Error("Cannot calculate the square root of a negative number.");
            }
            operator.solution = new MathGroup([new Token(Math.pow(group1, 0.5))]);
            break;
        case "Fraction": {
            if (group2 === 0) {
                throw new Error("Division by zero is not allowed");
            }
            operator.solution = new MathGroup([new Token(group1 / group2)]);
            break;
        }
        case "Power": {
            operator.solution = new MathGroup([new Token(Math.pow(group1, group2))]);
            break;
        }
        default:
            throw new Error(`Unknown operator type in parseOperator: ${operator.operator}`);
    }
    return true;
}
function operationsOrder(tokens) {
    function findOperatorIndex(begin, end, tokens, regex) {
        const index = tokens.slice(begin, end).findIndex((token) => token.type === "operator" && regex.test(token.value));
        return index > -1 ? index + begin : null;
    }
    const { begin, end } = findDeepestParenthesesScope(tokens);
    let priority = null;
    for (let i = 1; i <= 6; i++) {
        priority = findOperatorIndex(begin, end, tokens, getMathJaxOperatorsByPriority(i, true));
        if (priority !== null)
            break;
    }
    return { start: begin, end: end, specificOperatorIndex: priority };
}
export class MathPraiser {
    input = "";
    tokens;
    solution;
    mathInfo = new MathInfo();
    constructor(input) {
        this.input = input;
        this.processInput();
        const tokens = new BasicMathJaxTokens();
        tokens.addInput(this.input);
        //console.log("basicTokens",tokens.clone());
        const basicTokens = tokens.tokens;
        this.convertBasicMathJaxTokenaToMathGroup(basicTokens);
        this.addDebugInfo("convertBasicMathJaxTokenaToMathGroup", this.tokens);
        this.input = this.tokens.toString();
        this.controller();
        this.solution = this.tokens;
        this.addDebugInfo("solution", this.solution);
    }
    parse(tokens) {
        const operatorIndex = tokens.getItems().findIndex(t => t instanceof MathJaxOperator && t.isOperable);
        if (operatorIndex < 0)
            return;
        const operator = tokens.getItems()[operatorIndex];
        operator.groups.forEach(group => {
            this.parse(group);
        });
        operator.parseMathjaxOperator();
        if (!operator.solution) {
            operator.isOperable = false;
            return;
        }
        this.mathInfo.addMathSnapshot(this.tokens.clone());
        tokens.replaceItemCell(operator.solution, operatorIndex);
    }
    controller() {
        this.parse(this.tokens);
        combineSimilarValues(this.tokens);
        this.tokens.combiningLikeTerms();
    }
    solutionToString() {
        return (this.tokens.toString()) || "";
    }
    addDebugInfo(mes, value) {
        this.mathInfo.addDebugInfo(mes, value);
    }
    processInput() {
        this.input = this.input
            .replace(/(Math.|\\|\s|left|right)/g, "")
            .replace(/{/g, "(")
            .replace(/}/g, ")");
        //.replace(/(?<!\\|[a-zA-Z])(tan|sin|cos|binom|frac|asin|acos|atan|arccos|arcsin|arctan|cdot)/g, "\\$1");
    }
    finalReturn() {
        // return this.tokens.reconstruct()
    }
    defineGroupsAndOperators(tokens) {
        const range = operationsOrder(tokens);
        if (range.start === null || range.end === null)
            return false;
        if (range.specificOperatorIndex === null && range.start === 0 && range.end === tokens.length)
            return true;
        let newMathGroupSuccess = null;
        if (range.specificOperatorIndex !== null)
            newMathGroupSuccess = this.createOperatorItemFromTokens(tokens, range.specificOperatorIndex);
        else
            newMathGroupSuccess = this.createMathGroupInsertFromTokens(tokens, range.start, range.end);
        if (!newMathGroupSuccess)
            return false;
        return this.defineGroupsAndOperators(tokens);
    }
    convertBasicMathJaxTokenaToMathGroup(basicTokens) {
        const success = this.defineGroupsAndOperators(basicTokens);
        if (!success)
            return;
        const GroupedBasicTokens = basicTokens.filter((t) => !(t instanceof Paren));
        this.tokens = new MathGroup(GroupedBasicTokens);
    }
    createMathGroupInsertFromTokens(tokens, start, end) {
        const newMathGroup = new MathGroup(ensureAcceptableFormatForMathGroupItems(tokens.slice(start, end + 1)));
        tokens.splice(start, (end - start) + 1, newMathGroup);
        return true;
    }
    createOperatorItemFromTokens(tokens, index) {
        const metadata = searchMathJaxOperators(tokens[index].value);
        if (!metadata)
            throw new Error(`Operator ${tokens[index].value} not found in metadata`);
        const position = new Position(tokens, index);
        const newOperator = MathJaxOperator.create(position.operator, metadata.associativity.numPositions, position.groups);
        tokens.splice(position.start, (position.end - position.start) + 1, newOperator);
        return true;
    }
}
function deepClone(items) {
    let clone = [];
    items.forEach(item => {
        clone.push(item instanceof Array ? deepClone(item) : item.clone());
    });
    return clone;
}
function combineSimilarValues(math) {
    const op = math.getItems().find(t => t instanceof MathJaxOperator);
    if (!op)
        return;
    /*const a=new MathOverview()
    a.defineGlobalOverview(math.getItems())
    a.separateIntoIndividuals()*/
}
class mathVariables {
}
export function flattenArray(arr) {
    let result = [];
    let stack = Array.isArray(arr) ? [...arr] : [arr];
    while (stack.length) {
        const next = stack.pop();
        if (Array.isArray(next)) {
            stack.push(...next);
        }
        else {
            result.push(next);
        }
    }
    return result.reverse();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWF0aEVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYXRoUGFyc2VyL21hdGhFbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUF1QyxnQkFBZ0IsRUFBc0MsTUFBTSxpQkFBaUIsQ0FBQztBQUU1SCxPQUFPLEVBQUUsY0FBYyxFQUFFLEtBQUssRUFBZ0IsMkJBQTJCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUMxRyxPQUFPLEVBQTJCLDZCQUE2QixFQUErQix1QkFBdUIsRUFBMEQsc0JBQXNCLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUN6TyxPQUFPLEVBQUUsU0FBUyxFQUFFLGVBQWUsRUFBRSxLQUFLLEVBQUUsa0JBQWtCLEVBQUUsdUNBQXVDLEVBQUUsa0JBQWtCLEVBQWlCLE1BQU0saUJBQWlCLENBQUM7QUFFcEssTUFBTSxZQUFZLEdBQUc7SUFDakIsT0FBTyxFQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxPQUFPO0lBQzVFLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBQyxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsSUFBSSxFQUFFLEtBQUs7SUFDeEUsT0FBTyxFQUFFLEtBQUssRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsT0FBTztDQUMxRCxDQUFDO0FBQ0Y7OztHQUdHO0FBRUgsTUFBTSxVQUFVLHdCQUF3QixDQUFDLEdBQVU7SUFDL0MsTUFBTSxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ3JCLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztJQUNkLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFD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Q0FBQztBQUdELE1BQU0sYUFBYTtDQUVsQjtBQVVELE1BQU0sVUFBVSxZQUFZLENBQUMsR0FBUTtJQUNqQyxJQUFJLE1BQU0sR0FBRyxFQUFFLENBQUM7SUFDaEIsSUFBSSxLQUFLLEdBQUcsS0FBSyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRWxELE9BQU8sS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2xCLE1BQU0sSUFBSSxHQUFHLEtBQUssQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN6QixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUN0QixLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDeEIsQ0FBQzthQUFNLENBQUM7WUFDSixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3RCLENBQUM7SUFDTCxDQUFDO0lBQ0QsT0FBTyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUM7QUFDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlxyXG5pbXBvcnQgeyBxdWFkLGNhbGN1bGF0ZUJpbm9tLHJvdW5kQnlTZXR0aW5ncyAsZGVncmVlc1RvUmFkaWFucyxyYWRpYW5zVG9EZWdyZWVzLCBjYWxjdWxhdGVGYWN0b3JpYWx9IGZyb20gXCIuL21hdGhVdGlsaXRpZXNcIjtcclxuXHJcbmltcG9ydCB7IGZpbmRQYXJlbkluZGV4LCBQYXJlbixpZFBhcmVudGhlc2VzLCBmaW5kRGVlcGVzdFBhcmVudGhlc2VzU2NvcGUgfSBmcm9tIFwiLi4vdXRpbHMvUGFyZW5VdGVuc2lsc1wiO1xyXG5pbXBvcnQgeyBnZXRBbGxNYXRoSmF4UmVmZXJlbmNlcywgZ2V0TWF0aEpheE9wZXJhdG9yc0J5UHJpb3JpdHksIGdldE9wZXJhdG9yc0J5QXNzb2NpYXRpdml0eSwgZ2V0VmFsdWVzV2l0aEtleXNCeVNpZGUsIGhhc0ltcGxpY2l0TXVsdGlwbGljYXRpb24sIGlzT3BlcmF0b3JXaXRoQXNzb2NpYXRpdml0eSwgc2VhcmNoTWF0aEpheE9wZXJhdG9ycyB9IGZyb20gXCIuLi9zdGF0aWNEYXRhL2RhdGFNYW5hZ2VyXCI7XHJcbmltcG9ydCB7IE1hdGhHcm91cCwgTWF0aEpheE9wZXJhdG9yLCBUb2tlbiwgQmFzaWNNYXRoSmF4VG9rZW5zLCBlbnN1cmVBY2NlcHRhYmxlRm9ybWF0Rm9yTWF0aEdyb3VwSXRlbXMsIGRlZXBTZWFyY2hXaXRoUGF0aCwgTWF0aEdyb3VwSXRlbSB9IGZyb20gXCIuL21hdGhKYXhUb2tlbnNcIjtcclxuaW1wb3J0IHsgQmFzaWNNYXRoSmF4VG9rZW4gfSBmcm9tIFwic3JjL2Jhc2ljVG9rZW5cIjtcclxuY29uc3QgZ3JlZWtMZXR0ZXJzID0gW1xyXG4gICAgJ0FscGhhJywnYWxwaGEnLCAnQmV0YScsICdHYW1tYScsICdEZWx0YScsICdFcHNpbG9uJywgJ1pldGEnLCAnRXRhJywgJ1RoZXRhJywgXHJcbiAgICAnSW90YScsICdLYXBwYScsICdMYW1iZGEnLCAnTXUnLCdtdScsICdOdScsICdYaScsICdPbWljcm9uJywgJ1BpJywgJ1JobycsIFxyXG4gICAgJ1NpZ21hJywgJ1RhdScsICdVcHNpbG9uJywgJ1BoaScsICdDaGknLCAnUHNpJywgJ09tZWdhJ1xyXG5dO1xyXG4vKmNvbnN0IGxhdGV4T3BlcmF0b3JzPVtcclxuICAgICd0YW4nLCAnc2luJywgJ2NvcycsICdiaW5vbScsICdmcmFjJywgJ2FzaW4nLCAnYWNvcycsIFxyXG4gICAgJ2F0YW4nLCAnYXJjY29zJywgJ2FyY3NpbicsICdhcmN0YW4nLCAnY2RvdCcsJ3NxcnQnXHJcbl0qL1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRDb25zZWN1dGl2ZVNlcXVlbmNlcyhhcnI6IGFueVtdKSB7XHJcbiAgICBjb25zdCBzZXF1ZW5jZXMgPSBbXTtcclxuICAgIGxldCBzdGFydCA9IDA7XHJcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBhcnIubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpZiAoYXJyW2ldICE9PSBhcnJbaSAtIDFdICsgMSkge1xyXG4gICAgICAgICAgICBpZiAoaSAtIHN0YXJ0ID4gMSkge1xyXG4gICAgICAgICAgICAgICAgc2VxdWVuY2VzLnB1c2goYXJyLnNsaWNlKHN0YXJ0LCBpKSk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgc3RhcnQgPSBpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBzZXF1ZW5jZXM7XHJcbn1cclxuXHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIE1hdGhJbmZve1xyXG4gICAgZGVidWdJbmZvOiBzdHJpbmc9XCJcIjtcclxuICAgIHNvbHV0aW9uSW5mbzogYW55W109W107XHJcbiAgICBtYXRoSW5mbzogYW55W109W11cclxuICAgIGdyYXBoOiBzdHJpbmc9XCJcIjtcclxuICAgIG1hdGhTbmFwc2hvdHM6IE1hdGhHcm91cFtdPVtdXHJcbiAgICBhZGRHcmFwaEluZm8odmFsdWU6IHN0cmluZyl7XHJcbiAgICAgICAgdGhpcy5ncmFwaCs9dmFsdWU7XHJcbiAgICB9XHJcbiAgICBhZGREZWJ1Z0luZm8obXNnOiBzdHJpbmcsIHZhbHVlOiBhbnkpe1xyXG4gICAgICAgIHRoaXMuZGVidWdJbmZvKz0odHlwZW9mIG1zZz09PVwib2JqZWN0XCI/SlNPTi5zdHJpbmdpZnkobXNnLG51bGwsMSk6bXNnKStcIiA6IFwiKyh0eXBlb2YgdmFsdWU9PT1cIm9iamVjdFwiP0pTT04uc3RyaW5naWZ5KHZhbHVlLG51bGwsMSk6dmFsdWUpKyBcIlxcbiBcIjtcclxuICAgIH1cclxuICAgIGFkZFNvbHV0aW9uSW5mbyhtZXM6IHN0cmluZyl7XHJcbiAgICAgICAgdGhpcy5zb2x1dGlvbkluZm8ucHVzaChtZXMpO1xyXG4gICAgICAgIHRoaXMuYWRkRGVidWdJbmZvKFwiU29sdmVkXCIsbWVzKTtcclxuICAgIH1cclxuICAgIGFkZE1hdGhJbmZvKG1zZzogc3RyaW5nKXtcclxuICAgICAgICB0aGlzLm1hdGhJbmZvLnB1c2gobXNnKVxyXG4gICAgfVxyXG4gICAgYWRkTWF0aFNuYXBzaG90KG1hdGg6IE1hdGhHcm91cCl7XHJcbiAgICAgICAgdGhpcy5tYXRoU25hcHNob3RzLnB1c2gobWF0aClcclxuICAgICAgICBjb25zdCByZXN1bHQgPSBkZWVwU2VhcmNoV2l0aFBhdGgoXHJcbiAgICAgICAgICAgIG1hdGgsXHJcbiAgICAgICAgICAgIChpdGVtKSA9PiBpdGVtIGluc3RhbmNlb2YgTWF0aEpheE9wZXJhdG9yICYmIGl0ZW0uc29sdXRpb24gIT09IHVuZGVmaW5lZFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgaWYoIXJlc3VsdClyZXR1cm5cclxuXHJcbiAgICAgICAgY29uc3QgY3VzdG9tRm9ybWF0dGVyID0gKGNoZWNrOiBhbnksc3RyaW5nOiBzdHJpbmcpOiBzdHJpbmcgPT4ge1xyXG4gICAgICAgICAgICBpZiAoY2hlY2sgaW5zdGFuY2VvZiBNYXRoSmF4T3BlcmF0b3IgJiYgY2hlY2suc29sdXRpb24gIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGB7XFxcXGNvbG9ye3JlZH0ke3N0cmluZ319YDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gc3RyaW5nXHJcbiAgICAgICAgfTtcclxuICAgICAgICB0aGlzLm1hdGhJbmZvLnB1c2gobWF0aC50b1N0cmluZyhjdXN0b21Gb3JtYXR0ZXIpKVxyXG4gICAgICAgIHRoaXMuc29sdXRpb25JbmZvLnB1c2gocmVzdWx0Lml0ZW0udG9TdHJpbmdTb2x1dGlvbigpKVxyXG4gICAgICAgIFxyXG4gICAgfVxyXG5cclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcbmZ1bmN0aW9uIHJlYXJyYW5nZUVxdWF0aW9uKHRva2VuczogYW55LHRva2VuVG9pc29sYXRlOiBhbnkpe1xyXG4gICAgXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzb2xhdGVNdWx0aXBsaWNhdGlvbih0b2tlbnM6IGFueSxpc29sYXRUb2tlbjogVG9rZW4pey8qXHJcbiAgICBjb25zdCBpbmRleD1vcGVyYXRpb25zT3JkZXIodG9rZW5zKVxyXG4gICAgY29uc3QgSXNvbGF0ZWQ9dG9rZW5zLnRva2Vucy5maW5kKCh0b2tlbjogYW55LCBpZHg6IG51bWJlcik9PmlkeDxpbmRleClcclxuICAgIGNvbnN0IGZyYWM9Y3JlYXRlRnJhYyh0b2tlbnMubGlzdC5zbGljZShpbmRleCArIDEpLG5ldyBUb2tlbihJc29sYXRlZC52YWx1ZSkpXHJcbiAgICBJc29sYXRlZC52YWx1ZT0xO1xyXG4gICAgdG9rZW5zLmluc2VydFRva2VucyhpbmRleCsxLHRva2Vucy50b2tlbnMubGVuZ3RoLWluZGV4KzEsZnJhYykqL1xyXG59XHJcblxyXG5cclxuXHJcbmV4cG9ydCBjbGFzcyBQb3NpdGlvbiB7XHJcbiAgICBvcGVyYXRvcjogc3RyaW5nO1xyXG4gICAgaW5kZXg6IG51bWJlcjtcclxuICAgIHN0YXJ0OiBudW1iZXI7XHJcbiAgICBlbmQ6IG51bWJlcjtcclxuICAgIHRyYW5zaXRpb246IG51bWJlcjtcclxuICAgIHNwZWNpYWxDaGFyOiBzdHJpbmc7XHJcbiAgICBcclxuICAgIGdyb3VwczogTWF0aEdyb3VwW107XHJcbiAgICBjb25zdHJ1Y3Rvcih0b2tlbnM6IGFueVtdLCBpbmRleDogbnVtYmVyKXtcclxuICAgICAgICB0aGlzLmluZGV4ID0gaW5kZXg7XHJcbiAgICAgICAgdGhpcy50cmFuc2l0aW9uID0gdGhpcy5pbmRleDtcclxuICAgICAgICB0aGlzLnN0YXJ0ID0gdGhpcy5pbmRleDtcclxuICAgICAgICB0aGlzLmVuZCA9IHRoaXMuaW5kZXg7XHJcbiAgICAgICAgdGhpcy5wb3NpdGlvbih0b2tlbnMpXHJcbiAgICB9XHJcbiAgICBwb3NpdGlvbih0b2tlbnM6IGFueVtdKSB7XHJcbiAgICAgICAgdGhpcy5vcGVyYXRvciA9IHRva2Vuc1t0aGlzLmluZGV4XS52YWx1ZTtcclxuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IHNlYXJjaE1hdGhKYXhPcGVyYXRvcnModGhpcy5vcGVyYXRvcik7XHJcbiAgICAgICAgaWYgKCFtZXRhZGF0YSkgdGhyb3cgbmV3IEVycm9yKGBPcGVyYXRvciAke3RoaXMub3BlcmF0b3J9IG5vdCBmb3VuZCBpbiBtZXRhZGF0YWApO1xyXG4gICAgXHJcbiAgICAgICAgY29uc3QgYmVmb3JlSW5kZXg6IE1hdGhHcm91cFtdID0gW107XHJcbiAgICAgICAgY29uc3QgYWZ0ZXJJbmRleDogIE1hdGhHcm91cFtdID0gW107XHJcbiAgICBcclxuICAgICAgICBnZXRWYWx1ZXNXaXRoS2V5c0J5U2lkZShtZXRhZGF0YS5hc3NvY2lhdGl2aXR5LnBvc2l0aW9ucywgdHJ1ZSkuZm9yRWFjaCgoKSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSB0aGlzLmFwcGx5UG9zaXRpb24odG9rZW5zLCB0aGlzLnN0YXJ0LCB0cnVlKTtcclxuICAgICAgICAgICAgYmVmb3JlSW5kZXgucHVzaChpdGVtLm1hdGhHcm91cCk7XHJcbiAgICAgICAgICAgIHRoaXMuc3RhcnQgPSBpdGVtLmxhc3RJdGVtT2ZQcmV2aW91cztcclxuICAgICAgICB9KTtcclxuICAgIFxyXG4gICAgXHJcbiAgICAgICAgZ2V0VmFsdWVzV2l0aEtleXNCeVNpZGUobWV0YWRhdGEuYXNzb2NpYXRpdml0eS5wb3NpdGlvbnMsIGZhbHNlKS5mb3JFYWNoKCgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgaXRlbSA9IHRoaXMuYXBwbHlQb3NpdGlvbih0b2tlbnMsIHRoaXMuZW5kLCBmYWxzZSk7XHJcbiAgICAgICAgICAgIGFmdGVySW5kZXgucHVzaChpdGVtLm1hdGhHcm91cCk7XHJcbiAgICAgICAgICAgIHRoaXMuZW5kID0gaXRlbS5sYXN0SXRlbU9mUHJldmlvdXM7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5ncm91cHMgPSBiZWZvcmVJbmRleC5yZXZlcnNlKCkuY29uY2F0KGFmdGVySW5kZXgpO1xyXG4gICAgfVxyXG4gICAgYXBwbHlQb3NpdGlvbih0b2tlbnM6IGFueVtdLCBpbmRleDogIG51bWJlciwgaXNMZWZ0OiBib29sZWFuKSB7XHJcbiAgICAgICAgbGV0IGJyZWFrQ2hhcj1pbmRleFxyXG4gICAgICAgIGxldCB0YXJnZXQ6IGFueTtcclxuICAgICAgICBjb25zdCBtb2RpZmllZEluZGV4ID0gIGluZGV4Kyhpc0xlZnQ/LSAxIDogIDEpO1xyXG5cclxuICAgICAgICBpZiAoKGlzTGVmdCAmJiBpbmRleCA8PSAwKSB8fCAoIWlzTGVmdCAmJiBpbmRleCA+PSB0b2tlbnMubGVuZ3RoIC0gMSkgfHwgIXRva2Vuc1ttb2RpZmllZEluZGV4XSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJhdCBhcHBseVBvc2l0aW9uOiBcXFwiaW5kZXggd2Fzbid0IHZhbGlkXFxcIiBpbmRleDogXCIraW5kZXgpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHRva2Vuc1ttb2RpZmllZEluZGV4XSBpbnN0YW5jZW9mIFBhcmVuKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVuSW5kZXggPSBmaW5kUGFyZW5JbmRleCh0b2tlbnNbbW9kaWZpZWRJbmRleF0sdG9rZW5zKTtcclxuICAgICAgICAgICAgYnJlYWtDaGFyID0gIGlzTGVmdCA/IHBhcmVuSW5kZXgub3BlbiA6IHBhcmVuSW5kZXguY2xvc2UrMTtcclxuICAgICAgICAgICAgLy8gSW5zdXJlIHByb3BlciBmb3JtYXR0aW5nIHJlbW92ZWQgZXZlcnl0aGluZyBpbmNsdWRpbmcgcGFyZW50aGVzZXNcclxuICAgICAgICAgICAgdGFyZ2V0ID0gZW5zdXJlQWNjZXB0YWJsZUZvcm1hdEZvck1hdGhHcm91cEl0ZW1zKHRva2Vucy5zbGljZShwYXJlbkluZGV4Lm9wZW4sIHBhcmVuSW5kZXguY2xvc2UrMSkpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIGJyZWFrQ2hhcj1tb2RpZmllZEluZGV4O1xyXG4gICAgICAgICAgICB0YXJnZXQgPSBlbnN1cmVBY2NlcHRhYmxlRm9ybWF0Rm9yTWF0aEdyb3VwSXRlbXModG9rZW5zW2JyZWFrQ2hhcl0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGFyZ2V0Py5sZW5ndGg9PT0wKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgYXQgYXBwbHlQb3NpdGlvbjogY291bGRuJ3QgZmluZCB0YXJnZXQgdG9rZW4gZm9yIGRpcmVjdGlvbiAke2lzTGVmdD8nbGVmdCc6J3JpZ2h0J30gYW5kIG9wZXJhdG9yXCIke3Rva2Vuc1tpbmRleF0udmFsdWV9XCJgLCk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBtYXRoR3JvdXA6IG5ldyBNYXRoR3JvdXAodGFyZ2V0KSxcclxuICAgICAgICAgICAgbGFzdEl0ZW1PZlByZXZpb3VzOiBicmVha0NoYXIsXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gcGFyc2VTYWZldHlDaGVja3Mob3BlcmF0b3I6IE1hdGhKYXhPcGVyYXRvcil7XHJcbiAgICBpZiAoKG9wZXJhdG9yLmNvbW11dGF0aXZlJiZvcGVyYXRvci5ncm91cHMubGVuZ3RoPG9wZXJhdG9yLmdyb3VwTnVtKXx8KCFvcGVyYXRvci5jb21tdXRhdGl2ZSYmb3BlcmF0b3IuZ3JvdXBzLmxlbmd0aCE9PW9wZXJhdG9yLmdyb3VwTnVtKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBudW1iZXIgb2YgZ3JvdXBzIGZvciBvcGVyYXRvciAke29wZXJhdG9yLm9wZXJhdG9yfSBleHBlY3RlZCAke29wZXJhdG9yLmdyb3VwTnVtfSBidXQgZ290ICR7b3BlcmF0b3IuZ3JvdXBzLmxlbmd0aH1gKTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlT3BlcmF0b3Iob3BlcmF0b3I6IE1hdGhKYXhPcGVyYXRvcik6IGJvb2xlYW4ge1xyXG4gICAgcGFyc2VTYWZldHlDaGVja3Mob3BlcmF0b3IpOyBcclxuICAgIGZ1bmN0aW9uIGdldE9wZXJhYmxlVmFsdWUoZ3JvdXA6IE1hdGhHcm91cCk6IG51bWJlciB8IG51bGwge1xyXG4gICAgICAgIGlmICghZ3JvdXB8fCFncm91cC5pc09wZXJhYmxlKCkpIHJldHVybiBudWxsO1xyXG4gICAgICAgIHJldHVybiBncm91cC5nZXRPcGVyYWJsZVZhbHVlKCk7XHJcbiAgICB9XHJcbiAgICBjb25zdCBncm91cDEgPSBnZXRPcGVyYWJsZVZhbHVlKG9wZXJhdG9yLmdyb3Vwc1swXSk7XHJcbiAgICBjb25zdCBncm91cDIgPSBnZXRPcGVyYWJsZVZhbHVlKG9wZXJhdG9yLmdyb3Vwc1sxXSk7XHJcbiAgICBpZiAoZ3JvdXAxID09PSBudWxsfHwoZ3JvdXAyPT09bnVsbCYmb3BlcmF0b3IuZ3JvdXBzLmxlbmd0aD4xKSkgcmV0dXJuIGZhbHNlO1xyXG4gICAgXHJcbiAgICBzd2l0Y2ggKG9wZXJhdG9yLm9wZXJhdG9yKSB7XHJcbiAgICAgICAgY2FzZSBcIlNpbmVcIjpcclxuICAgICAgICAgICAgb3BlcmF0b3Iuc29sdXRpb24gPSBuZXcgTWF0aEdyb3VwKFtuZXcgVG9rZW4oTWF0aC5zaW4oZGVncmVlc1RvUmFkaWFucyhncm91cDEpKSldKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBcIlNxdWFyZVJvb3RcIjpcclxuICAgICAgICAgICAgaWYgKGdyb3VwMSA8IDApIHtcclxuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBjYWxjdWxhdGUgdGhlIHNxdWFyZSByb290IG9mIGEgbmVnYXRpdmUgbnVtYmVyLlwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcGVyYXRvci5zb2x1dGlvbiA9IG5ldyBNYXRoR3JvdXAoW25ldyBUb2tlbihNYXRoLnBvdyhncm91cDEsMC41KSldKTtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSBcIkZyYWN0aW9uXCI6IHtcclxuICAgICAgICAgICAgaWYgKGdyb3VwMiA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiRGl2aXNpb24gYnkgemVybyBpcyBub3QgYWxsb3dlZFwiKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBvcGVyYXRvci5zb2x1dGlvbiA9IG5ldyBNYXRoR3JvdXAoW25ldyBUb2tlbihncm91cDEgLyBncm91cDIhKV0pO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgY2FzZSBcIlBvd2VyXCI6IHtcclxuICAgICAgICAgICAgb3BlcmF0b3Iuc29sdXRpb24gPSBuZXcgTWF0aEdyb3VwKFtuZXcgVG9rZW4oTWF0aC5wb3coZ3JvdXAxLGdyb3VwMiEpKV0pO1xyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgYFVua25vd24gb3BlcmF0b3IgdHlwZSBpbiBwYXJzZU9wZXJhdG9yOiAke29wZXJhdG9yLm9wZXJhdG9yfWBcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgXHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxufVxyXG5cclxuXHJcblxyXG5cclxuZnVuY3Rpb24gb3BlcmF0aW9uc09yZGVyKHRva2VuczogYW55W10pIHtcclxuICAgIGZ1bmN0aW9uIGZpbmRPcGVyYXRvckluZGV4KGJlZ2luOiBudW1iZXIsIGVuZDogbnVtYmVyLCB0b2tlbnM6IGFueSwgcmVnZXg/OiBhbnkpIHtcclxuICAgICAgICBjb25zdCBpbmRleD10b2tlbnMuc2xpY2UoYmVnaW4sIGVuZCkuZmluZEluZGV4KCh0b2tlbjogeyB0eXBlOiBzdHJpbmc7IHZhbHVlOiBhbnk7IH0pID0+IHRva2VuLnR5cGUgPT09IFwib3BlcmF0b3JcIiAmJiByZWdleC50ZXN0KHRva2VuLnZhbHVlKSk7XHJcbiAgICAgICAgcmV0dXJuIGluZGV4Pi0xP2luZGV4K2JlZ2luOm51bGw7XHJcbiAgICB9XHJcbiAgICBjb25zdCB7IGJlZ2luLCBlbmQgfSA9IGZpbmREZWVwZXN0UGFyZW50aGVzZXNTY29wZSh0b2tlbnMpO1xyXG4gICAgbGV0IHByaW9yaXR5PW51bGxcclxuICAgIGZvciAobGV0IGk9MTtpPD02O2krKyl7XHJcbiAgICAgICAgcHJpb3JpdHkgPSBmaW5kT3BlcmF0b3JJbmRleChiZWdpbiAsIGVuZCx0b2tlbnMsIGdldE1hdGhKYXhPcGVyYXRvcnNCeVByaW9yaXR5KGksdHJ1ZSkpO1xyXG4gICAgICAgIGlmKHByaW9yaXR5IT09bnVsbClicmVhaztcclxuICAgIH1cclxuICAgIHJldHVybiB7c3RhcnQ6IGJlZ2luLGVuZDogZW5kLHNwZWNpZmljT3BlcmF0b3JJbmRleDogcHJpb3JpdHl9XHJcbn1cclxuXHJcbmV4cG9ydCBjbGFzcyBNYXRoUHJhaXNlcntcclxuICAgIGlucHV0PVwiXCI7XHJcbiAgICB0b2tlbnM6IE1hdGhHcm91cDtcclxuICAgIHNvbHV0aW9uOiBhbnk7XHJcbiAgICBtYXRoSW5mbz1uZXcgTWF0aEluZm8oKTtcclxuICAgIGNvbnN0cnVjdG9yKGlucHV0OiBzdHJpbmcpe1xyXG4gICAgICAgIHRoaXMuaW5wdXQ9aW5wdXQ7XHJcbiAgICAgICAgdGhpcy5wcm9jZXNzSW5wdXQoKTtcclxuICAgICAgICBcclxuICAgICAgICBjb25zdCB0b2tlbnM9bmV3IEJhc2ljTWF0aEpheFRva2VucygpO1xyXG4gICAgICAgIHRva2Vucy5hZGRJbnB1dCh0aGlzLmlucHV0KVxyXG4gICAgICAgIC8vY29uc29sZS5sb2coXCJiYXNpY1Rva2Vuc1wiLHRva2Vucy5jbG9uZSgpKTtcclxuICAgICAgICBjb25zdCBiYXNpY1Rva2Vucz10b2tlbnMudG9rZW5zXHJcbiAgICAgICAgdGhpcy5jb252ZXJ0QmFzaWNNYXRoSmF4VG9rZW5hVG9NYXRoR3JvdXAoYmFzaWNUb2tlbnMpXHJcbiAgICAgICAgXHJcbiAgICAgICAgdGhpcy5hZGREZWJ1Z0luZm8oXCJjb252ZXJ0QmFzaWNNYXRoSmF4VG9rZW5hVG9NYXRoR3JvdXBcIix0aGlzLnRva2VucylcclxuICAgICAgICBcclxuICAgICAgICB0aGlzLmlucHV0PXRoaXMudG9rZW5zLnRvU3RyaW5nKClcclxuICAgICAgICB0aGlzLmNvbnRyb2xsZXIoKTtcclxuICAgICAgICB0aGlzLnNvbHV0aW9uPXRoaXMudG9rZW5zXHJcbiAgICAgICAgdGhpcy5hZGREZWJ1Z0luZm8oXCJzb2x1dGlvblwiLHRoaXMuc29sdXRpb24pO1xyXG4gICAgfVxyXG5cclxuICAgIFxyXG4gICAgcGFyc2UodG9rZW5zOiBNYXRoR3JvdXApOiB2b2lkIHtcclxuICAgICAgICBjb25zdCBvcGVyYXRvckluZGV4PXRva2Vucy5nZXRJdGVtcygpLmZpbmRJbmRleChcclxuICAgICAgICAgICAgdCA9PiB0IGluc3RhbmNlb2YgTWF0aEpheE9wZXJhdG9yICYmIHQuaXNPcGVyYWJsZVxyXG4gICAgICAgICkgO1xyXG4gICAgICAgIGlmIChvcGVyYXRvckluZGV4PDApIHJldHVybjtcclxuICAgICAgICBjb25zdCBvcGVyYXRvciA9IHRva2Vucy5nZXRJdGVtcygpW29wZXJhdG9ySW5kZXhdIGFzIE1hdGhKYXhPcGVyYXRvclxyXG4gICAgXHJcbiAgICAgICAgXHJcbiAgICAgICAgb3BlcmF0b3IuZ3JvdXBzLmZvckVhY2goZ3JvdXAgPT4ge1xyXG4gICAgICAgICAgICB0aGlzLnBhcnNlKGdyb3VwKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBvcGVyYXRvci5wYXJzZU1hdGhqYXhPcGVyYXRvcigpXHJcbiAgICAgICAgaWYgKCFvcGVyYXRvci5zb2x1dGlvbikge1xyXG4gICAgICAgICAgICBvcGVyYXRvci5pc09wZXJhYmxlID0gZmFsc2U7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5tYXRoSW5mby5hZGRNYXRoU25hcHNob3QodGhpcy50b2tlbnMuY2xvbmUoKSlcclxuICAgICAgICB0b2tlbnMucmVwbGFjZUl0ZW1DZWxsKG9wZXJhdG9yLnNvbHV0aW9uLG9wZXJhdG9ySW5kZXgpOyBcclxuICAgIH1cclxuICAgIFxyXG4gICAgY29udHJvbGxlcigpOiBhbnl7XHJcbiAgICAgICAgdGhpcy5wYXJzZSh0aGlzLnRva2VucylcclxuICAgICAgICBjb21iaW5lU2ltaWxhclZhbHVlcyh0aGlzLnRva2VucylcclxuICAgICAgICB0aGlzLnRva2Vucy5jb21iaW5pbmdMaWtlVGVybXMoKVxyXG5cclxuICAgIH1cclxuICAgIHNvbHV0aW9uVG9TdHJpbmcoKXtcclxuICAgICAgICByZXR1cm4gKHRoaXMudG9rZW5zLnRvU3RyaW5nKCkpfHxcIlwiXHJcbiAgICB9XHJcblxyXG4gICAgYWRkRGVidWdJbmZvKG1lczogc3RyaW5nLHZhbHVlOiBhbnkpe1xyXG4gICAgICAgIHRoaXMubWF0aEluZm8uYWRkRGVidWdJbmZvKG1lcyx2YWx1ZSlcclxuICAgIH1cclxuICAgIHByb2Nlc3NJbnB1dCgpe1xyXG4gICAgICAgIHRoaXMuaW5wdXQ9dGhpcy5pbnB1dFxyXG4gICAgICAgIC5yZXBsYWNlKC8oTWF0aC58XFxcXHxcXHN8bGVmdHxyaWdodCkvZywgXCJcIikgXHJcbiAgICAgICAgLnJlcGxhY2UoL3svZywgXCIoXCIpXHJcbiAgICAgICAgLnJlcGxhY2UoL30vZywgXCIpXCIpXHJcbiAgICAgICAgLy8ucmVwbGFjZSgvKD88IVxcXFx8W2EtekEtWl0pKHRhbnxzaW58Y29zfGJpbm9tfGZyYWN8YXNpbnxhY29zfGF0YW58YXJjY29zfGFyY3NpbnxhcmN0YW58Y2RvdCkvZywgXCJcXFxcJDFcIik7XHJcbiAgICB9XHJcbiAgICBmaW5hbFJldHVybigpe1xyXG4gICAgICAgLy8gcmV0dXJuIHRoaXMudG9rZW5zLnJlY29uc3RydWN0KClcclxuICAgIH1cclxuICAgIGRlZmluZUdyb3Vwc0FuZE9wZXJhdG9ycyh0b2tlbnM6IEFycmF5PGFueT4pOmJvb2xlYW58dGhpc3tcclxuICAgICAgICBjb25zdCByYW5nZT1vcGVyYXRpb25zT3JkZXIodG9rZW5zKTtcclxuICAgICAgICBpZihyYW5nZS5zdGFydD09PW51bGx8fHJhbmdlLmVuZD09PW51bGwpcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIGlmKHJhbmdlLnNwZWNpZmljT3BlcmF0b3JJbmRleD09PW51bGwmJnJhbmdlLnN0YXJ0PT09MCYmcmFuZ2UuZW5kPT09dG9rZW5zLmxlbmd0aClyZXR1cm4gdHJ1ZTtcclxuICAgICAgICBsZXQgbmV3TWF0aEdyb3VwU3VjY2Vzcz1udWxsXHJcbiAgICAgICAgaWYgKHJhbmdlLnNwZWNpZmljT3BlcmF0b3JJbmRleCE9PW51bGwpXHJcbiAgICAgICAgICAgIG5ld01hdGhHcm91cFN1Y2Nlc3M9dGhpcy5jcmVhdGVPcGVyYXRvckl0ZW1Gcm9tVG9rZW5zKHRva2VucyxyYW5nZS5zcGVjaWZpY09wZXJhdG9ySW5kZXgpXHJcbiAgICAgICAgZWxzZVxyXG4gICAgICAgIG5ld01hdGhHcm91cFN1Y2Nlc3M9dGhpcy5jcmVhdGVNYXRoR3JvdXBJbnNlcnRGcm9tVG9rZW5zKHRva2VucyxyYW5nZS5zdGFydCxyYW5nZS5lbmQpXHJcbiAgICAgICAgaWYoIW5ld01hdGhHcm91cFN1Y2Nlc3MpcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIHJldHVybiB0aGlzLmRlZmluZUdyb3Vwc0FuZE9wZXJhdG9ycyh0b2tlbnMpO1xyXG4gICAgfVxyXG4gICAgY29udmVydEJhc2ljTWF0aEpheFRva2VuYVRvTWF0aEdyb3VwKGJhc2ljVG9rZW5zOiBBcnJheTxCYXNpY01hdGhKYXhUb2tlbnxQYXJlbj4pOnZvaWR7XHJcbiAgICAgICAgY29uc3Qgc3VjY2Vzcz10aGlzLmRlZmluZUdyb3Vwc0FuZE9wZXJhdG9ycyhiYXNpY1Rva2VucylcclxuICAgICAgICBpZighc3VjY2VzcylyZXR1cm5cclxuICAgICAgICBjb25zdCBHcm91cGVkQmFzaWNUb2tlbnM6IE1hdGhHcm91cEl0ZW1bXT0oYmFzaWNUb2tlbnMuZmlsdGVyKCh0KSA9PiAhKHQgaW5zdGFuY2VvZiBQYXJlbikpYXMgYW55KVxyXG4gICAgICAgIHRoaXMudG9rZW5zPW5ldyBNYXRoR3JvdXAoR3JvdXBlZEJhc2ljVG9rZW5zKVxyXG4gICAgfVxyXG4gICAgY3JlYXRlTWF0aEdyb3VwSW5zZXJ0RnJvbVRva2Vucyh0b2tlbnM6IEFycmF5PGFueT4sc3RhcnQ6IG51bWJlcixlbmQ6IG51bWJlcik6Ym9vbGVhbntcclxuICAgICAgICBjb25zdCBuZXdNYXRoR3JvdXA9bmV3IE1hdGhHcm91cChlbnN1cmVBY2NlcHRhYmxlRm9ybWF0Rm9yTWF0aEdyb3VwSXRlbXModG9rZW5zLnNsaWNlKHN0YXJ0LGVuZCsxKSkpO1xyXG4gICAgICAgIHRva2Vucy5zcGxpY2Uoc3RhcnQsKGVuZC1zdGFydCkrMSxuZXdNYXRoR3JvdXApO1xyXG4gICAgICAgIHJldHVybiB0cnVlXHJcbiAgICB9XHJcbiAgICBjcmVhdGVPcGVyYXRvckl0ZW1Gcm9tVG9rZW5zKHRva2VuczogQXJyYXk8YW55PixpbmRleDogbnVtYmVyKTpib29sZWFue1xyXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gc2VhcmNoTWF0aEpheE9wZXJhdG9ycyh0b2tlbnNbaW5kZXhdLnZhbHVlKTtcclxuICAgICAgICBpZighbWV0YWRhdGEpdGhyb3cgbmV3IEVycm9yKGBPcGVyYXRvciAke3Rva2Vuc1tpbmRleF0udmFsdWV9IG5vdCBmb3VuZCBpbiBtZXRhZGF0YWApO1xyXG4gICAgICAgIFxyXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uPW5ldyBQb3NpdGlvbih0b2tlbnMsaW5kZXgpXHJcbiAgICAgICAgY29uc3QgbmV3T3BlcmF0b3I9TWF0aEpheE9wZXJhdG9yLmNyZWF0ZShwb3NpdGlvbi5vcGVyYXRvcixtZXRhZGF0YS5hc3NvY2lhdGl2aXR5Lm51bVBvc2l0aW9ucyxwb3NpdGlvbi5ncm91cHMpXHJcbiAgICAgICAgdG9rZW5zLnNwbGljZShwb3NpdGlvbi5zdGFydCwocG9zaXRpb24uZW5kLXBvc2l0aW9uLnN0YXJ0KSsxLG5ld09wZXJhdG9yKTtcclxuICAgICAgICByZXR1cm4gdHJ1ZVxyXG4gICAgfVxyXG59XHJcbmZ1bmN0aW9uIGRlZXBDbG9uZShpdGVtczogYW55W10pIHtcclxuICAgIGxldCBjbG9uZTogYW55W10gPSBbXTtcclxuICAgIGl0ZW1zLmZvckVhY2goaXRlbSA9PiB7XHJcbiAgICAgICAgY2xvbmUucHVzaChpdGVtIGluc3RhbmNlb2YgQXJyYXkgPyBkZWVwQ2xvbmUoaXRlbSkgOiBpdGVtLmNsb25lKCkpO1xyXG4gICAgfSk7XHJcbiAgICByZXR1cm4gY2xvbmU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGNvbWJpbmVTaW1pbGFyVmFsdWVzKG1hdGg6IE1hdGhHcm91cCl7XHJcbiAgICBcclxuICAgIGNvbnN0IG9wPW1hdGguZ2V0SXRlbXMoKS5maW5kKHQ9PnQgaW5zdGFuY2VvZiBNYXRoSmF4T3BlcmF0b3IpXHJcbiAgICBpZighb3ApcmV0dXJuXHJcbiAgICAvKmNvbnN0IGE9bmV3IE1hdGhPdmVydmlldygpXHJcbiAgICBhLmRlZmluZUdsb2JhbE92ZXJ2aWV3KG1hdGguZ2V0SXRlbXMoKSlcclxuICAgIGEuc2VwYXJhdGVJbnRvSW5kaXZpZHVhbHMoKSovXHJcblxyXG59XHJcblxyXG5cclxuY2xhc3MgbWF0aFZhcmlhYmxlc3tcclxuXHJcbn1cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZsYXR0ZW5BcnJheShhcnI6IGFueSkge1xyXG4gICAgbGV0IHJlc3VsdCA9IFtdO1xyXG4gICAgbGV0IHN0YWNrID0gQXJyYXkuaXNBcnJheShhcnIpID8gWy4uLmFycl0gOiBbYXJyXTtcclxuXHJcbiAgICB3aGlsZSAoc3RhY2subGVuZ3RoKSB7XHJcbiAgICAgICAgY29uc3QgbmV4dCA9IHN0YWNrLnBvcCgpO1xyXG4gICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5leHQpKSB7XHJcbiAgICAgICAgICAgIHN0YWNrLnB1c2goLi4ubmV4dCk7IFxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHJlc3VsdC5wdXNoKG5leHQpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiByZXN1bHQucmV2ZXJzZSgpO1xyXG59XHJcbiJdfQ==