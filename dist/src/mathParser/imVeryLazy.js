import { Position, Token } from "src/mathParser/mathEngine";
export function expandExpression(tokens, position) {
    if (position.checkFrac(tokens)) {
        goodByFraction(tokens, position);
        return;
    }
    let left = tokens.tokens.slice(position.left.breakChar, position.index).filter(item => /(number|variable|powerVariable)/.test(item.type));
    let right = tokens.tokens.slice(position.index, position.right.breakChar).filter(item => /(number|variable|powerVariable)/.test(item.type));
    const isLeftMultiStep = position.left.multiStep === undefined;
    if (position.operator === "-" && isLeftMultiStep) {
        left = new Token(-1);
    }
    let replacementCell = [];
    for (let i = 0; i < left.length; i++) {
        for (let j = 0; j < right.length; j++) {
            replacementCell.push(left[i]);
            replacementCell.push(new Token("*"));
            replacementCell.push(right[j]);
        }
    }
    const is = position.operator === "-" && isLeftMultiStep;
    const start = is ? position.index : position.left.breakChar;
    const length = position.right.breakChar - (is ? position.index : position.left.breakChar);
    tokens.insertTokens(start, length, replacementCell);
    tokens.IDparentheses();
}
export const curlyBracketsRegex = new RegExp("(frac|sqrt|\\^|\\/|binom)");
function goodByFraction(tokens, position) {
    let replacementTokens = [];
    /*We rely on the denominator to already possess parentheses
    We rely on the fact. that both the nominator and the denominator both have parentheses and closing them
    All calculations are according to that.
    */
    let denominator = position.right.tokens; //tokens.tokens.slice(position.transition, position.right.breakChar);
    if (!denominator.length)
        denominator = [{ "type": "paren", "value": "(", "id": 0, "index": 0 },
            denominator, { "type": "paren", "value": ")", "id": 0, "index": 0 }];
    for (let i = 0; i < tokens.tokens.length; i++) {
        // Had to change i = position.right.breakChar -->to--> i = position.right.breakChar-1;
        if (i >= position.index && i < position.right.breakChar) {
            replacementTokens.push(...tokens.tokens.slice(position.index + 1, position.transition));
            i = position.right.breakChar - 1;
            continue;
        }
        if (/(=)/.test(tokens.tokens[i].value)) {
            replacementTokens.push(tokens.tokens[i]);
            continue;
        }
        let replacement = tokens.tokens.slice(i, i + 1);
        let whereAmI = i;
        let rest = [];
        if (tokens.tokens[i].value === "frac") {
            whereAmI = new Position(tokens, i);
            replacementTokens.push(...tokens.tokens.slice(whereAmI.index, whereAmI.index + 2));
            //nominator
            rest = tokens.tokens.slice(whereAmI.transition - 1, whereAmI.right.breakChar);
            // denominator
            replacement = tokens.tokens.slice(i + 2, whereAmI.transition - 1);
        }
        else {
            whereAmI = i + tokens.tokens.slice(i).findIndex(token => /(=|frac)/.test(token.value));
            whereAmI = whereAmI < i ? tokens.tokens.length : whereAmI;
            replacement = tokens.tokens.slice(i, whereAmI);
        }
        replacementTokens.push(...denominator, { "type": "operator", "value": "*" }, { "type": "paren", "value": "(", "id": 0, "index": 0 }, ...replacement, { "type": "paren", "value": ")", "id": 0, "index": 0 }, ...rest);
        i = typeof whereAmI === "object" ? whereAmI.right.breakChar - 1 : whereAmI - 1;
    }
    tokens.tokens = replacementTokens;
    tokens.IDparentheses();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1WZXJ5TGF6eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tYXRoUGFyc2VyL2ltVmVyeUxhenkuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUU1RCxNQUFNLFVBQVUsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLFFBQVE7SUFDN0MsSUFBSSxRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxFQUFDLENBQUM7UUFBQSxjQUFjLENBQUMsTUFBTSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQUEsT0FBTztJQUFBLENBQUM7SUFDekUsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGlDQUFpQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUMxSSxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsaUNBQWlDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzVJLE1BQU0sZUFBZSxHQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxLQUFHLFNBQVMsQ0FBQztJQUUxRCxJQUFJLFFBQVEsQ0FBQyxRQUFRLEtBQUcsR0FBRyxJQUFFLGVBQWUsRUFBQyxDQUFDO1FBQzFDLElBQUksR0FBRyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO0lBRXhCLENBQUM7SUFDRCxJQUFJLGVB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QUFRLENBQUM7WUFDbEQsV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBQyxRQUFRLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBQ0QsaUJBQWlCLENBQUMsSUFBSSxDQUNsQixHQUFHLFdBQVcsRUFDZCxFQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBQyxFQUNsQyxFQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUMsRUFDcEQsR0FBRyxXQUFXLEVBQ2QsRUFBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFDLEVBQ3BELEdBQUcsSUFBSSxDQUNWLENBQUM7UUFDRixDQUFDLEdBQUcsT0FBTyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBQyxDQUFDLENBQUM7SUFDL0UsQ0FBQztJQUNELE1BQU0sQ0FBQyxNQUFNLEdBQUMsaUJBQWlCLENBQUM7SUFDaEMsTUFBTSxDQUFDLGFBQWEsRUFBRSxDQUFDO0FBQzNCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQb3NpdGlvbiwgVG9rZW4gfSBmcm9tIFwic3JjL21hdGhQYXJzZXIvbWF0aEVuZ2luZVwiO1xuXG5leHBvcnQgZnVuY3Rpb24gZXhwYW5kRXhwcmVzc2lvbih0b2tlbnMsIHBvc2l0aW9uKSB7XG4gICAgaWYgKHBvc2l0aW9uLmNoZWNrRnJhYyh0b2tlbnMpKXtnb29kQnlGcmFjdGlvbih0b2tlbnMsIHBvc2l0aW9uKTtyZXR1cm47fVxuICAgIGxldCBsZWZ0ID0gdG9rZW5zLnRva2Vucy5zbGljZShwb3NpdGlvbi5sZWZ0LmJyZWFrQ2hhciwgcG9zaXRpb24uaW5kZXgpLmZpbHRlcihpdGVtID0+IC8obnVtYmVyfHZhcmlhYmxlfHBvd2VyVmFyaWFibGUpLy50ZXN0KGl0ZW0udHlwZSkpO1xuICAgIGxldCByaWdodCA9IHRva2Vucy50b2tlbnMuc2xpY2UocG9zaXRpb24uaW5kZXgsIHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhcikuZmlsdGVyKGl0ZW0gPT4gLyhudW1iZXJ8dmFyaWFibGV8cG93ZXJWYXJpYWJsZSkvLnRlc3QoaXRlbS50eXBlKSk7XG4gICAgY29uc3QgaXNMZWZ0TXVsdGlTdGVwPXBvc2l0aW9uLmxlZnQubXVsdGlTdGVwPT09dW5kZWZpbmVkO1xuXG4gICAgaWYgKHBvc2l0aW9uLm9wZXJhdG9yPT09XCItXCImJmlzTGVmdE11bHRpU3RlcCl7XG4gICAgICAgIGxlZnQgPSBuZXcgVG9rZW4oLTEpXG4gICAgICAgIFxuICAgIH1cbiAgICBsZXQgcmVwbGFjZW1lbnRDZWxsID0gW107XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZWZ0Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgcmlnaHQubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgICAgIHJlcGxhY2VtZW50Q2VsbC5wdXNoKGxlZnRbaV0pO1xuICAgICAgICAgICAgcmVwbGFjZW1lbnRDZWxsLnB1c2gobmV3IFRva2VuKFwiKlwiKSk7XG4gICAgICAgICAgICByZXBsYWNlbWVudENlbGwucHVzaChyaWdodFtqXSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBpcz1wb3NpdGlvbi5vcGVyYXRvcj09PVwiLVwiJiZpc0xlZnRNdWx0aVN0ZXA7XG4gICAgY29uc3Qgc3RhcnQ9aXM/cG9zaXRpb24uaW5kZXg6cG9zaXRpb24ubGVmdC5icmVha0NoYXJcbiAgICBjb25zdCBsZW5ndGg9cG9zaXRpb24ucmlnaHQuYnJlYWtDaGFyLShpcz9wb3NpdGlvbi5pbmRleDpwb3NpdGlvbi5sZWZ0LmJyZWFrQ2hhcilcbiAgICB0b2tlbnMuaW5zZXJ0VG9rZW5zKHN0YXJ0LCBsZW5ndGgsIHJlcGxhY2VtZW50Q2VsbCk7XG4gICAgdG9rZW5zLklEcGFyZW50aGVzZXMoKTtcbn1cblxuZXhwb3J0IGNvbnN0IGN1cmx5QnJhY2tldHNSZWdleCA9IG5ldyBSZWdFeHAoXCIoZnJhY3xzcXJ0fFxcXFxefFxcXFwvfGJpbm9tKVwiKVxuXG5cblxuZnVuY3Rpb24gZ29vZEJ5RnJhY3Rpb24odG9rZW5zLCBwb3NpdGlvbikge1xuICAgIGxldCByZXBsYWNlbWVudFRva2VucyA9IFtdO1xuICAgIC8qV2UgcmVseSBvbiB0aGUgZGVub21pbmF0b3IgdG8gYWxyZWFkeSBwb3NzZXNzIHBhcmVudGhlc2VzXG4gICAgV2UgcmVseSBvbiB0aGUgZmFjdC4gdGhhdCBib3RoIHRoZSBub21pbmF0b3IgYW5kIHRoZSBkZW5vbWluYXRvciBib3RoIGhhdmUgcGFyZW50aGVzZXMgYW5kIGNsb3NpbmcgdGhlbSBcbiAgICBBbGwgY2FsY3VsYXRpb25zIGFyZSBhY2NvcmRpbmcgdG8gdGhhdC5cbiAgICAqL1xuICAgIGxldCBkZW5vbWluYXRvciA9IHBvc2l0aW9uLnJpZ2h0LnRva2Vucy8vdG9rZW5zLnRva2Vucy5zbGljZShwb3NpdGlvbi50cmFuc2l0aW9uLCBwb3NpdGlvbi5yaWdodC5icmVha0NoYXIpO1xuICAgIGlmICghZGVub21pbmF0b3IubGVuZ3RoKVxuICAgICAgICBkZW5vbWluYXRvcj1be1widHlwZVwiOiBcInBhcmVuXCIsIFwidmFsdWVcIjogXCIoXCIsIFwiaWRcIjogMCwgXCJpbmRleFwiOiAwfVxuICAgICxkZW5vbWluYXRvcix7XCJ0eXBlXCI6IFwicGFyZW5cIiwgXCJ2YWx1ZVwiOiBcIilcIiwgXCJpZFwiOiAwLCBcImluZGV4XCI6IDB9XVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG9rZW5zLnRva2Vucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAvLyBIYWQgdG8gY2hhbmdlIGkgPSBwb3NpdGlvbi5yaWdodC5icmVha0NoYXIgLS0+dG8tLT4gaSA9IHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhci0xO1xuICAgICAgICBpZiAoaSA+PSBwb3NpdGlvbi5pbmRleCAmJiBpIDwgcG9zaXRpb24ucmlnaHQuYnJlYWtDaGFyKSB7XG4gICAgICAgICAgICByZXBsYWNlbWVudFRva2Vucy5wdXNoKC4uLnRva2Vucy50b2tlbnMuc2xpY2UocG9zaXRpb24uaW5kZXgrMSxwb3NpdGlvbi50cmFuc2l0aW9uKSlcbiAgICAgICAgICAgIGkgPSBwb3NpdGlvbi5yaWdodC5icmVha0NoYXItMTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKC8oPSkvLnRlc3QodG9rZW5zLnRva2Vuc1tpXS52YWx1ZSkpIHtcbiAgICAgICAgICAgIHJlcGxhY2VtZW50VG9rZW5zLnB1c2godG9rZW5zLnRva2Vuc1tpXSk7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgbGV0IHJlcGxhY2VtZW50ID0gdG9rZW5zLnRva2Vucy5zbGljZShpLGkrMSlcbiAgICAgICAgbGV0IHdoZXJlQW1JID0gaTtcbiAgICAgICAgbGV0IHJlc3Q9W107XG4gICAgICAgIGlmICh0b2tlbnMudG9rZW5zW2ldLnZhbHVlID09PSBcImZyYWNcIikge1xuICAgICAgICAgICAgd2hlcmVBbUkgPSBuZXcgUG9zaXRpb24odG9rZW5zLCBpKTtcbiAgICAgICAgICAgIHJlcGxhY2VtZW50VG9rZW5zLnB1c2goLi4udG9rZW5zLnRva2Vucy5zbGljZSh3aGVyZUFtSS5pbmRleCx3aGVyZUFtSS5pbmRleCsyKSlcbiAgICAgICAgICAgIC8vbm9taW5hdG9yXG4gICAgICAgICAgICByZXN0PXRva2Vucy50b2tlbnMuc2xpY2Uod2hlcmVBbUkudHJhbnNpdGlvbi0xLHdoZXJlQW1JLnJpZ2h0LmJyZWFrQ2hhcilcbiAgICAgICAgICAgIC8vIGRlbm9taW5hdG9yXG4gICAgICAgICAgICByZXBsYWNlbWVudCA9IHRva2Vucy50b2tlbnMuc2xpY2UoaSArIDIsIHdoZXJlQW1JLnRyYW5zaXRpb24tMSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZXtcbiAgICAgICAgICAgIHdoZXJlQW1JPWkrdG9rZW5zLnRva2Vucy5zbGljZShpKS5maW5kSW5kZXgodG9rZW4gPT4gLyg9fGZyYWMpLy50ZXN0KHRva2VuLnZhbHVlKSlcbiAgICAgICAgICAgIHdoZXJlQW1JPXdoZXJlQW1JPGk/dG9rZW5zLnRva2Vucy5sZW5ndGg6d2hlcmVBbUk7XG4gICAgICAgICAgICByZXBsYWNlbWVudCA9IHRva2Vucy50b2tlbnMuc2xpY2UoaSx3aGVyZUFtSSk7XG4gICAgICAgIH1cbiAgICAgICAgcmVwbGFjZW1lbnRUb2tlbnMucHVzaChcbiAgICAgICAgICAgIC4uLmRlbm9taW5hdG9yLFxuICAgICAgICAgICAge1widHlwZVwiOiBcIm9wZXJhdG9yXCIsIFwidmFsdWVcIjogXCIqXCJ9LFxuICAgICAgICAgICAge1widHlwZVwiOiBcInBhcmVuXCIsIFwidmFsdWVcIjogXCIoXCIsIFwiaWRcIjogMCwgXCJpbmRleFwiOiAwfSxcbiAgICAgICAgICAgIC4uLnJlcGxhY2VtZW50LFxuICAgICAgICAgICAge1widHlwZVwiOiBcInBhcmVuXCIsIFwidmFsdWVcIjogXCIpXCIsIFwiaWRcIjogMCwgXCJpbmRleFwiOiAwfSxcbiAgICAgICAgICAgIC4uLnJlc3RcbiAgICAgICAgKTtcbiAgICAgICAgaSA9IHR5cGVvZiB3aGVyZUFtSSA9PT0gXCJvYmplY3RcIiA/IHdoZXJlQW1JLnJpZ2h0LmJyZWFrQ2hhci0xIDogd2hlcmVBbUktMTtcbiAgICB9XG4gICAgdG9rZW5zLnRva2Vucz1yZXBsYWNlbWVudFRva2VucztcbiAgICB0b2tlbnMuSURwYXJlbnRoZXNlcygpO1xufSJdfQ==