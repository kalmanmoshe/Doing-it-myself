import { Position, Token } from "src/mathParser/mathEngine";
export function expandExpression(tokens, position) {
    if (position.checkFrac(tokens)) {
        goodByFraction(tokens, position);
        return;
    }
    let left = tokens.tokens.slice(position.left.breakChar, position.index).filter(item => /(number|variable|powerVariable)/.test(item.type));
    let right = tokens.tokens.slice(position.index, position.right.breakChar).filter(item => /(number|variable|powerVariable)/.test(item.type));
    const isLeftMultiStep = position.left.multiStep === undefined;
    if (position.operator === "-" && isLeftMultiStep) {
        left = new Token(-1);
    }
    let replacementCell = [];
    for (let i = 0; i < left.length; i++) {
        for (let j = 0; j < right.length; j++) {
            replacementCell.push(left[i]);
            replacementCell.push(new Token("*"));
            replacementCell.push(right[j]);
        }
    }
    const is = position.operator === "-" && isLeftMultiStep;
    const start = is ? position.index : position.left.breakChar;
    const length = position.right.breakChar - (is ? position.index : position.left.breakChar);
    tokens.insertTokens(start, length, replacementCell);
    tokens.IDparentheses();
}
export const curlyBracketsRegex = new RegExp("(frac|sqrt|\\^|\\/|binom)");
function goodByFraction(tokens, position) {
    let replacementTokens = [];
    /*We rely on the denominator to already possess parentheses
    We rely on the fact. that both the nominator and the denominator both have parentheses and closing them
    All calculations are according to that.
    */
    let denominator = position.right.tokens; //tokens.tokens.slice(position.transition, position.right.breakChar);
    if (!denominator.length)
        denominator = [{ "type": "paren", "value": "(", "id": 0, "index": 0 },
            denominator, { "type": "paren", "value": ")", "id": 0, "index": 0 }];
    for (let i = 0; i < tokens.tokens.length; i++) {
        // Had to change i = position.right.breakChar -->to--> i = position.right.breakChar-1;
        if (i >= position.index && i < position.right.breakChar) {
            replacementTokens.push(...tokens.tokens.slice(position.index + 1, position.transition));
            i = position.right.breakChar - 1;
            continue;
        }
        if (/(=)/.test(tokens.tokens[i].value)) {
            replacementTokens.push(tokens.tokens[i]);
            continue;
        }
        let replacement = tokens.tokens.slice(i, i + 1);
        let whereAmI = i;
        let rest = [];
        if (tokens.tokens[i].value === "frac") {
            whereAmI = new Position(tokens, i);
            replacementTokens.push(...tokens.tokens.slice(whereAmI.index, whereAmI.index + 2));
            //nominator
            rest = tokens.tokens.slice(whereAmI.transition - 1, whereAmI.right.breakChar);
            // denominator
            replacement = tokens.tokens.slice(i + 2, whereAmI.transition - 1);
        }
        else {
            whereAmI = i + tokens.tokens.slice(i).findIndex(token => /(=|frac)/.test(token.value));
            whereAmI = whereAmI < i ? tokens.tokens.length : whereAmI;
            replacement = tokens.tokens.slice(i, whereAmI);
        }
        replacementTokens.push(...denominator, { "type": "operator", "value": "*" }, { "type": "paren", "value": "(", "id": 0, "index": 0 }, ...replacement, { "type": "paren", "value": ")", "id": 0, "index": 0 }, ...rest);
        i = typeof whereAmI === "object" ? whereAmI.right.breakChar - 1 : whereAmI - 1;
    }
    tokens.tokens = replacementTokens;
    tokens.IDparentheses();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1WZXJ5TGF6eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbVZlcnlMYXp5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsS0FBSyxFQUFFLE1BQU0sMkJBQTJCLENBQUM7QUFFNUQsTUFBTSxVQUFVLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxRQUFRO0lBQzdDLElBQUksUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBQyxDQUFDO1FBQUEsY0FBYyxDQUFDLE1BQU0sRUFBRSxRQUFRLENBQUMsQ0FBQztRQUFBLE9BQU87SUFBQSxDQUFDO0lBQ3pFLElBQUksSUFBSSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxpQ0FBaUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDMUksSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGlDQUFpQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUM1SSxNQUFNLGVBQWUsR0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsS0FBRyxTQUFTLENBQUM7SUFFMUQsSUFBSSxRQUFRLENBQUMsUUFBUSxLQUFHLEdBQUcsSUFBRSxlQUFlLEVBQUMsQ0FBQztRQUMxQyxJQUFJLEdBQUcsSUFBSSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtJQUV4QixDQUFDO0lBQ0QsSUFBSSxlQUFlLEdBQUcsRUFBRSxD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LFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUMsUUFBUSxDQUFDLENBQUM7UUFDbEQsQ0FBQztRQUNELGlCQUFpQixDQUFDLElBQUksQ0FDbEIsR0FBRyxXQUFXLEVBQ2QsRUFBQyxNQUFNLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUMsRUFDbEMsRUFBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFDLEVBQ3BELEdBQUcsV0FBVyxFQUNkLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBQyxFQUNwRCxHQUFHLElBQUksQ0FDVixDQUFDO1FBQ0YsQ0FBQyxHQUFHLE9BQU8sUUFBUSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFDRCxNQUFNLENBQUMsTUFBTSxHQUFDLGlCQUFpQixDQUFDO0lBQ2hDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQztBQUMzQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUG9zaXRpb24sIFRva2VuIH0gZnJvbSBcInNyYy9tYXRoUGFyc2VyL21hdGhFbmdpbmVcIjtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBleHBhbmRFeHByZXNzaW9uKHRva2VucywgcG9zaXRpb24pIHtcclxuICAgIGlmIChwb3NpdGlvbi5jaGVja0ZyYWModG9rZW5zKSl7Z29vZEJ5RnJhY3Rpb24odG9rZW5zLCBwb3NpdGlvbik7cmV0dXJuO31cclxuICAgIGxldCBsZWZ0ID0gdG9rZW5zLnRva2Vucy5zbGljZShwb3NpdGlvbi5sZWZ0LmJyZWFrQ2hhciwgcG9zaXRpb24uaW5kZXgpLmZpbHRlcihpdGVtID0+IC8obnVtYmVyfHZhcmlhYmxlfHBvd2VyVmFyaWFibGUpLy50ZXN0KGl0ZW0udHlwZSkpO1xyXG4gICAgbGV0IHJpZ2h0ID0gdG9rZW5zLnRva2Vucy5zbGljZShwb3NpdGlvbi5pbmRleCwgcG9zaXRpb24ucmlnaHQuYnJlYWtDaGFyKS5maWx0ZXIoaXRlbSA9PiAvKG51bWJlcnx2YXJpYWJsZXxwb3dlclZhcmlhYmxlKS8udGVzdChpdGVtLnR5cGUpKTtcclxuICAgIGNvbnN0IGlzTGVmdE11bHRpU3RlcD1wb3NpdGlvbi5sZWZ0Lm11bHRpU3RlcD09PXVuZGVmaW5lZDtcclxuXHJcbiAgICBpZiAocG9zaXRpb24ub3BlcmF0b3I9PT1cIi1cIiYmaXNMZWZ0TXVsdGlTdGVwKXtcclxuICAgICAgICBsZWZ0ID0gbmV3IFRva2VuKC0xKVxyXG4gICAgICAgIFxyXG4gICAgfVxyXG4gICAgbGV0IHJlcGxhY2VtZW50Q2VsbCA9IFtdO1xyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBsZWZ0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByaWdodC5sZW5ndGg7IGorKykge1xyXG4gICAgICAgICAgICByZXBsYWNlbWVudENlbGwucHVzaChsZWZ0W2ldKTtcclxuICAgICAgICAgICAgcmVwbGFjZW1lbnRDZWxsLnB1c2gobmV3IFRva2VuKFwiKlwiKSk7XHJcbiAgICAgICAgICAgIHJlcGxhY2VtZW50Q2VsbC5wdXNoKHJpZ2h0W2pdKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgaXM9cG9zaXRpb24ub3BlcmF0b3I9PT1cIi1cIiYmaXNMZWZ0TXVsdGlTdGVwO1xyXG4gICAgY29uc3Qgc3RhcnQ9aXM/cG9zaXRpb24uaW5kZXg6cG9zaXRpb24ubGVmdC5icmVha0NoYXJcclxuICAgIGNvbnN0IGxlbmd0aD1wb3NpdGlvbi5yaWdodC5icmVha0NoYXItKGlzP3Bvc2l0aW9uLmluZGV4OnBvc2l0aW9uLmxlZnQuYnJlYWtDaGFyKVxyXG4gICAgdG9rZW5zLmluc2VydFRva2VucyhzdGFydCwgbGVuZ3RoLCByZXBsYWNlbWVudENlbGwpO1xyXG4gICAgdG9rZW5zLklEcGFyZW50aGVzZXMoKTtcclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IGN1cmx5QnJhY2tldHNSZWdleCA9IG5ldyBSZWdFeHAoXCIoZnJhY3xzcXJ0fFxcXFxefFxcXFwvfGJpbm9tKVwiKVxyXG5cclxuXHJcblxyXG5mdW5jdGlvbiBnb29kQnlGcmFjdGlvbih0b2tlbnMsIHBvc2l0aW9uKSB7XHJcbiAgICBsZXQgcmVwbGFjZW1lbnRUb2tlbnMgPSBbXTtcclxuICAgIC8qV2UgcmVseSBvbiB0aGUgZGVub21pbmF0b3IgdG8gYWxyZWFkeSBwb3NzZXNzIHBhcmVudGhlc2VzXHJcbiAgICBXZSByZWx5IG9uIHRoZSBmYWN0LiB0aGF0IGJvdGggdGhlIG5vbWluYXRvciBhbmQgdGhlIGRlbm9taW5hdG9yIGJvdGggaGF2ZSBwYXJlbnRoZXNlcyBhbmQgY2xvc2luZyB0aGVtIFxyXG4gICAgQWxsIGNhbGN1bGF0aW9ucyBhcmUgYWNjb3JkaW5nIHRvIHRoYXQuXHJcbiAgICAqL1xyXG4gICAgbGV0IGRlbm9taW5hdG9yID0gcG9zaXRpb24ucmlnaHQudG9rZW5zLy90b2tlbnMudG9rZW5zLnNsaWNlKHBvc2l0aW9uLnRyYW5zaXRpb24sIHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhcik7XHJcbiAgICBpZiAoIWRlbm9taW5hdG9yLmxlbmd0aClcclxuICAgICAgICBkZW5vbWluYXRvcj1be1widHlwZVwiOiBcInBhcmVuXCIsIFwidmFsdWVcIjogXCIoXCIsIFwiaWRcIjogMCwgXCJpbmRleFwiOiAwfVxyXG4gICAgLGRlbm9taW5hdG9yLHtcInR5cGVcIjogXCJwYXJlblwiLCBcInZhbHVlXCI6IFwiKVwiLCBcImlkXCI6IDAsIFwiaW5kZXhcIjogMH1dXHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRva2Vucy50b2tlbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAvLyBIYWQgdG8gY2hhbmdlIGkgPSBwb3NpdGlvbi5yaWdodC5icmVha0NoYXIgLS0+dG8tLT4gaSA9IHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhci0xO1xyXG4gICAgICAgIGlmIChpID49IHBvc2l0aW9uLmluZGV4ICYmIGkgPCBwb3NpdGlvbi5yaWdodC5icmVha0NoYXIpIHtcclxuICAgICAgICAgICAgcmVwbGFjZW1lbnRUb2tlbnMucHVzaCguLi50b2tlbnMudG9rZW5zLnNsaWNlKHBvc2l0aW9uLmluZGV4KzEscG9zaXRpb24udHJhbnNpdGlvbikpXHJcbiAgICAgICAgICAgIGkgPSBwb3NpdGlvbi5yaWdodC5icmVha0NoYXItMTtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAoLyg9KS8udGVzdCh0b2tlbnMudG9rZW5zW2ldLnZhbHVlKSkge1xyXG4gICAgICAgICAgICByZXBsYWNlbWVudFRva2Vucy5wdXNoKHRva2Vucy50b2tlbnNbaV0pO1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgbGV0IHJlcGxhY2VtZW50ID0gdG9rZW5zLnRva2Vucy5zbGljZShpLGkrMSlcclxuICAgICAgICBsZXQgd2hlcmVBbUkgPSBpO1xyXG4gICAgICAgIGxldCByZXN0PVtdO1xyXG4gICAgICAgIGlmICh0b2tlbnMudG9rZW5zW2ldLnZhbHVlID09PSBcImZyYWNcIikge1xyXG4gICAgICAgICAgICB3aGVyZUFtSSA9IG5ldyBQb3NpdGlvbih0b2tlbnMsIGkpO1xyXG4gICAgICAgICAgICByZXBsYWNlbWVudFRva2Vucy5wdXNoKC4uLnRva2Vucy50b2tlbnMuc2xpY2Uod2hlcmVBbUkuaW5kZXgsd2hlcmVBbUkuaW5kZXgrMikpXHJcbiAgICAgICAgICAgIC8vbm9taW5hdG9yXHJcbiAgICAgICAgICAgIHJlc3Q9dG9rZW5zLnRva2Vucy5zbGljZSh3aGVyZUFtSS50cmFuc2l0aW9uLTEsd2hlcmVBbUkucmlnaHQuYnJlYWtDaGFyKVxyXG4gICAgICAgICAgICAvLyBkZW5vbWluYXRvclxyXG4gICAgICAgICAgICByZXBsYWNlbWVudCA9IHRva2Vucy50b2tlbnMuc2xpY2UoaSArIDIsIHdoZXJlQW1JLnRyYW5zaXRpb24tMSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGVsc2V7XHJcbiAgICAgICAgICAgIHdoZXJlQW1JPWkrdG9rZW5zLnRva2Vucy5zbGljZShpKS5maW5kSW5kZXgodG9rZW4gPT4gLyg9fGZyYWMpLy50ZXN0KHRva2VuLnZhbHVlKSlcclxuICAgICAgICAgICAgd2hlcmVBbUk9d2hlcmVBbUk8aT90b2tlbnMudG9rZW5zLmxlbmd0aDp3aGVyZUFtSTtcclxuICAgICAgICAgICAgcmVwbGFjZW1lbnQgPSB0b2tlbnMudG9rZW5zLnNsaWNlKGksd2hlcmVBbUkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXBsYWNlbWVudFRva2Vucy5wdXNoKFxyXG4gICAgICAgICAgICAuLi5kZW5vbWluYXRvcixcclxuICAgICAgICAgICAge1widHlwZVwiOiBcIm9wZXJhdG9yXCIsIFwidmFsdWVcIjogXCIqXCJ9LFxyXG4gICAgICAgICAgICB7XCJ0eXBlXCI6IFwicGFyZW5cIiwgXCJ2YWx1ZVwiOiBcIihcIiwgXCJpZFwiOiAwLCBcImluZGV4XCI6IDB9LFxyXG4gICAgICAgICAgICAuLi5yZXBsYWNlbWVudCxcclxuICAgICAgICAgICAge1widHlwZVwiOiBcInBhcmVuXCIsIFwidmFsdWVcIjogXCIpXCIsIFwiaWRcIjogMCwgXCJpbmRleFwiOiAwfSxcclxuICAgICAgICAgICAgLi4ucmVzdFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgaSA9IHR5cGVvZiB3aGVyZUFtSSA9PT0gXCJvYmplY3RcIiA/IHdoZXJlQW1JLnJpZ2h0LmJyZWFrQ2hhci0xIDogd2hlcmVBbUktMTtcclxuICAgIH1cclxuICAgIHRva2Vucy50b2tlbnM9cmVwbGFjZW1lbnRUb2tlbnM7XHJcbiAgICB0b2tlbnMuSURwYXJlbnRoZXNlcygpO1xyXG59Il19