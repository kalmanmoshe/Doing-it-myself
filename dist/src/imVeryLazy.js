import { Position } from "./mathEngine";
export function expandExpression(tokens, position) {
    if (position.checkFrac(tokens)) {
        goodByFraction(tokens, position);
        return;
    }
    let left = tokens.tokens.slice(position.left.breakChar, position.index).filter(item => /(number|variable|powerVariable)/.test(item.type));
    let right = tokens.tokens.slice(position.index, position.right.breakChar).filter(item => /(number|variable|powerVariable)/.test(item.type));
    const isLeftMultiStep = position.left.multiStep === undefined;
    if (position.operator === "-" && isLeftMultiStep) {
        left = [{ "type": "number", "value": -1, "index": 0 }];
    }
    let replacementCell = [];
    for (let i = 0; i < left.length; i++) {
        for (let j = 0; j < right.length; j++) {
            replacementCell.push(left[i]);
            replacementCell.push({ "type": "operator", "value": "*", "index": 0 });
            replacementCell.push(right[j]);
        }
    }
    const is = position.operator === "-" && isLeftMultiStep;
    const start = is ? position.index : position.left.breakChar;
    const length = position.right.breakChar - (is ? position.index : position.left.breakChar);
    tokens.insertTokens(start, length, replacementCell);
    tokens.reIDparentheses();
}
export const curlyBracketsRegex = new RegExp("(frac|sqrt|\\^|\\/|binom)");
function goodByFraction(tokens, position) {
    let replacementTokens = [];
    /*We rely on the denominator to already possess parentheses
    We rely on the fact. that both the nominator and the denominator both have parentheses and closing them
    All calculations are according to that.
    */
    let denominator = position.right.tokens; //tokens.tokens.slice(position.transition, position.right.breakChar);
    if (!denominator.length)
        denominator = [{ "type": "paren", "value": "(", "id": 0, "index": 0 },
            denominator, { "type": "paren", "value": ")", "id": 0, "index": 0 }];
    console.log(denominator, denominator.length, typeof denominator);
    for (let i = 0; i < tokens.tokens.length; i++) {
        // Had to change i = position.right.breakChar -->to--> i = position.right.breakChar-1;
        //console.log(tokens.tokens[i].value)
        if (i >= position.index && i < position.right.breakChar) {
            replacementTokens.push(...tokens.tokens.slice(position.index + 1, position.transition));
            i = position.right.breakChar - 1;
            continue;
        }
        if (/(=)/.test(tokens.tokens[i].value)) {
            replacementTokens.push(tokens.tokens[i]);
            continue;
        }
        let replacement = tokens.tokens.slice(i, i + 1);
        let whereAmI = i;
        let rest = [];
        if (tokens.tokens[i].value === "frac") {
            whereAmI = new Position(tokens, i);
            replacementTokens.push(...tokens.tokens.slice(whereAmI.index, whereAmI.index + 2));
            //nominator
            rest = tokens.tokens.slice(whereAmI.transition - 1, whereAmI.right.breakChar);
            // denominator
            replacement = tokens.tokens.slice(i + 2, whereAmI.transition - 1);
        }
        else {
            whereAmI = i + tokens.tokens.slice(i).findIndex(token => /(=|frac)/.test(token.value));
            whereAmI = whereAmI < i ? tokens.tokens.length : whereAmI;
            replacement = tokens.tokens.slice(i, whereAmI);
        }
        replacementTokens.push(...denominator, { "type": "operator", "value": "*" }, { "type": "paren", "value": "(", "id": 0, "index": 0 }, ...replacement, { "type": "paren", "value": ")", "id": 0, "index": 0 }, ...rest);
        i = typeof whereAmI === "object" ? whereAmI.right.breakChar - 1 : whereAmI - 1;
    }
    //console.log(replacementTokens)
    tokens.tokens = replacementTokens;
    tokens.reIDparentheses();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1WZXJ5TGF6eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbVZlcnlMYXp5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFeEMsTUFBTSxVQUFVLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxRQUFRO0lBQzdDLElBQUksUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBQztRQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFBQSxPQUFPO0tBQUM7SUFDekUsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGlDQUFpQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUMxSSxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsaUNBQWlDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzVJLE1BQU0sZUFBZSxHQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxLQUFHLFNBQVMsQ0FBQztJQUUxRCxJQUFJLFFBQVEsQ0FBQyxRQUFRLEtBQUcsR0FBRyxJQUFFLGVBQWUsRUFBQztRQUN6QyxJQUFJLEdBQUcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0tBRXpEO0lBQ0QsSUFBSSxlQUFlLEdBQUcsRUFBRSxDQUFDO0lBQ3pCLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1FBQ2xDLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFO1lBQ25DLGVBQWUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDOUIsZUFBZSxDQUFDLElBQUksQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUN2RSxlQUFlLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2xDO0tBQ0o7SUFFRCxNQUFNLEVBQUUsR0FBQyxRQUFRLENBQUMsUUFBUSxLQUFHLEdBQUcsSUFBRSxlQUFlLENBQUM7SUFDbEQsTUFBTSxLQUFLLEdBQUMsRUFBRSxDQUFBLENBQUMsQ0FBQSxRQUFRLENBQUMsS0FBSyxDQUFBLENBQUMsQ0FBQSxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQTtJQUNyRCxNQUFNLE1BQU0sR0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBQyxDQUFDLEVBQUUsQ0FBQSxDQUFDLENBQUEsUUFBUSxDQUFDLEtBQUssQ0FBQSxDQUFDLENBQUEsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQTtJQUNqRixNQUFNLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsZUFBZSxDQUFDLENBQUM7SUFDcEQsTUFBTSxDQUFDLGVBQWUsRUFBRSxDQUFDO0FBQzdCLENBQUM7QUFFRCxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxJQUFJLE1BQU0sQ0FBQywyQkFBMkIsQ0FBQyxDQUFBO0FBSXpFLFNBQVMsY0FBYyxDQUFDLE1BQU0sRUFBRSxRQUFRO0lBQ3BDLElBQUksaUJBQWlCLEdBQUcsRUFBRSxDQUFDO0lBQzNCOzs7TUFHRTtJQUNGLElBQUksV0FBVyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFBLENBQUEscUVBQXFFO0lBQzVHLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTTtRQUNuQixXQUFXLEdBQUMsQ0FBQyxFQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUM7WUFDcEUsV0FBVyxFQUFDLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBQyxDQUFDLENBQUE7SUFDbEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEVBQUMsV0FBVyxDQUFDLE1BQU0sRUFBQyxPQUFPLFdBQVcsQ0FBQyxDQUFBO0lBQzlELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRTtRQUMzQyxzRkFBc0Y7UUFDdEYscUNBQXFDO1FBQ3JDLElBQUksQ0FBQyxJQUFJLFFBQVEsQ0FBQyxLQUFLLElBQUksQ0FBQyxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFO1lBQ3JELGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEdBQUMsQ0FBQyxFQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQyxDQUFBO1lBQ3BGLENBQUMsR0FBRyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBQyxDQUFDLENBQUM7WUFDL0IsU0FBUztTQUNaO1FBRUQsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLEVBQUU7WUFDcEMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6QyxTQUFTO1NBQ1o7UUFFRCxJQUFJLFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUMsQ0FBQyxHQUFDLENBQUMsQ0FBQyxDQUFBO1FBQzVDLElBQUksUUFBUSxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLElBQUksR0FBQyxFQUFFLENBQUM7UUFDWixJQUFJLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxLQUFLLE1BQU0sRUFBRTtZQUNuQyxRQUFRLEdBQUcsSUFBSSxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ25DLGlCQUFpQixDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxLQUFLLEVBQUMsUUFBUSxDQUFDLEtBQUssR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1lBQy9FLFdBQVc7WUFDWCxJQUFJLEdBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLFVBQVUsR0FBQyxDQUFDLEVBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQTtZQUN4RSxjQUFjO1lBQ2QsV0FBVyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsUUFBUSxDQUFDLFVBQVUsR0FBQyxDQUFDLENBQUMsQ0FBQztTQUNuRTthQUNHO1lBQ0EsUUFBUSxHQUFDLENBQUMsR0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFBO1lBQ2xGLFFBQVEsR0FBQyxRQUFRLEdBQUMsQ0FBQyxDQUFBLENBQUMsQ0FBQSxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQSxDQUFDLENBQUEsUUFBUSxDQUFDO1lBQ2xELFdBQVcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUMsUUFBUSxDQUFDLENBQUM7U0FDakQ7UUFDRCxpQkFBaUIsQ0FBQyxJQUFJLENBQ2xCLEdBQUcsV0FBVyxFQUNkLEVBQUMsTUFBTSxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFDLEVBQ2xDLEVBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsRUFBQyxFQUNwRCxHQUFHLFdBQVcsRUFDZCxFQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUMsRUFDcEQsR0FBRyxJQUFJLENBQ1YsQ0FBQztRQUNGLENBQUMsR0FBRyxPQUFPLFFBQVEsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsUUFBUSxHQUFDLENBQUMsQ0FBQztLQUM5RTtJQUNELGdDQUFnQztJQUNoQyxNQUFNLENBQUMsTUFBTSxHQUFDLGlCQUFpQixDQUFDO0lBQ2hDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztBQUM3QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUG9zaXRpb24gfSBmcm9tIFwiLi9tYXRoRW5naW5lXCI7XG5cbmV4cG9ydCBmdW5jdGlvbiBleHBhbmRFeHByZXNzaW9uKHRva2VucywgcG9zaXRpb24pIHtcbiAgICBpZiAocG9zaXRpb24uY2hlY2tGcmFjKHRva2Vucykpe2dvb2RCeUZyYWN0aW9uKHRva2VucywgcG9zaXRpb24pO3JldHVybjt9XG4gICAgbGV0IGxlZnQgPSB0b2tlbnMudG9rZW5zLnNsaWNlKHBvc2l0aW9uLmxlZnQuYnJlYWtDaGFyLCBwb3NpdGlvbi5pbmRleCkuZmlsdGVyKGl0ZW0gPT4gLyhudW1iZXJ8dmFyaWFibGV8cG93ZXJWYXJpYWJsZSkvLnRlc3QoaXRlbS50eXBlKSk7XG4gICAgbGV0IHJpZ2h0ID0gdG9rZW5zLnRva2Vucy5zbGljZShwb3NpdGlvbi5pbmRleCwgcG9zaXRpb24ucmlnaHQuYnJlYWtDaGFyKS5maWx0ZXIoaXRlbSA9PiAvKG51bWJlcnx2YXJpYWJsZXxwb3dlclZhcmlhYmxlKS8udGVzdChpdGVtLnR5cGUpKTtcbiAgICBjb25zdCBpc0xlZnRNdWx0aVN0ZXA9cG9zaXRpb24ubGVmdC5tdWx0aVN0ZXA9PT11bmRlZmluZWQ7XG5cbiAgICBpZiAocG9zaXRpb24ub3BlcmF0b3I9PT1cIi1cIiYmaXNMZWZ0TXVsdGlTdGVwKXtcbiAgICAgICAgbGVmdCA9IFt7IFwidHlwZVwiOiBcIm51bWJlclwiLCBcInZhbHVlXCI6IC0xLCBcImluZGV4XCI6IDAgfV1cbiAgICAgICAgXG4gICAgfVxuICAgIGxldCByZXBsYWNlbWVudENlbGwgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlZnQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCByaWdodC5sZW5ndGg7IGorKykge1xuICAgICAgICAgICAgcmVwbGFjZW1lbnRDZWxsLnB1c2gobGVmdFtpXSk7XG4gICAgICAgICAgICByZXBsYWNlbWVudENlbGwucHVzaCh7IFwidHlwZVwiOiBcIm9wZXJhdG9yXCIsIFwidmFsdWVcIjogXCIqXCIsIFwiaW5kZXhcIjogMCB9KTtcbiAgICAgICAgICAgIHJlcGxhY2VtZW50Q2VsbC5wdXNoKHJpZ2h0W2pdKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGlzPXBvc2l0aW9uLm9wZXJhdG9yPT09XCItXCImJmlzTGVmdE11bHRpU3RlcDtcbiAgICBjb25zdCBzdGFydD1pcz9wb3NpdGlvbi5pbmRleDpwb3NpdGlvbi5sZWZ0LmJyZWFrQ2hhclxuICAgIGNvbnN0IGxlbmd0aD1wb3NpdGlvbi5yaWdodC5icmVha0NoYXItKGlzP3Bvc2l0aW9uLmluZGV4OnBvc2l0aW9uLmxlZnQuYnJlYWtDaGFyKVxuICAgIHRva2Vucy5pbnNlcnRUb2tlbnMoc3RhcnQsIGxlbmd0aCwgcmVwbGFjZW1lbnRDZWxsKTtcbiAgICB0b2tlbnMucmVJRHBhcmVudGhlc2VzKCk7XG59XG5cbmV4cG9ydCBjb25zdCBjdXJseUJyYWNrZXRzUmVnZXggPSBuZXcgUmVnRXhwKFwiKGZyYWN8c3FydHxcXFxcXnxcXFxcL3xiaW5vbSlcIilcblxuXG5cbmZ1bmN0aW9uIGdvb2RCeUZyYWN0aW9uKHRva2VucywgcG9zaXRpb24pIHtcbiAgICBsZXQgcmVwbGFjZW1lbnRUb2tlbnMgPSBbXTtcbiAgICAvKldlIHJlbHkgb24gdGhlIGRlbm9taW5hdG9yIHRvIGFscmVhZHkgcG9zc2VzcyBwYXJlbnRoZXNlc1xuICAgIFdlIHJlbHkgb24gdGhlIGZhY3QuIHRoYXQgYm90aCB0aGUgbm9taW5hdG9yIGFuZCB0aGUgZGVub21pbmF0b3IgYm90aCBoYXZlIHBhcmVudGhlc2VzIGFuZCBjbG9zaW5nIHRoZW0gXG4gICAgQWxsIGNhbGN1bGF0aW9ucyBhcmUgYWNjb3JkaW5nIHRvIHRoYXQuXG4gICAgKi9cbiAgICBsZXQgZGVub21pbmF0b3IgPSBwb3NpdGlvbi5yaWdodC50b2tlbnMvL3Rva2Vucy50b2tlbnMuc2xpY2UocG9zaXRpb24udHJhbnNpdGlvbiwgcG9zaXRpb24ucmlnaHQuYnJlYWtDaGFyKTtcbiAgICBpZiAoIWRlbm9taW5hdG9yLmxlbmd0aClcbiAgICAgICAgZGVub21pbmF0b3I9W3tcInR5cGVcIjogXCJwYXJlblwiLCBcInZhbHVlXCI6IFwiKFwiLCBcImlkXCI6IDAsIFwiaW5kZXhcIjogMH1cbiAgICAsZGVub21pbmF0b3Ise1widHlwZVwiOiBcInBhcmVuXCIsIFwidmFsdWVcIjogXCIpXCIsIFwiaWRcIjogMCwgXCJpbmRleFwiOiAwfV1cbiAgICBjb25zb2xlLmxvZyhkZW5vbWluYXRvcixkZW5vbWluYXRvci5sZW5ndGgsdHlwZW9mIGRlbm9taW5hdG9yKVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG9rZW5zLnRva2Vucy5sZW5ndGg7IGkrKykge1xuICAgICAgICAvLyBIYWQgdG8gY2hhbmdlIGkgPSBwb3NpdGlvbi5yaWdodC5icmVha0NoYXIgLS0+dG8tLT4gaSA9IHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhci0xO1xuICAgICAgICAvL2NvbnNvbGUubG9nKHRva2Vucy50b2tlbnNbaV0udmFsdWUpXG4gICAgICAgIGlmIChpID49IHBvc2l0aW9uLmluZGV4ICYmIGkgPCBwb3NpdGlvbi5yaWdodC5icmVha0NoYXIpIHtcbiAgICAgICAgICAgIHJlcGxhY2VtZW50VG9rZW5zLnB1c2goLi4udG9rZW5zLnRva2Vucy5zbGljZShwb3NpdGlvbi5pbmRleCsxLHBvc2l0aW9uLnRyYW5zaXRpb24pKVxuICAgICAgICAgICAgaSA9IHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhci0xO1xuICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoLyg9KS8udGVzdCh0b2tlbnMudG9rZW5zW2ldLnZhbHVlKSkge1xuICAgICAgICAgICAgcmVwbGFjZW1lbnRUb2tlbnMucHVzaCh0b2tlbnMudG9rZW5zW2ldKTtcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBsZXQgcmVwbGFjZW1lbnQgPSB0b2tlbnMudG9rZW5zLnNsaWNlKGksaSsxKVxuICAgICAgICBsZXQgd2hlcmVBbUkgPSBpO1xuICAgICAgICBsZXQgcmVzdD1bXTtcbiAgICAgICAgaWYgKHRva2Vucy50b2tlbnNbaV0udmFsdWUgPT09IFwiZnJhY1wiKSB7XG4gICAgICAgICAgICB3aGVyZUFtSSA9IG5ldyBQb3NpdGlvbih0b2tlbnMsIGkpO1xuICAgICAgICAgICAgcmVwbGFjZW1lbnRUb2tlbnMucHVzaCguLi50b2tlbnMudG9rZW5zLnNsaWNlKHdoZXJlQW1JLmluZGV4LHdoZXJlQW1JLmluZGV4KzIpKVxuICAgICAgICAgICAgLy9ub21pbmF0b3JcbiAgICAgICAgICAgIHJlc3Q9dG9rZW5zLnRva2Vucy5zbGljZSh3aGVyZUFtSS50cmFuc2l0aW9uLTEsd2hlcmVBbUkucmlnaHQuYnJlYWtDaGFyKVxuICAgICAgICAgICAgLy8gZGVub21pbmF0b3JcbiAgICAgICAgICAgIHJlcGxhY2VtZW50ID0gdG9rZW5zLnRva2Vucy5zbGljZShpICsgMiwgd2hlcmVBbUkudHJhbnNpdGlvbi0xKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgd2hlcmVBbUk9aSt0b2tlbnMudG9rZW5zLnNsaWNlKGkpLmZpbmRJbmRleCh0b2tlbiA9PiAvKD18ZnJhYykvLnRlc3QodG9rZW4udmFsdWUpKVxuICAgICAgICAgICAgd2hlcmVBbUk9d2hlcmVBbUk8aT90b2tlbnMudG9rZW5zLmxlbmd0aDp3aGVyZUFtSTtcbiAgICAgICAgICAgIHJlcGxhY2VtZW50ID0gdG9rZW5zLnRva2Vucy5zbGljZShpLHdoZXJlQW1JKTtcbiAgICAgICAgfVxuICAgICAgICByZXBsYWNlbWVudFRva2Vucy5wdXNoKFxuICAgICAgICAgICAgLi4uZGVub21pbmF0b3IsXG4gICAgICAgICAgICB7XCJ0eXBlXCI6IFwib3BlcmF0b3JcIiwgXCJ2YWx1ZVwiOiBcIipcIn0sXG4gICAgICAgICAgICB7XCJ0eXBlXCI6IFwicGFyZW5cIiwgXCJ2YWx1ZVwiOiBcIihcIiwgXCJpZFwiOiAwLCBcImluZGV4XCI6IDB9LFxuICAgICAgICAgICAgLi4ucmVwbGFjZW1lbnQsXG4gICAgICAgICAgICB7XCJ0eXBlXCI6IFwicGFyZW5cIiwgXCJ2YWx1ZVwiOiBcIilcIiwgXCJpZFwiOiAwLCBcImluZGV4XCI6IDB9LFxuICAgICAgICAgICAgLi4ucmVzdFxuICAgICAgICApO1xuICAgICAgICBpID0gdHlwZW9mIHdoZXJlQW1JID09PSBcIm9iamVjdFwiID8gd2hlcmVBbUkucmlnaHQuYnJlYWtDaGFyLTEgOiB3aGVyZUFtSS0xO1xuICAgIH1cbiAgICAvL2NvbnNvbGUubG9nKHJlcGxhY2VtZW50VG9rZW5zKVxuICAgIHRva2Vucy50b2tlbnM9cmVwbGFjZW1lbnRUb2tlbnM7XG4gICAgdG9rZW5zLnJlSURwYXJlbnRoZXNlcygpO1xufSJdfQ==