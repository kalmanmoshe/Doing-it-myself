import { Position } from "./mathEngine";
export function expandExpression(tokens, position) {
    if (position.checkFrac(tokens)) {
        goodByFraction(tokens, position);
        return;
    }
    let left = tokens.tokens.slice(position.left.breakChar, position.index).filter(item => /(number|variable|powerVariable)/.test(item.type));
    let right = tokens.tokens.slice(position.index, position.right.breakChar).filter(item => /(number|variable|powerVariable)/.test(item.type));
    const isLeftMultiStep = position.left.multiStep === undefined;
    if (position.operator === "-" && isLeftMultiStep) {
        left = [{ "type": "number", "value": -1, "index": 0 }];
    }
    let replacementCell = [];
    for (let i = 0; i < left.length; i++) {
        for (let j = 0; j < right.length; j++) {
            replacementCell.push(left[i]);
            replacementCell.push({ "type": "operator", "value": "*", "index": 0 });
            replacementCell.push(right[j]);
        }
    }
    const is = position.operator === "-" && isLeftMultiStep;
    const start = is ? position.index : position.left.breakChar;
    const length = position.right.breakChar - (is ? position.index : position.left.breakChar);
    tokens.insertTokens(start, length + (isLeftMultiStep ? 0 : 1), replacementCell);
    tokens.reIDparentheses();
}
export const curlyBracketsRegex = new RegExp("(frac|sqrt|\\^|\\/|binom)");
function goodByFraction(tokens, position) {
    let replacementTokens = [];
    /*We rely on the denominator to already possess parentheses
    We rely on the fact. that both the nominator and the denominator both have parentheses and closing them
    All calculations are according to that.
    */
    let denominator = tokens.tokens.slice(position.transition, position.right.breakChar);
    for (let i = 0; i < tokens.tokens.length; i++) {
        // Had to change i = position.right.breakChar -->to--> i = position.right.breakChar-1;
        //console.log(tokens.tokens[i].value)
        if (i >= position.index && i < position.right.breakChar) {
            replacementTokens.push(...tokens.tokens.slice(position.index + 1, position.transition));
            i = position.right.breakChar - 1;
            continue;
        }
        if (/(=)/.test(tokens.tokens[i].value)) {
            replacementTokens.push(tokens.tokens[i]);
            continue;
        }
        let replacement = tokens.tokens.slice(i, i + 1);
        let whereAmI = i;
        let rest = [];
        console.log('denominator', denominator);
        if (tokens.tokens[i].value === "frac") {
            whereAmI = new Position(tokens, i);
            replacementTokens.push(...tokens.tokens.slice(whereAmI.index, whereAmI.index + 2));
            //nominator
            rest = tokens.tokens.slice(whereAmI.transition - 1, whereAmI.right.breakChar);
            // denominator
            replacement = tokens.tokens.slice(i + 2, whereAmI.transition - 1);
        }
        else {
            whereAmI = i + tokens.tokens.slice(i).findIndex(token => /(=|frac)/.test(token.value));
            whereAmI = whereAmI < i ? tokens.tokens.length : whereAmI;
            replacement = tokens.tokens.slice(i, whereAmI);
        }
        replacementTokens.push(...denominator, { "type": "operator", "value": "*" }, { "type": "paren", "value": "(", "id": 0, "index": 0 }, ...replacement, { "type": "paren", "value": ")", "id": 0, "index": 0 }, ...rest);
        i = typeof whereAmI === "object" ? whereAmI.right.breakChar - 1 : whereAmI - 1;
    }
    //console.log(replacementTokens)
    tokens.tokens = replacementTokens;
    tokens.reIDparentheses();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW1WZXJ5TGF6eS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9pbVZlcnlMYXp5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFFeEMsTUFBTSxVQUFVLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxRQUFRO0lBQzdDLElBQUksUUFBUSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBQztRQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFBQSxPQUFPO0tBQUM7SUFDekUsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLGlDQUFpQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUMxSSxJQUFJLEtBQUssR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsS0FBSyxFQUFFLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsaUNBQWlDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzVJLE1BQU0sZUFBZSxHQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxLQUFHLFNBQVMsQ0FBQztJQUUxRCxJQUFJLFFBQVEsQ0FBQyxRQUFRLEtBQUcsR0FBRyxJQUFFLGVBQWUsRUFBQztRQUN6QyxJQUFJLEdBQUcsQ0FBQyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFBO0tBRXpEO0lBQ0QsSUFB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LENBQUMsSUFBSSxDQUNsQixHQUFHLFdBQVcsRUFDZCxFQUFDLE1BQU0sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBQyxFQUNsQyxFQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLEVBQUMsRUFDcEQsR0FBRyxXQUFXLEVBQ2QsRUFBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFDLEVBQ3BELEdBQUcsSUFBSSxDQUNWLENBQUM7UUFDRixDQUFDLEdBQUcsT0FBTyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFNBQVMsR0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBQyxDQUFDLENBQUM7S0FDOUU7SUFDRCxnQ0FBZ0M7SUFDaEMsTUFBTSxDQUFDLE1BQU0sR0FBQyxpQkFBaUIsQ0FBQztJQUNoQyxNQUFNLENBQUMsZUFBZSxFQUFFLENBQUM7QUFDN0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBvc2l0aW9uIH0gZnJvbSBcIi4vbWF0aEVuZ2luZVwiO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGV4cGFuZEV4cHJlc3Npb24odG9rZW5zLCBwb3NpdGlvbikge1xyXG4gICAgaWYgKHBvc2l0aW9uLmNoZWNrRnJhYyh0b2tlbnMpKXtnb29kQnlGcmFjdGlvbih0b2tlbnMsIHBvc2l0aW9uKTtyZXR1cm47fVxyXG4gICAgbGV0IGxlZnQgPSB0b2tlbnMudG9rZW5zLnNsaWNlKHBvc2l0aW9uLmxlZnQuYnJlYWtDaGFyLCBwb3NpdGlvbi5pbmRleCkuZmlsdGVyKGl0ZW0gPT4gLyhudW1iZXJ8dmFyaWFibGV8cG93ZXJWYXJpYWJsZSkvLnRlc3QoaXRlbS50eXBlKSk7XHJcbiAgICBsZXQgcmlnaHQgPSB0b2tlbnMudG9rZW5zLnNsaWNlKHBvc2l0aW9uLmluZGV4LCBwb3NpdGlvbi5yaWdodC5icmVha0NoYXIpLmZpbHRlcihpdGVtID0+IC8obnVtYmVyfHZhcmlhYmxlfHBvd2VyVmFyaWFibGUpLy50ZXN0KGl0ZW0udHlwZSkpO1xyXG4gICAgY29uc3QgaXNMZWZ0TXVsdGlTdGVwPXBvc2l0aW9uLmxlZnQubXVsdGlTdGVwPT09dW5kZWZpbmVkO1xyXG5cclxuICAgIGlmIChwb3NpdGlvbi5vcGVyYXRvcj09PVwiLVwiJiZpc0xlZnRNdWx0aVN0ZXApe1xyXG4gICAgICAgIGxlZnQgPSBbeyBcInR5cGVcIjogXCJudW1iZXJcIiwgXCJ2YWx1ZVwiOiAtMSwgXCJpbmRleFwiOiAwIH1dXHJcbiAgICAgICAgXHJcbiAgICB9XHJcbiAgICBsZXQgcmVwbGFjZW1lbnRDZWxsID0gW107XHJcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxlZnQubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBmb3IgKGxldCBqID0gMDsgaiA8IHJpZ2h0Lmxlbmd0aDsgaisrKSB7XHJcbiAgICAgICAgICAgIHJlcGxhY2VtZW50Q2VsbC5wdXNoKGxlZnRbaV0pO1xyXG4gICAgICAgICAgICByZXBsYWNlbWVudENlbGwucHVzaCh7IFwidHlwZVwiOiBcIm9wZXJhdG9yXCIsIFwidmFsdWVcIjogXCIqXCIsIFwiaW5kZXhcIjogMCB9KTtcclxuICAgICAgICAgICAgcmVwbGFjZW1lbnRDZWxsLnB1c2gocmlnaHRbal0pO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBpcz1wb3NpdGlvbi5vcGVyYXRvcj09PVwiLVwiJiZpc0xlZnRNdWx0aVN0ZXA7XHJcbiAgICBjb25zdCBzdGFydD1pcz9wb3NpdGlvbi5pbmRleDpwb3NpdGlvbi5sZWZ0LmJyZWFrQ2hhclxyXG4gICAgY29uc3QgbGVuZ3RoPXBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhci0oaXM/cG9zaXRpb24uaW5kZXg6cG9zaXRpb24ubGVmdC5icmVha0NoYXIpXHJcbiAgICB0b2tlbnMuaW5zZXJ0VG9rZW5zKHN0YXJ0LCBsZW5ndGgrKGlzTGVmdE11bHRpU3RlcD8wOjEpLCByZXBsYWNlbWVudENlbGwpO1xyXG4gICAgdG9rZW5zLnJlSURwYXJlbnRoZXNlcygpO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgY3VybHlCcmFja2V0c1JlZ2V4ID0gbmV3IFJlZ0V4cChcIihmcmFjfHNxcnR8XFxcXF58XFxcXC98Ymlub20pXCIpXHJcblxyXG5cclxuXHJcbmZ1bmN0aW9uIGdvb2RCeUZyYWN0aW9uKHRva2VucywgcG9zaXRpb24pIHtcclxuICAgIGxldCByZXBsYWNlbWVudFRva2VucyA9IFtdO1xyXG4gICAgLypXZSByZWx5IG9uIHRoZSBkZW5vbWluYXRvciB0byBhbHJlYWR5IHBvc3Nlc3MgcGFyZW50aGVzZXNcclxuICAgIFdlIHJlbHkgb24gdGhlIGZhY3QuIHRoYXQgYm90aCB0aGUgbm9taW5hdG9yIGFuZCB0aGUgZGVub21pbmF0b3IgYm90aCBoYXZlIHBhcmVudGhlc2VzIGFuZCBjbG9zaW5nIHRoZW0gXHJcbiAgICBBbGwgY2FsY3VsYXRpb25zIGFyZSBhY2NvcmRpbmcgdG8gdGhhdC5cclxuICAgICovXHJcbiAgICBsZXQgZGVub21pbmF0b3IgPSB0b2tlbnMudG9rZW5zLnNsaWNlKHBvc2l0aW9uLnRyYW5zaXRpb24sIHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhcik7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b2tlbnMudG9rZW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgLy8gSGFkIHRvIGNoYW5nZSBpID0gcG9zaXRpb24ucmlnaHQuYnJlYWtDaGFyIC0tPnRvLS0+IGkgPSBwb3NpdGlvbi5yaWdodC5icmVha0NoYXItMTtcclxuICAgICAgICAvL2NvbnNvbGUubG9nKHRva2Vucy50b2tlbnNbaV0udmFsdWUpXHJcbiAgICAgICAgaWYgKGkgPj0gcG9zaXRpb24uaW5kZXggJiYgaSA8IHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhcikge1xyXG4gICAgICAgICAgICByZXBsYWNlbWVudFRva2Vucy5wdXNoKC4uLnRva2Vucy50b2tlbnMuc2xpY2UocG9zaXRpb24uaW5kZXgrMSxwb3NpdGlvbi50cmFuc2l0aW9uKSlcclxuICAgICAgICAgICAgaSA9IHBvc2l0aW9uLnJpZ2h0LmJyZWFrQ2hhci0xO1xyXG4gICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGlmICgvKD0pLy50ZXN0KHRva2Vucy50b2tlbnNbaV0udmFsdWUpKSB7XHJcbiAgICAgICAgICAgIHJlcGxhY2VtZW50VG9rZW5zLnB1c2godG9rZW5zLnRva2Vuc1tpXSk7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBsZXQgcmVwbGFjZW1lbnQgPSB0b2tlbnMudG9rZW5zLnNsaWNlKGksaSsxKVxyXG4gICAgICAgIGxldCB3aGVyZUFtSSA9IGk7XHJcbiAgICAgICAgbGV0IHJlc3Q9W107XHJcbiAgICAgICAgY29uc29sZS5sb2coJ2Rlbm9taW5hdG9yJyxkZW5vbWluYXRvcilcclxuICAgICAgICBpZiAodG9rZW5zLnRva2Vuc1tpXS52YWx1ZSA9PT0gXCJmcmFjXCIpIHtcclxuICAgICAgICAgICAgd2hlcmVBbUkgPSBuZXcgUG9zaXRpb24odG9rZW5zLCBpKTtcclxuICAgICAgICAgICAgcmVwbGFjZW1lbnRUb2tlbnMucHVzaCguLi50b2tlbnMudG9rZW5zLnNsaWNlKHdoZXJlQW1JLmluZGV4LHdoZXJlQW1JLmluZGV4KzIpKVxyXG4gICAgICAgICAgICAvL25vbWluYXRvclxyXG4gICAgICAgICAgICByZXN0PXRva2Vucy50b2tlbnMuc2xpY2Uod2hlcmVBbUkudHJhbnNpdGlvbi0xLHdoZXJlQW1JLnJpZ2h0LmJyZWFrQ2hhcilcclxuICAgICAgICAgICAgLy8gZGVub21pbmF0b3JcclxuICAgICAgICAgICAgcmVwbGFjZW1lbnQgPSB0b2tlbnMudG9rZW5zLnNsaWNlKGkgKyAyLCB3aGVyZUFtSS50cmFuc2l0aW9uLTEpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBlbHNle1xyXG4gICAgICAgICAgICB3aGVyZUFtST1pK3Rva2Vucy50b2tlbnMuc2xpY2UoaSkuZmluZEluZGV4KHRva2VuID0+IC8oPXxmcmFjKS8udGVzdCh0b2tlbi52YWx1ZSkpXHJcbiAgICAgICAgICAgIHdoZXJlQW1JPXdoZXJlQW1JPGk/dG9rZW5zLnRva2Vucy5sZW5ndGg6d2hlcmVBbUk7XHJcbiAgICAgICAgICAgIHJlcGxhY2VtZW50ID0gdG9rZW5zLnRva2Vucy5zbGljZShpLHdoZXJlQW1JKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmVwbGFjZW1lbnRUb2tlbnMucHVzaChcclxuICAgICAgICAgICAgLi4uZGVub21pbmF0b3IsXHJcbiAgICAgICAgICAgIHtcInR5cGVcIjogXCJvcGVyYXRvclwiLCBcInZhbHVlXCI6IFwiKlwifSxcclxuICAgICAgICAgICAge1widHlwZVwiOiBcInBhcmVuXCIsIFwidmFsdWVcIjogXCIoXCIsIFwiaWRcIjogMCwgXCJpbmRleFwiOiAwfSxcclxuICAgICAgICAgICAgLi4ucmVwbGFjZW1lbnQsXHJcbiAgICAgICAgICAgIHtcInR5cGVcIjogXCJwYXJlblwiLCBcInZhbHVlXCI6IFwiKVwiLCBcImlkXCI6IDAsIFwiaW5kZXhcIjogMH0sXHJcbiAgICAgICAgICAgIC4uLnJlc3RcclxuICAgICAgICApO1xyXG4gICAgICAgIGkgPSB0eXBlb2Ygd2hlcmVBbUkgPT09IFwib2JqZWN0XCIgPyB3aGVyZUFtSS5yaWdodC5icmVha0NoYXItMSA6IHdoZXJlQW1JLTE7XHJcbiAgICB9XHJcbiAgICAvL2NvbnNvbGUubG9nKHJlcGxhY2VtZW50VG9rZW5zKVxyXG4gICAgdG9rZW5zLnRva2Vucz1yZXBsYWNlbWVudFRva2VucztcclxuICAgIHRva2Vucy5yZUlEcGFyZW50aGVzZXMoKTtcclxufSJdfQ==