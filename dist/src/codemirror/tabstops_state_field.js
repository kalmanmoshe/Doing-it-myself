import { EditorView, Decoration } from "@codemirror/view";
import { StateEffect, StateField } from "@codemirror/state";
const addTabstopsEffect = StateEffect.define();
const removeAllTabstopsEffect = StateEffect.define();
export const tabstopsStateField = StateField.define({
    create() {
        return [];
    },
    update(value, transaction) {
        let tabstopGroups = value;
        tabstopGroups.forEach(grp => grp.map(transaction.changes));
        for (const effect of transaction.effects) {
            if (effect.is(addTabstopsEffect)) {
                tabstopGroups.unshift(...effect.value);
            }
            else if (effect.is(removeAllTabstopsEffect)) {
                tabstopGroups = [];
            }
        }
        // Remove the tabstop groups that the cursor has passed. This scenario
        // happens when the user manually moves the cursor using arrow keys or mouse
        if (transaction.selection) {
            const currTabstopGroupIndex = getCurrentTabstopGroupIndex(tabstopGroups, transaction.selection);
            tabstopGroups = tabstopGroups.slice(currTabstopGroupIndex);
            if (tabstopGroups.length <= 1) {
                // Clear all tabstop groups if there's just one remaining
                tabstopGroups = [];
            }
            else {
                tabstopGroups[0].hideFromEditor();
            }
        }
        return tabstopGroups;
    },
    provide: (field) => {
        return EditorView.decorations.of(view => {
            // "Flatten" the array of DecorationSets to produce a single DecorationSet
            const tabstopGroups = view.state.field(field);
            const decos = [];
            for (const tabstopGroup of tabstopGroups) {
                if (!tabstopGroup.hidden)
                    decos.push(...tabstopGroup.getRanges());
            }
            return Decoration.set(decos, true);
        });
    }
});
function getCurrentTabstopGroupIndex(tabstopGroups, sel) {
    for (let i = 0; i < tabstopGroups.length; i++) {
        const tabstopGroup = tabstopGroups[i];
        if (tabstopGroup.containsSelection(sel))
            return i;
    }
    return tabstopGroups.length;
}
export function getTabstopGroupsFromView(view) {
    const currentTabstopGroups = view.state.field(tabstopsStateField);
    return currentTabstopGroups;
}
export function addTabstops(view, tabstopGroups) {
    view.dispatch({
        effects: [addTabstopsEffect.of(tabstopGroups)],
    });
}
export function removeAllTabstops(view) {
    view.dispatch({
        effects: [removeAllTabstopsEffect.of(null)],
    });
}
// const COLORS = ["lightskyblue", "orange", "lime"];
const N_COLORS = 3;
export function getNextTabstopColor(view) {
    const field = view.state.field(tabstopsStateField);
    const existingColors = field.map(tabstopGroup => tabstopGroup.color);
    const uniqueExistingColors = new Set(existingColors);
    for (let i = 0; i < N_COLORS; i++) {
        if (!uniqueExistingColors.has(i))
            return i;
    }
    return 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFic3RvcHNfc3RhdGVfZmllbGQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29kZW1pcnJvci90YWJzdG9wc19zdGF0ZV9maWVsZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzFELE9BQU8sRUFBbUIsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRzdFLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBa0IsQ0FBQztBQUMvRCxNQUFNLHVCQUF1QixHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVyRCxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFpQjtJQUVuRSxNQUFNO1FBQ0wsT0FBTyxFQUFFLENBQUM7SUFDWCxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssRUFBRSxXQUFXO1FBQ3hCLElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztRQUMxQixhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUUzRCxLQUFLLE1BQU0sTUFBTSxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUMxQyxJQUFJLE1BQU0sQ0FBQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO2dCQUNsQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hDLENBQUM7aUJBQ0ksSUFBSSxNQUFNLENBQUMsRUFBRSxDQUFDLHVCQUF1QixDQUFDLEVBQUUsQ0FBQztnQkFDN0MsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUNwQixDQUFDO1FBQ0YsQ0FBQztRQUVELHNFQUFzRTtRQUN0RSw0RUFBNEU7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QyxjQUFjLENBQUMsQ0FBQztJQUVyRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsT0FBTyxDQUFDLENBQUM7QUFDVixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldywgRGVjb3JhdGlvbiB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XG5pbXBvcnQgeyBFZGl0b3JTZWxlY3Rpb24sIFN0YXRlRWZmZWN0LCBTdGF0ZUZpZWxkIH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XG5pbXBvcnQgeyBUYWJzdG9wR3JvdXAgfSBmcm9tIFwic3JjL3NuaXBwZXRzL3RhYnN0b3BcIjtcblxuY29uc3QgYWRkVGFic3RvcHNFZmZlY3QgPSBTdGF0ZUVmZmVjdC5kZWZpbmU8VGFic3RvcEdyb3VwW10+KCk7XG5jb25zdCByZW1vdmVBbGxUYWJzdG9wc0VmZmVjdCA9IFN0YXRlRWZmZWN0LmRlZmluZSgpO1xuXG5leHBvcnQgY29uc3QgdGFic3RvcHNTdGF0ZUZpZWxkID0gU3RhdGVGaWVsZC5kZWZpbmU8VGFic3RvcEdyb3VwW10+KHtcblxuXHRjcmVhdGUoKSB7XG5cdFx0cmV0dXJuIFtdO1xuXHR9LFxuXG5cdHVwZGF0ZSh2YWx1ZSwgdHJhbnNhY3Rpb24pIHtcblx0XHRsZXQgdGFic3RvcEdyb3VwcyA9IHZhbHVlO1xuXHRcdHRhYnN0b3BHcm91cHMuZm9yRWFjaChncnAgPT4gZ3JwLm1hcCh0cmFuc2FjdGlvbi5jaGFuZ2VzKSk7XG5cblx0XHRmb3IgKGNvbnN0IGVmZmVjdCBvZiB0cmFuc2FjdGlvbi5lZmZlY3RzKSB7XG5cdFx0XHRpZiAoZWZmZWN0LmlzKGFkZFRhYnN0b3BzRWZmZWN0KSkge1xuXHRcdFx0XHR0YWJzdG9wR3JvdXBzLnVuc2hpZnQoLi4uZWZmZWN0LnZhbHVlKTtcblx0XHRcdH1cblx0XHRcdGVsc2UgaWYgKGVmZmVjdC5pcyhyZW1vdmVBbGxUYWJzdG9wc0VmZmVjdCkpIHtcblx0XHRcdFx0dGFic3RvcEdyb3VwcyA9IFtdO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdC8vIFJlbW92ZSB0aGUgdGFic3RvcCBncm91cHMgdGhhdCB0aGUgY3Vyc29yIGhhcyBwYXNzZWQuIFRoaXMgc2NlbmFyaW9cblx0XHQvLyBoYXBwZW5zIHdoZW4gdGhlIHVzZXIgbWFudWFsbHkgbW92ZXMgdGhlIGN1cnNvciB1c2luZyBhcnJvdyBrZXlzIG9yIG1vdXNlXG5cdFx0aWYgKHRyYW5zYWN0aW9uLnNlbGVjdGlvbikge1xuXHRcdFx0Y29uc3QgY3VyclRhYnN0b3BHcm91cEluZGV4ID0gZ2V0Q3VycmVudFRhYnN0b3BHcm91cEluZGV4KFxuXHRcdFx0XHR0YWJzdG9wR3JvdXBzLFxuXHRcdFx0XHR0cmFuc2FjdGlvbi5zZWxlY3Rpb25cblx0XHRcdCk7XG5cdFx0XHR0YWJzdG9wR3JvdXBzID0gdGFic3RvcEdyb3Vwcy5zbGljZShjdXJyVGFic3RvcEdyb3VwSW5kZXgpO1xuXHRcdFx0XG5cdFx0XHRpZiAodGFic3RvcEdyb3Vwcy5sZW5ndGggPD0gMSkge1xuXHRcdFx0XHQvLyBDbGVhciBhbGwgdGFic3RvcCBncm91cHMgaWYgdGhlcmUncyBqdXN0IG9uZSByZW1haW5pbmdcblx0XHRcdFx0dGFic3RvcEdyb3VwcyA9IFtdO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0dGFic3RvcEdyb3Vwc1swXS5oaWRlRnJvbUVkaXRvcigpO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdHJldHVybiB0YWJzdG9wR3JvdXBzO1xuXHR9LFxuXG5cdHByb3ZpZGU6IChmaWVsZCkgPT4ge1xuXHRcdHJldHVybiBFZGl0b3JWaWV3LmRlY29yYXRpb25zLm9mKHZpZXcgPT4ge1xuXHRcdFx0Ly8gXCJGbGF0dGVuXCIgdGhlIGFycmF5IG9mIERlY29yYXRpb25TZXRzIHRvIHByb2R1Y2UgYSBzaW5nbGUgRGVjb3JhdGlvblNldFxuXHRcdFx0Y29uc3QgdGFic3RvcEdyb3VwcyA9IHZpZXcuc3RhdGUuZmllbGQoZmllbGQpO1xuXHRcdFx0Y29uc3QgZGVjb3MgPSBbXTtcblxuXHRcdFx0Zm9yIChjb25zdCB0YWJzdG9wR3JvdXAgb2YgdGFic3RvcEdyb3Vwcykge1xuXHRcdFx0XHRpZiAoIXRhYnN0b3BHcm91cC5oaWRkZW4pXG5cdFx0XHRcdFx0ZGVjb3MucHVzaCguLi50YWJzdG9wR3JvdXAuZ2V0UmFuZ2VzKCkpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gRGVjb3JhdGlvbi5zZXQoZGVjb3MsIHRydWUpO1xuXHRcdH0pO1xuXHR9XG59KTtcblxuZnVuY3Rpb24gZ2V0Q3VycmVudFRhYnN0b3BHcm91cEluZGV4KFxuXHR0YWJzdG9wR3JvdXBzOiBUYWJzdG9wR3JvdXBbXSxcblx0c2VsOiBFZGl0b3JTZWxlY3Rpb25cbik6IG51bWJlciB7XG5cdGZvciAobGV0IGkgPSAwOyBpIDwgdGFic3RvcEdyb3Vwcy5sZW5ndGg7IGkrKykge1xuXHRcdGNvbnN0IHRhYnN0b3BHcm91cCA9IHRhYnN0b3BHcm91cHNbaV07XG5cdFx0aWYgKHRhYnN0b3BHcm91cC5jb250YWluc1NlbGVjdGlvbihzZWwpKSByZXR1cm4gaTtcblx0fVxuXHRyZXR1cm4gdGFic3RvcEdyb3Vwcy5sZW5ndGg7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRUYWJzdG9wR3JvdXBzRnJvbVZpZXcodmlldzogRWRpdG9yVmlldykge1xuXHRjb25zdCBjdXJyZW50VGFic3RvcEdyb3VwcyA9IHZpZXcuc3RhdGUuZmllbGQodGFic3RvcHNTdGF0ZUZpZWxkKTtcblxuXHRyZXR1cm4gY3VycmVudFRhYnN0b3BHcm91cHM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGRUYWJzdG9wcyh2aWV3OiBFZGl0b3JWaWV3LCB0YWJzdG9wR3JvdXBzOiBUYWJzdG9wR3JvdXBbXSkge1xuXHR2aWV3LmRpc3BhdGNoKHtcblx0XHRlZmZlY3RzOiBbYWRkVGFic3RvcHNFZmZlY3Qub2YodGFic3RvcEdyb3VwcyldLFxuXHR9KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbW92ZUFsbFRhYnN0b3BzKHZpZXc6IEVkaXRvclZpZXcpIHtcblx0dmlldy5kaXNwYXRjaCh7XG5cdFx0ZWZmZWN0czogW3JlbW92ZUFsbFRhYnN0b3BzRWZmZWN0Lm9mKG51bGwpXSxcblx0fSk7XG59XG5cbi8vIGNvbnN0IENPTE9SUyA9IFtcImxpZ2h0c2t5Ymx1ZVwiLCBcIm9yYW5nZVwiLCBcImxpbWVcIl07XG5jb25zdCBOX0NPTE9SUyA9IDM7XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXROZXh0VGFic3RvcENvbG9yKHZpZXc6IEVkaXRvclZpZXcpIHtcblx0Y29uc3QgZmllbGQgPSB2aWV3LnN0YXRlLmZpZWxkKHRhYnN0b3BzU3RhdGVGaWVsZCk7XG5cdGNvbnN0IGV4aXN0aW5nQ29sb3JzID0gZmllbGQubWFwKHRhYnN0b3BHcm91cCA9PiB0YWJzdG9wR3JvdXAuY29sb3IpO1xuXHRjb25zdCB1bmlxdWVFeGlzdGluZ0NvbG9ycyA9IG5ldyBTZXQoZXhpc3RpbmdDb2xvcnMpO1xuXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgTl9DT0xPUlM7IGkrKykge1xuXHRcdGlmICghdW5pcXVlRXhpc3RpbmdDb2xvcnMuaGFzKGkpKSByZXR1cm4gaTtcblx0fVxuXG5cdHJldHVybiAwO1xufSJdfQ==