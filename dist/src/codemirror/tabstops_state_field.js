import { EditorView, Decoration } from "@codemirror/view";
import { StateEffect, StateField } from "@codemirror/state";
const addTabstopsEffect = StateEffect.define();
const removeAllTabstopsEffect = StateEffect.define();
export const tabstopsStateField = StateField.define({
    create() {
        return [];
    },
    update(value, transaction) {
        let tabstopGroups = value;
        tabstopGroups.forEach(grp => grp.map(transaction.changes));
        for (const effect of transaction.effects) {
            if (effect.is(addTabstopsEffect)) {
                tabstopGroups.unshift(...effect.value);
            }
            else if (effect.is(removeAllTabstopsEffect)) {
                tabstopGroups = [];
            }
        }
        // Remove the tabstop groups that the cursor has passed. This scenario
        // happens when the user manually moves the cursor using arrow keys or mouse
        if (transaction.selection) {
            const currTabstopGroupIndex = getCurrentTabstopGroupIndex(tabstopGroups, transaction.selection);
            tabstopGroups = tabstopGroups.slice(currTabstopGroupIndex);
            if (tabstopGroups.length <= 1) {
                // Clear all tabstop groups if there's just one remaining
                tabstopGroups = [];
            }
            else {
                tabstopGroups[0].hideFromEditor();
            }
        }
        return tabstopGroups;
    },
    provide: (field) => {
        return EditorView.decorations.of(view => {
            // "Flatten" the array of DecorationSets to produce a single DecorationSet
            const tabstopGroups = view.state.field(field);
            const decos = [];
            for (const tabstopGroup of tabstopGroups) {
                if (!tabstopGroup.hidden)
                    decos.push(...tabstopGroup.getRanges());
            }
            return Decoration.set(decos, true);
        });
    }
});
function getCurrentTabstopGroupIndex(tabstopGroups, sel) {
    for (let i = 0; i < tabstopGroups.length; i++) {
        const tabstopGroup = tabstopGroups[i];
        if (tabstopGroup.containsSelection(sel))
            return i;
    }
    return tabstopGroups.length;
}
export function getTabstopGroupsFromView(view) {
    const currentTabstopGroups = view.state.field(tabstopsStateField);
    return currentTabstopGroups;
}
export function addTabstops(view, tabstopGroups) {
    view.dispatch({
        effects: [addTabstopsEffect.of(tabstopGroups)],
    });
}
export function removeAllTabstops(view) {
    view.dispatch({
        effects: [removeAllTabstopsEffect.of(null)],
    });
}
// const COLORS = ["lightskyblue", "orange", "lime"];
const N_COLORS = 3;
export function getNextTabstopColor(view) {
    const field = view.state.field(tabstopsStateField);
    const existingColors = field.map(tabstopGroup => tabstopGroup.color);
    const uniqueExistingColors = new Set(existingColors);
    for (let i = 0; i < N_COLORS; i++) {
        if (!uniqueExistingColors.has(i))
            return i;
    }
    return 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGFic3RvcHNfc3RhdGVfZmllbGQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvY29kZW1pcnJvci90YWJzdG9wc19zdGF0ZV9maWVsZC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBQzFELE9BQU8sRUFBbUIsV0FBVyxFQUFFLFVBQVUsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRzdFLE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLE1BQU0sRUFBa0IsQ0FBQztBQUMvRCxNQUFNLHVCQUF1QixHQUFHLFdBQVcsQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUVyRCxNQUFNLENBQUMsTUFBTSxrQkFBa0IsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFpQjtJQUVuRSxNQUFNO1FBQ0wsT0FBTyxFQUFFLENBQUM7SUFDWCxDQUFDO0lBRUQsTUFBTSxDQUFDLEtBQUssRUFBRSxXQUFXO1FBQ3hCLElBQUksYUFBYSxHQUFHLEtBQUssQ0FBQztRQUMxQixhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQztRQUUzRCxLQUFLLE1BQU0sTUFBTSxJQUFJLFdBQVcsQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUMxQyxJQUFJLE1BQU0sQ0FBQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO2dCQUNsQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hDLENBQUM7aUJBQ0ksSUFBSSxNQUFNLENBQUMsRUFBRSxDQUFDLHVCQUF1QixDQUFDLEVBQUUsQ0FBQztnQkFDN0MsYUFBYSxHQUFHLEVBQUUsQ0FBQztZQUNwQixDQUFDO1FBQ0YsQ0FBQztRQUVELHNFQUFzRTtRQUN0RSw0RUFBNEU7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QyxjQUFjLENBQUMsQ0FBQztJQUVyRCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7UUFDbkMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFBRSxPQUFPLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQsT0FBTyxDQUFDLENBQUM7QUFDVixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldywgRGVjb3JhdGlvbiB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IEVkaXRvclNlbGVjdGlvbiwgU3RhdGVFZmZlY3QsIFN0YXRlRmllbGQgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgVGFic3RvcEdyb3VwIH0gZnJvbSBcInNyYy9zbmlwcGV0cy90YWJzdG9wXCI7XHJcblxyXG5jb25zdCBhZGRUYWJzdG9wc0VmZmVjdCA9IFN0YXRlRWZmZWN0LmRlZmluZTxUYWJzdG9wR3JvdXBbXT4oKTtcclxuY29uc3QgcmVtb3ZlQWxsVGFic3RvcHNFZmZlY3QgPSBTdGF0ZUVmZmVjdC5kZWZpbmUoKTtcclxuXHJcbmV4cG9ydCBjb25zdCB0YWJzdG9wc1N0YXRlRmllbGQgPSBTdGF0ZUZpZWxkLmRlZmluZTxUYWJzdG9wR3JvdXBbXT4oe1xyXG5cclxuXHRjcmVhdGUoKSB7XHJcblx0XHRyZXR1cm4gW107XHJcblx0fSxcclxuXHJcblx0dXBkYXRlKHZhbHVlLCB0cmFuc2FjdGlvbikge1xyXG5cdFx0bGV0IHRhYnN0b3BHcm91cHMgPSB2YWx1ZTtcclxuXHRcdHRhYnN0b3BHcm91cHMuZm9yRWFjaChncnAgPT4gZ3JwLm1hcCh0cmFuc2FjdGlvbi5jaGFuZ2VzKSk7XHJcblxyXG5cdFx0Zm9yIChjb25zdCBlZmZlY3Qgb2YgdHJhbnNhY3Rpb24uZWZmZWN0cykge1xyXG5cdFx0XHRpZiAoZWZmZWN0LmlzKGFkZFRhYnN0b3BzRWZmZWN0KSkge1xyXG5cdFx0XHRcdHRhYnN0b3BHcm91cHMudW5zaGlmdCguLi5lZmZlY3QudmFsdWUpO1xyXG5cdFx0XHR9XHJcblx0XHRcdGVsc2UgaWYgKGVmZmVjdC5pcyhyZW1vdmVBbGxUYWJzdG9wc0VmZmVjdCkpIHtcclxuXHRcdFx0XHR0YWJzdG9wR3JvdXBzID0gW107XHJcblx0XHRcdH1cclxuXHRcdH1cclxuXHJcblx0XHQvLyBSZW1vdmUgdGhlIHRhYnN0b3AgZ3JvdXBzIHRoYXQgdGhlIGN1cnNvciBoYXMgcGFzc2VkLiBUaGlzIHNjZW5hcmlvXHJcblx0XHQvLyBoYXBwZW5zIHdoZW4gdGhlIHVzZXIgbWFudWFsbHkgbW92ZXMgdGhlIGN1cnNvciB1c2luZyBhcnJvdyBrZXlzIG9yIG1vdXNlXHJcblx0XHRpZiAodHJhbnNhY3Rpb24uc2VsZWN0aW9uKSB7XHJcblx0XHRcdGNvbnN0IGN1cnJUYWJzdG9wR3JvdXBJbmRleCA9IGdldEN1cnJlbnRUYWJzdG9wR3JvdXBJbmRleChcclxuXHRcdFx0XHR0YWJzdG9wR3JvdXBzLFxyXG5cdFx0XHRcdHRyYW5zYWN0aW9uLnNlbGVjdGlvblxyXG5cdFx0XHQpO1xyXG5cdFx0XHR0YWJzdG9wR3JvdXBzID0gdGFic3RvcEdyb3Vwcy5zbGljZShjdXJyVGFic3RvcEdyb3VwSW5kZXgpO1xyXG5cdFx0XHRcclxuXHRcdFx0aWYgKHRhYnN0b3BHcm91cHMubGVuZ3RoIDw9IDEpIHtcclxuXHRcdFx0XHQvLyBDbGVhciBhbGwgdGFic3RvcCBncm91cHMgaWYgdGhlcmUncyBqdXN0IG9uZSByZW1haW5pbmdcclxuXHRcdFx0XHR0YWJzdG9wR3JvdXBzID0gW107XHJcblx0XHRcdH0gZWxzZSB7XHJcblx0XHRcdFx0dGFic3RvcEdyb3Vwc1swXS5oaWRlRnJvbUVkaXRvcigpO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblxyXG5cdFx0cmV0dXJuIHRhYnN0b3BHcm91cHM7XHJcblx0fSxcclxuXHJcblx0cHJvdmlkZTogKGZpZWxkKSA9PiB7XHJcblx0XHRyZXR1cm4gRWRpdG9yVmlldy5kZWNvcmF0aW9ucy5vZih2aWV3ID0+IHtcclxuXHRcdFx0Ly8gXCJGbGF0dGVuXCIgdGhlIGFycmF5IG9mIERlY29yYXRpb25TZXRzIHRvIHByb2R1Y2UgYSBzaW5nbGUgRGVjb3JhdGlvblNldFxyXG5cdFx0XHRjb25zdCB0YWJzdG9wR3JvdXBzID0gdmlldy5zdGF0ZS5maWVsZChmaWVsZCk7XHJcblx0XHRcdGNvbnN0IGRlY29zID0gW107XHJcblxyXG5cdFx0XHRmb3IgKGNvbnN0IHRhYnN0b3BHcm91cCBvZiB0YWJzdG9wR3JvdXBzKSB7XHJcblx0XHRcdFx0aWYgKCF0YWJzdG9wR3JvdXAuaGlkZGVuKVxyXG5cdFx0XHRcdFx0ZGVjb3MucHVzaCguLi50YWJzdG9wR3JvdXAuZ2V0UmFuZ2VzKCkpO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRyZXR1cm4gRGVjb3JhdGlvbi5zZXQoZGVjb3MsIHRydWUpO1xyXG5cdFx0fSk7XHJcblx0fVxyXG59KTtcclxuXHJcbmZ1bmN0aW9uIGdldEN1cnJlbnRUYWJzdG9wR3JvdXBJbmRleChcclxuXHR0YWJzdG9wR3JvdXBzOiBUYWJzdG9wR3JvdXBbXSxcclxuXHRzZWw6IEVkaXRvclNlbGVjdGlvblxyXG4pOiBudW1iZXIge1xyXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgdGFic3RvcEdyb3Vwcy5sZW5ndGg7IGkrKykge1xyXG5cdFx0Y29uc3QgdGFic3RvcEdyb3VwID0gdGFic3RvcEdyb3Vwc1tpXTtcclxuXHRcdGlmICh0YWJzdG9wR3JvdXAuY29udGFpbnNTZWxlY3Rpb24oc2VsKSkgcmV0dXJuIGk7XHJcblx0fVxyXG5cdHJldHVybiB0YWJzdG9wR3JvdXBzLmxlbmd0aDtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldFRhYnN0b3BHcm91cHNGcm9tVmlldyh2aWV3OiBFZGl0b3JWaWV3KSB7XHJcblx0Y29uc3QgY3VycmVudFRhYnN0b3BHcm91cHMgPSB2aWV3LnN0YXRlLmZpZWxkKHRhYnN0b3BzU3RhdGVGaWVsZCk7XHJcblxyXG5cdHJldHVybiBjdXJyZW50VGFic3RvcEdyb3VwcztcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGFkZFRhYnN0b3BzKHZpZXc6IEVkaXRvclZpZXcsIHRhYnN0b3BHcm91cHM6IFRhYnN0b3BHcm91cFtdKSB7XHJcblx0dmlldy5kaXNwYXRjaCh7XHJcblx0XHRlZmZlY3RzOiBbYWRkVGFic3RvcHNFZmZlY3Qub2YodGFic3RvcEdyb3VwcyldLFxyXG5cdH0pO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlQWxsVGFic3RvcHModmlldzogRWRpdG9yVmlldykge1xyXG5cdHZpZXcuZGlzcGF0Y2goe1xyXG5cdFx0ZWZmZWN0czogW3JlbW92ZUFsbFRhYnN0b3BzRWZmZWN0Lm9mKG51bGwpXSxcclxuXHR9KTtcclxufVxyXG5cclxuLy8gY29uc3QgQ09MT1JTID0gW1wibGlnaHRza3libHVlXCIsIFwib3JhbmdlXCIsIFwibGltZVwiXTtcclxuY29uc3QgTl9DT0xPUlMgPSAzO1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldE5leHRUYWJzdG9wQ29sb3IodmlldzogRWRpdG9yVmlldykge1xyXG5cdGNvbnN0IGZpZWxkID0gdmlldy5zdGF0ZS5maWVsZCh0YWJzdG9wc1N0YXRlRmllbGQpO1xyXG5cdGNvbnN0IGV4aXN0aW5nQ29sb3JzID0gZmllbGQubWFwKHRhYnN0b3BHcm91cCA9PiB0YWJzdG9wR3JvdXAuY29sb3IpO1xyXG5cdGNvbnN0IHVuaXF1ZUV4aXN0aW5nQ29sb3JzID0gbmV3IFNldChleGlzdGluZ0NvbG9ycyk7XHJcblxyXG5cdGZvciAobGV0IGkgPSAwOyBpIDwgTl9DT0xPUlM7IGkrKykge1xyXG5cdFx0aWYgKCF1bmlxdWVFeGlzdGluZ0NvbG9ycy5oYXMoaSkpIHJldHVybiBpO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIDA7XHJcbn0iXX0=