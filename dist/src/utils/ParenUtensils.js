import { BasicMathJaxToken, BasicTikzToken } from "src/mathParser/basicToken";
import { BracketState, BracketType } from "src/staticData/encasings";
export class Paren {
    constructor(type, state, depth, depthID) {
        this.type = type;
        this.state = state;
        this.depth = depth;
        this.depthID = depthID;
    }
    static create(data, depth, depthID) {
        const capitalize = (str) => str.charAt(0).toUpperCase() + str.slice(1);
        const [type, state] = data.split('_');
        const normalizedType = capitalize(type);
        const normalizedState = capitalize(state);
        if (!(normalizedType in BracketType) || !(normalizedState in BracketState)) {
            throw new Error(`Invalid type or state: ${normalizedType}, ${normalizedState}`);
        }
        return new Paren(BracketType[normalizedType], BracketState[normalizedState], depth, depthID);
    }
    clone() { return new Paren(this.type, this.state, this.depth, this.depthID); }
    toString() { return this.depth + "." + this.depthID; }
    compare(paren) {
        if (!(paren instanceof Paren))
            return false;
        return this.depth === paren.depth && this.depthID === paren.depthID;
    }
    addDepth(num) { this.depth += num; }
    isOpen() { return this.state === BracketState.Open; }
    adddepthID(num) { this.depthID += num; }
}
export function idParentheses(tokens) {
    const newTokens = [];
    let depth = 0;
    const depthCounts = {};
    for (let i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        if (parenState(token, true) && !(token instanceof Paren) && token.isValueString()) {
            if (!depthCounts[depth]) {
                depthCounts[depth] = 0;
            }
            const depthID = depthCounts[depth]++;
            const paren = Paren.create(token.value, depth, depthID);
            newTokens.push(paren);
            depth++;
            continue;
        }
        if (parenState(token) && !(token instanceof Paren) && token.isValueString()) {
            depth--;
            if (depth < 0) {
                console.error(token.getValue(), tokens);
                throw new Error("Unmatched closing parenthesis detected.");
            }
            // Assign a unique ID to the closing parenthesis
            const depthID = depthCounts[depth] - 1;
            const paren = Paren.create(token.value, depth, depthID);
            newTokens.push(paren);
            continue;
        }
        newTokens.push(token.clone());
    }
    if (depth !== 0) {
        console.error(tokens);
        throw new Error(`Unmatched opening parenthesis(es) detected: depth=${depth}`);
    }
    return newTokens;
}
export function mapBrackets(type, tokens) {
    return tokens
        .map((token, index) => token.name === type
        ? /*findParenIndex(token.value, undefined, tokens) */ 'errMoshe'
        : null)
        .filter((t) => t !== null);
}
export const parenState = (item, open = false) => {
    let isOpen;
    switch (true) {
        case item instanceof Paren:
            isOpen = item.isOpen();
            break;
        case (item instanceof BasicMathJaxToken || item instanceof BasicTikzToken) && item.isValueString() && item.getStringValue().split('_')[1] !== undefined:
            isOpen = item.getStringValue().split('_')[1] === BracketState.Open;
            break;
    }
    if (isOpen !== undefined) {
        return open ? isOpen : !isOpen;
    }
    return false;
};
export function findModifiedParenIndex(id, tokens, depth, depthID, filter) {
    id = (id instanceof Paren ? id.clone() : tokens[id].clone());
    if (depth !== undefined && depthID !== undefined) {
        id.depth += depth || 0;
        id.depthID += depthID || 0;
    }
    const openIndex = tokens.findIndex(token => {
        var _a;
        if (parenState(token, true) && ((_a = token.value) === null || _a === void 0 ? void 0 : _a.compare(id))) {
            if (filter && !token.name.startsWith(filter)) {
                id.depth = token.value.depth + (depth || 0);
                id.depthID = token.value.depthID + (depthID || 0);
                return false;
            }
            return true;
        }
        return false;
    });
    const closeIndex = tokens.findLastIndex(token => {
        var _a;
        return parenState(token, true) &&
            ((_a = token.value) === null || _a === void 0 ? void 0 : _a.compare(id));
    });
    return { open: openIndex, close: closeIndex, id };
}
/**
 * Finds the indices of the opening and closing parentheses based on the given ID.
 * @param {Paren|number} id - The identifier to compare tokens. Defaults to the token at the given index if a number is provided.
 * @param {Array} tokens - The array of tokens to search within.
 * @returns {{open: number, close: number, id: Paren}} An object containing the indices of the opening and closing parentheses and the matched ID.
 * - `open`: The index of the first matching opening parenthesis.
 * - `close`: The index of the last matching closing parenthesis.
 * - `id`: The identifier used for comparison.
 */
export function findParenIndex(id, tokens) {
    if (!(id instanceof Paren)) {
        id = tokens[id];
        if (!(id instanceof Paren))
            throw new TypeError("Invalid ID: Expected a Paren object or a valid index.");
    }
    const openIndex = tokens.findIndex((token) => parenState(token, true) && id.compare(token));
    const closeIndex = tokens.findLastIndex((token) => parenState(token) && id.compare(token));
    if (openIndex === -1 || closeIndex === -1)
        throw new Error('Parentheses not found');
    return { open: openIndex, close: closeIndex, id };
}
export function findDeepestParenthesesScope(tokens) {
    let begin = 0, end = tokens.length;
    let deepestScope = null;
    let currentScope = null;
    for (let i = 0; i < tokens.length; i++) {
        if (parenState(tokens[i], true)) {
            currentScope = findParenIndex(tokens[i], tokens);
        }
        if (currentScope !== null && i === currentScope.close) {
            [begin, end] = [currentScope.open, currentScope.close];
            deepestScope = currentScope.id;
            break;
        }
    }
    return { begin, end, deepestParenthesesScope: deepestScope !== null && deepestScope !== void 0 ? deepestScope : null };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFyZW5VdGVuc2lscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9QYXJlblV0ZW5zaWxzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxjQUFjLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUM5RSxPQUFPLEVBQUUsWUFBWSxFQUFFLFdBQVcsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3JFLE1BQU0sT0FBTyxLQUFLO0lBTWQsWUFBWSxJQUFpQixFQUFDLEtBQW1CLEVBQUMsS0FBYSxFQUFDLE9BQWU7UUFDM0UsSUFBSSxDQUFDLElBQUksR0FBQyxJQUFJLENBQUM7UUFDZixJQUFJLENBQUMsS0FBSyxHQUFDLEtBQUssQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFDLEtBQUssQ0FBQztRQUNqQixJQUFJLENBQUMsT0FBTyxHQUFDLE9BQU8sQ0FBQztJQUN6QixDQUFDO0lBQ0QsTUFBTSxDQUFDLE1BQU0sQ0FBQyxJQUFZLEVBQUUsS0FBYSxFQUFFLE9BQWU7UUFDdEQsTUFBTSxVQUFVLEdBQUcsQ0FBQyxHQUFXLEVBQVUsRUFBRSxDQUFBLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxFQUFFLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUV0RixNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsTUFBTSxjQUFjLEdBQUcsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3hDLE1BQU0sZUFBZSxHQUFHLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUUxQyxJQUFJLENBQUMsQ0FBQyxjQUFjLElBQUksV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLGVBQWUsSUFBSSxZQUFZLENBQUMsRUFBRSxDQUFDO1lBQ3pFLE1B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Q0FBQyxZQUFZLENBQUMsSUFBSSxFQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUNsRCxZQUFZLEdBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQTtZQUM1QixNQUFNO1FBQ1YsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSx1QkFBdUIsRUFBRSxZQUFZLGFBQVosWUFBWSxjQUFaLFlBQVksR0FBSSxJQUFJLEVBQUUsQ0FBQztBQUN6RSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQmFzaWNNYXRoSmF4VG9rZW4sIEJhc2ljVGlrelRva2VuIH0gZnJvbSBcInNyYy9tYXRoUGFyc2VyL2Jhc2ljVG9rZW5cIjtcclxuaW1wb3J0IHsgQnJhY2tldFN0YXRlLCBCcmFja2V0VHlwZSB9IGZyb20gXCJzcmMvc3RhdGljRGF0YS9lbmNhc2luZ3NcIjtcclxuZXhwb3J0IGNsYXNzIFBhcmVue1xyXG4gICAgdHlwZTogQnJhY2tldFR5cGU7XHJcbiAgICBzdGF0ZTogQnJhY2tldFN0YXRlO1xyXG4gICAgZGVwdGg6IG51bWJlcjtcclxuICAgIGRlcHRoSUQ6IG51bWJlcjtcclxuICAgIFxyXG4gICAgY29uc3RydWN0b3IodHlwZTogQnJhY2tldFR5cGUsc3RhdGU6IEJyYWNrZXRTdGF0ZSxkZXB0aDogbnVtYmVyLGRlcHRoSUQ6IG51bWJlcil7XHJcbiAgICAgICAgdGhpcy50eXBlPXR5cGU7XHJcbiAgICAgICAgdGhpcy5zdGF0ZT1zdGF0ZTtcclxuICAgICAgICB0aGlzLmRlcHRoPWRlcHRoO1xyXG4gICAgICAgIHRoaXMuZGVwdGhJRD1kZXB0aElEO1xyXG4gICAgfVxyXG4gICAgc3RhdGljIGNyZWF0ZShkYXRhOiBzdHJpbmcsIGRlcHRoOiBudW1iZXIsIGRlcHRoSUQ6IG51bWJlcik6IFBhcmVuIHtcclxuICAgICAgICBjb25zdCBjYXBpdGFsaXplID0gKHN0cjogc3RyaW5nKTogc3RyaW5nID0+c3RyLmNoYXJBdCgwKS50b1VwcGVyQ2FzZSgpICsgc3RyLnNsaWNlKDEpO1xyXG5cclxuICAgICAgICBjb25zdCBbdHlwZSwgc3RhdGVdID0gZGF0YS5zcGxpdCgnXycpO1xyXG4gICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRUeXBlID0gY2FwaXRhbGl6ZSh0eXBlKTtcclxuICAgICAgICBjb25zdCBub3JtYWxpemVkU3RhdGUgPSBjYXBpdGFsaXplKHN0YXRlKTtcclxuICAgIFxyXG4gICAgICAgIGlmICghKG5vcm1hbGl6ZWRUeXBlIGluIEJyYWNrZXRUeXBlKSB8fCAhKG5vcm1hbGl6ZWRTdGF0ZSBpbiBCcmFja2V0U3RhdGUpKSB7XHJcbiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCB0eXBlIG9yIHN0YXRlOiAke25vcm1hbGl6ZWRUeXBlfSwgJHtub3JtYWxpemVkU3RhdGV9YCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBuZXcgUGFyZW4oXHJcbiAgICAgICAgICAgIEJyYWNrZXRUeXBlW25vcm1hbGl6ZWRUeXBlIGFzIGtleW9mIHR5cGVvZiBCcmFja2V0VHlwZV0sXHJcbiAgICAgICAgICAgIEJyYWNrZXRTdGF0ZVtub3JtYWxpemVkU3RhdGUgYXMga2V5b2YgdHlwZW9mIEJyYWNrZXRTdGF0ZV0sXHJcbiAgICAgICAgICAgIGRlcHRoLFxyXG4gICAgICAgICAgICBkZXB0aElEXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgY2xvbmUoKXtyZXR1cm4gbmV3IFBhcmVuKHRoaXMudHlwZSx0aGlzLnN0YXRlLHRoaXMuZGVwdGgsdGhpcy5kZXB0aElEKX1cclxuICAgIHRvU3RyaW5nKCl7cmV0dXJuIHRoaXMuZGVwdGggKyBcIi5cIiArIHRoaXMuZGVwdGhJRH1cclxuICAgIGNvbXBhcmUocGFyZW46IFBhcmVuKXtcclxuICAgICAgICBpZighKHBhcmVuIGluc3RhbmNlb2YgUGFyZW4pKSByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZGVwdGg9PT1wYXJlbi5kZXB0aCYmdGhpcy5kZXB0aElEPT09cGFyZW4uZGVwdGhJRFxyXG4gICAgfVxyXG4gICAgYWRkRGVwdGgobnVtOiBhbnkpe3RoaXMuZGVwdGgrPW51bX1cclxuICAgIGlzT3Blbigpe3JldHVybiB0aGlzLnN0YXRlPT09QnJhY2tldFN0YXRlLk9wZW59XHJcbiAgICBhZGRkZXB0aElEKG51bTogbnVtYmVyKXt0aGlzLmRlcHRoSUQrPW51bX1cclxuICAgIFxyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaWRQYXJlbnRoZXNlcyh0b2tlbnM6IChCYXNpY01hdGhKYXhUb2tlbnxQYXJlbnxCYXNpY1Rpa3pUb2tlbilbXSk6IGFueVtdIHtcclxuICAgIGNvbnN0IG5ld1Rva2Vucz1bXVxyXG4gICAgbGV0IGRlcHRoID0gMDtcclxuICAgIGNvbnN0IGRlcHRoQ291bnRzOiBSZWNvcmQ8bnVtYmVyLCBudW1iZXI+ID0ge307XHJcbiAgICBcclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgY29uc3QgdG9rZW4gPSB0b2tlbnNbaV07XHJcbiAgICAgICAgaWYgKHBhcmVuU3RhdGUodG9rZW4sdHJ1ZSkmJiEodG9rZW4gaW5zdGFuY2VvZiBQYXJlbikmJnRva2VuLmlzVmFsdWVTdHJpbmcoKSkge1xyXG4gICAgICAgICAgICBpZiAoIWRlcHRoQ291bnRzW2RlcHRoXSkge1xyXG4gICAgICAgICAgICAgICAgZGVwdGhDb3VudHNbZGVwdGhdID0gMDtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBkZXB0aElEID0gZGVwdGhDb3VudHNbZGVwdGhdKys7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVuID0gUGFyZW4uY3JlYXRlKHRva2VuLnZhbHVlLGRlcHRoLGRlcHRoSUQpO1xyXG4gICAgICAgICAgICBuZXdUb2tlbnMucHVzaChwYXJlbik7XHJcbiAgICAgICAgICAgIGRlcHRoKys7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgaWYgKHBhcmVuU3RhdGUodG9rZW4pJiYhKHRva2VuIGluc3RhbmNlb2YgUGFyZW4pJiZ0b2tlbi5pc1ZhbHVlU3RyaW5nKCkpIHtcclxuICAgICAgICAgICAgZGVwdGgtLTtcclxuICAgICAgICAgICAgaWYgKGRlcHRoIDwgMCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcih0b2tlbi5nZXRWYWx1ZSgpLCB0b2tlbnMpO1xyXG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVW5tYXRjaGVkIGNsb3NpbmcgcGFyZW50aGVzaXMgZGV0ZWN0ZWQuXCIpO1xyXG4gICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAvLyBBc3NpZ24gYSB1bmlxdWUgSUQgdG8gdGhlIGNsb3NpbmcgcGFyZW50aGVzaXNcclxuICAgICAgICAgICAgY29uc3QgZGVwdGhJRCA9IGRlcHRoQ291bnRzW2RlcHRoXSAtIDE7XHJcbiAgICAgICAgICAgIGNvbnN0IHBhcmVuID0gUGFyZW4uY3JlYXRlKHRva2VuLnZhbHVlLGRlcHRoLGRlcHRoSUQpO1xyXG4gICAgICAgICAgICBuZXdUb2tlbnMucHVzaChwYXJlbik7XHJcbiAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBuZXdUb2tlbnMucHVzaCh0b2tlbi5jbG9uZSgpKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoZGVwdGggIT09IDApIHtcclxuICAgICAgICBjb25zb2xlLmVycm9yKHRva2Vucyk7XHJcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbm1hdGNoZWQgb3BlbmluZyBwYXJlbnRoZXNpcyhlcykgZGV0ZWN0ZWQ6IGRlcHRoPSR7ZGVwdGh9YCk7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG5ld1Rva2VucztcclxufVxyXG5cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBtYXBCcmFja2V0cyh0eXBlOiBzdHJpbmcsdG9rZW5zOiBhbnlbXSl7XHJcbiAgICByZXR1cm4gdG9rZW5zXHJcbiAgICAgICAgLm1hcCgodG9rZW46IHsgbmFtZTogYW55OyB9LCBpbmRleDogYW55KSA9PiBcclxuICAgICAgICAgICAgdG9rZW4ubmFtZSA9PT0gdHlwZVxyXG4gICAgICAgICAgICAgICAgPyAvKmZpbmRQYXJlbkluZGV4KHRva2VuLnZhbHVlLCB1bmRlZmluZWQsIHRva2VucykgKi8nZXJyTW9zaGUnXHJcbiAgICAgICAgICAgICAgICA6IG51bGxcclxuICAgICAgICApXHJcbiAgICAgICAgLmZpbHRlcigodDogbnVsbCkgPT4gdCAhPT0gbnVsbCk7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBwYXJlblN0YXRlPShpdGVtOiBQYXJlbnxCYXNpY01hdGhKYXhUb2tlbnxCYXNpY1Rpa3pUb2tlbixvcGVuOiBib29sZWFuPWZhbHNlKTpib29sZWFuPT57XHJcbiAgICBsZXQgaXNPcGVuO1xyXG4gICAgc3dpdGNoICh0cnVlKXtcclxuICAgICAgICBjYXNlIGl0ZW0gaW5zdGFuY2VvZiBQYXJlbjpcclxuICAgICAgICAgICAgaXNPcGVuID0gaXRlbS5pc09wZW4oKVxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICBjYXNlIChpdGVtIGluc3RhbmNlb2YgQmFzaWNNYXRoSmF4VG9rZW58fGl0ZW0gaW5zdGFuY2VvZiBCYXNpY1Rpa3pUb2tlbikmJml0ZW0uaXNWYWx1ZVN0cmluZygpJiZpdGVtLmdldFN0cmluZ1ZhbHVlKCkuc3BsaXQoJ18nKVsxXSE9PXVuZGVmaW5lZDpcclxuICAgICAgICAgICAgaXNPcGVuID0gaXRlbS5nZXRTdHJpbmdWYWx1ZSgpLnNwbGl0KCdfJylbMV09PT1CcmFja2V0U3RhdGUuT3BlbjtcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICB9XHJcbiAgICBpZihpc09wZW4hPT11bmRlZmluZWQpe1xyXG4gICAgICAgIHJldHVybiBvcGVuP2lzT3BlbjohaXNPcGVuXHJcbiAgICB9XHJcbiAgICByZXR1cm4gZmFsc2VcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRNb2RpZmllZFBhcmVuSW5kZXgoaWQ6IFBhcmVufG51bWJlciwgdG9rZW5zOiBhbnlbXSwgZGVwdGg/OiBudW1iZXIsIGRlcHRoSUQ/OiBudW1iZXIsIGZpbHRlcj86IGFueSkge1xyXG5cclxuICAgIGlkID0gKGlkIGluc3RhbmNlb2YgUGFyZW4/aWQuY2xvbmUoKTogdG9rZW5zW2lkXS5jbG9uZSgpKWFzIFBhcmVuXHJcblxyXG4gICAgaWYgKGRlcHRoICE9PSB1bmRlZmluZWQgJiYgZGVwdGhJRCAhPT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgaWQuZGVwdGggKz0gZGVwdGggfHwgMDtcclxuICAgICAgICBpZC5kZXB0aElEICs9IGRlcHRoSUQgfHwgMDtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBvcGVuSW5kZXggPSB0b2tlbnMuZmluZEluZGV4KHRva2VuID0+IHtcclxuICAgICAgICBpZiAocGFyZW5TdGF0ZSh0b2tlbix0cnVlKSYmIHRva2VuLnZhbHVlPy5jb21wYXJlKGlkKSkge1xyXG4gICAgICAgICAgICBpZiAoZmlsdGVyICYmICF0b2tlbi5uYW1lLnN0YXJ0c1dpdGgoZmlsdGVyKSkge1xyXG4gICAgICAgICAgICAgICAgaWQuZGVwdGggPSB0b2tlbi52YWx1ZS5kZXB0aCArIChkZXB0aCB8fCAwKVxyXG4gICAgICAgICAgICAgICAgaWQuZGVwdGhJRD10b2tlbi52YWx1ZS5kZXB0aElEICsgKGRlcHRoSUQgfHwgMClcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfSk7XHJcblxyXG4gICAgY29uc3QgY2xvc2VJbmRleCA9IHRva2Vucy5maW5kTGFzdEluZGV4KFxyXG4gICAgICAgIHRva2VuID0+XHJcbiAgICAgICAgICAgIHBhcmVuU3RhdGUodG9rZW4sdHJ1ZSkgJiZcclxuICAgICAgICAgICAgdG9rZW4udmFsdWU/LmNvbXBhcmUoaWQpXHJcbiAgICApO1xyXG5cclxuICAgIHJldHVybiB7IG9wZW46IG9wZW5JbmRleCwgY2xvc2U6IGNsb3NlSW5kZXgsIGlkIH07XHJcbn1cclxuXHJcblxyXG4vKipcclxuICogRmluZHMgdGhlIGluZGljZXMgb2YgdGhlIG9wZW5pbmcgYW5kIGNsb3NpbmcgcGFyZW50aGVzZXMgYmFzZWQgb24gdGhlIGdpdmVuIElELlxyXG4gKiBAcGFyYW0ge1BhcmVufG51bWJlcn0gaWQgLSBUaGUgaWRlbnRpZmllciB0byBjb21wYXJlIHRva2Vucy4gRGVmYXVsdHMgdG8gdGhlIHRva2VuIGF0IHRoZSBnaXZlbiBpbmRleCBpZiBhIG51bWJlciBpcyBwcm92aWRlZC5cclxuICogQHBhcmFtIHtBcnJheX0gdG9rZW5zIC0gVGhlIGFycmF5IG9mIHRva2VucyB0byBzZWFyY2ggd2l0aGluLlxyXG4gKiBAcmV0dXJucyB7e29wZW46IG51bWJlciwgY2xvc2U6IG51bWJlciwgaWQ6IFBhcmVufX0gQW4gb2JqZWN0IGNvbnRhaW5pbmcgdGhlIGluZGljZXMgb2YgdGhlIG9wZW5pbmcgYW5kIGNsb3NpbmcgcGFyZW50aGVzZXMgYW5kIHRoZSBtYXRjaGVkIElELlxyXG4gKiAtIGBvcGVuYDogVGhlIGluZGV4IG9mIHRoZSBmaXJzdCBtYXRjaGluZyBvcGVuaW5nIHBhcmVudGhlc2lzLlxyXG4gKiAtIGBjbG9zZWA6IFRoZSBpbmRleCBvZiB0aGUgbGFzdCBtYXRjaGluZyBjbG9zaW5nIHBhcmVudGhlc2lzLlxyXG4gKiAtIGBpZGA6IFRoZSBpZGVudGlmaWVyIHVzZWQgZm9yIGNvbXBhcmlzb24uXHJcbiAqL1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGZpbmRQYXJlbkluZGV4KGlkOiBudW1iZXIgfCBQYXJlbiwgdG9rZW5zOiBhbnlbXSk6IHsgb3BlbjogbnVtYmVyOyBjbG9zZTogbnVtYmVyOyBpZDogUGFyZW47IH0ge1xyXG4gICAgaWYoIShpZCBpbnN0YW5jZW9mIFBhcmVuKSl7XHJcbiAgICAgICAgaWQgPSB0b2tlbnNbaWRdO1xyXG4gICAgICAgIGlmKCEoaWQgaW5zdGFuY2VvZiBQYXJlbikpXHJcbiAgICAgICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJJbnZhbGlkIElEOiBFeHBlY3RlZCBhIFBhcmVuIG9iamVjdCBvciBhIHZhbGlkIGluZGV4LlwiKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBvcGVuSW5kZXggPSB0b2tlbnMuZmluZEluZGV4KFxyXG4gICAgICAgICh0b2tlbjogUGFyZW4pID0+IHBhcmVuU3RhdGUodG9rZW4sdHJ1ZSkgJiYgaWQuY29tcGFyZSh0b2tlbilcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgY2xvc2VJbmRleCA9IHRva2Vucy5maW5kTGFzdEluZGV4KFxyXG4gICAgICAgICh0b2tlbjogUGFyZW4pID0+IHBhcmVuU3RhdGUodG9rZW4pICYmIGlkLmNvbXBhcmUodG9rZW4pXHJcbiAgICApO1xyXG4gICAgaWYob3BlbkluZGV4PT09LTF8fGNsb3NlSW5kZXg9PT0tMSl0aHJvdyBuZXcgRXJyb3IoJ1BhcmVudGhlc2VzIG5vdCBmb3VuZCcpXHJcbiAgICByZXR1cm4geyBvcGVuOiBvcGVuSW5kZXgsIGNsb3NlOiBjbG9zZUluZGV4LCBpZCB9O1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gZmluZERlZXBlc3RQYXJlbnRoZXNlc1Njb3BlKHRva2VuczogYW55W10pIHtcclxuICAgIGxldCBiZWdpbiA9IDAsIGVuZCA9IHRva2Vucy5sZW5ndGg7XHJcbiAgICBsZXQgZGVlcGVzdFNjb3BlID0gbnVsbDtcclxuICAgIGxldCBjdXJyZW50U2NvcGUgPSBudWxsO1xyXG5cclxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgaWYgKHBhcmVuU3RhdGUodG9rZW5zW2ldLHRydWUpKSB7XHJcbiAgICAgICAgICAgIGN1cnJlbnRTY29wZSA9IGZpbmRQYXJlbkluZGV4KHRva2Vuc1tpXSx0b2tlbnMpOyAgXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjdXJyZW50U2NvcGUhPT1udWxsJiZpPT09Y3VycmVudFNjb3BlLmNsb3NlKSB7XHJcbiAgICAgICAgICAgIFtiZWdpbixlbmRdPVtjdXJyZW50U2NvcGUub3BlbixjdXJyZW50U2NvcGUuY2xvc2VdXHJcbiAgICAgICAgICAgIGRlZXBlc3RTY29wZT1jdXJyZW50U2NvcGUuaWRcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHJldHVybiB7IGJlZ2luLCBlbmQsIGRlZXBlc3RQYXJlbnRoZXNlc1Njb3BlOiBkZWVwZXN0U2NvcGUgPz8gbnVsbCB9O1xyXG59XHJcblxyXG4iXX0=