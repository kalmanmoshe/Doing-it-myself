import { BasicMathJaxToken, BasicTikzToken } from "src/basicToken";
import { BracketState, BracketType } from "src/staticData/encasings";
export class Paren {
    type;
    state;
    depth;
    depthID;
    constructor(type, state, depth, depthID) {
        this.type = type;
        this.state = state;
        this.depth = depth;
        this.depthID = depthID;
    }
    static create(data, depth, depthID) {
        const capitalize = (str) => str.charAt(0).toUpperCase() + str.slice(1);
        const [type, state] = data.split('_');
        const normalizedType = capitalize(type);
        const normalizedState = capitalize(state);
        if (!(normalizedType in BracketType) || !(normalizedState in BracketState)) {
            throw new Error(`Invalid type or state: ${normalizedType}, ${normalizedState}`);
        }
        return new Paren(BracketType[normalizedType], BracketState[normalizedState], depth, depthID);
    }
    clone() { return new Paren(this.type, this.state, this.depth, this.depthID); }
    toString() { return this.depth + "." + this.depthID; }
    compare(paren) {
        if (!(paren instanceof Paren))
            return false;
        return this.depth === paren.depth && this.depthID === paren.depthID;
    }
    addDepth(num) { this.depth += num; }
    isOpen() { return this.state === BracketState.Open; }
    adddepthID(num) { this.depthID += num; }
}
export function idParentheses(tokens) {
    const newTokens = [];
    let depth = 0;
    const depthCounts = {};
    for (let i = 0; i < tokens.length; i++) {
        const token = tokens[i];
        if (parenState(token, true) && !(token instanceof Paren) && token.isValueString()) {
            if (!depthCounts[depth]) {
                depthCounts[depth] = 0;
            }
            const depthID = depthCounts[depth]++;
            const paren = Paren.create(token.value, depth, depthID);
            newTokens.push(paren);
            depth++;
            continue;
        }
        if (parenState(token) && !(token instanceof Paren) && token.isValueString()) {
            depth--;
            if (depth < 0) {
                console.error(token.getValue(), tokens);
                throw new Error("Unmatched closing parenthesis detected.");
            }
            // Assign a unique ID to the closing parenthesis
            const depthID = depthCounts[depth] - 1;
            const paren = Paren.create(token.value, depth, depthID);
            newTokens.push(paren);
            continue;
        }
        newTokens.push(token.clone());
    }
    if (depth !== 0) {
        console.error(tokens);
        throw new Error(`Unmatched opening parenthesis(es) detected: depth=${depth}`);
    }
    return newTokens;
}
export function mapBrackets(type, tokens) {
    return tokens
        .map((token, index) => token.name === type
        ? /*findParenIndex(token.value, undefined, tokens) */ 'errMoshe'
        : null)
        .filter((t) => t !== null);
}
export const parenState = (item, open = false) => {
    let isOpen;
    switch (true) {
        case item instanceof Paren:
            isOpen = item.isOpen();
            break;
        case (item instanceof BasicMathJaxToken || item instanceof BasicTikzToken) && item.isValueString() && item.getStringValue().split('_')[1] !== undefined:
            isOpen = item.getStringValue().split('_')[1] === BracketState.Open;
            break;
    }
    if (isOpen !== undefined) {
        return open ? isOpen : !isOpen;
    }
    return false;
};
export function findModifiedParenIndex(id, tokens, depth, depthID, filter) {
    id = (id instanceof Paren ? id.clone() : tokens[id].clone());
    if (depth !== undefined && depthID !== undefined) {
        id.depth += depth || 0;
        id.depthID += depthID || 0;
    }
    const openIndex = tokens.findIndex(token => {
        if (parenState(token, true) && token.value?.compare(id)) {
            if (filter && !token.name.startsWith(filter)) {
                id.depth = token.value.depth + (depth || 0);
                id.depthID = token.value.depthID + (depthID || 0);
                return false;
            }
            return true;
        }
        return false;
    });
    const closeIndex = tokens.findLastIndex(token => parenState(token, true) &&
        token.value?.compare(id));
    return { open: openIndex, close: closeIndex, id };
}
/**
 * Finds the indices of the opening and closing parentheses based on the given ID.
 * @param {Paren|number} id - The identifier to compare tokens. Defaults to the token at the given index if a number is provided.
 * @param {Array} tokens - The array of tokens to search within.
 * @returns {{open: number, close: number, id: Paren}} An object containing the indices of the opening and closing parentheses and the matched ID.
 * - `open`: The index of the first matching opening parenthesis.
 * - `close`: The index of the last matching closing parenthesis.
 * - `id`: The identifier used for comparison.
 */
export function findParenIndex(id, tokens) {
    const index = typeof id === "number" ? id : null;
    id = index !== null ? tokens[index] : id;
    if (!(id instanceof Paren)) {
        throw new TypeError("Invalid ID: Expected a Paren object or a valid index.");
    }
    const openIndex = tokens.findIndex((token) => parenState(token, true) && id.compare(token));
    const closeIndex = tokens.findLastIndex((token) => parenState(token) && id.compare(token));
    if (openIndex === -1 || closeIndex === -1)
        throw new Error('Parentheses not found');
    return { open: openIndex, close: closeIndex, id };
}
export function findDeepestParenthesesScope(tokens) {
    let begin = 0, end = tokens.length;
    let deepestScope = null;
    let currentScope = null;
    for (let i = 0; i < tokens.length; i++) {
        if (parenState(tokens[i], true)) {
            currentScope = findParenIndex(tokens[i], tokens);
        }
        if (currentScope !== null && i === currentScope.close) {
            [begin, end] = [currentScope.open, currentScope.close];
            deepestScope = currentScope.id;
            break;
        }
    }
    return { begin, end, deepestParenthesesScope: deepestScope ?? null };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGVtcENvZGVSdW5uZXJGaWxlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL3V0aWxzL3RlbXBDb2RlUnVubmVyRmlsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsY0FBYyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbkUsT0FBTyxFQUFFLFlBQVksRUFBRSxXQUFXLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNyRSxNQUFNLE9BQU8sS0FBSztJQUNkLElBQUksQ0FBYztJQUNsQixLQUFLLENBQWU7SUFDcEIsS0FBSyxDQUFTO0lBQ2QsT0FBTyxDQUFTO0lBRWhCLFlBQVksSUFBaUIsRUFBQyxLQUFtQixFQUFDLEtBQWEsRUFBQyxPQUFlO1FBQzNFLElBQUksQ0FBQyxJQUFJLEdBQUMsSUFBSSxDQUFDO1FBQ2YsSUFBSSxDQUFDLEtBQUssR0FBQyxLQUFLLENBQUM7UUFDakIsSUFBSSxDQUFDLEtBQUssR0FBQyxLQUFLLENBQUM7UUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBQyxPQUFPLENBQUM7SUFDekIsQ0FBQztJQUNELE1BQU0sQ0FBQyxNQUFNLENBQUMsSUFBWSxFQUFFLEtBQWEsRUFBRSxPQUFlO1FBQ3RELE1BQU0sVUFBVSxHQUFHLENBQUMsR0FBVyxFQUFVLEVBQUUsQ0FBQSxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsRUFBRSxHQUFHLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFFdEYsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN4QyxNQUFNLGVBQWUsR0FBRyxVQUFVLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFMUMsSUFBSSxDQUFDLENBQUMsY0FBYyxJQUFJLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxlQUFlLElBQUksWUFBWSxDQUFDLEVBQUUsQ0FBQztZQUN6RSxNQUFNLElBQUksS0FBSyxDQUFDLDBCQUEwQixjQUFjLEtBQUssZUFBZSxFQUFFLENBQUMsQ0FBQztRQUNwRixDQUFDO1FBQ0QsT0FBTyxJQUFJLEtBQUssQ0FDWixXQUFXLENBQUMsY0FBMEMsQ0FBQyxFQUN2RCxZQUFZLENBQUMsZUFBNEMsQ0FBQyxFQUMxRCxLQUFLLEVBQ0wsT0FBTyxDQUNWLENBQUM7SUFDTixDQUFDO0lBRUQsS0FBSyxLQUFHLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksRUFBQyxJQUFJLENBQUMsS0FBSyxFQUFDLElBQUksQ0FBQyxLQUFLLEVBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBLENBQUEsQ0FBQztJQUN2RSxRQUFRLEtBQUcsT0FBTyxJQUFJLENBQUMsS0FBSyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFBLENBQUEsQ0FBQztJQUNsRCxPQUFPLENBQUMsS0FBWTtRQUNoQixJQUFHLENBQUMsQ0FBQyxLQUFLLFlBQVksS0FBSyxDQUFDO1lBQUUsT0FBTyxLQUFLLENBQUM7UUFDM0MsT0FBTyxJQUFJLENBQUMsS0FBSyxLQUFHLEtBQUssQ0FBQyxLQUFLLElBQUUsSUFBSSxDQUFDLE9BQU8sS0FBRyxLQUFLLENBQUMsT0FBTyxDQUFBO0lBQ2pFLENBQUM7SUFDRCxRQUFRLENBQUMsR0FBUSxJQUFFLElBQUksQ0FBQyxLQUFLLElBQUUsR0FBRyxDQUFBLENBQUEsQ0FBQztJQUNuQyxNQUFNLEtBQUcsT0FBTyxJQUFJLENBQUMsS0FBSyxLQUFHLFlBQVksQ0FBQyxJQUFJLENBQUEsQ0FBQSxDQUFDO0lBQy9DLFVBQVUsQ0FBQyxHQUFXLElBQUUsSUFBSSxDQUFDLE9BQU8sSUFBRSxHQUFHLENBQUEsQ0FBQSxDQUFDO0NBRTdDO0FBRUQsTUFBTSxVQUFVLGFBQWEsQ0FBQyxNQUFrRDtJQUM1RSxNQUFNLFNBQVMsR0FBQyxFQUFFLENBQUE7SUFDbEIsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDO0lBQ2QsTUFBTSxXQUFXLEdBQTJCLEVBQUUsQ0FBQztJQUUvQyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsTUFBTSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1FBQ3JDLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN4QixJQUFJLFVBQVUsQ0FBQyxLQUFLLEVBQUMsSUFBSSxDQUFDLElBQUUsQ0FBQyxDQUFDLEtBQUssWUFBWSxLQUFLLENBQUMsSUFBRSxLQUFLLENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FBQztZQUMzRSxJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ3RCLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDM0IsQ0FBQztZQUNELE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQ3JDLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsT0FBTyxDQUFDLENBQUM7WUFDdEQsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0QixLQUFLLEVBQUUsQ0FBQztZQUNSLFNBQVM7UUFDYixDQUFDO1FBRUQsSUFBSSxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUUsQ0FBQyxDQUFDLEtBQUssWUFBWSxLQUFLLENBQUMsSUFBRSxLQUFLLENBQUMsYUFBYSxFQUFFLEVBQUUsQ0FBQztZQUN0RSxLQUFLLEVBQUUsQ0FBQztZQUNSLElBQUksS0FBSyxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUNaLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUN4QyxNQUFNLElBQUksS0FBSyxDQUFDLHlDQUF5QyxDQUFDLENBQUM7WUFDL0QsQ0FBQztZQUVELGdEQUFnRDtZQUNoRCxNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZDLE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBQyxLQUFLLEVBQUMsT0FBTyxDQUFDLENBQUM7WUFDdEQsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0QixTQUFTO1FBQ2IsQ0FBQztRQUNELFNBQVMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELElBQUksS0FBSyxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ2QsT0FBTyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN0QixNQUFNLElBQUksS0FBSyxDQUFDLHFEQUFxRCxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ2xGLENBQUM7SUFDRCxPQUFPLFNBQVMsQ0FBQztBQUNyQixDQUFDO0FBR0QsTUFBTSxVQUFVLFdBQVcsQ0FBQyxJQUFZLEVBQUMsTUFBYTtJQUNsRCxPQUFPLE1BQU07U0FDUixHQUFHLENBQUMsQ0FBQyxLQUFxQixFQUFFLEtBQVUsRUFBRSxFQUFFLENBQ3ZDLEtBQUssQ0FBQyxJQUFJLEtBQUssSUFBSTtRQUNmLENBQUMsQ0FBQyxtREFBbUQsQ0FBQSxVQUFVO1FBQy9ELENBQUMsQ0FBQyxJQUFJLENBQ2I7U0FDQSxNQUFNLENBQUMsQ0FBQyxDQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQztBQUN6QyxDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sVUFBVSxHQUFDLENBQUMsSUFBNEMsRUFBQyxPQUFjLEtBQUssRUFBUyxFQUFFO0lBQ2hHLElBQUksTUFBTSxDQUFDO0lBQ1gsUUFBUSxJQUFJLEVBQUMsQ0FBQztRQUNWLEtBQUssSUFBSSxZQUFZLEtBQUs7WUFDdEIsTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQTtZQUN0QixNQUFNO1FBQ1YsS0FBSyxDQUFDLElBQUksWUFBWSxpQkFBaUIsSUFBRSxJQUFJLFlBQVksY0FBYyxDQUFDLElBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxJQUFFLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUcsU0FBUztZQUMzSSxNQUFNLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBRyxZQUFZLENBQUMsSUFBSSxDQUFDO1lBQ2pFLE1BQU07SUFDZCxDQUFDO0lBQ0QsSUFBRyxNQUFNLEtBQUcsU0FBUyxFQUFDLENBQUM7UUFDbkIsT0FBTyxJQUFJLENBQUEsQ0FBQyxDQUFBLE1BQU0sQ0FBQSxDQUFDLENBQUEsQ0FBQyxNQUFNLENBQUE7SUFDOUIsQ0FBQztJQUNELE9BQU8sS0FBSyxDQUFBO0FBQ2hCLENBQUMsQ0FBQTtBQUVELE1BQU0sVUFBVSxzQkFBc0IsQ0FBQyxFQUFnQixFQUFFLE1BQWEsRUFBRSxLQUFjLEVBQUUsT0FBZ0IsRUFBRSxNQUFZO0lBRWxILEVBQUUsR0FBRyxDQUFDLEVBQUUsWUFBWSxLQUFLLENBQUEsQ0FBQyxDQUFBLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssRUFBRSxDQUFTLENBQUE7SUFFakUsSUFBSSxLQUFLLEtBQUssU0FBUyxJQUFJLE9BQU8sS0FBSyxTQUFTLEVBQUUsQ0FBQztRQUMvQyxFQUFFLENBQUMsS0FBSyxJQUFJLEtBQUssSUFBSSxDQUFDLENBQUM7UUFDdkIsRUFBRSxDQUFDLE9BQU8sSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRCxNQUFNLFNBQVMsR0FBRyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxFQUFFO1FBQ3ZDLElBQUksVUFBVSxDQUFDLEtBQUssRUFBQyxJQUFJLENBQUMsSUFBRyxLQUFLLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQ3BELElBQUksTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztnQkFDM0MsRUFBRSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxDQUFDLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQTtnQkFDM0MsRUFBRSxDQUFDLE9BQU8sR0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLE9BQU8sR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQTtnQkFDL0MsT0FBTyxLQUFLLENBQUM7WUFDakIsQ0FBQztZQUNELE9BQU8sSUFBSSxDQUFDO1FBQ2hCLENBQUM7UUFDRCxPQUFPLEtBQUssQ0FBQztJQUNqQixDQUFDLENBQUMsQ0FBQztJQUVILE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQ25DLEtBQUssQ0FBQyxFQUFFLENBQ0osVUFBVSxDQUFDLEtBQUssRUFBQyxJQUFJLENBQUM7UUFDdEIsS0FBSyxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsRUFBRSxDQUFDLENBQy9CLENBQUM7SUFFRixPQUFPLEVBQUUsSUFBSSxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxDQUFDO0FBQ3RELENBQUM7QUFHRDs7Ozs7Ozs7R0FRRztBQUVILE1BQU0sVUFBVSxjQUFjLENBQUMsRUFBa0IsRUFBRSxNQUFhO0lBQzVELE1BQU0sS0FBSyxHQUFHLE9BQU8sRUFBRSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUM7SUFDakQsRUFBRSxHQUFHLEtBQUssS0FBSyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDO0lBRXpDLElBQUksQ0FBQyxDQUFDLEVBQUUsWUFBWSxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ3pCLE1BQU0sSUFBSSxTQUFTLENBQUMsdURBQXVELENBQUMsQ0FBQztJQUNqRixDQUFDO0lBQ0QsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FDOUIsQ0FBQyxLQUFZLEVBQUUsRUFBRSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FDaEUsQ0FBQztJQUVGLE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQ25DLENBQUMsS0FBWSxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FDM0QsQ0FBQztJQUNGLElBQUcsU0FBUyxLQUFHLENBQUMsQ0FBQyxJQUFFLFVBQVUsS0FBRyxDQUFDLENBQUM7UUFBQyxNQUFNLElBQUksS0FBSyxDQUFDLHVCQUF1QixDQUFDLENBQUE7SUFDM0UsT0FBTyxFQUFFLElBQUksRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FBQztBQUN0RCxDQUFDO0FBRUQsTUFBTSxVQUFVLDJCQUEyQixDQUFDLE1BQWE7SUFDckQsSUFBSSxLQUFLLEdBQUcsQ0FBQyxFQUFFLEdBQUcsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ25DLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQztJQUN4QixJQUFJLFlBQVksR0FBRyxJQUFJLENBQUM7SUFFeEIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNyQyxJQUFJLFVBQVUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUM3QixZQUFZLEdBQUcsY0FBYyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBQyxNQUFNLENBQUMsQ0FBQztRQUNwRCxDQUFDO1FBQ0QsSUFBSSxZQUFZLEtBQUcsSUFBSSxJQUFFLENBQUMsS0FBRyxZQUFZLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDOUMsQ0FBQyxLQUFLLEVBQUMsR0FBRyxDQUFDLEdBQUMsQ0FBQyxZQUFZLENBQUMsSUFBSSxFQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUNsRCxZQUFZLEdBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQTtZQUM1QixNQUFNO1FBQ1YsQ0FBQztJQUNMLENBQUM7SUFFRCxPQUFPLEVBQUUsS0FBSyxFQUFFLEdBQUcsRUFBRSx1QkFBdUIsRUFBRSxZQUFZLElBQUksSUFBSSxFQUFFLENBQUM7QUFDekUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEJhc2ljTWF0aEpheFRva2VuLCBCYXNpY1Rpa3pUb2tlbiB9IGZyb20gXCJzcmMvYmFzaWNUb2tlblwiO1xyXG5pbXBvcnQgeyBCcmFja2V0U3RhdGUsIEJyYWNrZXRUeXBlIH0gZnJvbSBcInNyYy9zdGF0aWNEYXRhL2VuY2FzaW5nc1wiO1xyXG5leHBvcnQgY2xhc3MgUGFyZW57XHJcbiAgICB0eXBlOiBCcmFja2V0VHlwZTtcclxuICAgIHN0YXRlOiBCcmFja2V0U3RhdGU7XHJcbiAgICBkZXB0aDogbnVtYmVyO1xyXG4gICAgZGVwdGhJRDogbnVtYmVyO1xyXG4gICAgXHJcbiAgICBjb25zdHJ1Y3Rvcih0eXBlOiBCcmFja2V0VHlwZSxzdGF0ZTogQnJhY2tldFN0YXRlLGRlcHRoOiBudW1iZXIsZGVwdGhJRDogbnVtYmVyKXtcclxuICAgICAgICB0aGlzLnR5cGU9dHlwZTtcclxuICAgICAgICB0aGlzLnN0YXRlPXN0YXRlO1xyXG4gICAgICAgIHRoaXMuZGVwdGg9ZGVwdGg7XHJcbiAgICAgICAgdGhpcy5kZXB0aElEPWRlcHRoSUQ7XHJcbiAgICB9XHJcbiAgICBzdGF0aWMgY3JlYXRlKGRhdGE6IHN0cmluZywgZGVwdGg6IG51bWJlciwgZGVwdGhJRDogbnVtYmVyKTogUGFyZW4ge1xyXG4gICAgICAgIGNvbnN0IGNhcGl0YWxpemUgPSAoc3RyOiBzdHJpbmcpOiBzdHJpbmcgPT5zdHIuY2hhckF0KDApLnRvVXBwZXJDYXNlKCkgKyBzdHIuc2xpY2UoMSk7XHJcblxyXG4gICAgICAgIGNvbnN0IFt0eXBlLCBzdGF0ZV0gPSBkYXRhLnNwbGl0KCdfJyk7XHJcbiAgICAgICAgY29uc3Qgbm9ybWFsaXplZFR5cGUgPSBjYXBpdGFsaXplKHR5cGUpO1xyXG4gICAgICAgIGNvbnN0IG5vcm1hbGl6ZWRTdGF0ZSA9IGNhcGl0YWxpemUoc3RhdGUpO1xyXG4gICAgXHJcbiAgICAgICAgaWYgKCEobm9ybWFsaXplZFR5cGUgaW4gQnJhY2tldFR5cGUpIHx8ICEobm9ybWFsaXplZFN0YXRlIGluIEJyYWNrZXRTdGF0ZSkpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIHR5cGUgb3Igc3RhdGU6ICR7bm9ybWFsaXplZFR5cGV9LCAke25vcm1hbGl6ZWRTdGF0ZX1gKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIG5ldyBQYXJlbihcclxuICAgICAgICAgICAgQnJhY2tldFR5cGVbbm9ybWFsaXplZFR5cGUgYXMga2V5b2YgdHlwZW9mIEJyYWNrZXRUeXBlXSxcclxuICAgICAgICAgICAgQnJhY2tldFN0YXRlW25vcm1hbGl6ZWRTdGF0ZSBhcyBrZXlvZiB0eXBlb2YgQnJhY2tldFN0YXRlXSxcclxuICAgICAgICAgICAgZGVwdGgsXHJcbiAgICAgICAgICAgIGRlcHRoSURcclxuICAgICAgICApO1xyXG4gICAgfVxyXG4gICAgXHJcbiAgICBjbG9uZSgpe3JldHVybiBuZXcgUGFyZW4odGhpcy50eXBlLHRoaXMuc3RhdGUsdGhpcy5kZXB0aCx0aGlzLmRlcHRoSUQpfVxyXG4gICAgdG9TdHJpbmcoKXtyZXR1cm4gdGhpcy5kZXB0aCArIFwiLlwiICsgdGhpcy5kZXB0aElEfVxyXG4gICAgY29tcGFyZShwYXJlbjogUGFyZW4pe1xyXG4gICAgICAgIGlmKCEocGFyZW4gaW5zdGFuY2VvZiBQYXJlbikpIHJldHVybiBmYWxzZTtcclxuICAgICAgICByZXR1cm4gdGhpcy5kZXB0aD09PXBhcmVuLmRlcHRoJiZ0aGlzLmRlcHRoSUQ9PT1wYXJlbi5kZXB0aElEXHJcbiAgICB9XHJcbiAgICBhZGREZXB0aChudW06IGFueSl7dGhpcy5kZXB0aCs9bnVtfVxyXG4gICAgaXNPcGVuKCl7cmV0dXJuIHRoaXMuc3RhdGU9PT1CcmFja2V0U3RhdGUuT3Blbn1cclxuICAgIGFkZGRlcHRoSUQobnVtOiBudW1iZXIpe3RoaXMuZGVwdGhJRCs9bnVtfVxyXG4gICAgXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBpZFBhcmVudGhlc2VzKHRva2VuczogKEJhc2ljTWF0aEpheFRva2VufFBhcmVufEJhc2ljVGlrelRva2VuKVtdKTogYW55W10ge1xyXG4gICAgY29uc3QgbmV3VG9rZW5zPVtdXHJcbiAgICBsZXQgZGVwdGggPSAwO1xyXG4gICAgY29uc3QgZGVwdGhDb3VudHM6IFJlY29yZDxudW1iZXIsIG51bWJlcj4gPSB7fTtcclxuICAgIFxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBjb25zdCB0b2tlbiA9IHRva2Vuc1tpXTtcclxuICAgICAgICBpZiAocGFyZW5TdGF0ZSh0b2tlbix0cnVlKSYmISh0b2tlbiBpbnN0YW5jZW9mIFBhcmVuKSYmdG9rZW4uaXNWYWx1ZVN0cmluZygpKSB7XHJcbiAgICAgICAgICAgIGlmICghZGVwdGhDb3VudHNbZGVwdGhdKSB7XHJcbiAgICAgICAgICAgICAgICBkZXB0aENvdW50c1tkZXB0aF0gPSAwO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IGRlcHRoSUQgPSBkZXB0aENvdW50c1tkZXB0aF0rKztcclxuICAgICAgICAgICAgY29uc3QgcGFyZW4gPSBQYXJlbi5jcmVhdGUodG9rZW4udmFsdWUsZGVwdGgsZGVwdGhJRCk7XHJcbiAgICAgICAgICAgIG5ld1Rva2Vucy5wdXNoKHBhcmVuKTtcclxuICAgICAgICAgICAgZGVwdGgrKztcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAocGFyZW5TdGF0ZSh0b2tlbikmJiEodG9rZW4gaW5zdGFuY2VvZiBQYXJlbikmJnRva2VuLmlzVmFsdWVTdHJpbmcoKSkge1xyXG4gICAgICAgICAgICBkZXB0aC0tO1xyXG4gICAgICAgICAgICBpZiAoZGVwdGggPCAwKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKHRva2VuLmdldFZhbHVlKCksIHRva2Vucyk7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbm1hdGNoZWQgY2xvc2luZyBwYXJlbnRoZXNpcyBkZXRlY3RlZC5cIik7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIC8vIEFzc2lnbiBhIHVuaXF1ZSBJRCB0byB0aGUgY2xvc2luZyBwYXJlbnRoZXNpc1xyXG4gICAgICAgICAgICBjb25zdCBkZXB0aElEID0gZGVwdGhDb3VudHNbZGVwdGhdIC0gMTtcclxuICAgICAgICAgICAgY29uc3QgcGFyZW4gPSBQYXJlbi5jcmVhdGUodG9rZW4udmFsdWUsZGVwdGgsZGVwdGhJRCk7XHJcbiAgICAgICAgICAgIG5ld1Rva2Vucy5wdXNoKHBhcmVuKTtcclxuICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG5ld1Rva2Vucy5wdXNoKHRva2VuLmNsb25lKCkpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmIChkZXB0aCAhPT0gMCkge1xyXG4gICAgICAgIGNvbnNvbGUuZXJyb3IodG9rZW5zKTtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVubWF0Y2hlZCBvcGVuaW5nIHBhcmVudGhlc2lzKGVzKSBkZXRlY3RlZDogZGVwdGg9JHtkZXB0aH1gKTtcclxuICAgIH1cclxuICAgIHJldHVybiBuZXdUb2tlbnM7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbWFwQnJhY2tldHModHlwZTogc3RyaW5nLHRva2VuczogYW55W10pe1xyXG4gICAgcmV0dXJuIHRva2Vuc1xyXG4gICAgICAgIC5tYXAoKHRva2VuOiB7IG5hbWU6IGFueTsgfSwgaW5kZXg6IGFueSkgPT4gXHJcbiAgICAgICAgICAgIHRva2VuLm5hbWUgPT09IHR5cGVcclxuICAgICAgICAgICAgICAgID8gLypmaW5kUGFyZW5JbmRleCh0b2tlbi52YWx1ZSwgdW5kZWZpbmVkLCB0b2tlbnMpICovJ2Vyck1vc2hlJ1xyXG4gICAgICAgICAgICAgICAgOiBudWxsXHJcbiAgICAgICAgKVxyXG4gICAgICAgIC5maWx0ZXIoKHQ6IG51bGwpID0+IHQgIT09IG51bGwpO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3QgcGFyZW5TdGF0ZT0oaXRlbTogUGFyZW58QmFzaWNNYXRoSmF4VG9rZW58QmFzaWNUaWt6VG9rZW4sb3BlbjogYm9vbGVhbj1mYWxzZSk6Ym9vbGVhbj0+e1xyXG4gICAgbGV0IGlzT3BlbjtcclxuICAgIHN3aXRjaCAodHJ1ZSl7XHJcbiAgICAgICAgY2FzZSBpdGVtIGluc3RhbmNlb2YgUGFyZW46XHJcbiAgICAgICAgICAgIGlzT3BlbiA9IGl0ZW0uaXNPcGVuKClcclxuICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgY2FzZSAoaXRlbSBpbnN0YW5jZW9mIEJhc2ljTWF0aEpheFRva2VufHxpdGVtIGluc3RhbmNlb2YgQmFzaWNUaWt6VG9rZW4pJiZpdGVtLmlzVmFsdWVTdHJpbmcoKSYmaXRlbS5nZXRTdHJpbmdWYWx1ZSgpLnNwbGl0KCdfJylbMV0hPT11bmRlZmluZWQ6XHJcbiAgICAgICAgICAgIGlzT3BlbiA9IGl0ZW0uZ2V0U3RyaW5nVmFsdWUoKS5zcGxpdCgnXycpWzFdPT09QnJhY2tldFN0YXRlLk9wZW47XHJcbiAgICAgICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG4gICAgaWYoaXNPcGVuIT09dW5kZWZpbmVkKXtcclxuICAgICAgICByZXR1cm4gb3Blbj9pc09wZW46IWlzT3BlblxyXG4gICAgfVxyXG4gICAgcmV0dXJuIGZhbHNlXHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kTW9kaWZpZWRQYXJlbkluZGV4KGlkOiBQYXJlbnxudW1iZXIsIHRva2VuczogYW55W10sIGRlcHRoPzogbnVtYmVyLCBkZXB0aElEPzogbnVtYmVyLCBmaWx0ZXI/OiBhbnkpIHtcclxuXHJcbiAgICBpZCA9IChpZCBpbnN0YW5jZW9mIFBhcmVuP2lkLmNsb25lKCk6IHRva2Vuc1tpZF0uY2xvbmUoKSlhcyBQYXJlblxyXG5cclxuICAgIGlmIChkZXB0aCAhPT0gdW5kZWZpbmVkICYmIGRlcHRoSUQgIT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAgIGlkLmRlcHRoICs9IGRlcHRoIHx8IDA7XHJcbiAgICAgICAgaWQuZGVwdGhJRCArPSBkZXB0aElEIHx8IDA7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3Qgb3BlbkluZGV4ID0gdG9rZW5zLmZpbmRJbmRleCh0b2tlbiA9PiB7XHJcbiAgICAgICAgaWYgKHBhcmVuU3RhdGUodG9rZW4sdHJ1ZSkmJiB0b2tlbi52YWx1ZT8uY29tcGFyZShpZCkpIHtcclxuICAgICAgICAgICAgaWYgKGZpbHRlciAmJiAhdG9rZW4ubmFtZS5zdGFydHNXaXRoKGZpbHRlcikpIHtcclxuICAgICAgICAgICAgICAgIGlkLmRlcHRoID0gdG9rZW4udmFsdWUuZGVwdGggKyAoZGVwdGggfHwgMClcclxuICAgICAgICAgICAgICAgIGlkLmRlcHRoSUQ9dG9rZW4udmFsdWUuZGVwdGhJRCArIChkZXB0aElEIHx8IDApXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH0pO1xyXG5cclxuICAgIGNvbnN0IGNsb3NlSW5kZXggPSB0b2tlbnMuZmluZExhc3RJbmRleChcclxuICAgICAgICB0b2tlbiA9PlxyXG4gICAgICAgICAgICBwYXJlblN0YXRlKHRva2VuLHRydWUpICYmXHJcbiAgICAgICAgICAgIHRva2VuLnZhbHVlPy5jb21wYXJlKGlkKVxyXG4gICAgKTtcclxuXHJcbiAgICByZXR1cm4geyBvcGVuOiBvcGVuSW5kZXgsIGNsb3NlOiBjbG9zZUluZGV4LCBpZCB9O1xyXG59XHJcblxyXG5cclxuLyoqXHJcbiAqIEZpbmRzIHRoZSBpbmRpY2VzIG9mIHRoZSBvcGVuaW5nIGFuZCBjbG9zaW5nIHBhcmVudGhlc2VzIGJhc2VkIG9uIHRoZSBnaXZlbiBJRC5cclxuICogQHBhcmFtIHtQYXJlbnxudW1iZXJ9IGlkIC0gVGhlIGlkZW50aWZpZXIgdG8gY29tcGFyZSB0b2tlbnMuIERlZmF1bHRzIHRvIHRoZSB0b2tlbiBhdCB0aGUgZ2l2ZW4gaW5kZXggaWYgYSBudW1iZXIgaXMgcHJvdmlkZWQuXHJcbiAqIEBwYXJhbSB7QXJyYXl9IHRva2VucyAtIFRoZSBhcnJheSBvZiB0b2tlbnMgdG8gc2VhcmNoIHdpdGhpbi5cclxuICogQHJldHVybnMge3tvcGVuOiBudW1iZXIsIGNsb3NlOiBudW1iZXIsIGlkOiBQYXJlbn19IEFuIG9iamVjdCBjb250YWluaW5nIHRoZSBpbmRpY2VzIG9mIHRoZSBvcGVuaW5nIGFuZCBjbG9zaW5nIHBhcmVudGhlc2VzIGFuZCB0aGUgbWF0Y2hlZCBJRC5cclxuICogLSBgb3BlbmA6IFRoZSBpbmRleCBvZiB0aGUgZmlyc3QgbWF0Y2hpbmcgb3BlbmluZyBwYXJlbnRoZXNpcy5cclxuICogLSBgY2xvc2VgOiBUaGUgaW5kZXggb2YgdGhlIGxhc3QgbWF0Y2hpbmcgY2xvc2luZyBwYXJlbnRoZXNpcy5cclxuICogLSBgaWRgOiBUaGUgaWRlbnRpZmllciB1c2VkIGZvciBjb21wYXJpc29uLlxyXG4gKi9cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kUGFyZW5JbmRleChpZDogbnVtYmVyIHwgUGFyZW4sIHRva2VuczogYW55W10pOiB7IG9wZW46IG51bWJlcjsgY2xvc2U6IG51bWJlcjsgaWQ6IFBhcmVuOyB9IHtcclxuICAgIGNvbnN0IGluZGV4ID0gdHlwZW9mIGlkID09PSBcIm51bWJlclwiID8gaWQgOiBudWxsO1xyXG4gICAgaWQgPSBpbmRleCAhPT0gbnVsbCA/IHRva2Vuc1tpbmRleF0gOiBpZDtcclxuXHJcbiAgICBpZiAoIShpZCBpbnN0YW5jZW9mIFBhcmVuKSkge1xyXG4gICAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoXCJJbnZhbGlkIElEOiBFeHBlY3RlZCBhIFBhcmVuIG9iamVjdCBvciBhIHZhbGlkIGluZGV4LlwiKTtcclxuICAgIH1cclxuICAgIGNvbnN0IG9wZW5JbmRleCA9IHRva2Vucy5maW5kSW5kZXgoXHJcbiAgICAgICAgKHRva2VuOiBQYXJlbikgPT4gcGFyZW5TdGF0ZSh0b2tlbix0cnVlKSAmJiBpZC5jb21wYXJlKHRva2VuKVxyXG4gICAgKTtcclxuXHJcbiAgICBjb25zdCBjbG9zZUluZGV4ID0gdG9rZW5zLmZpbmRMYXN0SW5kZXgoXHJcbiAgICAgICAgKHRva2VuOiBQYXJlbikgPT4gcGFyZW5TdGF0ZSh0b2tlbikgJiYgaWQuY29tcGFyZSh0b2tlbilcclxuICAgICk7XHJcbiAgICBpZihvcGVuSW5kZXg9PT0tMXx8Y2xvc2VJbmRleD09PS0xKXRocm93IG5ldyBFcnJvcignUGFyZW50aGVzZXMgbm90IGZvdW5kJylcclxuICAgIHJldHVybiB7IG9wZW46IG9wZW5JbmRleCwgY2xvc2U6IGNsb3NlSW5kZXgsIGlkIH07XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBmaW5kRGVlcGVzdFBhcmVudGhlc2VzU2NvcGUodG9rZW5zOiBhbnlbXSkge1xyXG4gICAgbGV0IGJlZ2luID0gMCwgZW5kID0gdG9rZW5zLmxlbmd0aDtcclxuICAgIGxldCBkZWVwZXN0U2NvcGUgPSBudWxsO1xyXG4gICAgbGV0IGN1cnJlbnRTY29wZSA9IG51bGw7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCB0b2tlbnMubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICBpZiAocGFyZW5TdGF0ZSh0b2tlbnNbaV0sdHJ1ZSkpIHtcclxuICAgICAgICAgICAgY3VycmVudFNjb3BlID0gZmluZFBhcmVuSW5kZXgodG9rZW5zW2ldLHRva2Vucyk7ICBcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGN1cnJlbnRTY29wZSE9PW51bGwmJmk9PT1jdXJyZW50U2NvcGUuY2xvc2UpIHtcclxuICAgICAgICAgICAgW2JlZ2luLGVuZF09W2N1cnJlbnRTY29wZS5vcGVuLGN1cnJlbnRTY29wZS5jbG9zZV1cclxuICAgICAgICAgICAgZGVlcGVzdFNjb3BlPWN1cnJlbnRTY29wZS5pZFxyXG4gICAgICAgICAgICBicmVhaztcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIHsgYmVnaW4sIGVuZCwgZGVlcGVzdFBhcmVudGhlc2VzU2NvcGU6IGRlZXBlc3RTY29wZSA/PyBudWxsIH07XHJcbn1cclxuXHJcbiJdfQ==