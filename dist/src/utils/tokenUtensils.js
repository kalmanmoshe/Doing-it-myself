export class Paren {
    type;
    depth;
    depthID;
    constructor(depth, depthID, type) {
        this.depth = depth;
        this.depthID = depthID;
        this.type = type;
    }
    toString() { this.id = this.depth + "." + this.depthID; }
    compare(Paren) { return this.depth === Paren.depth && this.depthID === Paren.depthID; }
    addDepth(num) { this.depth += num; }
    adddepthID(num) { this.depthID += num; }
}
const open = ['Parentheses_open', 'Curly_brackets_open', 'Square_brackets_open'];
const close = ['Parentheses_close', 'Curly_brackets_close', 'Square_brackets_close'];
export function idParentheses(tokens) {
    let depth = 0;
    const depthCounts = {};
    for (let i = 0; i < tokens.length; i++) {
        let token = tokens[i];
        if (open.includes(token.value)) {
            if (!depthCounts[depth]) {
                depthCounts[depth] = 0;
            }
            const depthID = depthCounts[depth]++;
            const paren = new Paren(depth, depthID, token.value);
            tokens.splice(i, 1, paren);
            // Increase depth for nested parentheses
            depth++;
            continue;
        }
        if (close.includes(token.value)) {
            depth--;
            if (depth < 0) {
                console.error(token.value, tokens);
                throw new Error("Unmatched closing parenthesis detected.");
            }
            // Assign a unique ID to the closing parenthesis
            const depthID = depthCounts[depth] - 1;
            const paren = new Paren(depth, depthID, token.value);
            tokens.splice(i, 1, paren);
        }
    }
    // Check for unmatched opening parentheses
    if (depth !== 0) {
        console.error(tokens);
        throw new Error(`Unmatched opening parenthesis(es) detected: depth=${depth}`);
    }
    return tokens;
}
export function mapBrackets(type, tokens) {
    return tokens
        .map((token, index) => token.name === type
        ? /*findParenIndex(token.value, undefined, tokens) */ 'errMoshe'
        : null)
        .filter((t) => t !== null);
}
export const isOpenParen = (item) => {
    if (!(item instanceof Paren) || !item.type)
        return false;
    return open.includes(item.type);
};
export const isClosedParen = (item) => {
    if (!(item instanceof Paren) || !item.type)
        return false;
    return close.includes(item.type);
};
export function findModifiedParenIndex(id, index, tokens, depth, depthID, filter) {
    // Initialize `id` as a new instance if not already provided
    id = id
        ? new Paren(id.depth, id.depthID)
        : new Paren(tokens[index].value.depth, tokens[index].value.depthID);
    if (depth !== undefined && depthID !== undefined) {
        id.depth += depth || 0;
        id.depthID += depthID || 0;
    }
    const openIndex = tokens.findIndex(token => {
        if (open.includes(token.name) && token.value?.compare(id)) {
            if (filter && !token.name.startsWith(filter)) {
                id.depth = token.value.depth + (depth || 0);
                id.depthID = token.value.depthID + (depthID || 0);
                return false;
            }
            return true;
        }
        return false;
    });
    const closeIndex = tokens.findLastIndex(token => close.includes(token.name) &&
        token.value?.compare(id));
    return { open: openIndex, close: closeIndex, id };
}
export function findParenIndex(id, index, tokens) {
    id = id ? id : tokens[index];
    const openIndex = tokens.findIndex(token => open.includes(token.type)
        && id.compare(token));
    const closeIndex = tokens.findLastIndex(token => close.includes(token.type)
        && id.compare(token));
    return { open: openIndex, close: closeIndex, id: id };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9rZW5VdGVuc2lscy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy90b2tlblV0ZW5zaWxzLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE1BQU0sT0FBTyxLQUFLO0lBQ2QsSUFBSSxDQUFDO0lBQ0wsS0FBSyxDQUFDO0lBQ04sT0FBTyxDQUFDO0lBRVIsWUFBWSxLQUFLLEVBQUMsT0FBTyxFQUFDLElBQUk7UUFDMUIsSUFBSSxDQUFDLEtBQUssR0FBQyxLQUFLLENBQUM7UUFDakIsSUFBSSxDQUFDLE9BQU8sR0FBQyxPQUFPLENBQUM7UUFDckIsSUFBSSxDQUFDLElBQUksR0FBQyxJQUFJLENBQUE7SUFDbEIsQ0FBQztJQUNELFFBQVEsS0FBRyxJQUFJLENBQUMsRUFBRSxHQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUEsQ0FBQSxDQUFDO0lBQ25ELE9BQU8sQ0FBQyxLQUFLLElBQUUsT0FBTyxJQUFJLENBQUMsS0FBSyxLQUFHLEtBQUssQ0FBQyxLQUFLLElBQUUsSUFBSSxDQUFDLE9BQU8sS0FBRyxLQUFLLENBQUMsT0FBTyxDQUFBLENBQUEsQ0FBQztJQUM3RSxRQUFRLENBQUMsR0FBRyxJQUFFLElBQUksQ0FBQyxLQUFLLElBQUUsR0FBRyxDQUFBLENBQUEsQ0FBQztJQUM5QixVQUFVLENBQUMsR0FBRyxJQUFFLElBQUksQ0FBQyxPQUFPLElBQUUsR0FBRyxDQUFBLENBQUEsQ0FBQztDQUNyQztBQUNELE1BQU0sSUFBSSxHQUFDLENBQUMsa0JBQWtCLEVBQUMscUJBQXFCLEVBQUMsc0JBQXNCLENBQUMsQ0FBQztBQUM3RSxNQUFNLEtBQUssR0FBQyxDQUFDLG1CQUFtQixFQUFDLHNCQUFzQixFQUFDLHVCQUF1QixDQUFDLENBQUM7QUFFakYsTUFBTSxVQUFVLGFBQWEsQ0FBQyxNQUFNO0lBQ2hDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztJQUNk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LEVBQUUsRUFBQyxFQUFFLEVBQUMsQ0FBQTtBQUNuRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiZXhwb3J0IGNsYXNzIFBhcmVue1xuICAgIHR5cGU7XG4gICAgZGVwdGg7XG4gICAgZGVwdGhJRDtcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihkZXB0aCxkZXB0aElELHR5cGUpe1xuICAgICAgICB0aGlzLmRlcHRoPWRlcHRoO1xuICAgICAgICB0aGlzLmRlcHRoSUQ9ZGVwdGhJRDtcbiAgICAgICAgdGhpcy50eXBlPXR5cGVcbiAgICB9XG4gICAgdG9TdHJpbmcoKXt0aGlzLmlkPXRoaXMuZGVwdGggKyBcIi5cIiArIHRoaXMuZGVwdGhJRH1cbiAgICBjb21wYXJlKFBhcmVuKXtyZXR1cm4gdGhpcy5kZXB0aD09PVBhcmVuLmRlcHRoJiZ0aGlzLmRlcHRoSUQ9PT1QYXJlbi5kZXB0aElEfVxuICAgIGFkZERlcHRoKG51bSl7dGhpcy5kZXB0aCs9bnVtfVxuICAgIGFkZGRlcHRoSUQobnVtKXt0aGlzLmRlcHRoSUQrPW51bX1cbn1cbmNvbnN0IG9wZW49WydQYXJlbnRoZXNlc19vcGVuJywnQ3VybHlfYnJhY2tldHNfb3BlbicsJ1NxdWFyZV9icmFja2V0c19vcGVuJ107XG5jb25zdCBjbG9zZT1bJ1BhcmVudGhlc2VzX2Nsb3NlJywnQ3VybHlfYnJhY2tldHNfY2xvc2UnLCdTcXVhcmVfYnJhY2tldHNfY2xvc2UnXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGlkUGFyZW50aGVzZXModG9rZW5zKSB7XG4gICAgbGV0IGRlcHRoID0gMDtcbiAgICBjb25zdCBkZXB0aENvdW50cyA9IHt9O1xuICAgIFxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG9rZW5zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGxldCB0b2tlbiA9IHRva2Vuc1tpXTtcbiAgICAgICAgaWYgKG9wZW4uaW5jbHVkZXModG9rZW4udmFsdWUpKSB7XG4gICAgICAgICAgICBpZiAoIWRlcHRoQ291bnRzW2RlcHRoXSkge1xuICAgICAgICAgICAgICAgIGRlcHRoQ291bnRzW2RlcHRoXSA9IDA7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGNvbnN0IGRlcHRoSUQgPSBkZXB0aENvdW50c1tkZXB0aF0rKztcbiAgICAgICAgICAgIGNvbnN0IHBhcmVuID0gbmV3IFBhcmVuKGRlcHRoLCBkZXB0aElELHRva2VuLnZhbHVlKTtcbiAgICAgICAgICAgIHRva2Vucy5zcGxpY2UoaSwxLHBhcmVuKVxuICAgICAgICAgICAgLy8gSW5jcmVhc2UgZGVwdGggZm9yIG5lc3RlZCBwYXJlbnRoZXNlc1xuICAgICAgICAgICAgZGVwdGgrKztcbiAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGNsb3NlLmluY2x1ZGVzKHRva2VuLnZhbHVlKSkge1xuICAgICAgICAgICAgZGVwdGgtLTtcbiAgICAgICAgICAgIGlmIChkZXB0aCA8IDApIHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKHRva2VuLnZhbHVlLHRva2VucylcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbm1hdGNoZWQgY2xvc2luZyBwYXJlbnRoZXNpcyBkZXRlY3RlZC5cIik7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIC8vIEFzc2lnbiBhIHVuaXF1ZSBJRCB0byB0aGUgY2xvc2luZyBwYXJlbnRoZXNpc1xuICAgICAgICAgICAgY29uc3QgZGVwdGhJRCA9IGRlcHRoQ291bnRzW2RlcHRoXSAtIDE7XG4gICAgICAgICAgICBjb25zdCBwYXJlbiA9IG5ldyBQYXJlbihkZXB0aCwgZGVwdGhJRCx0b2tlbi52YWx1ZSk7XG4gICAgICAgICAgICB0b2tlbnMuc3BsaWNlKGksMSxwYXJlbilcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8vIENoZWNrIGZvciB1bm1hdGNoZWQgb3BlbmluZyBwYXJlbnRoZXNlc1xuICAgIGlmIChkZXB0aCAhPT0gMCkge1xuICAgICAgICBjb25zb2xlLmVycm9yKHRva2VucylcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbm1hdGNoZWQgb3BlbmluZyBwYXJlbnRoZXNpcyhlcykgZGV0ZWN0ZWQ6IGRlcHRoPSR7ZGVwdGh9YCk7XG4gICAgfVxuICAgIHJldHVybiB0b2tlbnNcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIG1hcEJyYWNrZXRzKHR5cGUsdG9rZW5zKXtcbiAgICByZXR1cm4gdG9rZW5zXG4gICAgICAgIC5tYXAoKHRva2VuLCBpbmRleCkgPT4gXG4gICAgICAgICAgICB0b2tlbi5uYW1lID09PSB0eXBlXG4gICAgICAgICAgICAgICAgPyAvKmZpbmRQYXJlbkluZGV4KHRva2VuLnZhbHVlLCB1bmRlZmluZWQsIHRva2VucykgKi8nZXJyTW9zaGUnXG4gICAgICAgICAgICAgICAgOiBudWxsXG4gICAgICAgIClcbiAgICAgICAgLmZpbHRlcigodCkgPT4gdCAhPT0gbnVsbCk7XG59XG5leHBvcnQgY29uc3QgaXNPcGVuUGFyZW49KGl0ZW0pPT57XG4gICAgaWYoIShpdGVtIGluc3RhbmNlb2YgUGFyZW4pfHwhaXRlbS50eXBlKXJldHVybiBmYWxzZVxuICAgIHJldHVybiBvcGVuLmluY2x1ZGVzKGl0ZW0udHlwZSlcbn1cbmV4cG9ydCBjb25zdCBpc0Nsb3NlZFBhcmVuPShpdGVtKT0+e1xuICAgIGlmKCEoaXRlbSBpbnN0YW5jZW9mIFBhcmVuKXx8IWl0ZW0udHlwZSlyZXR1cm4gZmFsc2VcbiAgICByZXR1cm4gY2xvc2UuaW5jbHVkZXMoaXRlbS50eXBlKVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZmluZE1vZGlmaWVkUGFyZW5JbmRleChpZCwgaW5kZXgsIHRva2VucywgZGVwdGgsIGRlcHRoSUQsIGZpbHRlcikge1xuICAgIC8vIEluaXRpYWxpemUgYGlkYCBhcyBhIG5ldyBpbnN0YW5jZSBpZiBub3QgYWxyZWFkeSBwcm92aWRlZFxuICAgIGlkID0gaWRcbiAgICAgICAgPyBuZXcgUGFyZW4oaWQuZGVwdGgsIGlkLmRlcHRoSUQpXG4gICAgICAgIDogbmV3IFBhcmVuKHRva2Vuc1tpbmRleF0udmFsdWUuZGVwdGgsIHRva2Vuc1tpbmRleF0udmFsdWUuZGVwdGhJRCk7XG5cbiAgICBpZiAoZGVwdGggIT09IHVuZGVmaW5lZCAmJiBkZXB0aElEICE9PSB1bmRlZmluZWQpIHtcbiAgICAgICAgaWQuZGVwdGggKz0gZGVwdGggfHwgMDtcbiAgICAgICAgaWQuZGVwdGhJRCArPSBkZXB0aElEIHx8IDA7XG4gICAgfVxuXG4gICAgY29uc3Qgb3BlbkluZGV4ID0gdG9rZW5zLmZpbmRJbmRleCh0b2tlbiA9PiB7XG4gICAgICAgIGlmIChvcGVuLmluY2x1ZGVzKHRva2VuLm5hbWUpICYmIHRva2VuLnZhbHVlPy5jb21wYXJlKGlkKSkge1xuICAgICAgICAgICAgaWYgKGZpbHRlciAmJiAhdG9rZW4ubmFtZS5zdGFydHNXaXRoKGZpbHRlcikpIHtcbiAgICAgICAgICAgICAgICBpZC5kZXB0aCA9IHRva2VuLnZhbHVlLmRlcHRoICsgKGRlcHRoIHx8IDApXG4gICAgICAgICAgICAgICAgaWQuZGVwdGhJRD10b2tlbi52YWx1ZS5kZXB0aElEICsgKGRlcHRoSUQgfHwgMClcbiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfSk7XG5cbiAgICBjb25zdCBjbG9zZUluZGV4ID0gdG9rZW5zLmZpbmRMYXN0SW5kZXgoXG4gICAgICAgIHRva2VuID0+XG4gICAgICAgICAgICBjbG9zZS5pbmNsdWRlcyh0b2tlbi5uYW1lKSAmJlxuICAgICAgICAgICAgdG9rZW4udmFsdWU/LmNvbXBhcmUoaWQpXG4gICAgKTtcblxuICAgIHJldHVybiB7IG9wZW46IG9wZW5JbmRleCwgY2xvc2U6IGNsb3NlSW5kZXgsIGlkIH07XG59XG5cblxuXG5leHBvcnQgZnVuY3Rpb24gZmluZFBhcmVuSW5kZXgoaWQsaW5kZXgsdG9rZW5zKXtcbiAgICBpZD1pZD9pZDp0b2tlbnNbaW5kZXhdO1xuXG4gICAgY29uc3Qgb3BlbkluZGV4PXRva2Vucy5maW5kSW5kZXgoXG4gICAgICAgIHRva2VuPT5vcGVuLmluY2x1ZGVzKHRva2VuLnR5cGUpXG4gICAgICAgICYmaWQuY29tcGFyZSh0b2tlbilcbiAgICApXG4gICAgY29uc3QgY2xvc2VJbmRleD10b2tlbnMuZmluZExhc3RJbmRleChcbiAgICAgICAgdG9rZW49PmNsb3NlLmluY2x1ZGVzKHRva2VuLnR5cGUpXG4gICAgICAgICYmaWQuY29tcGFyZSh0b2tlbilcbiAgICApXG4gICAgcmV0dXJue29wZW46IG9wZW5JbmRleCxjbG9zZTogY2xvc2VJbmRleCxpZDppZH1cbn0iXX0=