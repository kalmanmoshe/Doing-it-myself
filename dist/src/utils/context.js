import { Direction, escalateToToken, findMatchingBracket, getCharacterAtPos, getCloseBracket } from "src/utils/editor_utils";
import { Mode } from "../snippets/options";
import { getLatexSuiteConfig } from "../snippets/codemirror/config";
import { syntaxTree } from "@codemirror/language";
export class Context {
    state;
    mode;
    pos;
    ranges;
    codeblockLanguage;
    boundsCache;
    static fromState(state) {
        const ctx = new Context();
        const sel = state.selection;
        ctx.state = state;
        ctx.pos = sel.main.to;
        ctx.ranges = Array.from(sel.ranges).reverse();
        ctx.mode = new Mode();
        ctx.boundsCache = new Map();
        const codeblockLanguage = langIfWithinCodeblock(state);
        const lengToTranslate = ['tikz'];
        const inCode = codeblockLanguage !== null;
        const settings = getLatexSuiteConfig(state);
        const forceMath = codeblockLanguage ? settings.forceMathLanguages.contains(codeblockLanguage) : false;
        ctx.mode.codeMath = forceMath;
        ctx.mode.code = inCode && !forceMath;
        if (ctx.mode.code && codeblockLanguage)
            ctx.codeblockLanguage = codeblockLanguage;
        if (ctx.mode.isntInText() && lengToTranslate.contains(ctx.codeblockLanguage)) {
            ctx.mode.translate = true;
        }
        // first, check if math mode should be "generally" on
        const inMath = forceMath || isWithinEquation(state);
        if (inMath && !forceMath) {
            const inInlineEquation = isWithinInlineEquation(state);
            ctx.mode.blockMath = !inInlineEquation;
            ctx.mode.inlineMath = inInlineEquation;
        }
        if (inMath) {
            ctx.mode.textEnv = ctx.inTextEnvironment();
        }
        ctx.mode.text = !inCode && !inMath;
        return ctx;
    }
    static fromView(view) {
        return Context.fromState(view.state);
    }
    isWithinEnvironment(pos, env) {
        if (!this.mode.inMath())
            return false;
        const bounds = this.getInnerBounds();
        if (!bounds)
            return false;
        const { start, end } = bounds;
        const text = this.state.sliceDoc(start, end);
        // pos referred to the absolute position in the whole document, but we just sliced the text
        // so now pos must be relative to the start in order to be any useful
        pos -= start;
        const openBracket = env.openSymbol.slice(-1);
        const closeBracket = getCloseBracket(openBracket);
        // Take care when the open symbol ends with a bracket {, [, or (
        // as then the closing symbol, }, ] or ), is not unique to this open symbol
        let offset;
        let openSearchSymbol;
        if (["{", "[", "("].contains(openBracket) && env.closeSymbol === closeBracket) {
            offset = env.openSymbol.length - 1;
            openSearchSymbol = openBracket;
        }
        else {
            offset = 0;
            openSearchSymbol = env.openSymbol;
        }
        let left = text.lastIndexOf(env.openSymbol, pos - 1);
        while (left != -1) {
            const right = findMatchingBracket(text, left + offset, openSearchSymbol, env.closeSymbol, false);
            if (right === -1)
                return false;
            // Check whether the cursor lies inside the environment symbols
            if ((right >= pos) && (pos >= left + env.openSymbol.length)) {
                return true;
            }
            if (left <= 0)
                return false;
            // Find the next open symbol
            left = text.lastIndexOf(env.openSymbol, left - 1);
        }
        return false;
    }
    inTextEnvironment() {
        return (this.isWithinEnvironment(this.pos, { openSymbol: "\\text{", closeSymbol: "}" }) ||
            this.isWithinEnvironment(this.pos, { openSymbol: "\\tag{", closeSymbol: "}" }) ||
            this.isWithinEnvironment(this.pos, { openSymbol: "\\begin{", closeSymbol: "}" }) ||
            this.isWithinEnvironment(this.pos, { openSymbol: "\\end{", closeSymbol: "}" }));
    }
    getBounds(pos = this.pos) {
        // yes, I also want the cache to work over the produced range instead of just that one through
        // a BTree or the like, but that'd be probably overkill
        if (this.boundsCache.has(pos)) {
            return this.boundsCache.get(pos) || null;
        }
        let bounds;
        if (this.mode.codeMath) {
            // means a codeblock language triggered the math mode -> use the codeblock bounds instead
            bounds = getCodeblockBounds(this.state, pos);
        }
        else {
            bounds = getEquationBounds(this.state);
        }
        if (bounds)
            this.boundsCache.set(pos, bounds);
        return bounds;
    }
    // Accounts for equations within text environments, e.g. $$\text{... $...$}$$
    getInnerBounds(pos = this.pos) {
        let bounds;
        if (this.mode.codeMath) {
            // means a codeblock language triggered the math mode -> use the codeblock bounds instead
            bounds = getCodeblockBounds(this.state, pos);
        }
        else {
            bounds = getInnerEquationBounds(this.state);
        }
        return bounds;
    }
}
const isWithinEquation = (state) => {
    const pos = state.selection.main.to;
    const tree = syntaxTree(state);
    let syntaxNode = tree.resolveInner(pos, -1);
    if (syntaxNode.name.contains("math-end"))
        return false;
    if (!syntaxNode.parent) {
        syntaxNode = tree.resolveInner(pos, 1);
        if (syntaxNode.name.contains("math-begin"))
            return false;
    }
    // Account/allow for being on an empty line in a equation
    if (!syntaxNode.parent) {
        const left = tree.resolveInner(pos - 1, -1);
        const right = tree.resolveInner(pos + 1, 1);
        return (left.name.contains("math") && right.name.contains("math") && !(left.name.contains("math-end")));
    }
    return (syntaxNode.name.contains("math"));
};
const isWithinInlineEquation = (state) => {
    const pos = state.selection.main.to;
    const tree = syntaxTree(state);
    let syntaxNode = tree.resolveInner(pos, -1);
    if (syntaxNode.name.contains("math-end"))
        return false;
    if (!syntaxNode.parent) {
        syntaxNode = tree.resolveInner(pos, 1);
        if (syntaxNode.name.contains("math-begin"))
            return false;
    }
    // Account/allow for being on an empty line in a equation
    if (!syntaxNode.parent)
        syntaxNode = tree.resolveInner(pos - 1, -1);
    const cursor = syntaxNode.cursor();
    const res = escalateToToken(cursor, Direction.Backward, "math-begin");
    return !res?.name.contains("math-block");
};
/**
 * Figures out where this equation starts and where it ends.
 *
 * **Note:** If you intend to use this directly, check out Context.getBounds instead, which caches and also takes care of codeblock languages which should behave like math mode.
 */
export const getEquationBounds = (state, pos) => {
    if (!pos)
        pos = state.selection.main.to;
    const tree = syntaxTree(state);
    let syntaxNode = tree.resolveInner(pos, -1);
    if (!syntaxNode.parent) {
        syntaxNode = tree.resolveInner(pos, 1);
    }
    // Account/allow for being on an empty line in a equation
    if (!syntaxNode.parent)
        syntaxNode = tree.resolveInner(pos - 1, -1);
    const cursor = syntaxNode.cursor();
    const begin = escalateToToken(cursor, Direction.Backward, "math-begin");
    const end = escalateToToken(cursor, Direction.Forward, "math-end");
    if (begin && end) {
        return { start: begin.to, end: end.from };
    }
    else {
        return null;
    }
};
// Accounts for equations within text environments, e.g. $$\text{... $...$}$$
const getInnerEquationBounds = (state, pos) => {
    if (!pos)
        pos = state.selection.main.to;
    let text = state.doc.toString();
    // ignore \$
    text = text.replaceAll("\\$", "\\R");
    const left = text.lastIndexOf("$", pos - 1);
    const right = text.indexOf("$", pos);
    if (left === -1 || right === -1)
        return null;
    return { start: left + 1, end: right };
};
/**
 * Figures out where this codeblock starts and where it ends.
 *
 * **Note:** If you intend to use this directly, check out Context.getBounds instead, which caches and also takes care of codeblock languages which should behave like math mode.
 */
const getCodeblockBounds = (state, pos = state.selection.main.from) => {
    const tree = syntaxTree(state);
    let cursor = tree.cursorAt(pos, -1);
    const blockBegin = escalateToToken(cursor, Direction.Backward, "HyperMD-codeblock-begin");
    cursor = tree.cursorAt(pos, -1);
    const blockEnd = escalateToToken(cursor, Direction.Forward, "HyperMD-codeblock-end");
    if (blockBegin && blockEnd)
        return { start: blockBegin.to + 1, end: blockEnd.from - 1 };
    return null;
};
const findFirstNonNewlineBefore = (state, pos) => {
    let currentPos = pos;
    while (currentPos >= 0) {
        const char = getCharacterAtPos(state, currentPos - 1);
        if (char !== "\n") {
            return currentPos;
        }
        currentPos--;
    }
    return 0;
};
const langIfWithinCodeblock = (state) => {
    const tree = syntaxTree(state);
    const pos = state.selection.ranges[0].from;
    const adjustedPos = pos === 0 ? 0 : findFirstNonNewlineBefore(state, pos);
    const cursor = tree.cursorAt(adjustedPos, -1);
    const inCodeblock = cursor.name.contains("codeblock");
    if (!inCodeblock) {
        return null;
    }
    // locate the start of the block
    const codeblockBegin = escalateToToken(cursor, Direction.Backward, "HyperMD-codeblock_HyperMD-codeblock-begin");
    if (codeblockBegin == null) {
        console.warn("unable to locate start of the codeblock even though inside one");
        return "";
    }
    // extract the language
    // codeblocks may start and end with an arbitrary number of backticks
    const language = state.sliceDoc(codeblockBegin.from, codeblockBegin.to).replace(/`+/, "");
    return language;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9jb250ZXh0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUFFLG1CQUFtQixFQUFFLGlCQUFpQixFQUFFLGVBQWUsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBQzdILE9BQU8sRUFBRSxJQUFJLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUUzQyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFPbEQsTUFBTSxPQUFPLE9BQU87SUFDbkIsS0FBSyxDQUFjO0lBQ25CLElBQUksQ0FBUTtJQUNaLEdBQUcsQ0FBUztJQUNaLE1BQU0sQ0FBbUI7SUFDekIsaUJBQWlCLENBQVM7SUFDMUIsV0FBVyxDQUFzQjtJQUVqQyxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQWtCO1FBQ2xDLE1BQU0sR0FBRyxHQUFHLElBQUksT0FBTyxFQUFFLENBQUM7UUFDMUIsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQztRQUM1QixHQUFHLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztRQUNsQixHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO1FBQ3RCLEdBQUcsQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDOUMsR0FBRyxDQUFDLElBQUksR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQ3RCLEdBQUcsQ0FBQyxXQUFXLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUU1QixNQUFNLGlCQUFpQixHQUFHLHFCQUFxQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3ZELE1BQU0sZUFB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R0FBRyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztJQUczQyxNQUFNLFdBQVcsR0FBRSxHQUFHLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLHlCQUF5QixDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN6RSxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRTlDLE1BQU0sV0FBVyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBRXRELElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNsQixPQUFPLElBQUksQ0FBQztJQUNiLENBQUM7SUFFRCxnQ0FBZ0M7SUFDaEMsTUFBTSxjQUFjLEdBQUcsZUFBZSxDQUFDLE1BQU0sRUFBRSxTQUFTLENBQUMsUUFBUSxFQUFFLDJDQUEyQyxDQUFDLENBQUM7SUFFaEgsSUFBSSxjQUFjLElBQUksSUFBSSxFQUFFLENBQUM7UUFDNUIsT0FBTyxDQUFDLElBQUksQ0FBQyxnRUFBZ0UsQ0FBQyxDQUFDO1FBQy9FLE9BQU8sRUFBRSxDQUFDO0lBQ1gsQ0FBQztJQUVELHVCQUF1QjtJQUN2QixxRUFBcUU7SUFDckUsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsSUFBSSxFQUFFLGNBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRTFGLE9BQU8sUUFBUSxDQUFDO0FBQ2pCLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclN0YXRlLCBTZWxlY3Rpb25SYW5nZSB9IGZyb20gXCJAY29kZW1pcnJvci9zdGF0ZVwiO1xuaW1wb3J0IHsgRWRpdG9yVmlldyB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XG5pbXBvcnQgeyBEaXJlY3Rpb24sIGVzY2FsYXRlVG9Ub2tlbiwgZmluZE1hdGNoaW5nQnJhY2tldCwgZ2V0Q2hhcmFjdGVyQXRQb3MsIGdldENsb3NlQnJhY2tldCB9IGZyb20gXCJzcmMvdXRpbHMvZWRpdG9yX3V0aWxzXCI7XG5pbXBvcnQgeyBNb2RlIH0gZnJvbSBcIi4uL3NuaXBwZXRzL29wdGlvbnNcIjtcbmltcG9ydCB7IEVudmlyb25tZW50IH0gZnJvbSBcIi4uL3NuaXBwZXRzL2Vudmlyb25tZW50XCI7XG5pbXBvcnQgeyBnZXRMYXRleFN1aXRlQ29uZmlnIH0gZnJvbSBcIi4uL3NuaXBwZXRzL2NvZGVtaXJyb3IvY29uZmlnXCI7XG5pbXBvcnQgeyBzeW50YXhUcmVlIH0gZnJvbSBcIkBjb2RlbWlycm9yL2xhbmd1YWdlXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQm91bmRzIHtcblx0c3RhcnQ6IG51bWJlcjtcblx0ZW5kOiBudW1iZXI7XG59XG5cbmV4cG9ydCBjbGFzcyBDb250ZXh0IHtcblx0c3RhdGU6IEVkaXRvclN0YXRlO1xuXHRtb2RlITogTW9kZTtcblx0cG9zOiBudW1iZXI7XG5cdHJhbmdlczogU2VsZWN0aW9uUmFuZ2VbXTtcblx0Y29kZWJsb2NrTGFuZ3VhZ2U6IHN0cmluZztcblx0Ym91bmRzQ2FjaGU6IE1hcDxudW1iZXIsIEJvdW5kcz47XG5cblx0c3RhdGljIGZyb21TdGF0ZShzdGF0ZTogRWRpdG9yU3RhdGUpOkNvbnRleHQge1xuXHRcdGNvbnN0IGN0eCA9IG5ldyBDb250ZXh0KCk7XG5cdFx0Y29uc3Qgc2VsID0gc3RhdGUuc2VsZWN0aW9uO1xuXHRcdGN0eC5zdGF0ZSA9IHN0YXRlO1xuXHRcdGN0eC5wb3MgPSBzZWwubWFpbi50bztcblx0XHRjdHgucmFuZ2VzID0gQXJyYXkuZnJvbShzZWwucmFuZ2VzKS5yZXZlcnNlKCk7XG5cdFx0Y3R4Lm1vZGUgPSBuZXcgTW9kZSgpO1xuXHRcdGN0eC5ib3VuZHNDYWNoZSA9IG5ldyBNYXAoKTtcblxuXHRcdGNvbnN0IGNvZGVibG9ja0xhbmd1YWdlID0gbGFuZ0lmV2l0aGluQ29kZWJsb2NrKHN0YXRlKTtcblx0XHRjb25zdCBsZW5nVG9UcmFuc2xhdGU9IFsndGlreiddXG5cdFx0Y29uc3QgaW5Db2RlID0gY29kZWJsb2NrTGFuZ3VhZ2UgIT09IG51bGw7XG5cdFx0Y29uc3Qgc2V0dGluZ3MgPSBnZXRMYXRleFN1aXRlQ29uZmlnKHN0YXRlKTtcblx0XHRjb25zdCBmb3JjZU1hdGggPSBjb2RlYmxvY2tMYW5ndWFnZT9zZXR0aW5ncy5mb3JjZU1hdGhMYW5ndWFnZXMuY29udGFpbnMoY29kZWJsb2NrTGFuZ3VhZ2UpOmZhbHNlO1xuXHRcdGN0eC5tb2RlLmNvZGVNYXRoID0gZm9yY2VNYXRoO1xuXHRcdGN0eC5tb2RlLmNvZGUgPSBpbkNvZGUgJiYgIWZvcmNlTWF0aDtcblx0XHRpZiAoY3R4Lm1vZGUuY29kZSYmY29kZWJsb2NrTGFuZ3VhZ2UpIGN0eC5jb2RlYmxvY2tMYW5ndWFnZSA9IGNvZGVibG9ja0xhbmd1YWdlO1xuXHRcdGlmIChjdHgubW9kZS5pc250SW5UZXh0KCkmJmxlbmdUb1RyYW5zbGF0ZS5jb250YWlucyhjdHguY29kZWJsb2NrTGFuZ3VhZ2UpKXtcblx0XHRcdGN0eC5tb2RlLnRyYW5zbGF0ZT10cnVlO1xuXHRcdH1cblxuXHRcdC8vIGZpcnN0LCBjaGVjayBpZiBtYXRoIG1vZGUgc2hvdWxkIGJlIFwiZ2VuZXJhbGx5XCIgb25cblx0XHRjb25zdCBpbk1hdGggPSBmb3JjZU1hdGggfHwgaXNXaXRoaW5FcXVhdGlvbihzdGF0ZSk7XG5cblx0XHRpZiAoaW5NYXRoICYmICFmb3JjZU1hdGgpIHtcblx0XHRcdGNvbnN0IGluSW5saW5lRXF1YXRpb24gPSBpc1dpdGhpbklubGluZUVxdWF0aW9uKHN0YXRlKTtcblxuXHRcdFx0Y3R4Lm1vZGUuYmxvY2tNYXRoID0gIWluSW5saW5lRXF1YXRpb247XG5cdFx0XHRjdHgubW9kZS5pbmxpbmVNYXRoID0gaW5JbmxpbmVFcXVhdGlvbjtcblx0XHR9XG5cblx0XHRpZiAoaW5NYXRoKSB7XG5cdFx0XHRjdHgubW9kZS50ZXh0RW52ID0gY3R4LmluVGV4dEVudmlyb25tZW50KCk7XG5cdFx0fVxuXG5cdFx0Y3R4Lm1vZGUudGV4dCA9ICFpbkNvZGUgJiYgIWluTWF0aDtcblxuXHRcdHJldHVybiBjdHg7XG5cdH1cblxuXHRzdGF0aWMgZnJvbVZpZXcodmlldzogRWRpdG9yVmlldyk6Q29udGV4dCB7XG5cdFx0cmV0dXJuIENvbnRleHQuZnJvbVN0YXRlKHZpZXcuc3RhdGUpO1xuXHR9XG5cblx0aXNXaXRoaW5FbnZpcm9ubWVudChwb3M6IG51bWJlciwgZW52OiBFbnZpcm9ubWVudCk6IGJvb2xlYW4ge1xuXHRcdGlmICghdGhpcy5tb2RlLmluTWF0aCgpKSByZXR1cm4gZmFsc2U7XG5cblx0XHRjb25zdCBib3VuZHMgPSB0aGlzLmdldElubmVyQm91bmRzKCk7XG5cdFx0aWYgKCFib3VuZHMpIHJldHVybiBmYWxzZTtcblxuXHRcdGNvbnN0IHtzdGFydCwgZW5kfSA9IGJvdW5kcztcblx0XHRjb25zdCB0ZXh0ID0gdGhpcy5zdGF0ZS5zbGljZURvYyhzdGFydCwgZW5kKTtcblx0XHQvLyBwb3MgcmVmZXJyZWQgdG8gdGhlIGFic29sdXRlIHBvc2l0aW9uIGluIHRoZSB3aG9sZSBkb2N1bWVudCwgYnV0IHdlIGp1c3Qgc2xpY2VkIHRoZSB0ZXh0XG5cdFx0Ly8gc28gbm93IHBvcyBtdXN0IGJlIHJlbGF0aXZlIHRvIHRoZSBzdGFydCBpbiBvcmRlciB0byBiZSBhbnkgdXNlZnVsXG5cdFx0cG9zIC09IHN0YXJ0O1xuXG5cdFx0Y29uc3Qgb3BlbkJyYWNrZXQgPSBlbnYub3BlblN5bWJvbC5zbGljZSgtMSk7XG5cdFx0Y29uc3QgY2xvc2VCcmFja2V0ID0gZ2V0Q2xvc2VCcmFja2V0KG9wZW5CcmFja2V0KTtcblxuXHRcdC8vIFRha2UgY2FyZSB3aGVuIHRoZSBvcGVuIHN5bWJvbCBlbmRzIHdpdGggYSBicmFja2V0IHssIFssIG9yIChcblx0XHQvLyBhcyB0aGVuIHRoZSBjbG9zaW5nIHN5bWJvbCwgfSwgXSBvciApLCBpcyBub3QgdW5pcXVlIHRvIHRoaXMgb3BlbiBzeW1ib2xcblx0XHRsZXQgb2Zmc2V0O1xuXHRcdGxldCBvcGVuU2VhcmNoU3ltYm9sO1xuXG5cdFx0aWYgKFtcIntcIiwgXCJbXCIsIFwiKFwiXS5jb250YWlucyhvcGVuQnJhY2tldCkgJiYgZW52LmNsb3NlU3ltYm9sID09PSBjbG9zZUJyYWNrZXQpIHtcblx0XHRcdG9mZnNldCA9IGVudi5vcGVuU3ltYm9sLmxlbmd0aCAtIDE7XG5cdFx0XHRvcGVuU2VhcmNoU3ltYm9sID0gb3BlbkJyYWNrZXQ7XG5cdFx0fSBlbHNlIHtcblx0XHRcdG9mZnNldCA9IDA7XG5cdFx0XHRvcGVuU2VhcmNoU3ltYm9sID0gZW52Lm9wZW5TeW1ib2w7XG5cdFx0fVxuXG5cdFx0bGV0IGxlZnQgPSB0ZXh0Lmxhc3RJbmRleE9mKGVudi5vcGVuU3ltYm9sLCBwb3MgLSAxKTtcblxuXHRcdHdoaWxlIChsZWZ0ICE9IC0xKSB7XG5cdFx0XHRjb25zdCByaWdodCA9IGZpbmRNYXRjaGluZ0JyYWNrZXQodGV4dCwgbGVmdCArIG9mZnNldCwgb3BlblNlYXJjaFN5bWJvbCwgZW52LmNsb3NlU3ltYm9sLCBmYWxzZSk7XG5cblx0XHRcdGlmIChyaWdodCA9PT0gLTEpIHJldHVybiBmYWxzZTtcblxuXHRcdFx0Ly8gQ2hlY2sgd2hldGhlciB0aGUgY3Vyc29yIGxpZXMgaW5zaWRlIHRoZSBlbnZpcm9ubWVudCBzeW1ib2xzXG5cdFx0XHRpZiAoKHJpZ2h0ID49IHBvcykgJiYgKHBvcyA+PSBsZWZ0ICsgZW52Lm9wZW5TeW1ib2wubGVuZ3RoKSkge1xuXHRcdFx0XHRyZXR1cm4gdHJ1ZTtcblx0XHRcdH1cblxuXHRcdFx0aWYgKGxlZnQgPD0gMCkgcmV0dXJuIGZhbHNlO1xuXG5cdFx0XHQvLyBGaW5kIHRoZSBuZXh0IG9wZW4gc3ltYm9sXG5cdFx0XHRsZWZ0ID0gdGV4dC5sYXN0SW5kZXhPZihlbnYub3BlblN5bWJvbCwgbGVmdCAtIDEpO1xuXHRcdH1cblxuXHRcdHJldHVybiBmYWxzZTtcblx0fVxuXG5cdGluVGV4dEVudmlyb25tZW50KCk6IGJvb2xlYW4ge1xuXHRcdHJldHVybiAoXG5cdFx0XHR0aGlzLmlzV2l0aGluRW52aXJvbm1lbnQodGhpcy5wb3MsIHtvcGVuU3ltYm9sOiBcIlxcXFx0ZXh0e1wiLCBjbG9zZVN5bWJvbDogXCJ9XCJ9KSB8fFxuXHRcdFx0dGhpcy5pc1dpdGhpbkVudmlyb25tZW50KHRoaXMucG9zLCB7b3BlblN5bWJvbDogXCJcXFxcdGFne1wiLCBjbG9zZVN5bWJvbDogXCJ9XCJ9KSB8fFxuXHRcdFx0dGhpcy5pc1dpdGhpbkVudmlyb25tZW50KHRoaXMucG9zLCB7b3BlblN5bWJvbDogXCJcXFxcYmVnaW57XCIsIGNsb3NlU3ltYm9sOiBcIn1cIn0pIHx8XG5cdFx0XHR0aGlzLmlzV2l0aGluRW52aXJvbm1lbnQodGhpcy5wb3MsIHtvcGVuU3ltYm9sOiBcIlxcXFxlbmR7XCIsIGNsb3NlU3ltYm9sOiBcIn1cIn0pXG5cdFx0KTtcblx0fVxuXG5cdGdldEJvdW5kcyhwb3M6IG51bWJlciA9IHRoaXMucG9zKTogQm91bmRzfG51bGwge1xuXHRcdC8vIHllcywgSSBhbHNvIHdhbnQgdGhlIGNhY2hlIHRvIHdvcmsgb3ZlciB0aGUgcHJvZHVjZWQgcmFuZ2UgaW5zdGVhZCBvZiBqdXN0IHRoYXQgb25lIHRocm91Z2hcblx0XHQvLyBhIEJUcmVlIG9yIHRoZSBsaWtlLCBidXQgdGhhdCdkIGJlIHByb2JhYmx5IG92ZXJraWxsXG5cdFx0aWYgKHRoaXMuYm91bmRzQ2FjaGUuaGFzKHBvcykpIHtcblx0XHRcdHJldHVybiB0aGlzLmJvdW5kc0NhY2hlLmdldChwb3MpfHxudWxsO1xuXHRcdH1cblxuXHRcdGxldCBib3VuZHM7XG5cdFx0aWYgKHRoaXMubW9kZS5jb2RlTWF0aCkge1xuXHRcdFx0Ly8gbWVhbnMgYSBjb2RlYmxvY2sgbGFuZ3VhZ2UgdHJpZ2dlcmVkIHRoZSBtYXRoIG1vZGUgLT4gdXNlIHRoZSBjb2RlYmxvY2sgYm91bmRzIGluc3RlYWRcblx0XHRcdGJvdW5kcyA9IGdldENvZGVibG9ja0JvdW5kcyh0aGlzLnN0YXRlLCBwb3MpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRib3VuZHMgPSBnZXRFcXVhdGlvbkJvdW5kcyh0aGlzLnN0YXRlKTtcblx0XHR9XG5cdFx0aWYoYm91bmRzKVxuXHRcdHRoaXMuYm91bmRzQ2FjaGUuc2V0KHBvcywgYm91bmRzKTtcblx0XHRyZXR1cm4gYm91bmRzO1xuXHR9XG5cblx0Ly8gQWNjb3VudHMgZm9yIGVxdWF0aW9ucyB3aXRoaW4gdGV4dCBlbnZpcm9ubWVudHMsIGUuZy4gJCRcXHRleHR7Li4uICQuLi4kfSQkXG5cdGdldElubmVyQm91bmRzKHBvczogbnVtYmVyID0gdGhpcy5wb3MpOiBCb3VuZHN8bnVsbCB7XG5cdFx0bGV0IGJvdW5kcztcblx0XHRpZiAodGhpcy5tb2RlLmNvZGVNYXRoKSB7XG5cdFx0XHQvLyBtZWFucyBhIGNvZGVibG9jayBsYW5ndWFnZSB0cmlnZ2VyZWQgdGhlIG1hdGggbW9kZSAtPiB1c2UgdGhlIGNvZGVibG9jayBib3VuZHMgaW5zdGVhZFxuXHRcdFx0Ym91bmRzID0gZ2V0Q29kZWJsb2NrQm91bmRzKHRoaXMuc3RhdGUsIHBvcyk7XG5cdFx0fSBlbHNlIHtcblx0XHRcdGJvdW5kcyA9IGdldElubmVyRXF1YXRpb25Cb3VuZHModGhpcy5zdGF0ZSk7XG5cdFx0fVxuXG5cdFx0cmV0dXJuIGJvdW5kcztcblx0fVxuXG59XG5cbmNvbnN0IGlzV2l0aGluRXF1YXRpb24gPSAoc3RhdGU6IEVkaXRvclN0YXRlKTpib29sZWFuID0+IHtcblx0Y29uc3QgcG9zID0gc3RhdGUuc2VsZWN0aW9uLm1haW4udG87XG5cdGNvbnN0IHRyZWUgPSBzeW50YXhUcmVlKHN0YXRlKTtcblxuXHRsZXQgc3ludGF4Tm9kZSA9IHRyZWUucmVzb2x2ZUlubmVyKHBvcywgLTEpO1xuXHRpZiAoc3ludGF4Tm9kZS5uYW1lLmNvbnRhaW5zKFwibWF0aC1lbmRcIikpIHJldHVybiBmYWxzZTtcblxuXHRpZiAoIXN5bnRheE5vZGUucGFyZW50KSB7XG5cdFx0c3ludGF4Tm9kZSA9IHRyZWUucmVzb2x2ZUlubmVyKHBvcywgMSk7XG5cdFx0aWYgKHN5bnRheE5vZGUubmFtZS5jb250YWlucyhcIm1hdGgtYmVnaW5cIikpIHJldHVybiBmYWxzZTtcblx0fVxuXG5cdC8vIEFjY291bnQvYWxsb3cgZm9yIGJlaW5nIG9uIGFuIGVtcHR5IGxpbmUgaW4gYSBlcXVhdGlvblxuXHRpZiAoIXN5bnRheE5vZGUucGFyZW50KSB7XG5cdFx0Y29uc3QgbGVmdCA9IHRyZWUucmVzb2x2ZUlubmVyKHBvcyAtIDEsIC0xKTtcblx0XHRjb25zdCByaWdodCA9IHRyZWUucmVzb2x2ZUlubmVyKHBvcyArIDEsIDEpO1xuXG5cdFx0cmV0dXJuIChsZWZ0Lm5hbWUuY29udGFpbnMoXCJtYXRoXCIpICYmIHJpZ2h0Lm5hbWUuY29udGFpbnMoXCJtYXRoXCIpICYmICEobGVmdC5uYW1lLmNvbnRhaW5zKFwibWF0aC1lbmRcIikpKTtcblx0fVxuXG5cdHJldHVybiAoc3ludGF4Tm9kZS5uYW1lLmNvbnRhaW5zKFwibWF0aFwiKSk7XG59XG5cbmNvbnN0IGlzV2l0aGluSW5saW5lRXF1YXRpb24gPSAoc3RhdGU6IEVkaXRvclN0YXRlKTpib29sZWFuID0+IHtcblx0Y29uc3QgcG9zID0gc3RhdGUuc2VsZWN0aW9uLm1haW4udG87XG5cdGNvbnN0IHRyZWUgPSBzeW50YXhUcmVlKHN0YXRlKTtcblxuXHRsZXQgc3ludGF4Tm9kZSA9IHRyZWUucmVzb2x2ZUlubmVyKHBvcywgLTEpO1xuXHRpZiAoc3ludGF4Tm9kZS5uYW1lLmNvbnRhaW5zKFwibWF0aC1lbmRcIikpIHJldHVybiBmYWxzZTtcblxuXHRpZiAoIXN5bnRheE5vZGUucGFyZW50KSB7XG5cdFx0c3ludGF4Tm9kZSA9IHRyZWUucmVzb2x2ZUlubmVyKHBvcywgMSk7XG5cdFx0aWYgKHN5bnRheE5vZGUubmFtZS5jb250YWlucyhcIm1hdGgtYmVnaW5cIikpIHJldHVybiBmYWxzZTtcblx0fVxuXG5cdC8vIEFjY291bnQvYWxsb3cgZm9yIGJlaW5nIG9uIGFuIGVtcHR5IGxpbmUgaW4gYSBlcXVhdGlvblxuXHRpZiAoIXN5bnRheE5vZGUucGFyZW50KSBzeW50YXhOb2RlID0gdHJlZS5yZXNvbHZlSW5uZXIocG9zIC0gMSwgLTEpO1xuXG5cdGNvbnN0IGN1cnNvciA9IHN5bnRheE5vZGUuY3Vyc29yKCk7XG5cdGNvbnN0IHJlcyA9IGVzY2FsYXRlVG9Ub2tlbihjdXJzb3IsIERpcmVjdGlvbi5CYWNrd2FyZCwgXCJtYXRoLWJlZ2luXCIpO1xuXG5cdHJldHVybiAhcmVzPy5uYW1lLmNvbnRhaW5zKFwibWF0aC1ibG9ja1wiKTtcbn1cblxuLyoqXG4gKiBGaWd1cmVzIG91dCB3aGVyZSB0aGlzIGVxdWF0aW9uIHN0YXJ0cyBhbmQgd2hlcmUgaXQgZW5kcy5cbiAqXG4gKiAqKk5vdGU6KiogSWYgeW91IGludGVuZCB0byB1c2UgdGhpcyBkaXJlY3RseSwgY2hlY2sgb3V0IENvbnRleHQuZ2V0Qm91bmRzIGluc3RlYWQsIHdoaWNoIGNhY2hlcyBhbmQgYWxzbyB0YWtlcyBjYXJlIG9mIGNvZGVibG9jayBsYW5ndWFnZXMgd2hpY2ggc2hvdWxkIGJlaGF2ZSBsaWtlIG1hdGggbW9kZS5cbiAqL1xuZXhwb3J0IGNvbnN0IGdldEVxdWF0aW9uQm91bmRzID0gKHN0YXRlOiBFZGl0b3JTdGF0ZSwgcG9zPzogbnVtYmVyKTpCb3VuZHN8bnVsbCA9PiB7XG5cdGlmICghcG9zKSBwb3MgPSBzdGF0ZS5zZWxlY3Rpb24ubWFpbi50bztcblx0Y29uc3QgdHJlZSA9IHN5bnRheFRyZWUoc3RhdGUpO1xuXG5cdGxldCBzeW50YXhOb2RlID0gdHJlZS5yZXNvbHZlSW5uZXIocG9zLCAtMSk7XG5cblx0aWYgKCFzeW50YXhOb2RlLnBhcmVudCkge1xuXHRcdHN5bnRheE5vZGUgPSB0cmVlLnJlc29sdmVJbm5lcihwb3MsIDEpO1xuXHR9XG5cblx0Ly8gQWNjb3VudC9hbGxvdyBmb3IgYmVpbmcgb24gYW4gZW1wdHkgbGluZSBpbiBhIGVxdWF0aW9uXG5cdGlmICghc3ludGF4Tm9kZS5wYXJlbnQpIHN5bnRheE5vZGUgPSB0cmVlLnJlc29sdmVJbm5lcihwb3MgLSAxLCAtMSk7XG5cblx0Y29uc3QgY3Vyc29yID0gc3ludGF4Tm9kZS5jdXJzb3IoKTtcblx0Y29uc3QgYmVnaW4gPSBlc2NhbGF0ZVRvVG9rZW4oY3Vyc29yLCBEaXJlY3Rpb24uQmFja3dhcmQsIFwibWF0aC1iZWdpblwiKTtcblx0Y29uc3QgZW5kID0gZXNjYWxhdGVUb1Rva2VuKGN1cnNvciwgRGlyZWN0aW9uLkZvcndhcmQsIFwibWF0aC1lbmRcIik7XG5cblx0aWYgKGJlZ2luICYmIGVuZCkge1xuXHRcdHJldHVybiB7c3RhcnQ6IGJlZ2luLnRvLCBlbmQ6IGVuZC5mcm9tfTtcblx0fVxuXHRlbHNlIHtcblx0XHRyZXR1cm4gbnVsbDtcblx0fVxufVxuXG4vLyBBY2NvdW50cyBmb3IgZXF1YXRpb25zIHdpdGhpbiB0ZXh0IGVudmlyb25tZW50cywgZS5nLiAkJFxcdGV4dHsuLi4gJC4uLiR9JCRcbmNvbnN0IGdldElubmVyRXF1YXRpb25Cb3VuZHMgPSAoc3RhdGU6IEVkaXRvclN0YXRlLCBwb3M/OiBudW1iZXIpOkJvdW5kc3xudWxsID0+IHtcblx0aWYgKCFwb3MpIHBvcyA9IHN0YXRlLnNlbGVjdGlvbi5tYWluLnRvO1xuXHRsZXQgdGV4dCA9IHN0YXRlLmRvYy50b1N0cmluZygpO1xuXG5cdC8vIGlnbm9yZSBcXCRcblx0dGV4dCA9IHRleHQucmVwbGFjZUFsbChcIlxcXFwkXCIsIFwiXFxcXFJcIik7XG5cblx0Y29uc3QgbGVmdCA9IHRleHQubGFzdEluZGV4T2YoXCIkXCIsIHBvcy0xKTtcblx0Y29uc3QgcmlnaHQgPSB0ZXh0LmluZGV4T2YoXCIkXCIsIHBvcyk7XG5cblx0aWYgKGxlZnQgPT09IC0xIHx8IHJpZ2h0ID09PSAtMSkgcmV0dXJuIG51bGw7XG5cblx0cmV0dXJuIHtzdGFydDogbGVmdCArIDEsIGVuZDogcmlnaHR9O1xufVxuXG4vKipcbiAqIEZpZ3VyZXMgb3V0IHdoZXJlIHRoaXMgY29kZWJsb2NrIHN0YXJ0cyBhbmQgd2hlcmUgaXQgZW5kcy5cbiAqXG4gKiAqKk5vdGU6KiogSWYgeW91IGludGVuZCB0byB1c2UgdGhpcyBkaXJlY3RseSwgY2hlY2sgb3V0IENvbnRleHQuZ2V0Qm91bmRzIGluc3RlYWQsIHdoaWNoIGNhY2hlcyBhbmQgYWxzbyB0YWtlcyBjYXJlIG9mIGNvZGVibG9jayBsYW5ndWFnZXMgd2hpY2ggc2hvdWxkIGJlaGF2ZSBsaWtlIG1hdGggbW9kZS5cbiAqL1xuY29uc3QgZ2V0Q29kZWJsb2NrQm91bmRzID0gKHN0YXRlOiBFZGl0b3JTdGF0ZSwgcG9zOiBudW1iZXIgPSBzdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tKTpCb3VuZHN8bnVsbCA9PiB7XG5cdGNvbnN0IHRyZWUgPSBzeW50YXhUcmVlKHN0YXRlKTtcblxuXHRsZXQgY3Vyc29yID0gdHJlZS5jdXJzb3JBdChwb3MsIC0xKTtcblx0Y29uc3QgYmxvY2tCZWdpbiA9IGVzY2FsYXRlVG9Ub2tlbihjdXJzb3IsIERpcmVjdGlvbi5CYWNrd2FyZCwgXCJIeXBlck1ELWNvZGVibG9jay1iZWdpblwiKTtcblxuXHRjdXJzb3IgPSB0cmVlLmN1cnNvckF0KHBvcywgLTEpO1xuXHRjb25zdCBibG9ja0VuZCA9IGVzY2FsYXRlVG9Ub2tlbihjdXJzb3IsIERpcmVjdGlvbi5Gb3J3YXJkLCBcIkh5cGVyTUQtY29kZWJsb2NrLWVuZFwiKTtcblx0aWYgKGJsb2NrQmVnaW4mJmJsb2NrRW5kKVxuXHRyZXR1cm4geyBzdGFydDogYmxvY2tCZWdpbi50byArIDEsIGVuZDogYmxvY2tFbmQuZnJvbSAtIDEgfTtcblx0cmV0dXJuIG51bGxcbn1cblxuY29uc3QgZmluZEZpcnN0Tm9uTmV3bGluZUJlZm9yZSA9IChzdGF0ZTogRWRpdG9yU3RhdGUsIHBvczogbnVtYmVyKTogbnVtYmVyID0+IHtcbiAgICBsZXQgY3VycmVudFBvcyA9IHBvcztcbiAgICB3aGlsZSAoY3VycmVudFBvcyA+PSAwKSB7XG4gICAgICAgIGNvbnN0IGNoYXIgPSBnZXRDaGFyYWN0ZXJBdFBvcyhzdGF0ZSwgY3VycmVudFBvcy0xKTtcbiAgICAgICAgaWYgKGNoYXIgIT09IFwiXFxuXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBjdXJyZW50UG9zO1xuICAgICAgICB9XG4gICAgICAgIGN1cnJlbnRQb3MtLTtcbiAgICB9XG4gICAgcmV0dXJuIDA7XG59O1xuXG5jb25zdCBsYW5nSWZXaXRoaW5Db2RlYmxvY2sgPSAoc3RhdGU6IEVkaXRvclN0YXRlKTogc3RyaW5nIHwgbnVsbCA9PiB7XG5cdGNvbnN0IHRyZWUgPSBzeW50YXhUcmVlKHN0YXRlKTtcblxuXHRjb25zdCBwb3MgPSBzdGF0ZS5zZWxlY3Rpb24ucmFuZ2VzWzBdLmZyb207XG5cblxuXHRjb25zdCBhZGp1c3RlZFBvcyA9cG9zID09PSAwID8gMCA6IGZpbmRGaXJzdE5vbk5ld2xpbmVCZWZvcmUoc3RhdGUsIHBvcyk7XG5cdGNvbnN0IGN1cnNvciA9IHRyZWUuY3Vyc29yQXQoYWRqdXN0ZWRQb3MsIC0xKTtcblx0XG5cdGNvbnN0IGluQ29kZWJsb2NrID0gY3Vyc29yLm5hbWUuY29udGFpbnMoXCJjb2RlYmxvY2tcIik7XG5cdFxuXHRpZiAoIWluQ29kZWJsb2NrKSB7XG5cdFx0cmV0dXJuIG51bGw7XG5cdH1cblxuXHQvLyBsb2NhdGUgdGhlIHN0YXJ0IG9mIHRoZSBibG9ja1xuXHRjb25zdCBjb2RlYmxvY2tCZWdpbiA9IGVzY2FsYXRlVG9Ub2tlbihjdXJzb3IsIERpcmVjdGlvbi5CYWNrd2FyZCwgXCJIeXBlck1ELWNvZGVibG9ja19IeXBlck1ELWNvZGVibG9jay1iZWdpblwiKTtcblxuXHRpZiAoY29kZWJsb2NrQmVnaW4gPT0gbnVsbCkge1xuXHRcdGNvbnNvbGUud2FybihcInVuYWJsZSB0byBsb2NhdGUgc3RhcnQgb2YgdGhlIGNvZGVibG9jayBldmVuIHRob3VnaCBpbnNpZGUgb25lXCIpO1xuXHRcdHJldHVybiBcIlwiO1xuXHR9XG5cblx0Ly8gZXh0cmFjdCB0aGUgbGFuZ3VhZ2Vcblx0Ly8gY29kZWJsb2NrcyBtYXkgc3RhcnQgYW5kIGVuZCB3aXRoIGFuIGFyYml0cmFyeSBudW1iZXIgb2YgYmFja3RpY2tzXG5cdGNvbnN0IGxhbmd1YWdlID0gc3RhdGUuc2xpY2VEb2MoY29kZWJsb2NrQmVnaW4uZnJvbSwgY29kZWJsb2NrQmVnaW4udG8pLnJlcGxhY2UoL2ArLywgXCJcIik7XG5cblx0cmV0dXJuIGxhbmd1YWdlO1xufVxuIl19