import { Direction, escalateToToken, findLine, findMatchingBracket, getCharacterAtPos, getCloseBracket } from "src/utils/editor_utils";
import { Mode } from "../snippets/options";
import { getLatexSuiteConfig } from "../snippets/codemirror/config";
import { syntaxTree } from "@codemirror/language";
export class Context {
    state;
    mode;
    pos;
    ranges;
    codeblockLanguage;
    boundsCache;
    static fromState(state) {
        const ctx = new Context();
        const sel = state.selection;
        ctx.state = state;
        ctx.pos = sel.main.to;
        ctx.ranges = Array.from(sel.ranges).reverse();
        ctx.mode = new Mode();
        ctx.boundsCache = new Map();
        const codeblockLanguage = langIfWithinCodeblock(state);
        const inCode = codeblockLanguage !== null;
        const settings = getLatexSuiteConfig(state);
        const forceMath = codeblockLanguage ? settings.forceMathLanguages.contains(codeblockLanguage) : false;
        ctx.mode.codeMath = forceMath;
        ctx.mode.code = inCode && !forceMath;
        if (ctx.mode.code && codeblockLanguage)
            ctx.codeblockLanguage = codeblockLanguage;
        // first, check if math mode should be "generally" on
        const inMath = forceMath || isWithinEquation(state);
        if (inMath && !forceMath) {
            const inInlineEquation = isWithinInlineEquation(state);
            ctx.mode.blockMath = !inInlineEquation;
            ctx.mode.inlineMath = inInlineEquation;
        }
        if (inMath) {
            ctx.mode.textEnv = ctx.inTextEnvironment();
        }
        ctx.mode.text = !inCode && !inMath;
        return ctx;
    }
    static fromView(view) {
        return Context.fromState(view.state);
    }
    shouldTranslate() {
        const lengToTranslate = ['tikz'];
        return this.mode.isntInText() && (!this.mode.code || lengToTranslate.contains(this.codeblockLanguage));
    }
    isWithinEnvironment(pos, env) {
        if (!this.mode.inMath())
            return false;
        const bounds = this.getInnerBounds();
        if (!bounds)
            return false;
        const { start, end } = bounds;
        const text = this.state.sliceDoc(start, end);
        // pos referred to the absolute position in the whole document, but we just sliced the text
        // so now pos must be relative to the start in order to be any useful
        pos -= start;
        const openBracket = env.openSymbol.slice(-1);
        const closeBracket = getCloseBracket(openBracket);
        // Take care when the open symbol ends with a bracket {, [, or (
        // as then the closing symbol, }, ] or ), is not unique to this open symbol
        let offset;
        let openSearchSymbol;
        if (["{", "[", "("].contains(openBracket) && env.closeSymbol === closeBracket) {
            offset = env.openSymbol.length - 1;
            openSearchSymbol = openBracket;
        }
        else {
            offset = 0;
            openSearchSymbol = env.openSymbol;
        }
        let left = text.lastIndexOf(env.openSymbol, pos - 1);
        while (left != -1) {
            const right = findMatchingBracket(text, left + offset, openSearchSymbol, env.closeSymbol, false);
            if (right === -1)
                return false;
            // Check whether the cursor lies inside the environment symbols
            if ((right >= pos) && (pos >= left + env.openSymbol.length)) {
                return true;
            }
            if (left <= 0)
                return false;
            // Find the next open symbol
            left = text.lastIndexOf(env.openSymbol, left - 1);
        }
        return false;
    }
    inTextEnvironment() {
        return (this.isWithinEnvironment(this.pos, { openSymbol: "\\text{", closeSymbol: "}" }) ||
            this.isWithinEnvironment(this.pos, { openSymbol: "\\tag{", closeSymbol: "}" }) ||
            this.isWithinEnvironment(this.pos, { openSymbol: "\\begin{", closeSymbol: "}" }) ||
            this.isWithinEnvironment(this.pos, { openSymbol: "\\end{", closeSymbol: "}" }));
    }
    getBounds(pos = this.pos) {
        // yes, I also want the cache to work over the produced range instead of just that one through
        // a BTree or the like, but that'd be probably overkill
        if (this.boundsCache.has(pos)) {
            return this.boundsCache.get(pos) || null;
        }
        let bounds;
        if (this.mode.code) {
            // means a codeblock language triggered the math mode -> use the codeblock bounds instead
            bounds = getCodeblockBounds(this.state, pos);
        }
        else {
            bounds = getEquationBounds(this.state);
        }
        if (bounds)
            this.boundsCache.set(pos, bounds);
        return bounds;
    }
    // Accounts for equations within text environments, e.g. $$\text{... $...$}$$
    getInnerBounds(pos = this.pos) {
        let bounds;
        if (this.mode.code) {
            // means a codeblock language triggered the math mode -> use the codeblock bounds instead
            bounds = getCodeblockBounds(this.state, pos);
        }
        else {
            bounds = getInnerEquationBounds(this.state);
        }
        return bounds;
    }
}
const isWithinEquation = (state) => {
    const pos = state.selection.main.to;
    const tree = syntaxTree(state);
    let syntaxNode = tree.resolveInner(pos, -1);
    if (syntaxNode.name.contains("math-end"))
        return false;
    if (!syntaxNode.parent) {
        syntaxNode = tree.resolveInner(pos, 1);
        if (syntaxNode.name.contains("math-begin"))
            return false;
    }
    // Account/allow for being on an empty line in a equation
    if (!syntaxNode.parent) {
        const left = tree.resolveInner(pos - 1, -1);
        const right = tree.resolveInner(pos + 1, 1);
        return (left.name.contains("math") && right.name.contains("math") && !(left.name.contains("math-end")));
    }
    return (syntaxNode.name.contains("math"));
};
const isWithinInlineEquation = (state) => {
    const pos = state.selection.main.to;
    const tree = syntaxTree(state);
    let syntaxNode = tree.resolveInner(pos, -1);
    if (syntaxNode.name.contains("math-end"))
        return false;
    if (!syntaxNode.parent) {
        syntaxNode = tree.resolveInner(pos, 1);
        if (syntaxNode.name.contains("math-begin"))
            return false;
    }
    // Account/allow for being on an empty line in a equation
    if (!syntaxNode.parent)
        syntaxNode = tree.resolveInner(pos - 1, -1);
    const cursor = syntaxNode.cursor();
    const res = escalateToToken(cursor, Direction.Backward, "math-begin");
    return !res?.name.contains("math-block");
};
/**
 * Figures out where this equation starts and where it ends.
 *
 * **Note:** If you intend to use this directly, check out Context.getBounds instead, which caches and also takes care of codeblock languages which should behave like math mode.
 */
export const getEquationBounds = (state, pos) => {
    if (!pos)
        pos = state.selection.main.to;
    const tree = syntaxTree(state);
    let syntaxNode = tree.resolveInner(pos, -1);
    if (!syntaxNode.parent) {
        syntaxNode = tree.resolveInner(pos, 1);
    }
    // Account/allow for being on an empty line in a equation
    if (!syntaxNode.parent)
        syntaxNode = tree.resolveInner(pos - 1, -1);
    const cursor = syntaxNode.cursor();
    const begin = escalateToToken(cursor, Direction.Backward, "math-begin");
    const end = escalateToToken(cursor, Direction.Forward, "math-end");
    if (begin && end) {
        return { start: begin.to, end: end.from };
    }
    else {
        return null;
    }
};
// Accounts for equations within text environments, e.g. $$\text{... $...$}$$
const getInnerEquationBounds = (state, pos) => {
    if (!pos)
        pos = state.selection.main.to;
    let text = state.doc.toString();
    // ignore \$
    text = text.replaceAll("\\$", "\\R");
    const left = text.lastIndexOf("$", pos - 1);
    const right = text.indexOf("$", pos);
    if (left === -1 || right === -1)
        return null;
    return { start: left + 1, end: right };
};
export const getHtmlBounds = (state, pos = state.selection.main.from) => {
    state = fixState(state);
    const tree = syntaxTree(state);
    let cursor = tree.cursorAt(pos, -1);
    const blockBegin = escalateToToken(cursor, Direction.Backward, "html-begin");
    cursor = tree.cursorAt(pos, -1);
    const blockEnd = escalateToToken(cursor, Direction.Forward, "html-end");
    if (blockBegin && blockEnd)
        return { start: blockBegin.from, end: blockEnd.to };
    if (blockBegin && !blockEnd)
        return { start: blockBegin.from, end: state.doc.length };
    return null;
};
/**
 * Figures out where this codeblock starts and where it ends.
 *
 * **Note:** If you intend to use this directly, check out Context.getBounds instead, which caches and also takes care of codeblock languages which should behave like math mode.
 */
const getCodeblockBounds = (state, pos = state.selection.main.from) => {
    state = fixState(state);
    const tree = syntaxTree(state);
    let cursor = tree.cursorAt(pos, -1);
    const blockBegin = escalateToToken(cursor, Direction.Backward, "HyperMD-codeblock-begin");
    cursor = tree.cursorAt(pos, -1);
    const blockEnd = escalateToToken(cursor, Direction.Forward, "HyperMD-codeblock-end");
    if (blockBegin && blockEnd)
        return { start: blockBegin.to + 1, end: blockEnd.from - 1 };
    return null;
};
const fixState = (state) => {
    if (syntaxTree(state).cursorAt(state.selection.main.from, -1).name === "Document") {
        state = state.update({
            changes: { from: state.selection.main.from, insert: "\u200B" }
        }).state;
    }
    return state;
};
const findFirstNonNewlineBefore = (state, pos) => {
    let currentPos = pos;
    while (currentPos >= 0) {
        const char = getCharacterAtPos(state, currentPos - 1);
        if (char !== "\n") {
            return currentPos;
        }
        currentPos--;
    }
    return 0;
};
//The position I get has.to be.at least one line.before the head of the code block
const langIfWithinCodeblock = (state) => {
    const tree = syntaxTree(state);
    const pos = state.selection.ranges[0].from;
    const adjustedPos = pos === 0 ? 0 : findFirstNonNewlineBefore(state, pos);
    const cursor = tree.cursorAt(adjustedPos, -1);
    const inCodeblock = cursor.name.contains("codeblock");
    if (!inCodeblock)
        return null;
    // locate the start of the block
    const codeblockBegin = findLine(state, state.doc.lineAt(pos).number, Direction.Backward, /^\`\`\`/);
    if (codeblockBegin == null) {
        console.warn("unable to locate start of the codeblock even though inside one");
        return "";
    }
    // extract the language
    // codeblocks may start and end with an arbitrary number of backticks
    const language = codeblockBegin.text.replace(/`+/, "");
    return language;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGV4dC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy91dGlscy9jb250ZXh0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUFFLFFBQVEsRUFBRSxtQkFBbUIsRUFBRSxpQkFBaUIsRUFBRSxlQUFlLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUN2SSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFFM0MsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDcEUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBUWxELE1BQU0sT0FBTyxPQUFPO0lBQ25CLEtBQUssQ0FBYztJQUNuQixJQUFJLENBQVE7SUFDWixHQUFHLENBQVM7SUFDWixNQUFNLENBQW1CO0lBQ3pCLGlCQUFpQixDQUFTO0lBQzFCLFdBQVcsQ0FBc0I7SUFFakMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxLQUFrQjtRQUNsQyxNQUFNLEdBQUcsR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQzFCLE1BQU0sR0FBRyxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUM7UUFDNUIsR0FBRyxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDbEIsR0FBRyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztRQUN0QixHQUFHLENBQUMsTUFBTSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO1FBQzlDLEdBQUcsQ0FBQyxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztRQUN0QixHQUFHLENBQUMsV0FBVyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFFNUIsTUFBTSxpQkFBaUIsR0FBRyxxQkFBcUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2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QUFxRTtJQUNyRSxNQUFNLFFBQVEsR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdkQsT0FBTyxRQUFRLENBQUM7QUFDakIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yU3RhdGUsIFNlbGVjdGlvblJhbmdlIH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XG5pbXBvcnQgeyBFZGl0b3JWaWV3IH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcbmltcG9ydCB7IERpcmVjdGlvbiwgZXNjYWxhdGVUb1Rva2VuLCBmaW5kTGluZSwgZmluZE1hdGNoaW5nQnJhY2tldCwgZ2V0Q2hhcmFjdGVyQXRQb3MsIGdldENsb3NlQnJhY2tldCB9IGZyb20gXCJzcmMvdXRpbHMvZWRpdG9yX3V0aWxzXCI7XG5pbXBvcnQgeyBNb2RlIH0gZnJvbSBcIi4uL3NuaXBwZXRzL29wdGlvbnNcIjtcbmltcG9ydCB7IEVudmlyb25tZW50IH0gZnJvbSBcIi4uL3NuaXBwZXRzL2Vudmlyb25tZW50XCI7XG5pbXBvcnQgeyBnZXRMYXRleFN1aXRlQ29uZmlnIH0gZnJvbSBcIi4uL3NuaXBwZXRzL2NvZGVtaXJyb3IvY29uZmlnXCI7XG5pbXBvcnQgeyBzeW50YXhUcmVlIH0gZnJvbSBcIkBjb2RlbWlycm9yL2xhbmd1YWdlXCI7XG5pbXBvcnQgeyBxdWV1ZVNuaXBwZXQgfSBmcm9tIFwic3JjL3NuaXBwZXRzL2NvZGVtaXJyb3Ivc25pcHBldF9xdWV1ZV9zdGF0ZV9maWVsZFwiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEJvdW5kcyB7XG5cdHN0YXJ0OiBudW1iZXI7XG5cdGVuZDogbnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgQ29udGV4dCB7XG5cdHN0YXRlOiBFZGl0b3JTdGF0ZTtcblx0bW9kZSE6IE1vZGU7XG5cdHBvczogbnVtYmVyO1xuXHRyYW5nZXM6IFNlbGVjdGlvblJhbmdlW107XG5cdGNvZGVibG9ja0xhbmd1YWdlOiBzdHJpbmc7XG5cdGJvdW5kc0NhY2hlOiBNYXA8bnVtYmVyLCBCb3VuZHM+O1xuXG5cdHN0YXRpYyBmcm9tU3RhdGUoc3RhdGU6IEVkaXRvclN0YXRlKTpDb250ZXh0IHtcblx0XHRjb25zdCBjdHggPSBuZXcgQ29udGV4dCgpO1xuXHRcdGNvbnN0IHNlbCA9IHN0YXRlLnNlbGVjdGlvbjtcblx0XHRjdHguc3RhdGUgPSBzdGF0ZTtcblx0XHRjdHgucG9zID0gc2VsLm1haW4udG87XG5cdFx0Y3R4LnJhbmdlcyA9IEFycmF5LmZyb20oc2VsLnJhbmdlcykucmV2ZXJzZSgpO1xuXHRcdGN0eC5tb2RlID0gbmV3IE1vZGUoKTtcblx0XHRjdHguYm91bmRzQ2FjaGUgPSBuZXcgTWFwKCk7XG5cblx0XHRjb25zdCBjb2RlYmxvY2tMYW5ndWFnZSA9IGxhbmdJZldpdGhpbkNvZGVibG9jayhzdGF0ZSk7XG5cdFx0Y29uc3QgaW5Db2RlID0gY29kZWJsb2NrTGFuZ3VhZ2UgIT09IG51bGw7XG5cdFx0Y29uc3Qgc2V0dGluZ3MgPSBnZXRMYXRleFN1aXRlQ29uZmlnKHN0YXRlKTtcblx0XHRjb25zdCBmb3JjZU1hdGggPSBjb2RlYmxvY2tMYW5ndWFnZT9zZXR0aW5ncy5mb3JjZU1hdGhMYW5ndWFnZXMuY29udGFpbnMoY29kZWJsb2NrTGFuZ3VhZ2UpOmZhbHNlO1xuXHRcdGN0eC5tb2RlLmNvZGVNYXRoID0gZm9yY2VNYXRoO1xuXHRcdGN0eC5tb2RlLmNvZGUgPSBpbkNvZGUgJiYgIWZvcmNlTWF0aDtcblx0XHRpZiAoY3R4Lm1vZGUuY29kZSYmY29kZWJsb2NrTGFuZ3VhZ2UpIGN0eC5jb2RlYmxvY2tMYW5ndWFnZSA9IGNvZGVibG9ja0xhbmd1YWdlO1xuXHRcdFxuXHRcdC8vIGZpcnN0LCBjaGVjayBpZiBtYXRoIG1vZGUgc2hvdWxkIGJlIFwiZ2VuZXJhbGx5XCIgb25cblx0XHRjb25zdCBpbk1hdGggPSBmb3JjZU1hdGggfHwgaXNXaXRoaW5FcXVhdGlvbihzdGF0ZSk7XG5cblx0XHRpZiAoaW5NYXRoICYmICFmb3JjZU1hdGgpIHtcblx0XHRcdGNvbnN0IGluSW5saW5lRXF1YXRpb24gPSBpc1dpdGhpbklubGluZUVxdWF0aW9uKHN0YXRlKTtcblxuXHRcdFx0Y3R4Lm1vZGUuYmxvY2tNYXRoID0gIWluSW5saW5lRXF1YXRpb247XG5cdFx0XHRjdHgubW9kZS5pbmxpbmVNYXRoID0gaW5JbmxpbmVFcXVhdGlvbjtcblx0XHR9XG5cblx0XHRpZiAoaW5NYXRoKSB7XG5cdFx0XHRjdHgubW9kZS50ZXh0RW52ID0gY3R4LmluVGV4dEVudmlyb25tZW50KCk7XG5cdFx0fVxuXG5cdFx0Y3R4Lm1vZGUudGV4dCA9ICFpbkNvZGUgJiYgIWluTWF0aDtcblxuXHRcdHJldHVybiBjdHg7XG5cdH1cblxuXHRzdGF0aWMgZnJvbVZpZXcodmlldzogRWRpdG9yVmlldyk6Q29udGV4dCB7XG5cdFx0cmV0dXJuIENvbnRleHQuZnJvbVN0YXRlKHZpZXcuc3RhdGUpO1xuXHR9XG5cdHNob3VsZFRyYW5zbGF0ZSgpe1xuXHRcdGNvbnN0IGxlbmdUb1RyYW5zbGF0ZT0gWyd0aWt6J11cblx0XHRcblx0XHRyZXR1cm4gdGhpcy5tb2RlLmlzbnRJblRleHQoKSYmKCF0aGlzLm1vZGUuY29kZXx8bGVuZ1RvVHJhbnNsYXRlLmNvbnRhaW5zKHRoaXMuY29kZWJsb2NrTGFuZ3VhZ2UpKVxuXHR9XG5cdGlzV2l0aGluRW52aXJvbm1lbnQocG9zOiBudW1iZXIsIGVudjogRW52aXJvbm1lbnQpOiBib29sZWFuIHtcblx0XHRpZiAoIXRoaXMubW9kZS5pbk1hdGgoKSkgcmV0dXJuIGZhbHNlO1xuXG5cdFx0Y29uc3QgYm91bmRzID0gdGhpcy5nZXRJbm5lckJvdW5kcygpO1xuXHRcdGlmICghYm91bmRzKSByZXR1cm4gZmFsc2U7XG5cblx0XHRjb25zdCB7c3RhcnQsIGVuZH0gPSBib3VuZHM7XG5cdFx0Y29uc3QgdGV4dCA9IHRoaXMuc3RhdGUuc2xpY2VEb2Moc3RhcnQsIGVuZCk7XG5cdFx0Ly8gcG9zIHJlZmVycmVkIHRvIHRoZSBhYnNvbHV0ZSBwb3NpdGlvbiBpbiB0aGUgd2hvbGUgZG9jdW1lbnQsIGJ1dCB3ZSBqdXN0IHNsaWNlZCB0aGUgdGV4dFxuXHRcdC8vIHNvIG5vdyBwb3MgbXVzdCBiZSByZWxhdGl2ZSB0byB0aGUgc3RhcnQgaW4gb3JkZXIgdG8gYmUgYW55IHVzZWZ1bFxuXHRcdHBvcyAtPSBzdGFydDtcblxuXHRcdGNvbnN0IG9wZW5CcmFja2V0ID0gZW52Lm9wZW5TeW1ib2wuc2xpY2UoLTEpO1xuXHRcdGNvbnN0IGNsb3NlQnJhY2tldCA9IGdldENsb3NlQnJhY2tldChvcGVuQnJhY2tldCk7XG5cblx0XHQvLyBUYWtlIGNhcmUgd2hlbiB0aGUgb3BlbiBzeW1ib2wgZW5kcyB3aXRoIGEgYnJhY2tldCB7LCBbLCBvciAoXG5cdFx0Ly8gYXMgdGhlbiB0aGUgY2xvc2luZyBzeW1ib2wsIH0sIF0gb3IgKSwgaXMgbm90IHVuaXF1ZSB0byB0aGlzIG9wZW4gc3ltYm9sXG5cdFx0bGV0IG9mZnNldDtcblx0XHRsZXQgb3BlblNlYXJjaFN5bWJvbDtcblxuXHRcdGlmIChbXCJ7XCIsIFwiW1wiLCBcIihcIl0uY29udGFpbnMob3BlbkJyYWNrZXQpICYmIGVudi5jbG9zZVN5bWJvbCA9PT0gY2xvc2VCcmFja2V0KSB7XG5cdFx0XHRvZmZzZXQgPSBlbnYub3BlblN5bWJvbC5sZW5ndGggLSAxO1xuXHRcdFx0b3BlblNlYXJjaFN5bWJvbCA9IG9wZW5CcmFja2V0O1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRvZmZzZXQgPSAwO1xuXHRcdFx0b3BlblNlYXJjaFN5bWJvbCA9IGVudi5vcGVuU3ltYm9sO1xuXHRcdH1cblxuXHRcdGxldCBsZWZ0ID0gdGV4dC5sYXN0SW5kZXhPZihlbnYub3BlblN5bWJvbCwgcG9zIC0gMSk7XG5cblx0XHR3aGlsZSAobGVmdCAhPSAtMSkge1xuXHRcdFx0Y29uc3QgcmlnaHQgPSBmaW5kTWF0Y2hpbmdCcmFja2V0KHRleHQsIGxlZnQgKyBvZmZzZXQsIG9wZW5TZWFyY2hTeW1ib2wsIGVudi5jbG9zZVN5bWJvbCwgZmFsc2UpO1xuXG5cdFx0XHRpZiAocmlnaHQgPT09IC0xKSByZXR1cm4gZmFsc2U7XG5cblx0XHRcdC8vIENoZWNrIHdoZXRoZXIgdGhlIGN1cnNvciBsaWVzIGluc2lkZSB0aGUgZW52aXJvbm1lbnQgc3ltYm9sc1xuXHRcdFx0aWYgKChyaWdodCA+PSBwb3MpICYmIChwb3MgPj0gbGVmdCArIGVudi5vcGVuU3ltYm9sLmxlbmd0aCkpIHtcblx0XHRcdFx0cmV0dXJuIHRydWU7XG5cdFx0XHR9XG5cblx0XHRcdGlmIChsZWZ0IDw9IDApIHJldHVybiBmYWxzZTtcblxuXHRcdFx0Ly8gRmluZCB0aGUgbmV4dCBvcGVuIHN5bWJvbFxuXHRcdFx0bGVmdCA9IHRleHQubGFzdEluZGV4T2YoZW52Lm9wZW5TeW1ib2wsIGxlZnQgLSAxKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gZmFsc2U7XG5cdH1cblxuXHRpblRleHRFbnZpcm9ubWVudCgpOiBib29sZWFuIHtcblx0XHRyZXR1cm4gKFxuXHRcdFx0dGhpcy5pc1dpdGhpbkVudmlyb25tZW50KHRoaXMucG9zLCB7b3BlblN5bWJvbDogXCJcXFxcdGV4dHtcIiwgY2xvc2VTeW1ib2w6IFwifVwifSkgfHxcblx0XHRcdHRoaXMuaXNXaXRoaW5FbnZpcm9ubWVudCh0aGlzLnBvcywge29wZW5TeW1ib2w6IFwiXFxcXHRhZ3tcIiwgY2xvc2VTeW1ib2w6IFwifVwifSkgfHxcblx0XHRcdHRoaXMuaXNXaXRoaW5FbnZpcm9ubWVudCh0aGlzLnBvcywge29wZW5TeW1ib2w6IFwiXFxcXGJlZ2lue1wiLCBjbG9zZVN5bWJvbDogXCJ9XCJ9KSB8fFxuXHRcdFx0dGhpcy5pc1dpdGhpbkVudmlyb25tZW50KHRoaXMucG9zLCB7b3BlblN5bWJvbDogXCJcXFxcZW5ke1wiLCBjbG9zZVN5bWJvbDogXCJ9XCJ9KVxuXHRcdCk7XG5cdH1cblxuXHRnZXRCb3VuZHMocG9zOiBudW1iZXIgPSB0aGlzLnBvcyk6IEJvdW5kc3xudWxsIHtcblx0XHQvLyB5ZXMsIEkgYWxzbyB3YW50IHRoZSBjYWNoZSB0byB3b3JrIG92ZXIgdGhlIHByb2R1Y2VkIHJhbmdlIGluc3RlYWQgb2YganVzdCB0aGF0IG9uZSB0aHJvdWdoXG5cdFx0Ly8gYSBCVHJlZSBvciB0aGUgbGlrZSwgYnV0IHRoYXQnZCBiZSBwcm9iYWJseSBvdmVya2lsbFxuXHRcdGlmICh0aGlzLmJvdW5kc0NhY2hlLmhhcyhwb3MpKSB7XG5cdFx0XHRyZXR1cm4gdGhpcy5ib3VuZHNDYWNoZS5nZXQocG9zKXx8bnVsbDtcblx0XHR9XG5cblx0XHRsZXQgYm91bmRzO1xuXHRcdGlmICh0aGlzLm1vZGUuY29kZSkge1xuXHRcdFx0Ly8gbWVhbnMgYSBjb2RlYmxvY2sgbGFuZ3VhZ2UgdHJpZ2dlcmVkIHRoZSBtYXRoIG1vZGUgLT4gdXNlIHRoZSBjb2RlYmxvY2sgYm91bmRzIGluc3RlYWRcblx0XHRcdGJvdW5kcyA9IGdldENvZGVibG9ja0JvdW5kcyh0aGlzLnN0YXRlLCBwb3MpO1xuXHRcdH0gZWxzZSB7XG5cdFx0XHRib3VuZHMgPSBnZXRFcXVhdGlvbkJvdW5kcyh0aGlzLnN0YXRlKTtcblx0XHR9XG5cdFx0aWYoYm91bmRzKVxuXHRcdHRoaXMuYm91bmRzQ2FjaGUuc2V0KHBvcywgYm91bmRzKTtcblx0XHRyZXR1cm4gYm91bmRzO1xuXHR9XG5cblx0Ly8gQWNjb3VudHMgZm9yIGVxdWF0aW9ucyB3aXRoaW4gdGV4dCBlbnZpcm9ubWVudHMsIGUuZy4gJCRcXHRleHR7Li4uICQuLi4kfSQkXG5cdGdldElubmVyQm91bmRzKHBvczogbnVtYmVyID0gdGhpcy5wb3MpOiBCb3VuZHN8bnVsbCB7XG5cdFx0bGV0IGJvdW5kcztcblx0XHRpZiAodGhpcy5tb2RlLmNvZGUpIHtcblx0XHRcdC8vIG1lYW5zIGEgY29kZWJsb2NrIGxhbmd1YWdlIHRyaWdnZXJlZCB0aGUgbWF0aCBtb2RlIC0+IHVzZSB0aGUgY29kZWJsb2NrIGJvdW5kcyBpbnN0ZWFkXG5cdFx0XHRib3VuZHMgPSBnZXRDb2RlYmxvY2tCb3VuZHModGhpcy5zdGF0ZSwgcG9zKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0Ym91bmRzID0gZ2V0SW5uZXJFcXVhdGlvbkJvdW5kcyh0aGlzLnN0YXRlKTtcblx0XHR9XG5cblx0XHRyZXR1cm4gYm91bmRzO1xuXHR9XG5cbn1cblxuY29uc3QgaXNXaXRoaW5FcXVhdGlvbiA9IChzdGF0ZTogRWRpdG9yU3RhdGUpOmJvb2xlYW4gPT4ge1xuXHRjb25zdCBwb3MgPSBzdGF0ZS5zZWxlY3Rpb24ubWFpbi50bztcblx0Y29uc3QgdHJlZSA9IHN5bnRheFRyZWUoc3RhdGUpO1xuXG5cdGxldCBzeW50YXhOb2RlID0gdHJlZS5yZXNvbHZlSW5uZXIocG9zLCAtMSk7XG5cdGlmIChzeW50YXhOb2RlLm5hbWUuY29udGFpbnMoXCJtYXRoLWVuZFwiKSkgcmV0dXJuIGZhbHNlO1xuXG5cdGlmICghc3ludGF4Tm9kZS5wYXJlbnQpIHtcblx0XHRzeW50YXhOb2RlID0gdHJlZS5yZXNvbHZlSW5uZXIocG9zLCAxKTtcblx0XHRpZiAoc3ludGF4Tm9kZS5uYW1lLmNvbnRhaW5zKFwibWF0aC1iZWdpblwiKSkgcmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0Ly8gQWNjb3VudC9hbGxvdyBmb3IgYmVpbmcgb24gYW4gZW1wdHkgbGluZSBpbiBhIGVxdWF0aW9uXG5cdGlmICghc3ludGF4Tm9kZS5wYXJlbnQpIHtcblx0XHRjb25zdCBsZWZ0ID0gdHJlZS5yZXNvbHZlSW5uZXIocG9zIC0gMSwgLTEpO1xuXHRcdGNvbnN0IHJpZ2h0ID0gdHJlZS5yZXNvbHZlSW5uZXIocG9zICsgMSwgMSk7XG5cblx0XHRyZXR1cm4gKGxlZnQubmFtZS5jb250YWlucyhcIm1hdGhcIikgJiYgcmlnaHQubmFtZS5jb250YWlucyhcIm1hdGhcIikgJiYgIShsZWZ0Lm5hbWUuY29udGFpbnMoXCJtYXRoLWVuZFwiKSkpO1xuXHR9XG5cblx0cmV0dXJuIChzeW50YXhOb2RlLm5hbWUuY29udGFpbnMoXCJtYXRoXCIpKTtcbn1cblxuY29uc3QgaXNXaXRoaW5JbmxpbmVFcXVhdGlvbiA9IChzdGF0ZTogRWRpdG9yU3RhdGUpOmJvb2xlYW4gPT4ge1xuXHRjb25zdCBwb3MgPSBzdGF0ZS5zZWxlY3Rpb24ubWFpbi50bztcblx0Y29uc3QgdHJlZSA9IHN5bnRheFRyZWUoc3RhdGUpO1xuXG5cdGxldCBzeW50YXhOb2RlID0gdHJlZS5yZXNvbHZlSW5uZXIocG9zLCAtMSk7XG5cdGlmIChzeW50YXhOb2RlLm5hbWUuY29udGFpbnMoXCJtYXRoLWVuZFwiKSkgcmV0dXJuIGZhbHNlO1xuXG5cdGlmICghc3ludGF4Tm9kZS5wYXJlbnQpIHtcblx0XHRzeW50YXhOb2RlID0gdHJlZS5yZXNvbHZlSW5uZXIocG9zLCAxKTtcblx0XHRpZiAoc3ludGF4Tm9kZS5uYW1lLmNvbnRhaW5zKFwibWF0aC1iZWdpblwiKSkgcmV0dXJuIGZhbHNlO1xuXHR9XG5cblx0Ly8gQWNjb3VudC9hbGxvdyBmb3IgYmVpbmcgb24gYW4gZW1wdHkgbGluZSBpbiBhIGVxdWF0aW9uXG5cdGlmICghc3ludGF4Tm9kZS5wYXJlbnQpIHN5bnRheE5vZGUgPSB0cmVlLnJlc29sdmVJbm5lcihwb3MgLSAxLCAtMSk7XG5cblx0Y29uc3QgY3Vyc29yID0gc3ludGF4Tm9kZS5jdXJzb3IoKTtcblx0Y29uc3QgcmVzID0gZXNjYWxhdGVUb1Rva2VuKGN1cnNvciwgRGlyZWN0aW9uLkJhY2t3YXJkLCBcIm1hdGgtYmVnaW5cIik7XG5cblx0cmV0dXJuICFyZXM/Lm5hbWUuY29udGFpbnMoXCJtYXRoLWJsb2NrXCIpO1xufVxuXG4vKipcbiAqIEZpZ3VyZXMgb3V0IHdoZXJlIHRoaXMgZXF1YXRpb24gc3RhcnRzIGFuZCB3aGVyZSBpdCBlbmRzLlxuICpcbiAqICoqTm90ZToqKiBJZiB5b3UgaW50ZW5kIHRvIHVzZSB0aGlzIGRpcmVjdGx5LCBjaGVjayBvdXQgQ29udGV4dC5nZXRCb3VuZHMgaW5zdGVhZCwgd2hpY2ggY2FjaGVzIGFuZCBhbHNvIHRha2VzIGNhcmUgb2YgY29kZWJsb2NrIGxhbmd1YWdlcyB3aGljaCBzaG91bGQgYmVoYXZlIGxpa2UgbWF0aCBtb2RlLlxuICovXG5leHBvcnQgY29uc3QgZ2V0RXF1YXRpb25Cb3VuZHMgPSAoc3RhdGU6IEVkaXRvclN0YXRlLCBwb3M/OiBudW1iZXIpOkJvdW5kc3xudWxsID0+IHtcblx0aWYgKCFwb3MpIHBvcyA9IHN0YXRlLnNlbGVjdGlvbi5tYWluLnRvO1xuXHRjb25zdCB0cmVlID0gc3ludGF4VHJlZShzdGF0ZSk7XG5cblx0bGV0IHN5bnRheE5vZGUgPSB0cmVlLnJlc29sdmVJbm5lcihwb3MsIC0xKTtcblxuXHRpZiAoIXN5bnRheE5vZGUucGFyZW50KSB7XG5cdFx0c3ludGF4Tm9kZSA9IHRyZWUucmVzb2x2ZUlubmVyKHBvcywgMSk7XG5cdH1cblxuXHQvLyBBY2NvdW50L2FsbG93IGZvciBiZWluZyBvbiBhbiBlbXB0eSBsaW5lIGluIGEgZXF1YXRpb25cblx0aWYgKCFzeW50YXhOb2RlLnBhcmVudCkgc3ludGF4Tm9kZSA9IHRyZWUucmVzb2x2ZUlubmVyKHBvcyAtIDEsIC0xKTtcblxuXHRjb25zdCBjdXJzb3IgPSBzeW50YXhOb2RlLmN1cnNvcigpO1xuXHRjb25zdCBiZWdpbiA9IGVzY2FsYXRlVG9Ub2tlbihjdXJzb3IsIERpcmVjdGlvbi5CYWNrd2FyZCwgXCJtYXRoLWJlZ2luXCIpO1xuXHRjb25zdCBlbmQgPSBlc2NhbGF0ZVRvVG9rZW4oY3Vyc29yLCBEaXJlY3Rpb24uRm9yd2FyZCwgXCJtYXRoLWVuZFwiKTtcblxuXHRpZiAoYmVnaW4gJiYgZW5kKSB7XG5cdFx0cmV0dXJuIHtzdGFydDogYmVnaW4udG8sIGVuZDogZW5kLmZyb219O1xuXHR9XG5cdGVsc2Uge1xuXHRcdHJldHVybiBudWxsO1xuXHR9XG59XG5cbi8vIEFjY291bnRzIGZvciBlcXVhdGlvbnMgd2l0aGluIHRleHQgZW52aXJvbm1lbnRzLCBlLmcuICQkXFx0ZXh0ey4uLiAkLi4uJH0kJFxuY29uc3QgZ2V0SW5uZXJFcXVhdGlvbkJvdW5kcyA9IChzdGF0ZTogRWRpdG9yU3RhdGUsIHBvcz86IG51bWJlcik6Qm91bmRzfG51bGwgPT4ge1xuXHRpZiAoIXBvcykgcG9zID0gc3RhdGUuc2VsZWN0aW9uLm1haW4udG87XG5cdGxldCB0ZXh0ID0gc3RhdGUuZG9jLnRvU3RyaW5nKCk7XG5cblx0Ly8gaWdub3JlIFxcJFxuXHR0ZXh0ID0gdGV4dC5yZXBsYWNlQWxsKFwiXFxcXCRcIiwgXCJcXFxcUlwiKTtcblxuXHRjb25zdCBsZWZ0ID0gdGV4dC5sYXN0SW5kZXhPZihcIiRcIiwgcG9zLTEpO1xuXHRjb25zdCByaWdodCA9IHRleHQuaW5kZXhPZihcIiRcIiwgcG9zKTtcblxuXHRpZiAobGVmdCA9PT0gLTEgfHwgcmlnaHQgPT09IC0xKSByZXR1cm4gbnVsbDtcblxuXHRyZXR1cm4ge3N0YXJ0OiBsZWZ0ICsgMSwgZW5kOiByaWdodH07XG59XG5leHBvcnQgY29uc3QgZ2V0SHRtbEJvdW5kcz0gKHN0YXRlOiBFZGl0b3JTdGF0ZSwgcG9zOiBudW1iZXIgPSBzdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tKTpCb3VuZHN8bnVsbCA9PiB7XG5cdHN0YXRlPWZpeFN0YXRlKHN0YXRlKVxuXHRjb25zdCB0cmVlID0gc3ludGF4VHJlZShzdGF0ZSk7XG5cdGxldCBjdXJzb3IgPSB0cmVlLmN1cnNvckF0KHBvcywgLTEpO1xuXHRjb25zdCBibG9ja0JlZ2luID0gZXNjYWxhdGVUb1Rva2VuKGN1cnNvciwgRGlyZWN0aW9uLkJhY2t3YXJkLCBcImh0bWwtYmVnaW5cIik7XG5cblx0Y3Vyc29yID0gdHJlZS5jdXJzb3JBdChwb3MsIC0xKTtcblx0Y29uc3QgYmxvY2tFbmQgPSBlc2NhbGF0ZVRvVG9rZW4oY3Vyc29yLCBEaXJlY3Rpb24uRm9yd2FyZCwgXCJodG1sLWVuZFwiKTtcblx0aWYoYmxvY2tCZWdpbiYmYmxvY2tFbmQpXG5cdFx0cmV0dXJuIHsgc3RhcnQ6IGJsb2NrQmVnaW4uZnJvbSwgZW5kOiBibG9ja0VuZC50byB9O1xuXHRpZiAoYmxvY2tCZWdpbiYmIWJsb2NrRW5kKVxuXHRyZXR1cm4geyBzdGFydDogYmxvY2tCZWdpbi5mcm9tLCBlbmQ6IHN0YXRlLmRvYy5sZW5ndGggfTtcblx0cmV0dXJuIG51bGxcbn1cbi8qKlxuICogRmlndXJlcyBvdXQgd2hlcmUgdGhpcyBjb2RlYmxvY2sgc3RhcnRzIGFuZCB3aGVyZSBpdCBlbmRzLlxuICpcbiAqICoqTm90ZToqKiBJZiB5b3UgaW50ZW5kIHRvIHVzZSB0aGlzIGRpcmVjdGx5LCBjaGVjayBvdXQgQ29udGV4dC5nZXRCb3VuZHMgaW5zdGVhZCwgd2hpY2ggY2FjaGVzIGFuZCBhbHNvIHRha2VzIGNhcmUgb2YgY29kZWJsb2NrIGxhbmd1YWdlcyB3aGljaCBzaG91bGQgYmVoYXZlIGxpa2UgbWF0aCBtb2RlLlxuICovXG5jb25zdCBnZXRDb2RlYmxvY2tCb3VuZHMgPSAoc3RhdGU6IEVkaXRvclN0YXRlLCBwb3M6IG51bWJlciA9IHN0YXRlLnNlbGVjdGlvbi5tYWluLmZyb20pOkJvdW5kc3xudWxsID0+IHtcblx0c3RhdGU9Zml4U3RhdGUoc3RhdGUpXG5cdGNvbnN0IHRyZWUgPSBzeW50YXhUcmVlKHN0YXRlKTtcblxuXHRsZXQgY3Vyc29yID0gdHJlZS5jdXJzb3JBdChwb3MsIC0xKTtcblx0Y29uc3QgYmxvY2tCZWdpbiA9IGVzY2FsYXRlVG9Ub2tlbihjdXJzb3IsIERpcmVjdGlvbi5CYWNrd2FyZCwgXCJIeXBlck1ELWNvZGVibG9jay1iZWdpblwiKTtcblxuXHRjdXJzb3IgPSB0cmVlLmN1cnNvckF0KHBvcywgLTEpO1xuXHRjb25zdCBibG9ja0VuZCA9IGVzY2FsYXRlVG9Ub2tlbihjdXJzb3IsIERpcmVjdGlvbi5Gb3J3YXJkLCBcIkh5cGVyTUQtY29kZWJsb2NrLWVuZFwiKTtcblx0aWYgKGJsb2NrQmVnaW4mJmJsb2NrRW5kKVxuXHRyZXR1cm4geyBzdGFydDogYmxvY2tCZWdpbi50byArIDEsIGVuZDogYmxvY2tFbmQuZnJvbSAtIDEgfTtcblx0cmV0dXJuIG51bGxcbn1cbmNvbnN0IGZpeFN0YXRlPShzdGF0ZTpFZGl0b3JTdGF0ZSk9Pntcblx0aWYoc3ludGF4VHJlZShzdGF0ZSkuY3Vyc29yQXQoc3RhdGUuc2VsZWN0aW9uLm1haW4uZnJvbSwgLTEpLm5hbWUgPT09IFwiRG9jdW1lbnRcIil7XG5cdFx0c3RhdGUgPSBzdGF0ZS51cGRhdGUoe1xuXHRcdFx0Y2hhbmdlczogeyBmcm9tOiBzdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tLCBpbnNlcnQ6IFwiXFx1MjAwQlwiIH1cblx0XHQgIH0pLnN0YXRlO1xuXHR9XG5cdHJldHVybiBzdGF0ZVxufVxuY29uc3QgZmluZEZpcnN0Tm9uTmV3bGluZUJlZm9yZSA9IChzdGF0ZTogRWRpdG9yU3RhdGUsIHBvczogbnVtYmVyKTogbnVtYmVyID0+IHtcbiAgICBsZXQgY3VycmVudFBvcyA9IHBvcztcbiAgICB3aGlsZSAoY3VycmVudFBvcyA+PSAwKSB7XG4gICAgICAgIGNvbnN0IGNoYXIgPSBnZXRDaGFyYWN0ZXJBdFBvcyhzdGF0ZSwgY3VycmVudFBvcy0xKTtcbiAgICAgICAgaWYgKGNoYXIgIT09IFwiXFxuXCIpIHtcbiAgICAgICAgICAgIHJldHVybiBjdXJyZW50UG9zO1xuICAgICAgICB9XG4gICAgICAgIGN1cnJlbnRQb3MtLTtcbiAgICB9XG4gICAgcmV0dXJuIDA7XG59O1xuXG4vL1RoZSBwb3NpdGlvbiBJIGdldCBoYXMudG8gYmUuYXQgbGVhc3Qgb25lIGxpbmUuYmVmb3JlIHRoZSBoZWFkIG9mIHRoZSBjb2RlIGJsb2NrXG5jb25zdCBsYW5nSWZXaXRoaW5Db2RlYmxvY2sgPSAoc3RhdGU6IEVkaXRvclN0YXRlKTogc3RyaW5nIHwgbnVsbCA9PiB7XG5cdGNvbnN0IHRyZWUgPSBzeW50YXhUcmVlKHN0YXRlKTtcblxuXHRjb25zdCBwb3MgPSBzdGF0ZS5zZWxlY3Rpb24ucmFuZ2VzWzBdLmZyb207XG5cdFxuXG5cblx0Y29uc3QgYWRqdXN0ZWRQb3MgPXBvcyA9PT0gMCA/IDAgOiBmaW5kRmlyc3ROb25OZXdsaW5lQmVmb3JlKHN0YXRlLCBwb3MpO1xuXHRjb25zdCBjdXJzb3IgPSB0cmVlLmN1cnNvckF0KGFkanVzdGVkUG9zLCAtMSk7XG5cdGNvbnN0IGluQ29kZWJsb2NrID0gY3Vyc29yLm5hbWUuY29udGFpbnMoXCJjb2RlYmxvY2tcIik7XG5cdFxuXHRpZiAoIWluQ29kZWJsb2NrKSByZXR1cm4gbnVsbDtcblx0XG5cblx0Ly8gbG9jYXRlIHRoZSBzdGFydCBvZiB0aGUgYmxvY2tcblx0Y29uc3QgY29kZWJsb2NrQmVnaW4gPSBmaW5kTGluZShzdGF0ZSxzdGF0ZS5kb2MubGluZUF0KHBvcykubnVtYmVyLERpcmVjdGlvbi5CYWNrd2FyZCwvXlxcYFxcYFxcYC8pXG5cdFxuXHRpZiAoY29kZWJsb2NrQmVnaW4gPT0gbnVsbCkge1xuXHRcdGNvbnNvbGUud2FybihcInVuYWJsZSB0byBsb2NhdGUgc3RhcnQgb2YgdGhlIGNvZGVibG9jayBldmVuIHRob3VnaCBpbnNpZGUgb25lXCIpO1xuXHRcdHJldHVybiBcIlwiO1xuXHR9XG5cblx0Ly8gZXh0cmFjdCB0aGUgbGFuZ3VhZ2Vcblx0Ly8gY29kZWJsb2NrcyBtYXkgc3RhcnQgYW5kIGVuZCB3aXRoIGFuIGFyYml0cmFyeSBudW1iZXIgb2YgYmFja3RpY2tzXG5cdGNvbnN0IGxhbmd1YWdlID0gY29kZWJsb2NrQmVnaW4udGV4dC5yZXBsYWNlKC9gKy8sIFwiXCIpO1xuXHRyZXR1cm4gbGFuZ3VhZ2U7XG59XG4iXX0=