import { TFile, TFolder, Notice, debounce } from "obsidian";
import { parseSnippets, parseSnippetVariables } from "../snippets/parse";
// @ts-ignore
import differenceImplementation from "set.prototype.difference";
// @ts-ignore
import intersectionImplementation from "set.prototype.intersection";
import { sortSnippets } from "src/snippets/sort";
const difference = differenceImplementation;
const intersection = intersectionImplementation;
function isInFolder(file, dir) {
    let cur = file.parent;
    let cnt = 0;
    while (cur && (!cur.isRoot()) && (cnt < 100)) {
        if (cur.path === dir.path)
            return true;
        cur = cur.parent;
        cnt++;
    }
    return false;
}
function fileIsInFolder(plugin, folderPath, file) {
    const snippetDir = plugin.app.vault.getAbstractFileByPath(folderPath);
    const isFolder = snippetDir instanceof TFolder;
    return (isFolder && isInFolder(file, snippetDir));
}
const refreshFromFiles = debounce(async (plugin) => {
    if (!(plugin.settings.loadSnippetVariablesFromFile || plugin.settings.loadSnippetsFromFile)) {
        return;
    }
    await plugin.processSettings(false, true);
}, 500, true);
export const onFileChange = async (plugin, file) => {
    if (!(file instanceof TFile))
        return;
    if (plugin.settings.loadSnippetVariablesFromFile && file.path === plugin.settings.snippetVariablesFileLocation
        || plugin.settings.loadSnippetsFromFile && file.path === plugin.settings.snippetsFileLocation
        || fileIsInFolder(plugin, plugin.settings.snippetVariablesFileLocation, file)
        || fileIsInFolder(plugin, plugin.settings.snippetsFileLocation, file)) {
        refreshFromFiles(plugin);
    }
};
export const onFileCreate = (plugin, file) => {
    if (!(file instanceof TFile))
        return;
    if (plugin.settings.loadSnippetVariablesFromFile && fileIsInFolder(plugin, plugin.settings.snippetVariablesFileLocation, file)
        || plugin.settings.loadSnippetsFromFile && fileIsInFolder(plugin, plugin.settings.snippetsFileLocation, file)) {
        refreshFromFiles(plugin);
    }
};
export const onFileDelete = (plugin, file) => {
    if (!(file instanceof TFile))
        return;
    const snippetVariablesDir = plugin.app.vault.getAbstractFileByPath(plugin.settings.snippetVariablesFileLocation);
    const snippetDir = plugin.app.vault.getAbstractFileByPath(plugin.settings.snippetsFileLocation);
    if (plugin.settings.loadSnippetVariablesFromFile && snippetVariablesDir instanceof TFolder && file.path.contains(snippetVariablesDir.path)
        || plugin.settings.loadSnippetsFromFile && snippetDir instanceof TFolder && file.path.contains(snippetDir.path)) {
        refreshFromFiles(plugin);
    }
};
function* generateFilesWithin(fileOrFolder) {
    if (fileOrFolder instanceof TFile)
        yield fileOrFolder;
    else if (fileOrFolder instanceof TFolder)
        for (const child of fileOrFolder.children)
            yield* generateFilesWithin(child);
}
function getFilesWithin(vault, path) {
    const fileOrFolder = vault.getAbstractFileByPath(path);
    const files = generateFilesWithin(fileOrFolder);
    return new Set(files);
}
export function getFileSets(plugin) {
    const variablesFolder = plugin.settings.loadSnippetVariablesFromFile
        ? getFilesWithin(plugin.app.vault, plugin.settings.snippetVariablesFileLocation)
        : new Set();
    const snippetsFolder = plugin.settings.loadSnippetsFromFile
        ? getFilesWithin(plugin.app.vault, plugin.settings.snippetsFileLocation)
        : new Set();
    const definitelyVariableFiles = difference(variablesFolder, snippetsFolder);
    const definitelySnippetFiles = difference(snippetsFolder, variablesFolder);
    const snippetOrVariableFiles = intersection(variablesFolder, snippetsFolder);
    return { definitelyVariableFiles, definitelySnippetFiles, snippetOrVariableFiles };
}
export async function getVariablesFromFiles(plugin, files) {
    const snippetVariables = {};
    for (const file of files.definitelyVariableFiles) {
        const content = await plugin.app.vault.cachedRead(file);
        try {
            Object.assign(snippetVariables, await parseSnippetVariables(content));
        }
        catch (e) {
            new Notice(`Failed to parse variable file ${file.name}: ${e}`);
            console.log(`Failed to parse variable file ${file.name}: ${e}`);
            files.definitelyVariableFiles.delete(file);
        }
    }
    return snippetVariables;
}
export async function tryGetVariablesFromUnknownFiles(plugin, files) {
    const snippetVariables = {};
    for (const file of files.snippetOrVariableFiles) {
        const content = await plugin.app.vault.cachedRead(file);
        try {
            Object.assign(snippetVariables, await parseSnippetVariables(content));
            files.definitelyVariableFiles.add(file);
        }
        catch (e) {
            // No error here, we just assume this is a snippets file.
            // If it's not, then an error will be raised later, while parsing it.
            files.definitelySnippetFiles.add(file);
        }
        files.snippetOrVariableFiles.delete(file);
    }
    return snippetVariables;
}
export async function getSnippetsFromFiles(plugin, files, snippetVariables) {
    const snippets = [];
    for (const file of files.definitelySnippetFiles) {
        const content = await plugin.app.vault.cachedRead(file);
        try {
            snippets.push(...await parseSnippets(content, snippetVariables));
        }
        catch (e) {
            new Notice(`Failed to parse snippet file ${file.name}: ${e}`);
            console.log(`Failed to parse snippet file ${file.name}: ${e}`);
            files.definitelySnippetFiles.delete(file);
        }
    }
    return sortSnippets(snippets);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZV93YXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9maWxlX3dhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBUyxLQUFLLEVBQUUsT0FBTyxFQUFpQixNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWxGLE9BQU8sRUFBRSxhQUFhLEVBQUUscUJBQXFCLEVBQXlCLE1BQU0sbUJBQW1CLENBQUM7QUFDaEcsYUFBYTtBQUNiLE9BQU8sd0JBQXdCLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsYUFBYTtBQUNiLE9BQU8sMEJBQTBCLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBRWpELE1BQU0sVUFBVSxHQUErQyx3QkFBd0IsQ0FBQztBQUN4RixNQUFNLFlBQVksR0FBK0MsMEJBQTBCLENBQUM7QUFHNUYsU0FBUyxVQUFVLENBQUMsSUFBVyxFQUFFLEdBQVk7SUFDNUMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN0QixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFFWixPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUU5QyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUk7WUFBRSxPQUFPLElBQUksQ0FBQztRQUV2QyxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUNqQixHQUFHLEVBQUUsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNkLENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxNQUF3QixFQUFFLFVBQWtCLEVBQUUsSUFBVztJQUNoRixNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsR0FB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QU0sQ0FBQyxnQ0FBZ0MsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzlELE9BQU8sQ0FBQyxHQUFHLENBQUMsZ0NBQWdDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztZQUMvRCxLQUFLLENBQUMsc0JBQXNCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzNDLENBQUM7SUFDRixDQUFDO0lBRUQsT0FBTyxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDL0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBMYXRleFN1aXRlUGx1Z2luIGZyb20gXCIuLi9tYWluXCI7XG5pbXBvcnQgeyBWYXVsdCwgVEZpbGUsIFRGb2xkZXIsIFRBYnN0cmFjdEZpbGUsIE5vdGljZSwgZGVib3VuY2UgfSBmcm9tIFwib2JzaWRpYW5cIjtcbmltcG9ydCB7IFNuaXBwZXQgfSBmcm9tIFwiLi4vc25pcHBldHMvc25pcHBldHNcIjtcbmltcG9ydCB7IHBhcnNlU25pcHBldHMsIHBhcnNlU25pcHBldFZhcmlhYmxlcywgdHlwZSBTbmlwcGV0VmFyaWFibGVzIH0gZnJvbSBcIi4uL3NuaXBwZXRzL3BhcnNlXCI7XG4vLyBAdHMtaWdub3JlXG5pbXBvcnQgZGlmZmVyZW5jZUltcGxlbWVudGF0aW9uIGZyb20gXCJzZXQucHJvdG90eXBlLmRpZmZlcmVuY2VcIjtcbi8vIEB0cy1pZ25vcmVcbmltcG9ydCBpbnRlcnNlY3Rpb25JbXBsZW1lbnRhdGlvbiBmcm9tIFwic2V0LnByb3RvdHlwZS5pbnRlcnNlY3Rpb25cIjtcbmltcG9ydCB7IHNvcnRTbmlwcGV0cyB9IGZyb20gXCJzcmMvc25pcHBldHMvc29ydFwiO1xuXG5jb25zdCBkaWZmZXJlbmNlOiA8VD4oc2VsZjogU2V0PFQ+LCBvdGhlcjogU2V0PFQ+KSA9PiBTZXQ8VD4gPSBkaWZmZXJlbmNlSW1wbGVtZW50YXRpb247XG5jb25zdCBpbnRlcnNlY3Rpb246IDxUPihzZWxmOiBTZXQ8VD4sIG90aGVyOiBTZXQ8VD4pID0+IFNldDxUPiA9IGludGVyc2VjdGlvbkltcGxlbWVudGF0aW9uO1xuXG5cbmZ1bmN0aW9uIGlzSW5Gb2xkZXIoZmlsZTogVEZpbGUsIGRpcjogVEZvbGRlcikge1xuXHRsZXQgY3VyID0gZmlsZS5wYXJlbnQ7XG5cdGxldCBjbnQgPSAwO1xuXG5cdHdoaWxlIChjdXIgJiYgKCFjdXIuaXNSb290KCkpICYmIChjbnQgPCAxMDApKSB7XG5cblx0XHRpZiAoY3VyLnBhdGggPT09IGRpci5wYXRoKSByZXR1cm4gdHJ1ZTtcblxuXHRcdGN1ciA9IGN1ci5wYXJlbnQ7XG5cdFx0Y250Kys7XG5cdH1cblxuXHRyZXR1cm4gZmFsc2U7XG59XG5cbmZ1bmN0aW9uIGZpbGVJc0luRm9sZGVyKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbiwgZm9sZGVyUGF0aDogc3RyaW5nLCBmaWxlOiBURmlsZSkge1xuXHRjb25zdCBzbmlwcGV0RGlyID0gcGx1Z2luLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZm9sZGVyUGF0aCk7XG5cdGNvbnN0IGlzRm9sZGVyID0gc25pcHBldERpciBpbnN0YW5jZW9mIFRGb2xkZXI7XG5cblx0cmV0dXJuIChpc0ZvbGRlciAmJiBpc0luRm9sZGVyKGZpbGUsIHNuaXBwZXREaXIpKTtcbn1cblxuY29uc3QgcmVmcmVzaEZyb21GaWxlcyA9IGRlYm91bmNlKGFzeW5jIChwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4pID0+IHtcblx0aWYgKCEocGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0VmFyaWFibGVzRnJvbUZpbGUgfHwgcGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0c0Zyb21GaWxlKSkge1xuXHRcdHJldHVybjtcblx0fVxuXG5cdGF3YWl0IHBsdWdpbi5wcm9jZXNzU2V0dGluZ3MoZmFsc2UsIHRydWUpO1xuXG59LCA1MDAsIHRydWUpO1xuXG5leHBvcnQgY29uc3Qgb25GaWxlQ2hhbmdlID0gYXN5bmMgKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbiwgZmlsZTogVEFic3RyYWN0RmlsZSkgPT4ge1xuXHRpZiAoIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpKSByZXR1cm47XG5cblx0aWYgKHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldFZhcmlhYmxlc0Zyb21GaWxlICYmIGZpbGUucGF0aCA9PT0gcGx1Z2luLnNldHRpbmdzLnNuaXBwZXRWYXJpYWJsZXNGaWxlTG9jYXRpb25cblx0XHR8fCBwbHVnaW4uc2V0dGluZ3MubG9hZFNuaXBwZXRzRnJvbUZpbGUgJiYgZmlsZS5wYXRoID09PSBwbHVnaW4uc2V0dGluZ3Muc25pcHBldHNGaWxlTG9jYXRpb25cblx0XHR8fCBmaWxlSXNJbkZvbGRlcihwbHVnaW4sIHBsdWdpbi5zZXR0aW5ncy5zbmlwcGV0VmFyaWFibGVzRmlsZUxvY2F0aW9uLCBmaWxlKVxuXHRcdHx8IGZpbGVJc0luRm9sZGVyKHBsdWdpbiwgcGx1Z2luLnNldHRpbmdzLnNuaXBwZXRzRmlsZUxvY2F0aW9uLCBmaWxlKVxuXHQpIHtcblx0XHRyZWZyZXNoRnJvbUZpbGVzKHBsdWdpbik7XG5cdH1cbn1cblxuZXhwb3J0IGNvbnN0IG9uRmlsZUNyZWF0ZSA9IChwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4sIGZpbGU6IFRBYnN0cmFjdEZpbGUpID0+IHtcblx0aWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkgcmV0dXJuO1xuXG5cdGlmIChwbHVnaW4uc2V0dGluZ3MubG9hZFNuaXBwZXRWYXJpYWJsZXNGcm9tRmlsZSAmJiBmaWxlSXNJbkZvbGRlcihwbHVnaW4scGx1Z2luLnNldHRpbmdzLnNuaXBwZXRWYXJpYWJsZXNGaWxlTG9jYXRpb24sIGZpbGUpXG5cdFx0fHwgcGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0c0Zyb21GaWxlICYmIGZpbGVJc0luRm9sZGVyKHBsdWdpbixwbHVnaW4uc2V0dGluZ3Muc25pcHBldHNGaWxlTG9jYXRpb24sIGZpbGUpXG5cdCkge1xuXHRcdHJlZnJlc2hGcm9tRmlsZXMocGx1Z2luKTtcblx0fVxufVxuXG5leHBvcnQgY29uc3Qgb25GaWxlRGVsZXRlID0gKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbiwgZmlsZTogVEFic3RyYWN0RmlsZSkgPT4ge1xuXHRpZiAoIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpKSByZXR1cm47XG5cblx0Y29uc3Qgc25pcHBldFZhcmlhYmxlc0RpciA9IHBsdWdpbi5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHBsdWdpbi5zZXR0aW5ncy5zbmlwcGV0VmFyaWFibGVzRmlsZUxvY2F0aW9uKTtcblx0Y29uc3Qgc25pcHBldERpciA9IHBsdWdpbi5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHBsdWdpbi5zZXR0aW5ncy5zbmlwcGV0c0ZpbGVMb2NhdGlvbik7XG5cblx0aWYgKHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldFZhcmlhYmxlc0Zyb21GaWxlICYmIHNuaXBwZXRWYXJpYWJsZXNEaXIgaW5zdGFuY2VvZiBURm9sZGVyICYmIGZpbGUucGF0aC5jb250YWlucyhzbmlwcGV0VmFyaWFibGVzRGlyLnBhdGgpXG5cdFx0fHwgcGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0c0Zyb21GaWxlICYmIHNuaXBwZXREaXIgaW5zdGFuY2VvZiBURm9sZGVyICYmIGZpbGUucGF0aC5jb250YWlucyhzbmlwcGV0RGlyLnBhdGgpXG5cdCkge1xuXHRcdHJlZnJlc2hGcm9tRmlsZXMocGx1Z2luKTtcblx0fVxufVxuXG5mdW5jdGlvbiogZ2VuZXJhdGVGaWxlc1dpdGhpbihmaWxlT3JGb2xkZXI6IFRBYnN0cmFjdEZpbGUpOiBHZW5lcmF0b3I8VEZpbGU+IHtcblx0aWYgKGZpbGVPckZvbGRlciBpbnN0YW5jZW9mIFRGaWxlKVxuXHRcdHlpZWxkIGZpbGVPckZvbGRlcjtcblxuXHRlbHNlIGlmIChmaWxlT3JGb2xkZXIgaW5zdGFuY2VvZiBURm9sZGVyKVxuXHRcdGZvciAoY29uc3QgY2hpbGQgb2YgZmlsZU9yRm9sZGVyLmNoaWxkcmVuKVxuXHRcdFx0eWllbGQqIGdlbmVyYXRlRmlsZXNXaXRoaW4oY2hpbGQpO1xufVxuXG5mdW5jdGlvbiBnZXRGaWxlc1dpdGhpbih2YXVsdDogVmF1bHQsIHBhdGg6IHN0cmluZyk6IFNldDxURmlsZT4ge1xuXHRjb25zdCBmaWxlT3JGb2xkZXIgPSB2YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgocGF0aCk7XG5cdGNvbnN0IGZpbGVzID0gZ2VuZXJhdGVGaWxlc1dpdGhpbihmaWxlT3JGb2xkZXIpO1xuXHRyZXR1cm4gbmV3IFNldChmaWxlcyk7XG59XG5cbmludGVyZmFjZSBGaWxlU2V0cyB7XG5cdGRlZmluaXRlbHlWYXJpYWJsZUZpbGVzOiBTZXQ8VEZpbGU+O1xuXHRkZWZpbml0ZWx5U25pcHBldEZpbGVzOiBTZXQ8VEZpbGU+O1xuXHRzbmlwcGV0T3JWYXJpYWJsZUZpbGVzOiBTZXQ8VEZpbGU+O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0RmlsZVNldHMocGx1Z2luOiBMYXRleFN1aXRlUGx1Z2luKTogRmlsZVNldHMge1xuXHRjb25zdCB2YXJpYWJsZXNGb2xkZXIgPVxuXHRcdHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldFZhcmlhYmxlc0Zyb21GaWxlXG5cdFx0PyBnZXRGaWxlc1dpdGhpbihwbHVnaW4uYXBwLnZhdWx0LCBwbHVnaW4uc2V0dGluZ3Muc25pcHBldFZhcmlhYmxlc0ZpbGVMb2NhdGlvbilcblx0XHQ6IG5ldyBTZXQ8VEZpbGU+KCk7XG5cblx0Y29uc3Qgc25pcHBldHNGb2xkZXIgPVxuXHRcdHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldHNGcm9tRmlsZVxuXHRcdD8gZ2V0RmlsZXNXaXRoaW4ocGx1Z2luLmFwcC52YXVsdCwgcGx1Z2luLnNldHRpbmdzLnNuaXBwZXRzRmlsZUxvY2F0aW9uKVxuXHRcdFx0OiBuZXcgU2V0PFRGaWxlPigpO1xuXG5cdGNvbnN0IGRlZmluaXRlbHlWYXJpYWJsZUZpbGVzID0gZGlmZmVyZW5jZSh2YXJpYWJsZXNGb2xkZXIsIHNuaXBwZXRzRm9sZGVyKTtcblx0Y29uc3QgZGVmaW5pdGVseVNuaXBwZXRGaWxlcyA9IGRpZmZlcmVuY2Uoc25pcHBldHNGb2xkZXIsIHZhcmlhYmxlc0ZvbGRlcik7XG5cdGNvbnN0IHNuaXBwZXRPclZhcmlhYmxlRmlsZXMgPSBpbnRlcnNlY3Rpb24odmFyaWFibGVzRm9sZGVyLCBzbmlwcGV0c0ZvbGRlcik7XG5cblx0cmV0dXJuIHtkZWZpbml0ZWx5VmFyaWFibGVGaWxlcywgZGVmaW5pdGVseVNuaXBwZXRGaWxlcywgc25pcHBldE9yVmFyaWFibGVGaWxlc307XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRWYXJpYWJsZXNGcm9tRmlsZXMocGx1Z2luOiBMYXRleFN1aXRlUGx1Z2luLCBmaWxlczogRmlsZVNldHMpIHtcblx0Y29uc3Qgc25pcHBldFZhcmlhYmxlczogU25pcHBldFZhcmlhYmxlcyA9IHt9O1xuXG5cdGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcy5kZWZpbml0ZWx5VmFyaWFibGVGaWxlcykge1xuXHRcdGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBwbHVnaW4uYXBwLnZhdWx0LmNhY2hlZFJlYWQoZmlsZSk7XG5cdFx0dHJ5IHtcblx0XHRcdE9iamVjdC5hc3NpZ24oc25pcHBldFZhcmlhYmxlcywgYXdhaXQgcGFyc2VTbmlwcGV0VmFyaWFibGVzKGNvbnRlbnQpKTtcblx0XHR9IGNhdGNoIChlKSB7XG5cdFx0XHRuZXcgTm90aWNlKGBGYWlsZWQgdG8gcGFyc2UgdmFyaWFibGUgZmlsZSAke2ZpbGUubmFtZX06ICR7ZX1gKTtcblx0XHRcdGNvbnNvbGUubG9nKGBGYWlsZWQgdG8gcGFyc2UgdmFyaWFibGUgZmlsZSAke2ZpbGUubmFtZX06ICR7ZX1gKTtcblx0XHRcdGZpbGVzLmRlZmluaXRlbHlWYXJpYWJsZUZpbGVzLmRlbGV0ZShmaWxlKTtcblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gc25pcHBldFZhcmlhYmxlcztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHRyeUdldFZhcmlhYmxlc0Zyb21Vbmtub3duRmlsZXMocGx1Z2luOiBMYXRleFN1aXRlUGx1Z2luLCBmaWxlczogRmlsZVNldHMpIHtcblx0Y29uc3Qgc25pcHBldFZhcmlhYmxlczogU25pcHBldFZhcmlhYmxlcyA9IHt9O1xuXG5cdGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcy5zbmlwcGV0T3JWYXJpYWJsZUZpbGVzKSB7XG5cdFx0Y29uc3QgY29udGVudCA9IGF3YWl0IHBsdWdpbi5hcHAudmF1bHQuY2FjaGVkUmVhZChmaWxlKTtcblx0XHR0cnkge1xuXHRcdFx0T2JqZWN0LmFzc2lnbihzbmlwcGV0VmFyaWFibGVzLCBhd2FpdCBwYXJzZVNuaXBwZXRWYXJpYWJsZXMoY29udGVudCkpO1xuXHRcdFx0ZmlsZXMuZGVmaW5pdGVseVZhcmlhYmxlRmlsZXMuYWRkKGZpbGUpO1xuXHRcdH0gY2F0Y2ggKGUpIHtcblx0XHRcdC8vIE5vIGVycm9yIGhlcmUsIHdlIGp1c3QgYXNzdW1lIHRoaXMgaXMgYSBzbmlwcGV0cyBmaWxlLlxuXHRcdFx0Ly8gSWYgaXQncyBub3QsIHRoZW4gYW4gZXJyb3Igd2lsbCBiZSByYWlzZWQgbGF0ZXIsIHdoaWxlIHBhcnNpbmcgaXQuXG5cdFx0XHRmaWxlcy5kZWZpbml0ZWx5U25pcHBldEZpbGVzLmFkZChmaWxlKTtcblx0XHR9XG5cdFx0ZmlsZXMuc25pcHBldE9yVmFyaWFibGVGaWxlcy5kZWxldGUoZmlsZSk7XG5cdH1cblxuXHRyZXR1cm4gc25pcHBldFZhcmlhYmxlcztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNuaXBwZXRzRnJvbUZpbGVzKFxuXHRwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4sXG5cdGZpbGVzOiBGaWxlU2V0cyxcblx0c25pcHBldFZhcmlhYmxlczogU25pcHBldFZhcmlhYmxlc1xuKSB7XG5cdGNvbnN0IHNuaXBwZXRzOiBTbmlwcGV0W10gPSBbXTtcblxuXHRmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMuZGVmaW5pdGVseVNuaXBwZXRGaWxlcykge1xuXHRcdGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBwbHVnaW4uYXBwLnZhdWx0LmNhY2hlZFJlYWQoZmlsZSk7XG5cdFx0dHJ5IHtcblx0XHRcdHNuaXBwZXRzLnB1c2goLi4uYXdhaXQgcGFyc2VTbmlwcGV0cyhjb250ZW50LCBzbmlwcGV0VmFyaWFibGVzKSk7XG5cdFx0fSBjYXRjaCAoZSkge1xuXHRcdFx0bmV3IE5vdGljZShgRmFpbGVkIHRvIHBhcnNlIHNuaXBwZXQgZmlsZSAke2ZpbGUubmFtZX06ICR7ZX1gKTtcblx0XHRcdGNvbnNvbGUubG9nKGBGYWlsZWQgdG8gcGFyc2Ugc25pcHBldCBmaWxlICR7ZmlsZS5uYW1lfTogJHtlfWApO1xuXHRcdFx0ZmlsZXMuZGVmaW5pdGVseVNuaXBwZXRGaWxlcy5kZWxldGUoZmlsZSk7XG5cdFx0fVxuXHR9XG5cblx0cmV0dXJuIHNvcnRTbmlwcGV0cyhzbmlwcGV0cyk7XG59XG4iXX0=