import { __awaiter } from "tslib";
import { TFile, TFolder, Notice, debounce } from "obsidian";
import { parseSnippets, parseSnippetVariables } from "../snippets/parse";
// @ts-ignore
import differenceImplementation from "set.prototype.difference";
// @ts-ignore
import intersectionImplementation from "set.prototype.intersection";
import { sortSnippets } from "src/snippets/sort";
const difference = differenceImplementation;
const intersection = intersectionImplementation;
function isInFolder(file, dir) {
    let cur = file.parent;
    let cnt = 0;
    while (cur && (!cur.isRoot()) && (cnt < 100)) {
        if (cur.path === dir.path)
            return true;
        cur = cur.parent;
        cnt++;
    }
    return false;
}
function fileIsInFolder(plugin, folderPath, file) {
    const snippetDir = plugin.app.vault.getAbstractFileByPath(folderPath);
    const isFolder = snippetDir instanceof TFolder;
    return (isFolder && isInFolder(file, snippetDir));
}
const refreshFromFiles = debounce((plugin) => __awaiter(void 0, void 0, void 0, function* () {
    if (!(plugin.settings.loadSnippetVariablesFromFile || plugin.settings.loadSnippetsFromFile)) {
        return;
    }
    yield plugin.processSettings(false, true);
}), 500, true);
export const onFileChange = (plugin, file) => __awaiter(void 0, void 0, void 0, function* () {
    if (!(file instanceof TFile))
        return;
    if (plugin.settings.loadSnippetVariablesFromFile && file.path === plugin.settings.snippetVariablesFileLocation
        || plugin.settings.loadSnippetsFromFile && file.path === plugin.settings.snippetsFileLocation
        || fileIsInFolder(plugin, plugin.settings.snippetVariablesFileLocation, file)
        || fileIsInFolder(plugin, plugin.settings.snippetsFileLocation, file)) {
        refreshFromFiles(plugin);
    }
});
export const onFileCreate = (plugin, file) => {
    if (!(file instanceof TFile))
        return;
    if (plugin.settings.loadSnippetVariablesFromFile && fileIsInFolder(plugin, plugin.settings.snippetVariablesFileLocation, file)
        || plugin.settings.loadSnippetsFromFile && fileIsInFolder(plugin, plugin.settings.snippetsFileLocation, file)) {
        refreshFromFiles(plugin);
    }
};
export const onFileDelete = (plugin, file) => {
    if (!(file instanceof TFile))
        return;
    const snippetVariablesDir = plugin.app.vault.getAbstractFileByPath(plugin.settings.snippetVariablesFileLocation);
    const snippetDir = plugin.app.vault.getAbstractFileByPath(plugin.settings.snippetsFileLocation);
    if (plugin.settings.loadSnippetVariablesFromFile && snippetVariablesDir instanceof TFolder && file.path.contains(snippetVariablesDir.path)
        || plugin.settings.loadSnippetsFromFile && snippetDir instanceof TFolder && file.path.contains(snippetDir.path)) {
        refreshFromFiles(plugin);
    }
};
function* generateFilesWithin(fileOrFolder) {
    if (fileOrFolder instanceof TFile)
        yield fileOrFolder;
    else if (fileOrFolder instanceof TFolder)
        for (const child of fileOrFolder.children)
            yield* generateFilesWithin(child);
}
function getFilesWithin(vault, path) {
    const fileOrFolder = vault.getAbstractFileByPath(path);
    if (fileOrFolder === null) {
        return new Set();
    }
    const files = generateFilesWithin(fileOrFolder);
    return new Set(files);
}
export function getFileSets(plugin) {
    const variablesFolder = plugin.settings.loadSnippetVariablesFromFile
        ? getFilesWithin(plugin.app.vault, plugin.settings.snippetVariablesFileLocation)
        : new Set();
    const snippetsFolder = plugin.settings.loadSnippetsFromFile
        ? getFilesWithin(plugin.app.vault, plugin.settings.snippetsFileLocation)
        : new Set();
    const definitelyVariableFiles = difference(variablesFolder, snippetsFolder);
    const definitelySnippetFiles = difference(snippetsFolder, variablesFolder);
    const snippetOrVariableFiles = intersection(variablesFolder, snippetsFolder);
    return { definitelyVariableFiles, definitelySnippetFiles, snippetOrVariableFiles };
}
export function getVariablesFromFiles(plugin, files) {
    return __awaiter(this, void 0, void 0, function* () {
        const snippetVariables = {};
        for (const file of files.definitelyVariableFiles) {
            const content = yield plugin.app.vault.cachedRead(file);
            try {
                Object.assign(snippetVariables, yield parseSnippetVariables(content));
            }
            catch (e) {
                new Notice(`Failed to parse variable file ${file.name}: ${e}`);
                console.log(`Failed to parse variable file ${file.name}: ${e}`);
                files.definitelyVariableFiles.delete(file);
            }
        }
        return snippetVariables;
    });
}
export function tryGetVariablesFromUnknownFiles(plugin, files) {
    return __awaiter(this, void 0, void 0, function* () {
        const snippetVariables = {};
        for (const file of files.snippetOrVariableFiles) {
            const content = yield plugin.app.vault.cachedRead(file);
            try {
                Object.assign(snippetVariables, yield parseSnippetVariables(content));
                files.definitelyVariableFiles.add(file);
            }
            catch (e) {
                // No error here, we just assume this is a snippets file.
                // If it's not, then an error will be raised later, while parsing it.
                files.definitelySnippetFiles.add(file);
            }
            files.snippetOrVariableFiles.delete(file);
        }
        return snippetVariables;
    });
}
export function getPreambleFromFiles(plugin, files, preamble) {
    return __awaiter(this, void 0, void 0, function* () {
    });
}
export function getSnippetsFromFiles(plugin, files, snippetVariables) {
    return __awaiter(this, void 0, void 0, function* () {
        const snippets = [];
        for (const file of files.definitelySnippetFiles) {
            const content = yield plugin.app.vault.cachedRead(file);
            try {
                snippets.push(...yield parseSnippets(content, snippetVariables));
            }
            catch (e) {
                new Notice(`Failed to parse snippet file ${file.name}: ${e}`);
                console.log(`Failed to parse snippet file ${file.name}: ${e}`);
                files.definitelySnippetFiles.delete(file);
            }
        }
        return sortSnippets(snippets);
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZV93YXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9maWxlX3dhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFDQSxPQUFPLEVBQVMsS0FBSyxFQUFFLE9BQU8sRUFBaUIsTUFBTSxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQztBQUVsRixPQUFPLEVBQUUsYUFBYSxFQUFFLHFCQUFxQixFQUF5QixNQUFNLG1CQUFtQixDQUFDO0FBQ2hHLGFBQWE7QUFDYixPQUFPLHdCQUF3QixNQUFNLDBCQUEwQixDQUFDO0FBQ2hFLGFBQWE7QUFDYixPQUFPLDBCQUEwQixNQUFNLDRCQUE0QixDQUFDO0FBQ3BFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUdqRCxNQUFNLFVBQVUsR0FBK0Msd0JBQXdCLENBQUM7QUFDeEYsTUFBTSxZQUFZLEdBQStDLDBCQUEwQixDQUFDO0FBRzVGLFNBQVMsVUFBVSxDQUFDLElBQVcsRUFBRSxHQUFZO0lBQzVDLElBQUksR0FBRyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7SUFDdEIsSUFBSSxHQUFHLEdBQUcsQ0FBQyxDQUFDO0lBRVosT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFFOUMsSUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLEdBQUcsQ0FBQyxJQUFJO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFFdkMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxNQUFNLENBQUM7UUFDakIsR0FBRyxFQUFFLENBQUM7SUFDUCxDQUFDO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDO0FBRUQsU0FBUyxjQUFjLENBQUMsTUFBd0IsRUFBRSxVQUFrQixFQUFFLElBQVc7SUFDaEYsTUFBTSxVQUFVLEdBQUcsTUFBTSxDQUFDLEdB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QUFDO1lBQ3hELElBQUksQ0FBQztnQkFDSixRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxhQUFhLENBQUMsT0FBTyxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztZQUNsRSxDQUFDO1lBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztnQkFDWixJQUFJLE1BQU0sQ0FBQyxnQ0FBZ0MsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2dCQUM5RCxPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQy9ELEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0MsQ0FBQztRQUNGLENBQUM7UUFFRCxPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQixDQUFDO0NBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTGF0ZXhTdWl0ZVBsdWdpbiBmcm9tIFwiLi4vbWFpblwiO1xyXG5pbXBvcnQgeyBWYXVsdCwgVEZpbGUsIFRGb2xkZXIsIFRBYnN0cmFjdEZpbGUsIE5vdGljZSwgZGVib3VuY2UgfSBmcm9tIFwib2JzaWRpYW5cIjtcclxuaW1wb3J0IHsgU25pcHBldCB9IGZyb20gXCIuLi9zbmlwcGV0cy9zbmlwcGV0c1wiO1xyXG5pbXBvcnQgeyBwYXJzZVNuaXBwZXRzLCBwYXJzZVNuaXBwZXRWYXJpYWJsZXMsIHR5cGUgU25pcHBldFZhcmlhYmxlcyB9IGZyb20gXCIuLi9zbmlwcGV0cy9wYXJzZVwiO1xyXG4vLyBAdHMtaWdub3JlXHJcbmltcG9ydCBkaWZmZXJlbmNlSW1wbGVtZW50YXRpb24gZnJvbSBcInNldC5wcm90b3R5cGUuZGlmZmVyZW5jZVwiO1xyXG4vLyBAdHMtaWdub3JlXHJcbmltcG9ydCBpbnRlcnNlY3Rpb25JbXBsZW1lbnRhdGlvbiBmcm9tIFwic2V0LnByb3RvdHlwZS5pbnRlcnNlY3Rpb25cIjtcclxuaW1wb3J0IHsgc29ydFNuaXBwZXRzIH0gZnJvbSBcInNyYy9zbmlwcGV0cy9zb3J0XCI7XHJcbmltcG9ydCBNb3NoZSBmcm9tIFwiLi4vbWFpblwiO1xyXG5cclxuY29uc3QgZGlmZmVyZW5jZTogPFQ+KHNlbGY6IFNldDxUPiwgb3RoZXI6IFNldDxUPikgPT4gU2V0PFQ+ID0gZGlmZmVyZW5jZUltcGxlbWVudGF0aW9uO1xyXG5jb25zdCBpbnRlcnNlY3Rpb246IDxUPihzZWxmOiBTZXQ8VD4sIG90aGVyOiBTZXQ8VD4pID0+IFNldDxUPiA9IGludGVyc2VjdGlvbkltcGxlbWVudGF0aW9uO1xyXG5cclxuXHJcbmZ1bmN0aW9uIGlzSW5Gb2xkZXIoZmlsZTogVEZpbGUsIGRpcjogVEZvbGRlcikge1xyXG5cdGxldCBjdXIgPSBmaWxlLnBhcmVudDtcclxuXHRsZXQgY250ID0gMDtcclxuXHJcblx0d2hpbGUgKGN1ciAmJiAoIWN1ci5pc1Jvb3QoKSkgJiYgKGNudCA8IDEwMCkpIHtcclxuXHJcblx0XHRpZiAoY3VyLnBhdGggPT09IGRpci5wYXRoKSByZXR1cm4gdHJ1ZTtcclxuXHJcblx0XHRjdXIgPSBjdXIucGFyZW50O1xyXG5cdFx0Y250Kys7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gZmFsc2U7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZpbGVJc0luRm9sZGVyKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbiwgZm9sZGVyUGF0aDogc3RyaW5nLCBmaWxlOiBURmlsZSkge1xyXG5cdGNvbnN0IHNuaXBwZXREaXIgPSBwbHVnaW4uYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChmb2xkZXJQYXRoKTtcclxuXHRjb25zdCBpc0ZvbGRlciA9IHNuaXBwZXREaXIgaW5zdGFuY2VvZiBURm9sZGVyO1xyXG5cclxuXHRyZXR1cm4gKGlzRm9sZGVyICYmIGlzSW5Gb2xkZXIoZmlsZSwgc25pcHBldERpcikpO1xyXG59XHJcblxyXG5jb25zdCByZWZyZXNoRnJvbUZpbGVzID0gZGVib3VuY2UoYXN5bmMgKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbikgPT4ge1xyXG5cdGlmICghKHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldFZhcmlhYmxlc0Zyb21GaWxlIHx8IHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldHNGcm9tRmlsZSkpIHtcclxuXHRcdHJldHVybjtcclxuXHR9XHJcblxyXG5cdGF3YWl0IHBsdWdpbi5wcm9jZXNzU2V0dGluZ3MoZmFsc2UsIHRydWUpO1xyXG5cclxufSwgNTAwLCB0cnVlKTtcclxuXHJcbmV4cG9ydCBjb25zdCBvbkZpbGVDaGFuZ2UgPSBhc3luYyAocGx1Z2luOiBMYXRleFN1aXRlUGx1Z2luLCBmaWxlOiBUQWJzdHJhY3RGaWxlKSA9PiB7XHJcblx0aWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkgcmV0dXJuO1xyXG5cclxuXHRpZiAocGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0VmFyaWFibGVzRnJvbUZpbGUgJiYgZmlsZS5wYXRoID09PSBwbHVnaW4uc2V0dGluZ3Muc25pcHBldFZhcmlhYmxlc0ZpbGVMb2NhdGlvblxyXG5cdFx0fHwgcGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0c0Zyb21GaWxlICYmIGZpbGUucGF0aCA9PT0gcGx1Z2luLnNldHRpbmdzLnNuaXBwZXRzRmlsZUxvY2F0aW9uXHJcblx0XHR8fCBmaWxlSXNJbkZvbGRlcihwbHVnaW4sIHBsdWdpbi5zZXR0aW5ncy5zbmlwcGV0VmFyaWFibGVzRmlsZUxvY2F0aW9uLCBmaWxlKVxyXG5cdFx0fHwgZmlsZUlzSW5Gb2xkZXIocGx1Z2luLCBwbHVnaW4uc2V0dGluZ3Muc25pcHBldHNGaWxlTG9jYXRpb24sIGZpbGUpXHJcblx0KSB7XHJcblx0XHRyZWZyZXNoRnJvbUZpbGVzKHBsdWdpbik7XHJcblx0fVxyXG59XHJcblxyXG5leHBvcnQgY29uc3Qgb25GaWxlQ3JlYXRlID0gKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbiwgZmlsZTogVEFic3RyYWN0RmlsZSkgPT4ge1xyXG5cdGlmICghKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHJldHVybjtcclxuXHJcblx0aWYgKHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldFZhcmlhYmxlc0Zyb21GaWxlICYmIGZpbGVJc0luRm9sZGVyKHBsdWdpbixwbHVnaW4uc2V0dGluZ3Muc25pcHBldFZhcmlhYmxlc0ZpbGVMb2NhdGlvbiwgZmlsZSlcclxuXHRcdHx8IHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldHNGcm9tRmlsZSAmJiBmaWxlSXNJbkZvbGRlcihwbHVnaW4scGx1Z2luLnNldHRpbmdzLnNuaXBwZXRzRmlsZUxvY2F0aW9uLCBmaWxlKVxyXG5cdCkge1xyXG5cdFx0cmVmcmVzaEZyb21GaWxlcyhwbHVnaW4pO1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IG9uRmlsZURlbGV0ZSA9IChwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4sIGZpbGU6IFRBYnN0cmFjdEZpbGUpID0+IHtcclxuXHRpZiAoIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpKSByZXR1cm47XHJcblxyXG5cdGNvbnN0IHNuaXBwZXRWYXJpYWJsZXNEaXIgPSBwbHVnaW4uYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChwbHVnaW4uc2V0dGluZ3Muc25pcHBldFZhcmlhYmxlc0ZpbGVMb2NhdGlvbik7XHJcblx0Y29uc3Qgc25pcHBldERpciA9IHBsdWdpbi5hcHAudmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHBsdWdpbi5zZXR0aW5ncy5zbmlwcGV0c0ZpbGVMb2NhdGlvbik7XHJcblxyXG5cdGlmIChwbHVnaW4uc2V0dGluZ3MubG9hZFNuaXBwZXRWYXJpYWJsZXNGcm9tRmlsZSAmJiBzbmlwcGV0VmFyaWFibGVzRGlyIGluc3RhbmNlb2YgVEZvbGRlciAmJiBmaWxlLnBhdGguY29udGFpbnMoc25pcHBldFZhcmlhYmxlc0Rpci5wYXRoKVxyXG5cdFx0fHwgcGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0c0Zyb21GaWxlICYmIHNuaXBwZXREaXIgaW5zdGFuY2VvZiBURm9sZGVyICYmIGZpbGUucGF0aC5jb250YWlucyhzbmlwcGV0RGlyLnBhdGgpXHJcblx0KSB7XHJcblx0XHRyZWZyZXNoRnJvbUZpbGVzKHBsdWdpbik7XHJcblx0fVxyXG59XHJcblxyXG5mdW5jdGlvbiogZ2VuZXJhdGVGaWxlc1dpdGhpbihmaWxlT3JGb2xkZXI6IFRBYnN0cmFjdEZpbGUpOiBHZW5lcmF0b3I8VEZpbGU+IHtcclxuXHRpZiAoZmlsZU9yRm9sZGVyIGluc3RhbmNlb2YgVEZpbGUpXHJcblx0XHR5aWVsZCBmaWxlT3JGb2xkZXI7XHJcblxyXG5cdGVsc2UgaWYgKGZpbGVPckZvbGRlciBpbnN0YW5jZW9mIFRGb2xkZXIpXHJcblx0XHRmb3IgKGNvbnN0IGNoaWxkIG9mIGZpbGVPckZvbGRlci5jaGlsZHJlbilcclxuXHRcdFx0eWllbGQqIGdlbmVyYXRlRmlsZXNXaXRoaW4oY2hpbGQpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRGaWxlc1dpdGhpbih2YXVsdDogVmF1bHQsIHBhdGg6IHN0cmluZyk6IFNldDxURmlsZT4ge1xyXG4gICAgY29uc3QgZmlsZU9yRm9sZGVyID0gdmF1bHQuZ2V0QWJzdHJhY3RGaWxlQnlQYXRoKHBhdGgpO1xyXG5cclxuICAgIGlmIChmaWxlT3JGb2xkZXIgPT09IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gbmV3IFNldCgpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgZmlsZXMgPSBnZW5lcmF0ZUZpbGVzV2l0aGluKGZpbGVPckZvbGRlcik7XHJcbiAgICByZXR1cm4gbmV3IFNldChmaWxlcyk7XHJcbn1cclxuXHJcblxyXG5pbnRlcmZhY2UgRmlsZVNldHMge1xyXG5cdGRlZmluaXRlbHlWYXJpYWJsZUZpbGVzOiBTZXQ8VEZpbGU+O1xyXG5cdGRlZmluaXRlbHlTbmlwcGV0RmlsZXM6IFNldDxURmlsZT47XHJcblx0c25pcHBldE9yVmFyaWFibGVGaWxlczogU2V0PFRGaWxlPjtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldEZpbGVTZXRzKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbik6IEZpbGVTZXRzIHtcclxuXHRjb25zdCB2YXJpYWJsZXNGb2xkZXIgPVxyXG5cdFx0cGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0VmFyaWFibGVzRnJvbUZpbGVcclxuXHRcdD8gZ2V0RmlsZXNXaXRoaW4ocGx1Z2luLmFwcC52YXVsdCwgcGx1Z2luLnNldHRpbmdzLnNuaXBwZXRWYXJpYWJsZXNGaWxlTG9jYXRpb24pXHJcblx0XHQ6IG5ldyBTZXQ8VEZpbGU+KCk7XHJcblxyXG5cdGNvbnN0IHNuaXBwZXRzRm9sZGVyID1cclxuXHRcdHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldHNGcm9tRmlsZVxyXG5cdFx0PyBnZXRGaWxlc1dpdGhpbihwbHVnaW4uYXBwLnZhdWx0LCBwbHVnaW4uc2V0dGluZ3Muc25pcHBldHNGaWxlTG9jYXRpb24pXHJcblx0XHRcdDogbmV3IFNldDxURmlsZT4oKTtcclxuXHJcblx0Y29uc3QgZGVmaW5pdGVseVZhcmlhYmxlRmlsZXMgPSBkaWZmZXJlbmNlKHZhcmlhYmxlc0ZvbGRlciwgc25pcHBldHNGb2xkZXIpO1xyXG5cdGNvbnN0IGRlZmluaXRlbHlTbmlwcGV0RmlsZXMgPSBkaWZmZXJlbmNlKHNuaXBwZXRzRm9sZGVyLCB2YXJpYWJsZXNGb2xkZXIpO1xyXG5cdGNvbnN0IHNuaXBwZXRPclZhcmlhYmxlRmlsZXMgPSBpbnRlcnNlY3Rpb24odmFyaWFibGVzRm9sZGVyLCBzbmlwcGV0c0ZvbGRlcik7XHJcblxyXG5cdHJldHVybiB7ZGVmaW5pdGVseVZhcmlhYmxlRmlsZXMsIGRlZmluaXRlbHlTbmlwcGV0RmlsZXMsIHNuaXBwZXRPclZhcmlhYmxlRmlsZXN9O1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0VmFyaWFibGVzRnJvbUZpbGVzKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbiwgZmlsZXM6IEZpbGVTZXRzKSB7XHJcblx0Y29uc3Qgc25pcHBldFZhcmlhYmxlczogU25pcHBldFZhcmlhYmxlcyA9IHt9O1xyXG5cclxuXHRmb3IgKGNvbnN0IGZpbGUgb2YgZmlsZXMuZGVmaW5pdGVseVZhcmlhYmxlRmlsZXMpIHtcclxuXHRcdGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBwbHVnaW4uYXBwLnZhdWx0LmNhY2hlZFJlYWQoZmlsZSk7XHJcblx0XHR0cnkge1xyXG5cdFx0XHRPYmplY3QuYXNzaWduKHNuaXBwZXRWYXJpYWJsZXMsIGF3YWl0IHBhcnNlU25pcHBldFZhcmlhYmxlcyhjb250ZW50KSk7XHJcblx0XHR9IGNhdGNoIChlKSB7XHJcblx0XHRcdG5ldyBOb3RpY2UoYEZhaWxlZCB0byBwYXJzZSB2YXJpYWJsZSBmaWxlICR7ZmlsZS5uYW1lfTogJHtlfWApO1xyXG5cdFx0XHRjb25zb2xlLmxvZyhgRmFpbGVkIHRvIHBhcnNlIHZhcmlhYmxlIGZpbGUgJHtmaWxlLm5hbWV9OiAke2V9YCk7XHJcblx0XHRcdGZpbGVzLmRlZmluaXRlbHlWYXJpYWJsZUZpbGVzLmRlbGV0ZShmaWxlKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHJldHVybiBzbmlwcGV0VmFyaWFibGVzO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdHJ5R2V0VmFyaWFibGVzRnJvbVVua25vd25GaWxlcyhwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4sIGZpbGVzOiBGaWxlU2V0cykge1xyXG5cdGNvbnN0IHNuaXBwZXRWYXJpYWJsZXM6IFNuaXBwZXRWYXJpYWJsZXMgPSB7fTtcclxuXHJcblx0Zm9yIChjb25zdCBmaWxlIG9mIGZpbGVzLnNuaXBwZXRPclZhcmlhYmxlRmlsZXMpIHtcclxuXHRcdGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBwbHVnaW4uYXBwLnZhdWx0LmNhY2hlZFJlYWQoZmlsZSk7XHJcblx0XHR0cnkge1xyXG5cdFx0XHRPYmplY3QuYXNzaWduKHNuaXBwZXRWYXJpYWJsZXMsIGF3YWl0IHBhcnNlU25pcHBldFZhcmlhYmxlcyhjb250ZW50KSk7XHJcblx0XHRcdGZpbGVzLmRlZmluaXRlbHlWYXJpYWJsZUZpbGVzLmFkZChmaWxlKTtcclxuXHRcdH0gY2F0Y2ggKGUpIHtcclxuXHRcdFx0Ly8gTm8gZXJyb3IgaGVyZSwgd2UganVzdCBhc3N1bWUgdGhpcyBpcyBhIHNuaXBwZXRzIGZpbGUuXHJcblx0XHRcdC8vIElmIGl0J3Mgbm90LCB0aGVuIGFuIGVycm9yIHdpbGwgYmUgcmFpc2VkIGxhdGVyLCB3aGlsZSBwYXJzaW5nIGl0LlxyXG5cdFx0XHRmaWxlcy5kZWZpbml0ZWx5U25pcHBldEZpbGVzLmFkZChmaWxlKTtcclxuXHRcdH1cclxuXHRcdGZpbGVzLnNuaXBwZXRPclZhcmlhYmxlRmlsZXMuZGVsZXRlKGZpbGUpO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIHNuaXBwZXRWYXJpYWJsZXM7XHJcbn1cclxuXHJcbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRQcmVhbWJsZUZyb21GaWxlcyhcclxuXHRwbHVnaW46IE1vc2hlLFxyXG5cdGZpbGVzOiBGaWxlU2V0cyxcclxuXHRwcmVhbWJsZTogU25pcHBldFZhcmlhYmxlc1xyXG4pIHtcclxuXHJcblxyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0U25pcHBldHNGcm9tRmlsZXMoXHJcblx0cGx1Z2luOiBMYXRleFN1aXRlUGx1Z2luLFxyXG5cdGZpbGVzOiBGaWxlU2V0cyxcclxuXHRzbmlwcGV0VmFyaWFibGVzOiBTbmlwcGV0VmFyaWFibGVzXHJcbikge1xyXG5cdGNvbnN0IHNuaXBwZXRzOiBTbmlwcGV0W10gPSBbXTtcclxuXHJcblx0Zm9yIChjb25zdCBmaWxlIG9mIGZpbGVzLmRlZmluaXRlbHlTbmlwcGV0RmlsZXMpIHtcclxuXHRcdGNvbnN0IGNvbnRlbnQgPSBhd2FpdCBwbHVnaW4uYXBwLnZhdWx0LmNhY2hlZFJlYWQoZmlsZSk7XHJcblx0XHR0cnkge1xyXG5cdFx0XHRzbmlwcGV0cy5wdXNoKC4uLmF3YWl0IHBhcnNlU25pcHBldHMoY29udGVudCwgc25pcHBldFZhcmlhYmxlcykpO1xyXG5cdFx0fSBjYXRjaCAoZSkge1xyXG5cdFx0XHRuZXcgTm90aWNlKGBGYWlsZWQgdG8gcGFyc2Ugc25pcHBldCBmaWxlICR7ZmlsZS5uYW1lfTogJHtlfWApO1xyXG5cdFx0XHRjb25zb2xlLmxvZyhgRmFpbGVkIHRvIHBhcnNlIHNuaXBwZXQgZmlsZSAke2ZpbGUubmFtZX06ICR7ZX1gKTtcclxuXHRcdFx0ZmlsZXMuZGVmaW5pdGVseVNuaXBwZXRGaWxlcy5kZWxldGUoZmlsZSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gc29ydFNuaXBwZXRzKHNuaXBwZXRzKTtcclxufVxyXG4iXX0=