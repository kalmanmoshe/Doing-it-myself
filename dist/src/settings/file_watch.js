import { TFile, TFolder, Notice, debounce } from "obsidian";
import { parseSnippets, parseSnippetVariables } from "../snippets/parse";
// @ts-ignore
import differenceImplementation from "set.prototype.difference";
// @ts-ignore
import intersectionImplementation from "set.prototype.intersection";
import { sortSnippets } from "src/snippets/sort";
const difference = differenceImplementation;
const intersection = intersectionImplementation;
function isInFolder(file, dir) {
    let cur = file.parent;
    let cnt = 0;
    while (cur && (!cur.isRoot()) && (cnt < 100)) {
        if (cur.path === dir.path)
            return true;
        cur = cur.parent;
        cnt++;
    }
    return false;
}
function fileIsInFolder(plugin, folderPath, file) {
    const snippetDir = plugin.app.vault.getAbstractFileByPath(folderPath);
    const isFolder = snippetDir instanceof TFolder;
    return (isFolder && isInFolder(file, snippetDir));
}
const refreshFromFiles = debounce(async (plugin) => {
    if (!(plugin.settings.loadSnippetVariablesFromFile || plugin.settings.loadSnippetsFromFile)) {
        return;
    }
    await plugin.processSettings(false, true);
}, 500, true);
export const onFileChange = async (plugin, file) => {
    if (!(file instanceof TFile))
        return;
    if (plugin.settings.loadSnippetVariablesFromFile && file.path === plugin.settings.snippetVariablesFileLocation
        || plugin.settings.loadSnippetsFromFile && file.path === plugin.settings.snippetsFileLocation
        || fileIsInFolder(plugin, plugin.settings.snippetVariablesFileLocation, file)
        || fileIsInFolder(plugin, plugin.settings.snippetsFileLocation, file)) {
        refreshFromFiles(plugin);
    }
};
export const onFileCreate = (plugin, file) => {
    if (!(file instanceof TFile))
        return;
    if (plugin.settings.loadSnippetVariablesFromFile && fileIsInFolder(plugin, plugin.settings.snippetVariablesFileLocation, file)
        || plugin.settings.loadSnippetsFromFile && fileIsInFolder(plugin, plugin.settings.snippetsFileLocation, file)) {
        refreshFromFiles(plugin);
    }
};
export const onFileDelete = (plugin, file) => {
    if (!(file instanceof TFile))
        return;
    const snippetVariablesDir = plugin.app.vault.getAbstractFileByPath(plugin.settings.snippetVariablesFileLocation);
    const snippetDir = plugin.app.vault.getAbstractFileByPath(plugin.settings.snippetsFileLocation);
    if (plugin.settings.loadSnippetVariablesFromFile && snippetVariablesDir instanceof TFolder && file.path.contains(snippetVariablesDir.path)
        || plugin.settings.loadSnippetsFromFile && snippetDir instanceof TFolder && file.path.contains(snippetDir.path)) {
        refreshFromFiles(plugin);
    }
};
function* generateFilesWithin(fileOrFolder) {
    if (fileOrFolder instanceof TFile)
        yield fileOrFolder;
    else if (fileOrFolder instanceof TFolder)
        for (const child of fileOrFolder.children)
            yield* generateFilesWithin(child);
}
function getFilesWithin(vault, path) {
    const fileOrFolder = vault.getAbstractFileByPath(path);
    if (fileOrFolder === null) {
        return new Set();
    }
    const files = generateFilesWithin(fileOrFolder);
    return new Set(files);
}
export function getFileSets(plugin) {
    const variablesFolder = plugin.settings.loadSnippetVariablesFromFile
        ? getFilesWithin(plugin.app.vault, plugin.settings.snippetVariablesFileLocation)
        : new Set();
    const snippetsFolder = plugin.settings.loadSnippetsFromFile
        ? getFilesWithin(plugin.app.vault, plugin.settings.snippetsFileLocation)
        : new Set();
    const definitelyVariableFiles = difference(variablesFolder, snippetsFolder);
    const definitelySnippetFiles = difference(snippetsFolder, variablesFolder);
    const snippetOrVariableFiles = intersection(variablesFolder, snippetsFolder);
    return { definitelyVariableFiles, definitelySnippetFiles, snippetOrVariableFiles };
}
export async function getVariablesFromFiles(plugin, files) {
    const snippetVariables = {};
    for (const file of files.definitelyVariableFiles) {
        const content = await plugin.app.vault.cachedRead(file);
        try {
            Object.assign(snippetVariables, await parseSnippetVariables(content));
        }
        catch (e) {
            new Notice(`Failed to parse variable file ${file.name}: ${e}`);
            console.log(`Failed to parse variable file ${file.name}: ${e}`);
            files.definitelyVariableFiles.delete(file);
        }
    }
    return snippetVariables;
}
export async function tryGetVariablesFromUnknownFiles(plugin, files) {
    const snippetVariables = {};
    for (const file of files.snippetOrVariableFiles) {
        const content = await plugin.app.vault.cachedRead(file);
        try {
            Object.assign(snippetVariables, await parseSnippetVariables(content));
            files.definitelyVariableFiles.add(file);
        }
        catch (e) {
            // No error here, we just assume this is a snippets file.
            // If it's not, then an error will be raised later, while parsing it.
            files.definitelySnippetFiles.add(file);
        }
        files.snippetOrVariableFiles.delete(file);
    }
    return snippetVariables;
}
export async function getPreambleFromFiles(plugin, files, preamble) {
}
export async function getSnippetsFromFiles(plugin, files, snippetVariables) {
    const snippets = [];
    for (const file of files.definitelySnippetFiles) {
        const content = await plugin.app.vault.cachedRead(file);
        try {
            snippets.push(...await parseSnippets(content, snippetVariables));
        }
        catch (e) {
            new Notice(`Failed to parse snippet file ${file.name}: ${e}`);
            console.log(`Failed to parse snippet file ${file.name}: ${e}`);
            files.definitelySnippetFiles.delete(file);
        }
    }
    return sortSnippets(snippets);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZV93YXRjaC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9zZXR0aW5ncy9maWxlX3dhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBUyxLQUFLLEVBQUUsT0FBTyxFQUFpQixNQUFNLEVBQUUsUUFBUSxFQUFFLE1BQU0sVUFBVSxDQUFDO0FBRWxGLE9BQU8sRUFBRSxhQUFhLEVBQUUscUJBQXFCLEVBQXlCLE1BQU0sbUJBQW1CLENBQUM7QUFDaEcsYUFBYTtBQUNiLE9BQU8sd0JBQXdCLE1BQU0sMEJBQTBCLENBQUM7QUFDaEUsYUFBYTtBQUNiLE9BQU8sMEJBQTBCLE1BQU0sNEJBQTRCLENBQUM7QUFDcEUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBR2pELE1BQU0sVUFBVSxHQUErQyx3QkFBd0IsQ0FBQztBQUN4RixNQUFNLFlBQVksR0FBK0MsMEJBQTBCLENBQUM7QUFHNUYsU0FBUyxVQUFVLENBQUMsSUFBVyxFQUFFLEdBQVk7SUFDNUMsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztJQUN0QixJQUFJLEdBQUcsR0FBRyxDQUFDLENBQUM7SUFFWixPQUFPLEdBQUcsSUFBSSxDQUFDLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUU5QyxJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssR0FBRyxDQUFDLElBQUk7WUFBRSxPQUFPLElBQUksQ0FBQztRQUV2QyxHQUFHLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQztRQUNqQixHQUFHLEVBQUUsQ0FBQztJQUNQLENBQUM7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNkLENBQUM7QUFFRCxTQUFTLGNBQWMsQ0FBQyxNQUF3QixFQUFFLFVBQWtCLEVBQUUsSUFBVztJQUNoRixNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsR0FB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LENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUM7WUFDSixRQUFRLENBQUMsSUFBSSxDQUFDLEdBQUcsTUFBTSxhQUFhLENBQUMsT0FBTyxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztRQUNsRSxDQUFDO1FBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQztZQUNaLElBQUksTUFBTSxDQUFDLGdDQUFnQyxJQUFJLENBQUMsSUFBSSxLQUFLLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDOUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxnQ0FBZ0MsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQy9ELEtBQUssQ0FBQyxzQkFBc0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0MsQ0FBQztJQUNGLENBQUM7SUFFRCxPQUFPLFlBQVksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMvQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IExhdGV4U3VpdGVQbHVnaW4gZnJvbSBcIi4uL21haW5cIjtcclxuaW1wb3J0IHsgVmF1bHQsIFRGaWxlLCBURm9sZGVyLCBUQWJzdHJhY3RGaWxlLCBOb3RpY2UsIGRlYm91bmNlIH0gZnJvbSBcIm9ic2lkaWFuXCI7XHJcbmltcG9ydCB7IFNuaXBwZXQgfSBmcm9tIFwiLi4vc25pcHBldHMvc25pcHBldHNcIjtcclxuaW1wb3J0IHsgcGFyc2VTbmlwcGV0cywgcGFyc2VTbmlwcGV0VmFyaWFibGVzLCB0eXBlIFNuaXBwZXRWYXJpYWJsZXMgfSBmcm9tIFwiLi4vc25pcHBldHMvcGFyc2VcIjtcclxuLy8gQHRzLWlnbm9yZVxyXG5pbXBvcnQgZGlmZmVyZW5jZUltcGxlbWVudGF0aW9uIGZyb20gXCJzZXQucHJvdG90eXBlLmRpZmZlcmVuY2VcIjtcclxuLy8gQHRzLWlnbm9yZVxyXG5pbXBvcnQgaW50ZXJzZWN0aW9uSW1wbGVtZW50YXRpb24gZnJvbSBcInNldC5wcm90b3R5cGUuaW50ZXJzZWN0aW9uXCI7XHJcbmltcG9ydCB7IHNvcnRTbmlwcGV0cyB9IGZyb20gXCJzcmMvc25pcHBldHMvc29ydFwiO1xyXG5pbXBvcnQgTW9zaGUgZnJvbSBcIi4uL21haW5cIjtcclxuXHJcbmNvbnN0IGRpZmZlcmVuY2U6IDxUPihzZWxmOiBTZXQ8VD4sIG90aGVyOiBTZXQ8VD4pID0+IFNldDxUPiA9IGRpZmZlcmVuY2VJbXBsZW1lbnRhdGlvbjtcclxuY29uc3QgaW50ZXJzZWN0aW9uOiA8VD4oc2VsZjogU2V0PFQ+LCBvdGhlcjogU2V0PFQ+KSA9PiBTZXQ8VD4gPSBpbnRlcnNlY3Rpb25JbXBsZW1lbnRhdGlvbjtcclxuXHJcblxyXG5mdW5jdGlvbiBpc0luRm9sZGVyKGZpbGU6IFRGaWxlLCBkaXI6IFRGb2xkZXIpIHtcclxuXHRsZXQgY3VyID0gZmlsZS5wYXJlbnQ7XHJcblx0bGV0IGNudCA9IDA7XHJcblxyXG5cdHdoaWxlIChjdXIgJiYgKCFjdXIuaXNSb290KCkpICYmIChjbnQgPCAxMDApKSB7XHJcblxyXG5cdFx0aWYgKGN1ci5wYXRoID09PSBkaXIucGF0aCkgcmV0dXJuIHRydWU7XHJcblxyXG5cdFx0Y3VyID0gY3VyLnBhcmVudDtcclxuXHRcdGNudCsrO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIGZhbHNlO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmaWxlSXNJbkZvbGRlcihwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4sIGZvbGRlclBhdGg6IHN0cmluZywgZmlsZTogVEZpbGUpIHtcclxuXHRjb25zdCBzbmlwcGV0RGlyID0gcGx1Z2luLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgoZm9sZGVyUGF0aCk7XHJcblx0Y29uc3QgaXNGb2xkZXIgPSBzbmlwcGV0RGlyIGluc3RhbmNlb2YgVEZvbGRlcjtcclxuXHJcblx0cmV0dXJuIChpc0ZvbGRlciAmJiBpc0luRm9sZGVyKGZpbGUsIHNuaXBwZXREaXIpKTtcclxufVxyXG5cclxuY29uc3QgcmVmcmVzaEZyb21GaWxlcyA9IGRlYm91bmNlKGFzeW5jIChwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4pID0+IHtcclxuXHRpZiAoIShwbHVnaW4uc2V0dGluZ3MubG9hZFNuaXBwZXRWYXJpYWJsZXNGcm9tRmlsZSB8fCBwbHVnaW4uc2V0dGluZ3MubG9hZFNuaXBwZXRzRnJvbUZpbGUpKSB7XHJcblx0XHRyZXR1cm47XHJcblx0fVxyXG5cclxuXHRhd2FpdCBwbHVnaW4ucHJvY2Vzc1NldHRpbmdzKGZhbHNlLCB0cnVlKTtcclxuXHJcbn0sIDUwMCwgdHJ1ZSk7XHJcblxyXG5leHBvcnQgY29uc3Qgb25GaWxlQ2hhbmdlID0gYXN5bmMgKHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbiwgZmlsZTogVEFic3RyYWN0RmlsZSkgPT4ge1xyXG5cdGlmICghKGZpbGUgaW5zdGFuY2VvZiBURmlsZSkpIHJldHVybjtcclxuXHJcblx0aWYgKHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldFZhcmlhYmxlc0Zyb21GaWxlICYmIGZpbGUucGF0aCA9PT0gcGx1Z2luLnNldHRpbmdzLnNuaXBwZXRWYXJpYWJsZXNGaWxlTG9jYXRpb25cclxuXHRcdHx8IHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldHNGcm9tRmlsZSAmJiBmaWxlLnBhdGggPT09IHBsdWdpbi5zZXR0aW5ncy5zbmlwcGV0c0ZpbGVMb2NhdGlvblxyXG5cdFx0fHwgZmlsZUlzSW5Gb2xkZXIocGx1Z2luLCBwbHVnaW4uc2V0dGluZ3Muc25pcHBldFZhcmlhYmxlc0ZpbGVMb2NhdGlvbiwgZmlsZSlcclxuXHRcdHx8IGZpbGVJc0luRm9sZGVyKHBsdWdpbiwgcGx1Z2luLnNldHRpbmdzLnNuaXBwZXRzRmlsZUxvY2F0aW9uLCBmaWxlKVxyXG5cdCkge1xyXG5cdFx0cmVmcmVzaEZyb21GaWxlcyhwbHVnaW4pO1xyXG5cdH1cclxufVxyXG5cclxuZXhwb3J0IGNvbnN0IG9uRmlsZUNyZWF0ZSA9IChwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4sIGZpbGU6IFRBYnN0cmFjdEZpbGUpID0+IHtcclxuXHRpZiAoIShmaWxlIGluc3RhbmNlb2YgVEZpbGUpKSByZXR1cm47XHJcblxyXG5cdGlmIChwbHVnaW4uc2V0dGluZ3MubG9hZFNuaXBwZXRWYXJpYWJsZXNGcm9tRmlsZSAmJiBmaWxlSXNJbkZvbGRlcihwbHVnaW4scGx1Z2luLnNldHRpbmdzLnNuaXBwZXRWYXJpYWJsZXNGaWxlTG9jYXRpb24sIGZpbGUpXHJcblx0XHR8fCBwbHVnaW4uc2V0dGluZ3MubG9hZFNuaXBwZXRzRnJvbUZpbGUgJiYgZmlsZUlzSW5Gb2xkZXIocGx1Z2luLHBsdWdpbi5zZXR0aW5ncy5zbmlwcGV0c0ZpbGVMb2NhdGlvbiwgZmlsZSlcclxuXHQpIHtcclxuXHRcdHJlZnJlc2hGcm9tRmlsZXMocGx1Z2luKTtcclxuXHR9XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBvbkZpbGVEZWxldGUgPSAocGx1Z2luOiBMYXRleFN1aXRlUGx1Z2luLCBmaWxlOiBUQWJzdHJhY3RGaWxlKSA9PiB7XHJcblx0aWYgKCEoZmlsZSBpbnN0YW5jZW9mIFRGaWxlKSkgcmV0dXJuO1xyXG5cclxuXHRjb25zdCBzbmlwcGV0VmFyaWFibGVzRGlyID0gcGx1Z2luLmFwcC52YXVsdC5nZXRBYnN0cmFjdEZpbGVCeVBhdGgocGx1Z2luLnNldHRpbmdzLnNuaXBwZXRWYXJpYWJsZXNGaWxlTG9jYXRpb24pO1xyXG5cdGNvbnN0IHNuaXBwZXREaXIgPSBwbHVnaW4uYXBwLnZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChwbHVnaW4uc2V0dGluZ3Muc25pcHBldHNGaWxlTG9jYXRpb24pO1xyXG5cclxuXHRpZiAocGx1Z2luLnNldHRpbmdzLmxvYWRTbmlwcGV0VmFyaWFibGVzRnJvbUZpbGUgJiYgc25pcHBldFZhcmlhYmxlc0RpciBpbnN0YW5jZW9mIFRGb2xkZXIgJiYgZmlsZS5wYXRoLmNvbnRhaW5zKHNuaXBwZXRWYXJpYWJsZXNEaXIucGF0aClcclxuXHRcdHx8IHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldHNGcm9tRmlsZSAmJiBzbmlwcGV0RGlyIGluc3RhbmNlb2YgVEZvbGRlciAmJiBmaWxlLnBhdGguY29udGFpbnMoc25pcHBldERpci5wYXRoKVxyXG5cdCkge1xyXG5cdFx0cmVmcmVzaEZyb21GaWxlcyhwbHVnaW4pO1xyXG5cdH1cclxufVxyXG5cclxuZnVuY3Rpb24qIGdlbmVyYXRlRmlsZXNXaXRoaW4oZmlsZU9yRm9sZGVyOiBUQWJzdHJhY3RGaWxlKTogR2VuZXJhdG9yPFRGaWxlPiB7XHJcblx0aWYgKGZpbGVPckZvbGRlciBpbnN0YW5jZW9mIFRGaWxlKVxyXG5cdFx0eWllbGQgZmlsZU9yRm9sZGVyO1xyXG5cclxuXHRlbHNlIGlmIChmaWxlT3JGb2xkZXIgaW5zdGFuY2VvZiBURm9sZGVyKVxyXG5cdFx0Zm9yIChjb25zdCBjaGlsZCBvZiBmaWxlT3JGb2xkZXIuY2hpbGRyZW4pXHJcblx0XHRcdHlpZWxkKiBnZW5lcmF0ZUZpbGVzV2l0aGluKGNoaWxkKTtcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RmlsZXNXaXRoaW4odmF1bHQ6IFZhdWx0LCBwYXRoOiBzdHJpbmcpOiBTZXQ8VEZpbGU+IHtcclxuICAgIGNvbnN0IGZpbGVPckZvbGRlciA9IHZhdWx0LmdldEFic3RyYWN0RmlsZUJ5UGF0aChwYXRoKTtcclxuXHJcbiAgICBpZiAoZmlsZU9yRm9sZGVyID09PSBudWxsKSB7XHJcbiAgICAgICAgcmV0dXJuIG5ldyBTZXQoKTtcclxuICAgIH1cclxuICAgIGNvbnN0IGZpbGVzID0gZ2VuZXJhdGVGaWxlc1dpdGhpbihmaWxlT3JGb2xkZXIpO1xyXG4gICAgcmV0dXJuIG5ldyBTZXQoZmlsZXMpO1xyXG59XHJcblxyXG5cclxuaW50ZXJmYWNlIEZpbGVTZXRzIHtcclxuXHRkZWZpbml0ZWx5VmFyaWFibGVGaWxlczogU2V0PFRGaWxlPjtcclxuXHRkZWZpbml0ZWx5U25pcHBldEZpbGVzOiBTZXQ8VEZpbGU+O1xyXG5cdHNuaXBwZXRPclZhcmlhYmxlRmlsZXM6IFNldDxURmlsZT47XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRGaWxlU2V0cyhwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4pOiBGaWxlU2V0cyB7XHJcblx0Y29uc3QgdmFyaWFibGVzRm9sZGVyID1cclxuXHRcdHBsdWdpbi5zZXR0aW5ncy5sb2FkU25pcHBldFZhcmlhYmxlc0Zyb21GaWxlXHJcblx0XHQ/IGdldEZpbGVzV2l0aGluKHBsdWdpbi5hcHAudmF1bHQsIHBsdWdpbi5zZXR0aW5ncy5zbmlwcGV0VmFyaWFibGVzRmlsZUxvY2F0aW9uKVxyXG5cdFx0OiBuZXcgU2V0PFRGaWxlPigpO1xyXG5cclxuXHRjb25zdCBzbmlwcGV0c0ZvbGRlciA9XHJcblx0XHRwbHVnaW4uc2V0dGluZ3MubG9hZFNuaXBwZXRzRnJvbUZpbGVcclxuXHRcdD8gZ2V0RmlsZXNXaXRoaW4ocGx1Z2luLmFwcC52YXVsdCwgcGx1Z2luLnNldHRpbmdzLnNuaXBwZXRzRmlsZUxvY2F0aW9uKVxyXG5cdFx0XHQ6IG5ldyBTZXQ8VEZpbGU+KCk7XHJcblxyXG5cdGNvbnN0IGRlZmluaXRlbHlWYXJpYWJsZUZpbGVzID0gZGlmZmVyZW5jZSh2YXJpYWJsZXNGb2xkZXIsIHNuaXBwZXRzRm9sZGVyKTtcclxuXHRjb25zdCBkZWZpbml0ZWx5U25pcHBldEZpbGVzID0gZGlmZmVyZW5jZShzbmlwcGV0c0ZvbGRlciwgdmFyaWFibGVzRm9sZGVyKTtcclxuXHRjb25zdCBzbmlwcGV0T3JWYXJpYWJsZUZpbGVzID0gaW50ZXJzZWN0aW9uKHZhcmlhYmxlc0ZvbGRlciwgc25pcHBldHNGb2xkZXIpO1xyXG5cclxuXHRyZXR1cm4ge2RlZmluaXRlbHlWYXJpYWJsZUZpbGVzLCBkZWZpbml0ZWx5U25pcHBldEZpbGVzLCBzbmlwcGV0T3JWYXJpYWJsZUZpbGVzfTtcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFZhcmlhYmxlc0Zyb21GaWxlcyhwbHVnaW46IExhdGV4U3VpdGVQbHVnaW4sIGZpbGVzOiBGaWxlU2V0cykge1xyXG5cdGNvbnN0IHNuaXBwZXRWYXJpYWJsZXM6IFNuaXBwZXRWYXJpYWJsZXMgPSB7fTtcclxuXHJcblx0Zm9yIChjb25zdCBmaWxlIG9mIGZpbGVzLmRlZmluaXRlbHlWYXJpYWJsZUZpbGVzKSB7XHJcblx0XHRjb25zdCBjb250ZW50ID0gYXdhaXQgcGx1Z2luLmFwcC52YXVsdC5jYWNoZWRSZWFkKGZpbGUpO1xyXG5cdFx0dHJ5IHtcclxuXHRcdFx0T2JqZWN0LmFzc2lnbihzbmlwcGV0VmFyaWFibGVzLCBhd2FpdCBwYXJzZVNuaXBwZXRWYXJpYWJsZXMoY29udGVudCkpO1xyXG5cdFx0fSBjYXRjaCAoZSkge1xyXG5cdFx0XHRuZXcgTm90aWNlKGBGYWlsZWQgdG8gcGFyc2UgdmFyaWFibGUgZmlsZSAke2ZpbGUubmFtZX06ICR7ZX1gKTtcclxuXHRcdFx0Y29uc29sZS5sb2coYEZhaWxlZCB0byBwYXJzZSB2YXJpYWJsZSBmaWxlICR7ZmlsZS5uYW1lfTogJHtlfWApO1xyXG5cdFx0XHRmaWxlcy5kZWZpbml0ZWx5VmFyaWFibGVGaWxlcy5kZWxldGUoZmlsZSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gc25pcHBldFZhcmlhYmxlcztcclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHRyeUdldFZhcmlhYmxlc0Zyb21Vbmtub3duRmlsZXMocGx1Z2luOiBMYXRleFN1aXRlUGx1Z2luLCBmaWxlczogRmlsZVNldHMpIHtcclxuXHRjb25zdCBzbmlwcGV0VmFyaWFibGVzOiBTbmlwcGV0VmFyaWFibGVzID0ge307XHJcblxyXG5cdGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcy5zbmlwcGV0T3JWYXJpYWJsZUZpbGVzKSB7XHJcblx0XHRjb25zdCBjb250ZW50ID0gYXdhaXQgcGx1Z2luLmFwcC52YXVsdC5jYWNoZWRSZWFkKGZpbGUpO1xyXG5cdFx0dHJ5IHtcclxuXHRcdFx0T2JqZWN0LmFzc2lnbihzbmlwcGV0VmFyaWFibGVzLCBhd2FpdCBwYXJzZVNuaXBwZXRWYXJpYWJsZXMoY29udGVudCkpO1xyXG5cdFx0XHRmaWxlcy5kZWZpbml0ZWx5VmFyaWFibGVGaWxlcy5hZGQoZmlsZSk7XHJcblx0XHR9IGNhdGNoIChlKSB7XHJcblx0XHRcdC8vIE5vIGVycm9yIGhlcmUsIHdlIGp1c3QgYXNzdW1lIHRoaXMgaXMgYSBzbmlwcGV0cyBmaWxlLlxyXG5cdFx0XHQvLyBJZiBpdCdzIG5vdCwgdGhlbiBhbiBlcnJvciB3aWxsIGJlIHJhaXNlZCBsYXRlciwgd2hpbGUgcGFyc2luZyBpdC5cclxuXHRcdFx0ZmlsZXMuZGVmaW5pdGVseVNuaXBwZXRGaWxlcy5hZGQoZmlsZSk7XHJcblx0XHR9XHJcblx0XHRmaWxlcy5zbmlwcGV0T3JWYXJpYWJsZUZpbGVzLmRlbGV0ZShmaWxlKTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBzbmlwcGV0VmFyaWFibGVzO1xyXG59XHJcblxyXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0UHJlYW1ibGVGcm9tRmlsZXMoXHJcblx0cGx1Z2luOiBNb3NoZSxcclxuXHRmaWxlczogRmlsZVNldHMsXHJcblx0cHJlYW1ibGU6IFNuaXBwZXRWYXJpYWJsZXNcclxuKSB7XHJcblxyXG5cclxufVxyXG5cclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldFNuaXBwZXRzRnJvbUZpbGVzKFxyXG5cdHBsdWdpbjogTGF0ZXhTdWl0ZVBsdWdpbixcclxuXHRmaWxlczogRmlsZVNldHMsXHJcblx0c25pcHBldFZhcmlhYmxlczogU25pcHBldFZhcmlhYmxlc1xyXG4pIHtcclxuXHRjb25zdCBzbmlwcGV0czogU25pcHBldFtdID0gW107XHJcblxyXG5cdGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcy5kZWZpbml0ZWx5U25pcHBldEZpbGVzKSB7XHJcblx0XHRjb25zdCBjb250ZW50ID0gYXdhaXQgcGx1Z2luLmFwcC52YXVsdC5jYWNoZWRSZWFkKGZpbGUpO1xyXG5cdFx0dHJ5IHtcclxuXHRcdFx0c25pcHBldHMucHVzaCguLi5hd2FpdCBwYXJzZVNuaXBwZXRzKGNvbnRlbnQsIHNuaXBwZXRWYXJpYWJsZXMpKTtcclxuXHRcdH0gY2F0Y2ggKGUpIHtcclxuXHRcdFx0bmV3IE5vdGljZShgRmFpbGVkIHRvIHBhcnNlIHNuaXBwZXQgZmlsZSAke2ZpbGUubmFtZX06ICR7ZX1gKTtcclxuXHRcdFx0Y29uc29sZS5sb2coYEZhaWxlZCB0byBwYXJzZSBzbmlwcGV0IGZpbGUgJHtmaWxlLm5hbWV9OiAke2V9YCk7XHJcblx0XHRcdGZpbGVzLmRlZmluaXRlbHlTbmlwcGV0RmlsZXMuZGVsZXRlKGZpbGUpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0cmV0dXJuIHNvcnRTbmlwcGV0cyhzbmlwcGV0cyk7XHJcbn1cclxuIl19