import { Decoration, ViewPlugin } from "@codemirror/view";
import { syntaxTree } from "@codemirror/language";
import { getHtmlBounds } from "./utils/context";
export const rtlForcePlugin = ViewPlugin.fromClass(class {
    constructor(view) {
        this.decorations = this.computeDecorations(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = this.computeDecorations(update.view);
        }
    }
    computeDecorations(view) {
        const widgets = [];
        for (const { from, to } of view.visibleRanges) {
            for (let pos = from; pos <= to;) {
                const line = view.state.doc.lineAt(pos);
                const content = line.text.trim();
                if (this.isRtl(content)) {
                    widgets.push(this.getRtlDecoration(line.from));
                }
                pos = line.to + 1;
            }
        }
        return Decoration.set(widgets);
    }
    isRtl(content) {
        // Remove unwanted characters and check for Hebrew letters at the start
        const cleanedContent = content
            .replace(/[#:\s"=-\d\[\].\+\-]*/g, "")
            .replace(/<[a-z]+[\w\s\d]*>/g, "");
        return /^[א-ת]/.test(cleanedContent);
    }
    getRtlDecoration(pos) {
        return Decoration.line({
            attributes: { "dir": "rtl" },
        }).range(pos);
    }
}, { decorations: v => v.decorations, });
export const HtmlBackgroundPlugin = ViewPlugin.fromClass(class {
    constructor(view) {
        this.decorations = this.computeDecorations(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = this.computeDecorations(update.view);
        }
    }
    computeDecorations(view) {
        const widgets = [];
        for (const { from, to } of view.visibleRanges) {
            syntaxTree(view.state).iterate({ from, to, enter: (node) => {
                    const type = node.type;
                    const to = node.to;
                    if (!(type.name.contains("begin") && type.name.contains("html"))) {
                        return;
                    }
                    const bounds = getHtmlBounds(view.state, to);
                    if (!bounds)
                        return;
                    widgets.push(this.gethtmlBackgroundDecoration(bounds.start, bounds.end));
                }
            });
        }
        return Decoration.set(widgets);
    }
    gethtmlBackgroundDecoration(from, to) {
        return Decoration.mark({
            class: 'moshe-html-background',
        }).range(from, to);
    }
}, { decorations: v => v.decorations, });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yRGVjb3JhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yRGVjb3JhdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUEyQixVQUFVLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpHLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDaEQsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7SUFHL0MsWUFBWSxJQUFnQjtRQUN4QixJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBRUQsTUFBTSxDQUFDLE1BQWtCO1FBQ3JCLElBQUksTUFBTSxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUMsZUFBZSxFQUFFLENBQUM7WUFDOUMsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQzVELENBQUM7SUFDTCxDQUFDO0lBRUQsa0JBQWtCLENBQUMsSUFBZ0I7UUFDL0IsTUFBTSxPQUFPLEdBQXdCLEVBQUUsQ0FBQztRQUV4QyxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1lBQzVDLEtBQUssSUFBSSxHQUFHLEdBQUcsSUFBSSxFQUFFLEdBQUcsSUFBSSxFQUFFLEdBQUcsQ0FBQztnQkFDOUIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUN4QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFD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Q0FBQyxJQUFJLENBQUM7WUFDbkIsS0FBSyxFQUFFLHVCQUF1QjtTQUNqQyxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztJQUN2QixDQUFDO0NBRUosRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldywgIFZpZXdVcGRhdGUgLERlY29yYXRpb24sRGVjb3JhdGlvblNldCwgVmlld1BsdWdpbiB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IFJhbmdlIH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XHJcbmltcG9ydCB7IHN5bnRheFRyZWUgfSBmcm9tIFwiQGNvZGVtaXJyb3IvbGFuZ3VhZ2VcIjtcclxuaW1wb3J0IHsgZ2V0SHRtbEJvdW5kcyB9IGZyb20gXCIuL3V0aWxzL2NvbnRleHRcIjtcclxuZXhwb3J0IGNvbnN0IHJ0bEZvcmNlUGx1Z2luID0gVmlld1BsdWdpbi5mcm9tQ2xhc3MoY2xhc3MgICB7XHJcbiAgICBkZWNvcmF0aW9uczogRGVjb3JhdGlvblNldDtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcih2aWV3OiBFZGl0b3JWaWV3KSB7XHJcbiAgICAgICAgdGhpcy5kZWNvcmF0aW9ucyA9IHRoaXMuY29tcHV0ZURlY29yYXRpb25zKHZpZXcpO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZSh1cGRhdGU6IFZpZXdVcGRhdGUpIHtcclxuICAgICAgICBpZiAodXBkYXRlLmRvY0NoYW5nZWQgfHwgdXBkYXRlLnZpZXdwb3J0Q2hhbmdlZCkge1xyXG4gICAgICAgICAgICB0aGlzLmRlY29yYXRpb25zID0gdGhpcy5jb21wdXRlRGVjb3JhdGlvbnModXBkYXRlLnZpZXcpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb21wdXRlRGVjb3JhdGlvbnModmlldzogRWRpdG9yVmlldyk6IERlY29yYXRpb25TZXQge1xyXG4gICAgICAgIGNvbnN0IHdpZGdldHM6IFJhbmdlPERlY29yYXRpb24+W10gPSBbXTtcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCB7IGZyb20sIHRvIH0gb2Ygdmlldy52aXNpYmxlUmFuZ2VzKSB7XHJcbiAgICAgICAgICAgIGZvciAobGV0IHBvcyA9IGZyb207IHBvcyA8PSB0bzspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxpbmUgPSB2aWV3LnN0YXRlLmRvYy5saW5lQXQocG9zKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBsaW5lLnRleHQudHJpbSgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzUnRsKGNvbnRlbnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0cy5wdXNoKHRoaXMuZ2V0UnRsRGVjb3JhdGlvbihsaW5lLmZyb20pKTtcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICBwb3MgPSBsaW5lLnRvICsgMTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIERlY29yYXRpb24uc2V0KHdpZGdldHMpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNSdGwoY29udGVudDogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgLy8gUmVtb3ZlIHVud2FudGVkIGNoYXJhY3RlcnMgYW5kIGNoZWNrIGZvciBIZWJyZXcgbGV0dGVycyBhdCB0aGUgc3RhcnRcclxuICAgICAgICBjb25zdCBjbGVhbmVkQ29udGVudCA9IGNvbnRlbnRcclxuICAgICAgICAgICAgLnJlcGxhY2UoL1sjOlxcc1wiPS1cXGRcXFtcXF0uXFwrXFwtXSovZywgXCJcIilcclxuICAgICAgICAgICAgLnJlcGxhY2UoLzxbYS16XStbXFx3XFxzXFxkXSo+L2csIFwiXCIpO1xyXG5cclxuICAgICAgICByZXR1cm4gL15b15At16pdLy50ZXN0KGNsZWFuZWRDb250ZW50KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFJ0bERlY29yYXRpb24ocG9zOiBudW1iZXIpOiBSYW5nZTxEZWNvcmF0aW9uPiB7XHJcbiAgICAgICAgcmV0dXJuIERlY29yYXRpb24ubGluZSh7XHJcbiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHtcImRpclwiOiBcInJ0bFwiIH0sXHJcbiAgICAgICAgfSkucmFuZ2UocG9zKTtcclxuICAgIH1cclxufSwgeyBkZWNvcmF0aW9uczogdiA9PiB2LmRlY29yYXRpb25zLCB9KTtcclxuXHJcblxyXG5leHBvcnQgY29uc3QgSHRtbEJhY2tncm91bmRQbHVnaW4gPSBWaWV3UGx1Z2luLmZyb21DbGFzcyhjbGFzcyAgIHtcclxuICAgIGRlY29yYXRpb25zOiBEZWNvcmF0aW9uU2V0O1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHZpZXc6IEVkaXRvclZpZXcpIHtcclxuICAgICAgICB0aGlzLmRlY29yYXRpb25zID0gdGhpcy5jb21wdXRlRGVjb3JhdGlvbnModmlldyk7XHJcbiAgICB9XHJcblxyXG4gICAgdXBkYXRlKHVwZGF0ZTogVmlld1VwZGF0ZSkge1xyXG4gICAgICAgIGlmICh1cGRhdGUuZG9jQ2hhbmdlZCB8fCB1cGRhdGUudmlld3BvcnRDaGFuZ2VkKSB7XHJcbiAgICAgICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSB0aGlzLmNvbXB1dGVEZWNvcmF0aW9ucyh1cGRhdGUudmlldyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGNvbXB1dGVEZWNvcmF0aW9ucyh2aWV3OiBFZGl0b3JWaWV3KTogRGVjb3JhdGlvblNldCB7XHJcbiAgICAgICAgY29uc3Qgd2lkZ2V0czogUmFuZ2U8RGVjb3JhdGlvbj5bXSA9IFtdO1xyXG5cclxuICAgICAgICBmb3IgKGNvbnN0IHsgZnJvbSwgdG8gfSBvZiB2aWV3LnZpc2libGVSYW5nZXMpIHtcclxuICAgICAgICAgICAgICAgIHN5bnRheFRyZWUodmlldy5zdGF0ZSkuaXRlcmF0ZSh7IGZyb20sIHRvLCBlbnRlcjogKG5vZGUpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gbm9kZS50eXBlO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRvID0gbm9kZS50bztcclxuICAgICAgICAgICAgICAgICAgICBpZiAoISh0eXBlLm5hbWUuY29udGFpbnMoXCJiZWdpblwiKSAmJiB0eXBlLm5hbWUuY29udGFpbnMoXCJodG1sXCIpKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJvdW5kcyA9IGdldEh0bWxCb3VuZHModmlldy5zdGF0ZSwgdG8pO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghYm91bmRzKSByZXR1cm47XHJcbiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0cy5wdXNoKHRoaXMuZ2V0aHRtbEJhY2tncm91bmREZWNvcmF0aW9uKGJvdW5kcy5zdGFydCxib3VuZHMuZW5kKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH0pXHJcblxyXG4gICAgICAgICAgICAgICAgXHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gRGVjb3JhdGlvbi5zZXQod2lkZ2V0cyk7XHJcbiAgICB9XHJcbiAgICBwcml2YXRlIGdldGh0bWxCYWNrZ3JvdW5kRGVjb3JhdGlvbihmcm9tOiBudW1iZXIsdG86IG51bWJlcik6IFJhbmdlPERlY29yYXRpb24+IHtcclxuICAgICAgICByZXR1cm4gRGVjb3JhdGlvbi5tYXJrKHtcclxuICAgICAgICAgICAgY2xhc3M6ICdtb3NoZS1odG1sLWJhY2tncm91bmQnLFxyXG4gICAgICAgIH0pLnJhbmdlKGZyb20sIHRvKTtcclxuICAgIH1cclxuXHJcbn0sIHsgZGVjb3JhdGlvbnM6IHYgPT4gdi5kZWNvcmF0aW9ucywgfSk7XHJcbiJdfQ==