import { Decoration, ViewPlugin } from "@codemirror/view";
import { syntaxTree } from "@codemirror/language";
import { getHtmlBounds } from "./utils/context";
export const rtlForcePlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = this.computeDecorations(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = this.computeDecorations(update.view);
        }
    }
    computeDecorations(view) {
        const widgets = [];
        for (const { from, to } of view.visibleRanges) {
            for (let pos = from; pos <= to;) {
                const line = view.state.doc.lineAt(pos);
                const content = line.text.trim();
                if (this.isRtl(content)) {
                    widgets.push(this.getRtlDecoration(line.from));
                }
                pos = line.to + 1;
            }
        }
        return Decoration.set(widgets);
    }
    isRtl(content) {
        // Remove unwanted characters and check for Hebrew letters at the start
        const cleanedContent = content
            .replace(/[#:\s"=-\d\[\].\+\-]*/g, "")
            .replace(/<[a-z]+[\w\s\d]*>/g, "");
        return /^[א-ת]/.test(cleanedContent);
    }
    getRtlDecoration(pos) {
        return Decoration.line({
            attributes: { "dir": "rtl" },
        }).range(pos);
    }
}, { decorations: v => v.decorations, });
export const HtmlBackgroundPlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = this.computeDecorations(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = this.computeDecorations(update.view);
        }
    }
    computeDecorations(view) {
        const widgets = [];
        for (const { from, to } of view.visibleRanges) {
            syntaxTree(view.state).iterate({ from, to, enter: (node) => {
                    const type = node.type;
                    const to = node.to;
                    if (!(type.name.contains("begin") && type.name.contains("html"))) {
                        return;
                    }
                    const bounds = getHtmlBounds(view.state, to);
                    if (!bounds)
                        return;
                    widgets.push(this.gethtmlBackgroundDecoration(bounds.start, bounds.end));
                }
            });
        }
        return Decoration.set(widgets);
    }
    gethtmlBackgroundDecoration(from, to) {
        return Decoration.mark({
            class: 'moshe-html-background',
        }).range(from, to);
    }
}, { decorations: v => v.decorations, });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yRGVjb3JhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yRGVjb3JhdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUEyQixVQUFVLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpHLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDaEQsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7SUFDL0MsV0FBVyxDQUFnQjtJQUUzQixZQUFZLElBQWdCO1FBQ3hCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxNQUFNLENBQUMsTUFBa0I7UUFDckIsSUFBSSxNQUFNLENBQUMsVUFBVSxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUM5QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUQsQ0FBQztJQUNMLENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxJQUFnQjtRQUMvQixNQUFNLE9BQU8sR0FBd0IsRUFBRSxDQUFDO1FBRXhDLEtBQUssTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDNUMsS0FBSyxJQUFJLEdBQUcsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLEVBQUUsR0FBRyxDQUFDO2dCQUM5QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3hDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBRWpDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO29CQUN0QixPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDbkQsQ0FBQztnQkFFRCxHQUFHLEdBQUcsSUFBSSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDdEIsQ0FBQztRQUNMLENBQUM7UUFFRCxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbkMsQ0FBQztJQUVPLEtBQUssQ0FBQyxPQUFlO1FBQ3pCLHVFQUF1RTtRQUN2RSxNQUFNLGNBQWMsR0FBRyxPQUFPO2FBQ3pCLE9BQU8sQ0FBQyx3QkFBd0IsRUFBRSxFQUFFLENBQUM7YUFDckMsT0FBTyxDQUFDLG9CQUFvQixFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBRXZDLE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztJQUN6QyxDQUFDO0lBRU8sZ0JBQWdCLENBQUMsR0FBVztRQUNoQyxPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUM7WUFDbkIsVUFBVSxFQUFFLEVBQUMsS0FBSyxFQUFFLEtBQUssRUFBRTtTQUM5QixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQ2xCLENBQUM7Q0FDSixFQUFFLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUM7QUFHekMsTUFBTSxDQUFDLE1BQU0sb0JBQW9CLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztJQUNyRCxXQUFXLENBQWdCO0lBRTNCLFlBQVksSUFBZ0I7UUFDeEIsSUFBSSxDQUFDLFdBQVcsR0FBRyxJQUFJLENBQUMsa0JBQWtCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFrQjtRQUNyQixJQUFJLE1BQU0sQ0FBQyxVQUFVLElBQUksTUFBTSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQzlDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUM1RCxDQUFDO0lBQ0wsQ0FBQztJQUVELGtCQUFrQixDQUFDLElBQWdCO1FBQy9CLE1BQU0sT0FBTyxHQUF3QixFQUFFLENBQUM7UUFFeEMsS0FBSyxNQUFNLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN4QyxVQUFVLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLE9BQU8sQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFLEVBQUU7b0JBQ3ZELE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUM7b0JBQ3ZCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxFQUFFLENBQUM7b0JBQ25CLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQzt3QkFDL0QsT0FBTztvQkFDWCxDQUFDO29CQUNELE1BQU0sTUFBTSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDO29CQUM3QyxJQUFJLENBQUMsTUFBTTt3QkFBRSxPQUFPO29CQUNwQixPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUM1RSxDQUFDO2FBQ0osQ0FBQyxDQUFBO1FBR04sQ0FBQztRQUVELE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUNuQyxDQUFDO0lBQ08sMkJBQTJCLENBQUMsSUFBWSxFQUFDLEVBQVU7UUFDdkQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDO1lBQ25CLEtBQUssRUFBRSx1QkFBdUI7U0FDakMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUVKLEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclZpZXcsICBWaWV3VXBkYXRlICxEZWNvcmF0aW9uLERlY29yYXRpb25TZXQsIFZpZXdQbHVnaW4gfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xuaW1wb3J0IHsgUmFuZ2UgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcbmltcG9ydCB7IHN5bnRheFRyZWUgfSBmcm9tIFwiQGNvZGVtaXJyb3IvbGFuZ3VhZ2VcIjtcbmltcG9ydCB7IGdldEh0bWxCb3VuZHMgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XG5leHBvcnQgY29uc3QgcnRsRm9yY2VQbHVnaW4gPSBWaWV3UGx1Z2luLmZyb21DbGFzcyhjbGFzcyAgIHtcbiAgICBkZWNvcmF0aW9uczogRGVjb3JhdGlvblNldDtcblxuICAgIGNvbnN0cnVjdG9yKHZpZXc6IEVkaXRvclZpZXcpIHtcbiAgICAgICAgdGhpcy5kZWNvcmF0aW9ucyA9IHRoaXMuY29tcHV0ZURlY29yYXRpb25zKHZpZXcpO1xuICAgIH1cblxuICAgIHVwZGF0ZSh1cGRhdGU6IFZpZXdVcGRhdGUpIHtcbiAgICAgICAgaWYgKHVwZGF0ZS5kb2NDaGFuZ2VkIHx8IHVwZGF0ZS52aWV3cG9ydENoYW5nZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSB0aGlzLmNvbXB1dGVEZWNvcmF0aW9ucyh1cGRhdGUudmlldyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wdXRlRGVjb3JhdGlvbnModmlldzogRWRpdG9yVmlldyk6IERlY29yYXRpb25TZXQge1xuICAgICAgICBjb25zdCB3aWRnZXRzOiBSYW5nZTxEZWNvcmF0aW9uPltdID0gW107XG5cbiAgICAgICAgZm9yIChjb25zdCB7IGZyb20sIHRvIH0gb2Ygdmlldy52aXNpYmxlUmFuZ2VzKSB7XG4gICAgICAgICAgICBmb3IgKGxldCBwb3MgPSBmcm9tOyBwb3MgPD0gdG87KSB7XG4gICAgICAgICAgICAgICAgY29uc3QgbGluZSA9IHZpZXcuc3RhdGUuZG9jLmxpbmVBdChwb3MpO1xuICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnQgPSBsaW5lLnRleHQudHJpbSgpO1xuXG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuaXNSdGwoY29udGVudCkpIHtcbiAgICAgICAgICAgICAgICAgICAgd2lkZ2V0cy5wdXNoKHRoaXMuZ2V0UnRsRGVjb3JhdGlvbihsaW5lLmZyb20pKTtcbiAgICAgICAgICAgICAgICB9XG5cbiAgICAgICAgICAgICAgICBwb3MgPSBsaW5lLnRvICsgMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBEZWNvcmF0aW9uLnNldCh3aWRnZXRzKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGlzUnRsKGNvbnRlbnQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICAvLyBSZW1vdmUgdW53YW50ZWQgY2hhcmFjdGVycyBhbmQgY2hlY2sgZm9yIEhlYnJldyBsZXR0ZXJzIGF0IHRoZSBzdGFydFxuICAgICAgICBjb25zdCBjbGVhbmVkQ29udGVudCA9IGNvbnRlbnRcbiAgICAgICAgICAgIC5yZXBsYWNlKC9bIzpcXHNcIj0tXFxkXFxbXFxdLlxcK1xcLV0qL2csIFwiXCIpXG4gICAgICAgICAgICAucmVwbGFjZSgvPFthLXpdK1tcXHdcXHNcXGRdKj4vZywgXCJcIik7XG5cbiAgICAgICAgcmV0dXJuIC9eW9eQLdeqXS8udGVzdChjbGVhbmVkQ29udGVudCk7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBnZXRSdGxEZWNvcmF0aW9uKHBvczogbnVtYmVyKTogUmFuZ2U8RGVjb3JhdGlvbj4ge1xuICAgICAgICByZXR1cm4gRGVjb3JhdGlvbi5saW5lKHtcbiAgICAgICAgICAgIGF0dHJpYnV0ZXM6IHtcImRpclwiOiBcInJ0bFwiIH0sXG4gICAgICAgIH0pLnJhbmdlKHBvcyk7XG4gICAgfVxufSwgeyBkZWNvcmF0aW9uczogdiA9PiB2LmRlY29yYXRpb25zLCB9KTtcblxuXG5leHBvcnQgY29uc3QgSHRtbEJhY2tncm91bmRQbHVnaW4gPSBWaWV3UGx1Z2luLmZyb21DbGFzcyhjbGFzcyAgIHtcbiAgICBkZWNvcmF0aW9uczogRGVjb3JhdGlvblNldDtcblxuICAgIGNvbnN0cnVjdG9yKHZpZXc6IEVkaXRvclZpZXcpIHtcbiAgICAgICAgdGhpcy5kZWNvcmF0aW9ucyA9IHRoaXMuY29tcHV0ZURlY29yYXRpb25zKHZpZXcpO1xuICAgIH1cblxuICAgIHVwZGF0ZSh1cGRhdGU6IFZpZXdVcGRhdGUpIHtcbiAgICAgICAgaWYgKHVwZGF0ZS5kb2NDaGFuZ2VkIHx8IHVwZGF0ZS52aWV3cG9ydENoYW5nZWQpIHtcbiAgICAgICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSB0aGlzLmNvbXB1dGVEZWNvcmF0aW9ucyh1cGRhdGUudmlldyk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBjb21wdXRlRGVjb3JhdGlvbnModmlldzogRWRpdG9yVmlldyk6IERlY29yYXRpb25TZXQge1xuICAgICAgICBjb25zdCB3aWRnZXRzOiBSYW5nZTxEZWNvcmF0aW9uPltdID0gW107XG5cbiAgICAgICAgZm9yIChjb25zdCB7IGZyb20sIHRvIH0gb2Ygdmlldy52aXNpYmxlUmFuZ2VzKSB7XG4gICAgICAgICAgICAgICAgc3ludGF4VHJlZSh2aWV3LnN0YXRlKS5pdGVyYXRlKHsgZnJvbSwgdG8sIGVudGVyOiAobm9kZSkgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0eXBlID0gbm9kZS50eXBlO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0byA9IG5vZGUudG87XG4gICAgICAgICAgICAgICAgICAgIGlmICghKHR5cGUubmFtZS5jb250YWlucyhcImJlZ2luXCIpICYmIHR5cGUubmFtZS5jb250YWlucyhcImh0bWxcIikpKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgY29uc3QgYm91bmRzID0gZ2V0SHRtbEJvdW5kcyh2aWV3LnN0YXRlLCB0byk7XG4gICAgICAgICAgICAgICAgICAgIGlmICghYm91bmRzKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIHdpZGdldHMucHVzaCh0aGlzLmdldGh0bWxCYWNrZ3JvdW5kRGVjb3JhdGlvbihib3VuZHMuc3RhcnQsYm91bmRzLmVuZCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG5cbiAgICAgICAgICAgICAgICBcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBEZWNvcmF0aW9uLnNldCh3aWRnZXRzKTtcbiAgICB9XG4gICAgcHJpdmF0ZSBnZXRodG1sQmFja2dyb3VuZERlY29yYXRpb24oZnJvbTogbnVtYmVyLHRvOiBudW1iZXIpOiBSYW5nZTxEZWNvcmF0aW9uPiB7XG4gICAgICAgIHJldHVybiBEZWNvcmF0aW9uLm1hcmsoe1xuICAgICAgICAgICAgY2xhc3M6ICdtb3NoZS1odG1sLWJhY2tncm91bmQnLFxuICAgICAgICB9KS5yYW5nZShmcm9tLCB0byk7XG4gICAgfVxuXG59LCB7IGRlY29yYXRpb25zOiB2ID0+IHYuZGVjb3JhdGlvbnMsIH0pO1xuIl19