import { Decoration, ViewPlugin } from "@codemirror/view";
import { syntaxTree } from "@codemirror/language";
import { getHtmlBounds } from "./utils/context";
export const rtlForcePlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = this.computeDecorations(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = this.computeDecorations(update.view);
        }
    }
    computeDecorations(view) {
        const widgets = [];
        for (const { from, to } of view.visibleRanges) {
            for (let pos = from; pos <= to;) {
                const line = view.state.doc.lineAt(pos);
                const content = line.text.trim();
                if (this.isRtl(content)) {
                    widgets.push(this.getRtlDecoration(line.from));
                }
                pos = line.to + 1;
            }
        }
        return Decoration.set(widgets);
    }
    isRtl(content) {
        // Remove unwanted characters and check for Hebrew letters at the start
        const cleanedContent = content
            .replace(/[#:\s"=-\d\[\].\+\-]*/g, "")
            .replace(/<[a-z]+[\w\s\d]*>/g, "");
        return /^[א-ת]/.test(cleanedContent);
    }
    getRtlDecoration(pos) {
        return Decoration.line({
            attributes: { "dir": "rtl" },
        }).range(pos);
    }
}, { decorations: v => v.decorations, });
export const HtmlBackgroundPlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = this.computeDecorations(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = this.computeDecorations(update.view);
        }
    }
    computeDecorations(view) {
        const widgets = [];
        for (const { from, to } of view.visibleRanges) {
            syntaxTree(view.state).iterate({ from, to, enter: (node) => {
                    const type = node.type;
                    const to = node.to;
                    if (!(type.name.contains("begin") && type.name.contains("html"))) {
                        return;
                    }
                    const bounds = getHtmlBounds(view.state, to);
                    if (!bounds)
                        return;
                    widgets.push(this.gethtmlBackgroundDecoration(bounds.start, bounds.end));
                }
            });
        }
        return Decoration.set(widgets);
    }
    gethtmlBackgroundDecoration(from, to) {
        return Decoration.mark({
            class: 'moshe-html-background',
        }).range(from, to);
    }
}, { decorations: v => v.decorations, });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yRGVjb3JhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZWRpdG9yRGVjb3JhdGlvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUEyQixVQUFVLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBRWpHLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxzQkFBc0IsQ0FBQztBQUNsRCxPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDaEQsTUFBTSxDQUFDLE1BQU0sY0FBYyxHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7SUFDL0MsV0FBVyxDQUFnQjtJQUUzQixZQUFZLElBQWdCO1FBQ3hCLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JELENBQUM7SUFFRCxNQUFNLENBQUMsTUFBa0I7UUFDckIsSUFBSSxNQUFNLENBQUMsVUFBVSxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUM5QyxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDNUQsQ0FBQztJQUNMLENBQUM7SUFFRCxrQkFBa0IsQ0FBQyxJQUFnQjtRQUMvQixNQUFNLE9BQU8sR0FBd0IsRUFBRSxDQUFDO1FBRXhDLEtBQUssTUFBTSxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsSUFBSSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDNUMsS0FBSyxJQUFJLEdBQUcsR0FBRyxJQUFJLEVBQUUsR0FBRyxJQUFJLEVBQUUsR0FBRyxDQUFDO2dCQUM5QixNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ3hDLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENB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QUMsSUFBWSxFQUFDLEVBQVU7UUFDdkQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDO1lBQ25CLEtBQUssRUFBRSx1QkFBdUI7U0FDakMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDdkIsQ0FBQztDQUVKLEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclZpZXcsICBWaWV3VXBkYXRlICxEZWNvcmF0aW9uLERlY29yYXRpb25TZXQsIFZpZXdQbHVnaW4gfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xyXG5pbXBvcnQgeyBSYW5nZSB9IGZyb20gXCJAY29kZW1pcnJvci9zdGF0ZVwiO1xyXG5pbXBvcnQgeyBzeW50YXhUcmVlIH0gZnJvbSBcIkBjb2RlbWlycm9yL2xhbmd1YWdlXCI7XHJcbmltcG9ydCB7IGdldEh0bWxCb3VuZHMgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XHJcbmV4cG9ydCBjb25zdCBydGxGb3JjZVBsdWdpbiA9IFZpZXdQbHVnaW4uZnJvbUNsYXNzKGNsYXNzICAge1xyXG4gICAgZGVjb3JhdGlvbnM6IERlY29yYXRpb25TZXQ7XHJcblxyXG4gICAgY29uc3RydWN0b3IodmlldzogRWRpdG9yVmlldykge1xyXG4gICAgICAgIHRoaXMuZGVjb3JhdGlvbnMgPSB0aGlzLmNvbXB1dGVEZWNvcmF0aW9ucyh2aWV3KTtcclxuICAgIH1cclxuXHJcbiAgICB1cGRhdGUodXBkYXRlOiBWaWV3VXBkYXRlKSB7XHJcbiAgICAgICAgaWYgKHVwZGF0ZS5kb2NDaGFuZ2VkIHx8IHVwZGF0ZS52aWV3cG9ydENoYW5nZWQpIHtcclxuICAgICAgICAgICAgdGhpcy5kZWNvcmF0aW9ucyA9IHRoaXMuY29tcHV0ZURlY29yYXRpb25zKHVwZGF0ZS52aWV3KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgY29tcHV0ZURlY29yYXRpb25zKHZpZXc6IEVkaXRvclZpZXcpOiBEZWNvcmF0aW9uU2V0IHtcclxuICAgICAgICBjb25zdCB3aWRnZXRzOiBSYW5nZTxEZWNvcmF0aW9uPltdID0gW107XHJcblxyXG4gICAgICAgIGZvciAoY29uc3QgeyBmcm9tLCB0byB9IG9mIHZpZXcudmlzaWJsZVJhbmdlcykge1xyXG4gICAgICAgICAgICBmb3IgKGxldCBwb3MgPSBmcm9tOyBwb3MgPD0gdG87KSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBsaW5lID0gdmlldy5zdGF0ZS5kb2MubGluZUF0KHBvcyk7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50ID0gbGluZS50ZXh0LnRyaW0oKTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5pc1J0bChjb250ZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHdpZGdldHMucHVzaCh0aGlzLmdldFJ0bERlY29yYXRpb24obGluZS5mcm9tKSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcG9zID0gbGluZS50byArIDE7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBEZWNvcmF0aW9uLnNldCh3aWRnZXRzKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGlzUnRsKGNvbnRlbnQ6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIC8vIFJlbW92ZSB1bndhbnRlZCBjaGFyYWN0ZXJzIGFuZCBjaGVjayBmb3IgSGVicmV3IGxldHRlcnMgYXQgdGhlIHN0YXJ0XHJcbiAgICAgICAgY29uc3QgY2xlYW5lZENvbnRlbnQgPSBjb250ZW50XHJcbiAgICAgICAgICAgIC5yZXBsYWNlKC9bIzpcXHNcIj0tXFxkXFxbXFxdLlxcK1xcLV0qL2csIFwiXCIpXHJcbiAgICAgICAgICAgIC5yZXBsYWNlKC88W2Etel0rW1xcd1xcc1xcZF0qPi9nLCBcIlwiKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIC9eW9eQLdeqXS8udGVzdChjbGVhbmVkQ29udGVudCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXRSdGxEZWNvcmF0aW9uKHBvczogbnVtYmVyKTogUmFuZ2U8RGVjb3JhdGlvbj4ge1xyXG4gICAgICAgIHJldHVybiBEZWNvcmF0aW9uLmxpbmUoe1xyXG4gICAgICAgICAgICBhdHRyaWJ1dGVzOiB7XCJkaXJcIjogXCJydGxcIiB9LFxyXG4gICAgICAgIH0pLnJhbmdlKHBvcyk7XHJcbiAgICB9XHJcbn0sIHsgZGVjb3JhdGlvbnM6IHYgPT4gdi5kZWNvcmF0aW9ucywgfSk7XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IEh0bWxCYWNrZ3JvdW5kUGx1Z2luID0gVmlld1BsdWdpbi5mcm9tQ2xhc3MoY2xhc3MgICB7XHJcbiAgICBkZWNvcmF0aW9uczogRGVjb3JhdGlvblNldDtcclxuXHJcbiAgICBjb25zdHJ1Y3Rvcih2aWV3OiBFZGl0b3JWaWV3KSB7XHJcbiAgICAgICAgdGhpcy5kZWNvcmF0aW9ucyA9IHRoaXMuY29tcHV0ZURlY29yYXRpb25zKHZpZXcpO1xyXG4gICAgfVxyXG5cclxuICAgIHVwZGF0ZSh1cGRhdGU6IFZpZXdVcGRhdGUpIHtcclxuICAgICAgICBpZiAodXBkYXRlLmRvY0NoYW5nZWQgfHwgdXBkYXRlLnZpZXdwb3J0Q2hhbmdlZCkge1xyXG4gICAgICAgICAgICB0aGlzLmRlY29yYXRpb25zID0gdGhpcy5jb21wdXRlRGVjb3JhdGlvbnModXBkYXRlLnZpZXcpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBjb21wdXRlRGVjb3JhdGlvbnModmlldzogRWRpdG9yVmlldyk6IERlY29yYXRpb25TZXQge1xyXG4gICAgICAgIGNvbnN0IHdpZGdldHM6IFJhbmdlPERlY29yYXRpb24+W10gPSBbXTtcclxuXHJcbiAgICAgICAgZm9yIChjb25zdCB7IGZyb20sIHRvIH0gb2Ygdmlldy52aXNpYmxlUmFuZ2VzKSB7XHJcbiAgICAgICAgICAgICAgICBzeW50YXhUcmVlKHZpZXcuc3RhdGUpLml0ZXJhdGUoeyBmcm9tLCB0bywgZW50ZXI6IChub2RlKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgdHlwZSA9IG5vZGUudHlwZTtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCB0byA9IG5vZGUudG87XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCEodHlwZS5uYW1lLmNvbnRhaW5zKFwiYmVnaW5cIikgJiYgdHlwZS5uYW1lLmNvbnRhaW5zKFwiaHRtbFwiKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjb25zdCBib3VuZHMgPSBnZXRIdG1sQm91bmRzKHZpZXcuc3RhdGUsIHRvKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWJvdW5kcykgcmV0dXJuO1xyXG4gICAgICAgICAgICAgICAgICAgIHdpZGdldHMucHVzaCh0aGlzLmdldGh0bWxCYWNrZ3JvdW5kRGVjb3JhdGlvbihib3VuZHMuc3RhcnQsYm91bmRzLmVuZCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG5cclxuICAgICAgICAgICAgICAgIFxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIERlY29yYXRpb24uc2V0KHdpZGdldHMpO1xyXG4gICAgfVxyXG4gICAgcHJpdmF0ZSBnZXRodG1sQmFja2dyb3VuZERlY29yYXRpb24oZnJvbTogbnVtYmVyLHRvOiBudW1iZXIpOiBSYW5nZTxEZWNvcmF0aW9uPiB7XHJcbiAgICAgICAgcmV0dXJuIERlY29yYXRpb24ubWFyayh7XHJcbiAgICAgICAgICAgIGNsYXNzOiAnbW9zaGUtaHRtbC1iYWNrZ3JvdW5kJyxcclxuICAgICAgICB9KS5yYW5nZShmcm9tLCB0byk7XHJcbiAgICB9XHJcblxyXG59LCB7IGRlY29yYXRpb25zOiB2ID0+IHYuZGVjb3JhdGlvbnMsIH0pO1xyXG4iXX0=