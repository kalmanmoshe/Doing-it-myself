import { EditorView, ViewPlugin, tooltips, } from "@codemirror/view";
import { Prec } from "@codemirror/state";
import { Context } from "./utils/context";
import { getCharacterAtPos, isComposing, replaceRange, setCursor } from "./editor utilities/editor_utils";
import { keyboardAutoReplaceHebrewToEnglishTriggers } from "./staticData/mathParserStaticData";
import { Suggestor } from "./suggestor";
import { RtlForc } from "./editorDecorations";
import { setSelectionToNextTabstop } from "./snippets/snippet_management";
import { runSnippets } from "./features/run_snippets";
import { getLatexSuiteConfig, getLatexSuiteConfigExtension } from "./snippets/codemirror/config";
import { runAutoFraction } from "./features/autofraction";
import { runMatrixShortcuts } from "./features/matrix_shortcuts";
import { shouldTaboutByCloseBracket, tabout } from "./features/tabout";
import { snippetExtensions } from "./snippets/codemirror/extensions";
import { colorPairedBracketsPluginLowestPrec, highlightCursorBracketsPlugin } from "./editor_extensions/highlight_brackets";
import { mkConcealPlugin } from "./editor_extensions/conceal";
import { cursorTooltipBaseTheme, cursorTooltipField, handleMathTooltip } from "./editor_extensions/math_tooltip";
import { removeAllTabstops, tabstopsStateField } from "./snippets/codemirror/tabstops_state_field";
import { clearSnippetQueue, snippetQueueStateField } from "./snippets/codemirror/snippet_queue_state_field";
import { handleUndoRedo, snippetInvertedEffects } from "./snippets/codemirror/history";
/*
class="cm-gutters" aria-hidden="true" style="min-height: 7865px; position: sticky;"
spellcheck="false" autocorrect="off" translate="no" contenteditable="true"

*/
export class EditorExtensions {
    suggestor = new Suggestor();
    setEditorExtensions(app) {
        while (app.editorExtensions.length)
            app.editorExtensions.pop();
        app.editorExtensions.push([
            getLatexSuiteConfigExtension(app.CMSettings),
            Prec.highest(EditorView.domEventHandlers({ "keydown": this.onKeydown })),
            Prec.default(EditorView.domEventHandlers({ "scroll": this.onScroll, "click": this.onClick, "mousemove": this.onMove })),
            EditorView.updateListener.of(handleUpdate),
            snippetExtensions,
            colorPairedBracketsPluginLowestPrec,
            highlightCursorBracketsPlugin.extension,
            cursorTooltipField.extension,
            cursorTooltipBaseTheme,
            tooltips({ position: "absolute" }),
        ]);
        this.registerDecorations(app);
        if (app.CMSettings.concealEnabled) {
            const timeout = app.CMSettings.concealRevealTimeout;
            app.editorExtensions.push(mkConcealPlugin(timeout).extension);
        }
        this.snippetExtensions(app);
        app.registerEditorExtension(app.editorExtensions.flat());
    }
    snippetExtensions(app) {
        app.editorExtensions.push([
            tabstopsStateField.extension,
            snippetQueueStateField.extension,
            snippetInvertedEffects,
        ]);
    }
    registerDecorations(app) {
        app.registerEditorExtension(ViewPlugin.fromClass(RtlForc, {
            decorations: (v) => v.decorations,
        }));
    }
    onScroll(event, view) {
        console.log(this.suggestor);
        this.suggestor.updatePositionFromView(view);
    }
    onMove(event, view) {
        const suggestionItems = document.body.querySelectorAll(".suggestion-item");
        const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
        if (clickedSuggestion) {
            const index = Array.from(suggestionItems).indexOf(clickedSuggestion);
            this.suggestor.selectionIndex = index;
            this.suggestor.updateSelection(suggestionItems);
        }
    }
    onClick(event, view) {
        if (!this.suggestor || !this.suggestor.isSuggesterDeployed()) {
            return;
        }
        const suggestionItems = document.body.querySelectorAll(".suggestion-item");
        // Check if the click is on a suggestion item
        const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
        if (clickedSuggestion) {
            this.suggestor.selectDropdownItem(clickedSuggestion, view);
        }
        const dropdownItem = document.body.querySelector(".suggestion-dropdown");
        const clickedDropdown = Array.from(suggestionItems).find((item) => item.contains(event.target));
        if (!clickedDropdown) {
            this.suggestor.close();
        }
    }
    onKeydown = (event, view) => {
        let key = event.key;
        let trigger;
        const ctx = Context.fromView(view);
        if (!(event.ctrlKey || event.metaKey) && ctx.shouldTranslate()) {
            trigger = keyboardAutoReplaceHebrewToEnglishTriggers.find((trigger2) => trigger2.key === event.key && trigger2.code === event.code);
            key = trigger?.replacement || key;
        }
        if (ctx.codeblockLanguage === "tikz") {
            this.suggestor.open(ctx, view);
        }
        if (this.suggestor.isSuggesterDeployed()) {
            handleDropdownNavigation(event, view, this.suggestor);
        }
        const success = handleKeydown(key, event.shiftKey, event.ctrlKey || event.metaKey, isComposing(view, event), view);
        if (success)
            event.preventDefault();
        else if (key !== event.key && trigger) {
            event.preventDefault();
            key = trigger.replacement;
            replaceRange(view, view.state.selection.main.from, view.state.selection.main.to, key);
            setCursor(view, view.state.selection.main.from + key.length);
        }
    };
}
const handleUpdate = (update) => {
    const settings = getLatexSuiteConfig(update.state);
    // The math tooltip handler is driven by view updates because it utilizes
    // information about visual line, which is not available in EditorState
    if (settings.mathPreviewEnabled) {
        handleMathTooltip(update);
    }
    handleUndoRedo(update);
};
const handleDropdownNavigation = (event, view, suggestor) => {
    const items = suggestor.getAlldropdownItems();
    switch (true) {
        case event.key === "ArrowDown":
            suggestor.selectionIndex = (suggestor.selectionIndex + 1) % items.length;
            suggestor.updateSelection(items);
            event.preventDefault();
            break;
        case event.key === "ArrowUp":
            suggestor.selectionIndex = (suggestor.selectionIndex - 1 + items.length) % items.length;
            suggestor.updateSelection(items);
            event.preventDefault();
            break;
        case event.key === "ArrowLeft" || event.key === "ArrowRight":
            suggestor.close();
            break;
        case event.key === "Backspace":
            suggestor.close();
            //suggestor.deploySuggestor(ctx,view)
            break;
        default:
            break;
    }
    if (event.key === "ArrowDown") {
    }
    else if (event.key === "Enter") {
        const selectedItem = items[suggestor.selectionIndex];
        suggestor.selectDropdownItem(selectedItem, view);
        event.preventDefault();
    } /*else if (event.key === "Escape") {
        dropdown.remove();
        event.preventDefault();
    }*/
};
export const handleKeydown = (key, shiftKey, ctrlKey, isIME, view) => {
    const settings = getLatexSuiteConfig(view);
    const ctx = Context.fromView(view);
    let success = false;
    /*
    * When backspace is pressed, if the cursor is inside an empty inline math,
    * delete both $ symbols, not just the first one.
    */
    if (settings.autoDelete$ && key === "Backspace" && ctx.mode.inMath()) {
        const charAtPos = getCharacterAtPos(view, ctx.pos);
        const charAtPrevPos = getCharacterAtPos(view, ctx.pos - 1);
        if (charAtPos === "$" && charAtPrevPos === "$") {
            replaceRange(view, ctx.pos - 1, ctx.pos + 1, "");
            // Note: not sure if removeAllTabstops is necessary
            removeAllTabstops(view);
            return true;
        }
    }
    if (settings.snippetsEnabled) {
        // Prevent IME from triggering keydown events.
        if (settings.suppressSnippetTriggerOnIME && isIME)
            return;
        // Allows Ctrl + z for undo, instead of triggering a snippet ending with z
        if (!ctrlKey) {
            try {
                success = runSnippets(view, ctx, key);
                if (success)
                    return true;
            }
            catch (e) {
                clearSnippetQueue(view);
                console.error(e);
            }
        }
    }
    if (key === "Tab") {
        success = setSelectionToNextTabstop(view);
        if (success)
            return true;
    }
    if (ctx.mode.strictlyInMath()) {
        if (key === "/") {
            success = runAutoFraction(view, ctx);
            if (success)
                return true;
        }
    }
    if (settings.matrixShortcutsEnabled && ctx.mode.blockMath) {
        if (["Tab", "Enter"].contains(key)) {
            success = runMatrixShortcuts(view, ctx, key, shiftKey);
            if (success)
                return true;
        }
    }
    if (key === "Tab" && shiftKey) {
        success = tabout(view, ctx, -1);
        if (success)
            return true;
    }
    else if (key === "Tab" || shouldTaboutByCloseBracket(view, key)) {
        success = tabout(view, ctx, 1);
        if (success)
            return true;
    }
    return false;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0RWRpdG9yRXh0ZW5zaW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXRFZGl0b3JFeHRlbnNpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUEwQixRQUFRLEdBQUcsTUFBTSxrQkFBa0IsQ0FBQztBQUM3RixPQUFPLEVBQWUsSUFBSSxFQUFZLE1BQU0sbUJBQW1CLENBQUM7QUFDaEUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQzFHLE9BQU8sRUFBRSwwQ0FBMEMsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQy9GLE9BQU8sRUFBRyxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDekMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBRTFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsNEJBQTRCLEVBQUUsTUFBTSw4QkFBOEIsQ0FBQztBQUNqRyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDMUQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sNkJBQTZCLENBQUM7QUFDakUsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxtQ0FBbUMsRUFBRSw2QkFBNkIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQzVILE9BQU8sRUFBRSxlQUFlLEVBQUUs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cEMsT0FBTyxHQUFHLGtCQUFrQixDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ3ZELElBQUksT0FBTztnQkFBRSxPQUFPLElBQUksQ0FBQztRQUMxQixDQUFDO0lBQ0YsQ0FBQztJQUNELElBQUksR0FBRyxLQUFLLEtBQUssSUFBRSxRQUFRLEVBQUUsQ0FBQztRQUM3QixPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQixJQUFJLE9BQU87WUFBRSxPQUFPLElBQUksQ0FBQztJQUMxQixDQUFDO1NBQ0ksSUFBSSxHQUFHLEtBQUssS0FBSyxJQUFJLDBCQUEwQixDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ2pFLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUMsQ0FBQztRQUM5QixJQUFJLE9BQU87WUFBRSxPQUFPLElBQUksQ0FBQztJQUMxQixDQUFDO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTW9zaGUgZnJvbSBcIi4vbWFpblwiO1xyXG5pbXBvcnQgeyBnZXRUaWt6U3VnZ2VzdGlvbnMsIExhdGV4IH0gZnJvbSBcIi4vdXRpbGl0aWVzXCI7XHJcbmltcG9ydCB7IEVkaXRvclZpZXcsIFZpZXdQbHVnaW4sIFZpZXdVcGRhdGUgLERlY29yYXRpb24sIHRvb2x0aXBzLCB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IEVkaXRvclN0YXRlLCBQcmVjLEV4dGVuc2lvbiB9IGZyb20gXCJAY29kZW1pcnJvci9zdGF0ZVwiO1xyXG5pbXBvcnQgeyBDb250ZXh0IH0gZnJvbSBcIi4vdXRpbHMvY29udGV4dFwiO1xyXG5pbXBvcnQgeyBnZXRDaGFyYWN0ZXJBdFBvcywgaXNDb21wb3NpbmcsIHJlcGxhY2VSYW5nZSwgc2V0Q3Vyc29yIH0gZnJvbSBcIi4vZWRpdG9yIHV0aWxpdGllcy9lZGl0b3JfdXRpbHNcIjtcclxuaW1wb3J0IHsga2V5Ym9hcmRBdXRvUmVwbGFjZUhlYnJld1RvRW5nbGlzaFRyaWdnZXJzIH0gZnJvbSBcIi4vc3RhdGljRGF0YS9tYXRoUGFyc2VyU3RhdGljRGF0YVwiO1xyXG5pbXBvcnQgeyAgU3VnZ2VzdG9yIH0gZnJvbSBcIi4vc3VnZ2VzdG9yXCI7XHJcbmltcG9ydCB7IFJ0bEZvcmMgfSBmcm9tIFwiLi9lZGl0b3JEZWNvcmF0aW9uc1wiO1xyXG5pbXBvcnQgeyBzZXRTZWxlY3Rpb25Ub05leHRUYWJzdG9wIH0gZnJvbSBcIi4vc25pcHBldHMvc25pcHBldF9tYW5hZ2VtZW50XCI7XHJcblxyXG5pbXBvcnQgeyBydW5TbmlwcGV0cyB9IGZyb20gXCIuL2ZlYXR1cmVzL3J1bl9zbmlwcGV0c1wiO1xyXG5pbXBvcnQgeyBnZXRMYXRleFN1aXRlQ29uZmlnLCBnZXRMYXRleFN1aXRlQ29uZmlnRXh0ZW5zaW9uIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9jb25maWdcIjtcclxuaW1wb3J0IHsgcnVuQXV0b0ZyYWN0aW9uIH0gZnJvbSBcIi4vZmVhdHVyZXMvYXV0b2ZyYWN0aW9uXCI7XHJcbmltcG9ydCB7IHJ1bk1hdHJpeFNob3J0Y3V0cyB9IGZyb20gXCIuL2ZlYXR1cmVzL21hdHJpeF9zaG9ydGN1dHNcIjtcclxuaW1wb3J0IHsgc2hvdWxkVGFib3V0QnlDbG9zZUJyYWNrZXQsIHRhYm91dCB9IGZyb20gXCIuL2ZlYXR1cmVzL3RhYm91dFwiO1xyXG5pbXBvcnQgeyBzbmlwcGV0RXh0ZW5zaW9ucyB9IGZyb20gXCIuL3NuaXBwZXRzL2NvZGVtaXJyb3IvZXh0ZW5zaW9uc1wiO1xyXG5pbXBvcnQgeyBjb2xvclBhaXJlZEJyYWNrZXRzUGx1Z2luTG93ZXN0UHJlYywgaGlnaGxpZ2h0Q3Vyc29yQnJhY2tldHNQbHVnaW4gfSBmcm9tIFwiLi9lZGl0b3JfZXh0ZW5zaW9ucy9oaWdobGlnaHRfYnJhY2tldHNcIjtcclxuaW1wb3J0IHsgbWtDb25jZWFsUGx1Z2luIH0gZnJvbSBcIi4vZWRpdG9yX2V4dGVuc2lvbnMvY29uY2VhbFwiO1xyXG5pbXBvcnQgeyBjdXJzb3JUb29sdGlwQmFzZVRoZW1lLCBjdXJzb3JUb29sdGlwRmllbGQsIGhhbmRsZU1hdGhUb29sdGlwIH0gZnJvbSBcIi4vZWRpdG9yX2V4dGVuc2lvbnMvbWF0aF90b29sdGlwXCI7XHJcbmltcG9ydCB7IGNvbnRleHQgfSBmcm9tIFwiZXNidWlsZC13YXNtXCI7XHJcbmltcG9ydCB7IHJlbW92ZUFsbFRhYnN0b3BzLCB0YWJzdG9wc1N0YXRlRmllbGQgfSBmcm9tIFwiLi9zbmlwcGV0cy9jb2RlbWlycm9yL3RhYnN0b3BzX3N0YXRlX2ZpZWxkXCI7XHJcbmltcG9ydCB7IGNsZWFyU25pcHBldFF1ZXVlLCBzbmlwcGV0UXVldWVTdGF0ZUZpZWxkIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XHJcbmltcG9ydCB7IGhhbmRsZVVuZG9SZWRvLCBzbmlwcGV0SW52ZXJ0ZWRFZmZlY3RzIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9oaXN0b3J5XCI7XHJcblxyXG5cclxuLypcclxuY2xhc3M9XCJjbS1ndXR0ZXJzXCIgYXJpYS1oaWRkZW49XCJ0cnVlXCIgc3R5bGU9XCJtaW4taGVpZ2h0OiA3ODY1cHg7IHBvc2l0aW9uOiBzdGlja3k7XCJcclxuc3BlbGxjaGVjaz1cImZhbHNlXCIgYXV0b2NvcnJlY3Q9XCJvZmZcIiB0cmFuc2xhdGU9XCJub1wiIGNvbnRlbnRlZGl0YWJsZT1cInRydWVcIlxyXG5cclxuKi9cclxuXHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIEVkaXRvckV4dGVuc2lvbnMge1xyXG4gICAgcHJpdmF0ZSBzdWdnZXN0b3I6IFN1Z2dlc3RvciA9IG5ldyBTdWdnZXN0b3IoKTtcclxuICAgIHNldEVkaXRvckV4dGVuc2lvbnMoYXBwOiBNb3NoZSkge1xyXG5cdFx0d2hpbGUgKGFwcC5lZGl0b3JFeHRlbnNpb25zLmxlbmd0aCkgYXBwLmVkaXRvckV4dGVuc2lvbnMucG9wKCk7XHJcblx0XHRcclxuXHRcdGFwcC5lZGl0b3JFeHRlbnNpb25zLnB1c2goW1xyXG5cdFx0XHRnZXRMYXRleFN1aXRlQ29uZmlnRXh0ZW5zaW9uKGFwcC5DTVNldHRpbmdzKSxcclxuXHRcdFx0UHJlYy5oaWdoZXN0KEVkaXRvclZpZXcuZG9tRXZlbnRIYW5kbGVycyh7IFwia2V5ZG93blwiOiB0aGlzLm9uS2V5ZG93biB9KSksXHJcbiAgXHRcdFx0UHJlYy5kZWZhdWx0KEVkaXRvclZpZXcuZG9tRXZlbnRIYW5kbGVycyh7IFwic2Nyb2xsXCI6IHRoaXMub25TY3JvbGwsIFwiY2xpY2tcIjogdGhpcy5vbkNsaWNrLCBcIm1vdXNlbW92ZVwiOiB0aGlzLm9uTW92ZSB9KSksXHJcblx0XHRcdEVkaXRvclZpZXcudXBkYXRlTGlzdGVuZXIub2YoaGFuZGxlVXBkYXRlKSxcclxuXHRcdFx0c25pcHBldEV4dGVuc2lvbnMsXHJcblx0XHRcdGNvbG9yUGFpcmVkQnJhY2tldHNQbHVnaW5Mb3dlc3RQcmVjLFxyXG5cdFx0XHRoaWdobGlnaHRDdXJzb3JCcmFja2V0c1BsdWdpbi5leHRlbnNpb24sXHJcblx0XHRcdGN1cnNvclRvb2x0aXBGaWVsZC5leHRlbnNpb24sXHJcblx0XHRcdGN1cnNvclRvb2x0aXBCYXNlVGhlbWUsXHJcblx0XHRcdHRvb2x0aXBzKHsgcG9zaXRpb246IFwiYWJzb2x1dGVcIiB9KSxcclxuXHRcdF0pO1xyXG5cdFx0dGhpcy5yZWdpc3RlckRlY29yYXRpb25zKGFwcClcclxuXHJcblx0XHRpZiAoYXBwLkNNU2V0dGluZ3MuY29uY2VhbEVuYWJsZWQpIHtcclxuXHRcdFx0Y29uc3QgdGltZW91dCA9IGFwcC5DTVNldHRpbmdzLmNvbmNlYWxSZXZlYWxUaW1lb3V0O1xyXG5cdFx0XHRhcHAuZWRpdG9yRXh0ZW5zaW9ucy5wdXNoKG1rQ29uY2VhbFBsdWdpbih0aW1lb3V0KS5leHRlbnNpb24pO1xyXG5cdFx0fVxyXG5cdFx0dGhpcy5zbmlwcGV0RXh0ZW5zaW9ucyhhcHApO1xyXG5cclxuXHRcdGFwcC5yZWdpc3RlckVkaXRvckV4dGVuc2lvbihhcHAuZWRpdG9yRXh0ZW5zaW9ucy5mbGF0KCkpO1xyXG5cdH1cclxuICAgIHByaXZhdGUgc25pcHBldEV4dGVuc2lvbnMoYXBwOiBNb3NoZSkge1xyXG5cdFx0YXBwLmVkaXRvckV4dGVuc2lvbnMucHVzaChbXHJcblx0XHRcdHRhYnN0b3BzU3RhdGVGaWVsZC5leHRlbnNpb24sXHJcblx0XHRcdHNuaXBwZXRRdWV1ZVN0YXRlRmllbGQuZXh0ZW5zaW9uLFxyXG5cdFx0XHRzbmlwcGV0SW52ZXJ0ZWRFZmZlY3RzLFxyXG5cdFx0XSk7XHJcblx0fVxyXG4gICAgcHJpdmF0ZSByZWdpc3RlckRlY29yYXRpb25zKGFwcDogTW9zaGUpe1xyXG4gICAgICAgIGFwcC5yZWdpc3RlckVkaXRvckV4dGVuc2lvbihcclxuICAgICAgICAgICAgVmlld1BsdWdpbi5mcm9tQ2xhc3MoUnRsRm9yYywge1xyXG4gICAgICAgICAgICBkZWNvcmF0aW9uczogKHYpID0+IHYuZGVjb3JhdGlvbnMsXHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgKSk7XHJcbiAgICB9XHJcblx0cHJpdmF0ZSBvblNjcm9sbCAoZXZlbnQ6IEV2ZW50LHZpZXc6IEVkaXRvclZpZXcpIHtcclxuXHRcdGNvbnNvbGUubG9nKHRoaXMuc3VnZ2VzdG9yKVxyXG5cdFx0dGhpcy5zdWdnZXN0b3IudXBkYXRlUG9zaXRpb25Gcm9tVmlldyh2aWV3KTtcclxuXHR9XHJcblx0cHJpdmF0ZSBvbk1vdmUoZXZlbnQ6IE1vdXNlRXZlbnQsdmlldzogRWRpdG9yVmlldyl7XHJcblx0XHRjb25zdCBzdWdnZXN0aW9uSXRlbXMgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3VnZ2VzdGlvbi1pdGVtXCIpO1xyXG5cclxuXHRcdGNvbnN0IGNsaWNrZWRTdWdnZXN0aW9uID0gQXJyYXkuZnJvbShzdWdnZXN0aW9uSXRlbXMpLmZpbmQoKGl0ZW0pID0+XHJcblx0XHRcdGl0ZW0uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpXHJcblx0XHQpO1xyXG5cdFx0aWYgKGNsaWNrZWRTdWdnZXN0aW9uKSB7XHJcblx0XHRcdGNvbnN0IGluZGV4ID0gQXJyYXkuZnJvbShzdWdnZXN0aW9uSXRlbXMpLmluZGV4T2YoY2xpY2tlZFN1Z2dlc3Rpb24pO1xyXG5cdFx0XHR0aGlzLnN1Z2dlc3Rvci5zZWxlY3Rpb25JbmRleD1pbmRleFxyXG5cdFx0XHR0aGlzLnN1Z2dlc3Rvci51cGRhdGVTZWxlY3Rpb24oc3VnZ2VzdGlvbkl0ZW1zKVxyXG5cdFx0fVxyXG5cdH1cclxuXHRwcml2YXRlIG9uQ2xpY2sgKGV2ZW50OiBNb3VzZUV2ZW50LHZpZXc6IEVkaXRvclZpZXcpIHtcclxuXHRcdGlmKCF0aGlzLnN1Z2dlc3Rvcnx8IXRoaXMuc3VnZ2VzdG9yLmlzU3VnZ2VzdGVyRGVwbG95ZWQoKSl7cmV0dXJufVxyXG5cdFx0Y29uc3Qgc3VnZ2VzdGlvbkl0ZW1zID0gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yQWxsKFwiLnN1Z2dlc3Rpb24taXRlbVwiKTtcclxuXHRcclxuXHRcdC8vIENoZWNrIGlmIHRoZSBjbGljayBpcyBvbiBhIHN1Z2dlc3Rpb24gaXRlbVxyXG5cdFx0Y29uc3QgY2xpY2tlZFN1Z2dlc3Rpb24gPSBBcnJheS5mcm9tKHN1Z2dlc3Rpb25JdGVtcykuZmluZCgoaXRlbSkgPT5cclxuXHRcdFx0aXRlbS5jb250YWlucyhldmVudC50YXJnZXQgYXMgTm9kZSlcclxuXHRcdCk7XHJcblx0XHRpZiAoY2xpY2tlZFN1Z2dlc3Rpb24pIHtcclxuXHRcdFx0dGhpcy5zdWdnZXN0b3Iuc2VsZWN0RHJvcGRvd25JdGVtKGNsaWNrZWRTdWdnZXN0aW9uLHZpZXcpO1xyXG5cdFx0fVxyXG5cdFx0Y29uc3QgZHJvcGRvd25JdGVtID0gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik7XHJcblx0XHRjb25zdCBjbGlja2VkRHJvcGRvd24gPSBBcnJheS5mcm9tKHN1Z2dlc3Rpb25JdGVtcykuZmluZCgoaXRlbSkgPT5cclxuXHRcdFx0aXRlbS5jb250YWlucyhldmVudC50YXJnZXQgYXMgTm9kZSlcclxuXHRcdCk7XHJcblx0XHRpZighY2xpY2tlZERyb3Bkb3duKXtcclxuXHRcdFx0dGhpcy5zdWdnZXN0b3IuY2xvc2UoKVxyXG5cdFx0fVxyXG5cdH1cclxuXHRwcml2YXRlIG9uS2V5ZG93biA9IChldmVudDogS2V5Ym9hcmRFdmVudCwgdmlldzogRWRpdG9yVmlldykgPT4ge1xyXG5cdFx0bGV0IGtleSA9IGV2ZW50LmtleTtcclxuXHRcdGxldCB0cmlnZ2VyXHJcblx0XHRjb25zdCBjdHggPSBDb250ZXh0LmZyb21WaWV3KHZpZXcpO1xyXG5cdFx0aWYgKCEoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5KSAmJiBjdHguc2hvdWxkVHJhbnNsYXRlKCkpIHtcclxuXHRcdCAgdHJpZ2dlciA9IGtleWJvYXJkQXV0b1JlcGxhY2VIZWJyZXdUb0VuZ2xpc2hUcmlnZ2Vycy5maW5kKCh0cmlnZ2VyMikgPT4gdHJpZ2dlcjIua2V5ID09PSBldmVudC5rZXkgJiYgdHJpZ2dlcjIuY29kZSA9PT0gZXZlbnQuY29kZSk7XHJcblx0XHQgIGtleSA9IHRyaWdnZXI/LnJlcGxhY2VtZW50fHxrZXk7XHJcblx0XHR9XHJcblx0XHRpZihjdHguY29kZWJsb2NrTGFuZ3VhZ2U9PT1cInRpa3pcIil7XHJcblx0XHRcdHRoaXMuc3VnZ2VzdG9yLm9wZW4oY3R4LHZpZXcpXHJcblx0XHR9XHJcblx0XHRpZih0aGlzLnN1Z2dlc3Rvci5pc1N1Z2dlc3RlckRlcGxveWVkKCkpe1xyXG5cdFx0XHRoYW5kbGVEcm9wZG93bk5hdmlnYXRpb24oZXZlbnQsdmlldyx0aGlzLnN1Z2dlc3RvcilcclxuXHRcdH1cclxuXHRcdFxyXG5cdFx0Y29uc3Qgc3VjY2VzcyA9IGhhbmRsZUtleWRvd24oa2V5LCBldmVudC5zaGlmdEtleSwgZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5LCBpc0NvbXBvc2luZyh2aWV3LCBldmVudCksIHZpZXcpO1xyXG5cdFx0aWYgKHN1Y2Nlc3MpIFxyXG5cdFx0ICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0ZWxzZSBpZiAoa2V5ICE9PSBldmVudC5rZXkmJnRyaWdnZXIpIHtcclxuXHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuXHRcdFx0a2V5ID0gdHJpZ2dlci5yZXBsYWNlbWVudDtcclxuXHRcdFx0cmVwbGFjZVJhbmdlKHZpZXcsdmlldy5zdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tLHZpZXcuc3RhdGUuc2VsZWN0aW9uLm1haW4udG8sa2V5KVxyXG5cdFx0XHRzZXRDdXJzb3Iodmlldyx2aWV3LnN0YXRlLnNlbGVjdGlvbi5tYWluLmZyb20ra2V5Lmxlbmd0aClcclxuXHQgIH1cclxuXHR9O1xyXG59XHJcblxyXG5jb25zdCBoYW5kbGVVcGRhdGUgPSAodXBkYXRlOiBWaWV3VXBkYXRlKSA9PiB7XHJcblx0Y29uc3Qgc2V0dGluZ3MgPSBnZXRMYXRleFN1aXRlQ29uZmlnKHVwZGF0ZS5zdGF0ZSk7XHJcblxyXG5cdC8vIFRoZSBtYXRoIHRvb2x0aXAgaGFuZGxlciBpcyBkcml2ZW4gYnkgdmlldyB1cGRhdGVzIGJlY2F1c2UgaXQgdXRpbGl6ZXNcclxuXHQvLyBpbmZvcm1hdGlvbiBhYm91dCB2aXN1YWwgbGluZSwgd2hpY2ggaXMgbm90IGF2YWlsYWJsZSBpbiBFZGl0b3JTdGF0ZVxyXG5cdGlmIChzZXR0aW5ncy5tYXRoUHJldmlld0VuYWJsZWQpIHtcclxuXHRcdGhhbmRsZU1hdGhUb29sdGlwKHVwZGF0ZSk7XHJcblx0fVxyXG5cclxuXHRoYW5kbGVVbmRvUmVkbyh1cGRhdGUpO1xyXG59XHJcblxyXG5jb25zdCBoYW5kbGVEcm9wZG93bk5hdmlnYXRpb249KGV2ZW50OiBLZXlib2FyZEV2ZW50LHZpZXc6RWRpdG9yVmlldyxzdWdnZXN0b3I6IFN1Z2dlc3Rvcik9PntcclxuXHRjb25zdCBpdGVtcyA9IHN1Z2dlc3Rvci5nZXRBbGxkcm9wZG93bkl0ZW1zKCk7XHJcblx0c3dpdGNoICh0cnVlKSB7XHJcblx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd0Rvd25cIjpcclxuXHRcdFx0c3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4ID0gKHN1Z2dlc3Rvci5zZWxlY3Rpb25JbmRleCArIDEpICUgaXRlbXMubGVuZ3RoO1xyXG5cdFx0XHRzdWdnZXN0b3IudXBkYXRlU2VsZWN0aW9uKGl0ZW1zKTtcclxuXHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuXHRcdFx0YnJlYWs7XHJcblx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd1VwXCI6XHJcblx0XHRcdHN1Z2dlc3Rvci5zZWxlY3Rpb25JbmRleCA9IChzdWdnZXN0b3Iuc2VsZWN0aW9uSW5kZXggLSAxICsgaXRlbXMubGVuZ3RoKSAlIGl0ZW1zLmxlbmd0aDtcclxuXHRcdFx0c3VnZ2VzdG9yLnVwZGF0ZVNlbGVjdGlvbihpdGVtcyk7XHJcblx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0XHRcdGJyZWFrO1xyXG5cdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiQXJyb3dMZWZ0XCJ8fGV2ZW50LmtleSA9PT0gXCJBcnJvd1JpZ2h0XCI6XHJcblx0XHRcdHN1Z2dlc3Rvci5jbG9zZSgpO1xyXG5cdFx0XHRicmVhaztcclxuXHRcdGNhc2UgZXZlbnQua2V5ID09PSBcIkJhY2tzcGFjZVwiOlxyXG5cdFx0XHRzdWdnZXN0b3IuY2xvc2UoKTtcclxuXHRcdFx0Ly9zdWdnZXN0b3IuZGVwbG95U3VnZ2VzdG9yKGN0eCx2aWV3KVxyXG5cdFx0XHRicmVhaztcclxuXHRcdGRlZmF1bHQ6XHJcblx0XHRcdGJyZWFrO1xyXG5cdH1cclxuXHRpZiAoZXZlbnQua2V5ID09PSBcIkFycm93RG93blwiKSB7XHJcblx0XHRcclxuXHR9ZWxzZSBpZiAoZXZlbnQua2V5ID09PSBcIkVudGVyXCIpIHtcclxuXHRcdGNvbnN0IHNlbGVjdGVkSXRlbSA9IGl0ZW1zW3N1Z2dlc3Rvci5zZWxlY3Rpb25JbmRleF07XHJcblx0XHRzdWdnZXN0b3Iuc2VsZWN0RHJvcGRvd25JdGVtKHNlbGVjdGVkSXRlbSx2aWV3KTtcclxuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0fSAvKmVsc2UgaWYgKGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIikge1xyXG5cdFx0ZHJvcGRvd24ucmVtb3ZlKCk7XHJcblx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdH0qL1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IGhhbmRsZUtleWRvd24gPSAoa2V5OiBzdHJpbmcsIHNoaWZ0S2V5OiBib29sZWFuLCBjdHJsS2V5OiBib29sZWFuLCBpc0lNRTogYm9vbGVhbiwgdmlldzogRWRpdG9yVmlldykgPT4ge1xyXG5cdGNvbnN0IHNldHRpbmdzID0gZ2V0TGF0ZXhTdWl0ZUNvbmZpZyh2aWV3KTtcclxuXHRjb25zdCBjdHggPSBDb250ZXh0LmZyb21WaWV3KHZpZXcpO1xyXG5cclxuXHRsZXQgc3VjY2VzcyA9IGZhbHNlO1xyXG5cclxuXHQvKlxyXG5cdCogV2hlbiBiYWNrc3BhY2UgaXMgcHJlc3NlZCwgaWYgdGhlIGN1cnNvciBpcyBpbnNpZGUgYW4gZW1wdHkgaW5saW5lIG1hdGgsXHJcblx0KiBkZWxldGUgYm90aCAkIHN5bWJvbHMsIG5vdCBqdXN0IHRoZSBmaXJzdCBvbmUuXHJcblx0Ki9cclxuXHRpZiAoc2V0dGluZ3MuYXV0b0RlbGV0ZSQgJiYga2V5ID09PSBcIkJhY2tzcGFjZVwiICYmIGN0eC5tb2RlLmluTWF0aCgpKSB7XHJcblx0XHRjb25zdCBjaGFyQXRQb3MgPSBnZXRDaGFyYWN0ZXJBdFBvcyh2aWV3LCBjdHgucG9zKTtcclxuXHRcdGNvbnN0IGNoYXJBdFByZXZQb3MgPSBnZXRDaGFyYWN0ZXJBdFBvcyh2aWV3LCBjdHgucG9zIC0gMSk7XHJcblxyXG5cdFx0aWYgKGNoYXJBdFBvcyA9PT0gXCIkXCIgJiYgY2hhckF0UHJldlBvcyA9PT0gXCIkXCIpIHtcclxuXHRcdFx0cmVwbGFjZVJhbmdlKHZpZXcsIGN0eC5wb3MgLSAxLCBjdHgucG9zICsgMSwgXCJcIik7XHJcblx0XHRcdC8vIE5vdGU6IG5vdCBzdXJlIGlmIHJlbW92ZUFsbFRhYnN0b3BzIGlzIG5lY2Vzc2FyeVxyXG5cdFx0XHRyZW1vdmVBbGxUYWJzdG9wcyh2aWV3KTtcclxuXHRcdFx0cmV0dXJuIHRydWU7XHJcblx0XHR9XHJcblx0fVxyXG5cdFxyXG5cdGlmIChzZXR0aW5ncy5zbmlwcGV0c0VuYWJsZWQpIHtcclxuXHJcblx0XHQvLyBQcmV2ZW50IElNRSBmcm9tIHRyaWdnZXJpbmcga2V5ZG93biBldmVudHMuXHJcblx0XHRpZiAoc2V0dGluZ3Muc3VwcHJlc3NTbmlwcGV0VHJpZ2dlck9uSU1FICYmIGlzSU1FKSByZXR1cm47XHJcblxyXG5cdFx0Ly8gQWxsb3dzIEN0cmwgKyB6IGZvciB1bmRvLCBpbnN0ZWFkIG9mIHRyaWdnZXJpbmcgYSBzbmlwcGV0IGVuZGluZyB3aXRoIHpcclxuXHRcdGlmICghY3RybEtleSkge1xyXG5cdFx0XHR0cnkge1xyXG5cdFx0XHRcdHN1Y2Nlc3MgPSBydW5TbmlwcGV0cyh2aWV3LCBjdHgsIGtleSk7XHJcblx0XHRcdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xyXG5cdFx0XHR9XHJcblx0XHRcdGNhdGNoIChlKSB7XHJcblx0XHRcdFx0Y2xlYXJTbmlwcGV0UXVldWUodmlldyk7XHJcblx0XHRcdFx0Y29uc29sZS5lcnJvcihlKTtcclxuXHRcdFx0fVxyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0aWYgKGtleSA9PT0gXCJUYWJcIikge1xyXG5cdFx0c3VjY2VzcyA9IHNldFNlbGVjdGlvblRvTmV4dFRhYnN0b3Aodmlldyk7XHJcblxyXG5cdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHRpZiAoY3R4Lm1vZGUuc3RyaWN0bHlJbk1hdGgoKSkge1xyXG5cdFx0aWYgKGtleSA9PT0gXCIvXCIpIHtcclxuXHRcdFx0c3VjY2VzcyA9IHJ1bkF1dG9GcmFjdGlvbih2aWV3LCBjdHgpO1xyXG5cclxuXHRcdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0aWYgKHNldHRpbmdzLm1hdHJpeFNob3J0Y3V0c0VuYWJsZWQgJiYgY3R4Lm1vZGUuYmxvY2tNYXRoKSB7XHJcblx0XHRpZiAoW1wiVGFiXCIsIFwiRW50ZXJcIl0uY29udGFpbnMoa2V5KSkge1xyXG5cdFx0XHRzdWNjZXNzID0gcnVuTWF0cml4U2hvcnRjdXRzKHZpZXcsIGN0eCwga2V5LCBzaGlmdEtleSk7XHJcblx0XHRcdGlmIChzdWNjZXNzKSByZXR1cm4gdHJ1ZTtcclxuXHRcdH1cclxuXHR9XHJcblx0aWYgKGtleSA9PT0gXCJUYWJcIiYmc2hpZnRLZXkpIHtcclxuXHRcdHN1Y2Nlc3MgPSB0YWJvdXQodmlldywgY3R4LC0xKTtcclxuXHRcdGlmIChzdWNjZXNzKSByZXR1cm4gdHJ1ZTtcclxuXHR9XHJcblx0ZWxzZSBpZiAoa2V5ID09PSBcIlRhYlwiIHx8IHNob3VsZFRhYm91dEJ5Q2xvc2VCcmFja2V0KHZpZXcsIGtleSkpIHtcclxuXHRcdHN1Y2Nlc3MgPSB0YWJvdXQodmlldywgY3R4LDEpO1xyXG5cdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIGZhbHNlO1xyXG59Il19