import { Context } from "./utils/context";
import { getCharacterAtPos, isComposing, replaceRange, setCursor } from "./editor utilities/editor_utils";
import { keyboardAutoReplaceHebrewToEnglishTriggers } from "./staticData/mathParserStaticData";
import { setSelectionToNextTabstop } from "./snippets/snippet_management";
import { runSnippets } from "./features/run_snippets";
import { getLatexSuiteConfig } from "./snippets/codemirror/config";
import { runAutoFraction } from "./features/autofraction";
import { runMatrixShortcuts } from "./features/matrix_shortcuts";
import { shouldTaboutByCloseBracket, tabout } from "./features/tabout";
import { handleMathTooltip } from "./editor_extensions/math_tooltip";
import { removeAllTabstops } from "./snippets/codemirror/tabstops_state_field";
import { clearSnippetQueue } from "./snippets/codemirror/snippet_queue_state_field";
import { handleUndoRedo } from "./snippets/codemirror/history";
import { suggestor } from "./suggestor";
/*
class="cm-gutters" aria-hidden="true" style="min-height: 7865px; position: sticky;"
spellcheck="false" autocorrect="off" translate="no" contenteditable="true"

*/
export const onScroll = (event, view) => {
    suggestor.updatePositionFromView(view);
};
export const onMove = (event, view) => {
    if (!suggestor.isSuggesterDeployed()) {
        return;
    }
    const suggestionItems = document.body.querySelectorAll(".suggestion-item");
    const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (clickedSuggestion) {
        const index = Array.from(suggestionItems).indexOf(clickedSuggestion);
        suggestor.setSelectionIndex(index);
    }
};
export const onClick = (event, view) => {
    if (!suggestor.isSuggesterDeployed()) {
        return;
    }
    const suggestionItems = document.body.querySelectorAll(".suggestion-item");
    // Check if the click is on a suggestion item
    const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (clickedSuggestion) {
        suggestor.selectDropdownItem(view);
    }
    const dropdownItem = document.body.querySelector(".suggestion-dropdown");
    const clickedDropdown = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (!clickedDropdown) {
        suggestor.close();
    }
};
export const onKeydown = (event, view) => {
    let key = event.key;
    let trigger;
    const ctx = Context.fromView(view);
    if (!(event.ctrlKey || event.metaKey) && ctx.shouldTranslate()) {
        trigger = keyboardAutoReplaceHebrewToEnglishTriggers.find((trigger2) => trigger2.key === event.key && trigger2.code === event.code);
        key = trigger?.replacement || key;
    }
    if (suggestor.isSuggesterDeployed()) {
        suggestor.handleDropdownNavigation(event, view);
    }
    const success = handleKeydown(key, event.shiftKey, event.ctrlKey || event.metaKey, isComposing(view, event), view, ctx);
    if (success)
        event.preventDefault();
    else if (key !== event.key && trigger) {
        event.preventDefault();
        key = trigger.replacement;
        replaceRange(view, view.state.selection.main.from, view.state.selection.main.to, key);
        setCursor(view, view.state.selection.main.from + key.length);
    }
};
export const onTransaction = (update) => {
    if (update.transactions[0] && update.transactions[0].docChanged) {
        const ctx = Context.fromView(update.view);
        if (ctx.codeblockLanguage === "tikz") {
            suggestor.open(ctx, update.view);
        }
    }
    const settings = getLatexSuiteConfig(update.state);
    // The math tooltip handler is driven by view updates because it utilizes
    // information about visual line, which is not available in EditorState
    if (settings.mathPreviewEnabled) {
        handleMathTooltip(update);
    }
    handleUndoRedo(update);
};
export const handleKeydown = (key, shiftKey, ctrlKey, isIME, view, ctx) => {
    const settings = getLatexSuiteConfig(view);
    let success = false;
    /*
    * When backspace is pressed, if the cursor is inside an empty inline math,
    * delete both $ symbols, not just the first one.
    */
    if (settings.autoDelete$ && key === "Backspace" && ctx.mode.inMath()) {
        const charAtPos = getCharacterAtPos(view, ctx.pos);
        const charAtPrevPos = getCharacterAtPos(view, ctx.pos - 1);
        if (charAtPos === "$" && charAtPrevPos === "$") {
            replaceRange(view, ctx.pos - 1, ctx.pos + 1, "");
            // Note: not sure if removeAllTabstops is necessary
            removeAllTabstops(view);
            return true;
        }
    }
    if (settings.snippetsEnabled) {
        // Prevent IME from triggering keydown events.
        if (settings.suppressSnippetTriggerOnIME && isIME)
            return;
        // Allows Ctrl + z for undo, instead of triggering a snippet ending with z
        if (!ctrlKey) {
            try {
                success = runSnippets(view, ctx, key);
                if (success)
                    return true;
            }
            catch (e) {
                clearSnippetQueue(view);
                console.error(e);
            }
        }
    }
    if (key === "Tab") {
        success = setSelectionToNextTabstop(view);
        if (success)
            return true;
    }
    if (ctx.mode.strictlyInMath()) {
        if (key === "/") {
            success = runAutoFraction(view, ctx);
            if (success)
                return true;
        }
    }
    if (settings.matrixShortcutsEnabled && ctx.mode.blockMath) {
        if (["Tab", "Enter"].contains(key)) {
            success = runMatrixShortcuts(view, ctx, key, shiftKey);
            if (success)
                return true;
        }
    }
    if (key === "Tab" && shiftKey) {
        success = tabout(view, ctx, -1);
        if (success)
            return true;
    }
    else if (key === "Tab" || shouldTaboutByCloseBracket(view, key)) {
        success = tabout(view, ctx, 1);
        if (success)
            return true;
    }
    return false;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0RWRpdG9yRXh0ZW5zaW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXRFZGl0b3JFeHRlbnNpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUMxRyxPQUFPLEVBQUUsMENBQTBDLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUMvRixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUxRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG1CQUFtQixFQUFnQyxNQUFNLDhCQUE4QixDQUFDO0FBQ2pHLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDdkUsT0FBTyxFQUE4QyxpQkFBaUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ2pILE9BQU8sRUFBRSxpQkFBaUIsRUFBc0IsTUFBTSw0Q0FBNEMsQ0FBQztBQUNuRyxPQUFPLEVBQUUsaUJBQWlCLEVBQTBCLE1BQU0saURBQWlELENBQUM7QUFDNUcsT0FBTyxFQUFFLGNBQWMsRUFBMEIsTUFBTSwrQkFBK0IsQ0FBQztBQUN2RixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBR3hDOzs7O0VBSUU7QUFFRixNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUMsQ0FBQyxLQUFZLEVBQUMsSUFBZ0IsRUFBQyxFQUFFO0lBQ3RELFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxJQUFJ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QUssRUFBRSxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNwQyxPQUFPLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsUUFBUSxDQUFDLENBQUM7WUFDdkQsSUFBSSxPQUFPO2dCQUFFLE9BQU8sSUFBSSxDQUFDO1FBQzFCLENBQUM7SUFDRixDQUFDO0lBQ0QsSUFBSSxHQUFHLEtBQUssS0FBSyxJQUFFLFFBQVEsRUFBRSxDQUFDO1FBQzdCLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9CLElBQUksT0FBTztZQUFFLE9BQU8sSUFBSSxDQUFDO0lBQzFCLENBQUM7U0FDSSxJQUFJLEdBQUcsS0FBSyxLQUFLLElBQUksMEJBQTBCLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDakUsT0FBTyxHQUFHLE1BQU0sQ0FBQyxJQUFJLEVBQUUsR0FBRyxFQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzlCLElBQUksT0FBTztZQUFFLE9BQU8sSUFBSSxDQUFDO0lBQzFCLENBQUM7SUFFRCxPQUFPLEtBQUssQ0FBQztBQUNkLENBQUMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIlxuaW1wb3J0IHsgRWRpdG9yVmlldywgVmlld1BsdWdpbiwgVmlld1VwZGF0ZSAsRGVjb3JhdGlvbiwgdG9vbHRpcHMsIH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XG5pbXBvcnQgeyBnZXRDaGFyYWN0ZXJBdFBvcywgaXNDb21wb3NpbmcsIHJlcGxhY2VSYW5nZSwgc2V0Q3Vyc29yIH0gZnJvbSBcIi4vZWRpdG9yIHV0aWxpdGllcy9lZGl0b3JfdXRpbHNcIjtcbmltcG9ydCB7IGtleWJvYXJkQXV0b1JlcGxhY2VIZWJyZXdUb0VuZ2xpc2hUcmlnZ2VycyB9IGZyb20gXCIuL3N0YXRpY0RhdGEvbWF0aFBhcnNlclN0YXRpY0RhdGFcIjtcbmltcG9ydCB7IHNldFNlbGVjdGlvblRvTmV4dFRhYnN0b3AgfSBmcm9tIFwiLi9zbmlwcGV0cy9zbmlwcGV0X21hbmFnZW1lbnRcIjtcblxuaW1wb3J0IHsgcnVuU25pcHBldHMgfSBmcm9tIFwiLi9mZWF0dXJlcy9ydW5fc25pcHBldHNcIjtcbmltcG9ydCB7IGdldExhdGV4U3VpdGVDb25maWcsIGdldExhdGV4U3VpdGVDb25maWdFeHRlbnNpb24gfSBmcm9tIFwiLi9zbmlwcGV0cy9jb2RlbWlycm9yL2NvbmZpZ1wiO1xuaW1wb3J0IHsgcnVuQXV0b0ZyYWN0aW9uIH0gZnJvbSBcIi4vZmVhdHVyZXMvYXV0b2ZyYWN0aW9uXCI7XG5pbXBvcnQgeyBydW5NYXRyaXhTaG9ydGN1dHMgfSBmcm9tIFwiLi9mZWF0dXJlcy9tYXRyaXhfc2hvcnRjdXRzXCI7XG5pbXBvcnQgeyBzaG91bGRUYWJvdXRCeUNsb3NlQnJhY2tldCwgdGFib3V0IH0gZnJvbSBcIi4vZmVhdHVyZXMvdGFib3V0XCI7XG5pbXBvcnQgeyBjdXJzb3JUb29sdGlwQmFzZVRoZW1lLCBjdXJzb3JUb29sdGlwRmllbGQsIGhhbmRsZU1hdGhUb29sdGlwIH0gZnJvbSBcIi4vZWRpdG9yX2V4dGVuc2lvbnMvbWF0aF90b29sdGlwXCI7XG5pbXBvcnQgeyByZW1vdmVBbGxUYWJzdG9wcywgdGFic3RvcHNTdGF0ZUZpZWxkIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci90YWJzdG9wc19zdGF0ZV9maWVsZFwiO1xuaW1wb3J0IHsgY2xlYXJTbmlwcGV0UXVldWUsIHNuaXBwZXRRdWV1ZVN0YXRlRmllbGQgfSBmcm9tIFwiLi9zbmlwcGV0cy9jb2RlbWlycm9yL3NuaXBwZXRfcXVldWVfc3RhdGVfZmllbGRcIjtcbmltcG9ydCB7IGhhbmRsZVVuZG9SZWRvLCBzbmlwcGV0SW52ZXJ0ZWRFZmZlY3RzIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9oaXN0b3J5XCI7XG5pbXBvcnQgeyBzdWdnZXN0b3IgfSBmcm9tIFwiLi9zdWdnZXN0b3JcIjtcbmltcG9ydCB7IGNvbnRleHQgfSBmcm9tIFwiZXNidWlsZC13YXNtXCI7XG5cbi8qXG5jbGFzcz1cImNtLWd1dHRlcnNcIiBhcmlhLWhpZGRlbj1cInRydWVcIiBzdHlsZT1cIm1pbi1oZWlnaHQ6IDc4NjVweDsgcG9zaXRpb246IHN0aWNreTtcIlxuc3BlbGxjaGVjaz1cImZhbHNlXCIgYXV0b2NvcnJlY3Q9XCJvZmZcIiB0cmFuc2xhdGU9XCJub1wiIGNvbnRlbnRlZGl0YWJsZT1cInRydWVcIlxuXG4qL1xuXG5leHBvcnQgY29uc3Qgb25TY3JvbGw9KGV2ZW50OiBFdmVudCx2aWV3OiBFZGl0b3JWaWV3KT0+e1xuXHRzdWdnZXN0b3IudXBkYXRlUG9zaXRpb25Gcm9tVmlldyh2aWV3KTtcbn1cblxuXG5leHBvcnQgY29uc3Qgb25Nb3ZlPShldmVudDogTW91c2VFdmVudCx2aWV3OiBFZGl0b3JWaWV3KT0+e1xuXHRpZighc3VnZ2VzdG9yLmlzU3VnZ2VzdGVyRGVwbG95ZWQoKSl7cmV0dXJufVxuXHRjb25zdCBzdWdnZXN0aW9uSXRlbXMgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3VnZ2VzdGlvbi1pdGVtXCIpO1xuXHRjb25zdCBjbGlja2VkU3VnZ2VzdGlvbiA9IEFycmF5LmZyb20oc3VnZ2VzdGlvbkl0ZW1zKS5maW5kKChpdGVtKSA9PlxuXHRcdGl0ZW0uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpXG5cdCk7XG5cdGlmIChjbGlja2VkU3VnZ2VzdGlvbikge1xuXHRcdGNvbnN0IGluZGV4ID0gQXJyYXkuZnJvbShzdWdnZXN0aW9uSXRlbXMpLmluZGV4T2YoY2xpY2tlZFN1Z2dlc3Rpb24pO1xuXHRcdHN1Z2dlc3Rvci5zZXRTZWxlY3Rpb25JbmRleChpbmRleClcblx0fVxufVxuXG5cbmV4cG9ydCBjb25zdCBvbkNsaWNrPShldmVudDogTW91c2VFdmVudCx2aWV3OiBFZGl0b3JWaWV3KT0+e1xuXHRpZighc3VnZ2VzdG9yLmlzU3VnZ2VzdGVyRGVwbG95ZWQoKSl7cmV0dXJufVxuXHRjb25zdCBzdWdnZXN0aW9uSXRlbXMgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3VnZ2VzdGlvbi1pdGVtXCIpO1xuXG5cdC8vIENoZWNrIGlmIHRoZSBjbGljayBpcyBvbiBhIHN1Z2dlc3Rpb24gaXRlbVxuXHRjb25zdCBjbGlja2VkU3VnZ2VzdGlvbiA9IEFycmF5LmZyb20oc3VnZ2VzdGlvbkl0ZW1zKS5maW5kKChpdGVtKSA9PlxuXHRcdGl0ZW0uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpXG5cdCk7XG5cdGlmIChjbGlja2VkU3VnZ2VzdGlvbikge1xuXHRcdHN1Z2dlc3Rvci5zZWxlY3REcm9wZG93bkl0ZW0odmlldyk7XG5cdH1cblx0Y29uc3QgZHJvcGRvd25JdGVtID0gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik7XG5cdGNvbnN0IGNsaWNrZWREcm9wZG93biA9IEFycmF5LmZyb20oc3VnZ2VzdGlvbkl0ZW1zKS5maW5kKChpdGVtKSA9PlxuXHRcdGl0ZW0uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpXG5cdCk7XG5cdGlmKCFjbGlja2VkRHJvcGRvd24pe1xuXHRcdHN1Z2dlc3Rvci5jbG9zZSgpXG5cdH1cbn1cblxuZXhwb3J0IGNvbnN0IG9uS2V5ZG93biA9IChldmVudDogS2V5Ym9hcmRFdmVudCwgdmlldzogRWRpdG9yVmlldykgPT4ge1xuXHRsZXQga2V5ID0gZXZlbnQua2V5O1xuXHRsZXQgdHJpZ2dlclxuXHRjb25zdCBjdHggPSBDb250ZXh0LmZyb21WaWV3KHZpZXcpO1xuXHRpZiAoIShldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpICYmIGN0eC5zaG91bGRUcmFuc2xhdGUoKSkge1xuXHQgIHRyaWdnZXIgPSBrZXlib2FyZEF1dG9SZXBsYWNlSGVicmV3VG9FbmdsaXNoVHJpZ2dlcnMuZmluZCgodHJpZ2dlcjIpID0+IHRyaWdnZXIyLmtleSA9PT0gZXZlbnQua2V5ICYmIHRyaWdnZXIyLmNvZGUgPT09IGV2ZW50LmNvZGUpO1xuXHQgIGtleSA9IHRyaWdnZXI/LnJlcGxhY2VtZW50fHxrZXk7XG5cdH1cblx0aWYoc3VnZ2VzdG9yLmlzU3VnZ2VzdGVyRGVwbG95ZWQoKSl7XG5cdFx0c3VnZ2VzdG9yLmhhbmRsZURyb3Bkb3duTmF2aWdhdGlvbihldmVudCx2aWV3KVxuXHR9XG5cdFxuXHRjb25zdCBzdWNjZXNzID0gaGFuZGxlS2V5ZG93bihrZXksIGV2ZW50LnNoaWZ0S2V5LCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXksIGlzQ29tcG9zaW5nKHZpZXcsIGV2ZW50KSwgdmlldyxjdHgpO1xuXHRpZiAoc3VjY2Vzcylcblx0ICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRlbHNlIGlmIChrZXkgIT09IGV2ZW50LmtleSYmdHJpZ2dlcikge1xuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0a2V5ID0gdHJpZ2dlci5yZXBsYWNlbWVudDtcblx0XHRyZXBsYWNlUmFuZ2Uodmlldyx2aWV3LnN0YXRlLnNlbGVjdGlvbi5tYWluLmZyb20sdmlldy5zdGF0ZS5zZWxlY3Rpb24ubWFpbi50byxrZXkpXG5cdFx0c2V0Q3Vyc29yKHZpZXcsdmlldy5zdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tK2tleS5sZW5ndGgpXG4gIH1cbn07XG5leHBvcnQgY29uc3Qgb25UcmFuc2FjdGlvbiA9ICh1cGRhdGU6IFZpZXdVcGRhdGUpID0+IHtcblx0aWYodXBkYXRlLnRyYW5zYWN0aW9uc1swXSYmdXBkYXRlLnRyYW5zYWN0aW9uc1swXS5kb2NDaGFuZ2VkKXtcblx0XHRjb25zdCBjdHg9Q29udGV4dC5mcm9tVmlldyh1cGRhdGUudmlldyk7XG5cdFx0aWYoY3R4LmNvZGVibG9ja0xhbmd1YWdlPT09XCJ0aWt6XCIpe1xuXHRcdFx0c3VnZ2VzdG9yLm9wZW4oY3R4LHVwZGF0ZS52aWV3KVxuXHRcdH1cblx0fVxuXG5cdGNvbnN0IHNldHRpbmdzID0gZ2V0TGF0ZXhTdWl0ZUNvbmZpZyh1cGRhdGUuc3RhdGUpO1xuXG5cdC8vIFRoZSBtYXRoIHRvb2x0aXAgaGFuZGxlciBpcyBkcml2ZW4gYnkgdmlldyB1cGRhdGVzIGJlY2F1c2UgaXQgdXRpbGl6ZXNcblx0Ly8gaW5mb3JtYXRpb24gYWJvdXQgdmlzdWFsIGxpbmUsIHdoaWNoIGlzIG5vdCBhdmFpbGFibGUgaW4gRWRpdG9yU3RhdGVcblx0aWYgKHNldHRpbmdzLm1hdGhQcmV2aWV3RW5hYmxlZCkge1xuXHRcdGhhbmRsZU1hdGhUb29sdGlwKHVwZGF0ZSk7XG5cdH1cblxuXHRoYW5kbGVVbmRvUmVkbyh1cGRhdGUpO1xuXG59XG5cblxuXG5leHBvcnQgY29uc3QgaGFuZGxlS2V5ZG93biA9IChrZXk6IHN0cmluZywgc2hpZnRLZXk6IGJvb2xlYW4sIGN0cmxLZXk6IGJvb2xlYW4sIGlzSU1FOiBib29sZWFuLCB2aWV3OiBFZGl0b3JWaWV3LCBjdHg6IENvbnRleHQpID0+IHtcblx0Y29uc3Qgc2V0dGluZ3MgPSBnZXRMYXRleFN1aXRlQ29uZmlnKHZpZXcpO1xuXG5cdGxldCBzdWNjZXNzID0gZmFsc2U7XG5cblx0Lypcblx0KiBXaGVuIGJhY2tzcGFjZSBpcyBwcmVzc2VkLCBpZiB0aGUgY3Vyc29yIGlzIGluc2lkZSBhbiBlbXB0eSBpbmxpbmUgbWF0aCxcblx0KiBkZWxldGUgYm90aCAkIHN5bWJvbHMsIG5vdCBqdXN0IHRoZSBmaXJzdCBvbmUuXG5cdCovXG5cdGlmIChzZXR0aW5ncy5hdXRvRGVsZXRlJCAmJiBrZXkgPT09IFwiQmFja3NwYWNlXCIgJiYgY3R4Lm1vZGUuaW5NYXRoKCkpIHtcblx0XHRjb25zdCBjaGFyQXRQb3MgPSBnZXRDaGFyYWN0ZXJBdFBvcyh2aWV3LCBjdHgucG9zKTtcblx0XHRjb25zdCBjaGFyQXRQcmV2UG9zID0gZ2V0Q2hhcmFjdGVyQXRQb3ModmlldywgY3R4LnBvcyAtIDEpO1xuXG5cdFx0aWYgKGNoYXJBdFBvcyA9PT0gXCIkXCIgJiYgY2hhckF0UHJldlBvcyA9PT0gXCIkXCIpIHtcblx0XHRcdHJlcGxhY2VSYW5nZSh2aWV3LCBjdHgucG9zIC0gMSwgY3R4LnBvcyArIDEsIFwiXCIpO1xuXHRcdFx0Ly8gTm90ZTogbm90IHN1cmUgaWYgcmVtb3ZlQWxsVGFic3RvcHMgaXMgbmVjZXNzYXJ5XG5cdFx0XHRyZW1vdmVBbGxUYWJzdG9wcyh2aWV3KTtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblx0fVxuXHRcblx0aWYgKHNldHRpbmdzLnNuaXBwZXRzRW5hYmxlZCkge1xuXG5cdFx0Ly8gUHJldmVudCBJTUUgZnJvbSB0cmlnZ2VyaW5nIGtleWRvd24gZXZlbnRzLlxuXHRcdGlmIChzZXR0aW5ncy5zdXBwcmVzc1NuaXBwZXRUcmlnZ2VyT25JTUUgJiYgaXNJTUUpIHJldHVybjtcblxuXHRcdC8vIEFsbG93cyBDdHJsICsgeiBmb3IgdW5kbywgaW5zdGVhZCBvZiB0cmlnZ2VyaW5nIGEgc25pcHBldCBlbmRpbmcgd2l0aCB6XG5cdFx0aWYgKCFjdHJsS2V5KSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRzdWNjZXNzID0gcnVuU25pcHBldHModmlldywgY3R4LCBrZXkpO1xuXHRcdFx0XHRpZiAoc3VjY2VzcykgcmV0dXJuIHRydWU7XG5cdFx0XHR9XG5cdFx0XHRjYXRjaCAoZSkge1xuXHRcdFx0XHRjbGVhclNuaXBwZXRRdWV1ZSh2aWV3KTtcblx0XHRcdFx0Y29uc29sZS5lcnJvcihlKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRpZiAoa2V5ID09PSBcIlRhYlwiKSB7XG5cdFx0c3VjY2VzcyA9IHNldFNlbGVjdGlvblRvTmV4dFRhYnN0b3Aodmlldyk7XG5cblx0XHRpZiAoc3VjY2VzcykgcmV0dXJuIHRydWU7XG5cdH1cblx0aWYgKGN0eC5tb2RlLnN0cmljdGx5SW5NYXRoKCkpIHtcblx0XHRpZiAoa2V5ID09PSBcIi9cIikge1xuXHRcdFx0c3VjY2VzcyA9IHJ1bkF1dG9GcmFjdGlvbih2aWV3LCBjdHgpO1xuXG5cdFx0XHRpZiAoc3VjY2VzcykgcmV0dXJuIHRydWU7XG5cdFx0fVxuXHR9XG5cblx0aWYgKHNldHRpbmdzLm1hdHJpeFNob3J0Y3V0c0VuYWJsZWQgJiYgY3R4Lm1vZGUuYmxvY2tNYXRoKSB7XG5cdFx0aWYgKFtcIlRhYlwiLCBcIkVudGVyXCJdLmNvbnRhaW5zKGtleSkpIHtcblx0XHRcdHN1Y2Nlc3MgPSBydW5NYXRyaXhTaG9ydGN1dHModmlldywgY3R4LCBrZXksIHNoaWZ0S2V5KTtcblx0XHRcdGlmIChzdWNjZXNzKSByZXR1cm4gdHJ1ZTtcblx0XHR9XG5cdH1cblx0aWYgKGtleSA9PT0gXCJUYWJcIiYmc2hpZnRLZXkpIHtcblx0XHRzdWNjZXNzID0gdGFib3V0KHZpZXcsIGN0eCwtMSk7XG5cdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xuXHR9XG5cdGVsc2UgaWYgKGtleSA9PT0gXCJUYWJcIiB8fCBzaG91bGRUYWJvdXRCeUNsb3NlQnJhY2tldCh2aWV3LCBrZXkpKSB7XG5cdFx0c3VjY2VzcyA9IHRhYm91dCh2aWV3LCBjdHgsMSk7XG5cdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xuXHR9XG5cblx0cmV0dXJuIGZhbHNlO1xufVxuXG4iXX0=