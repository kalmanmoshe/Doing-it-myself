import { Context } from "./utils/context";
import { getCharacterAtPos, isComposing, replaceRange, setCursor } from "./editor utilities/editor_utils";
import { keyboardAutoReplaceHebrewToEnglishTriggers } from "./staticData/mathParserStaticData";
import { setSelectionToNextTabstop } from "./snippets/snippet_management";
import { runSnippets } from "./features/run_snippets";
import { getLatexSuiteConfig } from "./snippets/codemirror/config";
import { runAutoFraction } from "./features/autofraction";
import { runMatrixShortcuts } from "./features/matrix_shortcuts";
import { shouldTaboutByCloseBracket, tabout } from "./features/tabout";
import { handleMathTooltip } from "./editor_extensions/math_tooltip";
import { removeAllTabstops } from "./snippets/codemirror/tabstops_state_field";
import { clearSnippetQueue } from "./snippets/codemirror/snippet_queue_state_field";
import { handleUndoRedo } from "./snippets/codemirror/history";
import { suggestor } from "./suggestor";
/*
class="cm-gutters" aria-hidden="true" style="min-height: 7865px; position: sticky;"
spellcheck="false" autocorrect="off" translate="no" contenteditable="true"

*/
export const onScroll = (event, view) => {
    console.log(suggestor);
    suggestor.updatePositionFromView(view);
};
export const onMove = (event, view) => {
    const suggestionItems = document.body.querySelectorAll(".suggestion-item");
    const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (clickedSuggestion) {
        const index = Array.from(suggestionItems).indexOf(clickedSuggestion);
        suggestor.selectionIndex = index;
        suggestor.updateSelection(suggestionItems);
    }
};
export const onClick = (event, view) => {
    if (!suggestor.isSuggesterDeployed()) {
        return;
    }
    const suggestionItems = document.body.querySelectorAll(".suggestion-item");
    // Check if the click is on a suggestion item
    const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (clickedSuggestion) {
        suggestor.selectDropdownItem(clickedSuggestion, view);
    }
    const dropdownItem = document.body.querySelector(".suggestion-dropdown");
    const clickedDropdown = Array.from(suggestionItems).find((item) => item.contains(event.target));
    if (!clickedDropdown) {
        suggestor.close();
    }
};
export const onKeydown = (event, view) => {
    let key = event.key;
    let trigger;
    const ctx = Context.fromView(view);
    if (!(event.ctrlKey || event.metaKey) && ctx.shouldTranslate()) {
        trigger = keyboardAutoReplaceHebrewToEnglishTriggers.find((trigger2) => trigger2.key === event.key && trigger2.code === event.code);
        key = trigger?.replacement || key;
    }
    if (ctx.codeblockLanguage === "tikz") {
        suggestor.open(ctx, view);
    }
    if (suggestor.isSuggesterDeployed()) {
        handleDropdownNavigation(event, view);
    }
    const success = handleKeydown(key, event.shiftKey, event.ctrlKey || event.metaKey, isComposing(view, event), view);
    if (success)
        event.preventDefault();
    else if (key !== event.key && trigger) {
        event.preventDefault();
        key = trigger.replacement;
        replaceRange(view, view.state.selection.main.from, view.state.selection.main.to, key);
        setCursor(view, view.state.selection.main.from + key.length);
    }
};
export const handleUpdate = (update) => {
    const settings = getLatexSuiteConfig(update.state);
    // The math tooltip handler is driven by view updates because it utilizes
    // information about visual line, which is not available in EditorState
    if (settings.mathPreviewEnabled) {
        handleMathTooltip(update);
    }
    handleUndoRedo(update);
};
const handleDropdownNavigation = (event, view) => {
    const items = suggestor.getAlldropdownItems();
    switch (true) {
        case event.key === "ArrowDown":
            suggestor.selectionIndex = (suggestor.selectionIndex + 1) % items.length;
            suggestor.updateSelection(items);
            event.preventDefault();
            break;
        case event.key === "ArrowUp":
            suggestor.selectionIndex = (suggestor.selectionIndex - 1 + items.length) % items.length;
            suggestor.updateSelection(items);
            event.preventDefault();
            break;
        case event.key === "ArrowLeft" || event.key === "ArrowRight":
            suggestor.close();
            break;
        case event.key === "Backspace":
            suggestor.close();
            //suggestor.deploySuggestor(ctx,view)
            break;
        default:
            break;
    }
    if (event.key === "ArrowDown") {
    }
    else if (event.key === "Enter") {
        const selectedItem = items[suggestor.selectionIndex];
        suggestor.selectDropdownItem(selectedItem, view);
        event.preventDefault();
    } /*else if (event.key === "Escape") {
        dropdown.remove();
        event.preventDefault();
    }*/
};
export const handleKeydown = (key, shiftKey, ctrlKey, isIME, view) => {
    const settings = getLatexSuiteConfig(view);
    const ctx = Context.fromView(view);
    let success = false;
    /*
    * When backspace is pressed, if the cursor is inside an empty inline math,
    * delete both $ symbols, not just the first one.
    */
    if (settings.autoDelete$ && key === "Backspace" && ctx.mode.inMath()) {
        const charAtPos = getCharacterAtPos(view, ctx.pos);
        const charAtPrevPos = getCharacterAtPos(view, ctx.pos - 1);
        if (charAtPos === "$" && charAtPrevPos === "$") {
            replaceRange(view, ctx.pos - 1, ctx.pos + 1, "");
            // Note: not sure if removeAllTabstops is necessary
            removeAllTabstops(view);
            return true;
        }
    }
    if (settings.snippetsEnabled) {
        // Prevent IME from triggering keydown events.
        if (settings.suppressSnippetTriggerOnIME && isIME)
            return;
        // Allows Ctrl + z for undo, instead of triggering a snippet ending with z
        if (!ctrlKey) {
            try {
                success = runSnippets(view, ctx, key);
                if (success)
                    return true;
            }
            catch (e) {
                clearSnippetQueue(view);
                console.error(e);
            }
        }
    }
    if (key === "Tab") {
        success = setSelectionToNextTabstop(view);
        if (success)
            return true;
    }
    if (ctx.mode.strictlyInMath()) {
        if (key === "/") {
            success = runAutoFraction(view, ctx);
            if (success)
                return true;
        }
    }
    if (settings.matrixShortcutsEnabled && ctx.mode.blockMath) {
        if (["Tab", "Enter"].contains(key)) {
            success = runMatrixShortcuts(view, ctx, key, shiftKey);
            if (success)
                return true;
        }
    }
    if (key === "Tab" && shiftKey) {
        success = tabout(view, ctx, -1);
        if (success)
            return true;
    }
    else if (key === "Tab" || shouldTaboutByCloseBracket(view, key)) {
        success = tabout(view, ctx, 1);
        if (success)
            return true;
    }
    return false;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0RWRpdG9yRXh0ZW5zaW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zZXRFZGl0b3JFeHRlbnNpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxPQUFPLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUMxQyxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxTQUFTLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUMxRyxPQUFPLEVBQUUsMENBQTBDLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUUvRixPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUUxRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFDdEQsT0FBTyxFQUFFLG1CQUFtQixFQUFnQyxNQUFNLDhCQUE4QixDQUFDO0FBQ2pHLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUMxRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUNqRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFJdkUsT0FBTyxFQUE4QyxpQkFBaUIsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBRWpILE9BQU8sRUFBRSxpQkFBaUIsRUFBc0IsTUFBTSw0Q0FBNEMsQ0FBQztBQUNuRyxPQUFPLEVBQUUsaUJBQWlCLEVBQTBCLE1BQU0saURBQWlELENBQUM7QUFDNUcsT0FBTyxFQUFFLGNBQWMsRUFBMEIsTUFBTSwrQkFBK0IsQ0FBQztBQUN2RixPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sYUFBYSxDQUFDO0FBRXhDOzs7O0VBSUU7QUFFRixNQUFNLENBQUMsTUFBTSxRQUFRLEdBQUMsQ0FBQyxLQUFZLEVBQUMsSUFBZ0IsRUFBQyxFQUFFO0lBQ3RELE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxD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O1FBQzNELElBQUksQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDcEMsT0FBTyxHQUFHLGtCQUFrQixDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1lBQ3ZELElBQUksT0FBTztnQkFBRSxPQUFPLElBQUksQ0FBQztRQUMxQixDQUFDO0lBQ0YsQ0FBQztJQUNELElBQUksR0FBRyxLQUFLLEtBQUssSUFBRSxRQUFRLEVBQUUsQ0FBQztRQUM3QixPQUFPLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQixJQUFJLE9BQU87WUFBRSxPQUFPLElBQUksQ0FBQztJQUMxQixDQUFDO1NBQ0ksSUFBSSxHQUFHLEtBQUssS0FBSyxJQUFJLDBCQUEwQixDQUFDLElBQUksRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO1FBQ2pFLE9BQU8sR0FBRyxNQUFNLENBQUMsSUFBSSxFQUFFLEdBQUcsRUFBQyxDQUFDLENBQUMsQ0FBQztRQUM5QixJQUFJLE9BQU87WUFBRSxPQUFPLElBQUksQ0FBQztJQUMxQixDQUFDO0lBRUQsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJcbmltcG9ydCB7IEVkaXRvclZpZXcsIFZpZXdQbHVnaW4sIFZpZXdVcGRhdGUgLERlY29yYXRpb24sIHRvb2x0aXBzLCB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XG5pbXBvcnQgeyBDb250ZXh0IH0gZnJvbSBcIi4vdXRpbHMvY29udGV4dFwiO1xuaW1wb3J0IHsgZ2V0Q2hhcmFjdGVyQXRQb3MsIGlzQ29tcG9zaW5nLCByZXBsYWNlUmFuZ2UsIHNldEN1cnNvciB9IGZyb20gXCIuL2VkaXRvciB1dGlsaXRpZXMvZWRpdG9yX3V0aWxzXCI7XG5pbXBvcnQgeyBrZXlib2FyZEF1dG9SZXBsYWNlSGVicmV3VG9FbmdsaXNoVHJpZ2dlcnMgfSBmcm9tIFwiLi9zdGF0aWNEYXRhL21hdGhQYXJzZXJTdGF0aWNEYXRhXCI7XG5pbXBvcnQgeyBSdGxGb3JjIH0gZnJvbSBcIi4vZWRpdG9yRGVjb3JhdGlvbnNcIjtcbmltcG9ydCB7IHNldFNlbGVjdGlvblRvTmV4dFRhYnN0b3AgfSBmcm9tIFwiLi9zbmlwcGV0cy9zbmlwcGV0X21hbmFnZW1lbnRcIjtcblxuaW1wb3J0IHsgcnVuU25pcHBldHMgfSBmcm9tIFwiLi9mZWF0dXJlcy9ydW5fc25pcHBldHNcIjtcbmltcG9ydCB7IGdldExhdGV4U3VpdGVDb25maWcsIGdldExhdGV4U3VpdGVDb25maWdFeHRlbnNpb24gfSBmcm9tIFwiLi9zbmlwcGV0cy9jb2RlbWlycm9yL2NvbmZpZ1wiO1xuaW1wb3J0IHsgcnVuQXV0b0ZyYWN0aW9uIH0gZnJvbSBcIi4vZmVhdHVyZXMvYXV0b2ZyYWN0aW9uXCI7XG5pbXBvcnQgeyBydW5NYXRyaXhTaG9ydGN1dHMgfSBmcm9tIFwiLi9mZWF0dXJlcy9tYXRyaXhfc2hvcnRjdXRzXCI7XG5pbXBvcnQgeyBzaG91bGRUYWJvdXRCeUNsb3NlQnJhY2tldCwgdGFib3V0IH0gZnJvbSBcIi4vZmVhdHVyZXMvdGFib3V0XCI7XG5pbXBvcnQgeyBzbmlwcGV0RXh0ZW5zaW9ucyB9IGZyb20gXCIuL3NuaXBwZXRzL2NvZGVtaXJyb3IvZXh0ZW5zaW9uc1wiO1xuaW1wb3J0IHsgY29sb3JQYWlyZWRCcmFja2V0c1BsdWdpbkxvd2VzdFByZWMsIGhpZ2hsaWdodEN1cnNvckJyYWNrZXRzUGx1Z2luIH0gZnJvbSBcIi4vZWRpdG9yX2V4dGVuc2lvbnMvaGlnaGxpZ2h0X2JyYWNrZXRzXCI7XG5pbXBvcnQgeyBta0NvbmNlYWxQbHVnaW4gfSBmcm9tIFwiLi9lZGl0b3JfZXh0ZW5zaW9ucy9jb25jZWFsXCI7XG5pbXBvcnQgeyBjdXJzb3JUb29sdGlwQmFzZVRoZW1lLCBjdXJzb3JUb29sdGlwRmllbGQsIGhhbmRsZU1hdGhUb29sdGlwIH0gZnJvbSBcIi4vZWRpdG9yX2V4dGVuc2lvbnMvbWF0aF90b29sdGlwXCI7XG5pbXBvcnQgeyBjb250ZXh0IH0gZnJvbSBcImVzYnVpbGQtd2FzbVwiO1xuaW1wb3J0IHsgcmVtb3ZlQWxsVGFic3RvcHMsIHRhYnN0b3BzU3RhdGVGaWVsZCB9IGZyb20gXCIuL3NuaXBwZXRzL2NvZGVtaXJyb3IvdGFic3RvcHNfc3RhdGVfZmllbGRcIjtcbmltcG9ydCB7IGNsZWFyU25pcHBldFF1ZXVlLCBzbmlwcGV0UXVldWVTdGF0ZUZpZWxkIH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XG5pbXBvcnQgeyBoYW5kbGVVbmRvUmVkbywgc25pcHBldEludmVydGVkRWZmZWN0cyB9IGZyb20gXCIuL3NuaXBwZXRzL2NvZGVtaXJyb3IvaGlzdG9yeVwiO1xuaW1wb3J0IHsgc3VnZ2VzdG9yIH0gZnJvbSBcIi4vc3VnZ2VzdG9yXCI7XG5cbi8qXG5jbGFzcz1cImNtLWd1dHRlcnNcIiBhcmlhLWhpZGRlbj1cInRydWVcIiBzdHlsZT1cIm1pbi1oZWlnaHQ6IDc4NjVweDsgcG9zaXRpb246IHN0aWNreTtcIlxuc3BlbGxjaGVjaz1cImZhbHNlXCIgYXV0b2NvcnJlY3Q9XCJvZmZcIiB0cmFuc2xhdGU9XCJub1wiIGNvbnRlbnRlZGl0YWJsZT1cInRydWVcIlxuXG4qL1xuXG5leHBvcnQgY29uc3Qgb25TY3JvbGw9KGV2ZW50OiBFdmVudCx2aWV3OiBFZGl0b3JWaWV3KT0+e1xuXHRjb25zb2xlLmxvZyhzdWdnZXN0b3IpXG5cdHN1Z2dlc3Rvci51cGRhdGVQb3NpdGlvbkZyb21WaWV3KHZpZXcpO1xufVxuXG5leHBvcnQgY29uc3Qgb25Nb3ZlPShldmVudDogTW91c2VFdmVudCx2aWV3OiBFZGl0b3JWaWV3KT0+e1xuXHRjb25zdCBzdWdnZXN0aW9uSXRlbXMgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3VnZ2VzdGlvbi1pdGVtXCIpO1xuXG5cdGNvbnN0IGNsaWNrZWRTdWdnZXN0aW9uID0gQXJyYXkuZnJvbShzdWdnZXN0aW9uSXRlbXMpLmZpbmQoKGl0ZW0pID0+XG5cdFx0aXRlbS5jb250YWlucyhldmVudC50YXJnZXQgYXMgTm9kZSlcblx0KTtcblx0aWYgKGNsaWNrZWRTdWdnZXN0aW9uKSB7XG5cdFx0Y29uc3QgaW5kZXggPSBBcnJheS5mcm9tKHN1Z2dlc3Rpb25JdGVtcykuaW5kZXhPZihjbGlja2VkU3VnZ2VzdGlvbik7XG5cdFx0c3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4PWluZGV4XG5cdFx0c3VnZ2VzdG9yLnVwZGF0ZVNlbGVjdGlvbihzdWdnZXN0aW9uSXRlbXMpXG5cdH1cbn1cbmV4cG9ydCBjb25zdCBvbkNsaWNrPShldmVudDogTW91c2VFdmVudCx2aWV3OiBFZGl0b3JWaWV3KT0+e1xuXHRpZighc3VnZ2VzdG9yLmlzU3VnZ2VzdGVyRGVwbG95ZWQoKSl7cmV0dXJufVxuXHRjb25zdCBzdWdnZXN0aW9uSXRlbXMgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3VnZ2VzdGlvbi1pdGVtXCIpO1xuXG5cdC8vIENoZWNrIGlmIHRoZSBjbGljayBpcyBvbiBhIHN1Z2dlc3Rpb24gaXRlbVxuXHRjb25zdCBjbGlja2VkU3VnZ2VzdGlvbiA9IEFycmF5LmZyb20oc3VnZ2VzdGlvbkl0ZW1zKS5maW5kKChpdGVtKSA9PlxuXHRcdGl0ZW0uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpXG5cdCk7XG5cdGlmIChjbGlja2VkU3VnZ2VzdGlvbikge1xuXHRcdHN1Z2dlc3Rvci5zZWxlY3REcm9wZG93bkl0ZW0oY2xpY2tlZFN1Z2dlc3Rpb24sdmlldyk7XG5cdH1cblx0Y29uc3QgZHJvcGRvd25JdGVtID0gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik7XG5cdGNvbnN0IGNsaWNrZWREcm9wZG93biA9IEFycmF5LmZyb20oc3VnZ2VzdGlvbkl0ZW1zKS5maW5kKChpdGVtKSA9PlxuXHRcdGl0ZW0uY29udGFpbnMoZXZlbnQudGFyZ2V0IGFzIE5vZGUpXG5cdCk7XG5cdGlmKCFjbGlja2VkRHJvcGRvd24pe1xuXHRcdHN1Z2dlc3Rvci5jbG9zZSgpXG5cdH1cbn1cbmV4cG9ydCBjb25zdCBvbktleWRvd24gPSAoZXZlbnQ6IEtleWJvYXJkRXZlbnQsIHZpZXc6IEVkaXRvclZpZXcpID0+IHtcblx0bGV0IGtleSA9IGV2ZW50LmtleTtcblx0bGV0IHRyaWdnZXJcblx0Y29uc3QgY3R4ID0gQ29udGV4dC5mcm9tVmlldyh2aWV3KTtcblx0aWYgKCEoZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5KSAmJiBjdHguc2hvdWxkVHJhbnNsYXRlKCkpIHtcblx0ICB0cmlnZ2VyID0ga2V5Ym9hcmRBdXRvUmVwbGFjZUhlYnJld1RvRW5nbGlzaFRyaWdnZXJzLmZpbmQoKHRyaWdnZXIyKSA9PiB0cmlnZ2VyMi5rZXkgPT09IGV2ZW50LmtleSAmJiB0cmlnZ2VyMi5jb2RlID09PSBldmVudC5jb2RlKTtcblx0ICBrZXkgPSB0cmlnZ2VyPy5yZXBsYWNlbWVudHx8a2V5O1xuXHR9XG5cdGlmKGN0eC5jb2RlYmxvY2tMYW5ndWFnZT09PVwidGlrelwiKXtcblx0XHRzdWdnZXN0b3Iub3BlbihjdHgsdmlldylcblx0fVxuXHRpZihzdWdnZXN0b3IuaXNTdWdnZXN0ZXJEZXBsb3llZCgpKXtcblx0XHRoYW5kbGVEcm9wZG93bk5hdmlnYXRpb24oZXZlbnQsdmlldylcblx0fVxuXHRcblx0Y29uc3Qgc3VjY2VzcyA9IGhhbmRsZUtleWRvd24oa2V5LCBldmVudC5zaGlmdEtleSwgZXZlbnQuY3RybEtleSB8fCBldmVudC5tZXRhS2V5LCBpc0NvbXBvc2luZyh2aWV3LCBldmVudCksIHZpZXcpO1xuXHRpZiAoc3VjY2VzcykgXG5cdCAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0ZWxzZSBpZiAoa2V5ICE9PSBldmVudC5rZXkmJnRyaWdnZXIpIHtcblx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdGtleSA9IHRyaWdnZXIucmVwbGFjZW1lbnQ7XG5cdFx0cmVwbGFjZVJhbmdlKHZpZXcsdmlldy5zdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tLHZpZXcuc3RhdGUuc2VsZWN0aW9uLm1haW4udG8sa2V5KVxuXHRcdHNldEN1cnNvcih2aWV3LHZpZXcuc3RhdGUuc2VsZWN0aW9uLm1haW4uZnJvbStrZXkubGVuZ3RoKVxuICB9XG59O1xuXG5leHBvcnQgY29uc3QgaGFuZGxlVXBkYXRlID0gKHVwZGF0ZTogVmlld1VwZGF0ZSkgPT4ge1xuXHRjb25zdCBzZXR0aW5ncyA9IGdldExhdGV4U3VpdGVDb25maWcodXBkYXRlLnN0YXRlKTtcblxuXHQvLyBUaGUgbWF0aCB0b29sdGlwIGhhbmRsZXIgaXMgZHJpdmVuIGJ5IHZpZXcgdXBkYXRlcyBiZWNhdXNlIGl0IHV0aWxpemVzXG5cdC8vIGluZm9ybWF0aW9uIGFib3V0IHZpc3VhbCBsaW5lLCB3aGljaCBpcyBub3QgYXZhaWxhYmxlIGluIEVkaXRvclN0YXRlXG5cdGlmIChzZXR0aW5ncy5tYXRoUHJldmlld0VuYWJsZWQpIHtcblx0XHRoYW5kbGVNYXRoVG9vbHRpcCh1cGRhdGUpO1xuXHR9XG5cblx0aGFuZGxlVW5kb1JlZG8odXBkYXRlKTtcbn1cblxuY29uc3QgaGFuZGxlRHJvcGRvd25OYXZpZ2F0aW9uPShldmVudDogS2V5Ym9hcmRFdmVudCx2aWV3OkVkaXRvclZpZXcpPT57XG5cdGNvbnN0IGl0ZW1zID0gc3VnZ2VzdG9yLmdldEFsbGRyb3Bkb3duSXRlbXMoKTtcblx0c3dpdGNoICh0cnVlKSB7XG5cdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiQXJyb3dEb3duXCI6XG5cdFx0XHRzdWdnZXN0b3Iuc2VsZWN0aW9uSW5kZXggPSAoc3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4ICsgMSkgJSBpdGVtcy5sZW5ndGg7XG5cdFx0XHRzdWdnZXN0b3IudXBkYXRlU2VsZWN0aW9uKGl0ZW1zKTtcblx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRicmVhaztcblx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd1VwXCI6XG5cdFx0XHRzdWdnZXN0b3Iuc2VsZWN0aW9uSW5kZXggPSAoc3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4IC0gMSArIGl0ZW1zLmxlbmd0aCkgJSBpdGVtcy5sZW5ndGg7XG5cdFx0XHRzdWdnZXN0b3IudXBkYXRlU2VsZWN0aW9uKGl0ZW1zKTtcblx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRicmVhaztcblx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd0xlZnRcInx8ZXZlbnQua2V5ID09PSBcIkFycm93UmlnaHRcIjpcblx0XHRcdHN1Z2dlc3Rvci5jbG9zZSgpO1xuXHRcdFx0YnJlYWs7XG5cdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiQmFja3NwYWNlXCI6XG5cdFx0XHRzdWdnZXN0b3IuY2xvc2UoKTtcblx0XHRcdC8vc3VnZ2VzdG9yLmRlcGxveVN1Z2dlc3RvcihjdHgsdmlldylcblx0XHRcdGJyZWFrO1xuXHRcdGRlZmF1bHQ6XG5cdFx0XHRicmVhaztcblx0fVxuXHRpZiAoZXZlbnQua2V5ID09PSBcIkFycm93RG93blwiKSB7XG5cdFx0XG5cdH1lbHNlIGlmIChldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xuXHRcdGNvbnN0IHNlbGVjdGVkSXRlbSA9IGl0ZW1zW3N1Z2dlc3Rvci5zZWxlY3Rpb25JbmRleF07XG5cdFx0c3VnZ2VzdG9yLnNlbGVjdERyb3Bkb3duSXRlbShzZWxlY3RlZEl0ZW0sdmlldyk7XG5cdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0fSAvKmVsc2UgaWYgKGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIikge1xuXHRcdGRyb3Bkb3duLnJlbW92ZSgpO1xuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdH0qL1xufVxuXG5cbmV4cG9ydCBjb25zdCBoYW5kbGVLZXlkb3duID0gKGtleTogc3RyaW5nLCBzaGlmdEtleTogYm9vbGVhbiwgY3RybEtleTogYm9vbGVhbiwgaXNJTUU6IGJvb2xlYW4sIHZpZXc6IEVkaXRvclZpZXcpID0+IHtcblx0Y29uc3Qgc2V0dGluZ3MgPSBnZXRMYXRleFN1aXRlQ29uZmlnKHZpZXcpO1xuXHRjb25zdCBjdHggPSBDb250ZXh0LmZyb21WaWV3KHZpZXcpO1xuXG5cdGxldCBzdWNjZXNzID0gZmFsc2U7XG5cblx0Lypcblx0KiBXaGVuIGJhY2tzcGFjZSBpcyBwcmVzc2VkLCBpZiB0aGUgY3Vyc29yIGlzIGluc2lkZSBhbiBlbXB0eSBpbmxpbmUgbWF0aCxcblx0KiBkZWxldGUgYm90aCAkIHN5bWJvbHMsIG5vdCBqdXN0IHRoZSBmaXJzdCBvbmUuXG5cdCovXG5cdGlmIChzZXR0aW5ncy5hdXRvRGVsZXRlJCAmJiBrZXkgPT09IFwiQmFja3NwYWNlXCIgJiYgY3R4Lm1vZGUuaW5NYXRoKCkpIHtcblx0XHRjb25zdCBjaGFyQXRQb3MgPSBnZXRDaGFyYWN0ZXJBdFBvcyh2aWV3LCBjdHgucG9zKTtcblx0XHRjb25zdCBjaGFyQXRQcmV2UG9zID0gZ2V0Q2hhcmFjdGVyQXRQb3ModmlldywgY3R4LnBvcyAtIDEpO1xuXG5cdFx0aWYgKGNoYXJBdFBvcyA9PT0gXCIkXCIgJiYgY2hhckF0UHJldlBvcyA9PT0gXCIkXCIpIHtcblx0XHRcdHJlcGxhY2VSYW5nZSh2aWV3LCBjdHgucG9zIC0gMSwgY3R4LnBvcyArIDEsIFwiXCIpO1xuXHRcdFx0Ly8gTm90ZTogbm90IHN1cmUgaWYgcmVtb3ZlQWxsVGFic3RvcHMgaXMgbmVjZXNzYXJ5XG5cdFx0XHRyZW1vdmVBbGxUYWJzdG9wcyh2aWV3KTtcblx0XHRcdHJldHVybiB0cnVlO1xuXHRcdH1cblx0fVxuXHRcblx0aWYgKHNldHRpbmdzLnNuaXBwZXRzRW5hYmxlZCkge1xuXG5cdFx0Ly8gUHJldmVudCBJTUUgZnJvbSB0cmlnZ2VyaW5nIGtleWRvd24gZXZlbnRzLlxuXHRcdGlmIChzZXR0aW5ncy5zdXBwcmVzc1NuaXBwZXRUcmlnZ2VyT25JTUUgJiYgaXNJTUUpIHJldHVybjtcblxuXHRcdC8vIEFsbG93cyBDdHJsICsgeiBmb3IgdW5kbywgaW5zdGVhZCBvZiB0cmlnZ2VyaW5nIGEgc25pcHBldCBlbmRpbmcgd2l0aCB6XG5cdFx0aWYgKCFjdHJsS2V5KSB7XG5cdFx0XHR0cnkge1xuXHRcdFx0XHRzdWNjZXNzID0gcnVuU25pcHBldHModmlldywgY3R4LCBrZXkpO1xuXHRcdFx0XHRpZiAoc3VjY2VzcykgcmV0dXJuIHRydWU7XG5cdFx0XHR9XG5cdFx0XHRjYXRjaCAoZSkge1xuXHRcdFx0XHRjbGVhclNuaXBwZXRRdWV1ZSh2aWV3KTtcblx0XHRcdFx0Y29uc29sZS5lcnJvcihlKTtcblx0XHRcdH1cblx0XHR9XG5cdH1cblxuXHRpZiAoa2V5ID09PSBcIlRhYlwiKSB7XG5cdFx0c3VjY2VzcyA9IHNldFNlbGVjdGlvblRvTmV4dFRhYnN0b3Aodmlldyk7XG5cblx0XHRpZiAoc3VjY2VzcykgcmV0dXJuIHRydWU7XG5cdH1cblx0aWYgKGN0eC5tb2RlLnN0cmljdGx5SW5NYXRoKCkpIHtcblx0XHRpZiAoa2V5ID09PSBcIi9cIikge1xuXHRcdFx0c3VjY2VzcyA9IHJ1bkF1dG9GcmFjdGlvbih2aWV3LCBjdHgpO1xuXG5cdFx0XHRpZiAoc3VjY2VzcykgcmV0dXJuIHRydWU7XG5cdFx0fVxuXHR9XG5cblx0aWYgKHNldHRpbmdzLm1hdHJpeFNob3J0Y3V0c0VuYWJsZWQgJiYgY3R4Lm1vZGUuYmxvY2tNYXRoKSB7XG5cdFx0aWYgKFtcIlRhYlwiLCBcIkVudGVyXCJdLmNvbnRhaW5zKGtleSkpIHtcblx0XHRcdHN1Y2Nlc3MgPSBydW5NYXRyaXhTaG9ydGN1dHModmlldywgY3R4LCBrZXksIHNoaWZ0S2V5KTtcblx0XHRcdGlmIChzdWNjZXNzKSByZXR1cm4gdHJ1ZTtcblx0XHR9XG5cdH1cblx0aWYgKGtleSA9PT0gXCJUYWJcIiYmc2hpZnRLZXkpIHtcblx0XHRzdWNjZXNzID0gdGFib3V0KHZpZXcsIGN0eCwtMSk7XG5cdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xuXHR9XG5cdGVsc2UgaWYgKGtleSA9PT0gXCJUYWJcIiB8fCBzaG91bGRUYWJvdXRCeUNsb3NlQnJhY2tldCh2aWV3LCBrZXkpKSB7XG5cdFx0c3VjY2VzcyA9IHRhYm91dCh2aWV3LCBjdHgsMSk7XG5cdFx0aWYgKHN1Y2Nlc3MpIHJldHVybiB0cnVlO1xuXHR9XG5cblx0cmV0dXJuIGZhbHNlO1xufVxuXG4iXX0=