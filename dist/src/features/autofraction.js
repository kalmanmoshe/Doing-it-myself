import { findMatchingBracket } from "src/utils/editor_utils";
import { queueSnippet } from "src/snippets/codemirror/snippet_queue_state_field";
import { expandSnippets } from "src/snippets/snippet_management";
import { autoEnlargeBrackets } from "./auto_enlarge_brackets";
import { getLatexSuiteConfig } from "src/snippets/codemirror/config";
export const runAutoFraction = (view, ctx) => {
    for (const range of ctx.ranges) {
        runAutoFractionCursor(view, ctx, range);
    }
    const success = expandSnippets(view);
    if (success) {
        autoEnlargeBrackets(view);
    }
    return success;
};
export const runAutoFractionCursor = (view, ctx, range) => {
    const settings = getLatexSuiteConfig(view);
    const { from, to } = range;
    // Don't run autofraction in excluded environments
    for (const env of settings.autofractionExcludedEnvs) {
        if (ctx.isWithinEnvironment(to, env)) {
            return false;
        }
    }
    // Get the bounds of the equation
    const result = ctx.getBounds();
    if (!result)
        return false;
    const eqnStart = result.start;
    const curLines = view.state.sliceDoc(eqnStart, to).split("\n");
    let string = curLines[curLines.length - 1];
    let start = eqnStart;
    if (from != to) {
        // We have a selection
        // Set start to the beginning of the selection
        start = from;
    }
    else {
        // Find the contents of the fraction
        // Match everything except spaces and +-, but allow these characters in brackets
        // Also, allow spaces after greek letters
        // By replacing spaces after greek letters with a dummy character (#)
        const greek = "alpha|beta|gamma|Gamma|delta|Delta|epsilon|varepsilon|zeta|eta|theta|Theta|iota|kappa|lambda|Lambda|mu|nu|omicron|xi|Xi|pi|Pi|rho|sigma|Sigma|tau|upsilon|Upsilon|varphi|phi|Phi|chi|psi|Psi|omega|Omega|cdot|frac|binom";
        const regex = new RegExp("(" + greek + ") ", "g");
        string = string.replace(regex, "$1#");
        console.log("replace(regex, \"$1#\")", string);
        string = string.slice(string.lastIndexOf(" ") + 1);
        console.log("lastIndexOf(\" \")", string);
        string = string.slice(identifyBrackets(string));
        console.log("identifyBrackets", string);
        const removeRegex = /(?:^|[^\\])[^a-zA-Z0-9-+^%$#@!,_.\\(){}[\]]/;
        while (removeRegex.test(string)) {
            string = string.slice(string.match(removeRegex)?.index + 1);
        }
        string = string.startsWith("+") ? string.slice(1) : string;
    }
    start = (to - string.length);
    if (start === to) {
        return false;
    }
    let numerator = view.state.sliceDoc(start, to);
    if (numerator.at(0) === "(" && numerator.at(-1) === ")") {
        const closing = findMatchingBracket(numerator, 0, "(", ")", false);
        if (closing === numerator.length - 1) {
            numerator = numerator.slice(1, -1);
        }
    }
    const replacement = `\\frac{${numerator}}{$0}$1`;
    queueSnippet(view, to - string.length, to, replacement, "/");
    return true;
};
export function identifyBrackets(input) {
    function indexEnvironment(input, open, close) {
        const ids = [];
        let depth = 0;
        const depthCounts = {};
        const openLen = open.length;
        const closeLen = close.length;
        for (let i = 0; i < input.length; i++) {
            if (input.startsWith(open, i)) {
                if (!depthCounts[depth]) {
                    depthCounts[depth] = 0;
                }
                const depthID = depthCounts[depth]++;
                ids.push({ index: i, depth, depthID });
                depth++;
                i += openLen - 1; // Skip the length of the opening tag
                continue;
            }
            if (input.startsWith(close, i)) {
                if (depth > 0) {
                    depth--;
                    const depthID = depthCounts[depth] - 1;
                    ids.push({ index: i, depth, depthID });
                }
                else {
                    // Handle unmatched closing bracket
                    ids.push({ index: i, depth: -1, depthID: -1 });
                }
                i += closeLen - 1; // Skip the length of the closing tag
                continue;
            }
        }
        // Add any unmatched opening brackets
        while (depth > 0) {
            depth--;
            ids.push({ index: -1, depth, depthID: depthCounts[depth] - 1 });
        }
        return ids;
    }
    const map = new Map([
        ['parentheses', '(', ')'],
        ['squareBrackets', '[', ']'],
        ['curlyBraces', '{', '}'],
        ['aligned', '\\begin{aligned}', '\\end{aligned}'],
        ['align', '\\begin{align}', '\\end{align}'],
        ['array', '\\begin{array}', '\\end{array}'],
        ['bmatrix', '\\begin{bmatrix}', '\\end{bmatrix}'],
        ['Bmatrix', '\\begin{Bmatrix}', '\\end{Bmatrix}'],
        ['cases', '\\begin{cases}', '\\end{cases}'],
        ['gather', '\\begin{gather}', '\\end{gather}'],
        ['matrix', '\\begin{matrix}', '\\end{matrix}'],
        ['pmatrix', '\\begin{pmatrix}', '\\end{pmatrix}'],
        ['Vmatrix', '\\begin{Vmatrix}', '\\end{Vmatrix}'],
        ['vmatrix', '\\begin{vmatrix}', '\\end{vmatrix}'],
        ['smallmatrix', '\\begin{smallmatrix}', '\\end{smallmatrix}'],
        ['CD', '\\begin{CD}', '\\end{CD}'],
        ['eqnarray', '\\begin{eqnarray}', '\\end{eqnarray}'],
        ['eqnarray*', '\\begin{eqnarray*}', '\\end{eqnarray*}'],
        ['flalign', '\\begin{flalign}', '\\end{flalign}'],
        ['flalign*', '\\begin{flalign*}', '\\end{flalign*}'],
        ['IEEEeqnarray', '\\begin{IEEEeqnarray}', '\\end{IEEEeqnarray}'],
        ['IEEEeqnarray', '\\begin{IEEEeqnarray*}', '\\end{IEEEeqnarray*}'],
        ['multline', '\\begin{multline}', '\\end{multline}'],
        ['split', '\\begin{split}', '\\end{split}'],
        ['subarray', '\\begin{subarray}', '\\end{subarray}'],
        ['subnumcases', '\\begin{subnumcases}', '\\end{subnumcases}'],
        ['substack', '\\begin{substack}', '\\end{substack}'],
    ].map(env => ([env[0], { open: env[1], close: env[2], fond: [] }])));
    const keysToDelete = [];
    for (const [key, value] of map.entries()) {
        if (input.includes(value.open) || input.includes(value.close)) {
            value.fond = indexEnvironment(input, value.open, value.close);
        }
        else {
            keysToDelete.push(key);
        }
    }
    // Delete keys after iteration
    for (const key of keysToDelete) {
        map.delete(key);
    }
    console.log("map", map);
    const unmatched = [];
    for (const [key, value] of map.entries()) {
        for (const obj of value.fond) {
            if (obj.index === -1) {
                const match = value.fond.find(o => o.index >= 0 && o.depth === obj.depth && o.depthID === obj.depthID);
                if (match)
                    unmatched.push(match.index + value.open.length);
            }
            else if (obj.depth < 0 || obj.depthID < 0) {
                unmatched.push(obj.index + value.close.length);
            }
        }
    }
    let index = (unmatched.sort((a, b) => b - a)[0]);
    return index !== undefined ? index : 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b2ZyYWN0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ZlYXR1cmVzL2F1dG9mcmFjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsbUJBQW1CLEVBQWtCLE1BQU0sd0JBQXdCLENBQUM7QUFDN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG1EQUFtRCxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNqRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUlyRSxNQUFNLENBQUMsTUFBTSxlQUFlLEdBQUcsQ0FBQyxJQUFnQixFQUFFLEdBQVksRUFBVSxFQUFFO0lBRXpFLEtBQUssTUFBTSxLQUFLLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hDLHFCQUFxQixDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVyQyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ2IsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUMsQ0FBQTtBQUdELE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLENBQUMsSUFBZ0IsRUFBRSxHQUFZLEVBQUUsS0FBcUIsRUFBVSxFQUFFO0lBRXRHLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNDLE1BQU0sRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFDLEdBQUcsS0FBSyxDQUFDO0lBRXpCLGtEQUFrRDtJQUNsRCxLQUFLLE1BQU0sR0FBRyxJQUFJLFFBQVEsQ0FBQyx3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QUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pELE9BQU8sS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDM0MsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclZpZXcgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xyXG5pbXBvcnQgeyBTZWxlY3Rpb25SYW5nZSB9IGZyb20gXCJAY29kZW1pcnJvci9zdGF0ZVwiO1xyXG5pbXBvcnQgeyBmaW5kTWF0Y2hpbmdCcmFja2V0LCBnZXRPcGVuQnJhY2tldCB9IGZyb20gXCJzcmMvdXRpbHMvZWRpdG9yX3V0aWxzXCI7XHJcbmltcG9ydCB7IHF1ZXVlU25pcHBldCB9IGZyb20gXCJzcmMvc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XHJcbmltcG9ydCB7IGV4cGFuZFNuaXBwZXRzIH0gZnJvbSBcInNyYy9zbmlwcGV0cy9zbmlwcGV0X21hbmFnZW1lbnRcIjtcclxuaW1wb3J0IHsgYXV0b0VubGFyZ2VCcmFja2V0cyB9IGZyb20gXCIuL2F1dG9fZW5sYXJnZV9icmFja2V0c1wiO1xyXG5pbXBvcnQgeyBDb250ZXh0IH0gZnJvbSBcInNyYy91dGlscy9jb250ZXh0XCI7XHJcbmltcG9ydCB7IGdldExhdGV4U3VpdGVDb25maWcgfSBmcm9tIFwic3JjL3NuaXBwZXRzL2NvZGVtaXJyb3IvY29uZmlnXCI7XHJcbmltcG9ydCB7IHZhbHVlIH0gZnJvbSBcInZhbGlib3RcIjtcclxuXHJcblxyXG5leHBvcnQgY29uc3QgcnVuQXV0b0ZyYWN0aW9uID0gKHZpZXc6IEVkaXRvclZpZXcsIGN0eDogQ29udGV4dCk6Ym9vbGVhbiA9PiB7XHJcblxyXG5cdGZvciAoY29uc3QgcmFuZ2Ugb2YgY3R4LnJhbmdlcykge1xyXG5cdFx0cnVuQXV0b0ZyYWN0aW9uQ3Vyc29yKHZpZXcsIGN0eCwgcmFuZ2UpO1xyXG5cdH1cclxuXHJcblx0Y29uc3Qgc3VjY2VzcyA9IGV4cGFuZFNuaXBwZXRzKHZpZXcpO1xyXG5cclxuXHRpZiAoc3VjY2Vzcykge1xyXG5cdFx0YXV0b0VubGFyZ2VCcmFja2V0cyh2aWV3KTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBzdWNjZXNzO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IHJ1bkF1dG9GcmFjdGlvbkN1cnNvciA9ICh2aWV3OiBFZGl0b3JWaWV3LCBjdHg6IENvbnRleHQsIHJhbmdlOiBTZWxlY3Rpb25SYW5nZSk6Ym9vbGVhbiA9PiB7XHJcblxyXG5cdGNvbnN0IHNldHRpbmdzID0gZ2V0TGF0ZXhTdWl0ZUNvbmZpZyh2aWV3KTtcclxuXHRjb25zdCB7ZnJvbSwgdG99ID0gcmFuZ2U7XHJcblxyXG5cdC8vIERvbid0IHJ1biBhdXRvZnJhY3Rpb24gaW4gZXhjbHVkZWQgZW52aXJvbm1lbnRzXHJcblx0Zm9yIChjb25zdCBlbnYgb2Ygc2V0dGluZ3MuYXV0b2ZyYWN0aW9uRXhjbHVkZWRFbnZzKSB7XHJcblx0XHRpZiAoY3R4LmlzV2l0aGluRW52aXJvbm1lbnQodG8sIGVudikpIHtcclxuXHRcdFx0cmV0dXJuIGZhbHNlO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0Ly8gR2V0IHRoZSBib3VuZHMgb2YgdGhlIGVxdWF0aW9uXHJcblx0Y29uc3QgcmVzdWx0ID0gY3R4LmdldEJvdW5kcygpO1xyXG5cdGlmICghcmVzdWx0KSByZXR1cm4gZmFsc2U7XHJcblx0Y29uc3QgZXFuU3RhcnQgPSByZXN1bHQuc3RhcnQ7XHJcblxyXG5cdGNvbnN0IGN1ckxpbmVzID0gdmlldy5zdGF0ZS5zbGljZURvYyhlcW5TdGFydCwgdG8pLnNwbGl0KFwiXFxuXCIpO1xyXG5cdGxldCBzdHJpbmcgPSBjdXJMaW5lc1tjdXJMaW5lcy5sZW5ndGggLSAxXTtcclxuXHRsZXQgc3RhcnQgPSBlcW5TdGFydDtcclxuXHJcblx0aWYgKGZyb20gIT0gdG8pIHtcclxuXHRcdC8vIFdlIGhhdmUgYSBzZWxlY3Rpb25cclxuXHRcdC8vIFNldCBzdGFydCB0byB0aGUgYmVnaW5uaW5nIG9mIHRoZSBzZWxlY3Rpb25cclxuXHJcblx0XHRzdGFydCA9IGZyb207XHJcblx0fVxyXG5cdGVsc2Uge1xyXG5cdFx0Ly8gRmluZCB0aGUgY29udGVudHMgb2YgdGhlIGZyYWN0aW9uXHJcblx0XHQvLyBNYXRjaCBldmVyeXRoaW5nIGV4Y2VwdCBzcGFjZXMgYW5kICstLCBidXQgYWxsb3cgdGhlc2UgY2hhcmFjdGVycyBpbiBicmFja2V0c1xyXG5cclxuXHRcdC8vIEFsc28sIGFsbG93IHNwYWNlcyBhZnRlciBncmVlayBsZXR0ZXJzXHJcblx0XHQvLyBCeSByZXBsYWNpbmcgc3BhY2VzIGFmdGVyIGdyZWVrIGxldHRlcnMgd2l0aCBhIGR1bW15IGNoYXJhY3RlciAoIylcclxuXHJcblx0XHRjb25zdCBncmVlayA9IFwiYWxwaGF8YmV0YXxnYW1tYXxHYW1tYXxkZWx0YXxEZWx0YXxlcHNpbG9ufHZhcmVwc2lsb258emV0YXxldGF8dGhldGF8VGhldGF8aW90YXxrYXBwYXxsYW1iZGF8TGFtYmRhfG11fG51fG9taWNyb258eGl8WGl8cGl8UGl8cmhvfHNpZ21hfFNpZ21hfHRhdXx1cHNpbG9ufFVwc2lsb258dmFycGhpfHBoaXxQaGl8Y2hpfHBzaXxQc2l8b21lZ2F8T21lZ2F8Y2RvdHxmcmFjfGJpbm9tXCI7XHJcblx0XHRjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoXCIoXCIgKyBncmVlayArIFwiKSBcIiwgXCJnXCIpO1xyXG5cdFx0c3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVnZXgsIFwiJDEjXCIpO1xyXG5cdFx0Y29uc29sZS5sb2coXCJyZXBsYWNlKHJlZ2V4LCBcXFwiJDEjXFxcIilcIixzdHJpbmcpO1xyXG5cdFx0c3RyaW5nPXN0cmluZy5zbGljZShzdHJpbmcubGFzdEluZGV4T2YoXCIgXCIpKzEpO1xyXG5cdFx0Y29uc29sZS5sb2coXCJsYXN0SW5kZXhPZihcXFwiIFxcXCIpXCIsc3RyaW5nKTtcclxuXHRcdHN0cmluZyA9IHN0cmluZy5zbGljZShpZGVudGlmeUJyYWNrZXRzKHN0cmluZykpO1xyXG5cdFx0Y29uc29sZS5sb2coXCJpZGVudGlmeUJyYWNrZXRzXCIsc3RyaW5nKTtcclxuXHJcblx0XHRjb25zdCByZW1vdmVSZWdleCA9IC8oPzpefFteXFxcXF0pW15hLXpBLVowLTktK14lJCNAISxfLlxcXFwoKXt9W1xcXV0vO1xyXG5cdFx0d2hpbGUgKHJlbW92ZVJlZ2V4LnRlc3Qoc3RyaW5nKSkge1xyXG5cdFx0XHRzdHJpbmcgPSBzdHJpbmcuc2xpY2Uoc3RyaW5nLm1hdGNoKHJlbW92ZVJlZ2V4KT8uaW5kZXghICsgMSk7XHJcblx0XHR9XHJcblx0XHRzdHJpbmcgPSBzdHJpbmcuc3RhcnRzV2l0aChcIitcIikgPyBzdHJpbmcuc2xpY2UoMSkgOiBzdHJpbmc7XHJcblx0fVxyXG5cdFxyXG5cdHN0YXJ0PSh0by1zdHJpbmcubGVuZ3RoKTtcclxuXHRpZiAoc3RhcnQgPT09IHRvKSB7IHJldHVybiBmYWxzZTsgfVxyXG5cclxuXHRsZXQgbnVtZXJhdG9yID0gdmlldy5zdGF0ZS5zbGljZURvYyhzdGFydCwgdG8pO1xyXG5cclxuXHRpZiAobnVtZXJhdG9yLmF0KDApID09PSBcIihcIiAmJiBudW1lcmF0b3IuYXQoLTEpID09PSBcIilcIikge1xyXG5cdFx0Y29uc3QgY2xvc2luZyA9IGZpbmRNYXRjaGluZ0JyYWNrZXQobnVtZXJhdG9yLCAwLCBcIihcIiwgXCIpXCIsIGZhbHNlKTtcclxuXHRcdGlmIChjbG9zaW5nID09PSBudW1lcmF0b3IubGVuZ3RoIC0gMSkge1xyXG5cdFx0XHRudW1lcmF0b3IgPSBudW1lcmF0b3Iuc2xpY2UoMSwgLTEpO1xyXG5cdFx0fVxyXG5cdH1cclxuXHRjb25zdCByZXBsYWNlbWVudCA9IGBcXFxcZnJhY3ske251bWVyYXRvcn19eyQwfSQxYFxyXG5cdHF1ZXVlU25pcHBldCh2aWV3LCB0by1zdHJpbmcubGVuZ3RoLCB0bywgcmVwbGFjZW1lbnQsIFwiL1wiKTtcclxuXHRyZXR1cm4gdHJ1ZTtcclxufVxyXG5leHBvcnQgZnVuY3Rpb24gaWRlbnRpZnlCcmFja2V0cyhpbnB1dDogc3RyaW5nKSB7XHJcbiAgICBmdW5jdGlvbiBpbmRleEVudmlyb25tZW50KGlucHV0OiBzdHJpbmcsIG9wZW46IHN0cmluZywgY2xvc2U6IHN0cmluZykge1xyXG4gICAgICAgIGNvbnN0IGlkczogQXJyYXk8eyBpbmRleDogbnVtYmVyOyBkZXB0aDogbnVtYmVyOyBkZXB0aElEOiBudW1iZXIgfT4gPSBbXTtcclxuICAgICAgICBsZXQgZGVwdGggPSAwO1xyXG4gICAgICAgIGNvbnN0IGRlcHRoQ291bnRzOiBSZWNvcmQ8bnVtYmVyLCBudW1iZXI+ID0ge307XHJcbiAgICAgICAgY29uc3Qgb3BlbkxlbiA9IG9wZW4ubGVuZ3RoO1xyXG4gICAgICAgIGNvbnN0IGNsb3NlTGVuID0gY2xvc2UubGVuZ3RoO1xyXG5cclxuICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGlucHV0Lmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmIChpbnB1dC5zdGFydHNXaXRoKG9wZW4sIGkpKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWRlcHRoQ291bnRzW2RlcHRoXSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRlcHRoQ291bnRzW2RlcHRoXSA9IDA7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkZXB0aElEID0gZGVwdGhDb3VudHNbZGVwdGhdKys7XHJcbiAgICAgICAgICAgICAgICBpZHMucHVzaCh7IGluZGV4OiBpLCBkZXB0aCwgZGVwdGhJRCB9KTtcclxuICAgICAgICAgICAgICAgIGRlcHRoKys7XHJcbiAgICAgICAgICAgICAgICBpICs9IG9wZW5MZW4gLSAxOyAvLyBTa2lwIHRoZSBsZW5ndGggb2YgdGhlIG9wZW5pbmcgdGFnXHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBpZiAoaW5wdXQuc3RhcnRzV2l0aChjbG9zZSwgaSkpIHtcclxuICAgICAgICAgICAgICAgIGlmIChkZXB0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICBkZXB0aC0tO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGRlcHRoSUQgPSBkZXB0aENvdW50c1tkZXB0aF0gLSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIGlkcy5wdXNoKHsgaW5kZXg6IGksIGRlcHRoLCBkZXB0aElEIH0pO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAvLyBIYW5kbGUgdW5tYXRjaGVkIGNsb3NpbmcgYnJhY2tldFxyXG4gICAgICAgICAgICAgICAgICAgIGlkcy5wdXNoKHsgaW5kZXg6IGksIGRlcHRoOiAtMSwgZGVwdGhJRDogLTEgfSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBpICs9IGNsb3NlTGVuIC0gMTsgLy8gU2tpcCB0aGUgbGVuZ3RoIG9mIHRoZSBjbG9zaW5nIHRhZ1xyXG4gICAgICAgICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIC8vIEFkZCBhbnkgdW5tYXRjaGVkIG9wZW5pbmcgYnJhY2tldHNcclxuICAgICAgICB3aGlsZSAoZGVwdGggPiAwKSB7XHJcbiAgICAgICAgICAgIGRlcHRoLS07XHJcbiAgICAgICAgICAgIGlkcy5wdXNoKHsgaW5kZXg6IC0xLCBkZXB0aCwgZGVwdGhJRDogZGVwdGhDb3VudHNbZGVwdGhdIC0gMSB9KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiBpZHM7XHJcbiAgICB9XHJcblx0XHJcbiAgICBjb25zdCBtYXAgPSBuZXcgTWFwPHN0cmluZywgeyBvcGVuOiBzdHJpbmc7IGNsb3NlOiBzdHJpbmc7IGZvbmQ6IEFycmF5PHsgaW5kZXg6IG51bWJlcjsgZGVwdGg6IG51bWJlcjsgZGVwdGhJRDogbnVtYmVyIH0+IH0+KFxyXG5cdFx0W1xyXG5cdFx0XHRbJ3BhcmVudGhlc2VzJywnKCcsJyknXSxcclxuXHRcdFx0WydzcXVhcmVCcmFja2V0cycsJ1snLCddJ10sXHJcblx0XHRcdFsnY3VybHlCcmFjZXMnLCd7JywnfSddLFxyXG5cdFx0XHRbJ2FsaWduZWQnLCdcXFxcYmVnaW57YWxpZ25lZH0nLCdcXFxcZW5ke2FsaWduZWR9J10sXHJcblx0XHRcdFsnYWxpZ24nLCdcXFxcYmVnaW57YWxpZ259JywnXFxcXGVuZHthbGlnbn0nXSxcclxuXHRcdFx0WydhcnJheScsJ1xcXFxiZWdpbnthcnJheX0nLCdcXFxcZW5ke2FycmF5fSddLFxyXG5cdFx0XHRbJ2JtYXRyaXgnLCdcXFxcYmVnaW57Ym1hdHJpeH0nLCdcXFxcZW5ke2JtYXRyaXh9J10sXHJcblx0XHRcdFsnQm1hdHJpeCcsJ1xcXFxiZWdpbntCbWF0cml4fScsJ1xcXFxlbmR7Qm1hdHJpeH0nXSxcclxuXHRcdFx0WydjYXNlcycsJ1xcXFxiZWdpbntjYXNlc30nLCdcXFxcZW5ke2Nhc2VzfSddLFxyXG5cdFx0XHRbJ2dhdGhlcicsJ1xcXFxiZWdpbntnYXRoZXJ9JywnXFxcXGVuZHtnYXRoZXJ9J10sXHJcblx0XHRcdFsnbWF0cml4JywnXFxcXGJlZ2lue21hdHJpeH0nLCdcXFxcZW5ke21hdHJpeH0nXSxcclxuXHRcdFx0WydwbWF0cml4JywnXFxcXGJlZ2lue3BtYXRyaXh9JywnXFxcXGVuZHtwbWF0cml4fSddLFxyXG5cdFx0XHRbJ1ZtYXRyaXgnLCdcXFxcYmVnaW57Vm1hdHJpeH0nLCdcXFxcZW5ke1ZtYXRyaXh9J10sXHJcblx0XHRcdFsndm1hdHJpeCcsJ1xcXFxiZWdpbnt2bWF0cml4fScsJ1xcXFxlbmR7dm1hdHJpeH0nXSxcclxuXHRcdFx0WydzbWFsbG1hdHJpeCcsJ1xcXFxiZWdpbntzbWFsbG1hdHJpeH0nLCdcXFxcZW5ke3NtYWxsbWF0cml4fSddLFxyXG5cdFx0XHRbJ0NEJywnXFxcXGJlZ2lue0NEfScsJ1xcXFxlbmR7Q0R9J10sXHJcblx0XHRcdFsnZXFuYXJyYXknLCdcXFxcYmVnaW57ZXFuYXJyYXl9JywnXFxcXGVuZHtlcW5hcnJheX0nXSxcclxuXHRcdFx0WydlcW5hcnJheSonLCdcXFxcYmVnaW57ZXFuYXJyYXkqfScsJ1xcXFxlbmR7ZXFuYXJyYXkqfSddLFxyXG5cdFx0XHRbJ2ZsYWxpZ24nLCdcXFxcYmVnaW57ZmxhbGlnbn0nLCdcXFxcZW5ke2ZsYWxpZ259J10sXHJcblx0XHRcdFsnZmxhbGlnbionLCdcXFxcYmVnaW57ZmxhbGlnbip9JywnXFxcXGVuZHtmbGFsaWduKn0nXSxcclxuXHRcdFx0WydJRUVFZXFuYXJyYXknLCdcXFxcYmVnaW57SUVFRWVxbmFycmF5fScsJ1xcXFxlbmR7SUVFRWVxbmFycmF5fSddLFxyXG5cdFx0XHRbJ0lFRUVlcW5hcnJheScsJ1xcXFxiZWdpbntJRUVFZXFuYXJyYXkqfScsJ1xcXFxlbmR7SUVFRWVxbmFycmF5Kn0nXSxcclxuXHRcdFx0WydtdWx0bGluZScsJ1xcXFxiZWdpbnttdWx0bGluZX0nLCdcXFxcZW5ke211bHRsaW5lfSddLFxyXG5cdFx0XHRbJ3NwbGl0JywnXFxcXGJlZ2lue3NwbGl0fScsJ1xcXFxlbmR7c3BsaXR9J10sXHJcblx0XHRcdFsnc3ViYXJyYXknLCdcXFxcYmVnaW57c3ViYXJyYXl9JywnXFxcXGVuZHtzdWJhcnJheX0nXSxcclxuXHRcdFx0WydzdWJudW1jYXNlcycsJ1xcXFxiZWdpbntzdWJudW1jYXNlc30nLCdcXFxcZW5ke3N1Ym51bWNhc2VzfSddLFxyXG5cdFx0XHRbJ3N1YnN0YWNrJywnXFxcXGJlZ2lue3N1YnN0YWNrfScsJ1xcXFxlbmR7c3Vic3RhY2t9J10sXHJcblx0XHRdLm1hcChlbnYgPT4gKFtlbnZbMF0sIHsgb3BlbjogZW52WzFdLCBjbG9zZTogZW52WzJdLCBmb25kOiBbXSB9XSkpKTtcclxuXHRcclxuXHRcdFxyXG5cdGNvbnN0IGtleXNUb0RlbGV0ZSA9IFtdO1xyXG5cdGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIG1hcC5lbnRyaWVzKCkpIHtcclxuXHRcdGlmIChpbnB1dC5pbmNsdWRlcyh2YWx1ZS5vcGVuKSB8fCBpbnB1dC5pbmNsdWRlcyh2YWx1ZS5jbG9zZSkpIHtcclxuXHRcdFx0dmFsdWUuZm9uZCA9IGluZGV4RW52aXJvbm1lbnQoaW5wdXQsIHZhbHVlLm9wZW4sIHZhbHVlLmNsb3NlKTtcclxuXHRcdH0gZWxzZSB7XHJcblx0XHRcdGtleXNUb0RlbGV0ZS5wdXNoKGtleSk7XHJcblx0XHR9XHJcblx0fVxyXG5cdFxyXG5cdC8vIERlbGV0ZSBrZXlzIGFmdGVyIGl0ZXJhdGlvblxyXG5cdGZvciAoY29uc3Qga2V5IG9mIGtleXNUb0RlbGV0ZSkge1xyXG5cdFx0bWFwLmRlbGV0ZShrZXkpO1xyXG5cdH1cclxuXHRcdFxyXG5cdGNvbnNvbGUubG9nKFwibWFwXCIsbWFwKTtcclxuICAgIGNvbnN0IHVubWF0Y2hlZDogbnVtYmVyW10gPSBbXTtcclxuXHJcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBtYXAuZW50cmllcygpKSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBvYmogb2YgdmFsdWUuZm9uZCkge1xyXG4gICAgICAgICAgICBpZiAob2JqLmluZGV4ID09PSAtMSkge1xyXG5cdFx0XHRcdGNvbnN0IG1hdGNoPXZhbHVlLmZvbmQuZmluZChvID0+IG8uaW5kZXggPj0gMCAmJiBvLmRlcHRoID09PSBvYmouZGVwdGggJiYgby5kZXB0aElEID09PSBvYmouZGVwdGhJRCk7XHJcblx0XHRcdFx0aWYobWF0Y2gpXHJcbiAgICAgICAgICAgICAgICBcdHVubWF0Y2hlZC5wdXNoKG1hdGNoLmluZGV4K3ZhbHVlLm9wZW4ubGVuZ3RoKTtcclxuICAgICAgICAgICAgfVxyXG5cdFx0XHRlbHNlIGlmKG9iai5kZXB0aDwwfHxvYmouZGVwdGhJRDwwKXtcclxuXHRcdFx0XHR1bm1hdGNoZWQucHVzaChvYmouaW5kZXgrdmFsdWUuY2xvc2UubGVuZ3RoKTtcclxuXHRcdFx0fVxyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBsZXQgaW5kZXggPSAodW5tYXRjaGVkLnNvcnQoKGEsIGIpID0+IGIgLSBhKVswXSk7XHJcbiAgICByZXR1cm4gaW5kZXggIT09IHVuZGVmaW5lZCA/IGluZGV4IDogMDtcclxufVxyXG4iXX0=