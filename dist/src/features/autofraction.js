import { findMatchingBracket } from "src/utils/editor_utils";
import { queueSnippet } from "src/snippets/codemirror/snippet_queue_state_field";
import { expandSnippets } from "src/snippets/snippet_management";
import { autoEnlargeBrackets } from "./auto_enlarge_brackets";
import { getLatexSuiteConfig } from "src/snippets/codemirror/config";
export const runAutoFraction = (view, ctx) => {
    for (const range of ctx.ranges) {
        runAutoFractionCursor(view, ctx, range);
    }
    const success = expandSnippets(view);
    if (success) {
        autoEnlargeBrackets(view);
    }
    return success;
};
export const runAutoFractionCursor = (view, ctx, range) => {
    const settings = getLatexSuiteConfig(view);
    const { from, to } = range;
    // Don't run autofraction in excluded environments
    for (const env of settings.autofractionExcludedEnvs) {
        if (ctx.isWithinEnvironment(to, env)) {
            return false;
        }
    }
    // Get the bounds of the equation
    const result = ctx.getBounds();
    if (!result)
        return false;
    const eqnStart = result.start;
    const curLines = view.state.sliceDoc(eqnStart, to).split("\n");
    let string = curLines[curLines.length - 1];
    let start = eqnStart;
    if (from != to) {
        // We have a selection
        // Set start to the beginning of the selection
        start = from;
    }
    else {
        // Find the contents of the fraction
        // Match everything except spaces and +-, but allow these characters in brackets
        // Also, allow spaces after greek letters
        // By replacing spaces after greek letters with a dummy character (#)
        const greek = "alpha|beta|gamma|Gamma|delta|Delta|epsilon|varepsilon|zeta|eta|theta|Theta|iota|kappa|lambda|Lambda|mu|nu|omicron|xi|Xi|pi|Pi|rho|sigma|Sigma|tau|upsilon|Upsilon|varphi|phi|Phi|chi|psi|Psi|omega|Omega";
        const regex = new RegExp("(" + greek + ")\s", "g");
        string = string.replace(regex, "$1#$2");
        console.log('sliceToMatching(string)', sliceToMatching(string));
    }
    if (start === to) {
        return false;
    }
    // Run autofraction
    let numerator = view.state.sliceDoc(start, to);
    // Remove unnecessary outer parentheses
    if (numerator.at(0) === "(" && numerator.at(-1) === ")") {
        const closing = findMatchingBracket(numerator, 0, "(", ")", false);
        if (closing === numerator.length - 1) {
            numerator = numerator.slice(1, -1);
        }
    }
    const replacement = `\\frac{${string}}{$0}$1`;
    queueSnippet(view, to - string.length, to, replacement, "/");
    return true;
};
export function sliceToMatching(input) {
    const depthCounts = new Map([
        ['round', { open: 0, close: 0, pairMatchCount: 0, offset: 0 }],
        ['square', { open: 0, close: 0, pairMatchCount: 0, offset: 0 }],
        ['curly', { open: 0, close: 0, pairMatchCount: 0, offset: 0 }],
    ]);
    for (let i = 0; i < input.length; i++) {
        const char = input[i];
        if (char === '(' || char === '[' || char === '{') {
            const type = char === '(' ? 'round' : char === '[' ? 'square' : 'curly';
            const current = depthCounts.get(type);
            if (current)
                current.open++;
        }
        else if (char === ')' || char === ']' || char === '}') {
            const type = char === ')' ? 'round' : char === ']' ? 'square' : 'curly';
            const current = depthCounts.get(type);
            if (current)
                current.close++;
        }
    }
    for (const [key, value] of depthCounts.entries()) {
        value.pairMatchCount = Math.min(value.open, value.close);
        value.offset = value.open - value.close;
    }
    return depthCounts;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b2ZyYWN0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ZlYXR1cmVzL2F1dG9mcmFjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsbUJBQW1CLEVBQWtCLE1BQU0sd0JBQXdCLENBQUM7QUFDN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG1EQUFtRCxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNqRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUlyRSxNQUFNLENBQUMsTUFBTSxlQUFlLEdBQUcsQ0FBQyxJQUFnQixFQUFFLEdBQVksRUFBVSxFQUFFO0lBRXpFLEtBQUssTUFBTSxLQUFLLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hDLHFCQUFxQixDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVyQyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ2IsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUMsQ0FBQTtBQUdELE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLENBQUMsSUFBZ0IsRUFBRSxHQUFZLEVBQUUsS0FBcUIsRUFBVSxFQUFFO0lBRXRHLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNDLE1BQU0sRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFDLEdBQUcsS0FBSyxDQUFDO0lBRXpCLGtEQUFrRDtJQUNsRCxLQUFLLE1BQU0sR0FBRyxJQUFJLFFBQVEsQ0FBQyx3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QUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFDakMsQ0FBQztJQUNMLENBQUM7SUFFRCxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksV0FBVyxDQUFDLE9BQU8sRUFBRSxFQUFFLENBQUM7UUFDL0MsS0FBSyxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pELEtBQUssQ0FBQyxNQUFNLEdBQUcsS0FBSyxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDO0lBQzVDLENBQUM7SUFFRCxPQUFPLFdBQVcsQ0FBQztBQUN2QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldyB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IFNlbGVjdGlvblJhbmdlIH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XHJcbmltcG9ydCB7IGZpbmRNYXRjaGluZ0JyYWNrZXQsIGdldE9wZW5CcmFja2V0IH0gZnJvbSBcInNyYy91dGlscy9lZGl0b3JfdXRpbHNcIjtcclxuaW1wb3J0IHsgcXVldWVTbmlwcGV0IH0gZnJvbSBcInNyYy9zbmlwcGV0cy9jb2RlbWlycm9yL3NuaXBwZXRfcXVldWVfc3RhdGVfZmllbGRcIjtcclxuaW1wb3J0IHsgZXhwYW5kU25pcHBldHMgfSBmcm9tIFwic3JjL3NuaXBwZXRzL3NuaXBwZXRfbWFuYWdlbWVudFwiO1xyXG5pbXBvcnQgeyBhdXRvRW5sYXJnZUJyYWNrZXRzIH0gZnJvbSBcIi4vYXV0b19lbmxhcmdlX2JyYWNrZXRzXCI7XHJcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwic3JjL3V0aWxzL2NvbnRleHRcIjtcclxuaW1wb3J0IHsgZ2V0TGF0ZXhTdWl0ZUNvbmZpZyB9IGZyb20gXCJzcmMvc25pcHBldHMvY29kZW1pcnJvci9jb25maWdcIjtcclxuaW1wb3J0IHsgdmFsdWUgfSBmcm9tIFwidmFsaWJvdFwiO1xyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBydW5BdXRvRnJhY3Rpb24gPSAodmlldzogRWRpdG9yVmlldywgY3R4OiBDb250ZXh0KTpib29sZWFuID0+IHtcclxuXHJcblx0Zm9yIChjb25zdCByYW5nZSBvZiBjdHgucmFuZ2VzKSB7XHJcblx0XHRydW5BdXRvRnJhY3Rpb25DdXJzb3IodmlldywgY3R4LCByYW5nZSk7XHJcblx0fVxyXG5cclxuXHRjb25zdCBzdWNjZXNzID0gZXhwYW5kU25pcHBldHModmlldyk7XHJcblxyXG5cdGlmIChzdWNjZXNzKSB7XHJcblx0XHRhdXRvRW5sYXJnZUJyYWNrZXRzKHZpZXcpO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIHN1Y2Nlc3M7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgY29uc3QgcnVuQXV0b0ZyYWN0aW9uQ3Vyc29yID0gKHZpZXc6IEVkaXRvclZpZXcsIGN0eDogQ29udGV4dCwgcmFuZ2U6IFNlbGVjdGlvblJhbmdlKTpib29sZWFuID0+IHtcclxuXHJcblx0Y29uc3Qgc2V0dGluZ3MgPSBnZXRMYXRleFN1aXRlQ29uZmlnKHZpZXcpO1xyXG5cdGNvbnN0IHtmcm9tLCB0b30gPSByYW5nZTtcclxuXHJcblx0Ly8gRG9uJ3QgcnVuIGF1dG9mcmFjdGlvbiBpbiBleGNsdWRlZCBlbnZpcm9ubWVudHNcclxuXHRmb3IgKGNvbnN0IGVudiBvZiBzZXR0aW5ncy5hdXRvZnJhY3Rpb25FeGNsdWRlZEVudnMpIHtcclxuXHRcdGlmIChjdHguaXNXaXRoaW5FbnZpcm9ubWVudCh0bywgZW52KSkge1xyXG5cdFx0XHRyZXR1cm4gZmFsc2U7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHQvLyBHZXQgdGhlIGJvdW5kcyBvZiB0aGUgZXF1YXRpb25cclxuXHRjb25zdCByZXN1bHQgPSBjdHguZ2V0Qm91bmRzKCk7XHJcblx0aWYgKCFyZXN1bHQpIHJldHVybiBmYWxzZTtcclxuXHRjb25zdCBlcW5TdGFydCA9IHJlc3VsdC5zdGFydDtcclxuXHJcblx0Y29uc3QgY3VyTGluZXMgPSB2aWV3LnN0YXRlLnNsaWNlRG9jKGVxblN0YXJ0LCB0bykuc3BsaXQoXCJcXG5cIik7XHJcblx0bGV0IHN0cmluZyA9IGN1ckxpbmVzW2N1ckxpbmVzLmxlbmd0aCAtIDFdO1xyXG5cdGxldCBzdGFydCA9IGVxblN0YXJ0O1xyXG5cclxuXHRpZiAoZnJvbSAhPSB0bykge1xyXG5cdFx0Ly8gV2UgaGF2ZSBhIHNlbGVjdGlvblxyXG5cdFx0Ly8gU2V0IHN0YXJ0IHRvIHRoZSBiZWdpbm5pbmcgb2YgdGhlIHNlbGVjdGlvblxyXG5cclxuXHRcdHN0YXJ0ID0gZnJvbTtcclxuXHR9XHJcblx0ZWxzZSB7XHJcblx0XHQvLyBGaW5kIHRoZSBjb250ZW50cyBvZiB0aGUgZnJhY3Rpb25cclxuXHRcdC8vIE1hdGNoIGV2ZXJ5dGhpbmcgZXhjZXB0IHNwYWNlcyBhbmQgKy0sIGJ1dCBhbGxvdyB0aGVzZSBjaGFyYWN0ZXJzIGluIGJyYWNrZXRzXHJcblxyXG5cdFx0Ly8gQWxzbywgYWxsb3cgc3BhY2VzIGFmdGVyIGdyZWVrIGxldHRlcnNcclxuXHRcdC8vIEJ5IHJlcGxhY2luZyBzcGFjZXMgYWZ0ZXIgZ3JlZWsgbGV0dGVycyB3aXRoIGEgZHVtbXkgY2hhcmFjdGVyICgjKVxyXG5cclxuXHRcdGNvbnN0IGdyZWVrID0gXCJhbHBoYXxiZXRhfGdhbW1hfEdhbW1hfGRlbHRhfERlbHRhfGVwc2lsb258dmFyZXBzaWxvbnx6ZXRhfGV0YXx0aGV0YXxUaGV0YXxpb3RhfGthcHBhfGxhbWJkYXxMYW1iZGF8bXV8bnV8b21pY3Jvbnx4aXxYaXxwaXxQaXxyaG98c2lnbWF8U2lnbWF8dGF1fHVwc2lsb258VXBzaWxvbnx2YXJwaGl8cGhpfFBoaXxjaGl8cHNpfFBzaXxvbWVnYXxPbWVnYVwiO1xyXG5cdFx0Y29uc3QgcmVnZXggPSBuZXcgUmVnRXhwKFwiKFwiICsgZ3JlZWsgKyBcIilcXHNcIiwgXCJnXCIpO1xyXG5cdFx0c3RyaW5nID0gc3RyaW5nLnJlcGxhY2UocmVnZXgsIFwiJDEjJDJcIik7XHJcblxyXG5cdFx0Y29uc29sZS5sb2coJ3NsaWNlVG9NYXRjaGluZyhzdHJpbmcpJyxzbGljZVRvTWF0Y2hpbmcoc3RyaW5nKSk7XHJcblx0fVxyXG5cclxuXHJcblx0aWYgKHN0YXJ0ID09PSB0bykgeyByZXR1cm4gZmFsc2U7IH1cclxuXHJcblx0Ly8gUnVuIGF1dG9mcmFjdGlvblxyXG5cdGxldCBudW1lcmF0b3IgPSB2aWV3LnN0YXRlLnNsaWNlRG9jKHN0YXJ0LCB0byk7XHJcblxyXG5cdC8vIFJlbW92ZSB1bm5lY2Vzc2FyeSBvdXRlciBwYXJlbnRoZXNlc1xyXG5cdGlmIChudW1lcmF0b3IuYXQoMCkgPT09IFwiKFwiICYmIG51bWVyYXRvci5hdCgtMSkgPT09IFwiKVwiKSB7XHJcblx0XHRjb25zdCBjbG9zaW5nID0gZmluZE1hdGNoaW5nQnJhY2tldChudW1lcmF0b3IsIDAsIFwiKFwiLCBcIilcIiwgZmFsc2UpO1xyXG5cdFx0aWYgKGNsb3NpbmcgPT09IG51bWVyYXRvci5sZW5ndGggLSAxKSB7XHJcblx0XHRcdG51bWVyYXRvciA9IG51bWVyYXRvci5zbGljZSgxLCAtMSk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRjb25zdCByZXBsYWNlbWVudCA9IGBcXFxcZnJhY3ske3N0cmluZ319eyQwfSQxYFxyXG5cclxuXHRxdWV1ZVNuaXBwZXQodmlldywgdG8tc3RyaW5nLmxlbmd0aCwgdG8sIHJlcGxhY2VtZW50LCBcIi9cIik7XHJcblxyXG5cdHJldHVybiB0cnVlO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIHNsaWNlVG9NYXRjaGluZyhpbnB1dDogc3RyaW5nIHwgYW55W10pIHtcclxuICAgIGNvbnN0IGRlcHRoQ291bnRzID0gbmV3IE1hcChbXHJcbiAgICAgICAgWydyb3VuZCcsIHsgb3BlbjogMCwgY2xvc2U6IDAsIHBhaXJNYXRjaENvdW50OiAwLCBvZmZzZXQ6IDAgfV0sXHJcbiAgICAgICAgWydzcXVhcmUnLCB7IG9wZW46IDAsIGNsb3NlOiAwLCBwYWlyTWF0Y2hDb3VudDogMCwgb2Zmc2V0OiAwIH1dLFxyXG4gICAgICAgIFsnY3VybHknLCB7IG9wZW46IDAsIGNsb3NlOiAwLCBwYWlyTWF0Y2hDb3VudDogMCwgb2Zmc2V0OiAwIH1dLFxyXG4gICAgXSk7XHJcblxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBpbnB1dC5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIGNvbnN0IGNoYXIgPSBpbnB1dFtpXTtcclxuICAgICAgICBpZiAoY2hhciA9PT0gJygnIHx8IGNoYXIgPT09ICdbJyB8fCBjaGFyID09PSAneycpIHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IGNoYXIgPT09ICcoJyA/ICdyb3VuZCcgOiBjaGFyID09PSAnWycgPyAnc3F1YXJlJyA6ICdjdXJseSc7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1cnJlbnQgPSBkZXB0aENvdW50cy5nZXQodHlwZSk7XHJcbiAgICAgICAgICAgIGlmIChjdXJyZW50KSBjdXJyZW50Lm9wZW4rKztcclxuICAgICAgICB9IGVsc2UgaWYgKGNoYXIgPT09ICcpJyB8fCBjaGFyID09PSAnXScgfHwgY2hhciA9PT0gJ30nKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHR5cGUgPSBjaGFyID09PSAnKScgPyAncm91bmQnIDogY2hhciA9PT0gJ10nID8gJ3NxdWFyZScgOiAnY3VybHknO1xyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50ID0gZGVwdGhDb3VudHMuZ2V0KHR5cGUpO1xyXG4gICAgICAgICAgICBpZiAoY3VycmVudCkgY3VycmVudC5jbG9zZSsrO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBkZXB0aENvdW50cy5lbnRyaWVzKCkpIHtcclxuICAgICAgICB2YWx1ZS5wYWlyTWF0Y2hDb3VudCA9IE1hdGgubWluKHZhbHVlLm9wZW4sIHZhbHVlLmNsb3NlKTtcclxuICAgICAgICB2YWx1ZS5vZmZzZXQgPSB2YWx1ZS5vcGVuIC0gdmFsdWUuY2xvc2U7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGRlcHRoQ291bnRzO1xyXG59Il19