import { findMatchingBracket } from "src/utils/editor_utils";
import { queueSnippet } from "src/snippets/codemirror/snippet_queue_state_field";
import { expandSnippets } from "src/snippets/snippet_management";
import { autoEnlargeBrackets } from "./auto_enlarge_brackets";
import { getLatexSuiteConfig } from "src/snippets/codemirror/config";
export const runAutoFraction = (view, ctx) => {
    for (const range of ctx.ranges) {
        runAutoFractionCursor(view, ctx, range);
    }
    const success = expandSnippets(view);
    if (success) {
        autoEnlargeBrackets(view);
    }
    return success;
};
export const runAutoFractionCursor = (view, ctx, range) => {
    const settings = getLatexSuiteConfig(view);
    const { from, to } = range;
    // Don't run autofraction in excluded environments
    for (const env of settings.autofractionExcludedEnvs) {
        if (ctx.isWithinEnvironment(to, env)) {
            return false;
        }
    }
    // Get the bounds of the equation
    const result = ctx.getBounds();
    if (!result)
        return false;
    const eqnStart = result.start;
    const curLines = view.state.sliceDoc(eqnStart, to).split("\n");
    let string = curLines[curLines.length - 1];
    let start = eqnStart;
    if (from != to) {
        // We have a selection
        // Set start to the beginning of the selection
        start = from;
    }
    else {
        // Find the contents of the fraction
        // Match everything except spaces and +-, but allow these characters in brackets
        // Also, allow spaces after greek letters
        // By replacing spaces after greek letters with a dummy character (#)
        const greek = "alpha|beta|gamma|Gamma|delta|Delta|epsilon|varepsilon|zeta|eta|theta|Theta|iota|kappa|lambda|Lambda|mu|nu|omicron|xi|Xi|pi|Pi|rho|sigma|Sigma|tau|upsilon|Upsilon|varphi|phi|Phi|chi|psi|Psi|omega|Omega";
        const regex = new RegExp("(" + greek + ")\s", "g");
        string = string.replace(regex, "$1#$2");
        string = string.slice(string.lastIndexOf(" ") + 1);
        string = string.slice(identifyBrackets(string));
        const removeRegex = /(?:^|[^\\])[^a-zA-Z0-9-+^%$#@!,_.\\(){}[\]]/;
        while (removeRegex.test(string)) {
            string = string.slice(string.match(removeRegex)?.index + 1);
        }
        string = string.startsWith("+") ? string.slice(1) : string;
    }
    start = (to - string.length);
    if (start === to) {
        return false;
    }
    let numerator = view.state.sliceDoc(start, to);
    if (numerator.at(0) === "(" && numerator.at(-1) === ")") {
        const closing = findMatchingBracket(numerator, 0, "(", ")", false);
        if (closing === numerator.length - 1) {
            numerator = numerator.slice(1, -1);
        }
    }
    const replacement = `\\frac{${string}}{$0}$1`;
    queueSnippet(view, to - string.length, to, replacement, "/");
    return true;
};
export function identifyBrackets(input) {
    function indexEnvironment(input, open, close) {
        const ids = [];
        let depth = 0;
        const depthCounts = {};
        const openLen = open.length;
        const closeLen = close.length;
        for (let i = 0; i < input.length; i++) {
            if (input.startsWith(open, i)) {
                if (!depthCounts[depth]) {
                    depthCounts[depth] = 0;
                }
                const depthID = depthCounts[depth]++;
                ids.push({ index: i, depth, depthID });
                depth++;
                i += openLen - 1; // Skip the length of the opening tag
                continue;
            }
            if (input.startsWith(close, i)) {
                if (depth > 0) {
                    depth--;
                    const depthID = depthCounts[depth] - 1;
                    ids.push({ index: i, depth, depthID });
                }
                else {
                    // Handle unmatched closing bracket
                    ids.push({ index: i, depth: -1, depthID: -1 });
                }
                i += closeLen - 1; // Skip the length of the closing tag
                continue;
            }
        }
        // Add any unmatched opening brackets
        while (depth > 0) {
            depth--;
            ids.push({ index: -1, depth, depthID: depthCounts[depth] - 1 });
        }
        return ids;
    }
    const map = new Map([
        ['parentheses', '(', ')'],
        ['squareBrackets', '[', ']'],
        ['curlyBraces', '{', '}'],
        ['aligned', '\\begin{aligned}', '\\end{aligned}'],
        ['align', '\\begin{align}', '\\end{align}'],
        ['array', '\\begin{array}', '\\end{array}'],
        ['bmatrix', '\\begin{bmatrix}', '\\end{bmatrix}'],
        ['Bmatrix', '\\begin{Bmatrix}', '\\end{Bmatrix}'],
        ['cases', '\\begin{cases}', '\\end{cases}'],
        ['gather', '\\begin{gather}', '\\end{gather}'],
        ['matrix', '\\begin{matrix}', '\\end{matrix}'],
        ['pmatrix', '\\begin{pmatrix}', '\\end{pmatrix}'],
        ['Vmatrix', '\\begin{Vmatrix}', '\\end{Vmatrix}'],
        ['vmatrix', '\\begin{vmatrix}', '\\end{vmatrix}'],
        ['smallmatrix', '\\begin{smallmatrix}', '\\end{smallmatrix}'],
        ['CD', '\\begin{CD}', '\\end{CD}'],
        ['eqnarray', '\\begin{eqnarray}', '\\end{eqnarray}'],
        ['eqnarray*', '\\begin{eqnarray*}', '\\end{eqnarray*}'],
        ['flalign', '\\begin{flalign}', '\\end{flalign}'],
        ['flalign*', '\\begin{flalign*}', '\\end{flalign*}'],
        ['IEEEeqnarray', '\\begin{IEEEeqnarray}', '\\end{IEEEeqnarray}'],
        ['IEEEeqnarray', '\\begin{IEEEeqnarray*}', '\\end{IEEEeqnarray*}'],
        ['multline', '\\begin{multline}', '\\end{multline}'],
        ['split', '\\begin{split}', '\\end{split}'],
        ['subarray', '\\begin{subarray}', '\\end{subarray}'],
        ['subnumcases', '\\begin{subnumcases}', '\\end{subnumcases}'],
        ['substack', '\\begin{substack}', '\\end{substack}'],
    ].map(env => ([env[0], { open: env[1], close: env[2], fond: [] }])));
    for (const [key, value] of map.entries()) {
        value.fond = indexEnvironment(input, value.open, value.close);
    }
    const unmatched = [];
    for (const [key, value] of map.entries()) {
        for (const obj of value.fond) {
            if (obj.index === -1) {
                const match = value.fond.find(o => o.index >= 0 && o.depth === obj.depth && o.depthID === obj.depthID);
                if (match)
                    unmatched.push(match.index + value.open.length);
            }
        }
    }
    let index = (unmatched.sort((a, b) => b - a)[0]);
    return index !== undefined ? index : 0;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b2ZyYWN0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ZlYXR1cmVzL2F1dG9mcmFjdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsbUJBQW1CLEVBQWtCLE1BQU0sd0JBQXdCLENBQUM7QUFDN0UsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLG1EQUFtRCxDQUFDO0FBQ2pGLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUNqRSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUU5RCxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUlyRSxNQUFNLENBQUMsTUFBTSxlQUFlLEdBQUcsQ0FBQyxJQUFnQixFQUFFLEdBQVksRUFBVSxFQUFFO0lBRXpFLEtBQUssTUFBTSxLQUFLLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hDLHFCQUFxQixDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDekMsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFHLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUVyQyxJQUFJLE9BQU8sRUFBRSxDQUFDO1FBQ2IsbUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDM0IsQ0FBQztJQUVELE9BQU8sT0FBTyxDQUFDO0FBQ2hCLENBQUMsQ0FBQTtBQUdELE1BQU0sQ0FBQyxNQUFNLHFCQUFxQixHQUFHLENBQUMsSUFBZ0IsRUFBRSxHQUFZLEVBQUUsS0FBcUIsRUFBVSxFQUFFO0lBRXRHLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNDLE1BQU0sRUFBQyxJQUFJLEVBQUUsRUFBRSxFQUFDLEdBQUcsS0FBSyxDQUFDO0lBRXpCLGtEQUFrRDtJQUNsRCxLQUFLLE1BQU0sR0FBRyxJQUFJLFFBQVEsQ0FBQyx3QkFBd0IsRUFBRSxDQUFDO1FBQ3JELElBQUksR0FBRyxDQUFDLG1CQUFtQixDQUFDLEVBQUUsRUFBRSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3RDLE9BQU8sS0FBSyxDQUFDO1FBQ2QsQ0FBQztJQUNGLENBQUM7SUFFRCxpQ0FBaUM7SUFDakMsTUFBTSxNQUFNLEdBQUcsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDO0lBQy9CLElBQUksQ0FBQyxNQUFNO1FBQUUsT0FBTyxLQUFLLENBQUM7SUFDMUIsTUFBTSxRQUFRLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQztJQUU5QixNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQy9ELElBQUksTUFBTSxHQUFHLFFBQVEsQ0FBQyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQzNDLElBQUksS0FBSyxHQUFHLFFBQVEsQ0FBQztJQUVyQixJQUFJLElBQUksSUFBSSxFQUFFLEVBQUUsQ0FBQztRQUNoQixzQkFBc0I7UUFDdEIsOENBQThDO1FBRTlDLEtBQUssR0FBRyxJQUFJLENBQUM7SUFDZCxDQUFDO1NBQ0ksQ0FBQztRQUNMLG9DQUFvQztRQUNwQyxnRkFBZ0Y7UUFFaEYseUNBQXlDO1FBQ3pDLHFFQUFxRTtRQUVyRSxNQUFNLEtBQUssR0FBRywwTUFBME0sQ0FBQztRQUN6TixNQUFNLEtBQUssR0FBRyxJQUFJLE1BQU0sQ0FBQyxHQUFHLEdBQUcsS0FBSyxHQUFHLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztRQUNuRCxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDeEMsTUFBTSxHQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQztRQUMvQyxNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1FBRWhELE1BQU0sV0FBVyxHQUFHLDZDQUE2QyxDQUFDO1FBQ2xFLE9BQU8sV0FBVyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1lBQ2pDLE1BQU0sR0FBRyxNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEVBQUUsS0FBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzlELENBQUM7UUFDRCxNQUFNLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDO0lBQzVELENBQUM7SUFFRCxLQUFLLEdBQUMsQ0FBQyxFQUFFLEdBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3pCLElBQUksS0FBSyxLQUFLLEVBQUUsRUFBRSxDQUFDO1FBQUMsT0FBTyxLQUFLLENBQUM7SUFBQyxDQUFDO0lBRW5DLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztJQUUvQyxJQUFJLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxJQUFJLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLEVBQUUsQ0FBQztRQUN6RCxNQUFNLE9BQU8sR0FBRyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDbkUsSUFBSSxPQUFPLEtBQUssU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUN0QyxTQUFTLEdBQUcsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNwQyxDQUFDO0lBQ0YsQ0FBQztJQUNELE1BQU0sV0FBVyxHQUFHLFVBQVUsTUFBTSxTQUFTLENBQUE7SUFDN0MsWUFBWSxDQUFDLElBQUksRUFBRSxFQUFFLEdBQUMsTUFBTSxDQUFDLE1BQU0sRUFBRSxFQUFFLEVBQUUsV0FBVyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQzNELE9BQU8sSUFBSSxDQUFDO0FBQ2IsQ0FBQyxDQUFBO0FBQ0QsTUFBTSxVQUFVLGdCQUFnQixDQUFDLEtBQWE7SUFDMUMsU0FBUyxnQkFBZ0IsQ0FBQyxLQUFhLEVBQUUsSUFBWSxFQUFFLEtBQWE7UUFDaEUsTUFBTSxHQUFHLEdBQTZELEVBQUUsQ0FBQztRQUN6RSxJQUFJLEtBQUssR0FBRyxDQUFDLENBQUM7UUFDZCxNQUFNLFdBQVcsR0FBMkIsRUFBRSxDQUFDO1FBQy9DLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDNUIsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLE1BQU0sQ0FBQztRQUU5QixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ3BDLElBQUksS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDNUIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO29CQUN0QixXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUMzQixDQUFDO2dCQUNELE1BQU0sT0FBTyxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDO2dCQUNyQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztnQkFDdkMsS0FBSyxFQUFFLENBQUM7Z0JBQ1IsQ0FBQyxJQUFJLE9BQU8sR0FBRyxDQUFDLENBQUMsQ0FBQyxxQ0FBcUM7Z0JBQ3ZELFNBQVM7WUFDYixDQUFDO1lBQ0QsSUFBSSxLQUFLLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO2dCQUM3QixJQUFJLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztvQkFDWixLQUFLLEVBQUUsQ0FBQztvQkFDUixNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUN2QyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQztnQkFDM0MsQ0FBQztxQkFBTSxDQUFDO29CQUNKLG1DQUFtQztvQkFDbkMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ25ELENBQUM7Z0JBQ0QsQ0FBQyxJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUMsQ0FBQyxxQ0FBcUM7Z0JBQ3hELFNBQVM7WUFDYixDQUFDO1FBQ0wsQ0FBQztRQUVELHFDQUFxQztRQUNyQyxPQUFPLEtBQUssR0FBRyxDQUFDLEVBQUUsQ0FBQztZQUNmLEtBQUssRUFBRSxDQUFDO1lBQ1IsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsT0FBTyxFQUFFLFdBQVcsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3BFLENBQUM7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNmLENBQUM7SUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsQ0FDckI7UUFDQyxDQUFDLGFBQWEsRUFBQyxHQUFHLEVBQUMsR0FBRyxDQUFDO1FBQ3ZCLENBQUMsZ0JBQWdCLEVBQUMsR0FBRyxFQUFDLEdBQUcsQ0FBQztRQUMxQixDQUFDLGFBQWEsRUFBQyxHQUFHLEVBQUMsR0FBRyxDQUFDO1FBQ3ZCLENBQUMsU0FBUyxFQUFDLGtCQUFrQixFQUFDLGdCQUFnQixDQUFDO1FBQy9DLENBQUMsT0FBTyxFQUFDLGdCQUFnQixFQUFDLGNBQWMsQ0FBQztRQUN6QyxDQUFDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxjQUFjLENBQUM7UUFDekMsQ0FBQyxTQUFTLEVBQUMsa0JBQWtCLEVBQUMsZ0JBQWdCLENBQUM7UUFDL0MsQ0FBQyxTQUFTLEVBQUMsa0JBQWtCLEVBQUMsZ0JBQWdCLENBQUM7UUFDL0MsQ0FBQyxPQUFPLEVBQUMsZ0JBQWdCLEVBQUMsY0FBYyxDQUFDO1FBQ3pDLENBQUMsUUFBUSxFQUFDLGlCQUFpQixFQUFDLGVBQWUsQ0FBQztRQUM1QyxDQUFDLFFBQVEsRUFBQyxpQkFBaUIsRUFBQyxlQUFlLENBQUM7UUFDNUMsQ0FBQyxTQUFTLEVBQUMsa0JBQWtCLEVBQUMsZ0JBQWdCLENBQUM7UUFDL0MsQ0FBQyxTQUFTLEVBQUMsa0JBQWtCLEVBQUMsZ0JBQWdCLENBQUM7UUFDL0MsQ0FBQyxTQUFTLEVBQUMsa0JBQWtCLEVBQUMsZ0JBQWdCLENBQUM7UUFDL0MsQ0FBQyxhQUFhLEVBQUMsc0JBQXNCLEVBQUMsb0JBQW9CLENBQUM7UUFDM0QsQ0FBQyxJQUFJLEVBQUMsYUFBYSxFQUFDLFdBQVcsQ0FBQztRQUNoQyxDQUFDLFVBQVUsRUFBQyxtQkFBbUIsRUFBQyxpQkFBaUIsQ0FBQztRQUNsRCxDQUFDLFdBQVcsRUFBQyxvQkFBb0IsRUFBQyxrQkFBa0IsQ0FBQztRQUNyRCxDQUFDLFNBQVMsRUFBQyxrQkFBa0IsRUFBQyxnQkFBZ0IsQ0FBQztRQUMvQyxDQUFDLFVBQVUsRUFBQyxtQkFBbUIsRUFBQyxpQkFBaUIsQ0FBQztRQUNsRCxDQUFDLGNBQWMsRUFBQyx1QkFBdUIsRUFBQyxxQkFBcUIsQ0FBQztRQUM5RCxDQUFDLGNBQWMsRUFBQyx3QkFBd0IsRUFBQyxzQkFBc0IsQ0FBQztRQUNoRSxDQUFDLFVBQVUsRUFBQyxtQkFBbUIsRUFBQyxpQkFBaUIsQ0FBQztRQUNsRCxDQUFDLE9BQU8sRUFBQyxnQkFBZ0IsRUFBQyxjQUFjLENBQUM7UUFDekMsQ0FBQyxVQUFVLEVBQUMsbUJBQW1CLEVBQUMsaUJBQWlCLENBQUM7UUFDbEQsQ0FBQyxhQUFhLEVBQUMsc0JBQXNCLEVBQUMsb0JBQW9CLENBQUM7UUFDM0QsQ0FBQyxVQUFVLEVBQUMsbUJBQW1CLEVBQUMsaUJBQWlCLENBQUM7S0FDbEQsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBRW5FLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztRQUN2QyxLQUFLLENBQUMsSUFBSSxHQUFHLGdCQUFnQixDQUFDLEtBQUssRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsRSxDQUFDO0lBQ0QsTUFBTSxTQUFTLEdBQWEsRUFBRSxDQUFDO0lBRS9CLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztRQUN2QyxLQUFLLE1BQU0sR0FBRyxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUMzQixJQUFJLEdBQUcsQ0FBQyxLQUFLLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQztnQkFDL0IsTUFBTSxLQUFLLEdBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsS0FBSyxLQUFLLEdBQUcsQ0FBQyxLQUFLLElBQUksQ0FBQyxDQUFDLE9BQU8sS0FBSyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3JHLElBQUcsS0FBSztvQkFDSyxTQUFTLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUNuRCxDQUFDO1FBQ0wsQ0FBQztJQUNMLENBQUM7SUFFRCxJQUFJLEtBQUssR0FBRyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqRCxPQUFPLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBQzNDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFZGl0b3JWaWV3IH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcclxuaW1wb3J0IHsgU2VsZWN0aW9uUmFuZ2UgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgZmluZE1hdGNoaW5nQnJhY2tldCwgZ2V0T3BlbkJyYWNrZXQgfSBmcm9tIFwic3JjL3V0aWxzL2VkaXRvcl91dGlsc1wiO1xyXG5pbXBvcnQgeyBxdWV1ZVNuaXBwZXQgfSBmcm9tIFwic3JjL3NuaXBwZXRzL2NvZGVtaXJyb3Ivc25pcHBldF9xdWV1ZV9zdGF0ZV9maWVsZFwiO1xyXG5pbXBvcnQgeyBleHBhbmRTbmlwcGV0cyB9IGZyb20gXCJzcmMvc25pcHBldHMvc25pcHBldF9tYW5hZ2VtZW50XCI7XHJcbmltcG9ydCB7IGF1dG9FbmxhcmdlQnJhY2tldHMgfSBmcm9tIFwiLi9hdXRvX2VubGFyZ2VfYnJhY2tldHNcIjtcclxuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCJzcmMvdXRpbHMvY29udGV4dFwiO1xyXG5pbXBvcnQgeyBnZXRMYXRleFN1aXRlQ29uZmlnIH0gZnJvbSBcInNyYy9zbmlwcGV0cy9jb2RlbWlycm9yL2NvbmZpZ1wiO1xyXG5pbXBvcnQgeyB2YWx1ZSB9IGZyb20gXCJ2YWxpYm90XCI7XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IHJ1bkF1dG9GcmFjdGlvbiA9ICh2aWV3OiBFZGl0b3JWaWV3LCBjdHg6IENvbnRleHQpOmJvb2xlYW4gPT4ge1xyXG5cclxuXHRmb3IgKGNvbnN0IHJhbmdlIG9mIGN0eC5yYW5nZXMpIHtcclxuXHRcdHJ1bkF1dG9GcmFjdGlvbkN1cnNvcih2aWV3LCBjdHgsIHJhbmdlKTtcclxuXHR9XHJcblxyXG5cdGNvbnN0IHN1Y2Nlc3MgPSBleHBhbmRTbmlwcGV0cyh2aWV3KTtcclxuXHJcblx0aWYgKHN1Y2Nlc3MpIHtcclxuXHRcdGF1dG9FbmxhcmdlQnJhY2tldHModmlldyk7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gc3VjY2VzcztcclxufVxyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBydW5BdXRvRnJhY3Rpb25DdXJzb3IgPSAodmlldzogRWRpdG9yVmlldywgY3R4OiBDb250ZXh0LCByYW5nZTogU2VsZWN0aW9uUmFuZ2UpOmJvb2xlYW4gPT4ge1xyXG5cclxuXHRjb25zdCBzZXR0aW5ncyA9IGdldExhdGV4U3VpdGVDb25maWcodmlldyk7XHJcblx0Y29uc3Qge2Zyb20sIHRvfSA9IHJhbmdlO1xyXG5cclxuXHQvLyBEb24ndCBydW4gYXV0b2ZyYWN0aW9uIGluIGV4Y2x1ZGVkIGVudmlyb25tZW50c1xyXG5cdGZvciAoY29uc3QgZW52IG9mIHNldHRpbmdzLmF1dG9mcmFjdGlvbkV4Y2x1ZGVkRW52cykge1xyXG5cdFx0aWYgKGN0eC5pc1dpdGhpbkVudmlyb25tZW50KHRvLCBlbnYpKSB7XHJcblx0XHRcdHJldHVybiBmYWxzZTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdC8vIEdldCB0aGUgYm91bmRzIG9mIHRoZSBlcXVhdGlvblxyXG5cdGNvbnN0IHJlc3VsdCA9IGN0eC5nZXRCb3VuZHMoKTtcclxuXHRpZiAoIXJlc3VsdCkgcmV0dXJuIGZhbHNlO1xyXG5cdGNvbnN0IGVxblN0YXJ0ID0gcmVzdWx0LnN0YXJ0O1xyXG5cclxuXHRjb25zdCBjdXJMaW5lcyA9IHZpZXcuc3RhdGUuc2xpY2VEb2MoZXFuU3RhcnQsIHRvKS5zcGxpdChcIlxcblwiKTtcclxuXHRsZXQgc3RyaW5nID0gY3VyTGluZXNbY3VyTGluZXMubGVuZ3RoIC0gMV07XHJcblx0bGV0IHN0YXJ0ID0gZXFuU3RhcnQ7XHJcblxyXG5cdGlmIChmcm9tICE9IHRvKSB7XHJcblx0XHQvLyBXZSBoYXZlIGEgc2VsZWN0aW9uXHJcblx0XHQvLyBTZXQgc3RhcnQgdG8gdGhlIGJlZ2lubmluZyBvZiB0aGUgc2VsZWN0aW9uXHJcblxyXG5cdFx0c3RhcnQgPSBmcm9tO1xyXG5cdH1cclxuXHRlbHNlIHtcclxuXHRcdC8vIEZpbmQgdGhlIGNvbnRlbnRzIG9mIHRoZSBmcmFjdGlvblxyXG5cdFx0Ly8gTWF0Y2ggZXZlcnl0aGluZyBleGNlcHQgc3BhY2VzIGFuZCArLSwgYnV0IGFsbG93IHRoZXNlIGNoYXJhY3RlcnMgaW4gYnJhY2tldHNcclxuXHJcblx0XHQvLyBBbHNvLCBhbGxvdyBzcGFjZXMgYWZ0ZXIgZ3JlZWsgbGV0dGVyc1xyXG5cdFx0Ly8gQnkgcmVwbGFjaW5nIHNwYWNlcyBhZnRlciBncmVlayBsZXR0ZXJzIHdpdGggYSBkdW1teSBjaGFyYWN0ZXIgKCMpXHJcblxyXG5cdFx0Y29uc3QgZ3JlZWsgPSBcImFscGhhfGJldGF8Z2FtbWF8R2FtbWF8ZGVsdGF8RGVsdGF8ZXBzaWxvbnx2YXJlcHNpbG9ufHpldGF8ZXRhfHRoZXRhfFRoZXRhfGlvdGF8a2FwcGF8bGFtYmRhfExhbWJkYXxtdXxudXxvbWljcm9ufHhpfFhpfHBpfFBpfHJob3xzaWdtYXxTaWdtYXx0YXV8dXBzaWxvbnxVcHNpbG9ufHZhcnBoaXxwaGl8UGhpfGNoaXxwc2l8UHNpfG9tZWdhfE9tZWdhXCI7XHJcblx0XHRjb25zdCByZWdleCA9IG5ldyBSZWdFeHAoXCIoXCIgKyBncmVlayArIFwiKVxcc1wiLCBcImdcIik7XHJcblx0XHRzdHJpbmcgPSBzdHJpbmcucmVwbGFjZShyZWdleCwgXCIkMSMkMlwiKTtcclxuXHRcdHN0cmluZz1zdHJpbmcuc2xpY2Uoc3RyaW5nLmxhc3RJbmRleE9mKFwiIFwiKSsxKTtcclxuXHRcdHN0cmluZyA9IHN0cmluZy5zbGljZShpZGVudGlmeUJyYWNrZXRzKHN0cmluZykpO1xyXG5cclxuXHRcdGNvbnN0IHJlbW92ZVJlZ2V4ID0gLyg/Ol58W15cXFxcXSlbXmEtekEtWjAtOS0rXiUkI0AhLF8uXFxcXCgpe31bXFxdXS87XHJcblx0XHR3aGlsZSAocmVtb3ZlUmVnZXgudGVzdChzdHJpbmcpKSB7XHJcblx0XHRcdHN0cmluZyA9IHN0cmluZy5zbGljZShzdHJpbmcubWF0Y2gocmVtb3ZlUmVnZXgpPy5pbmRleCEgKyAxKTtcclxuXHRcdH1cclxuXHRcdHN0cmluZyA9IHN0cmluZy5zdGFydHNXaXRoKFwiK1wiKSA/IHN0cmluZy5zbGljZSgxKSA6IHN0cmluZztcclxuXHR9XHJcblx0XHJcblx0c3RhcnQ9KHRvLXN0cmluZy5sZW5ndGgpO1xyXG5cdGlmIChzdGFydCA9PT0gdG8pIHsgcmV0dXJuIGZhbHNlOyB9XHJcblxyXG5cdGxldCBudW1lcmF0b3IgPSB2aWV3LnN0YXRlLnNsaWNlRG9jKHN0YXJ0LCB0byk7XHJcblxyXG5cdGlmIChudW1lcmF0b3IuYXQoMCkgPT09IFwiKFwiICYmIG51bWVyYXRvci5hdCgtMSkgPT09IFwiKVwiKSB7XHJcblx0XHRjb25zdCBjbG9zaW5nID0gZmluZE1hdGNoaW5nQnJhY2tldChudW1lcmF0b3IsIDAsIFwiKFwiLCBcIilcIiwgZmFsc2UpO1xyXG5cdFx0aWYgKGNsb3NpbmcgPT09IG51bWVyYXRvci5sZW5ndGggLSAxKSB7XHJcblx0XHRcdG51bWVyYXRvciA9IG51bWVyYXRvci5zbGljZSgxLCAtMSk7XHJcblx0XHR9XHJcblx0fVxyXG5cdGNvbnN0IHJlcGxhY2VtZW50ID0gYFxcXFxmcmFjeyR7c3RyaW5nfX17JDB9JDFgXHJcblx0cXVldWVTbmlwcGV0KHZpZXcsIHRvLXN0cmluZy5sZW5ndGgsIHRvLCByZXBsYWNlbWVudCwgXCIvXCIpO1xyXG5cdHJldHVybiB0cnVlO1xyXG59XHJcbmV4cG9ydCBmdW5jdGlvbiBpZGVudGlmeUJyYWNrZXRzKGlucHV0OiBzdHJpbmcpIHtcclxuICAgIGZ1bmN0aW9uIGluZGV4RW52aXJvbm1lbnQoaW5wdXQ6IHN0cmluZywgb3Blbjogc3RyaW5nLCBjbG9zZTogc3RyaW5nKSB7XHJcbiAgICAgICAgY29uc3QgaWRzOiBBcnJheTx7IGluZGV4OiBudW1iZXI7IGRlcHRoOiBudW1iZXI7IGRlcHRoSUQ6IG51bWJlciB9PiA9IFtdO1xyXG4gICAgICAgIGxldCBkZXB0aCA9IDA7XHJcbiAgICAgICAgY29uc3QgZGVwdGhDb3VudHM6IFJlY29yZDxudW1iZXIsIG51bWJlcj4gPSB7fTtcclxuICAgICAgICBjb25zdCBvcGVuTGVuID0gb3Blbi5sZW5ndGg7XHJcbiAgICAgICAgY29uc3QgY2xvc2VMZW4gPSBjbG9zZS5sZW5ndGg7XHJcblxyXG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaW5wdXQubGVuZ3RoOyBpKyspIHtcclxuICAgICAgICAgICAgaWYgKGlucHV0LnN0YXJ0c1dpdGgob3BlbiwgaSkpIHtcclxuICAgICAgICAgICAgICAgIGlmICghZGVwdGhDb3VudHNbZGVwdGhdKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVwdGhDb3VudHNbZGVwdGhdID0gMDtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGNvbnN0IGRlcHRoSUQgPSBkZXB0aENvdW50c1tkZXB0aF0rKztcclxuICAgICAgICAgICAgICAgIGlkcy5wdXNoKHsgaW5kZXg6IGksIGRlcHRoLCBkZXB0aElEIH0pO1xyXG4gICAgICAgICAgICAgICAgZGVwdGgrKztcclxuICAgICAgICAgICAgICAgIGkgKz0gb3BlbkxlbiAtIDE7IC8vIFNraXAgdGhlIGxlbmd0aCBvZiB0aGUgb3BlbmluZyB0YWdcclxuICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChpbnB1dC5zdGFydHNXaXRoKGNsb3NlLCBpKSkge1xyXG4gICAgICAgICAgICAgICAgaWYgKGRlcHRoID4gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgIGRlcHRoLS07XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVwdGhJRCA9IGRlcHRoQ291bnRzW2RlcHRoXSAtIDE7XHJcbiAgICAgICAgICAgICAgICAgICAgaWRzLnB1c2goeyBpbmRleDogaSwgZGVwdGgsIGRlcHRoSUQgfSk7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIC8vIEhhbmRsZSB1bm1hdGNoZWQgY2xvc2luZyBicmFja2V0XHJcbiAgICAgICAgICAgICAgICAgICAgaWRzLnB1c2goeyBpbmRleDogaSwgZGVwdGg6IC0xLCBkZXB0aElEOiAtMSB9KTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIGkgKz0gY2xvc2VMZW4gLSAxOyAvLyBTa2lwIHRoZSBsZW5ndGggb2YgdGhlIGNsb3NpbmcgdGFnXHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgLy8gQWRkIGFueSB1bm1hdGNoZWQgb3BlbmluZyBicmFja2V0c1xyXG4gICAgICAgIHdoaWxlIChkZXB0aCA+IDApIHtcclxuICAgICAgICAgICAgZGVwdGgtLTtcclxuICAgICAgICAgICAgaWRzLnB1c2goeyBpbmRleDogLTEsIGRlcHRoLCBkZXB0aElEOiBkZXB0aENvdW50c1tkZXB0aF0gLSAxIH0pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIGlkcztcclxuICAgIH1cclxuXHRcclxuICAgIGNvbnN0IG1hcCA9IG5ldyBNYXA8c3RyaW5nLCB7IG9wZW46IHN0cmluZzsgY2xvc2U6IHN0cmluZzsgZm9uZDogQXJyYXk8eyBpbmRleDogbnVtYmVyOyBkZXB0aDogbnVtYmVyOyBkZXB0aElEOiBudW1iZXIgfT4gfT4oXHJcblx0XHRbXHJcblx0XHRcdFsncGFyZW50aGVzZXMnLCcoJywnKSddLFxyXG5cdFx0XHRbJ3NxdWFyZUJyYWNrZXRzJywnWycsJ10nXSxcclxuXHRcdFx0WydjdXJseUJyYWNlcycsJ3snLCd9J10sXHJcblx0XHRcdFsnYWxpZ25lZCcsJ1xcXFxiZWdpbnthbGlnbmVkfScsJ1xcXFxlbmR7YWxpZ25lZH0nXSxcclxuXHRcdFx0WydhbGlnbicsJ1xcXFxiZWdpbnthbGlnbn0nLCdcXFxcZW5ke2FsaWdufSddLFxyXG5cdFx0XHRbJ2FycmF5JywnXFxcXGJlZ2lue2FycmF5fScsJ1xcXFxlbmR7YXJyYXl9J10sXHJcblx0XHRcdFsnYm1hdHJpeCcsJ1xcXFxiZWdpbntibWF0cml4fScsJ1xcXFxlbmR7Ym1hdHJpeH0nXSxcclxuXHRcdFx0WydCbWF0cml4JywnXFxcXGJlZ2lue0JtYXRyaXh9JywnXFxcXGVuZHtCbWF0cml4fSddLFxyXG5cdFx0XHRbJ2Nhc2VzJywnXFxcXGJlZ2lue2Nhc2VzfScsJ1xcXFxlbmR7Y2FzZXN9J10sXHJcblx0XHRcdFsnZ2F0aGVyJywnXFxcXGJlZ2lue2dhdGhlcn0nLCdcXFxcZW5ke2dhdGhlcn0nXSxcclxuXHRcdFx0WydtYXRyaXgnLCdcXFxcYmVnaW57bWF0cml4fScsJ1xcXFxlbmR7bWF0cml4fSddLFxyXG5cdFx0XHRbJ3BtYXRyaXgnLCdcXFxcYmVnaW57cG1hdHJpeH0nLCdcXFxcZW5ke3BtYXRyaXh9J10sXHJcblx0XHRcdFsnVm1hdHJpeCcsJ1xcXFxiZWdpbntWbWF0cml4fScsJ1xcXFxlbmR7Vm1hdHJpeH0nXSxcclxuXHRcdFx0Wyd2bWF0cml4JywnXFxcXGJlZ2lue3ZtYXRyaXh9JywnXFxcXGVuZHt2bWF0cml4fSddLFxyXG5cdFx0XHRbJ3NtYWxsbWF0cml4JywnXFxcXGJlZ2lue3NtYWxsbWF0cml4fScsJ1xcXFxlbmR7c21hbGxtYXRyaXh9J10sXHJcblx0XHRcdFsnQ0QnLCdcXFxcYmVnaW57Q0R9JywnXFxcXGVuZHtDRH0nXSxcclxuXHRcdFx0WydlcW5hcnJheScsJ1xcXFxiZWdpbntlcW5hcnJheX0nLCdcXFxcZW5ke2VxbmFycmF5fSddLFxyXG5cdFx0XHRbJ2VxbmFycmF5KicsJ1xcXFxiZWdpbntlcW5hcnJheSp9JywnXFxcXGVuZHtlcW5hcnJheSp9J10sXHJcblx0XHRcdFsnZmxhbGlnbicsJ1xcXFxiZWdpbntmbGFsaWdufScsJ1xcXFxlbmR7ZmxhbGlnbn0nXSxcclxuXHRcdFx0WydmbGFsaWduKicsJ1xcXFxiZWdpbntmbGFsaWduKn0nLCdcXFxcZW5ke2ZsYWxpZ24qfSddLFxyXG5cdFx0XHRbJ0lFRUVlcW5hcnJheScsJ1xcXFxiZWdpbntJRUVFZXFuYXJyYXl9JywnXFxcXGVuZHtJRUVFZXFuYXJyYXl9J10sXHJcblx0XHRcdFsnSUVFRWVxbmFycmF5JywnXFxcXGJlZ2lue0lFRUVlcW5hcnJheSp9JywnXFxcXGVuZHtJRUVFZXFuYXJyYXkqfSddLFxyXG5cdFx0XHRbJ211bHRsaW5lJywnXFxcXGJlZ2lue211bHRsaW5lfScsJ1xcXFxlbmR7bXVsdGxpbmV9J10sXHJcblx0XHRcdFsnc3BsaXQnLCdcXFxcYmVnaW57c3BsaXR9JywnXFxcXGVuZHtzcGxpdH0nXSxcclxuXHRcdFx0WydzdWJhcnJheScsJ1xcXFxiZWdpbntzdWJhcnJheX0nLCdcXFxcZW5ke3N1YmFycmF5fSddLFxyXG5cdFx0XHRbJ3N1Ym51bWNhc2VzJywnXFxcXGJlZ2lue3N1Ym51bWNhc2VzfScsJ1xcXFxlbmR7c3VibnVtY2FzZXN9J10sXHJcblx0XHRcdFsnc3Vic3RhY2snLCdcXFxcYmVnaW57c3Vic3RhY2t9JywnXFxcXGVuZHtzdWJzdGFja30nXSxcclxuXHRcdF0ubWFwKGVudiA9PiAoW2VudlswXSwgeyBvcGVuOiBlbnZbMV0sIGNsb3NlOiBlbnZbMl0sIGZvbmQ6IFtdIH1dKSkpO1xyXG5cclxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIG1hcC5lbnRyaWVzKCkpIHtcclxuICAgICAgICB2YWx1ZS5mb25kID0gaW5kZXhFbnZpcm9ubWVudChpbnB1dCwgdmFsdWUub3BlbiwgdmFsdWUuY2xvc2UpO1xyXG4gICAgfVxyXG4gICAgY29uc3QgdW5tYXRjaGVkOiBudW1iZXJbXSA9IFtdO1xyXG5cclxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIG1hcC5lbnRyaWVzKCkpIHtcclxuICAgICAgICBmb3IgKGNvbnN0IG9iaiBvZiB2YWx1ZS5mb25kKSB7XHJcbiAgICAgICAgICAgIGlmIChvYmouaW5kZXggPT09IC0xKSB7XHJcblx0XHRcdFx0Y29uc3QgbWF0Y2g9dmFsdWUuZm9uZC5maW5kKG8gPT4gby5pbmRleCA+PSAwICYmIG8uZGVwdGggPT09IG9iai5kZXB0aCAmJiBvLmRlcHRoSUQgPT09IG9iai5kZXB0aElEKTtcclxuXHRcdFx0XHRpZihtYXRjaClcclxuICAgICAgICAgICAgICAgIFx0dW5tYXRjaGVkLnB1c2gobWF0Y2guaW5kZXgrdmFsdWUub3Blbi5sZW5ndGgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGxldCBpbmRleCA9ICh1bm1hdGNoZWQuc29ydCgoYSwgYikgPT4gYiAtIGEpWzBdKTtcclxuICAgIHJldHVybiBpbmRleCAhPT0gdW5kZWZpbmVkID8gaW5kZXggOiAwO1xyXG59XHJcbiJdfQ==