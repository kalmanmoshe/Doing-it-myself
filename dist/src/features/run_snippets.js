import { getLatexSuiteConfig } from "src/snippets/codemirror/config";
import { queueSnippet } from "src/snippets/codemirror/snippet_queue_state_field";
import { expandSnippets } from "src/snippets/snippet_management";
import { autoEnlargeBrackets } from "./auto_enlarge_brackets";
export const runSnippets = (view, ctx, key) => {
    let shouldAutoEnlargeBrackets = false;
    for (const range of ctx.ranges) {
        const result = runSnippetCursor(view, ctx, key, range);
        if (result.shouldAutoEnlargeBrackets)
            shouldAutoEnlargeBrackets = true;
    }
    const success = expandSnippets(view);
    if (shouldAutoEnlargeBrackets) {
        autoEnlargeBrackets(view);
    }
    return success;
};
const runSnippetCursor = (view, ctx, key, range) => {
    const settings = getLatexSuiteConfig(view);
    const { from, to } = range;
    const sel = view.state.sliceDoc(from, to);
    const line = view.state.sliceDoc(0, to);
    const updatedLine = line + key;
    for (const snippet of settings.snippets) {
        let effectiveLine = line;
        if (!snippetShouldRunInMode(snippet.options, ctx.mode)) {
            continue;
        }
        if (snippet.options.automatic || snippet.type === "visual") {
            // If the key pressed wasn't a text character, continue
            if (key.length !== 1)
                continue;
            effectiveLine = updatedLine;
        }
        else if (!(key === settings.snippetsTrigger)) {
            // The snippet must be triggered by a key
            continue;
        }
        // Check that this snippet is not excluded in a certain environment
        let isExcluded = false;
        // in practice, a snippet should have very few excluded environments, if any,
        // so the cost of this check shouldn't be very high
        for (const environment of snippet.excludedEnvironments) {
            if (ctx.isWithinEnvironment(to, environment)) {
                isExcluded = true;
            }
        }
        // we could've used a labelled outer for loop to `continue` from within the inner for loop,
        // but labels are extremely rarely used, so we do this construction instead
        if (isExcluded) {
            continue;
        }
        const result = snippet.process(effectiveLine, range, sel);
        if (result === null)
            continue;
        const triggerPos = result.triggerPos;
        if (snippet.options.onWordBoundary) {
            // Check that the trigger is preceded and followed by a word delimiter
            if (!isOnWordBoundary(view.state, triggerPos, to, settings.wordDelimiters))
                continue;
        }
        let replacement = result.replacement;
        // When in inline math, remove any spaces at the end of the replacement
        if (ctx.mode.inlineMath && settings.removeSnippetWhitespace) {
            replacement = trimWhitespace(replacement, ctx);
        }
        // Expand the snippet
        const start = triggerPos;
        console.log('replacement', replacement);
        queueSnippet(view, start, to, replacement, key);
        const containsTrigger = settings.autoEnlargeBracketsTriggers.some(word => replacement.contains("\\" + word));
        return { success: true, shouldAutoEnlargeBrackets: containsTrigger };
    }
    return { success: false, shouldAutoEnlargeBrackets: false };
};
const snippetShouldRunInMode = (options, mode) => {
    if (options.mode.inlineMath && mode.inlineMath ||
        options.mode.blockMath && mode.blockMath ||
        (options.mode.inlineMath || options.mode.blockMath) && mode.codeMath) {
        if (!mode.textEnv) {
            return true;
        }
    }
    if (mode.inMath() && mode.textEnv && options.mode.text) {
        return true;
    }
    if (options.mode.text && mode.text ||
        options.mode.code && mode.code) {
        return true;
    }
};
const isOnWordBoundary = (state, triggerPos, to, wordDelimiters) => {
    const prevChar = state.sliceDoc(triggerPos - 1, triggerPos);
    const nextChar = state.sliceDoc(to, to + 1);
    wordDelimiters = wordDelimiters.replace("\\n", "\n");
    return (wordDelimiters.contains(prevChar) && wordDelimiters.contains(nextChar));
};
const trimWhitespace = (replacement, ctx) => {
    let spaceIndex = 0;
    if (replacement.endsWith(" ")) {
        spaceIndex = -1;
    }
    else {
        const lastThreeChars = replacement.slice(-3);
        const lastChar = lastThreeChars.slice(-1);
        if (lastThreeChars.slice(0, 2) === " $" && !isNaN(parseInt(lastChar))) {
            spaceIndex = -3;
        }
    }
    if (spaceIndex != 0) {
        if (spaceIndex === -1) {
            replacement = replacement.trimEnd();
        }
        else if (spaceIndex === -3) {
            replacement = replacement.slice(0, -3) + replacement.slice(-2);
        }
    }
    return replacement;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVuX3NuaXBwZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ZlYXR1cmVzL3J1bl9zbmlwcGV0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNyRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFFakYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRWpFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRzlELE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLElBQWdCLEVBQUUsR0FBWSxFQUFFLEdBQVcsRUFBVSxFQUFFO0lBRWxGLElBQUkseUJBQXlCLEdBQUcsS0FBSyxDQUFDO0lBQ3RDLEtBQUssTUFBTSxLQUFLLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hDLE1BQU0sTUFBTSxHQUFHLGdCQUFnQixDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3ZELElBQUksTUFBTSxDQUFDLHlCQUF5QjtZQUFFLHlCQUF5QixHQUFHLElBQUksQ0FBQztJQUN4RSxDQUFDO0lBRUQsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBR3JDLElBQUkseUJBQXlCLEVBQUUsQ0FBQztRQUMvQixtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDaEIsQ0FBQyxDQUFBO0FBR0QsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLElBQWdCLEVBQUUsR0FBWSxFQUFFLEdBQVcsRUFBRSxLQUFxQixFQUF5RCxFQUFFO0lBRXRKLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNDLE1BQU0sRUFBQyxJQUFJ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QVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hFLENBQUM7SUFDRixDQUFDO0lBRUQsT0FBTyxXQUFXLENBQUM7QUFDcEIsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldyB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IEVkaXRvclN0YXRlLCBTZWxlY3Rpb25SYW5nZSB9IGZyb20gXCJAY29kZW1pcnJvci9zdGF0ZVwiO1xyXG5pbXBvcnQgeyBnZXRMYXRleFN1aXRlQ29uZmlnIH0gZnJvbSBcInNyYy9zbmlwcGV0cy9jb2RlbWlycm9yL2NvbmZpZ1wiO1xyXG5pbXBvcnQgeyBxdWV1ZVNuaXBwZXQgfSBmcm9tIFwic3JjL3NuaXBwZXRzL2NvZGVtaXJyb3Ivc25pcHBldF9xdWV1ZV9zdGF0ZV9maWVsZFwiO1xyXG5pbXBvcnQgeyBNb2RlLCBPcHRpb25zIH0gZnJvbSBcInNyYy9zbmlwcGV0cy9vcHRpb25zXCI7XHJcbmltcG9ydCB7IGV4cGFuZFNuaXBwZXRzIH0gZnJvbSBcInNyYy9zbmlwcGV0cy9zbmlwcGV0X21hbmFnZW1lbnRcIjtcclxuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCJzcmMvdXRpbHMvY29udGV4dFwiO1xyXG5pbXBvcnQgeyBhdXRvRW5sYXJnZUJyYWNrZXRzIH0gZnJvbSBcIi4vYXV0b19lbmxhcmdlX2JyYWNrZXRzXCI7XHJcblxyXG5cclxuZXhwb3J0IGNvbnN0IHJ1blNuaXBwZXRzID0gKHZpZXc6IEVkaXRvclZpZXcsIGN0eDogQ29udGV4dCwga2V5OiBzdHJpbmcpOmJvb2xlYW4gPT4ge1xyXG5cclxuXHRsZXQgc2hvdWxkQXV0b0VubGFyZ2VCcmFja2V0cyA9IGZhbHNlO1xyXG5cdGZvciAoY29uc3QgcmFuZ2Ugb2YgY3R4LnJhbmdlcykge1xyXG5cdFx0Y29uc3QgcmVzdWx0ID0gcnVuU25pcHBldEN1cnNvcih2aWV3LCBjdHgsIGtleSwgcmFuZ2UpO1xyXG5cdFx0aWYgKHJlc3VsdC5zaG91bGRBdXRvRW5sYXJnZUJyYWNrZXRzKSBzaG91bGRBdXRvRW5sYXJnZUJyYWNrZXRzID0gdHJ1ZTtcclxuXHR9XHJcblxyXG5cdGNvbnN0IHN1Y2Nlc3MgPSBleHBhbmRTbmlwcGV0cyh2aWV3KTtcclxuXHJcblxyXG5cdGlmIChzaG91bGRBdXRvRW5sYXJnZUJyYWNrZXRzKSB7XHJcblx0XHRhdXRvRW5sYXJnZUJyYWNrZXRzKHZpZXcpO1xyXG5cdH1cclxuXHJcblx0cmV0dXJuIHN1Y2Nlc3M7XHJcbn1cclxuXHJcblxyXG5jb25zdCBydW5TbmlwcGV0Q3Vyc29yID0gKHZpZXc6IEVkaXRvclZpZXcsIGN0eDogQ29udGV4dCwga2V5OiBzdHJpbmcsIHJhbmdlOiBTZWxlY3Rpb25SYW5nZSk6e3N1Y2Nlc3M6IGJvb2xlYW47IHNob3VsZEF1dG9FbmxhcmdlQnJhY2tldHM6IGJvb2xlYW59ID0+IHtcclxuXHRcclxuXHRjb25zdCBzZXR0aW5ncyA9IGdldExhdGV4U3VpdGVDb25maWcodmlldyk7XHJcblx0Y29uc3Qge2Zyb20sIHRvfSA9IHJhbmdlO1xyXG5cdGNvbnN0IHNlbCA9IHZpZXcuc3RhdGUuc2xpY2VEb2MoZnJvbSwgdG8pO1xyXG5cdGNvbnN0IGxpbmUgPSB2aWV3LnN0YXRlLnNsaWNlRG9jKDAsIHRvKTtcclxuXHRjb25zdCB1cGRhdGVkTGluZSA9IGxpbmUgKyBrZXk7XHJcblx0Zm9yIChjb25zdCBzbmlwcGV0IG9mIHNldHRpbmdzLnNuaXBwZXRzKSB7XHJcblx0XHRsZXQgZWZmZWN0aXZlTGluZSA9IGxpbmU7XHJcblx0XHRpZiAoIXNuaXBwZXRTaG91bGRSdW5Jbk1vZGUoc25pcHBldC5vcHRpb25zLCBjdHgubW9kZSkpIHtcclxuXHRcdFx0Y29udGludWU7XHJcblx0XHR9XHJcblxyXG5cdFx0aWYgKHNuaXBwZXQub3B0aW9ucy5hdXRvbWF0aWMgfHwgc25pcHBldC50eXBlID09PSBcInZpc3VhbFwiKSB7XHJcblx0XHRcdC8vIElmIHRoZSBrZXkgcHJlc3NlZCB3YXNuJ3QgYSB0ZXh0IGNoYXJhY3RlciwgY29udGludWVcclxuXHRcdFx0aWYgKGtleS5sZW5ndGggIT09IDEpIGNvbnRpbnVlO1xyXG5cdFx0XHRlZmZlY3RpdmVMaW5lID0gdXBkYXRlZExpbmU7XHJcblx0XHR9XHJcblx0XHRlbHNlIGlmICghKGtleSA9PT0gc2V0dGluZ3Muc25pcHBldHNUcmlnZ2VyKSkge1xyXG5cdFx0XHQvLyBUaGUgc25pcHBldCBtdXN0IGJlIHRyaWdnZXJlZCBieSBhIGtleVxyXG5cdFx0XHRjb250aW51ZTtcclxuXHRcdH1cclxuXHJcblx0XHQvLyBDaGVjayB0aGF0IHRoaXMgc25pcHBldCBpcyBub3QgZXhjbHVkZWQgaW4gYSBjZXJ0YWluIGVudmlyb25tZW50XHJcblx0XHRsZXQgaXNFeGNsdWRlZCA9IGZhbHNlO1xyXG5cdFx0Ly8gaW4gcHJhY3RpY2UsIGEgc25pcHBldCBzaG91bGQgaGF2ZSB2ZXJ5IGZldyBleGNsdWRlZCBlbnZpcm9ubWVudHMsIGlmIGFueSxcclxuXHRcdC8vIHNvIHRoZSBjb3N0IG9mIHRoaXMgY2hlY2sgc2hvdWxkbid0IGJlIHZlcnkgaGlnaFxyXG5cdFx0Zm9yIChjb25zdCBlbnZpcm9ubWVudCBvZiBzbmlwcGV0LmV4Y2x1ZGVkRW52aXJvbm1lbnRzKSB7XHJcblx0XHRcdGlmIChjdHguaXNXaXRoaW5FbnZpcm9ubWVudCh0bywgZW52aXJvbm1lbnQpKSB7IGlzRXhjbHVkZWQgPSB0cnVlOyB9XHJcblx0XHR9XHJcblx0XHQvLyB3ZSBjb3VsZCd2ZSB1c2VkIGEgbGFiZWxsZWQgb3V0ZXIgZm9yIGxvb3AgdG8gYGNvbnRpbnVlYCBmcm9tIHdpdGhpbiB0aGUgaW5uZXIgZm9yIGxvb3AsXHJcblx0XHQvLyBidXQgbGFiZWxzIGFyZSBleHRyZW1lbHkgcmFyZWx5IHVzZWQsIHNvIHdlIGRvIHRoaXMgY29uc3RydWN0aW9uIGluc3RlYWRcclxuXHRcdGlmIChpc0V4Y2x1ZGVkKSB7IGNvbnRpbnVlOyB9XHJcblxyXG5cdFx0Y29uc3QgcmVzdWx0ID0gc25pcHBldC5wcm9jZXNzKGVmZmVjdGl2ZUxpbmUsIHJhbmdlLCBzZWwpO1xyXG5cdFx0aWYgKHJlc3VsdCA9PT0gbnVsbCkgY29udGludWU7XHJcblx0XHRjb25zdCB0cmlnZ2VyUG9zID0gcmVzdWx0LnRyaWdnZXJQb3M7XHJcblxyXG5cdFx0aWYgKHNuaXBwZXQub3B0aW9ucy5vbldvcmRCb3VuZGFyeSkge1xyXG5cdFx0XHQvLyBDaGVjayB0aGF0IHRoZSB0cmlnZ2VyIGlzIHByZWNlZGVkIGFuZCBmb2xsb3dlZCBieSBhIHdvcmQgZGVsaW1pdGVyXHJcblx0XHRcdGlmICghaXNPbldvcmRCb3VuZGFyeSh2aWV3LnN0YXRlLCB0cmlnZ2VyUG9zLCB0bywgc2V0dGluZ3Mud29yZERlbGltaXRlcnMpKSBjb250aW51ZTtcclxuXHRcdH1cclxuXHRcdGxldCByZXBsYWNlbWVudCA9IHJlc3VsdC5yZXBsYWNlbWVudDtcclxuXHJcblx0XHQvLyBXaGVuIGluIGlubGluZSBtYXRoLCByZW1vdmUgYW55IHNwYWNlcyBhdCB0aGUgZW5kIG9mIHRoZSByZXBsYWNlbWVudFxyXG5cdFx0aWYgKGN0eC5tb2RlLmlubGluZU1hdGggJiYgc2V0dGluZ3MucmVtb3ZlU25pcHBldFdoaXRlc3BhY2UpIHtcclxuXHRcdFx0cmVwbGFjZW1lbnQgPSB0cmltV2hpdGVzcGFjZShyZXBsYWNlbWVudCwgY3R4KTtcclxuXHRcdH1cclxuXHJcblx0XHQvLyBFeHBhbmQgdGhlIHNuaXBwZXRcclxuXHRcdGNvbnN0IHN0YXJ0ID0gdHJpZ2dlclBvcztcclxuXHRcdGNvbnNvbGUubG9nKCdyZXBsYWNlbWVudCcscmVwbGFjZW1lbnQpO1xyXG5cdFx0cXVldWVTbmlwcGV0KHZpZXcsIHN0YXJ0LCB0bywgcmVwbGFjZW1lbnQsIGtleSk7XHJcblx0XHRjb25zdCBjb250YWluc1RyaWdnZXIgPSBzZXR0aW5ncy5hdXRvRW5sYXJnZUJyYWNrZXRzVHJpZ2dlcnMuc29tZSh3b3JkID0+IHJlcGxhY2VtZW50LmNvbnRhaW5zKFwiXFxcXFwiICsgd29yZCkpO1xyXG5cdFx0cmV0dXJuIHtzdWNjZXNzOiB0cnVlLCBzaG91bGRBdXRvRW5sYXJnZUJyYWNrZXRzOiBjb250YWluc1RyaWdnZXJ9O1xyXG5cdH1cclxuXHJcblxyXG5cdHJldHVybiB7c3VjY2VzczogZmFsc2UsIHNob3VsZEF1dG9FbmxhcmdlQnJhY2tldHM6IGZhbHNlfTtcclxufVxyXG5cclxuY29uc3Qgc25pcHBldFNob3VsZFJ1bkluTW9kZSA9IChvcHRpb25zOiBPcHRpb25zLCBtb2RlOiBNb2RlKSA9PiB7XHJcblx0aWYgKFxyXG5cdFx0b3B0aW9ucy5tb2RlLmlubGluZU1hdGggJiYgbW9kZS5pbmxpbmVNYXRoIHx8XHJcblx0XHRvcHRpb25zLm1vZGUuYmxvY2tNYXRoICYmIG1vZGUuYmxvY2tNYXRoIHx8XHJcblx0XHQob3B0aW9ucy5tb2RlLmlubGluZU1hdGggfHwgb3B0aW9ucy5tb2RlLmJsb2NrTWF0aCkgJiYgbW9kZS5jb2RlTWF0aFxyXG5cdCkge1xyXG5cdFx0aWYgKCFtb2RlLnRleHRFbnYpIHtcclxuXHRcdFx0cmV0dXJuIHRydWU7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRpZiAobW9kZS5pbk1hdGgoKSAmJiBtb2RlLnRleHRFbnYgJiYgb3B0aW9ucy5tb2RlLnRleHQpIHtcclxuXHRcdHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHJcblx0aWYgKG9wdGlvbnMubW9kZS50ZXh0ICYmIG1vZGUudGV4dCB8fFxyXG5cdFx0b3B0aW9ucy5tb2RlLmNvZGUgJiYgbW9kZS5jb2RlXHJcblx0KSB7XHJcblx0XHRyZXR1cm4gdHJ1ZTtcclxuXHR9XHJcbn1cclxuXHJcbmNvbnN0IGlzT25Xb3JkQm91bmRhcnkgPSAoc3RhdGU6IEVkaXRvclN0YXRlLCB0cmlnZ2VyUG9zOiBudW1iZXIsIHRvOiBudW1iZXIsIHdvcmREZWxpbWl0ZXJzOiBzdHJpbmcpID0+IHtcclxuXHRjb25zdCBwcmV2Q2hhciA9IHN0YXRlLnNsaWNlRG9jKHRyaWdnZXJQb3MtMSwgdHJpZ2dlclBvcyk7XHJcblx0Y29uc3QgbmV4dENoYXIgPSBzdGF0ZS5zbGljZURvYyh0bywgdG8rMSk7XHJcblxyXG5cdHdvcmREZWxpbWl0ZXJzID0gd29yZERlbGltaXRlcnMucmVwbGFjZShcIlxcXFxuXCIsIFwiXFxuXCIpO1xyXG5cclxuXHRyZXR1cm4gKHdvcmREZWxpbWl0ZXJzLmNvbnRhaW5zKHByZXZDaGFyKSAmJiB3b3JkRGVsaW1pdGVycy5jb250YWlucyhuZXh0Q2hhcikpO1xyXG59XHJcblxyXG5jb25zdCB0cmltV2hpdGVzcGFjZSA9IChyZXBsYWNlbWVudDogc3RyaW5nLCBjdHg6IENvbnRleHQpID0+IHtcclxuXHRsZXQgc3BhY2VJbmRleCA9IDA7XHJcblxyXG5cdGlmIChyZXBsYWNlbWVudC5lbmRzV2l0aChcIiBcIikpIHtcclxuXHRcdHNwYWNlSW5kZXggPSAtMTtcclxuXHR9XHJcblx0ZWxzZSB7XHJcblx0XHRjb25zdCBsYXN0VGhyZWVDaGFycyA9IHJlcGxhY2VtZW50LnNsaWNlKC0zKTtcclxuXHRcdGNvbnN0IGxhc3RDaGFyID0gbGFzdFRocmVlQ2hhcnMuc2xpY2UoLTEpO1xyXG5cclxuXHRcdGlmIChsYXN0VGhyZWVDaGFycy5zbGljZSgwLCAyKSA9PT0gXCIgJFwiICYmICFpc05hTihwYXJzZUludChsYXN0Q2hhcikpKSB7XHJcblx0XHRcdHNwYWNlSW5kZXggPSAtMztcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGlmIChzcGFjZUluZGV4ICE9IDApIHtcclxuXHRcdGlmIChzcGFjZUluZGV4ID09PSAtMSkge1xyXG5cdFx0XHRyZXBsYWNlbWVudCA9IHJlcGxhY2VtZW50LnRyaW1FbmQoKTtcclxuXHRcdH1cclxuXHRcdGVsc2UgaWYgKHNwYWNlSW5kZXggPT09IC0zKXtcclxuXHRcdFx0cmVwbGFjZW1lbnQgPSByZXBsYWNlbWVudC5zbGljZSgwLCAtMykgKyByZXBsYWNlbWVudC5zbGljZSgtMik7XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gcmVwbGFjZW1lbnQ7XHJcbn0iXX0=