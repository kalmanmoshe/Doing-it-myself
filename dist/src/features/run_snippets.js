import { getLatexSuiteConfig } from "src/snippets/codemirror/config";
import { queueSnippet } from "src/snippets/codemirror/snippet_queue_state_field";
import { expandSnippets } from "src/snippets/snippet_management";
import { autoEnlargeBrackets } from "./auto_enlarge_brackets";
export const runSnippets = (view, ctx, key) => {
    let shouldAutoEnlargeBrackets = false;
    for (const range of ctx.ranges) {
        const result = runSnippetCursor(view, ctx, key, range);
        if (result.shouldAutoEnlargeBrackets)
            shouldAutoEnlargeBrackets = true;
    }
    const success = expandSnippets(view);
    if (shouldAutoEnlargeBrackets) {
        autoEnlargeBrackets(view);
    }
    return success;
};
const runSnippetCursor = (view, ctx, key, range) => {
    const settings = getLatexSuiteConfig(view);
    const { from, to } = range;
    const sel = view.state.sliceDoc(from, to);
    const line = view.state.sliceDoc(0, to);
    const updatedLine = line + key;
    for (const snippet of settings.snippets) {
        let effectiveLine = line;
        if (!snippetShouldRunInMode(snippet.options, ctx.mode)) {
            continue;
        }
        if (snippet.options.automatic || snippet.type === "visual") {
            // If the key pressed wasn't a text character, continue
            if (!(key.length === 1))
                continue;
            effectiveLine = updatedLine;
        }
        else if (!(key === settings.snippetsTrigger)) {
            // The snippet must be triggered by a key
            continue;
        }
        // Check that this snippet is not excluded in a certain environment
        let isExcluded = false;
        // in practice, a snippet should have very few excluded environments, if any,
        // so the cost of this check shouldn't be very high
        for (const environment of snippet.excludedEnvironments) {
            if (ctx.isWithinEnvironment(to, environment)) {
                isExcluded = true;
            }
        }
        // we could've used a labelled outer for loop to `continue` from within the inner for loop,
        // but labels are extremely rarely used, so we do this construction instead
        if (isExcluded) {
            continue;
        }
        const result = snippet.process(effectiveLine, range, sel);
        if (result === null)
            continue;
        const triggerPos = result.triggerPos;
        if (snippet.options.onWordBoundary) {
            // Check that the trigger is preceded and followed by a word delimiter
            if (!isOnWordBoundary(view.state, triggerPos, to, settings.wordDelimiters))
                continue;
        }
        let replacement = result.replacement;
        // When in inline math, remove any spaces at the end of the replacement
        if (ctx.mode.inlineMath && settings.removeSnippetWhitespace) {
            replacement = trimWhitespace(replacement, ctx);
        }
        // Expand the snippet
        const start = triggerPos;
        queueSnippet(view, start, to, replacement, key);
        console.log(replacement);
        const containsTrigger = settings.autoEnlargeBracketsTriggers.some(word => replacement.contains("\\" + word));
        return { success: true, shouldAutoEnlargeBrackets: containsTrigger };
    }
    return { success: false, shouldAutoEnlargeBrackets: false };
};
const snippetShouldRunInMode = (options, mode) => {
    if (options.mode.inlineMath && mode.inlineMath ||
        options.mode.blockMath && mode.blockMath ||
        (options.mode.inlineMath || options.mode.blockMath) && mode.codeMath) {
        if (!mode.textEnv) {
            return true;
        }
    }
    if (mode.inMath() && mode.textEnv && options.mode.text) {
        return true;
    }
    if (options.mode.text && mode.text ||
        options.mode.code && mode.code) {
        return true;
    }
};
const isOnWordBoundary = (state, triggerPos, to, wordDelimiters) => {
    const prevChar = state.sliceDoc(triggerPos - 1, triggerPos);
    const nextChar = state.sliceDoc(to, to + 1);
    wordDelimiters = wordDelimiters.replace("\\n", "\n");
    return (wordDelimiters.contains(prevChar) && wordDelimiters.contains(nextChar));
};
const trimWhitespace = (replacement, ctx) => {
    let spaceIndex = 0;
    if (replacement.endsWith(" ")) {
        spaceIndex = -1;
    }
    else {
        const lastThreeChars = replacement.slice(-3);
        const lastChar = lastThreeChars.slice(-1);
        if (lastThreeChars.slice(0, 2) === " $" && !isNaN(parseInt(lastChar))) {
            spaceIndex = -3;
        }
    }
    if (spaceIndex != 0) {
        if (spaceIndex === -1) {
            replacement = replacement.trimEnd();
        }
        else if (spaceIndex === -3) {
            replacement = replacement.slice(0, -3) + replacement.slice(-2);
        }
    }
    return replacement;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicnVuX3NuaXBwZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2ZlYXR1cmVzL3J1bl9zbmlwcGV0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxnQ0FBZ0MsQ0FBQztBQUNyRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFFakYsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBRWpFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBRzlELE1BQU0sQ0FBQyxNQUFNLFdBQVcsR0FBRyxDQUFDLElBQWdCLEVBQUUsR0FBWSxFQUFFLEdBQVcsRUFBVSxFQUFFO0lBRWxGLElBQUkseUJBQXlCLEdBQUcsS0FBSyxDQUFDO0lBRXRDLEtBQUssTUFBTSxLQUFLLElBQUksR0FBRyxDQUFDLE1BQU0sRUFBRSxDQUFDO1FBQ2hDLE1BQU0sTUFBTSxHQUFHLGdCQUFnQixDQUFDLElBQUksRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBRXZELElBQUksTUFBTSxDQUFDLHlCQUF5QjtZQUFFLHlCQUF5QixHQUFHLElBQUksQ0FBQztJQUN4RSxDQUFDO0lBRUQsTUFBTSxPQUFPLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBR3JDLElBQUkseUJBQXlCLEVBQUUsQ0FBQztRQUMvQixtQkFBbUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzQixDQUFDO0lBRUQsT0FBTyxPQUFPLENBQUM7QUFDaEIsQ0FBQyxDQUFBO0FBR0QsTUFBTSxnQkFBZ0IsR0FBRyxDQUFDLElBQWdCLEVBQUUsR0FBWSxFQUFFLEdBQVcsRUFBRSxLQUFxQixFQUF5RCxFQUFFO0lBRXRKLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNDLE1BQU0sRUFBQyxJQUFJ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QUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEUsQ0FBQztJQUNGLENBQUM7SUFFRCxPQUFPLFdBQVcsQ0FBQztBQUNwQixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFZGl0b3JWaWV3IH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcclxuaW1wb3J0IHsgRWRpdG9yU3RhdGUsIFNlbGVjdGlvblJhbmdlIH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XHJcbmltcG9ydCB7IGdldExhdGV4U3VpdGVDb25maWcgfSBmcm9tIFwic3JjL3NuaXBwZXRzL2NvZGVtaXJyb3IvY29uZmlnXCI7XHJcbmltcG9ydCB7IHF1ZXVlU25pcHBldCB9IGZyb20gXCJzcmMvc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XHJcbmltcG9ydCB7IE1vZGUsIE9wdGlvbnMgfSBmcm9tIFwic3JjL3NuaXBwZXRzL29wdGlvbnNcIjtcclxuaW1wb3J0IHsgZXhwYW5kU25pcHBldHMgfSBmcm9tIFwic3JjL3NuaXBwZXRzL3NuaXBwZXRfbWFuYWdlbWVudFwiO1xyXG5pbXBvcnQgeyBDb250ZXh0IH0gZnJvbSBcInNyYy91dGlscy9jb250ZXh0XCI7XHJcbmltcG9ydCB7IGF1dG9FbmxhcmdlQnJhY2tldHMgfSBmcm9tIFwiLi9hdXRvX2VubGFyZ2VfYnJhY2tldHNcIjtcclxuXHJcblxyXG5leHBvcnQgY29uc3QgcnVuU25pcHBldHMgPSAodmlldzogRWRpdG9yVmlldywgY3R4OiBDb250ZXh0LCBrZXk6IHN0cmluZyk6Ym9vbGVhbiA9PiB7XHJcblxyXG5cdGxldCBzaG91bGRBdXRvRW5sYXJnZUJyYWNrZXRzID0gZmFsc2U7XHJcblxyXG5cdGZvciAoY29uc3QgcmFuZ2Ugb2YgY3R4LnJhbmdlcykge1xyXG5cdFx0Y29uc3QgcmVzdWx0ID0gcnVuU25pcHBldEN1cnNvcih2aWV3LCBjdHgsIGtleSwgcmFuZ2UpO1xyXG5cclxuXHRcdGlmIChyZXN1bHQuc2hvdWxkQXV0b0VubGFyZ2VCcmFja2V0cykgc2hvdWxkQXV0b0VubGFyZ2VCcmFja2V0cyA9IHRydWU7XHJcblx0fVxyXG5cclxuXHRjb25zdCBzdWNjZXNzID0gZXhwYW5kU25pcHBldHModmlldyk7XHJcblxyXG5cclxuXHRpZiAoc2hvdWxkQXV0b0VubGFyZ2VCcmFja2V0cykge1xyXG5cdFx0YXV0b0VubGFyZ2VCcmFja2V0cyh2aWV3KTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBzdWNjZXNzO1xyXG59XHJcblxyXG5cclxuY29uc3QgcnVuU25pcHBldEN1cnNvciA9ICh2aWV3OiBFZGl0b3JWaWV3LCBjdHg6IENvbnRleHQsIGtleTogc3RyaW5nLCByYW5nZTogU2VsZWN0aW9uUmFuZ2UpOntzdWNjZXNzOiBib29sZWFuOyBzaG91bGRBdXRvRW5sYXJnZUJyYWNrZXRzOiBib29sZWFufSA9PiB7XHJcblx0XHJcblx0Y29uc3Qgc2V0dGluZ3MgPSBnZXRMYXRleFN1aXRlQ29uZmlnKHZpZXcpO1xyXG5cdGNvbnN0IHtmcm9tLCB0b30gPSByYW5nZTtcclxuXHRjb25zdCBzZWwgPSB2aWV3LnN0YXRlLnNsaWNlRG9jKGZyb20sIHRvKTtcclxuXHRjb25zdCBsaW5lID0gdmlldy5zdGF0ZS5zbGljZURvYygwLCB0byk7XHJcblx0Y29uc3QgdXBkYXRlZExpbmUgPSBsaW5lICsga2V5O1xyXG5cdGZvciAoY29uc3Qgc25pcHBldCBvZiBzZXR0aW5ncy5zbmlwcGV0cykge1xyXG5cdFx0bGV0IGVmZmVjdGl2ZUxpbmUgPSBsaW5lO1xyXG5cdFx0aWYgKCFzbmlwcGV0U2hvdWxkUnVuSW5Nb2RlKHNuaXBwZXQub3B0aW9ucywgY3R4Lm1vZGUpKSB7XHJcblx0XHRcdGNvbnRpbnVlO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmIChzbmlwcGV0Lm9wdGlvbnMuYXV0b21hdGljIHx8IHNuaXBwZXQudHlwZSA9PT0gXCJ2aXN1YWxcIikge1xyXG5cdFx0XHQvLyBJZiB0aGUga2V5IHByZXNzZWQgd2Fzbid0IGEgdGV4dCBjaGFyYWN0ZXIsIGNvbnRpbnVlXHJcblx0XHRcdGlmICghKGtleS5sZW5ndGggPT09IDEpKSBjb250aW51ZTtcclxuXHRcdFx0ZWZmZWN0aXZlTGluZSA9IHVwZGF0ZWRMaW5lO1xyXG5cdFx0fVxyXG5cdFx0ZWxzZSBpZiAoIShrZXkgPT09IHNldHRpbmdzLnNuaXBwZXRzVHJpZ2dlcikpIHtcclxuXHRcdFx0Ly8gVGhlIHNuaXBwZXQgbXVzdCBiZSB0cmlnZ2VyZWQgYnkgYSBrZXlcclxuXHRcdFx0Y29udGludWU7XHJcblx0XHR9XHJcblxyXG5cdFx0Ly8gQ2hlY2sgdGhhdCB0aGlzIHNuaXBwZXQgaXMgbm90IGV4Y2x1ZGVkIGluIGEgY2VydGFpbiBlbnZpcm9ubWVudFxyXG5cdFx0bGV0IGlzRXhjbHVkZWQgPSBmYWxzZTtcclxuXHRcdC8vIGluIHByYWN0aWNlLCBhIHNuaXBwZXQgc2hvdWxkIGhhdmUgdmVyeSBmZXcgZXhjbHVkZWQgZW52aXJvbm1lbnRzLCBpZiBhbnksXHJcblx0XHQvLyBzbyB0aGUgY29zdCBvZiB0aGlzIGNoZWNrIHNob3VsZG4ndCBiZSB2ZXJ5IGhpZ2hcclxuXHRcdGZvciAoY29uc3QgZW52aXJvbm1lbnQgb2Ygc25pcHBldC5leGNsdWRlZEVudmlyb25tZW50cykge1xyXG5cdFx0XHRpZiAoY3R4LmlzV2l0aGluRW52aXJvbm1lbnQodG8sIGVudmlyb25tZW50KSkgeyBpc0V4Y2x1ZGVkID0gdHJ1ZTsgfVxyXG5cdFx0fVxyXG5cdFx0Ly8gd2UgY291bGQndmUgdXNlZCBhIGxhYmVsbGVkIG91dGVyIGZvciBsb29wIHRvIGBjb250aW51ZWAgZnJvbSB3aXRoaW4gdGhlIGlubmVyIGZvciBsb29wLFxyXG5cdFx0Ly8gYnV0IGxhYmVscyBhcmUgZXh0cmVtZWx5IHJhcmVseSB1c2VkLCBzbyB3ZSBkbyB0aGlzIGNvbnN0cnVjdGlvbiBpbnN0ZWFkXHJcblx0XHRpZiAoaXNFeGNsdWRlZCkgeyBjb250aW51ZTsgfVxyXG5cclxuXHRcdGNvbnN0IHJlc3VsdCA9IHNuaXBwZXQucHJvY2VzcyhlZmZlY3RpdmVMaW5lLCByYW5nZSwgc2VsKTtcclxuXHRcdGlmIChyZXN1bHQgPT09IG51bGwpIGNvbnRpbnVlO1xyXG5cdFx0Y29uc3QgdHJpZ2dlclBvcyA9IHJlc3VsdC50cmlnZ2VyUG9zO1xyXG5cclxuXHRcdGlmIChzbmlwcGV0Lm9wdGlvbnMub25Xb3JkQm91bmRhcnkpIHtcclxuXHRcdFx0Ly8gQ2hlY2sgdGhhdCB0aGUgdHJpZ2dlciBpcyBwcmVjZWRlZCBhbmQgZm9sbG93ZWQgYnkgYSB3b3JkIGRlbGltaXRlclxyXG5cdFx0XHRpZiAoIWlzT25Xb3JkQm91bmRhcnkodmlldy5zdGF0ZSwgdHJpZ2dlclBvcywgdG8sIHNldHRpbmdzLndvcmREZWxpbWl0ZXJzKSkgY29udGludWU7XHJcblx0XHR9XHJcblx0XHRsZXQgcmVwbGFjZW1lbnQgPSByZXN1bHQucmVwbGFjZW1lbnQ7XHJcblxyXG5cdFx0Ly8gV2hlbiBpbiBpbmxpbmUgbWF0aCwgcmVtb3ZlIGFueSBzcGFjZXMgYXQgdGhlIGVuZCBvZiB0aGUgcmVwbGFjZW1lbnRcclxuXHRcdGlmIChjdHgubW9kZS5pbmxpbmVNYXRoICYmIHNldHRpbmdzLnJlbW92ZVNuaXBwZXRXaGl0ZXNwYWNlKSB7XHJcblx0XHRcdHJlcGxhY2VtZW50ID0gdHJpbVdoaXRlc3BhY2UocmVwbGFjZW1lbnQsIGN0eCk7XHJcblx0XHR9XHJcblxyXG5cdFx0Ly8gRXhwYW5kIHRoZSBzbmlwcGV0XHJcblx0XHRjb25zdCBzdGFydCA9IHRyaWdnZXJQb3M7XHJcblx0XHRxdWV1ZVNuaXBwZXQodmlldywgc3RhcnQsIHRvLCByZXBsYWNlbWVudCwga2V5KTtcclxuXHRcdGNvbnNvbGUubG9nKHJlcGxhY2VtZW50KTtcclxuXHRcdGNvbnN0IGNvbnRhaW5zVHJpZ2dlciA9IHNldHRpbmdzLmF1dG9FbmxhcmdlQnJhY2tldHNUcmlnZ2Vycy5zb21lKHdvcmQgPT4gcmVwbGFjZW1lbnQuY29udGFpbnMoXCJcXFxcXCIgKyB3b3JkKSk7XHJcblx0XHRyZXR1cm4ge3N1Y2Nlc3M6IHRydWUsIHNob3VsZEF1dG9FbmxhcmdlQnJhY2tldHM6IGNvbnRhaW5zVHJpZ2dlcn07XHJcblx0fVxyXG5cclxuXHJcblx0cmV0dXJuIHtzdWNjZXNzOiBmYWxzZSwgc2hvdWxkQXV0b0VubGFyZ2VCcmFja2V0czogZmFsc2V9O1xyXG59XHJcblxyXG5jb25zdCBzbmlwcGV0U2hvdWxkUnVuSW5Nb2RlID0gKG9wdGlvbnM6IE9wdGlvbnMsIG1vZGU6IE1vZGUpID0+IHtcclxuXHRpZiAoXHJcblx0XHRvcHRpb25zLm1vZGUuaW5saW5lTWF0aCAmJiBtb2RlLmlubGluZU1hdGggfHxcclxuXHRcdG9wdGlvbnMubW9kZS5ibG9ja01hdGggJiYgbW9kZS5ibG9ja01hdGggfHxcclxuXHRcdChvcHRpb25zLm1vZGUuaW5saW5lTWF0aCB8fCBvcHRpb25zLm1vZGUuYmxvY2tNYXRoKSAmJiBtb2RlLmNvZGVNYXRoXHJcblx0KSB7XHJcblx0XHRpZiAoIW1vZGUudGV4dEVudikge1xyXG5cdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdGlmIChtb2RlLmluTWF0aCgpICYmIG1vZGUudGV4dEVudiAmJiBvcHRpb25zLm1vZGUudGV4dCkge1xyXG5cdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cclxuXHRpZiAob3B0aW9ucy5tb2RlLnRleHQgJiYgbW9kZS50ZXh0IHx8XHJcblx0XHRvcHRpb25zLm1vZGUuY29kZSAmJiBtb2RlLmNvZGVcclxuXHQpIHtcclxuXHRcdHJldHVybiB0cnVlO1xyXG5cdH1cclxufVxyXG5cclxuY29uc3QgaXNPbldvcmRCb3VuZGFyeSA9IChzdGF0ZTogRWRpdG9yU3RhdGUsIHRyaWdnZXJQb3M6IG51bWJlciwgdG86IG51bWJlciwgd29yZERlbGltaXRlcnM6IHN0cmluZykgPT4ge1xyXG5cdGNvbnN0IHByZXZDaGFyID0gc3RhdGUuc2xpY2VEb2ModHJpZ2dlclBvcy0xLCB0cmlnZ2VyUG9zKTtcclxuXHRjb25zdCBuZXh0Q2hhciA9IHN0YXRlLnNsaWNlRG9jKHRvLCB0bysxKTtcclxuXHJcblx0d29yZERlbGltaXRlcnMgPSB3b3JkRGVsaW1pdGVycy5yZXBsYWNlKFwiXFxcXG5cIiwgXCJcXG5cIik7XHJcblxyXG5cdHJldHVybiAod29yZERlbGltaXRlcnMuY29udGFpbnMocHJldkNoYXIpICYmIHdvcmREZWxpbWl0ZXJzLmNvbnRhaW5zKG5leHRDaGFyKSk7XHJcbn1cclxuXHJcbmNvbnN0IHRyaW1XaGl0ZXNwYWNlID0gKHJlcGxhY2VtZW50OiBzdHJpbmcsIGN0eDogQ29udGV4dCkgPT4ge1xyXG5cdGxldCBzcGFjZUluZGV4ID0gMDtcclxuXHJcblx0aWYgKHJlcGxhY2VtZW50LmVuZHNXaXRoKFwiIFwiKSkge1xyXG5cdFx0c3BhY2VJbmRleCA9IC0xO1xyXG5cdH1cclxuXHRlbHNlIHtcclxuXHRcdGNvbnN0IGxhc3RUaHJlZUNoYXJzID0gcmVwbGFjZW1lbnQuc2xpY2UoLTMpO1xyXG5cdFx0Y29uc3QgbGFzdENoYXIgPSBsYXN0VGhyZWVDaGFycy5zbGljZSgtMSk7XHJcblxyXG5cdFx0aWYgKGxhc3RUaHJlZUNoYXJzLnNsaWNlKDAsIDIpID09PSBcIiAkXCIgJiYgIWlzTmFOKHBhcnNlSW50KGxhc3RDaGFyKSkpIHtcclxuXHRcdFx0c3BhY2VJbmRleCA9IC0zO1xyXG5cdFx0fVxyXG5cdH1cclxuXHJcblx0aWYgKHNwYWNlSW5kZXggIT0gMCkge1xyXG5cdFx0aWYgKHNwYWNlSW5kZXggPT09IC0xKSB7XHJcblx0XHRcdHJlcGxhY2VtZW50ID0gcmVwbGFjZW1lbnQudHJpbUVuZCgpO1xyXG5cdFx0fVxyXG5cdFx0ZWxzZSBpZiAoc3BhY2VJbmRleCA9PT0gLTMpe1xyXG5cdFx0XHRyZXBsYWNlbWVudCA9IHJlcGxhY2VtZW50LnNsaWNlKDAsIC0zKSArIHJlcGxhY2VtZW50LnNsaWNlKC0yKTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHJldHVybiByZXBsYWNlbWVudDtcclxufSJdfQ==