import { getTikzSuggestions, } from "./utilities";
import { expandSnippets } from "./snippets/snippet_management";
import { queueSnippet } from "./snippets/codemirror/snippet_queue_state_field";
import { setCursor } from "./utils/editor_utils";
class SuggestorTrigger {
    text;
    codeBlockText;
    suggestions = [];
    constructor(ctx, view) {
        this.text = this.getCurrentLineText(ctx.pos, view);
        const source = this.getCodeBlockText(ctx, view);
        this.filteredSuggestions();
        if (!source)
            return;
        //const tokens=new BasicTikzTokens(source)
        //console.log(tokens)
    }
    getSuggestions() { return this.suggestions; }
    getText() { return this.text; }
    setTrigger(trigger) {
    }
    hasValue() {
        return this.text && this.text.length > 0 && this.suggestions.length !== 1 && this.suggestions[0] !== this.text;
    }
    getCurrentLineText(pos, view) {
        const line = view.state.doc.lineAt(pos);
        //const cursorOffsetInLine = (pos+2) - line.from;I don't know why I had this here
        const textUpToCursor = line.text.slice(0, pos - line.from).trim();
        const words = textUpToCursor.split(/([\s,\[\](){};]|--\+\+|--\+|--)+/);
        const word = words[words.length - 1] || '';
        /* Checks that need to be made
        1. In what command are we in if any.
        2. Are we inputting a Variable a coordinate or formatting.
        3. if Formatting Are we starting to type a command or are we inputting a value to a command
        */
        return words[words.length - 1] || "";
    }
    filteredSuggestions() {
        const allSuggestions = getTikzSuggestions().map(s => s.trigger || s.replacement);
        const filteredSuggestions = allSuggestions.filter((suggestion) => suggestion.toLowerCase().startsWith(this.text.toLowerCase()));
        const sortedSuggestions = filteredSuggestions.sort((a, b) => {
            const lowerLastWord = this.text.toLowerCase();
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
            const aExactMatch = aLower === lowerLastWord ? -1 : 0;
            const bExactMatch = bLower === lowerLastWord ? -1 : 0;
            if (aExactMatch !== bExactMatch)
                return aExactMatch - bExactMatch;
            if (a.length !== b.length)
                return a.length - b.length;
            return aLower.localeCompare(bLower);
        });
        this.suggestions = sortedSuggestions;
    }
    getCodeBlockText(ctx, view) {
        const doc = view.state.doc;
        const bounds = ctx.getBounds();
        if (bounds === null)
            throw new Error("No bounds found");
        const betweenText = doc.sliceString(bounds.start, bounds.end).trim();
        return betweenText;
    }
}
class Suggestor {
    trigger;
    selectionIndex = 0;
    context;
    containerEl;
    open(context, view) {
        // If the suggestor is already deployed, close it
        this.close();
        this.context = context;
        this.trigger = new SuggestorTrigger(this.context, view);
        if (!this.trigger.hasValue())
            return false;
        this.createContainerEl();
        this.updatePositionFromView(view);
        document.body.appendChild(this.containerEl);
        this.updateSelection();
        return true;
    }
    close() {
        document.body.querySelectorAll(".suggestion-item").forEach(node => node.remove());
        document.body.querySelector(".suggestion-dropdown")?.remove();
    }
    isSuggesterDeployed() { return !!document.body.querySelector(".suggestion-dropdown"); }
    setSelectionIndex(number) {
        this.selectionIndex = number;
        this.updateSelection();
    }
    moveSelectionIndex(number) {
        const items = this.getAlldropdownItems();
        this.selectionIndex = (suggestor.selectionIndex + number + items.length) % items.length;
        this.updateSelection(items);
    }
    updatePositionFromView(view) {
        const coords = view.coordsAtPos(view.state.selection.main.head);
        if (!coords)
            return false;
        this.updatePosition(coords.left, coords.bottom);
        return true;
    }
    createContainerEl() {
        const suggestions = this.trigger.getSuggestions();
        if (suggestions.length < 1)
            return;
        this.containerEl = document.createElement("div");
        this.containerEl.addClass("suggestion-dropdown");
        suggestions.forEach((suggestion) => {
            this.renderSuggestion(suggestion);
        });
    }
    renderSuggestion(suggestion) {
        this.containerEl.appendChild(Object.assign(document.createElement("div"), {
            className: "suggestion-item",
            innerText: suggestion
        }));
    }
    updatePosition(left, top) {
        if (!this.containerEl)
            return false;
        Object.assign(this.containerEl.style, {
            position: "absolute",
            left: `${left}px`,
            top: `${top}px`,
        });
        return true;
    }
    getAlldropdownItems() { return document.body.querySelectorAll(".suggestion-item"); }
    getDropdown() { return document.body.querySelector(".suggestion-dropdown"); }
    handleDropdownNavigation(event, view) {
        const dropdown = this.getDropdown();
        if (!dropdown)
            return;
        const items = this.getAlldropdownItems();
        if (items.length === 0)
            return;
        switch (true) {
            case event.key === "ArrowDown":
                this.moveSelectionIndex(1);
                event.preventDefault();
                break;
            case event.key === "ArrowUp":
                this.moveSelectionIndex(-1);
                event.preventDefault();
                break;
            case event.key === "ArrowLeft" || event.key === "ArrowRight":
                suggestor.close();
                break;
            case event.key === "Backspace":
                suggestor.close();
                break;
            case event.key === "Enter":
                suggestor.selectDropdownItem(view);
                event.preventDefault();
                break;
            case event.key === "Escape":
                suggestor.close();
                event.preventDefault();
                break;
            default:
                return false;
        }
        return true;
    }
    updateSelection(items = this.getAlldropdownItems()) {
        items.forEach((item, index) => {
            if (index === this.selectionIndex) {
                item.classList.add("selected");
                item.scrollIntoView({ block: "nearest" });
            }
            else {
                item.classList.remove("selected");
            }
        });
    }
    selectDropdownItem(view, item = this.getAlldropdownItems()[this.selectionIndex]) {
        this.close();
        if (!this.context)
            return;
        const trigger = this.trigger.getText();
        const selectedText = item.textContent || "";
        const pos = this.context.pos;
        queueSnippet(view, pos - trigger.length, pos, selectedText);
        const success = expandSnippets(view);
        view.focus();
        setCursor(view, calculateNewCursorPosition(trigger, selectedText, pos));
        return success;
    }
}
function calculateNewCursorPosition(triggerText, selectedText, originalPos) {
    console.log('calculateNewCursorPosition', triggerText, selectedText, originalPos);
    const lengthDifference = selectedText.length - triggerText.length;
    return originalPos + lengthDifference;
}
export const suggestor = new Suggestor();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N1Z2dlc3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEdBQUksTUFBTSxhQUFhLENBQUM7QUFHbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQUMvRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFakQsTUFBTSxnQkFBZ0I7SUFDYixJQUFJLENBQVE7SUFDWixhQUFhLENBQVM7SUFDdEIsV0FBVyxHQUFXLEVBQUUsQ0FBQztJQUNqQyxZQUFZLEdBQVksRUFBRSxJQUFnQjtRQUN6QyxJQUFJLENBQUMsSUFBSSxHQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ2hELE1BQU0sTUFBTSxHQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUE7UUFDMUIsSUFBRyxDQUFDLE1BQU07WUFBQyxPQUFNO1FBQ2pCLDBDQUEwQztRQUMxQyxxQkFBcUI7SUFDdEIsQ0FBQztJQUNELGNBQWMsS0FBRyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUEsQ0FBQSxDQUFDO0lBQ3pDLE9BQU8sS0FBRyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUEsQ0FBQSxDQUFDO0lBQzNCLFVBQVUsQ0FBQyxPQUFlO0lBRTFCLENBQUM7SUFDRCxRQUFRO1FBQ1AsT0FBTyxJQUFJLENBQUMsSUFBSSxJQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFDLENBQUMsSUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sS0FBRyxDQUFDLElBQUUsSUFBSSxDQUFDLFdB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R0FBRyxnQkFBZ0IsQ0FBQztBQUMxQyxDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLElBQUksU0FBUyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRUaWt6U3VnZ2VzdGlvbnMsICB9IGZyb20gXCIuL3V0aWxpdGllc1wiO1xyXG5pbXBvcnQgeyBFZGl0b3JWaWV3LCB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XHJcbmltcG9ydCB7IGV4cGFuZFNuaXBwZXRzIH0gZnJvbSBcIi4vc25pcHBldHMvc25pcHBldF9tYW5hZ2VtZW50XCI7XHJcbmltcG9ydCB7IHF1ZXVlU25pcHBldCB9IGZyb20gXCIuL3NuaXBwZXRzL2NvZGVtaXJyb3Ivc25pcHBldF9xdWV1ZV9zdGF0ZV9maWVsZFwiO1xyXG5pbXBvcnQgeyBzZXRDdXJzb3IgfSBmcm9tIFwiLi91dGlscy9lZGl0b3JfdXRpbHNcIjtcclxuXHJcbmNsYXNzIFN1Z2dlc3RvclRyaWdnZXJ7XHJcblx0cHJpdmF0ZSB0ZXh0OiBzdHJpbmdcclxuXHRwcml2YXRlIGNvZGVCbG9ja1RleHQ6IHN0cmluZztcclxuXHRwcml2YXRlIHN1Z2dlc3Rpb25zOiBzdHJpbmdbXT1bXTtcclxuXHRjb25zdHJ1Y3RvcihjdHg6IENvbnRleHQsIHZpZXc6IEVkaXRvclZpZXcpe1xyXG5cdFx0dGhpcy50ZXh0PXRoaXMuZ2V0Q3VycmVudExpbmVUZXh0KGN0eC5wb3MsIHZpZXcpXHJcblx0XHRjb25zdCBzb3VyY2U9dGhpcy5nZXRDb2RlQmxvY2tUZXh0KGN0eCx2aWV3KVxyXG5cdFx0dGhpcy5maWx0ZXJlZFN1Z2dlc3Rpb25zKClcclxuXHRcdGlmKCFzb3VyY2UpcmV0dXJuXHJcblx0XHQvL2NvbnN0IHRva2Vucz1uZXcgQmFzaWNUaWt6VG9rZW5zKHNvdXJjZSlcclxuXHRcdC8vY29uc29sZS5sb2codG9rZW5zKVxyXG5cdH1cclxuXHRnZXRTdWdnZXN0aW9ucygpe3JldHVybiB0aGlzLnN1Z2dlc3Rpb25zfVxyXG5cdGdldFRleHQoKXtyZXR1cm4gdGhpcy50ZXh0fVxyXG5cdHNldFRyaWdnZXIodHJpZ2dlcjogc3RyaW5nKXtcclxuXHJcblx0fVxyXG5cdGhhc1ZhbHVlKCl7XHJcblx0XHRyZXR1cm4gdGhpcy50ZXh0JiZ0aGlzLnRleHQubGVuZ3RoPjAmJnRoaXMuc3VnZ2VzdGlvbnMubGVuZ3RoIT09MSYmdGhpcy5zdWdnZXN0aW9uc1swXSE9PXRoaXMudGV4dFxyXG5cdH1cclxuXHRnZXRDdXJyZW50TGluZVRleHQocG9zOiBudW1iZXIsIHZpZXc6IEVkaXRvclZpZXcpOiBzdHJpbmcge1xyXG5cdFx0Y29uc3QgbGluZSA9IHZpZXcuc3RhdGUuZG9jLmxpbmVBdChwb3MpO1xyXG5cdFx0Ly9jb25zdCBjdXJzb3JPZmZzZXRJbkxpbmUgPSAocG9zKzIpIC0gbGluZS5mcm9tO0kgZG9uJ3Qga25vdyB3aHkgSSBoYWQgdGhpcyBoZXJlXHJcblx0XHRjb25zdCB0ZXh0VXBUb0N1cnNvciA9IGxpbmUudGV4dC5zbGljZSgwLCBwb3MtIGxpbmUuZnJvbSkudHJpbSgpO1xyXG5cdFx0Y29uc3Qgd29yZHMgPSB0ZXh0VXBUb0N1cnNvci5zcGxpdCgvKFtcXHMsXFxbXFxdKCl7fTtdfC0tXFwrXFwrfC0tXFwrfC0tKSsvKTtcclxuXHRcdGNvbnN0IHdvcmQ9d29yZHNbd29yZHMubGVuZ3RoIC0gMV18fCcnO1xyXG5cdFx0LyogQ2hlY2tzIHRoYXQgbmVlZCB0byBiZSBtYWRlXHJcblx0XHQxLiBJbiB3aGF0IGNvbW1hbmQgYXJlIHdlIGluIGlmIGFueS5cclxuXHRcdDIuIEFyZSB3ZSBpbnB1dHRpbmcgYSBWYXJpYWJsZSBhIGNvb3JkaW5hdGUgb3IgZm9ybWF0dGluZy5cclxuXHRcdDMuIGlmIEZvcm1hdHRpbmcgQXJlIHdlIHN0YXJ0aW5nIHRvIHR5cGUgYSBjb21tYW5kIG9yIGFyZSB3ZSBpbnB1dHRpbmcgYSB2YWx1ZSB0byBhIGNvbW1hbmRcclxuXHRcdCovXHJcblx0XHRyZXR1cm4gd29yZHNbd29yZHMubGVuZ3RoIC0gMV0gfHwgXCJcIjtcclxuXHR9XHJcblx0cHJpdmF0ZSBmaWx0ZXJlZFN1Z2dlc3Rpb25zKCkge1xyXG5cdFx0Y29uc3QgYWxsU3VnZ2VzdGlvbnMgPSBnZXRUaWt6U3VnZ2VzdGlvbnMoKS5tYXAocyA9PiBzLnRyaWdnZXIgfHwgcy5yZXBsYWNlbWVudCk7XHJcblx0XHJcblx0XHRjb25zdCBmaWx0ZXJlZFN1Z2dlc3Rpb25zID0gYWxsU3VnZ2VzdGlvbnMuZmlsdGVyKChzdWdnZXN0aW9uKSA9PlxyXG5cdFx0XHRzdWdnZXN0aW9uLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCh0aGlzLnRleHQudG9Mb3dlckNhc2UoKSlcclxuXHRcdCk7XHJcblx0XHJcblx0XHRjb25zdCBzb3J0ZWRTdWdnZXN0aW9ucyA9IGZpbHRlcmVkU3VnZ2VzdGlvbnMuc29ydCgoYSwgYikgPT4ge1xyXG5cdFx0XHRjb25zdCBsb3dlckxhc3RXb3JkID0gdGhpcy50ZXh0LnRvTG93ZXJDYXNlKCk7XHJcblx0XHRcdGNvbnN0IGFMb3dlciA9IGEudG9Mb3dlckNhc2UoKTtcclxuXHRcdFx0Y29uc3QgYkxvd2VyID0gYi50b0xvd2VyQ2FzZSgpO1xyXG5cdFxyXG5cdFx0XHRjb25zdCBhRXhhY3RNYXRjaCA9IGFMb3dlciA9PT0gbG93ZXJMYXN0V29yZCA/IC0xIDogMDtcclxuXHRcdFx0Y29uc3QgYkV4YWN0TWF0Y2ggPSBiTG93ZXIgPT09IGxvd2VyTGFzdFdvcmQgPyAtMSA6IDA7XHJcblx0XHRcdGlmIChhRXhhY3RNYXRjaCAhPT0gYkV4YWN0TWF0Y2gpIHJldHVybiBhRXhhY3RNYXRjaCAtIGJFeGFjdE1hdGNoO1xyXG5cdFxyXG5cdFx0XHRpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSByZXR1cm4gYS5sZW5ndGggLSBiLmxlbmd0aDtcclxuXHRcclxuXHRcdFx0cmV0dXJuIGFMb3dlci5sb2NhbGVDb21wYXJlKGJMb3dlcik7XHJcblx0XHR9KTtcclxuXHRcdHRoaXMuc3VnZ2VzdGlvbnMgPSBzb3J0ZWRTdWdnZXN0aW9ucztcclxuXHR9XHJcblx0Z2V0Q29kZUJsb2NrVGV4dChjdHg6IENvbnRleHQsdmlldzogRWRpdG9yVmlldyl7XHJcblx0XHRjb25zdCBkb2MgPSB2aWV3LnN0YXRlLmRvYztcclxuXHRcdFxyXG5cdFx0Y29uc3QgYm91bmRzPWN0eC5nZXRCb3VuZHMoKVxyXG5cdFx0aWYoYm91bmRzPT09bnVsbClcclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiTm8gYm91bmRzIGZvdW5kXCIpXHJcblxyXG5cclxuXHRcdGNvbnN0IGJldHdlZW5UZXh0ID0gZG9jLnNsaWNlU3RyaW5nKGJvdW5kcy5zdGFydCwgYm91bmRzLmVuZCkudHJpbSgpO1xyXG5cdFx0cmV0dXJuIGJldHdlZW5UZXh0XHJcblx0fVxyXG59XHJcblxyXG5jbGFzcyBTdWdnZXN0b3Ige1xyXG5cdHByaXZhdGUgdHJpZ2dlcjogU3VnZ2VzdG9yVHJpZ2dlcjtcclxuXHRwcml2YXRlIHNlbGVjdGlvbkluZGV4OiBudW1iZXI9MDtcclxuXHRwcml2YXRlIGNvbnRleHQ6IENvbnRleHQ7XHJcblx0cHJpdmF0ZSBjb250YWluZXJFbDogSFRNTEVsZW1lbnQ7XHJcblxyXG5cdG9wZW4oY29udGV4dDogQ29udGV4dCx2aWV3OiBFZGl0b3JWaWV3KXtcclxuXHRcdC8vIElmIHRoZSBzdWdnZXN0b3IgaXMgYWxyZWFkeSBkZXBsb3llZCwgY2xvc2UgaXRcclxuXHRcdHRoaXMuY2xvc2UoKTtcclxuXHRcdHRoaXMuY29udGV4dD1jb250ZXh0O1xyXG5cdFx0dGhpcy50cmlnZ2VyPW5ldyBTdWdnZXN0b3JUcmlnZ2VyKHRoaXMuY29udGV4dCwgdmlldylcclxuXHRcdGlmKCF0aGlzLnRyaWdnZXIuaGFzVmFsdWUoKSlyZXR1cm4gZmFsc2U7XHJcblx0XHR0aGlzLmNyZWF0ZUNvbnRhaW5lckVsKCk7XHJcblx0XHR0aGlzLnVwZGF0ZVBvc2l0aW9uRnJvbVZpZXcodmlldyk7XHJcblx0XHRkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHRoaXMuY29udGFpbmVyRWwpO1xyXG5cdFx0dGhpcy51cGRhdGVTZWxlY3Rpb24oKTtcclxuXHRcdHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHRjbG9zZSgpe1xyXG5cdFx0ZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yQWxsKFwiLnN1Z2dlc3Rpb24taXRlbVwiKS5mb3JFYWNoKG5vZGUgPT4gbm9kZS5yZW1vdmUoKSk7XHJcblx0XHRkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoXCIuc3VnZ2VzdGlvbi1kcm9wZG93blwiKT8ucmVtb3ZlKCk7XHJcblx0fVxyXG5cdGlzU3VnZ2VzdGVyRGVwbG95ZWQoKTogYm9vbGVhbiB7cmV0dXJuICEhZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik7fVxyXG5cdHNldFNlbGVjdGlvbkluZGV4KG51bWJlcjogbnVtYmVyKXtcclxuXHRcdHRoaXMuc2VsZWN0aW9uSW5kZXg9bnVtYmVyXHJcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbigpXHJcblx0fVxyXG5cdG1vdmVTZWxlY3Rpb25JbmRleChudW1iZXI6IG51bWJlcil7XHJcblx0XHRjb25zdCBpdGVtcz10aGlzLmdldEFsbGRyb3Bkb3duSXRlbXMoKVxyXG5cdFx0dGhpcy5zZWxlY3Rpb25JbmRleD0oc3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4ICtudW1iZXIgKyBpdGVtcy5sZW5ndGgpICUgaXRlbXMubGVuZ3RoXHJcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbihpdGVtcylcclxuXHR9XHJcblxyXG5cdHVwZGF0ZVBvc2l0aW9uRnJvbVZpZXcodmlldzogRWRpdG9yVmlldyk6IGJvb2xlYW57XHJcblx0XHRjb25zdCBjb29yZHM9dmlldy5jb29yZHNBdFBvcyh2aWV3LnN0YXRlLnNlbGVjdGlvbi5tYWluLmhlYWQpXHJcblx0XHRpZiAoIWNvb3JkcykgcmV0dXJuIGZhbHNlO1xyXG5cdFx0dGhpcy51cGRhdGVQb3NpdGlvbihjb29yZHMubGVmdCxjb29yZHMuYm90dG9tKVxyXG5cdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cdFxyXG5cdFxyXG5cdGNyZWF0ZUNvbnRhaW5lckVsKCl7XHJcblx0XHRjb25zdCBzdWdnZXN0aW9ucz10aGlzLnRyaWdnZXIuZ2V0U3VnZ2VzdGlvbnMoKVxyXG5cdFx0aWYoc3VnZ2VzdGlvbnMubGVuZ3RoPDEpcmV0dXJuO1xyXG5cdFx0dGhpcy5jb250YWluZXJFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcblx0XHR0aGlzLmNvbnRhaW5lckVsLmFkZENsYXNzKFwic3VnZ2VzdGlvbi1kcm9wZG93blwiKVxyXG5cclxuXHRcdHN1Z2dlc3Rpb25zLmZvckVhY2goKHN1Z2dlc3Rpb24pID0+IHtcclxuXHRcdFx0dGhpcy5yZW5kZXJTdWdnZXN0aW9uKHN1Z2dlc3Rpb24pO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRyZW5kZXJTdWdnZXN0aW9uKHN1Z2dlc3Rpb246IHN0cmluZyl7XHJcblx0XHR0aGlzLmNvbnRhaW5lckVsLmFwcGVuZENoaWxkKFxyXG5cdFx0XHRPYmplY3QuYXNzaWduKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiksIHtcclxuXHRcdFx0XHRjbGFzc05hbWU6IFwic3VnZ2VzdGlvbi1pdGVtXCIsXHJcblx0XHRcdFx0aW5uZXJUZXh0OiBzdWdnZXN0aW9uXHJcblx0XHRcdH0pXHJcblx0XHQpO1xyXG5cdH1cclxuXHJcblx0dXBkYXRlUG9zaXRpb24obGVmdDogbnVtYmVyLHRvcDogbnVtYmVyKXtcclxuXHRcdGlmICghdGhpcy5jb250YWluZXJFbCkgcmV0dXJuIGZhbHNlO1xyXG5cdFx0T2JqZWN0LmFzc2lnbih0aGlzLmNvbnRhaW5lckVsLnN0eWxlLHtcclxuXHRcdFx0cG9zaXRpb246IFwiYWJzb2x1dGVcIixcclxuXHRcdFx0bGVmdDogYCR7bGVmdH1weGAsXHJcblx0XHRcdHRvcDogYCR7dG9wfXB4YCxcclxuXHRcdH0pO1xyXG5cdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cclxuXHRnZXRBbGxkcm9wZG93bkl0ZW1zKCl7cmV0dXJuIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIil9XHJcblx0cHJpdmF0ZSBnZXREcm9wZG93bigpe3JldHVybiBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoXCIuc3VnZ2VzdGlvbi1kcm9wZG93blwiKX1cclxuXHJcblx0aGFuZGxlRHJvcGRvd25OYXZpZ2F0aW9uKGV2ZW50OiBLZXlib2FyZEV2ZW50LHZpZXc6RWRpdG9yVmlldykge1xyXG5cdFx0Y29uc3QgZHJvcGRvd24gPSB0aGlzLmdldERyb3Bkb3duKCk7XHJcblx0XHRpZiAoIWRyb3Bkb3duKSByZXR1cm47XHJcblx0XHJcblx0XHRjb25zdCBpdGVtcyA9IHRoaXMuZ2V0QWxsZHJvcGRvd25JdGVtcygpO1xyXG5cclxuXHRcdGlmIChpdGVtcy5sZW5ndGggPT09IDApIHJldHVybjtcclxuXHRcdHN3aXRjaCAodHJ1ZSkge1xyXG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd0Rvd25cIjpcclxuXHRcdFx0XHR0aGlzLm1vdmVTZWxlY3Rpb25JbmRleCgxKVxyXG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgZXZlbnQua2V5ID09PSBcIkFycm93VXBcIjpcclxuXHRcdFx0XHR0aGlzLm1vdmVTZWxlY3Rpb25JbmRleCgtMSlcclxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd0xlZnRcInx8ZXZlbnQua2V5ID09PSBcIkFycm93UmlnaHRcIjpcclxuXHRcdFx0XHRzdWdnZXN0b3IuY2xvc2UoKTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiQmFja3NwYWNlXCI6XHJcblx0XHRcdFx0c3VnZ2VzdG9yLmNsb3NlKCk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgZXZlbnQua2V5ID09PSBcIkVudGVyXCI6XHJcblx0XHRcdFx0c3VnZ2VzdG9yLnNlbGVjdERyb3Bkb3duSXRlbSh2aWV3KTtcclxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIjpcclxuXHRcdFx0XHRzdWdnZXN0b3IuY2xvc2UoKTtcclxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRkZWZhdWx0OlxyXG5cdFx0XHRcdHJldHVybiBmYWxzZTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHJcblx0dXBkYXRlU2VsZWN0aW9uKGl0ZW1zOiBOb2RlTGlzdE9mPEVsZW1lbnQ+PXRoaXMuZ2V0QWxsZHJvcGRvd25JdGVtcygpKSB7XHJcblx0XHRpdGVtcy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xyXG5cdFx0XHRpZiAoaW5kZXggPT09IHRoaXMuc2VsZWN0aW9uSW5kZXgpIHtcclxuXHRcdFx0XHRpdGVtLmNsYXNzTGlzdC5hZGQoXCJzZWxlY3RlZFwiKTtcclxuXHRcdFx0XHRpdGVtLnNjcm9sbEludG9WaWV3KHsgYmxvY2s6IFwibmVhcmVzdFwiIH0pO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdGl0ZW0uY2xhc3NMaXN0LnJlbW92ZShcInNlbGVjdGVkXCIpO1xyXG5cdFx0XHR9XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHNlbGVjdERyb3Bkb3duSXRlbSh2aWV3OiBFZGl0b3JWaWV3LGl0ZW06IEVsZW1lbnQ9dGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKClbdGhpcy5zZWxlY3Rpb25JbmRleF0pIHtcclxuXHRcdHRoaXMuY2xvc2UoKVxyXG5cdFx0aWYoIXRoaXMuY29udGV4dClyZXR1cm47XHJcblxyXG5cdFx0Y29uc3QgdHJpZ2dlcj10aGlzLnRyaWdnZXIuZ2V0VGV4dCgpXHJcblxyXG5cdFx0Y29uc3Qgc2VsZWN0ZWRUZXh0ID0gaXRlbS50ZXh0Q29udGVudCB8fCBcIlwiO1xyXG5cdFx0Y29uc3QgcG9zPXRoaXMuY29udGV4dC5wb3M7XHJcblx0XHRxdWV1ZVNuaXBwZXQodmlldyxwb3MtdHJpZ2dlci5sZW5ndGgscG9zLHNlbGVjdGVkVGV4dClcclxuXHRcdGNvbnN0IHN1Y2Nlc3MgPSBleHBhbmRTbmlwcGV0cyh2aWV3KTtcclxuXHRcdHZpZXcuZm9jdXMoKTtcclxuXHRcdHNldEN1cnNvcih2aWV3LGNhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uKHRyaWdnZXIsc2VsZWN0ZWRUZXh0LHBvcykpXHJcblx0XHRyZXR1cm4gc3VjY2VzcztcclxuXHR9XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBjYWxjdWxhdGVOZXdDdXJzb3JQb3NpdGlvbih0cmlnZ2VyVGV4dDogc3RyaW5nLCBzZWxlY3RlZFRleHQ6IHN0cmluZywgb3JpZ2luYWxQb3M6IG51bWJlcik6IG51bWJlciB7XHJcblx0Y29uc29sZS5sb2coJ2NhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uJyx0cmlnZ2VyVGV4dCxzZWxlY3RlZFRleHQsb3JpZ2luYWxQb3MpXHJcbiAgICBjb25zdCBsZW5ndGhEaWZmZXJlbmNlID0gc2VsZWN0ZWRUZXh0Lmxlbmd0aCAtIHRyaWdnZXJUZXh0Lmxlbmd0aDtcclxuICAgIHJldHVybiBvcmlnaW5hbFBvcyArIGxlbmd0aERpZmZlcmVuY2U7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBzdWdnZXN0b3IgPSBuZXcgU3VnZ2VzdG9yKCk7Il19