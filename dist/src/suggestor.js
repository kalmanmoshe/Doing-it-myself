import { getTikzSuggestions, } from "./utilities";
import { setCursor } from "./editor utilities/editor_utils";
import { expandSnippets } from "./snippets/snippet_management";
import { queueSnippet } from "./snippets/codemirror/snippet_queue_state_field";
class SuggestorTrigger {
    text;
    codeBlockText;
    suggestions = [];
    constructor(ctx, view) {
        this.text = this.getCurrentLineText(ctx.pos, view);
        const source = this.getCodeBlockText(ctx, view);
        this.filteredSuggestions();
        if (!source)
            return;
        //const tokens=new BasicTikzTokens(source)
        //console.log(tokens)
    }
    getSuggestions() { return this.suggestions; }
    getText() { return this.text; }
    setTrigger(trigger) {
    }
    hasValue() {
        return this.text && this.text.length > 0 && this.suggestions.length !== 1 && this.suggestions[0] !== this.text;
    }
    getCurrentLineText(pos, view) {
        const line = view.state.doc.lineAt(pos);
        //const cursorOffsetInLine = (pos+2) - line.from;I don't know why I had this here
        const textUpToCursor = line.text.slice(0, pos - line.from).trim();
        const words = textUpToCursor.split(/([\s,\[\](){};]|--\+\+|--\+|--)+/);
        const word = words[words.length - 1] || '';
        /* Checks that need to be made
        1. In what command are we in if any.
        2. Are we inputting a Variable a coordinate or formatting.
        3. if Formatting Are we starting to type a command or are we inputting a value to a command
        */
        return words[words.length - 1] || "";
    }
    filteredSuggestions() {
        const allSuggestions = getTikzSuggestions().map(s => s.trigger || s.replacement);
        const filteredSuggestions = allSuggestions.filter((suggestion) => suggestion.toLowerCase().startsWith(this.text.toLowerCase()));
        const sortedSuggestions = filteredSuggestions.sort((a, b) => {
            const lowerLastWord = this.text.toLowerCase();
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
            const aExactMatch = aLower === lowerLastWord ? -1 : 0;
            const bExactMatch = bLower === lowerLastWord ? -1 : 0;
            if (aExactMatch !== bExactMatch)
                return aExactMatch - bExactMatch;
            if (a.length !== b.length)
                return a.length - b.length;
            return aLower.localeCompare(bLower);
        });
        this.suggestions = sortedSuggestions;
    }
    getCodeBlockText(ctx, view) {
        const doc = view.state.doc;
        const bounds = ctx.getBounds();
        if (bounds === null)
            throw new Error("No bounds found");
        const betweenText = doc.sliceString(bounds.start, bounds.end).trim();
        return betweenText;
    }
}
class Suggestor {
    trigger;
    selectionIndex = 0;
    context;
    containerEl;
    open(context, view) {
        // If the suggestor is already deployed, close it
        this.close();
        this.context = context;
        this.trigger = new SuggestorTrigger(this.context, view);
        if (!this.trigger.hasValue())
            return false;
        this.createContainerEl();
        this.updatePositionFromView(view);
        document.body.appendChild(this.containerEl);
        this.updateSelection();
        return true;
    }
    close() {
        document.body.querySelectorAll(".suggestion-item").forEach(node => node.remove());
        document.body.querySelector(".suggestion-dropdown")?.remove();
    }
    isSuggesterDeployed() { return !!document.body.querySelector(".suggestion-dropdown"); }
    setSelectionIndex(number) {
        this.selectionIndex = number;
        this.updateSelection();
    }
    moveSelectionIndex(number) {
        const items = this.getAlldropdownItems();
        this.selectionIndex = (suggestor.selectionIndex + number + items.length) % items.length;
        this.updateSelection(items);
    }
    updatePositionFromView(view) {
        const coords = view.coordsAtPos(view.state.selection.main.head);
        if (!coords)
            return false;
        this.updatePosition(coords.left, coords.bottom);
        return true;
    }
    createContainerEl() {
        const suggestions = this.trigger.getSuggestions();
        if (suggestions.length < 1)
            return;
        this.containerEl = document.createElement("div");
        this.containerEl.addClass("suggestion-dropdown");
        suggestions.forEach((suggestion) => {
            this.renderSuggestion(suggestion);
        });
    }
    renderSuggestion(suggestion) {
        this.containerEl.appendChild(Object.assign(document.createElement("div"), {
            className: "suggestion-item",
            innerText: suggestion
        }));
    }
    updatePosition(left, top) {
        if (!this.containerEl)
            return false;
        Object.assign(this.containerEl.style, {
            position: "absolute",
            left: `${left}px`,
            top: `${top}px`,
        });
        return true;
    }
    getAlldropdownItems() { return document.body.querySelectorAll(".suggestion-item"); }
    getDropdown() { return document.body.querySelector(".suggestion-dropdown"); }
    handleDropdownNavigation(event, view) {
        const dropdown = this.getDropdown();
        if (!dropdown)
            return;
        const items = this.getAlldropdownItems();
        if (items.length === 0)
            return;
        switch (true) {
            case event.key === "ArrowDown":
                this.moveSelectionIndex(1);
                event.preventDefault();
                break;
            case event.key === "ArrowUp":
                this.moveSelectionIndex(-1);
                event.preventDefault();
                break;
            case event.key === "ArrowLeft" || event.key === "ArrowRight":
                suggestor.close();
                break;
            case event.key === "Backspace":
                suggestor.close();
                break;
            case event.key === "Enter":
                suggestor.selectDropdownItem(view);
                event.preventDefault();
                break;
            case event.key === "Escape":
                suggestor.close();
                event.preventDefault();
                break;
            default:
                return false;
        }
        return true;
    }
    updateSelection(items = this.getAlldropdownItems()) {
        items.forEach((item, index) => {
            if (index === this.selectionIndex) {
                item.classList.add("selected");
                item.scrollIntoView({ block: "nearest" });
            }
            else {
                item.classList.remove("selected");
            }
        });
    }
    selectDropdownItem(view, item = this.getAlldropdownItems()[this.selectionIndex]) {
        this.close();
        if (!this.context)
            return;
        const trigger = this.trigger.getText();
        const selectedText = item.textContent || "";
        const pos = this.context.pos;
        queueSnippet(view, pos - trigger.length, pos, selectedText);
        const success = expandSnippets(view);
        view.focus();
        setCursor(view, calculateNewCursorPosition(trigger, selectedText, pos));
        return success;
    }
}
function calculateNewCursorPosition(triggerText, selectedText, originalPos) {
    console.log('calculateNewCursorPosition', triggerText, selectedText, originalPos);
    const lengthDifference = selectedText.length - triggerText.length;
    return originalPos + lengthDifference;
}
export const suggestor = new Suggestor();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N1Z2dlc3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEdBQUksTUFBTSxhQUFhLENBQUM7QUFHbkQsT0FBTyxFQUFnQixTQUFTLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUMxRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBRS9FLE1BQU0sZ0JBQWdCO0lBQ2IsSUFBSSxDQUFRO0lBQ1osYUFBYSxDQUFTO0lBQ3RCLFdBQVcsR0FBVyxFQUFFLENBQUM7SUFDakMsWUFBWSxHQUFZLEVBQUUsSUFBZ0I7UUFDekMsSUFBSSxDQUFDLElBQUksR0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNoRCxNQUFNLE1BQU0sR0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFDLElBQUksQ0FBQyxDQUFBO1FBQzVDLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFBO1FBQzFCLElBQUcsQ0FBQyxNQUFNO1lBQUMsT0FBTTtRQUNqQiwwQ0FBMEM7UUFDMUMscUJBQXFCO0lBQ3RCLENBQUM7SUFDRCxjQUFjLEtBQUcsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFBLENBQUEsQ0FBQztJQUN6QyxPQUFPLEtBQUcsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFBLENBQUEsQ0FBQztJQUMzQixVQUFVLENBQUMsT0FBZTtJQUUxQixDQUFDO0lBQ0QsUUFBUTtRQUNQLE9BQU8sSUFBSSxDQUFDLElBQUksSUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sR0FBQyxDQUFDLElBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEtBQUcsQ0FBQyxJQUFFLElBQUksQ0FBQyxX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LEdBQUcsZ0JBQWdCLENBQUM7QUFDMUMsQ0FBQztBQUVELE1BQU0sQ0FBQyxNQUFNLFNBQVMsR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0VGlrelN1Z2dlc3Rpb25zLCAgfSBmcm9tIFwiLi91dGlsaXRpZXNcIjtcbmltcG9ydCB7IEVkaXRvclZpZXcsIH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XG5pbXBvcnQgeyByZXBsYWNlUmFuZ2UsIHNldEN1cnNvciB9IGZyb20gXCIuL2VkaXRvciB1dGlsaXRpZXMvZWRpdG9yX3V0aWxzXCI7XG5pbXBvcnQgeyBleHBhbmRTbmlwcGV0cyB9IGZyb20gXCIuL3NuaXBwZXRzL3NuaXBwZXRfbWFuYWdlbWVudFwiO1xuaW1wb3J0IHsgcXVldWVTbmlwcGV0IH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XG5cbmNsYXNzIFN1Z2dlc3RvclRyaWdnZXJ7XG5cdHByaXZhdGUgdGV4dDogc3RyaW5nXG5cdHByaXZhdGUgY29kZUJsb2NrVGV4dDogc3RyaW5nO1xuXHRwcml2YXRlIHN1Z2dlc3Rpb25zOiBzdHJpbmdbXT1bXTtcblx0Y29uc3RydWN0b3IoY3R4OiBDb250ZXh0LCB2aWV3OiBFZGl0b3JWaWV3KXtcblx0XHR0aGlzLnRleHQ9dGhpcy5nZXRDdXJyZW50TGluZVRleHQoY3R4LnBvcywgdmlldylcblx0XHRjb25zdCBzb3VyY2U9dGhpcy5nZXRDb2RlQmxvY2tUZXh0KGN0eCx2aWV3KVxuXHRcdHRoaXMuZmlsdGVyZWRTdWdnZXN0aW9ucygpXG5cdFx0aWYoIXNvdXJjZSlyZXR1cm5cblx0XHQvL2NvbnN0IHRva2Vucz1uZXcgQmFzaWNUaWt6VG9rZW5zKHNvdXJjZSlcblx0XHQvL2NvbnNvbGUubG9nKHRva2Vucylcblx0fVxuXHRnZXRTdWdnZXN0aW9ucygpe3JldHVybiB0aGlzLnN1Z2dlc3Rpb25zfVxuXHRnZXRUZXh0KCl7cmV0dXJuIHRoaXMudGV4dH1cblx0c2V0VHJpZ2dlcih0cmlnZ2VyOiBzdHJpbmcpe1xuXG5cdH1cblx0aGFzVmFsdWUoKXtcblx0XHRyZXR1cm4gdGhpcy50ZXh0JiZ0aGlzLnRleHQubGVuZ3RoPjAmJnRoaXMuc3VnZ2VzdGlvbnMubGVuZ3RoIT09MSYmdGhpcy5zdWdnZXN0aW9uc1swXSE9PXRoaXMudGV4dFxuXHR9XG5cdGdldEN1cnJlbnRMaW5lVGV4dChwb3M6IG51bWJlciwgdmlldzogRWRpdG9yVmlldyk6IHN0cmluZyB7XG5cdFx0Y29uc3QgbGluZSA9IHZpZXcuc3RhdGUuZG9jLmxpbmVBdChwb3MpO1xuXHRcdC8vY29uc3QgY3Vyc29yT2Zmc2V0SW5MaW5lID0gKHBvcysyKSAtIGxpbmUuZnJvbTtJIGRvbid0IGtub3cgd2h5IEkgaGFkIHRoaXMgaGVyZVxuXHRcdGNvbnN0IHRleHRVcFRvQ3Vyc29yID0gbGluZS50ZXh0LnNsaWNlKDAsIHBvcy0gbGluZS5mcm9tKS50cmltKCk7XG5cdFx0Y29uc3Qgd29yZHMgPSB0ZXh0VXBUb0N1cnNvci5zcGxpdCgvKFtcXHMsXFxbXFxdKCl7fTtdfC0tXFwrXFwrfC0tXFwrfC0tKSsvKTtcblx0XHRjb25zdCB3b3JkPXdvcmRzW3dvcmRzLmxlbmd0aCAtIDFdfHwnJztcblx0XHQvKiBDaGVja3MgdGhhdCBuZWVkIHRvIGJlIG1hZGVcblx0XHQxLiBJbiB3aGF0IGNvbW1hbmQgYXJlIHdlIGluIGlmIGFueS5cblx0XHQyLiBBcmUgd2UgaW5wdXR0aW5nIGEgVmFyaWFibGUgYSBjb29yZGluYXRlIG9yIGZvcm1hdHRpbmcuXG5cdFx0My4gaWYgRm9ybWF0dGluZyBBcmUgd2Ugc3RhcnRpbmcgdG8gdHlwZSBhIGNvbW1hbmQgb3IgYXJlIHdlIGlucHV0dGluZyBhIHZhbHVlIHRvIGEgY29tbWFuZFxuXHRcdCovXG5cdFx0cmV0dXJuIHdvcmRzW3dvcmRzLmxlbmd0aCAtIDFdIHx8IFwiXCI7XG5cdH1cblx0cHJpdmF0ZSBmaWx0ZXJlZFN1Z2dlc3Rpb25zKCkge1xuXHRcdGNvbnN0IGFsbFN1Z2dlc3Rpb25zID0gZ2V0VGlrelN1Z2dlc3Rpb25zKCkubWFwKHMgPT4gcy50cmlnZ2VyIHx8IHMucmVwbGFjZW1lbnQpO1xuXHRcblx0XHRjb25zdCBmaWx0ZXJlZFN1Z2dlc3Rpb25zID0gYWxsU3VnZ2VzdGlvbnMuZmlsdGVyKChzdWdnZXN0aW9uKSA9PlxuXHRcdFx0c3VnZ2VzdGlvbi50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgodGhpcy50ZXh0LnRvTG93ZXJDYXNlKCkpXG5cdFx0KTtcblx0XG5cdFx0Y29uc3Qgc29ydGVkU3VnZ2VzdGlvbnMgPSBmaWx0ZXJlZFN1Z2dlc3Rpb25zLnNvcnQoKGEsIGIpID0+IHtcblx0XHRcdGNvbnN0IGxvd2VyTGFzdFdvcmQgPSB0aGlzLnRleHQudG9Mb3dlckNhc2UoKTtcblx0XHRcdGNvbnN0IGFMb3dlciA9IGEudG9Mb3dlckNhc2UoKTtcblx0XHRcdGNvbnN0IGJMb3dlciA9IGIudG9Mb3dlckNhc2UoKTtcblx0XG5cdFx0XHRjb25zdCBhRXhhY3RNYXRjaCA9IGFMb3dlciA9PT0gbG93ZXJMYXN0V29yZCA/IC0xIDogMDtcblx0XHRcdGNvbnN0IGJFeGFjdE1hdGNoID0gYkxvd2VyID09PSBsb3dlckxhc3RXb3JkID8gLTEgOiAwO1xuXHRcdFx0aWYgKGFFeGFjdE1hdGNoICE9PSBiRXhhY3RNYXRjaCkgcmV0dXJuIGFFeGFjdE1hdGNoIC0gYkV4YWN0TWF0Y2g7XG5cdFxuXHRcdFx0aWYgKGEubGVuZ3RoICE9PSBiLmxlbmd0aCkgcmV0dXJuIGEubGVuZ3RoIC0gYi5sZW5ndGg7XG5cdFxuXHRcdFx0cmV0dXJuIGFMb3dlci5sb2NhbGVDb21wYXJlKGJMb3dlcik7XG5cdFx0fSk7XG5cdFx0dGhpcy5zdWdnZXN0aW9ucyA9IHNvcnRlZFN1Z2dlc3Rpb25zO1xuXHR9XG5cdGdldENvZGVCbG9ja1RleHQoY3R4OiBDb250ZXh0LHZpZXc6IEVkaXRvclZpZXcpe1xuXHRcdGNvbnN0IGRvYyA9IHZpZXcuc3RhdGUuZG9jO1xuXHRcdFxuXHRcdGNvbnN0IGJvdW5kcz1jdHguZ2V0Qm91bmRzKClcblx0XHRpZihib3VuZHM9PT1udWxsKVxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiTm8gYm91bmRzIGZvdW5kXCIpXG5cblxuXHRcdGNvbnN0IGJldHdlZW5UZXh0ID0gZG9jLnNsaWNlU3RyaW5nKGJvdW5kcy5zdGFydCwgYm91bmRzLmVuZCkudHJpbSgpO1xuXHRcdHJldHVybiBiZXR3ZWVuVGV4dFxuXHR9XG59XG5cbmNsYXNzIFN1Z2dlc3RvciB7XG5cdHByaXZhdGUgdHJpZ2dlcjogU3VnZ2VzdG9yVHJpZ2dlcjtcblx0cHJpdmF0ZSBzZWxlY3Rpb25JbmRleDogbnVtYmVyPTA7XG5cdHByaXZhdGUgY29udGV4dDogQ29udGV4dDtcblx0cHJpdmF0ZSBjb250YWluZXJFbDogSFRNTEVsZW1lbnQ7XG5cblx0b3Blbihjb250ZXh0OiBDb250ZXh0LHZpZXc6IEVkaXRvclZpZXcpe1xuXHRcdC8vIElmIHRoZSBzdWdnZXN0b3IgaXMgYWxyZWFkeSBkZXBsb3llZCwgY2xvc2UgaXRcblx0XHR0aGlzLmNsb3NlKCk7XG5cdFx0dGhpcy5jb250ZXh0PWNvbnRleHQ7XG5cdFx0dGhpcy50cmlnZ2VyPW5ldyBTdWdnZXN0b3JUcmlnZ2VyKHRoaXMuY29udGV4dCwgdmlldylcblx0XHRpZighdGhpcy50cmlnZ2VyLmhhc1ZhbHVlKCkpcmV0dXJuIGZhbHNlO1xuXHRcdHRoaXMuY3JlYXRlQ29udGFpbmVyRWwoKTtcblx0XHR0aGlzLnVwZGF0ZVBvc2l0aW9uRnJvbVZpZXcodmlldyk7XG5cdFx0ZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZCh0aGlzLmNvbnRhaW5lckVsKTtcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbigpO1xuXHRcdHJldHVybiB0cnVlO1xuXHR9XG5cdGNsb3NlKCl7XG5cdFx0ZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yQWxsKFwiLnN1Z2dlc3Rpb24taXRlbVwiKS5mb3JFYWNoKG5vZGUgPT4gbm9kZS5yZW1vdmUoKSk7XG5cdFx0ZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik/LnJlbW92ZSgpO1xuXHR9XG5cdGlzU3VnZ2VzdGVyRGVwbG95ZWQoKTogYm9vbGVhbiB7cmV0dXJuICEhZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik7fVxuXHRzZXRTZWxlY3Rpb25JbmRleChudW1iZXI6IG51bWJlcil7XG5cdFx0dGhpcy5zZWxlY3Rpb25JbmRleD1udW1iZXJcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbigpXG5cdH1cblx0bW92ZVNlbGVjdGlvbkluZGV4KG51bWJlcjogbnVtYmVyKXtcblx0XHRjb25zdCBpdGVtcz10aGlzLmdldEFsbGRyb3Bkb3duSXRlbXMoKVxuXHRcdHRoaXMuc2VsZWN0aW9uSW5kZXg9KHN1Z2dlc3Rvci5zZWxlY3Rpb25JbmRleCArbnVtYmVyICsgaXRlbXMubGVuZ3RoKSAlIGl0ZW1zLmxlbmd0aFxuXHRcdHRoaXMudXBkYXRlU2VsZWN0aW9uKGl0ZW1zKVxuXHR9XG5cblx0dXBkYXRlUG9zaXRpb25Gcm9tVmlldyh2aWV3OiBFZGl0b3JWaWV3KTogYm9vbGVhbntcblx0XHRjb25zdCBjb29yZHM9dmlldy5jb29yZHNBdFBvcyh2aWV3LnN0YXRlLnNlbGVjdGlvbi5tYWluLmhlYWQpXG5cdFx0aWYgKCFjb29yZHMpIHJldHVybiBmYWxzZTtcblx0XHR0aGlzLnVwZGF0ZVBvc2l0aW9uKGNvb3Jkcy5sZWZ0LGNvb3Jkcy5ib3R0b20pXG5cdFx0cmV0dXJuIHRydWU7XG5cdH1cblx0XG5cdFxuXHRjcmVhdGVDb250YWluZXJFbCgpe1xuXHRcdGNvbnN0IHN1Z2dlc3Rpb25zPXRoaXMudHJpZ2dlci5nZXRTdWdnZXN0aW9ucygpXG5cdFx0aWYoc3VnZ2VzdGlvbnMubGVuZ3RoPDEpcmV0dXJuO1xuXHRcdHRoaXMuY29udGFpbmVyRWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuXHRcdHRoaXMuY29udGFpbmVyRWwuYWRkQ2xhc3MoXCJzdWdnZXN0aW9uLWRyb3Bkb3duXCIpXG5cblx0XHRzdWdnZXN0aW9ucy5mb3JFYWNoKChzdWdnZXN0aW9uKSA9PiB7XG5cdFx0XHR0aGlzLnJlbmRlclN1Z2dlc3Rpb24oc3VnZ2VzdGlvbik7XG5cdFx0fSk7XG5cdH1cblxuXHRyZW5kZXJTdWdnZXN0aW9uKHN1Z2dlc3Rpb246IHN0cmluZyl7XG5cdFx0dGhpcy5jb250YWluZXJFbC5hcHBlbmRDaGlsZChcblx0XHRcdE9iamVjdC5hc3NpZ24oZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKSwge1xuXHRcdFx0XHRjbGFzc05hbWU6IFwic3VnZ2VzdGlvbi1pdGVtXCIsXG5cdFx0XHRcdGlubmVyVGV4dDogc3VnZ2VzdGlvblxuXHRcdFx0fSlcblx0XHQpO1xuXHR9XG5cblx0dXBkYXRlUG9zaXRpb24obGVmdDogbnVtYmVyLHRvcDogbnVtYmVyKXtcblx0XHRpZiAoIXRoaXMuY29udGFpbmVyRWwpIHJldHVybiBmYWxzZTtcblx0XHRPYmplY3QuYXNzaWduKHRoaXMuY29udGFpbmVyRWwuc3R5bGUse1xuXHRcdFx0cG9zaXRpb246IFwiYWJzb2x1dGVcIixcblx0XHRcdGxlZnQ6IGAke2xlZnR9cHhgLFxuXHRcdFx0dG9wOiBgJHt0b3B9cHhgLFxuXHRcdH0pO1xuXHRcdHJldHVybiB0cnVlO1xuXHR9XG5cblx0Z2V0QWxsZHJvcGRvd25JdGVtcygpe3JldHVybiBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3VnZ2VzdGlvbi1pdGVtXCIpfVxuXHRwcml2YXRlIGdldERyb3Bkb3duKCl7cmV0dXJuIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcihcIi5zdWdnZXN0aW9uLWRyb3Bkb3duXCIpfVxuXG5cdGhhbmRsZURyb3Bkb3duTmF2aWdhdGlvbihldmVudDogS2V5Ym9hcmRFdmVudCx2aWV3OkVkaXRvclZpZXcpIHtcblx0XHRjb25zdCBkcm9wZG93biA9IHRoaXMuZ2V0RHJvcGRvd24oKTtcblx0XHRpZiAoIWRyb3Bkb3duKSByZXR1cm47XG5cdFxuXHRcdGNvbnN0IGl0ZW1zID0gdGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKCk7XG5cblx0XHRpZiAoaXRlbXMubGVuZ3RoID09PSAwKSByZXR1cm47XG5cdFx0c3dpdGNoICh0cnVlKSB7XG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd0Rvd25cIjpcblx0XHRcdFx0dGhpcy5tb3ZlU2VsZWN0aW9uSW5kZXgoMSlcblx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd1VwXCI6XG5cdFx0XHRcdHRoaXMubW92ZVNlbGVjdGlvbkluZGV4KC0xKVxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgZXZlbnQua2V5ID09PSBcIkFycm93TGVmdFwifHxldmVudC5rZXkgPT09IFwiQXJyb3dSaWdodFwiOlxuXHRcdFx0XHRzdWdnZXN0b3IuY2xvc2UoKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJCYWNrc3BhY2VcIjpcblx0XHRcdFx0c3VnZ2VzdG9yLmNsb3NlKCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiRW50ZXJcIjpcblx0XHRcdFx0c3VnZ2VzdG9yLnNlbGVjdERyb3Bkb3duSXRlbSh2aWV3KTtcblx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIjpcblx0XHRcdFx0c3VnZ2VzdG9yLmNsb3NlKCk7XG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0ZGVmYXVsdDpcblx0XHRcdFx0cmV0dXJuIGZhbHNlO1xuXHRcdH1cblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdHVwZGF0ZVNlbGVjdGlvbihpdGVtczogTm9kZUxpc3RPZjxFbGVtZW50Pj10aGlzLmdldEFsbGRyb3Bkb3duSXRlbXMoKSkge1xuXHRcdGl0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7XG5cdFx0XHRpZiAoaW5kZXggPT09IHRoaXMuc2VsZWN0aW9uSW5kZXgpIHtcblx0XHRcdFx0aXRlbS5jbGFzc0xpc3QuYWRkKFwic2VsZWN0ZWRcIik7XG5cdFx0XHRcdGl0ZW0uc2Nyb2xsSW50b1ZpZXcoeyBibG9jazogXCJuZWFyZXN0XCIgfSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpdGVtLmNsYXNzTGlzdC5yZW1vdmUoXCJzZWxlY3RlZFwiKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdHNlbGVjdERyb3Bkb3duSXRlbSh2aWV3OiBFZGl0b3JWaWV3LGl0ZW06IEVsZW1lbnQ9dGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKClbdGhpcy5zZWxlY3Rpb25JbmRleF0pIHtcblx0XHR0aGlzLmNsb3NlKClcblx0XHRpZighdGhpcy5jb250ZXh0KXJldHVybjtcblxuXHRcdGNvbnN0IHRyaWdnZXI9dGhpcy50cmlnZ2VyLmdldFRleHQoKVxuXG5cdFx0Y29uc3Qgc2VsZWN0ZWRUZXh0ID0gaXRlbS50ZXh0Q29udGVudCB8fCBcIlwiO1xuXHRcdGNvbnN0IHBvcz10aGlzLmNvbnRleHQucG9zO1xuXHRcdHF1ZXVlU25pcHBldCh2aWV3LHBvcy10cmlnZ2VyLmxlbmd0aCxwb3Msc2VsZWN0ZWRUZXh0KVxuXHRcdGNvbnN0IHN1Y2Nlc3MgPSBleHBhbmRTbmlwcGV0cyh2aWV3KTtcblx0XHR2aWV3LmZvY3VzKCk7XG5cdFx0c2V0Q3Vyc29yKHZpZXcsY2FsY3VsYXRlTmV3Q3Vyc29yUG9zaXRpb24odHJpZ2dlcixzZWxlY3RlZFRleHQscG9zKSlcblx0XHRyZXR1cm4gc3VjY2Vzcztcblx0fVxufVxuXG5cbmZ1bmN0aW9uIGNhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uKHRyaWdnZXJUZXh0OiBzdHJpbmcsIHNlbGVjdGVkVGV4dDogc3RyaW5nLCBvcmlnaW5hbFBvczogbnVtYmVyKTogbnVtYmVyIHtcblx0Y29uc29sZS5sb2coJ2NhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uJyx0cmlnZ2VyVGV4dCxzZWxlY3RlZFRleHQsb3JpZ2luYWxQb3MpXG4gICAgY29uc3QgbGVuZ3RoRGlmZmVyZW5jZSA9IHNlbGVjdGVkVGV4dC5sZW5ndGggLSB0cmlnZ2VyVGV4dC5sZW5ndGg7XG4gICAgcmV0dXJuIG9yaWdpbmFsUG9zICsgbGVuZ3RoRGlmZmVyZW5jZTtcbn1cblxuZXhwb3J0IGNvbnN0IHN1Z2dlc3RvciA9IG5ldyBTdWdnZXN0b3IoKTsiXX0=