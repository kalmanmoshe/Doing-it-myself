import { getTikzSuggestions, } from "./utilities";
import { EditorView, } from "@codemirror/view";
import { expandSnippets } from "./snippets/snippet_management";
import { queueSnippet } from "./snippets/codemirror/snippet_queue_state_field";
class SuggestorTrigger {
    text;
    codeBlockText;
    constructor(ctx, view) {
        this.text = this.getCurrentLineText(ctx.pos, view);
        const source = this.getCodeBlockText(ctx, view);
        if (!source)
            return;
        //const tokens=new BasicTikzTokens(source)
        //console.log(tokens)
    }
    setTrigger(trigger) {
    }
    getCurrentLineText(pos, view) {
        const line = view.state.doc.lineAt(pos);
        //const cursorOffsetInLine = (pos+2) - line.from;I don't know why I had this here
        const textUpToCursor = line.text.slice(0, pos - line.from).trim();
        const words = textUpToCursor.split(/([\s,\[\](){};]|--\+\+|--\+|--)+/);
        const word = words[words.length - 1] || '';
        console.log(word);
        /* Checks that need to be made
        1. In what command are we in if any.
        2. Are we inputting a Variable a coordinate or formatting.
        3. if Formatting Are we starting to type a command or are we inputting a value to a command
        */
        return words[words.length - 1] || "";
    }
    getCodeBlockText(ctx, view) {
        const doc = view.state.doc;
        const { number } = doc.lineAt(ctx.pos);
        const beforeLine = findLine(view.state, number, -1, '```');
        const afterLine = findLine(view.state, number, 1, '```');
        ;
        if (!beforeLine || !afterLine)
            return null;
        const betweenText = doc.sliceString(beforeLine.to, afterLine.from).trim();
        const relativePos = ctx.pos - beforeLine.to;
        return betweenText;
    }
}
const findLine = (state, lineNumber, dir, startsWith) => {
    const { doc } = state;
    for (let i = lineNumber + dir; i > 0 && i <= doc.lines; i += dir) {
        const line = doc.line(i).text.trim();
        if (line.startsWith(startsWith))
            return doc.line(i);
    }
    return null;
};
export class Suggestor {
    trigger;
    selectionIndex;
    context;
    isSuggesterDeployed = false;
    deploySuggestor(context, view) {
        console.log("sjdsjd");
        this.removeSuggestor();
        this.context = context;
        const suggestions = this.getSuggestions(view);
        if (suggestions.length < 1)
            return;
        const suggestionDropdown = createFloatingSuggestionDropdown(suggestions, view, this.context.pos);
        if (!suggestionDropdown)
            return;
        document.body.appendChild(suggestionDropdown);
        this.isSuggesterDeployed = true;
        this.selectionIndex = 0;
        this.updateSelection(this.getAlldropdownItems());
    }
    updateSuggestorPosition() {
    }
    removeSuggestor() {
        document.body.querySelectorAll(".suggestion-item").forEach(node => node.remove());
        document.body.querySelector(".suggestion-dropdown")?.remove();
        this.isSuggesterDeployed = false;
    }
    getAlldropdownItems() { return document.body.querySelectorAll(".suggestion-item"); }
    dropdownifAnyDeployed() { return document.body.querySelector(".suggestion-dropdown"); }
    handleDropdownNavigation(event, view) {
        const dropdown = this.dropdownifAnyDeployed();
        if (!dropdown || this.selectionIndex === undefined)
            return;
        const items = this.getAlldropdownItems();
        if (items.length === 0)
            return;
    }
    getSuggestions(view) {
        this.trigger = new SuggestorTrigger(this.context, view);
        const allSuggestions = getTikzSuggestions().map(s => s.trigger || s.replacement);
        const filteredSuggestions = allSuggestions.filter((suggestion) => suggestion.toLowerCase().startsWith(this.trigger.text.toLowerCase()));
        const sortedSuggestions = filteredSuggestions.sort((a, b) => {
            const lowerLastWord = this.trigger.text.toLowerCase();
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
            const aExactMatch = aLower === lowerLastWord ? -1 : 0;
            const bExactMatch = bLower === lowerLastWord ? -1 : 0;
            if (aExactMatch !== bExactMatch)
                return aExactMatch - bExactMatch;
            if (a.length !== b.length)
                return a.length - b.length;
            return aLower.localeCompare(bLower);
        });
        return sortedSuggestions;
    }
    updateSelection(items) {
        items.forEach((item, index) => {
            if (index === this.selectionIndex) {
                item.classList.add("selected");
                item.scrollIntoView({ block: "nearest" });
            }
            else {
                item.classList.remove("selected");
            }
        });
    }
    selectDropdownItem(item, view) {
        this.removeSuggestor();
        if (!this.context)
            return;
        const selectedText = item.textContent || "";
        const pos = this.context.pos;
        queueSnippet(view, pos - this.trigger.text.length, pos, selectedText);
        const success = expandSnippets(view);
        //view.focus();
        //setCursor(view,calculateNewCursorPosition(this.trigger.text,selectedText,pos))
        console.log(`Selected: ${selectedText}`);
    }
}
function calculateNewCursorPosition(triggerText, selectedText, originalPos) {
    const lengthDifference = selectedText.length - triggerText.length;
    return originalPos + lengthDifference;
}
function createFloatingSuggestionDropdown(suggestions, editorView, position) {
    const coordinates = editorView.coordsAtPos(position);
    if (!coordinates)
        return;
    const suggestionDropdown = createSuggestionDropdown(suggestions);
    suggestionDropdown.style.position = "absolute";
    suggestionDropdown.style.left = `${coordinates.left}px`;
    suggestionDropdown.style.top = `${coordinates.bottom}px`;
    return suggestionDropdown;
}
function createSuggestionDropdown(suggestions) {
    const dropdownContainer = document.createElement("div");
    dropdownContainer.className = "suggestion-dropdown";
    suggestions.forEach((suggestion) => {
        const item = createSuggestionItem(suggestion);
        dropdownContainer.appendChild(item);
    });
    return dropdownContainer;
}
function createSuggestionItem(displayText) {
    // Create the outer suggestion item container
    const container = document.createElement("div");
    container.classList.add("suggestion-item");
    container.innerText = displayText;
    return container;
    // Create the icon container
    const icon = document.createElement("div");
    icon.classList.add("icon");
    icon.textContent = "Æ’"; // Placeholder icon content
    // Create the details container
    const details = document.createElement("div");
    details.classList.add("details");
    // Add a name span to details
    const name = document.createElement("span");
    name.classList.add("name");
    name.textContent = "function"; // Placeholder name content
    // Add a type span to details
    const type = document.createElement("span");
    type.classList.add("type");
    type.textContent = "Keyword"; // Placeholder type content
    // Append name and type to details
    details.appendChild(name);
    details.appendChild(type);
    // Append icon and details to the container
    container.appendChild(icon);
    container.appendChild(details);
    return container;
}
export function getCharacterAtPos(viewOrState, pos) {
    const state = viewOrState instanceof EditorView ? viewOrState.state : viewOrState;
    const doc = state.doc;
    return doc.slice(pos, pos + 1).toString();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N1Z2dlc3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEdBQUksTUFBTSxhQUFhLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsR0FBRyxNQUFNLGtCQUFrQixDQUFDO0FBTy9DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saURBQWlELENBQUM7QUFHL0UsTUFBTSxnQkFBZ0I7SUFDckIsSUFBSSxDQUFRO0lBQ1osYUFBYSxDQUFTO0lBQ3RCLFlBQVksR0FBWSxFQUFFLElBQWdCO1FBQ3pDLElBQUksQ0FBQyxJQUFJLEdBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDaEQsTUFBTSxNQUFNLEdBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBQyxJQUFJLENBQUMsQ0FBQTtRQUM1QyxJQUFHLENBQUMsTUFBTTtZQUFDLE9BQU07UUFDakIsMENBQTBDO1FBQzFDLHFCQUFxQjtJQUN0QixDQUFDO0lBQ0QsVUFBVSxDQUFDLE9BQWU7SUFFMUIsQ0FBQztJQUNELGtCQUFrQixDQUFDLEdBQVcsRUFBRSxJQUFnQjtRQUMvQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEMsaUZBQWlGO1FBQ2pGLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLEdBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2pFLE1BQU0sS0FBSyxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztR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LENBQUMsQ0FBQztJQUUvQixPQUFPLFNBQVMsQ0FBQztBQUNsQixDQUFDO0FBUUQsTUFBTSxVQUFVLGlCQUFpQixDQUFDLFdBQXFDLEVBQUUsR0FBVztJQUNuRixNQUFNLEtBQUssR0FBRyxXQUFXLFlBQVksVUFBVSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUM7SUFDbEYsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztJQUN0QixPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsR0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUN6QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0VGlrelN1Z2dlc3Rpb25zLCAgfSBmcm9tIFwiLi91dGlsaXRpZXNcIjtcbmltcG9ydCB7IEVkaXRvclZpZXcsIH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcbmltcG9ydCB7IHN5bnRheFRyZWUgfSBmcm9tIFwiQGNvZGVtaXJyb3IvbGFuZ3VhZ2VcIjtcbmltcG9ydCB7IEVkaXRvclN0YXRlfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcbmltcG9ydCB7IFN5bnRheE5vZGUsIFRyZWVDdXJzb3IgfSBmcm9tIFwiQGxlemVyL2NvbW1vblwiO1xuaW1wb3J0IE1vc2hlIGZyb20gXCIuL21haW5cIjtcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XG5pbXBvcnQgeyByZXBsYWNlUmFuZ2UsIHNldEN1cnNvciB9IGZyb20gXCIuL2VkaXRvciB1dGlsaXRpZXMvZWRpdG9yX3V0aWxzXCI7XG5pbXBvcnQgeyBleHBhbmRTbmlwcGV0cyB9IGZyb20gXCIuL3NuaXBwZXRzL3NuaXBwZXRfbWFuYWdlbWVudFwiO1xuaW1wb3J0IHsgcXVldWVTbmlwcGV0IH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XG5cblxuY2xhc3MgU3VnZ2VzdG9yVHJpZ2dlcntcblx0dGV4dDogc3RyaW5nXG5cdGNvZGVCbG9ja1RleHQ6IHN0cmluZztcblx0Y29uc3RydWN0b3IoY3R4OiBDb250ZXh0LCB2aWV3OiBFZGl0b3JWaWV3KXtcblx0XHR0aGlzLnRleHQ9dGhpcy5nZXRDdXJyZW50TGluZVRleHQoY3R4LnBvcywgdmlldylcblx0XHRjb25zdCBzb3VyY2U9dGhpcy5nZXRDb2RlQmxvY2tUZXh0KGN0eCx2aWV3KVxuXHRcdGlmKCFzb3VyY2UpcmV0dXJuXG5cdFx0Ly9jb25zdCB0b2tlbnM9bmV3IEJhc2ljVGlrelRva2Vucyhzb3VyY2UpXG5cdFx0Ly9jb25zb2xlLmxvZyh0b2tlbnMpXG5cdH1cblx0c2V0VHJpZ2dlcih0cmlnZ2VyOiBzdHJpbmcpe1xuXG5cdH1cblx0Z2V0Q3VycmVudExpbmVUZXh0KHBvczogbnVtYmVyLCB2aWV3OiBFZGl0b3JWaWV3KTogc3RyaW5nIHtcblx0XHRjb25zdCBsaW5lID0gdmlldy5zdGF0ZS5kb2MubGluZUF0KHBvcyk7XG5cdFx0Ly9jb25zdCBjdXJzb3JPZmZzZXRJbkxpbmUgPSAocG9zKzIpIC0gbGluZS5mcm9tO0kgZG9uJ3Qga25vdyB3aHkgSSBoYWQgdGhpcyBoZXJlXG5cdFx0Y29uc3QgdGV4dFVwVG9DdXJzb3IgPSBsaW5lLnRleHQuc2xpY2UoMCwgcG9zLSBsaW5lLmZyb20pLnRyaW0oKTtcblx0XHRjb25zdCB3b3JkcyA9IHRleHRVcFRvQ3Vyc29yLnNwbGl0KC8oW1xccyxcXFtcXF0oKXt9O118LS1cXCtcXCt8LS1cXCt8LS0pKy8pO1xuXHRcdGNvbnN0IHdvcmQ9d29yZHNbd29yZHMubGVuZ3RoIC0gMV18fCcnO1xuXHRcdGNvbnNvbGUubG9nKHdvcmQpXG5cdFx0LyogQ2hlY2tzIHRoYXQgbmVlZCB0byBiZSBtYWRlXG5cdFx0MS4gSW4gd2hhdCBjb21tYW5kIGFyZSB3ZSBpbiBpZiBhbnkuXG5cdFx0Mi4gQXJlIHdlIGlucHV0dGluZyBhIFZhcmlhYmxlIGEgY29vcmRpbmF0ZSBvciBmb3JtYXR0aW5nLlxuXHRcdDMuIGlmIEZvcm1hdHRpbmcgQXJlIHdlIHN0YXJ0aW5nIHRvIHR5cGUgYSBjb21tYW5kIG9yIGFyZSB3ZSBpbnB1dHRpbmcgYSB2YWx1ZSB0byBhIGNvbW1hbmRcblx0XHQqL1xuXHRcdHJldHVybiB3b3Jkc1t3b3Jkcy5sZW5ndGggLSAxXSB8fCBcIlwiO1xuXHR9XG5cdGdldENvZGVCbG9ja1RleHQoY3R4OiBDb250ZXh0LHZpZXc6IEVkaXRvclZpZXcpe1xuXHRcdGNvbnN0IGRvYyA9IHZpZXcuc3RhdGUuZG9jO1xuXHRcdGNvbnN0IHsgbnVtYmVyIH0gPSBkb2MubGluZUF0KGN0eC5wb3MpO1xuXG5cdFx0Y29uc3QgYmVmb3JlTGluZSA9IGZpbmRMaW5lKHZpZXcuc3RhdGUsbnVtYmVyLC0xLCdgYGAnKTtcblx0XHRjb25zdCBhZnRlckxpbmUgPSAgZmluZExpbmUodmlldy5zdGF0ZSxudW1iZXIsMSwnYGBgJyk7O1xuXHRcdGlmICghYmVmb3JlTGluZSB8fCAhYWZ0ZXJMaW5lKSByZXR1cm4gbnVsbDtcblx0XHRjb25zdCBiZXR3ZWVuVGV4dCA9IGRvYy5zbGljZVN0cmluZyhiZWZvcmVMaW5lLnRvLCBhZnRlckxpbmUuZnJvbSkudHJpbSgpO1xuXHRcdGNvbnN0IHJlbGF0aXZlUG9zID0gY3R4LnBvcyAtIGJlZm9yZUxpbmUudG87XG5cdFx0cmV0dXJuIGJldHdlZW5UZXh0XG5cdH1cbn1cblxuY29uc3QgZmluZExpbmUgPSAoc3RhdGU6IEVkaXRvclN0YXRlLCBsaW5lTnVtYmVyOiBudW1iZXIsZGlyOiBudW1iZXIsIHN0YXJ0c1dpdGg6IHN0cmluZykgPT4ge1xuXHRjb25zdCB7ZG9jfT1zdGF0ZVxuXHRmb3IgKGxldCBpID0gbGluZU51bWJlciArIGRpcjsgaSA+IDAgJiYgaSA8PSBkb2MubGluZXM7IGkgKz0gZGlyKSB7XG5cdGNvbnN0IGxpbmUgPSBkb2MubGluZShpKS50ZXh0LnRyaW0oKTtcblx0aWYgKGxpbmUuc3RhcnRzV2l0aChzdGFydHNXaXRoKSkgcmV0dXJuIGRvYy5saW5lKGkpO1xuXHR9XG5cdHJldHVybiBudWxsO1xufTtcblxuZXhwb3J0IGNsYXNzIFN1Z2dlc3RvciB7XG5cdHByaXZhdGUgdHJpZ2dlcjogU3VnZ2VzdG9yVHJpZ2dlcjtcblx0c2VsZWN0aW9uSW5kZXg6IG51bWJlcjtcblx0cHJpdmF0ZSBjb250ZXh0OiBDb250ZXh0O1xuXHRpc1N1Z2dlc3RlckRlcGxveWVkOiBib29sZWFuPWZhbHNlO1xuXG5cdGRlcGxveVN1Z2dlc3Rvcihjb250ZXh0OiBDb250ZXh0LHZpZXc6IEVkaXRvclZpZXcpe1xuXHRcdGNvbnNvbGUubG9nKFwic2pkc2pkXCIpXG5cdFx0dGhpcy5yZW1vdmVTdWdnZXN0b3IoKVxuXHRcdHRoaXMuY29udGV4dD1jb250ZXh0O1xuXHRcdGNvbnN0IHN1Z2dlc3Rpb25zPXRoaXMuZ2V0U3VnZ2VzdGlvbnModmlldylcblx0XHRpZihzdWdnZXN0aW9ucy5sZW5ndGg8MSlyZXR1cm47XG5cblx0XHRjb25zdCBzdWdnZXN0aW9uRHJvcGRvd24gPSBjcmVhdGVGbG9hdGluZ1N1Z2dlc3Rpb25Ecm9wZG93bihzdWdnZXN0aW9ucyx2aWV3LCB0aGlzLmNvbnRleHQucG9zKTtcblx0XHRpZiAoIXN1Z2dlc3Rpb25Ecm9wZG93bikgcmV0dXJuO1xuXHRcdGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQoc3VnZ2VzdGlvbkRyb3Bkb3duKTtcblx0XHR0aGlzLmlzU3VnZ2VzdGVyRGVwbG95ZWQ9dHJ1ZTtcblx0XHR0aGlzLnNlbGVjdGlvbkluZGV4PTA7XG5cdFx0dGhpcy51cGRhdGVTZWxlY3Rpb24odGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKCkpO1xuXG5cdH1cblx0dXBkYXRlU3VnZ2VzdG9yUG9zaXRpb24oKXtcblxuXHR9XG5cblx0cmVtb3ZlU3VnZ2VzdG9yKCkge1xuXHRcdGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIikuZm9yRWFjaChub2RlID0+IG5vZGUucmVtb3ZlKCkpO1xuXHRcdGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcihcIi5zdWdnZXN0aW9uLWRyb3Bkb3duXCIpPy5yZW1vdmUoKVxuXHRcdHRoaXMuaXNTdWdnZXN0ZXJEZXBsb3llZD1mYWxzZTtcblx0fVxuXG5cdGdldEFsbGRyb3Bkb3duSXRlbXMoKXtyZXR1cm4gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yQWxsKFwiLnN1Z2dlc3Rpb24taXRlbVwiKX1cblx0cHJpdmF0ZSBkcm9wZG93bmlmQW55RGVwbG95ZWQoKXtyZXR1cm4gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIil9XG5cblx0cHJpdmF0ZSBoYW5kbGVEcm9wZG93bk5hdmlnYXRpb24oZXZlbnQ6IEtleWJvYXJkRXZlbnQsdmlldzpFZGl0b3JWaWV3KSB7XG5cdFx0Y29uc3QgZHJvcGRvd24gPSB0aGlzLmRyb3Bkb3duaWZBbnlEZXBsb3llZCgpO1xuXHRcdGlmICghZHJvcGRvd24gfHwgdGhpcy5zZWxlY3Rpb25JbmRleCA9PT0gdW5kZWZpbmVkKSByZXR1cm47XG5cdFxuXHRcdGNvbnN0IGl0ZW1zID0gdGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKCk7XG5cblx0XHRpZiAoaXRlbXMubGVuZ3RoID09PSAwKSByZXR1cm47XG5cdFx0XG5cdH1cblxuXHRwcml2YXRlIGdldFN1Z2dlc3Rpb25zKHZpZXc6IEVkaXRvclZpZXcpIHtcblx0XHR0aGlzLnRyaWdnZXI9bmV3IFN1Z2dlc3RvclRyaWdnZXIodGhpcy5jb250ZXh0LCB2aWV3KVxuXHRcdGNvbnN0IGFsbFN1Z2dlc3Rpb25zID0gZ2V0VGlrelN1Z2dlc3Rpb25zKCkubWFwKHMgPT4gcy50cmlnZ2VyfHxzLnJlcGxhY2VtZW50KTtcblx0XG5cdFx0Y29uc3QgZmlsdGVyZWRTdWdnZXN0aW9ucyA9IGFsbFN1Z2dlc3Rpb25zLmZpbHRlcigoc3VnZ2VzdGlvbikgPT5cblx0XHRcdHN1Z2dlc3Rpb24udG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKHRoaXMudHJpZ2dlci50ZXh0LnRvTG93ZXJDYXNlKCkpXG5cdFx0KTtcblx0XG5cdFx0Y29uc3Qgc29ydGVkU3VnZ2VzdGlvbnMgPSBmaWx0ZXJlZFN1Z2dlc3Rpb25zLnNvcnQoKGEsIGIpID0+IHtcblx0XHRcdGNvbnN0IGxvd2VyTGFzdFdvcmQgPSB0aGlzLnRyaWdnZXIudGV4dC50b0xvd2VyQ2FzZSgpO1xuXHRcdFx0Y29uc3QgYUxvd2VyID0gYS50b0xvd2VyQ2FzZSgpO1xuXHRcdFx0Y29uc3QgYkxvd2VyID0gYi50b0xvd2VyQ2FzZSgpO1xuXHRcblxuXHRcdFx0Y29uc3QgYUV4YWN0TWF0Y2ggPSBhTG93ZXIgPT09IGxvd2VyTGFzdFdvcmQgPyAtMSA6IDA7XG5cdFx0XHRjb25zdCBiRXhhY3RNYXRjaCA9IGJMb3dlciA9PT0gbG93ZXJMYXN0V29yZCA/IC0xIDogMDtcblx0XHRcdGlmIChhRXhhY3RNYXRjaCAhPT0gYkV4YWN0TWF0Y2gpIHJldHVybiBhRXhhY3RNYXRjaCAtIGJFeGFjdE1hdGNoO1xuXHRcblx0XHRcdGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBhLmxlbmd0aCAtIGIubGVuZ3RoO1xuXHRcblx0XHRcdHJldHVybiBhTG93ZXIubG9jYWxlQ29tcGFyZShiTG93ZXIpO1xuXHRcdH0pO1xuXHRcdHJldHVybiBzb3J0ZWRTdWdnZXN0aW9ucztcblx0fVxuXG5cdFxuXG5cdHVwZGF0ZVNlbGVjdGlvbihpdGVtczogTm9kZUxpc3RPZjxFbGVtZW50Pikge1xuXHRcdGl0ZW1zLmZvckVhY2goKGl0ZW0sIGluZGV4KSA9PiB7XG5cdFx0XHRpZiAoaW5kZXggPT09IHRoaXMuc2VsZWN0aW9uSW5kZXgpIHtcblx0XHRcdFx0aXRlbS5jbGFzc0xpc3QuYWRkKFwic2VsZWN0ZWRcIik7XG5cdFx0XHRcdGl0ZW0uc2Nyb2xsSW50b1ZpZXcoeyBibG9jazogXCJuZWFyZXN0XCIgfSk7XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRpdGVtLmNsYXNzTGlzdC5yZW1vdmUoXCJzZWxlY3RlZFwiKTtcblx0XHRcdH1cblx0XHR9KTtcblx0fVxuXG5cdHNlbGVjdERyb3Bkb3duSXRlbShpdGVtOiBFbGVtZW50LHZpZXc6IEVkaXRvclZpZXcpIHtcblx0XHR0aGlzLnJlbW92ZVN1Z2dlc3RvcigpXG5cdFx0aWYoIXRoaXMuY29udGV4dClyZXR1cm4gO1xuXHRcdGNvbnN0IHNlbGVjdGVkVGV4dCA9IGl0ZW0udGV4dENvbnRlbnQgfHwgXCJcIjtcblx0XHRjb25zdCBwb3M9dGhpcy5jb250ZXh0LnBvcztcblx0XHRxdWV1ZVNuaXBwZXQodmlldyxwb3MtdGhpcy50cmlnZ2VyLnRleHQubGVuZ3RoLHBvcyxzZWxlY3RlZFRleHQpXG5cdFx0Y29uc3Qgc3VjY2VzcyA9IGV4cGFuZFNuaXBwZXRzKHZpZXcpO1xuXHRcdC8vdmlldy5mb2N1cygpO1xuXHRcdC8vc2V0Q3Vyc29yKHZpZXcsY2FsY3VsYXRlTmV3Q3Vyc29yUG9zaXRpb24odGhpcy50cmlnZ2VyLnRleHQsc2VsZWN0ZWRUZXh0LHBvcykpXG5cdFx0Y29uc29sZS5sb2coYFNlbGVjdGVkOiAke3NlbGVjdGVkVGV4dH1gKTtcblx0fVxufVxuZnVuY3Rpb24gY2FsY3VsYXRlTmV3Q3Vyc29yUG9zaXRpb24odHJpZ2dlclRleHQ6IHN0cmluZywgc2VsZWN0ZWRUZXh0OiBzdHJpbmcsIG9yaWdpbmFsUG9zOiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IGxlbmd0aERpZmZlcmVuY2UgPSBzZWxlY3RlZFRleHQubGVuZ3RoIC0gdHJpZ2dlclRleHQubGVuZ3RoO1xuICAgIHJldHVybiBvcmlnaW5hbFBvcyArIGxlbmd0aERpZmZlcmVuY2U7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUZsb2F0aW5nU3VnZ2VzdGlvbkRyb3Bkb3duKHN1Z2dlc3Rpb25zOiBhbnlbXSxlZGl0b3JWaWV3OiBFZGl0b3JWaWV3LCBwb3NpdGlvbjogbnVtYmVyKSB7XG5cbiAgICBjb25zdCBjb29yZGluYXRlcyA9IGVkaXRvclZpZXcuY29vcmRzQXRQb3MocG9zaXRpb24pO1xuICAgIGlmICghY29vcmRpbmF0ZXMpIHJldHVybjtcblxuICAgIGNvbnN0IHN1Z2dlc3Rpb25Ecm9wZG93biA9IGNyZWF0ZVN1Z2dlc3Rpb25Ecm9wZG93bihzdWdnZXN0aW9ucyk7XG5cbiAgICBzdWdnZXN0aW9uRHJvcGRvd24uc3R5bGUucG9zaXRpb24gPSBcImFic29sdXRlXCI7XG4gICAgc3VnZ2VzdGlvbkRyb3Bkb3duLnN0eWxlLmxlZnQgPSBgJHtjb29yZGluYXRlcy5sZWZ0fXB4YDtcbiAgICBzdWdnZXN0aW9uRHJvcGRvd24uc3R5bGUudG9wID0gYCR7Y29vcmRpbmF0ZXMuYm90dG9tfXB4YDtcblx0cmV0dXJuIHN1Z2dlc3Rpb25Ecm9wZG93bjtcbn1cblxuXG5mdW5jdGlvbiBjcmVhdGVTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnM6IHN0cmluZ1tdKSB7XG4gICAgY29uc3QgZHJvcGRvd25Db250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuICAgIGRyb3Bkb3duQ29udGFpbmVyLmNsYXNzTmFtZSA9IFwic3VnZ2VzdGlvbi1kcm9wZG93blwiO1xuXG4gICAgc3VnZ2VzdGlvbnMuZm9yRWFjaCgoc3VnZ2VzdGlvbikgPT4ge1xuICAgICAgICBjb25zdCBpdGVtID0gY3JlYXRlU3VnZ2VzdGlvbkl0ZW0oc3VnZ2VzdGlvbilcblx0XHRkcm9wZG93bkNvbnRhaW5lci5hcHBlbmRDaGlsZChpdGVtKVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGRyb3Bkb3duQ29udGFpbmVyO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVTdWdnZXN0aW9uSXRlbShkaXNwbGF5VGV4dDogc3RyaW5nKTogSFRNTEVsZW1lbnQge1xuXHQvLyBDcmVhdGUgdGhlIG91dGVyIHN1Z2dlc3Rpb24gaXRlbSBjb250YWluZXJcblx0Y29uc3QgY29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcblx0Y29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJzdWdnZXN0aW9uLWl0ZW1cIik7XG5cdGNvbnRhaW5lci5pbm5lclRleHQ9ZGlzcGxheVRleHRcbiAgXHRyZXR1cm4gY29udGFpbmVyXG5cdC8vIENyZWF0ZSB0aGUgaWNvbiBjb250YWluZXJcblx0Y29uc3QgaWNvbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG5cdGljb24uY2xhc3NMaXN0LmFkZChcImljb25cIik7XG5cdGljb24udGV4dENvbnRlbnQgPSBcIsaSXCI7IC8vIFBsYWNlaG9sZGVyIGljb24gY29udGVudFxuICBcblx0Ly8gQ3JlYXRlIHRoZSBkZXRhaWxzIGNvbnRhaW5lclxuXHRjb25zdCBkZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcblx0ZGV0YWlscy5jbGFzc0xpc3QuYWRkKFwiZGV0YWlsc1wiKTtcbiAgXG5cdC8vIEFkZCBhIG5hbWUgc3BhbiB0byBkZXRhaWxzXG5cdGNvbnN0IG5hbWUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwic3BhblwiKTtcblx0bmFtZS5jbGFzc0xpc3QuYWRkKFwibmFtZVwiKTtcblx0bmFtZS50ZXh0Q29udGVudCA9IFwiZnVuY3Rpb25cIjsgLy8gUGxhY2Vob2xkZXIgbmFtZSBjb250ZW50XG4gIFxuXHQvLyBBZGQgYSB0eXBlIHNwYW4gdG8gZGV0YWlsc1xuXHRjb25zdCB0eXBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XG5cdHR5cGUuY2xhc3NMaXN0LmFkZChcInR5cGVcIik7XG5cdHR5cGUudGV4dENvbnRlbnQgPSBcIktleXdvcmRcIjsgLy8gUGxhY2Vob2xkZXIgdHlwZSBjb250ZW50XG4gIFxuXHQvLyBBcHBlbmQgbmFtZSBhbmQgdHlwZSB0byBkZXRhaWxzXG5cdGRldGFpbHMuYXBwZW5kQ2hpbGQobmFtZSk7XG5cdGRldGFpbHMuYXBwZW5kQ2hpbGQodHlwZSk7XG4gIFxuXHQvLyBBcHBlbmQgaWNvbiBhbmQgZGV0YWlscyB0byB0aGUgY29udGFpbmVyXG5cdGNvbnRhaW5lci5hcHBlbmRDaGlsZChpY29uKTtcblx0Y29udGFpbmVyLmFwcGVuZENoaWxkKGRldGFpbHMpO1xuICBcblx0cmV0dXJuIGNvbnRhaW5lcjtcbn1cblxuXG5cblxuXG5cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENoYXJhY3RlckF0UG9zKHZpZXdPclN0YXRlOiBFZGl0b3JWaWV3IHwgRWRpdG9yU3RhdGUsIHBvczogbnVtYmVyKSB7XG5cdGNvbnN0IHN0YXRlID0gdmlld09yU3RhdGUgaW5zdGFuY2VvZiBFZGl0b3JWaWV3ID8gdmlld09yU3RhdGUuc3RhdGUgOiB2aWV3T3JTdGF0ZTtcblx0Y29uc3QgZG9jID0gc3RhdGUuZG9jO1xuXHRyZXR1cm4gZG9jLnNsaWNlKHBvcywgcG9zKzEpLnRvU3RyaW5nKCk7XG59XG5cbiJdfQ==