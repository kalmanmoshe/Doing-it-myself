import { getTikzSuggestions, } from "./utilities";
import { setCursor } from "./editor utilities/editor_utils";
import { expandSnippets } from "./snippets/snippet_management";
import { queueSnippet } from "./snippets/codemirror/snippet_queue_state_field";
class SuggestorTrigger {
    text;
    codeBlockText;
    constructor(ctx, view) {
        this.text = this.getCurrentLineText(ctx.pos, view);
        const source = this.getCodeBlockText(ctx, view);
        if (!source)
            return;
        //const tokens=new BasicTikzTokens(source)
        //console.log(tokens)
    }
    setTrigger(trigger) {
    }
    getCurrentLineText(pos, view) {
        const line = view.state.doc.lineAt(pos);
        //const cursorOffsetInLine = (pos+2) - line.from;I don't know why I had this here
        const textUpToCursor = line.text.slice(0, pos - line.from).trim();
        const words = textUpToCursor.split(/([\s,\[\](){};]|--\+\+|--\+|--)+/);
        const word = words[words.length - 1] || '';
        /* Checks that need to be made
        1. In what command are we in if any.
        2. Are we inputting a Variable a coordinate or formatting.
        3. if Formatting Are we starting to type a command or are we inputting a value to a command
        */
        return words[words.length - 1] || "";
    }
    getCodeBlockText(ctx, view) {
        const doc = view.state.doc;
        const s = doc.lineAt(ctx.pos);
        const bounds = ctx.getBounds();
        if (bounds === null)
            throw new Error("No bounds found");
        const betweenText = doc.sliceString(bounds.start, bounds.end).trim();
        return betweenText;
    }
}
class Suggestor {
    trigger;
    selectionIndex = 0;
    context;
    suggestions = [];
    containerEl;
    open(context, view) {
        // If the suggestor is already deployed, close it
        this.close();
        this.context = context;
        this.createContainerEl(view);
        this.updatePositionFromView(view);
        document.body.appendChild(this.containerEl);
        this.updateSelection();
    }
    close() {
        document.body.querySelectorAll(".suggestion-item").forEach(node => node.remove());
        document.body.querySelector(".suggestion-dropdown")?.remove();
    }
    isSuggesterDeployed() { return !!document.body.querySelector(".suggestion-dropdown"); }
    setSelectionIndex(number) {
        this.selectionIndex = number;
        this.updateSelection();
    }
    moveSelectionIndex(number) {
        const items = this.getAlldropdownItems();
        this.selectionIndex = (suggestor.selectionIndex + number + items.length) % items.length;
        this.updateSelection(items);
    }
    updatePositionFromView(view) {
        const coords = view.coordsAtPos(view.state.selection.main.head);
        if (!coords)
            return false;
        this.updatePosition(coords.left, coords.bottom);
        return true;
    }
    createContainerEl(view) {
        const suggestions = this.getSuggestions(view);
        if (suggestions.length < 1)
            return;
        this.containerEl = document.createElement("div");
        this.containerEl.addClass("suggestion-dropdown");
        suggestions.forEach((suggestion) => {
            this.renderSuggestion(suggestion);
        });
    }
    renderSuggestion(suggestion) {
        this.containerEl.appendChild(Object.assign(document.createElement("div"), {
            className: "suggestion-item",
            innerText: suggestion
        }));
    }
    updatePosition(left, top) {
        if (!this.containerEl)
            return false;
        Object.assign(this.containerEl.style, {
            position: "absolute",
            left: `${left}px`,
            top: `${top}px`,
        });
        return true;
    }
    getAlldropdownItems() { return document.body.querySelectorAll(".suggestion-item"); }
    getDropdown() { return document.body.querySelector(".suggestion-dropdown"); }
    handleDropdownNavigation(event, view) {
        const dropdown = this.getDropdown();
        if (!dropdown)
            return;
        const items = this.getAlldropdownItems();
        if (items.length === 0)
            return;
        switch (true) {
            case event.key === "ArrowDown":
                this.moveSelectionIndex(1);
                event.preventDefault();
                break;
            case event.key === "ArrowUp":
                this.moveSelectionIndex(-1);
                event.preventDefault();
                break;
            case event.key === "ArrowLeft" || event.key === "ArrowRight":
                suggestor.close();
                break;
            case event.key === "Backspace":
                suggestor.close();
                break;
            case event.key === "Enter":
                suggestor.selectDropdownItem(view);
                event.preventDefault();
                break;
            case event.key === "Escape":
                suggestor.close();
                event.preventDefault();
                break;
            default:
                return false;
        }
        return true;
    }
    getSuggestions(view) {
        this.trigger = new SuggestorTrigger(this.context, view);
        const allSuggestions = getTikzSuggestions().map(s => s.trigger || s.replacement);
        const filteredSuggestions = allSuggestions.filter((suggestion) => suggestion.toLowerCase().startsWith(this.trigger.text.toLowerCase()));
        const sortedSuggestions = filteredSuggestions.sort((a, b) => {
            const lowerLastWord = this.trigger.text.toLowerCase();
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
            const aExactMatch = aLower === lowerLastWord ? -1 : 0;
            const bExactMatch = bLower === lowerLastWord ? -1 : 0;
            if (aExactMatch !== bExactMatch)
                return aExactMatch - bExactMatch;
            if (a.length !== b.length)
                return a.length - b.length;
            return aLower.localeCompare(bLower);
        });
        return sortedSuggestions;
    }
    updateSelection(items = this.getAlldropdownItems()) {
        items.forEach((item, index) => {
            if (index === this.selectionIndex) {
                item.classList.add("selected");
                item.scrollIntoView({ block: "nearest" });
            }
            else {
                item.classList.remove("selected");
            }
        });
    }
    selectDropdownItem(view, item = this.getAlldropdownItems()[this.selectionIndex]) {
        this.close();
        if (!this.context)
            return;
        const selectedText = item.textContent || "";
        const pos = this.context.pos;
        queueSnippet(view, pos - this.trigger.text.length, pos, selectedText);
        const success = expandSnippets(view);
        view.focus();
        setCursor(view, calculateNewCursorPosition(this.trigger.text, selectedText, pos));
        console.log(`Selected: ${selectedText}`, success, calculateNewCursorPosition(this.trigger.text, selectedText, pos));
        return success;
    }
}
function calculateNewCursorPosition(triggerText, selectedText, originalPos) {
    console.log(triggerText, selectedText, originalPos);
    const lengthDifference = selectedText.length - triggerText.length;
    return originalPos + lengthDifference;
}
export const suggestor = new Suggestor();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N1Z2dlc3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEdBQUksTUFBTSxhQUFhLENBQUM7QUFHbkQsT0FBTyxFQUFnQixTQUFTLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUMxRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlEQUFpRCxDQUFDO0FBRS9FLE1BQU0sZ0JBQWdCO0lBQ3JCLElBQUksQ0FBUTtJQUNaLGFBQWEsQ0FBUztJQUN0QixZQUFZLEdBQVksRUFBRSxJQUFnQjtRQUN6QyxJQUFJLENBQUMsSUFBSSxHQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ2hELE1BQU0sTUFBTSxHQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUMsSUFBRyxDQUFDLE1BQU07WUFBQyxPQUFNO1FBQ2pCLDBDQUEwQztRQUMxQyxxQkFBcUI7SUFDdEIsQ0FBQztJQUNELFVBQVUsQ0FBQyxPQUFlO0lBRTFCLENBQUM7SUFDRCxrQkFBa0IsQ0FBQyxHQUFXLEVBQUUsSUFBZ0I7UUFDL0MsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3hDLGlGQUFpRjtRQUNqRixNQUFNLGNBQWMsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsR0FBRyxHQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNqRSxNQUFNLEtBQUssR0FBRyxjQUFjLENBQUMsS0FBSyxDQUFDLGtDQUFrQyxDQUFDLENBQUM7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SUFBSSxFQUFFLENBQUM7UUFDNUMsTUFBTSxHQUFHLEdBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUM7UUFDM0IsWUFBWSxDQUFDLElBQUksRUFBQyxHQUFHLEdBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFDLEdBQUcsRUFBQyxZQUFZLENBQUMsQ0FBQTtRQUNoRSxNQUFNLE9BQU8sR0FBRyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDckMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ2IsU0FBUyxDQUFDLElBQUksRUFBQywwQkFBMEIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksRUFBQyxZQUFZLEVBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQTtRQUM5RSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsWUFBWSxFQUFFLEVBQUMsT0FBTyxFQUFDLDBCQUEwQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFDLFlBQVksRUFBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hILE9BQU8sT0FBTyxDQUFDO0lBQ2hCLENBQUM7Q0FDRDtBQUdELFNBQVMsMEJBQTBCLENBQUMsV0FBbUIsRUFBRSxZQUFvQixFQUFFLFdBQW1CO0lBQ2pHLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFDLFlBQVksRUFBQyxXQUFXLENBQUMsQ0FBQTtJQUM5QyxNQUFNLGdCQUFnQixHQUFHLFlBQVksQ0FBQyxNQUFNLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQztJQUNsRSxPQUFPLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQztBQUMxQyxDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLElBQUksU0FBUyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRUaWt6U3VnZ2VzdGlvbnMsICB9IGZyb20gXCIuL3V0aWxpdGllc1wiO1xyXG5pbXBvcnQgeyBFZGl0b3JWaWV3LCB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XHJcbmltcG9ydCB7IHJlcGxhY2VSYW5nZSwgc2V0Q3Vyc29yIH0gZnJvbSBcIi4vZWRpdG9yIHV0aWxpdGllcy9lZGl0b3JfdXRpbHNcIjtcclxuaW1wb3J0IHsgZXhwYW5kU25pcHBldHMgfSBmcm9tIFwiLi9zbmlwcGV0cy9zbmlwcGV0X21hbmFnZW1lbnRcIjtcclxuaW1wb3J0IHsgcXVldWVTbmlwcGV0IH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XHJcblxyXG5jbGFzcyBTdWdnZXN0b3JUcmlnZ2Vye1xyXG5cdHRleHQ6IHN0cmluZ1xyXG5cdGNvZGVCbG9ja1RleHQ6IHN0cmluZztcclxuXHRjb25zdHJ1Y3RvcihjdHg6IENvbnRleHQsIHZpZXc6IEVkaXRvclZpZXcpe1xyXG5cdFx0dGhpcy50ZXh0PXRoaXMuZ2V0Q3VycmVudExpbmVUZXh0KGN0eC5wb3MsIHZpZXcpXHJcblx0XHRjb25zdCBzb3VyY2U9dGhpcy5nZXRDb2RlQmxvY2tUZXh0KGN0eCx2aWV3KVxyXG5cdFx0aWYoIXNvdXJjZSlyZXR1cm5cclxuXHRcdC8vY29uc3QgdG9rZW5zPW5ldyBCYXNpY1Rpa3pUb2tlbnMoc291cmNlKVxyXG5cdFx0Ly9jb25zb2xlLmxvZyh0b2tlbnMpXHJcblx0fVxyXG5cdHNldFRyaWdnZXIodHJpZ2dlcjogc3RyaW5nKXtcclxuXHJcblx0fVxyXG5cdGdldEN1cnJlbnRMaW5lVGV4dChwb3M6IG51bWJlciwgdmlldzogRWRpdG9yVmlldyk6IHN0cmluZyB7XHJcblx0XHRjb25zdCBsaW5lID0gdmlldy5zdGF0ZS5kb2MubGluZUF0KHBvcyk7XHJcblx0XHQvL2NvbnN0IGN1cnNvck9mZnNldEluTGluZSA9IChwb3MrMikgLSBsaW5lLmZyb207SSBkb24ndCBrbm93IHdoeSBJIGhhZCB0aGlzIGhlcmVcclxuXHRcdGNvbnN0IHRleHRVcFRvQ3Vyc29yID0gbGluZS50ZXh0LnNsaWNlKDAsIHBvcy0gbGluZS5mcm9tKS50cmltKCk7XHJcblx0XHRjb25zdCB3b3JkcyA9IHRleHRVcFRvQ3Vyc29yLnNwbGl0KC8oW1xccyxcXFtcXF0oKXt9O118LS1cXCtcXCt8LS1cXCt8LS0pKy8pO1xyXG5cdFx0Y29uc3Qgd29yZD13b3Jkc1t3b3Jkcy5sZW5ndGggLSAxXXx8Jyc7XHJcblx0XHQvKiBDaGVja3MgdGhhdCBuZWVkIHRvIGJlIG1hZGVcclxuXHRcdDEuIEluIHdoYXQgY29tbWFuZCBhcmUgd2UgaW4gaWYgYW55LlxyXG5cdFx0Mi4gQXJlIHdlIGlucHV0dGluZyBhIFZhcmlhYmxlIGEgY29vcmRpbmF0ZSBvciBmb3JtYXR0aW5nLlxyXG5cdFx0My4gaWYgRm9ybWF0dGluZyBBcmUgd2Ugc3RhcnRpbmcgdG8gdHlwZSBhIGNvbW1hbmQgb3IgYXJlIHdlIGlucHV0dGluZyBhIHZhbHVlIHRvIGEgY29tbWFuZFxyXG5cdFx0Ki9cclxuXHRcdHJldHVybiB3b3Jkc1t3b3Jkcy5sZW5ndGggLSAxXSB8fCBcIlwiO1xyXG5cdH1cclxuXHRnZXRDb2RlQmxvY2tUZXh0KGN0eDogQ29udGV4dCx2aWV3OiBFZGl0b3JWaWV3KXtcclxuXHRcdGNvbnN0IGRvYyA9IHZpZXcuc3RhdGUuZG9jO1xyXG5cdFx0Y29uc3QgcyA9IGRvYy5saW5lQXQoY3R4LnBvcyk7XHJcblxyXG5cdFx0Y29uc3QgYm91bmRzPWN0eC5nZXRCb3VuZHMoKVxyXG5cdFx0aWYoYm91bmRzPT09bnVsbClcclxuXHRcdFx0dGhyb3cgbmV3IEVycm9yKFwiTm8gYm91bmRzIGZvdW5kXCIpXHJcblxyXG5cdFx0Y29uc3QgYmV0d2VlblRleHQgPSBkb2Muc2xpY2VTdHJpbmcoYm91bmRzLnN0YXJ0LCBib3VuZHMuZW5kKS50cmltKCk7XHJcblx0XHRyZXR1cm4gYmV0d2VlblRleHRcclxuXHR9XHJcbn1cclxuXHJcbmNsYXNzIFN1Z2dlc3RvciB7XHJcblx0cHJpdmF0ZSB0cmlnZ2VyOiBTdWdnZXN0b3JUcmlnZ2VyO1xyXG5cdHByaXZhdGUgc2VsZWN0aW9uSW5kZXg6IG51bWJlcj0wO1xyXG5cdHByaXZhdGUgY29udGV4dDogQ29udGV4dDtcclxuXHRwcml2YXRlIHN1Z2dlc3Rpb25zID0gW107XHJcblx0cHJpdmF0ZSBjb250YWluZXJFbDogSFRNTEVsZW1lbnQ7XHJcblxyXG5cdG9wZW4oY29udGV4dDogQ29udGV4dCx2aWV3OiBFZGl0b3JWaWV3KXtcclxuXHRcdC8vIElmIHRoZSBzdWdnZXN0b3IgaXMgYWxyZWFkeSBkZXBsb3llZCwgY2xvc2UgaXRcclxuXHRcdHRoaXMuY2xvc2UoKTtcclxuXHRcdHRoaXMuY29udGV4dD1jb250ZXh0O1xyXG5cdFx0dGhpcy5jcmVhdGVDb250YWluZXJFbCh2aWV3KTtcclxuXHRcdHRoaXMudXBkYXRlUG9zaXRpb25Gcm9tVmlldyh2aWV3KTtcclxuXHRcdGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5jb250YWluZXJFbCk7XHJcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbigpO1xyXG5cdH1cclxuXHRjbG9zZSgpe1xyXG5cdFx0ZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yQWxsKFwiLnN1Z2dlc3Rpb24taXRlbVwiKS5mb3JFYWNoKG5vZGUgPT4gbm9kZS5yZW1vdmUoKSk7XHJcblx0XHRkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoXCIuc3VnZ2VzdGlvbi1kcm9wZG93blwiKT8ucmVtb3ZlKCk7XHJcblx0fVxyXG5cdGlzU3VnZ2VzdGVyRGVwbG95ZWQoKTogYm9vbGVhbiB7cmV0dXJuICEhZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik7fVxyXG5cdHNldFNlbGVjdGlvbkluZGV4KG51bWJlcjogbnVtYmVyKXtcclxuXHRcdHRoaXMuc2VsZWN0aW9uSW5kZXg9bnVtYmVyXHJcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbigpXHJcblx0fVxyXG5cdG1vdmVTZWxlY3Rpb25JbmRleChudW1iZXI6IG51bWJlcil7XHJcblx0XHRjb25zdCBpdGVtcz10aGlzLmdldEFsbGRyb3Bkb3duSXRlbXMoKVxyXG5cdFx0dGhpcy5zZWxlY3Rpb25JbmRleD0oc3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4ICtudW1iZXIgKyBpdGVtcy5sZW5ndGgpICUgaXRlbXMubGVuZ3RoXHJcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbihpdGVtcylcclxuXHR9XHJcblxyXG5cdHVwZGF0ZVBvc2l0aW9uRnJvbVZpZXcodmlldzogRWRpdG9yVmlldyk6IGJvb2xlYW57XHJcblx0XHRjb25zdCBjb29yZHM9dmlldy5jb29yZHNBdFBvcyh2aWV3LnN0YXRlLnNlbGVjdGlvbi5tYWluLmhlYWQpXHJcblx0XHRpZiAoIWNvb3JkcykgcmV0dXJuIGZhbHNlO1xyXG5cdFx0dGhpcy51cGRhdGVQb3NpdGlvbihjb29yZHMubGVmdCxjb29yZHMuYm90dG9tKVxyXG5cdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cdFxyXG5cdFxyXG5cdGNyZWF0ZUNvbnRhaW5lckVsKHZpZXc6IEVkaXRvclZpZXcpe1xyXG5cdFx0Y29uc3Qgc3VnZ2VzdGlvbnM9dGhpcy5nZXRTdWdnZXN0aW9ucyh2aWV3KVxyXG5cdFx0aWYoc3VnZ2VzdGlvbnMubGVuZ3RoPDEpcmV0dXJuO1xyXG5cdFx0dGhpcy5jb250YWluZXJFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcblx0XHR0aGlzLmNvbnRhaW5lckVsLmFkZENsYXNzKFwic3VnZ2VzdGlvbi1kcm9wZG93blwiKVxyXG5cclxuXHRcdHN1Z2dlc3Rpb25zLmZvckVhY2goKHN1Z2dlc3Rpb24pID0+IHtcclxuXHRcdFx0dGhpcy5yZW5kZXJTdWdnZXN0aW9uKHN1Z2dlc3Rpb24pO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRyZW5kZXJTdWdnZXN0aW9uKHN1Z2dlc3Rpb246IHN0cmluZyl7XHJcblx0XHR0aGlzLmNvbnRhaW5lckVsLmFwcGVuZENoaWxkKFxyXG5cdFx0XHRPYmplY3QuYXNzaWduKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiksIHtcclxuXHRcdFx0XHRjbGFzc05hbWU6IFwic3VnZ2VzdGlvbi1pdGVtXCIsXHJcblx0XHRcdFx0aW5uZXJUZXh0OiBzdWdnZXN0aW9uXHJcblx0XHRcdH0pXHJcblx0XHQpO1xyXG5cdH1cclxuXHJcblx0dXBkYXRlUG9zaXRpb24obGVmdDogbnVtYmVyLHRvcDogbnVtYmVyKXtcclxuXHRcdGlmICghdGhpcy5jb250YWluZXJFbCkgcmV0dXJuIGZhbHNlO1xyXG5cdFx0T2JqZWN0LmFzc2lnbih0aGlzLmNvbnRhaW5lckVsLnN0eWxlLHtcclxuXHRcdFx0cG9zaXRpb246IFwiYWJzb2x1dGVcIixcclxuXHRcdFx0bGVmdDogYCR7bGVmdH1weGAsXHJcblx0XHRcdHRvcDogYCR7dG9wfXB4YCxcclxuXHRcdH0pO1xyXG5cdFx0cmV0dXJuIHRydWU7XHJcblx0fVxyXG5cclxuXHRnZXRBbGxkcm9wZG93bkl0ZW1zKCl7cmV0dXJuIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIil9XHJcblx0cHJpdmF0ZSBnZXREcm9wZG93bigpe3JldHVybiBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoXCIuc3VnZ2VzdGlvbi1kcm9wZG93blwiKX1cclxuXHJcblx0aGFuZGxlRHJvcGRvd25OYXZpZ2F0aW9uKGV2ZW50OiBLZXlib2FyZEV2ZW50LHZpZXc6RWRpdG9yVmlldykge1xyXG5cdFx0Y29uc3QgZHJvcGRvd24gPSB0aGlzLmdldERyb3Bkb3duKCk7XHJcblx0XHRpZiAoIWRyb3Bkb3duKSByZXR1cm47XHJcblx0XHJcblx0XHRjb25zdCBpdGVtcyA9IHRoaXMuZ2V0QWxsZHJvcGRvd25JdGVtcygpO1xyXG5cclxuXHRcdGlmIChpdGVtcy5sZW5ndGggPT09IDApIHJldHVybjtcclxuXHRcdHN3aXRjaCAodHJ1ZSkge1xyXG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd0Rvd25cIjpcclxuXHRcdFx0XHR0aGlzLm1vdmVTZWxlY3Rpb25JbmRleCgxKVxyXG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgZXZlbnQua2V5ID09PSBcIkFycm93VXBcIjpcclxuXHRcdFx0XHR0aGlzLm1vdmVTZWxlY3Rpb25JbmRleCgtMSlcclxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd0xlZnRcInx8ZXZlbnQua2V5ID09PSBcIkFycm93UmlnaHRcIjpcclxuXHRcdFx0XHRzdWdnZXN0b3IuY2xvc2UoKTtcclxuXHRcdFx0XHRicmVhaztcclxuXHRcdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiQmFja3NwYWNlXCI6XHJcblx0XHRcdFx0c3VnZ2VzdG9yLmNsb3NlKCk7XHJcblx0XHRcdFx0YnJlYWs7XHJcblx0XHRcdGNhc2UgZXZlbnQua2V5ID09PSBcIkVudGVyXCI6XHJcblx0XHRcdFx0c3VnZ2VzdG9yLnNlbGVjdERyb3Bkb3duSXRlbSh2aWV3KTtcclxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJFc2NhcGVcIjpcclxuXHRcdFx0XHRzdWdnZXN0b3IuY2xvc2UoKTtcclxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGJyZWFrO1xyXG5cdFx0XHRkZWZhdWx0OlxyXG5cdFx0XHRcdHJldHVybiBmYWxzZTtcclxuXHRcdH1cclxuXHRcdHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHJcblx0cHJpdmF0ZSBnZXRTdWdnZXN0aW9ucyh2aWV3OiBFZGl0b3JWaWV3KSB7XHJcblx0XHR0aGlzLnRyaWdnZXI9bmV3IFN1Z2dlc3RvclRyaWdnZXIodGhpcy5jb250ZXh0LCB2aWV3KVxyXG5cdFx0Y29uc3QgYWxsU3VnZ2VzdGlvbnMgPSBnZXRUaWt6U3VnZ2VzdGlvbnMoKS5tYXAocyA9PiBzLnRyaWdnZXJ8fHMucmVwbGFjZW1lbnQpO1xyXG5cdFxyXG5cdFx0Y29uc3QgZmlsdGVyZWRTdWdnZXN0aW9ucyA9IGFsbFN1Z2dlc3Rpb25zLmZpbHRlcigoc3VnZ2VzdGlvbikgPT5cclxuXHRcdFx0c3VnZ2VzdGlvbi50b0xvd2VyQ2FzZSgpLnN0YXJ0c1dpdGgodGhpcy50cmlnZ2VyLnRleHQudG9Mb3dlckNhc2UoKSlcclxuXHRcdCk7XHJcblx0XHJcblx0XHRjb25zdCBzb3J0ZWRTdWdnZXN0aW9ucyA9IGZpbHRlcmVkU3VnZ2VzdGlvbnMuc29ydCgoYSwgYikgPT4ge1xyXG5cdFx0XHRjb25zdCBsb3dlckxhc3RXb3JkID0gdGhpcy50cmlnZ2VyLnRleHQudG9Mb3dlckNhc2UoKTtcclxuXHRcdFx0Y29uc3QgYUxvd2VyID0gYS50b0xvd2VyQ2FzZSgpO1xyXG5cdFx0XHRjb25zdCBiTG93ZXIgPSBiLnRvTG93ZXJDYXNlKCk7XHJcblx0XHJcblxyXG5cdFx0XHRjb25zdCBhRXhhY3RNYXRjaCA9IGFMb3dlciA9PT0gbG93ZXJMYXN0V29yZCA/IC0xIDogMDtcclxuXHRcdFx0Y29uc3QgYkV4YWN0TWF0Y2ggPSBiTG93ZXIgPT09IGxvd2VyTGFzdFdvcmQgPyAtMSA6IDA7XHJcblx0XHRcdGlmIChhRXhhY3RNYXRjaCAhPT0gYkV4YWN0TWF0Y2gpIHJldHVybiBhRXhhY3RNYXRjaCAtIGJFeGFjdE1hdGNoO1xyXG5cdFxyXG5cdFx0XHRpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSByZXR1cm4gYS5sZW5ndGggLSBiLmxlbmd0aDtcclxuXHRcclxuXHRcdFx0cmV0dXJuIGFMb3dlci5sb2NhbGVDb21wYXJlKGJMb3dlcik7XHJcblx0XHR9KTtcclxuXHRcdHJldHVybiBzb3J0ZWRTdWdnZXN0aW9ucztcclxuXHR9XHJcblxyXG5cdHVwZGF0ZVNlbGVjdGlvbihpdGVtczogTm9kZUxpc3RPZjxFbGVtZW50Pj10aGlzLmdldEFsbGRyb3Bkb3duSXRlbXMoKSkge1xyXG5cdFx0aXRlbXMuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcclxuXHRcdFx0aWYgKGluZGV4ID09PSB0aGlzLnNlbGVjdGlvbkluZGV4KSB7XHJcblx0XHRcdFx0aXRlbS5jbGFzc0xpc3QuYWRkKFwic2VsZWN0ZWRcIik7XHJcblx0XHRcdFx0aXRlbS5zY3JvbGxJbnRvVmlldyh7IGJsb2NrOiBcIm5lYXJlc3RcIiB9KTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRpdGVtLmNsYXNzTGlzdC5yZW1vdmUoXCJzZWxlY3RlZFwiKTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRzZWxlY3REcm9wZG93bkl0ZW0odmlldzogRWRpdG9yVmlldyxpdGVtOiBFbGVtZW50PXRoaXMuZ2V0QWxsZHJvcGRvd25JdGVtcygpW3RoaXMuc2VsZWN0aW9uSW5kZXhdKSB7XHJcblx0XHR0aGlzLmNsb3NlKClcclxuXHRcdGlmKCF0aGlzLmNvbnRleHQpcmV0dXJuIDtcclxuXHRcdGNvbnN0IHNlbGVjdGVkVGV4dCA9IGl0ZW0udGV4dENvbnRlbnQgfHwgXCJcIjtcclxuXHRcdGNvbnN0IHBvcz10aGlzLmNvbnRleHQucG9zO1xyXG5cdFx0cXVldWVTbmlwcGV0KHZpZXcscG9zLXRoaXMudHJpZ2dlci50ZXh0Lmxlbmd0aCxwb3Msc2VsZWN0ZWRUZXh0KVxyXG5cdFx0Y29uc3Qgc3VjY2VzcyA9IGV4cGFuZFNuaXBwZXRzKHZpZXcpO1xyXG5cdFx0dmlldy5mb2N1cygpO1xyXG5cdFx0c2V0Q3Vyc29yKHZpZXcsY2FsY3VsYXRlTmV3Q3Vyc29yUG9zaXRpb24odGhpcy50cmlnZ2VyLnRleHQsc2VsZWN0ZWRUZXh0LHBvcykpXHJcblx0XHRjb25zb2xlLmxvZyhgU2VsZWN0ZWQ6ICR7c2VsZWN0ZWRUZXh0fWAsc3VjY2VzcyxjYWxjdWxhdGVOZXdDdXJzb3JQb3NpdGlvbih0aGlzLnRyaWdnZXIudGV4dCxzZWxlY3RlZFRleHQscG9zKSk7XHJcblx0XHRyZXR1cm4gc3VjY2VzcztcclxuXHR9XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBjYWxjdWxhdGVOZXdDdXJzb3JQb3NpdGlvbih0cmlnZ2VyVGV4dDogc3RyaW5nLCBzZWxlY3RlZFRleHQ6IHN0cmluZywgb3JpZ2luYWxQb3M6IG51bWJlcik6IG51bWJlciB7XHJcblx0Y29uc29sZS5sb2codHJpZ2dlclRleHQsc2VsZWN0ZWRUZXh0LG9yaWdpbmFsUG9zKVxyXG4gICAgY29uc3QgbGVuZ3RoRGlmZmVyZW5jZSA9IHNlbGVjdGVkVGV4dC5sZW5ndGggLSB0cmlnZ2VyVGV4dC5sZW5ndGg7XHJcbiAgICByZXR1cm4gb3JpZ2luYWxQb3MgKyBsZW5ndGhEaWZmZXJlbmNlO1xyXG59XHJcblxyXG5leHBvcnQgY29uc3Qgc3VnZ2VzdG9yID0gbmV3IFN1Z2dlc3RvcigpOyJdfQ==