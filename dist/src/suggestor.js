import { getTikzSuggestions, } from "./utilities";
import { expandSnippets } from "./snippets/snippet_management";
import { queueSnippet } from "./snippets/codemirror/snippet_queue_state_field";
import { setCursor } from "./utils/editor_utils";
class SuggestorTrigger {
    text;
    codeBlockText;
    suggestions = [];
    constructor(ctx, view) {
        this.text = this.getCurrentLineText(ctx.pos, view);
        const source = this.getCodeBlockText(ctx, view);
        this.filteredSuggestions();
        if (!source)
            return;
        //const tokens=new BasicTikzTokens(source)
        //console.log(tokens)
    }
    getSuggestions() { return this.suggestions; }
    getText() { return this.text; }
    setTrigger(trigger) {
    }
    hasValue() {
        return this.text && this.text.length > 0 && this.suggestions.length !== 1 && this.suggestions[0] !== this.text;
    }
    getCurrentLineText(pos, view) {
        const line = view.state.doc.lineAt(pos);
        //const cursorOffsetInLine = (pos+2) - line.from;I don't know why I had this here
        const textUpToCursor = line.text.slice(0, pos - line.from).trim();
        const words = textUpToCursor.split(/([\s,\[\](){};]|--\+\+|--\+|--)+/);
        const word = words[words.length - 1] || '';
        /* Checks that need to be made
        1. In what command are we in if any.
        2. Are we inputting a Variable a coordinate or formatting.
        3. if Formatting Are we starting to type a command or are we inputting a value to a command
        */
        return words[words.length - 1] || "";
    }
    filteredSuggestions() {
        const allSuggestions = getTikzSuggestions().map(s => s.trigger || s.replacement);
        const filteredSuggestions = allSuggestions.filter((suggestion) => suggestion.toLowerCase().startsWith(this.text.toLowerCase()));
        const sortedSuggestions = filteredSuggestions.sort((a, b) => {
            const lowerLastWord = this.text.toLowerCase();
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
            const aExactMatch = aLower === lowerLastWord ? -1 : 0;
            const bExactMatch = bLower === lowerLastWord ? -1 : 0;
            if (aExactMatch !== bExactMatch)
                return aExactMatch - bExactMatch;
            if (a.length !== b.length)
                return a.length - b.length;
            return aLower.localeCompare(bLower);
        });
        this.suggestions = sortedSuggestions;
    }
    getCodeBlockText(ctx, view) {
        const doc = view.state.doc;
        const bounds = ctx.getBounds();
        if (bounds === null)
            throw new Error("No bounds found");
        const betweenText = doc.sliceString(bounds.start, bounds.end).trim();
        return betweenText;
    }
}
class Suggestor {
    trigger;
    selectionIndex = 0;
    context;
    containerEl;
    open(context, view) {
        // If the suggestor is already deployed, close it
        this.close();
        this.context = context;
        this.trigger = new SuggestorTrigger(this.context, view);
        if (!this.trigger.hasValue())
            return false;
        this.createContainerEl();
        this.updatePositionFromView(view);
        document.body.appendChild(this.containerEl);
        this.updateSelection();
        return true;
    }
    close() {
        document.body.querySelectorAll(".suggestion-item").forEach(node => node.remove());
        document.body.querySelector(".suggestion-dropdown")?.remove();
    }
    isSuggesterDeployed() { return !!document.body.querySelector(".suggestion-dropdown"); }
    setSelectionIndex(number) {
        this.selectionIndex = number;
        this.updateSelection();
    }
    moveSelectionIndex(number) {
        const items = this.getAlldropdownItems();
        this.selectionIndex = (suggestor.selectionIndex + number + items.length) % items.length;
        this.updateSelection(items);
    }
    updatePositionFromView(view) {
        const coords = view.coordsAtPos(view.state.selection.main.head);
        if (!coords)
            return false;
        this.updatePosition(coords.left, coords.bottom);
        return true;
    }
    createContainerEl() {
        const suggestions = this.trigger.getSuggestions();
        if (suggestions.length < 1)
            return;
        this.containerEl = document.createElement("div");
        this.containerEl.addClass("suggestion-dropdown");
        suggestions.forEach((suggestion) => {
            this.renderSuggestion(suggestion);
        });
    }
    renderSuggestion(suggestion) {
        this.containerEl.appendChild(Object.assign(document.createElement("div"), {
            className: "suggestion-item",
            innerText: suggestion
        }));
    }
    updatePosition(left, top) {
        if (!this.containerEl)
            return false;
        Object.assign(this.containerEl.style, {
            position: "absolute",
            left: `${left}px`,
            top: `${top}px`,
        });
        return true;
    }
    getAlldropdownItems() { return document.body.querySelectorAll(".suggestion-item"); }
    getDropdown() { return document.body.querySelector(".suggestion-dropdown"); }
    handleDropdownNavigation(event, view) {
        const dropdown = this.getDropdown();
        if (!dropdown)
            return;
        const items = this.getAlldropdownItems();
        if (items.length === 0)
            return;
        switch (true) {
            case event.key === "ArrowDown":
                this.moveSelectionIndex(1);
                event.preventDefault();
                break;
            case event.key === "ArrowUp":
                this.moveSelectionIndex(-1);
                event.preventDefault();
                break;
            case event.key === "ArrowLeft" || event.key === "ArrowRight":
                suggestor.close();
                break;
            case event.key === "Backspace":
                suggestor.close();
                break;
            case event.key === "Enter":
                suggestor.selectDropdownItem(view);
                event.preventDefault();
                break;
            case event.key === "Escape":
                suggestor.close();
                event.preventDefault();
                break;
            default:
                return false;
        }
        return true;
    }
    updateSelection(items = this.getAlldropdownItems()) {
        items.forEach((item, index) => {
            if (index === this.selectionIndex) {
                item.classList.add("selected");
                item.scrollIntoView({ block: "nearest" });
            }
            else {
                item.classList.remove("selected");
            }
        });
    }
    selectDropdownItem(view, item = this.getAlldropdownItems()[this.selectionIndex]) {
        this.close();
        if (!this.context)
            return;
        const trigger = this.trigger.getText();
        const selectedText = item.textContent || "";
        const pos = this.context.pos;
        queueSnippet(view, pos - trigger.length, pos, selectedText);
        const success = expandSnippets(view);
        view.focus();
        setCursor(view, calculateNewCursorPosition(trigger, selectedText, pos));
        return success;
    }
}
function calculateNewCursorPosition(triggerText, selectedText, originalPos) {
    console.log('calculateNewCursorPosition', triggerText, selectedText, originalPos);
    const lengthDifference = selectedText.length - triggerText.length;
    return originalPos + lengthDifference;
}
export const suggestor = new Suggestor();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N1Z2dlc3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEdBQUksTUFBTSxhQUFhLENBQUM7QUFHbkQsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQy9ELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxpREFBaUQsQ0FBQztBQUMvRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFFakQsTUFBTSxnQkFBZ0I7SUFDYixJQUFJLENBQVE7SUFDWixhQUFhLENBQVM7SUFDdEIsV0FBVyxHQUFXLEVBQUUsQ0FBQztJQUNqQyxZQUFZLEdBQVksRUFBRSxJQUFnQjtRQUN6QyxJQUFJLENBQUMsSUFBSSxHQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFBO1FBQ2hELE1BQU0sTUFBTSxHQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLEVBQUMsSUFBSSxDQUFDLENBQUE7UUFDNUMsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUE7UUFDMUIsSUFBRyxDQUFDLE1BQU07WUFBQyxPQUFNO1FBQ2pCLDBDQUEwQztRQUMxQyxxQkFBcUI7SUFDdEIsQ0FBQztJQUNELGNBQWMsS0FBRyxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUEsQ0FBQSxDQUFDO0lBQ3pDLE9BQU8sS0FBRyxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUEsQ0FBQSxDQUFDO0lBQzNCLFVBQVUsQ0FBQyxPQUFlO0lBRTFCLENBQUM7SUFDRCxRQUFRO1FBQ1AsT0FBTyxJQUFJLENBQUMsSUFBSSxJQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFDLENBQUMsSUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU0sS0FBRyxDQUFDLElBQUUsSUFBSSxDQUFDLFdB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R0FBRyxnQkFBZ0IsQ0FBQztBQUMxQyxDQUFDO0FBRUQsTUFBTSxDQUFDLE1BQU0sU0FBUyxHQUFHLElBQUksU0FBUyxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRUaWt6U3VnZ2VzdGlvbnMsICB9IGZyb20gXCIuL3V0aWxpdGllc1wiO1xuaW1wb3J0IHsgRWRpdG9yVmlldywgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCIuL3V0aWxzL2NvbnRleHRcIjtcbmltcG9ydCB7IGV4cGFuZFNuaXBwZXRzIH0gZnJvbSBcIi4vc25pcHBldHMvc25pcHBldF9tYW5hZ2VtZW50XCI7XG5pbXBvcnQgeyBxdWV1ZVNuaXBwZXQgfSBmcm9tIFwiLi9zbmlwcGV0cy9jb2RlbWlycm9yL3NuaXBwZXRfcXVldWVfc3RhdGVfZmllbGRcIjtcbmltcG9ydCB7IHNldEN1cnNvciB9IGZyb20gXCIuL3V0aWxzL2VkaXRvcl91dGlsc1wiO1xuXG5jbGFzcyBTdWdnZXN0b3JUcmlnZ2Vye1xuXHRwcml2YXRlIHRleHQ6IHN0cmluZ1xuXHRwcml2YXRlIGNvZGVCbG9ja1RleHQ6IHN0cmluZztcblx0cHJpdmF0ZSBzdWdnZXN0aW9uczogc3RyaW5nW109W107XG5cdGNvbnN0cnVjdG9yKGN0eDogQ29udGV4dCwgdmlldzogRWRpdG9yVmlldyl7XG5cdFx0dGhpcy50ZXh0PXRoaXMuZ2V0Q3VycmVudExpbmVUZXh0KGN0eC5wb3MsIHZpZXcpXG5cdFx0Y29uc3Qgc291cmNlPXRoaXMuZ2V0Q29kZUJsb2NrVGV4dChjdHgsdmlldylcblx0XHR0aGlzLmZpbHRlcmVkU3VnZ2VzdGlvbnMoKVxuXHRcdGlmKCFzb3VyY2UpcmV0dXJuXG5cdFx0Ly9jb25zdCB0b2tlbnM9bmV3IEJhc2ljVGlrelRva2Vucyhzb3VyY2UpXG5cdFx0Ly9jb25zb2xlLmxvZyh0b2tlbnMpXG5cdH1cblx0Z2V0U3VnZ2VzdGlvbnMoKXtyZXR1cm4gdGhpcy5zdWdnZXN0aW9uc31cblx0Z2V0VGV4dCgpe3JldHVybiB0aGlzLnRleHR9XG5cdHNldFRyaWdnZXIodHJpZ2dlcjogc3RyaW5nKXtcblxuXHR9XG5cdGhhc1ZhbHVlKCl7XG5cdFx0cmV0dXJuIHRoaXMudGV4dCYmdGhpcy50ZXh0Lmxlbmd0aD4wJiZ0aGlzLnN1Z2dlc3Rpb25zLmxlbmd0aCE9PTEmJnRoaXMuc3VnZ2VzdGlvbnNbMF0hPT10aGlzLnRleHRcblx0fVxuXHRnZXRDdXJyZW50TGluZVRleHQocG9zOiBudW1iZXIsIHZpZXc6IEVkaXRvclZpZXcpOiBzdHJpbmcge1xuXHRcdGNvbnN0IGxpbmUgPSB2aWV3LnN0YXRlLmRvYy5saW5lQXQocG9zKTtcblx0XHQvL2NvbnN0IGN1cnNvck9mZnNldEluTGluZSA9IChwb3MrMikgLSBsaW5lLmZyb207SSBkb24ndCBrbm93IHdoeSBJIGhhZCB0aGlzIGhlcmVcblx0XHRjb25zdCB0ZXh0VXBUb0N1cnNvciA9IGxpbmUudGV4dC5zbGljZSgwLCBwb3MtIGxpbmUuZnJvbSkudHJpbSgpO1xuXHRcdGNvbnN0IHdvcmRzID0gdGV4dFVwVG9DdXJzb3Iuc3BsaXQoLyhbXFxzLFxcW1xcXSgpe307XXwtLVxcK1xcK3wtLVxcK3wtLSkrLyk7XG5cdFx0Y29uc3Qgd29yZD13b3Jkc1t3b3Jkcy5sZW5ndGggLSAxXXx8Jyc7XG5cdFx0LyogQ2hlY2tzIHRoYXQgbmVlZCB0byBiZSBtYWRlXG5cdFx0MS4gSW4gd2hhdCBjb21tYW5kIGFyZSB3ZSBpbiBpZiBhbnkuXG5cdFx0Mi4gQXJlIHdlIGlucHV0dGluZyBhIFZhcmlhYmxlIGEgY29vcmRpbmF0ZSBvciBmb3JtYXR0aW5nLlxuXHRcdDMuIGlmIEZvcm1hdHRpbmcgQXJlIHdlIHN0YXJ0aW5nIHRvIHR5cGUgYSBjb21tYW5kIG9yIGFyZSB3ZSBpbnB1dHRpbmcgYSB2YWx1ZSB0byBhIGNvbW1hbmRcblx0XHQqL1xuXHRcdHJldHVybiB3b3Jkc1t3b3Jkcy5sZW5ndGggLSAxXSB8fCBcIlwiO1xuXHR9XG5cdHByaXZhdGUgZmlsdGVyZWRTdWdnZXN0aW9ucygpIHtcblx0XHRjb25zdCBhbGxTdWdnZXN0aW9ucyA9IGdldFRpa3pTdWdnZXN0aW9ucygpLm1hcChzID0+IHMudHJpZ2dlciB8fCBzLnJlcGxhY2VtZW50KTtcblx0XG5cdFx0Y29uc3QgZmlsdGVyZWRTdWdnZXN0aW9ucyA9IGFsbFN1Z2dlc3Rpb25zLmZpbHRlcigoc3VnZ2VzdGlvbikgPT5cblx0XHRcdHN1Z2dlc3Rpb24udG9Mb3dlckNhc2UoKS5zdGFydHNXaXRoKHRoaXMudGV4dC50b0xvd2VyQ2FzZSgpKVxuXHRcdCk7XG5cdFxuXHRcdGNvbnN0IHNvcnRlZFN1Z2dlc3Rpb25zID0gZmlsdGVyZWRTdWdnZXN0aW9ucy5zb3J0KChhLCBiKSA9PiB7XG5cdFx0XHRjb25zdCBsb3dlckxhc3RXb3JkID0gdGhpcy50ZXh0LnRvTG93ZXJDYXNlKCk7XG5cdFx0XHRjb25zdCBhTG93ZXIgPSBhLnRvTG93ZXJDYXNlKCk7XG5cdFx0XHRjb25zdCBiTG93ZXIgPSBiLnRvTG93ZXJDYXNlKCk7XG5cdFxuXHRcdFx0Y29uc3QgYUV4YWN0TWF0Y2ggPSBhTG93ZXIgPT09IGxvd2VyTGFzdFdvcmQgPyAtMSA6IDA7XG5cdFx0XHRjb25zdCBiRXhhY3RNYXRjaCA9IGJMb3dlciA9PT0gbG93ZXJMYXN0V29yZCA/IC0xIDogMDtcblx0XHRcdGlmIChhRXhhY3RNYXRjaCAhPT0gYkV4YWN0TWF0Y2gpIHJldHVybiBhRXhhY3RNYXRjaCAtIGJFeGFjdE1hdGNoO1xuXHRcblx0XHRcdGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBhLmxlbmd0aCAtIGIubGVuZ3RoO1xuXHRcblx0XHRcdHJldHVybiBhTG93ZXIubG9jYWxlQ29tcGFyZShiTG93ZXIpO1xuXHRcdH0pO1xuXHRcdHRoaXMuc3VnZ2VzdGlvbnMgPSBzb3J0ZWRTdWdnZXN0aW9ucztcblx0fVxuXHRnZXRDb2RlQmxvY2tUZXh0KGN0eDogQ29udGV4dCx2aWV3OiBFZGl0b3JWaWV3KXtcblx0XHRjb25zdCBkb2MgPSB2aWV3LnN0YXRlLmRvYztcblx0XHRcblx0XHRjb25zdCBib3VuZHM9Y3R4LmdldEJvdW5kcygpXG5cdFx0aWYoYm91bmRzPT09bnVsbClcblx0XHRcdHRocm93IG5ldyBFcnJvcihcIk5vIGJvdW5kcyBmb3VuZFwiKVxuXG5cblx0XHRjb25zdCBiZXR3ZWVuVGV4dCA9IGRvYy5zbGljZVN0cmluZyhib3VuZHMuc3RhcnQsIGJvdW5kcy5lbmQpLnRyaW0oKTtcblx0XHRyZXR1cm4gYmV0d2VlblRleHRcblx0fVxufVxuXG5jbGFzcyBTdWdnZXN0b3Ige1xuXHRwcml2YXRlIHRyaWdnZXI6IFN1Z2dlc3RvclRyaWdnZXI7XG5cdHByaXZhdGUgc2VsZWN0aW9uSW5kZXg6IG51bWJlcj0wO1xuXHRwcml2YXRlIGNvbnRleHQ6IENvbnRleHQ7XG5cdHByaXZhdGUgY29udGFpbmVyRWw6IEhUTUxFbGVtZW50O1xuXG5cdG9wZW4oY29udGV4dDogQ29udGV4dCx2aWV3OiBFZGl0b3JWaWV3KXtcblx0XHQvLyBJZiB0aGUgc3VnZ2VzdG9yIGlzIGFscmVhZHkgZGVwbG95ZWQsIGNsb3NlIGl0XG5cdFx0dGhpcy5jbG9zZSgpO1xuXHRcdHRoaXMuY29udGV4dD1jb250ZXh0O1xuXHRcdHRoaXMudHJpZ2dlcj1uZXcgU3VnZ2VzdG9yVHJpZ2dlcih0aGlzLmNvbnRleHQsIHZpZXcpXG5cdFx0aWYoIXRoaXMudHJpZ2dlci5oYXNWYWx1ZSgpKXJldHVybiBmYWxzZTtcblx0XHR0aGlzLmNyZWF0ZUNvbnRhaW5lckVsKCk7XG5cdFx0dGhpcy51cGRhdGVQb3NpdGlvbkZyb21WaWV3KHZpZXcpO1xuXHRcdGRvY3VtZW50LmJvZHkuYXBwZW5kQ2hpbGQodGhpcy5jb250YWluZXJFbCk7XG5cdFx0dGhpcy51cGRhdGVTZWxlY3Rpb24oKTtcblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXHRjbG9zZSgpe1xuXHRcdGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIikuZm9yRWFjaChub2RlID0+IG5vZGUucmVtb3ZlKCkpO1xuXHRcdGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcihcIi5zdWdnZXN0aW9uLWRyb3Bkb3duXCIpPy5yZW1vdmUoKTtcblx0fVxuXHRpc1N1Z2dlc3RlckRlcGxveWVkKCk6IGJvb2xlYW4ge3JldHVybiAhIWRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcihcIi5zdWdnZXN0aW9uLWRyb3Bkb3duXCIpO31cblx0c2V0U2VsZWN0aW9uSW5kZXgobnVtYmVyOiBudW1iZXIpe1xuXHRcdHRoaXMuc2VsZWN0aW9uSW5kZXg9bnVtYmVyXG5cdFx0dGhpcy51cGRhdGVTZWxlY3Rpb24oKVxuXHR9XG5cdG1vdmVTZWxlY3Rpb25JbmRleChudW1iZXI6IG51bWJlcil7XG5cdFx0Y29uc3QgaXRlbXM9dGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKClcblx0XHR0aGlzLnNlbGVjdGlvbkluZGV4PShzdWdnZXN0b3Iuc2VsZWN0aW9uSW5kZXggK251bWJlciArIGl0ZW1zLmxlbmd0aCkgJSBpdGVtcy5sZW5ndGhcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbihpdGVtcylcblx0fVxuXG5cdHVwZGF0ZVBvc2l0aW9uRnJvbVZpZXcodmlldzogRWRpdG9yVmlldyk6IGJvb2xlYW57XG5cdFx0Y29uc3QgY29vcmRzPXZpZXcuY29vcmRzQXRQb3Modmlldy5zdGF0ZS5zZWxlY3Rpb24ubWFpbi5oZWFkKVxuXHRcdGlmICghY29vcmRzKSByZXR1cm4gZmFsc2U7XG5cdFx0dGhpcy51cGRhdGVQb3NpdGlvbihjb29yZHMubGVmdCxjb29yZHMuYm90dG9tKVxuXHRcdHJldHVybiB0cnVlO1xuXHR9XG5cdFxuXHRcblx0Y3JlYXRlQ29udGFpbmVyRWwoKXtcblx0XHRjb25zdCBzdWdnZXN0aW9ucz10aGlzLnRyaWdnZXIuZ2V0U3VnZ2VzdGlvbnMoKVxuXHRcdGlmKHN1Z2dlc3Rpb25zLmxlbmd0aDwxKXJldHVybjtcblx0XHR0aGlzLmNvbnRhaW5lckVsID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcblx0XHR0aGlzLmNvbnRhaW5lckVsLmFkZENsYXNzKFwic3VnZ2VzdGlvbi1kcm9wZG93blwiKVxuXG5cdFx0c3VnZ2VzdGlvbnMuZm9yRWFjaCgoc3VnZ2VzdGlvbikgPT4ge1xuXHRcdFx0dGhpcy5yZW5kZXJTdWdnZXN0aW9uKHN1Z2dlc3Rpb24pO1xuXHRcdH0pO1xuXHR9XG5cblx0cmVuZGVyU3VnZ2VzdGlvbihzdWdnZXN0aW9uOiBzdHJpbmcpe1xuXHRcdHRoaXMuY29udGFpbmVyRWwuYXBwZW5kQ2hpbGQoXG5cdFx0XHRPYmplY3QuYXNzaWduKGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIiksIHtcblx0XHRcdFx0Y2xhc3NOYW1lOiBcInN1Z2dlc3Rpb24taXRlbVwiLFxuXHRcdFx0XHRpbm5lclRleHQ6IHN1Z2dlc3Rpb25cblx0XHRcdH0pXG5cdFx0KTtcblx0fVxuXG5cdHVwZGF0ZVBvc2l0aW9uKGxlZnQ6IG51bWJlcix0b3A6IG51bWJlcil7XG5cdFx0aWYgKCF0aGlzLmNvbnRhaW5lckVsKSByZXR1cm4gZmFsc2U7XG5cdFx0T2JqZWN0LmFzc2lnbih0aGlzLmNvbnRhaW5lckVsLnN0eWxlLHtcblx0XHRcdHBvc2l0aW9uOiBcImFic29sdXRlXCIsXG5cdFx0XHRsZWZ0OiBgJHtsZWZ0fXB4YCxcblx0XHRcdHRvcDogYCR7dG9wfXB4YCxcblx0XHR9KTtcblx0XHRyZXR1cm4gdHJ1ZTtcblx0fVxuXG5cdGdldEFsbGRyb3Bkb3duSXRlbXMoKXtyZXR1cm4gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yQWxsKFwiLnN1Z2dlc3Rpb24taXRlbVwiKX1cblx0cHJpdmF0ZSBnZXREcm9wZG93bigpe3JldHVybiBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoXCIuc3VnZ2VzdGlvbi1kcm9wZG93blwiKX1cblxuXHRoYW5kbGVEcm9wZG93bk5hdmlnYXRpb24oZXZlbnQ6IEtleWJvYXJkRXZlbnQsdmlldzpFZGl0b3JWaWV3KSB7XG5cdFx0Y29uc3QgZHJvcGRvd24gPSB0aGlzLmdldERyb3Bkb3duKCk7XG5cdFx0aWYgKCFkcm9wZG93bikgcmV0dXJuO1xuXHRcblx0XHRjb25zdCBpdGVtcyA9IHRoaXMuZ2V0QWxsZHJvcGRvd25JdGVtcygpO1xuXG5cdFx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuXHRcdHN3aXRjaCAodHJ1ZSkge1xuXHRcdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiQXJyb3dEb3duXCI6XG5cdFx0XHRcdHRoaXMubW92ZVNlbGVjdGlvbkluZGV4KDEpXG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiQXJyb3dVcFwiOlxuXHRcdFx0XHR0aGlzLm1vdmVTZWxlY3Rpb25JbmRleCgtMSlcblx0XHRcdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcblx0XHRcdFx0YnJlYWs7XG5cdFx0XHRjYXNlIGV2ZW50LmtleSA9PT0gXCJBcnJvd0xlZnRcInx8ZXZlbnQua2V5ID09PSBcIkFycm93UmlnaHRcIjpcblx0XHRcdFx0c3VnZ2VzdG9yLmNsb3NlKCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiQmFja3NwYWNlXCI6XG5cdFx0XHRcdHN1Z2dlc3Rvci5jbG9zZSgpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGNhc2UgZXZlbnQua2V5ID09PSBcIkVudGVyXCI6XG5cdFx0XHRcdHN1Z2dlc3Rvci5zZWxlY3REcm9wZG93bkl0ZW0odmlldyk7XG5cdFx0XHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG5cdFx0XHRcdGJyZWFrO1xuXHRcdFx0Y2FzZSBldmVudC5rZXkgPT09IFwiRXNjYXBlXCI6XG5cdFx0XHRcdHN1Z2dlc3Rvci5jbG9zZSgpO1xuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXHRcdFx0XHRicmVhaztcblx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdHJldHVybiBmYWxzZTtcblx0XHR9XG5cdFx0cmV0dXJuIHRydWU7XG5cdH1cblxuXHR1cGRhdGVTZWxlY3Rpb24oaXRlbXM6IE5vZGVMaXN0T2Y8RWxlbWVudD49dGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKCkpIHtcblx0XHRpdGVtcy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuXHRcdFx0aWYgKGluZGV4ID09PSB0aGlzLnNlbGVjdGlvbkluZGV4KSB7XG5cdFx0XHRcdGl0ZW0uY2xhc3NMaXN0LmFkZChcInNlbGVjdGVkXCIpO1xuXHRcdFx0XHRpdGVtLnNjcm9sbEludG9WaWV3KHsgYmxvY2s6IFwibmVhcmVzdFwiIH0pO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0aXRlbS5jbGFzc0xpc3QucmVtb3ZlKFwic2VsZWN0ZWRcIik7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRzZWxlY3REcm9wZG93bkl0ZW0odmlldzogRWRpdG9yVmlldyxpdGVtOiBFbGVtZW50PXRoaXMuZ2V0QWxsZHJvcGRvd25JdGVtcygpW3RoaXMuc2VsZWN0aW9uSW5kZXhdKSB7XG5cdFx0dGhpcy5jbG9zZSgpXG5cdFx0aWYoIXRoaXMuY29udGV4dClyZXR1cm47XG5cblx0XHRjb25zdCB0cmlnZ2VyPXRoaXMudHJpZ2dlci5nZXRUZXh0KClcblxuXHRcdGNvbnN0IHNlbGVjdGVkVGV4dCA9IGl0ZW0udGV4dENvbnRlbnQgfHwgXCJcIjtcblx0XHRjb25zdCBwb3M9dGhpcy5jb250ZXh0LnBvcztcblx0XHRxdWV1ZVNuaXBwZXQodmlldyxwb3MtdHJpZ2dlci5sZW5ndGgscG9zLHNlbGVjdGVkVGV4dClcblx0XHRjb25zdCBzdWNjZXNzID0gZXhwYW5kU25pcHBldHModmlldyk7XG5cdFx0dmlldy5mb2N1cygpO1xuXHRcdHNldEN1cnNvcih2aWV3LGNhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uKHRyaWdnZXIsc2VsZWN0ZWRUZXh0LHBvcykpXG5cdFx0cmV0dXJuIHN1Y2Nlc3M7XG5cdH1cbn1cblxuXG5mdW5jdGlvbiBjYWxjdWxhdGVOZXdDdXJzb3JQb3NpdGlvbih0cmlnZ2VyVGV4dDogc3RyaW5nLCBzZWxlY3RlZFRleHQ6IHN0cmluZywgb3JpZ2luYWxQb3M6IG51bWJlcik6IG51bWJlciB7XG5cdGNvbnNvbGUubG9nKCdjYWxjdWxhdGVOZXdDdXJzb3JQb3NpdGlvbicsdHJpZ2dlclRleHQsc2VsZWN0ZWRUZXh0LG9yaWdpbmFsUG9zKVxuICAgIGNvbnN0IGxlbmd0aERpZmZlcmVuY2UgPSBzZWxlY3RlZFRleHQubGVuZ3RoIC0gdHJpZ2dlclRleHQubGVuZ3RoO1xuICAgIHJldHVybiBvcmlnaW5hbFBvcyArIGxlbmd0aERpZmZlcmVuY2U7XG59XG5cbmV4cG9ydCBjb25zdCBzdWdnZXN0b3IgPSBuZXcgU3VnZ2VzdG9yKCk7Il19