import { getTikzSuggestions, } from "./utilities";
import { EditorView, } from "@codemirror/view";
import { expandSnippets } from "./snippets/snippet_management";
import { queueSnippet } from "./snippets/codemirror/snippet_queue_state_field";
class SuggestorTrigger {
    text;
    codeBlockText;
    constructor(ctx, view) {
        this.text = this.getCurrentLineText(ctx.pos, view);
        const source = this.getCodeBlockText(ctx, view);
        if (!source)
            return;
        //const tokens=new BasicTikzTokens(source)
        //console.log(tokens)
    }
    setTrigger(trigger) {
    }
    getCurrentLineText(pos, view) {
        const line = view.state.doc.lineAt(pos);
        //const cursorOffsetInLine = (pos+2) - line.from;I don't know why I had this here
        const textUpToCursor = line.text.slice(0, pos - line.from).trim();
        const words = textUpToCursor.split(/([\s,\[\](){};]|--\+\+|--\+|--)+/);
        const word = words[words.length - 1] || '';
        console.log(word);
        /* Checks that need to be made
        1. In what command are we in if any.
        2. Are we inputting a Variable a coordinate or formatting.
        3. if Formatting Are we starting to type a command or are we inputting a value to a command
        */
        return words[words.length - 1] || "";
    }
    getCodeBlockText(ctx, view) {
        const doc = view.state.doc;
        const { number } = doc.lineAt(ctx.pos);
        const beforeLine = findLine(view.state, number, -1, '```');
        const afterLine = findLine(view.state, number, 1, '```');
        ;
        if (!beforeLine || !afterLine)
            return null;
        const betweenText = doc.sliceString(beforeLine.to, afterLine.from).trim();
        const relativePos = ctx.pos - beforeLine.to;
        return betweenText;
    }
}
const findLine = (state, lineNumber, dir, startsWith) => {
    const { doc } = state;
    for (let i = lineNumber + dir; i > 0 && i <= doc.lines; i += dir) {
        const line = doc.line(i).text.trim();
        if (line.startsWith(startsWith))
            return doc.line(i);
    }
    return null;
};
export class Suggestor {
    trigger;
    selectionIndex;
    context;
    isSuggesterDeployed = false;
    deploySuggestor(context, view) {
        console.log("sjdsjd");
        this.removeSuggestor();
        this.context = context;
        const suggestions = this.getSuggestions(view);
        if (suggestions.length < 1)
            return;
        const suggestionDropdown = createFloatingSuggestionDropdown(suggestions, view, this.context.pos);
        if (!suggestionDropdown)
            return;
        document.body.appendChild(suggestionDropdown);
        this.isSuggesterDeployed = true;
        this.selectionIndex = 0;
        this.updateSelection(this.getAlldropdownItems());
    }
    updateSuggestorPosition() {
    }
    removeSuggestor() {
        document.body.querySelectorAll(".suggestion-item").forEach(node => node.remove());
        document.body.querySelector(".suggestion-dropdown")?.remove();
        this.isSuggesterDeployed = false;
    }
    getAlldropdownItems() { return document.body.querySelectorAll(".suggestion-item"); }
    dropdownifAnyDeployed() { return document.body.querySelector(".suggestion-dropdown"); }
    handleDropdownNavigation(event, view) {
        const dropdown = this.dropdownifAnyDeployed();
        if (!dropdown || this.selectionIndex === undefined)
            return;
        const items = this.getAlldropdownItems();
        if (items.length === 0)
            return;
    }
    getSuggestions(view) {
        this.trigger = new SuggestorTrigger(this.context, view);
        const allSuggestions = getTikzSuggestions().map(s => s.trigger || s.replacement);
        const filteredSuggestions = allSuggestions.filter((suggestion) => suggestion.toLowerCase().startsWith(this.trigger.text.toLowerCase()));
        const sortedSuggestions = filteredSuggestions.sort((a, b) => {
            const lowerLastWord = this.trigger.text.toLowerCase();
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
            const aExactMatch = aLower === lowerLastWord ? -1 : 0;
            const bExactMatch = bLower === lowerLastWord ? -1 : 0;
            if (aExactMatch !== bExactMatch)
                return aExactMatch - bExactMatch;
            if (a.length !== b.length)
                return a.length - b.length;
            return aLower.localeCompare(bLower);
        });
        return sortedSuggestions;
    }
    updateSelection(items) {
        items.forEach((item, index) => {
            if (index === this.selectionIndex) {
                item.classList.add("selected");
                item.scrollIntoView({ block: "nearest" });
            }
            else {
                item.classList.remove("selected");
            }
        });
    }
    selectDropdownItem(item, view) {
        this.removeSuggestor();
        if (!this.context)
            return;
        const selectedText = item.textContent || "";
        const pos = this.context.pos;
        queueSnippet(view, pos - this.trigger.text.length, pos, selectedText);
        const success = expandSnippets(view);
        //view.focus();
        //setCursor(view,calculateNewCursorPosition(this.trigger.text,selectedText,pos))
        console.log(`Selected: ${selectedText}`);
    }
}
function calculateNewCursorPosition(triggerText, selectedText, originalPos) {
    const lengthDifference = selectedText.length - triggerText.length;
    return originalPos + lengthDifference;
}
function createFloatingSuggestionDropdown(suggestions, editorView, position) {
    const coordinates = editorView.coordsAtPos(position);
    if (!coordinates)
        return;
    const suggestionDropdown = createSuggestionDropdown(suggestions);
    suggestionDropdown.style.position = "absolute";
    suggestionDropdown.style.left = `${coordinates.left}px`;
    suggestionDropdown.style.top = `${coordinates.bottom}px`;
    return suggestionDropdown;
}
function createSuggestionDropdown(suggestions) {
    const dropdownContainer = document.createElement("div");
    dropdownContainer.className = "suggestion-dropdown";
    suggestions.forEach((suggestion) => {
        const item = createSuggestionItem(suggestion);
        dropdownContainer.appendChild(item);
    });
    return dropdownContainer;
}
function createSuggestionItem(displayText) {
    // Create the outer suggestion item container
    const container = document.createElement("div");
    container.classList.add("suggestion-item");
    container.innerText = displayText;
    return container;
    // Create the icon container
    const icon = document.createElement("div");
    icon.classList.add("icon");
    icon.textContent = "Æ’"; // Placeholder icon content
    // Create the details container
    const details = document.createElement("div");
    details.classList.add("details");
    // Add a name span to details
    const name = document.createElement("span");
    name.classList.add("name");
    name.textContent = "function"; // Placeholder name content
    // Add a type span to details
    const type = document.createElement("span");
    type.classList.add("type");
    type.textContent = "Keyword"; // Placeholder type content
    // Append name and type to details
    details.appendChild(name);
    details.appendChild(type);
    // Append icon and details to the container
    container.appendChild(icon);
    container.appendChild(details);
    return container;
}
export function getCharacterAtPos(viewOrState, pos) {
    const state = viewOrState instanceof EditorView ? viewOrState.state : viewOrState;
    const doc = state.doc;
    return doc.slice(pos, pos + 1).toString();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N1Z2dlc3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEdBQUksTUFBTSxhQUFhLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsR0FBRyxNQUFNLGtCQUFrQixDQUFDO0FBTy9DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saURBQWlELENBQUM7QUFHL0UsTUFBTSxnQkFBZ0I7SUFDckIsSUFBSSxDQUFRO0lBQ1osYUFBYSxDQUFTO0lBQ3RCLFlBQVksR0FBWSxFQUFFLElBQWdCO1FBQ3pDLElBQUksQ0FBQyxJQUFJLEdBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLENBQUE7UUFDaEQsTUFBTSxNQUFNLEdBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsRUFBQyxJQUFJLENBQUMsQ0FBQTtRQUM1QyxJQUFHLENBQUMsTUFBTTtZQUFDLE9BQU07UUFDakIsMENBQTBDO1FBQzFDLHFCQUFxQjtJQUN0QixDQUFDO0lBQ0QsVUFBVSxDQUFDLE9BQWU7SUFFMUIsQ0FBQztJQUNELGtCQUFrQixDQUFDLEdBQVcsRUFBRSxJQUFnQjtRQUMvQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDeEMsaUZBQWlGO1FBQ2pGLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxHQUFHLEdBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2pFLE1BQU0sS0FBSyxHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsa0NBQWtDLENBQUMsQ0FBQztR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LENBQUMsQ0FBQztJQUUvQixPQUFPLFNBQVMsQ0FBQztBQUNsQixDQUFDO0FBUUQsTUFBTSxVQUFVLGlCQUFpQixDQUFDLFdBQXFDLEVBQUUsR0FBVztJQUNuRixNQUFNLEtBQUssR0FBRyxXQUFXLFlBQVksVUFBVSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUM7SUFDbEYsTUFBTSxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQztJQUN0QixPQUFPLEdBQUcsQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEdBQUcsR0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLEVBQUUsQ0FBQztBQUN6QyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZ2V0VGlrelN1Z2dlc3Rpb25zLCAgfSBmcm9tIFwiLi91dGlsaXRpZXNcIjtcclxuaW1wb3J0IHsgRWRpdG9yVmlldywgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xyXG5pbXBvcnQgeyBzeW50YXhUcmVlIH0gZnJvbSBcIkBjb2RlbWlycm9yL2xhbmd1YWdlXCI7XHJcbmltcG9ydCB7IEVkaXRvclN0YXRlfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgU3ludGF4Tm9kZSwgVHJlZUN1cnNvciB9IGZyb20gXCJAbGV6ZXIvY29tbW9uXCI7XHJcbmltcG9ydCBNb3NoZSBmcm9tIFwiLi9tYWluXCI7XHJcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XHJcbmltcG9ydCB7IHJlcGxhY2VSYW5nZSwgc2V0Q3Vyc29yIH0gZnJvbSBcIi4vZWRpdG9yIHV0aWxpdGllcy9lZGl0b3JfdXRpbHNcIjtcclxuaW1wb3J0IHsgZXhwYW5kU25pcHBldHMgfSBmcm9tIFwiLi9zbmlwcGV0cy9zbmlwcGV0X21hbmFnZW1lbnRcIjtcclxuaW1wb3J0IHsgcXVldWVTbmlwcGV0IH0gZnJvbSBcIi4vc25pcHBldHMvY29kZW1pcnJvci9zbmlwcGV0X3F1ZXVlX3N0YXRlX2ZpZWxkXCI7XHJcblxyXG5cclxuY2xhc3MgU3VnZ2VzdG9yVHJpZ2dlcntcclxuXHR0ZXh0OiBzdHJpbmdcclxuXHRjb2RlQmxvY2tUZXh0OiBzdHJpbmc7XHJcblx0Y29uc3RydWN0b3IoY3R4OiBDb250ZXh0LCB2aWV3OiBFZGl0b3JWaWV3KXtcclxuXHRcdHRoaXMudGV4dD10aGlzLmdldEN1cnJlbnRMaW5lVGV4dChjdHgucG9zLCB2aWV3KVxyXG5cdFx0Y29uc3Qgc291cmNlPXRoaXMuZ2V0Q29kZUJsb2NrVGV4dChjdHgsdmlldylcclxuXHRcdGlmKCFzb3VyY2UpcmV0dXJuXHJcblx0XHQvL2NvbnN0IHRva2Vucz1uZXcgQmFzaWNUaWt6VG9rZW5zKHNvdXJjZSlcclxuXHRcdC8vY29uc29sZS5sb2codG9rZW5zKVxyXG5cdH1cclxuXHRzZXRUcmlnZ2VyKHRyaWdnZXI6IHN0cmluZyl7XHJcblxyXG5cdH1cclxuXHRnZXRDdXJyZW50TGluZVRleHQocG9zOiBudW1iZXIsIHZpZXc6IEVkaXRvclZpZXcpOiBzdHJpbmcge1xyXG5cdFx0Y29uc3QgbGluZSA9IHZpZXcuc3RhdGUuZG9jLmxpbmVBdChwb3MpO1xyXG5cdFx0Ly9jb25zdCBjdXJzb3JPZmZzZXRJbkxpbmUgPSAocG9zKzIpIC0gbGluZS5mcm9tO0kgZG9uJ3Qga25vdyB3aHkgSSBoYWQgdGhpcyBoZXJlXHJcblx0XHRjb25zdCB0ZXh0VXBUb0N1cnNvciA9IGxpbmUudGV4dC5zbGljZSgwLCBwb3MtIGxpbmUuZnJvbSkudHJpbSgpO1xyXG5cdFx0Y29uc3Qgd29yZHMgPSB0ZXh0VXBUb0N1cnNvci5zcGxpdCgvKFtcXHMsXFxbXFxdKCl7fTtdfC0tXFwrXFwrfC0tXFwrfC0tKSsvKTtcclxuXHRcdGNvbnN0IHdvcmQ9d29yZHNbd29yZHMubGVuZ3RoIC0gMV18fCcnO1xyXG5cdFx0Y29uc29sZS5sb2cod29yZClcclxuXHRcdC8qIENoZWNrcyB0aGF0IG5lZWQgdG8gYmUgbWFkZVxyXG5cdFx0MS4gSW4gd2hhdCBjb21tYW5kIGFyZSB3ZSBpbiBpZiBhbnkuXHJcblx0XHQyLiBBcmUgd2UgaW5wdXR0aW5nIGEgVmFyaWFibGUgYSBjb29yZGluYXRlIG9yIGZvcm1hdHRpbmcuXHJcblx0XHQzLiBpZiBGb3JtYXR0aW5nIEFyZSB3ZSBzdGFydGluZyB0byB0eXBlIGEgY29tbWFuZCBvciBhcmUgd2UgaW5wdXR0aW5nIGEgdmFsdWUgdG8gYSBjb21tYW5kXHJcblx0XHQqL1xyXG5cdFx0cmV0dXJuIHdvcmRzW3dvcmRzLmxlbmd0aCAtIDFdIHx8IFwiXCI7XHJcblx0fVxyXG5cdGdldENvZGVCbG9ja1RleHQoY3R4OiBDb250ZXh0LHZpZXc6IEVkaXRvclZpZXcpe1xyXG5cdFx0Y29uc3QgZG9jID0gdmlldy5zdGF0ZS5kb2M7XHJcblx0XHRjb25zdCB7IG51bWJlciB9ID0gZG9jLmxpbmVBdChjdHgucG9zKTtcclxuXHJcblx0XHRjb25zdCBiZWZvcmVMaW5lID0gZmluZExpbmUodmlldy5zdGF0ZSxudW1iZXIsLTEsJ2BgYCcpO1xyXG5cdFx0Y29uc3QgYWZ0ZXJMaW5lID0gIGZpbmRMaW5lKHZpZXcuc3RhdGUsbnVtYmVyLDEsJ2BgYCcpOztcclxuXHRcdGlmICghYmVmb3JlTGluZSB8fCAhYWZ0ZXJMaW5lKSByZXR1cm4gbnVsbDtcclxuXHRcdGNvbnN0IGJldHdlZW5UZXh0ID0gZG9jLnNsaWNlU3RyaW5nKGJlZm9yZUxpbmUudG8sIGFmdGVyTGluZS5mcm9tKS50cmltKCk7XHJcblx0XHRjb25zdCByZWxhdGl2ZVBvcyA9IGN0eC5wb3MgLSBiZWZvcmVMaW5lLnRvO1xyXG5cdFx0cmV0dXJuIGJldHdlZW5UZXh0XHJcblx0fVxyXG59XHJcblxyXG5jb25zdCBmaW5kTGluZSA9IChzdGF0ZTogRWRpdG9yU3RhdGUsIGxpbmVOdW1iZXI6IG51bWJlcixkaXI6IG51bWJlciwgc3RhcnRzV2l0aDogc3RyaW5nKSA9PiB7XHJcblx0Y29uc3Qge2RvY309c3RhdGVcclxuXHRmb3IgKGxldCBpID0gbGluZU51bWJlciArIGRpcjsgaSA+IDAgJiYgaSA8PSBkb2MubGluZXM7IGkgKz0gZGlyKSB7XHJcblx0Y29uc3QgbGluZSA9IGRvYy5saW5lKGkpLnRleHQudHJpbSgpO1xyXG5cdGlmIChsaW5lLnN0YXJ0c1dpdGgoc3RhcnRzV2l0aCkpIHJldHVybiBkb2MubGluZShpKTtcclxuXHR9XHJcblx0cmV0dXJuIG51bGw7XHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgU3VnZ2VzdG9yIHtcclxuXHRwcml2YXRlIHRyaWdnZXI6IFN1Z2dlc3RvclRyaWdnZXI7XHJcblx0c2VsZWN0aW9uSW5kZXg6IG51bWJlcjtcclxuXHRwcml2YXRlIGNvbnRleHQ6IENvbnRleHQ7XHJcblx0aXNTdWdnZXN0ZXJEZXBsb3llZDogYm9vbGVhbj1mYWxzZTtcclxuXHJcblx0ZGVwbG95U3VnZ2VzdG9yKGNvbnRleHQ6IENvbnRleHQsdmlldzogRWRpdG9yVmlldyl7XHJcblx0XHRjb25zb2xlLmxvZyhcInNqZHNqZFwiKVxyXG5cdFx0dGhpcy5yZW1vdmVTdWdnZXN0b3IoKVxyXG5cdFx0dGhpcy5jb250ZXh0PWNvbnRleHQ7XHJcblx0XHRjb25zdCBzdWdnZXN0aW9ucz10aGlzLmdldFN1Z2dlc3Rpb25zKHZpZXcpXHJcblx0XHRpZihzdWdnZXN0aW9ucy5sZW5ndGg8MSlyZXR1cm47XHJcblxyXG5cdFx0Y29uc3Qgc3VnZ2VzdGlvbkRyb3Bkb3duID0gY3JlYXRlRmxvYXRpbmdTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnMsdmlldywgdGhpcy5jb250ZXh0LnBvcyk7XHJcblx0XHRpZiAoIXN1Z2dlc3Rpb25Ecm9wZG93bikgcmV0dXJuO1xyXG5cdFx0ZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzdWdnZXN0aW9uRHJvcGRvd24pO1xyXG5cdFx0dGhpcy5pc1N1Z2dlc3RlckRlcGxveWVkPXRydWU7XHJcblx0XHR0aGlzLnNlbGVjdGlvbkluZGV4PTA7XHJcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbih0aGlzLmdldEFsbGRyb3Bkb3duSXRlbXMoKSk7XHJcblxyXG5cdH1cclxuXHR1cGRhdGVTdWdnZXN0b3JQb3NpdGlvbigpe1xyXG5cclxuXHR9XHJcblxyXG5cdHJlbW92ZVN1Z2dlc3RvcigpIHtcclxuXHRcdGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIikuZm9yRWFjaChub2RlID0+IG5vZGUucmVtb3ZlKCkpO1xyXG5cdFx0ZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik/LnJlbW92ZSgpXHJcblx0XHR0aGlzLmlzU3VnZ2VzdGVyRGVwbG95ZWQ9ZmFsc2U7XHJcblx0fVxyXG5cclxuXHRnZXRBbGxkcm9wZG93bkl0ZW1zKCl7cmV0dXJuIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIil9XHJcblx0cHJpdmF0ZSBkcm9wZG93bmlmQW55RGVwbG95ZWQoKXtyZXR1cm4gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIil9XHJcblxyXG5cdHByaXZhdGUgaGFuZGxlRHJvcGRvd25OYXZpZ2F0aW9uKGV2ZW50OiBLZXlib2FyZEV2ZW50LHZpZXc6RWRpdG9yVmlldykge1xyXG5cdFx0Y29uc3QgZHJvcGRvd24gPSB0aGlzLmRyb3Bkb3duaWZBbnlEZXBsb3llZCgpO1xyXG5cdFx0aWYgKCFkcm9wZG93biB8fCB0aGlzLnNlbGVjdGlvbkluZGV4ID09PSB1bmRlZmluZWQpIHJldHVybjtcclxuXHRcclxuXHRcdGNvbnN0IGl0ZW1zID0gdGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKCk7XHJcblxyXG5cdFx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xyXG5cdFx0XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGdldFN1Z2dlc3Rpb25zKHZpZXc6IEVkaXRvclZpZXcpIHtcclxuXHRcdHRoaXMudHJpZ2dlcj1uZXcgU3VnZ2VzdG9yVHJpZ2dlcih0aGlzLmNvbnRleHQsIHZpZXcpXHJcblx0XHRjb25zdCBhbGxTdWdnZXN0aW9ucyA9IGdldFRpa3pTdWdnZXN0aW9ucygpLm1hcChzID0+IHMudHJpZ2dlcnx8cy5yZXBsYWNlbWVudCk7XHJcblx0XHJcblx0XHRjb25zdCBmaWx0ZXJlZFN1Z2dlc3Rpb25zID0gYWxsU3VnZ2VzdGlvbnMuZmlsdGVyKChzdWdnZXN0aW9uKSA9PlxyXG5cdFx0XHRzdWdnZXN0aW9uLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCh0aGlzLnRyaWdnZXIudGV4dC50b0xvd2VyQ2FzZSgpKVxyXG5cdFx0KTtcclxuXHRcclxuXHRcdGNvbnN0IHNvcnRlZFN1Z2dlc3Rpb25zID0gZmlsdGVyZWRTdWdnZXN0aW9ucy5zb3J0KChhLCBiKSA9PiB7XHJcblx0XHRcdGNvbnN0IGxvd2VyTGFzdFdvcmQgPSB0aGlzLnRyaWdnZXIudGV4dC50b0xvd2VyQ2FzZSgpO1xyXG5cdFx0XHRjb25zdCBhTG93ZXIgPSBhLnRvTG93ZXJDYXNlKCk7XHJcblx0XHRcdGNvbnN0IGJMb3dlciA9IGIudG9Mb3dlckNhc2UoKTtcclxuXHRcclxuXHJcblx0XHRcdGNvbnN0IGFFeGFjdE1hdGNoID0gYUxvd2VyID09PSBsb3dlckxhc3RXb3JkID8gLTEgOiAwO1xyXG5cdFx0XHRjb25zdCBiRXhhY3RNYXRjaCA9IGJMb3dlciA9PT0gbG93ZXJMYXN0V29yZCA/IC0xIDogMDtcclxuXHRcdFx0aWYgKGFFeGFjdE1hdGNoICE9PSBiRXhhY3RNYXRjaCkgcmV0dXJuIGFFeGFjdE1hdGNoIC0gYkV4YWN0TWF0Y2g7XHJcblx0XHJcblx0XHRcdGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBhLmxlbmd0aCAtIGIubGVuZ3RoO1xyXG5cdFxyXG5cdFx0XHRyZXR1cm4gYUxvd2VyLmxvY2FsZUNvbXBhcmUoYkxvd2VyKTtcclxuXHRcdH0pO1xyXG5cdFx0cmV0dXJuIHNvcnRlZFN1Z2dlc3Rpb25zO1xyXG5cdH1cclxuXHJcblx0XHJcblxyXG5cdHVwZGF0ZVNlbGVjdGlvbihpdGVtczogTm9kZUxpc3RPZjxFbGVtZW50Pikge1xyXG5cdFx0aXRlbXMuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcclxuXHRcdFx0aWYgKGluZGV4ID09PSB0aGlzLnNlbGVjdGlvbkluZGV4KSB7XHJcblx0XHRcdFx0aXRlbS5jbGFzc0xpc3QuYWRkKFwic2VsZWN0ZWRcIik7XHJcblx0XHRcdFx0aXRlbS5zY3JvbGxJbnRvVmlldyh7IGJsb2NrOiBcIm5lYXJlc3RcIiB9KTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRpdGVtLmNsYXNzTGlzdC5yZW1vdmUoXCJzZWxlY3RlZFwiKTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRzZWxlY3REcm9wZG93bkl0ZW0oaXRlbTogRWxlbWVudCx2aWV3OiBFZGl0b3JWaWV3KSB7XHJcblx0XHR0aGlzLnJlbW92ZVN1Z2dlc3RvcigpXHJcblx0XHRpZighdGhpcy5jb250ZXh0KXJldHVybiA7XHJcblx0XHRjb25zdCBzZWxlY3RlZFRleHQgPSBpdGVtLnRleHRDb250ZW50IHx8IFwiXCI7XHJcblx0XHRjb25zdCBwb3M9dGhpcy5jb250ZXh0LnBvcztcclxuXHRcdHF1ZXVlU25pcHBldCh2aWV3LHBvcy10aGlzLnRyaWdnZXIudGV4dC5sZW5ndGgscG9zLHNlbGVjdGVkVGV4dClcclxuXHRcdGNvbnN0IHN1Y2Nlc3MgPSBleHBhbmRTbmlwcGV0cyh2aWV3KTtcclxuXHRcdC8vdmlldy5mb2N1cygpO1xyXG5cdFx0Ly9zZXRDdXJzb3IodmlldyxjYWxjdWxhdGVOZXdDdXJzb3JQb3NpdGlvbih0aGlzLnRyaWdnZXIudGV4dCxzZWxlY3RlZFRleHQscG9zKSlcclxuXHRcdGNvbnNvbGUubG9nKGBTZWxlY3RlZDogJHtzZWxlY3RlZFRleHR9YCk7XHJcblx0fVxyXG59XHJcbmZ1bmN0aW9uIGNhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uKHRyaWdnZXJUZXh0OiBzdHJpbmcsIHNlbGVjdGVkVGV4dDogc3RyaW5nLCBvcmlnaW5hbFBvczogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IGxlbmd0aERpZmZlcmVuY2UgPSBzZWxlY3RlZFRleHQubGVuZ3RoIC0gdHJpZ2dlclRleHQubGVuZ3RoO1xyXG4gICAgcmV0dXJuIG9yaWdpbmFsUG9zICsgbGVuZ3RoRGlmZmVyZW5jZTtcclxufVxyXG5cclxuZnVuY3Rpb24gY3JlYXRlRmxvYXRpbmdTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnM6IGFueVtdLGVkaXRvclZpZXc6IEVkaXRvclZpZXcsIHBvc2l0aW9uOiBudW1iZXIpIHtcclxuXHJcbiAgICBjb25zdCBjb29yZGluYXRlcyA9IGVkaXRvclZpZXcuY29vcmRzQXRQb3MocG9zaXRpb24pO1xyXG4gICAgaWYgKCFjb29yZGluYXRlcykgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IHN1Z2dlc3Rpb25Ecm9wZG93biA9IGNyZWF0ZVN1Z2dlc3Rpb25Ecm9wZG93bihzdWdnZXN0aW9ucyk7XHJcblxyXG4gICAgc3VnZ2VzdGlvbkRyb3Bkb3duLnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xyXG4gICAgc3VnZ2VzdGlvbkRyb3Bkb3duLnN0eWxlLmxlZnQgPSBgJHtjb29yZGluYXRlcy5sZWZ0fXB4YDtcclxuICAgIHN1Z2dlc3Rpb25Ecm9wZG93bi5zdHlsZS50b3AgPSBgJHtjb29yZGluYXRlcy5ib3R0b219cHhgO1xyXG5cdHJldHVybiBzdWdnZXN0aW9uRHJvcGRvd247XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBjcmVhdGVTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnM6IHN0cmluZ1tdKSB7XHJcbiAgICBjb25zdCBkcm9wZG93bkNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBkcm9wZG93bkNvbnRhaW5lci5jbGFzc05hbWUgPSBcInN1Z2dlc3Rpb24tZHJvcGRvd25cIjtcclxuXHJcbiAgICBzdWdnZXN0aW9ucy5mb3JFYWNoKChzdWdnZXN0aW9uKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaXRlbSA9IGNyZWF0ZVN1Z2dlc3Rpb25JdGVtKHN1Z2dlc3Rpb24pXHJcblx0XHRkcm9wZG93bkNvbnRhaW5lci5hcHBlbmRDaGlsZChpdGVtKVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGRyb3Bkb3duQ29udGFpbmVyO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVTdWdnZXN0aW9uSXRlbShkaXNwbGF5VGV4dDogc3RyaW5nKTogSFRNTEVsZW1lbnQge1xyXG5cdC8vIENyZWF0ZSB0aGUgb3V0ZXIgc3VnZ2VzdGlvbiBpdGVtIGNvbnRhaW5lclxyXG5cdGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcblx0Y29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJzdWdnZXN0aW9uLWl0ZW1cIik7XHJcblx0Y29udGFpbmVyLmlubmVyVGV4dD1kaXNwbGF5VGV4dFxyXG4gIFx0cmV0dXJuIGNvbnRhaW5lclxyXG5cdC8vIENyZWF0ZSB0aGUgaWNvbiBjb250YWluZXJcclxuXHRjb25zdCBpY29uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuXHRpY29uLmNsYXNzTGlzdC5hZGQoXCJpY29uXCIpO1xyXG5cdGljb24udGV4dENvbnRlbnQgPSBcIsaSXCI7IC8vIFBsYWNlaG9sZGVyIGljb24gY29udGVudFxyXG4gIFxyXG5cdC8vIENyZWF0ZSB0aGUgZGV0YWlscyBjb250YWluZXJcclxuXHRjb25zdCBkZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuXHRkZXRhaWxzLmNsYXNzTGlzdC5hZGQoXCJkZXRhaWxzXCIpO1xyXG4gIFxyXG5cdC8vIEFkZCBhIG5hbWUgc3BhbiB0byBkZXRhaWxzXHJcblx0Y29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzcGFuXCIpO1xyXG5cdG5hbWUuY2xhc3NMaXN0LmFkZChcIm5hbWVcIik7XHJcblx0bmFtZS50ZXh0Q29udGVudCA9IFwiZnVuY3Rpb25cIjsgLy8gUGxhY2Vob2xkZXIgbmFtZSBjb250ZW50XHJcbiAgXHJcblx0Ly8gQWRkIGEgdHlwZSBzcGFuIHRvIGRldGFpbHNcclxuXHRjb25zdCB0eXBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XHJcblx0dHlwZS5jbGFzc0xpc3QuYWRkKFwidHlwZVwiKTtcclxuXHR0eXBlLnRleHRDb250ZW50ID0gXCJLZXl3b3JkXCI7IC8vIFBsYWNlaG9sZGVyIHR5cGUgY29udGVudFxyXG4gIFxyXG5cdC8vIEFwcGVuZCBuYW1lIGFuZCB0eXBlIHRvIGRldGFpbHNcclxuXHRkZXRhaWxzLmFwcGVuZENoaWxkKG5hbWUpO1xyXG5cdGRldGFpbHMuYXBwZW5kQ2hpbGQodHlwZSk7XHJcbiAgXHJcblx0Ly8gQXBwZW5kIGljb24gYW5kIGRldGFpbHMgdG8gdGhlIGNvbnRhaW5lclxyXG5cdGNvbnRhaW5lci5hcHBlbmRDaGlsZChpY29uKTtcclxuXHRjb250YWluZXIuYXBwZW5kQ2hpbGQoZGV0YWlscyk7XHJcbiAgXHJcblx0cmV0dXJuIGNvbnRhaW5lcjtcclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldENoYXJhY3RlckF0UG9zKHZpZXdPclN0YXRlOiBFZGl0b3JWaWV3IHwgRWRpdG9yU3RhdGUsIHBvczogbnVtYmVyKSB7XHJcblx0Y29uc3Qgc3RhdGUgPSB2aWV3T3JTdGF0ZSBpbnN0YW5jZW9mIEVkaXRvclZpZXcgPyB2aWV3T3JTdGF0ZS5zdGF0ZSA6IHZpZXdPclN0YXRlO1xyXG5cdGNvbnN0IGRvYyA9IHN0YXRlLmRvYztcclxuXHRyZXR1cm4gZG9jLnNsaWNlKHBvcywgcG9zKzEpLnRvU3RyaW5nKCk7XHJcbn1cclxuXHJcbiJdfQ==