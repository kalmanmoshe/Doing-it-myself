import { getTikzSuggestions, } from "./utilities";
import { EditorView, } from "@codemirror/view";
import { expandSnippets } from "./snippets/snippet_management";
import { queueSnippet } from "./snippets/codemirror/snippet_queue_state_field";
import { BasicTikzTokens } from "./tikzjax/interpret/tokenizeTikzjax";
class SuggestorTrigger {
    text;
    codeBlockText;
    constructor(ctx, view) {
        this.text = this.getCurrentLineText(ctx.pos, view);
        const source = this.getCodeBlockText(ctx, view);
        if (!source)
            return;
        const tokens = new BasicTikzTokens(source);
        console.log(tokens);
    }
    setTrigger(trigger) {
    }
    getCurrentLineText(pos, view) {
        const line = view.state.doc.lineAt(pos);
        //const cursorOffsetInLine = (pos+2) - line.from;I don't know why I had this here
        const textUpToCursor = line.text.slice(0, pos - line.from).trim();
        const words = textUpToCursor.split(/([\s,\[\](){};]|--\+\+|--\+|--)+/);
        const word = words[words.length - 1] || '';
        console.log(word);
        /* Checks that need to be made
        1. In what command are we in if any.
        2. Are we inputting a Variable a coordinate or formatting.
        3. if Formatting Are we starting to type a command or are we inputting a value to a command
        */
        return words[words.length - 1] || "";
    }
    getCodeBlockText(ctx, view) {
        const doc = view.state.doc;
        const { number } = doc.lineAt(ctx.pos);
        const beforeLine = findLine(view.state, number, -1, '```');
        const afterLine = findLine(view.state, number, 1, '```');
        ;
        if (!beforeLine || !afterLine)
            return null;
        const betweenText = doc.sliceString(beforeLine.to, afterLine.from).trim();
        const relativePos = ctx.pos - beforeLine.to;
        return betweenText;
    }
}
const findLine = (state, lineNumber, dir, startsWith) => {
    const { doc } = state;
    for (let i = lineNumber + dir; i > 0 && i <= doc.lines; i += dir) {
        const line = doc.line(i).text.trim();
        if (line.startsWith(startsWith))
            return doc.line(i);
    }
    return null;
};
export class Suggestor {
    trigger;
    selectionIndex;
    context;
    isSuggesterDeployed = false;
    deploySuggestor(context, view) {
        console.log("sjdsjd");
        this.removeSuggestor();
        this.context = context;
        const suggestions = this.getSuggestions(view);
        if (suggestions.length < 1)
            return;
        const suggestionDropdown = createFloatingSuggestionDropdown(suggestions, view, this.context.pos);
        if (!suggestionDropdown)
            return;
        document.body.appendChild(suggestionDropdown);
        this.isSuggesterDeployed = true;
        this.selectionIndex = 0;
        this.updateSelection(this.getAlldropdownItems());
    }
    updateSuggestorPosition() {
    }
    removeSuggestor() {
        document.body.querySelectorAll(".suggestion-item").forEach(node => node.remove());
        document.body.querySelector(".suggestion-dropdown")?.remove();
        this.isSuggesterDeployed = false;
    }
    getAlldropdownItems() { return document.body.querySelectorAll(".suggestion-item"); }
    dropdownifAnyDeployed() { return document.body.querySelector(".suggestion-dropdown"); }
    handleDropdownNavigation(event, view) {
        const dropdown = this.dropdownifAnyDeployed();
        if (!dropdown || this.selectionIndex === undefined)
            return;
        const items = this.getAlldropdownItems();
        if (items.length === 0)
            return;
    }
    getSuggestions(view) {
        this.trigger = new SuggestorTrigger(this.context, view);
        const allSuggestions = getTikzSuggestions().map(s => s.trigger || s.replacement);
        const filteredSuggestions = allSuggestions.filter((suggestion) => suggestion.toLowerCase().startsWith(this.trigger.text.toLowerCase()));
        const sortedSuggestions = filteredSuggestions.sort((a, b) => {
            const lowerLastWord = this.trigger.text.toLowerCase();
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
            const aExactMatch = aLower === lowerLastWord ? -1 : 0;
            const bExactMatch = bLower === lowerLastWord ? -1 : 0;
            if (aExactMatch !== bExactMatch)
                return aExactMatch - bExactMatch;
            if (a.length !== b.length)
                return a.length - b.length;
            return aLower.localeCompare(bLower);
        });
        return sortedSuggestions;
    }
    updateSelection(items) {
        items.forEach((item, index) => {
            if (index === this.selectionIndex) {
                item.classList.add("selected");
                item.scrollIntoView({ block: "nearest" });
            }
            else {
                item.classList.remove("selected");
            }
        });
    }
    selectDropdownItem(item, view) {
        this.removeSuggestor();
        if (!this.context)
            return;
        const selectedText = item.textContent || "";
        const pos = this.context.pos;
        queueSnippet(view, pos - this.trigger.text.length, pos, selectedText);
        const success = expandSnippets(view);
        //view.focus();
        //setCursor(view,calculateNewCursorPosition(this.trigger.text,selectedText,pos))
        console.log(`Selected: ${selectedText}`);
    }
}
function calculateNewCursorPosition(triggerText, selectedText, originalPos) {
    const lengthDifference = selectedText.length - triggerText.length;
    return originalPos + lengthDifference;
}
function createFloatingSuggestionDropdown(suggestions, editorView, position) {
    const coordinates = editorView.coordsAtPos(position);
    if (!coordinates)
        return;
    const suggestionDropdown = createSuggestionDropdown(suggestions);
    suggestionDropdown.style.position = "absolute";
    suggestionDropdown.style.left = `${coordinates.left}px`;
    suggestionDropdown.style.top = `${coordinates.bottom}px`;
    return suggestionDropdown;
}
function createSuggestionDropdown(suggestions) {
    const dropdownContainer = document.createElement("div");
    dropdownContainer.className = "suggestion-dropdown";
    suggestions.forEach((suggestion) => {
        const item = createSuggestionItem(suggestion);
        dropdownContainer.appendChild(item);
    });
    return dropdownContainer;
}
function createSuggestionItem(displayText) {
    // Create the outer suggestion item container
    const container = document.createElement("div");
    container.classList.add("suggestion-item");
    container.innerText = displayText;
    return container;
    // Create the icon container
    const icon = document.createElement("div");
    icon.classList.add("icon");
    icon.textContent = "Æ’"; // Placeholder icon content
    // Create the details container
    const details = document.createElement("div");
    details.classList.add("details");
    // Add a name span to details
    const name = document.createElement("span");
    name.classList.add("name");
    name.textContent = "function"; // Placeholder name content
    // Add a type span to details
    const type = document.createElement("span");
    type.classList.add("type");
    type.textContent = "Keyword"; // Placeholder type content
    // Append name and type to details
    details.appendChild(name);
    details.appendChild(type);
    // Append icon and details to the container
    container.appendChild(icon);
    container.appendChild(details);
    return container;
}
export function getCharacterAtPos(viewOrState, pos) {
    const state = viewOrState instanceof EditorView ? viewOrState.state : viewOrState;
    const doc = state.doc;
    return doc.slice(pos, pos + 1).toString();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N1Z2dlc3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEdBQUksTUFBTSxhQUFhLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsR0FBRyxNQUFNLGtCQUFrQixDQUFDO0FBTy9DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saURBQWlELENBQUM7QUFDL0UsT0FBTyxFQUFrQixlQUFlLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUd0RixNQUFNLGdCQUFnQjtJQUNyQixJQUFJLENBQVE7SUFDWixhQUFhLENBQVM7SUFDdEIsWUFBWSxHQUFZLEVBQUUsSUFBZ0I7UUFDekMsSUFBSSxDQUFDLElBQUksR0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNoRCxNQUFNLE1BQU0sR0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFDLElBQUksQ0FBQyxDQUFBO1FBQzVDLElBQUcsQ0FBQyxNQUFNO1lBQUMsT0FBTTtRQUNqQixNQUFNLE1BQU0sR0FBQyxJQUFJLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ3BCLENBQUM7SUFDRCxVQUFVLENBQUMsT0FBZTtJQUUxQixDQUFDO0lBQ0Qsa0JBQWtCLENBQUMsR0FBVyxFQUFFLElBQWdCO1FBQy9DLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN4QyxpRkFBaUY7UUFDakYsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFF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LFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUUxQiwyQ0FBMkM7SUFDM0MsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QixTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRS9CLE9BQU8sU0FBUyxDQUFDO0FBQ2xCLENBQUM7QUFRRCxNQUFNLFVBQVUsaUJBQWlCLENBQUMsV0FBcUMsRUFBRSxHQUFXO0lBQ25GLE1BQU0sS0FBSyxHQUFHLFdBQVcsWUFBWSxVQUFVLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztJQUNsRixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQ3RCLE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxHQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ3pDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRUaWt6U3VnZ2VzdGlvbnMsICB9IGZyb20gXCIuL3V0aWxpdGllc1wiO1xyXG5pbXBvcnQgeyBFZGl0b3JWaWV3LCB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IHN5bnRheFRyZWUgfSBmcm9tIFwiQGNvZGVtaXJyb3IvbGFuZ3VhZ2VcIjtcclxuaW1wb3J0IHsgRWRpdG9yU3RhdGV9IGZyb20gXCJAY29kZW1pcnJvci9zdGF0ZVwiO1xyXG5pbXBvcnQgeyBTeW50YXhOb2RlLCBUcmVlQ3Vyc29yIH0gZnJvbSBcIkBsZXplci9jb21tb25cIjtcclxuaW1wb3J0IE1vc2hlIGZyb20gXCIuL21haW5cIjtcclxuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCIuL3V0aWxzL2NvbnRleHRcIjtcclxuaW1wb3J0IHsgcmVwbGFjZVJhbmdlLCBzZXRDdXJzb3IgfSBmcm9tIFwiLi9lZGl0b3IgdXRpbGl0aWVzL2VkaXRvcl91dGlsc1wiO1xyXG5pbXBvcnQgeyBleHBhbmRTbmlwcGV0cyB9IGZyb20gXCIuL3NuaXBwZXRzL3NuaXBwZXRfbWFuYWdlbWVudFwiO1xyXG5pbXBvcnQgeyBxdWV1ZVNuaXBwZXQgfSBmcm9tIFwiLi9zbmlwcGV0cy9jb2RlbWlycm9yL3NuaXBwZXRfcXVldWVfc3RhdGVfZmllbGRcIjtcclxuaW1wb3J0IHsgQmFzaWNUaWt6VG9rZW4sIEJhc2ljVGlrelRva2VucyB9IGZyb20gXCIuL3Rpa3pqYXgvaW50ZXJwcmV0L3Rva2VuaXplVGlrempheFwiO1xyXG5cclxuXHJcbmNsYXNzIFN1Z2dlc3RvclRyaWdnZXJ7XHJcblx0dGV4dDogc3RyaW5nXHJcblx0Y29kZUJsb2NrVGV4dDogc3RyaW5nO1xyXG5cdGNvbnN0cnVjdG9yKGN0eDogQ29udGV4dCwgdmlldzogRWRpdG9yVmlldyl7XHJcblx0XHR0aGlzLnRleHQ9dGhpcy5nZXRDdXJyZW50TGluZVRleHQoY3R4LnBvcywgdmlldylcclxuXHRcdGNvbnN0IHNvdXJjZT10aGlzLmdldENvZGVCbG9ja1RleHQoY3R4LHZpZXcpXHJcblx0XHRpZighc291cmNlKXJldHVyblxyXG5cdFx0Y29uc3QgdG9rZW5zPW5ldyBCYXNpY1Rpa3pUb2tlbnMoc291cmNlKVxyXG5cdFx0Y29uc29sZS5sb2codG9rZW5zKVxyXG5cdH1cclxuXHRzZXRUcmlnZ2VyKHRyaWdnZXI6IHN0cmluZyl7XHJcblxyXG5cdH1cclxuXHRnZXRDdXJyZW50TGluZVRleHQocG9zOiBudW1iZXIsIHZpZXc6IEVkaXRvclZpZXcpOiBzdHJpbmcge1xyXG5cdFx0Y29uc3QgbGluZSA9IHZpZXcuc3RhdGUuZG9jLmxpbmVBdChwb3MpO1xyXG5cdFx0Ly9jb25zdCBjdXJzb3JPZmZzZXRJbkxpbmUgPSAocG9zKzIpIC0gbGluZS5mcm9tO0kgZG9uJ3Qga25vdyB3aHkgSSBoYWQgdGhpcyBoZXJlXHJcblx0XHRjb25zdCB0ZXh0VXBUb0N1cnNvciA9IGxpbmUudGV4dC5zbGljZSgwLCBwb3MtIGxpbmUuZnJvbSkudHJpbSgpO1xyXG5cdFx0Y29uc3Qgd29yZHMgPSB0ZXh0VXBUb0N1cnNvci5zcGxpdCgvKFtcXHMsXFxbXFxdKCl7fTtdfC0tXFwrXFwrfC0tXFwrfC0tKSsvKTtcclxuXHRcdGNvbnN0IHdvcmQ9d29yZHNbd29yZHMubGVuZ3RoIC0gMV18fCcnO1xyXG5cdFx0Y29uc29sZS5sb2cod29yZClcclxuXHRcdC8qIENoZWNrcyB0aGF0IG5lZWQgdG8gYmUgbWFkZVxyXG5cdFx0MS4gSW4gd2hhdCBjb21tYW5kIGFyZSB3ZSBpbiBpZiBhbnkuXHJcblx0XHQyLiBBcmUgd2UgaW5wdXR0aW5nIGEgVmFyaWFibGUgYSBjb29yZGluYXRlIG9yIGZvcm1hdHRpbmcuXHJcblx0XHQzLiBpZiBGb3JtYXR0aW5nIEFyZSB3ZSBzdGFydGluZyB0byB0eXBlIGEgY29tbWFuZCBvciBhcmUgd2UgaW5wdXR0aW5nIGEgdmFsdWUgdG8gYSBjb21tYW5kXHJcblx0XHQqL1xyXG5cdFx0cmV0dXJuIHdvcmRzW3dvcmRzLmxlbmd0aCAtIDFdIHx8IFwiXCI7XHJcblx0fVxyXG5cdGdldENvZGVCbG9ja1RleHQoY3R4OiBDb250ZXh0LHZpZXc6IEVkaXRvclZpZXcpe1xyXG5cdFx0Y29uc3QgZG9jID0gdmlldy5zdGF0ZS5kb2M7XHJcblx0XHRjb25zdCB7IG51bWJlciB9ID0gZG9jLmxpbmVBdChjdHgucG9zKTtcclxuXHJcblx0XHRjb25zdCBiZWZvcmVMaW5lID0gZmluZExpbmUodmlldy5zdGF0ZSxudW1iZXIsLTEsJ2BgYCcpO1xyXG5cdFx0Y29uc3QgYWZ0ZXJMaW5lID0gIGZpbmRMaW5lKHZpZXcuc3RhdGUsbnVtYmVyLDEsJ2BgYCcpOztcclxuXHRcdGlmICghYmVmb3JlTGluZSB8fCAhYWZ0ZXJMaW5lKSByZXR1cm4gbnVsbDtcclxuXHRcdGNvbnN0IGJldHdlZW5UZXh0ID0gZG9jLnNsaWNlU3RyaW5nKGJlZm9yZUxpbmUudG8sIGFmdGVyTGluZS5mcm9tKS50cmltKCk7XHJcblx0XHRjb25zdCByZWxhdGl2ZVBvcyA9IGN0eC5wb3MgLSBiZWZvcmVMaW5lLnRvO1xyXG5cdFx0cmV0dXJuIGJldHdlZW5UZXh0XHJcblx0fVxyXG59XHJcblxyXG5jb25zdCBmaW5kTGluZSA9IChzdGF0ZTogRWRpdG9yU3RhdGUsIGxpbmVOdW1iZXI6IG51bWJlcixkaXI6IG51bWJlciwgc3RhcnRzV2l0aDogc3RyaW5nKSA9PiB7XHJcblx0Y29uc3Qge2RvY309c3RhdGVcclxuXHRmb3IgKGxldCBpID0gbGluZU51bWJlciArIGRpcjsgaSA+IDAgJiYgaSA8PSBkb2MubGluZXM7IGkgKz0gZGlyKSB7XHJcblx0Y29uc3QgbGluZSA9IGRvYy5saW5lKGkpLnRleHQudHJpbSgpO1xyXG5cdGlmIChsaW5lLnN0YXJ0c1dpdGgoc3RhcnRzV2l0aCkpIHJldHVybiBkb2MubGluZShpKTtcclxuXHR9XHJcblx0cmV0dXJuIG51bGw7XHJcbn07XHJcblxyXG5leHBvcnQgY2xhc3MgU3VnZ2VzdG9yIHtcclxuXHRwcml2YXRlIHRyaWdnZXI6IFN1Z2dlc3RvclRyaWdnZXI7XHJcblx0c2VsZWN0aW9uSW5kZXg6IG51bWJlcjtcclxuXHRwcml2YXRlIGNvbnRleHQ6IENvbnRleHQ7XHJcblx0aXNTdWdnZXN0ZXJEZXBsb3llZDogYm9vbGVhbj1mYWxzZTtcclxuXHJcblx0ZGVwbG95U3VnZ2VzdG9yKGNvbnRleHQ6IENvbnRleHQsdmlldzogRWRpdG9yVmlldyl7XHJcblx0XHRjb25zb2xlLmxvZyhcInNqZHNqZFwiKVxyXG5cdFx0dGhpcy5yZW1vdmVTdWdnZXN0b3IoKVxyXG5cdFx0dGhpcy5jb250ZXh0PWNvbnRleHQ7XHJcblx0XHRjb25zdCBzdWdnZXN0aW9ucz10aGlzLmdldFN1Z2dlc3Rpb25zKHZpZXcpXHJcblx0XHRpZihzdWdnZXN0aW9ucy5sZW5ndGg8MSlyZXR1cm47XHJcblxyXG5cdFx0Y29uc3Qgc3VnZ2VzdGlvbkRyb3Bkb3duID0gY3JlYXRlRmxvYXRpbmdTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnMsdmlldywgdGhpcy5jb250ZXh0LnBvcyk7XHJcblx0XHRpZiAoIXN1Z2dlc3Rpb25Ecm9wZG93bikgcmV0dXJuO1xyXG5cdFx0ZG9jdW1lbnQuYm9keS5hcHBlbmRDaGlsZChzdWdnZXN0aW9uRHJvcGRvd24pO1xyXG5cdFx0dGhpcy5pc1N1Z2dlc3RlckRlcGxveWVkPXRydWU7XHJcblx0XHR0aGlzLnNlbGVjdGlvbkluZGV4PTA7XHJcblx0XHR0aGlzLnVwZGF0ZVNlbGVjdGlvbih0aGlzLmdldEFsbGRyb3Bkb3duSXRlbXMoKSk7XHJcblxyXG5cdH1cclxuXHR1cGRhdGVTdWdnZXN0b3JQb3NpdGlvbigpe1xyXG5cclxuXHR9XHJcblxyXG5cdHJlbW92ZVN1Z2dlc3RvcigpIHtcclxuXHRcdGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIikuZm9yRWFjaChub2RlID0+IG5vZGUucmVtb3ZlKCkpO1xyXG5cdFx0ZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIik/LnJlbW92ZSgpXHJcblx0XHR0aGlzLmlzU3VnZ2VzdGVyRGVwbG95ZWQ9ZmFsc2U7XHJcblx0fVxyXG5cclxuXHRnZXRBbGxkcm9wZG93bkl0ZW1zKCl7cmV0dXJuIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIil9XHJcblx0cHJpdmF0ZSBkcm9wZG93bmlmQW55RGVwbG95ZWQoKXtyZXR1cm4gZG9jdW1lbnQuYm9keS5xdWVyeVNlbGVjdG9yKFwiLnN1Z2dlc3Rpb24tZHJvcGRvd25cIil9XHJcblxyXG5cdHByaXZhdGUgaGFuZGxlRHJvcGRvd25OYXZpZ2F0aW9uKGV2ZW50OiBLZXlib2FyZEV2ZW50LHZpZXc6RWRpdG9yVmlldykge1xyXG5cdFx0Y29uc3QgZHJvcGRvd24gPSB0aGlzLmRyb3Bkb3duaWZBbnlEZXBsb3llZCgpO1xyXG5cdFx0aWYgKCFkcm9wZG93biB8fCB0aGlzLnNlbGVjdGlvbkluZGV4ID09PSB1bmRlZmluZWQpIHJldHVybjtcclxuXHRcclxuXHRcdGNvbnN0IGl0ZW1zID0gdGhpcy5nZXRBbGxkcm9wZG93bkl0ZW1zKCk7XHJcblxyXG5cdFx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xyXG5cdFx0XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIGdldFN1Z2dlc3Rpb25zKHZpZXc6IEVkaXRvclZpZXcpIHtcclxuXHRcdHRoaXMudHJpZ2dlcj1uZXcgU3VnZ2VzdG9yVHJpZ2dlcih0aGlzLmNvbnRleHQsIHZpZXcpXHJcblx0XHRjb25zdCBhbGxTdWdnZXN0aW9ucyA9IGdldFRpa3pTdWdnZXN0aW9ucygpLm1hcChzID0+IHMudHJpZ2dlcnx8cy5yZXBsYWNlbWVudCk7XHJcblx0XHJcblx0XHRjb25zdCBmaWx0ZXJlZFN1Z2dlc3Rpb25zID0gYWxsU3VnZ2VzdGlvbnMuZmlsdGVyKChzdWdnZXN0aW9uKSA9PlxyXG5cdFx0XHRzdWdnZXN0aW9uLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCh0aGlzLnRyaWdnZXIudGV4dC50b0xvd2VyQ2FzZSgpKVxyXG5cdFx0KTtcclxuXHRcclxuXHRcdGNvbnN0IHNvcnRlZFN1Z2dlc3Rpb25zID0gZmlsdGVyZWRTdWdnZXN0aW9ucy5zb3J0KChhLCBiKSA9PiB7XHJcblx0XHRcdGNvbnN0IGxvd2VyTGFzdFdvcmQgPSB0aGlzLnRyaWdnZXIudGV4dC50b0xvd2VyQ2FzZSgpO1xyXG5cdFx0XHRjb25zdCBhTG93ZXIgPSBhLnRvTG93ZXJDYXNlKCk7XHJcblx0XHRcdGNvbnN0IGJMb3dlciA9IGIudG9Mb3dlckNhc2UoKTtcclxuXHRcclxuXHJcblx0XHRcdGNvbnN0IGFFeGFjdE1hdGNoID0gYUxvd2VyID09PSBsb3dlckxhc3RXb3JkID8gLTEgOiAwO1xyXG5cdFx0XHRjb25zdCBiRXhhY3RNYXRjaCA9IGJMb3dlciA9PT0gbG93ZXJMYXN0V29yZCA/IC0xIDogMDtcclxuXHRcdFx0aWYgKGFFeGFjdE1hdGNoICE9PSBiRXhhY3RNYXRjaCkgcmV0dXJuIGFFeGFjdE1hdGNoIC0gYkV4YWN0TWF0Y2g7XHJcblx0XHJcblx0XHRcdGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHJldHVybiBhLmxlbmd0aCAtIGIubGVuZ3RoO1xyXG5cdFxyXG5cdFx0XHRyZXR1cm4gYUxvd2VyLmxvY2FsZUNvbXBhcmUoYkxvd2VyKTtcclxuXHRcdH0pO1xyXG5cdFx0cmV0dXJuIHNvcnRlZFN1Z2dlc3Rpb25zO1xyXG5cdH1cclxuXHJcblx0XHJcblxyXG5cdHVwZGF0ZVNlbGVjdGlvbihpdGVtczogTm9kZUxpc3RPZjxFbGVtZW50Pikge1xyXG5cdFx0aXRlbXMuZm9yRWFjaCgoaXRlbSwgaW5kZXgpID0+IHtcclxuXHRcdFx0aWYgKGluZGV4ID09PSB0aGlzLnNlbGVjdGlvbkluZGV4KSB7XHJcblx0XHRcdFx0aXRlbS5jbGFzc0xpc3QuYWRkKFwic2VsZWN0ZWRcIik7XHJcblx0XHRcdFx0aXRlbS5zY3JvbGxJbnRvVmlldyh7IGJsb2NrOiBcIm5lYXJlc3RcIiB9KTtcclxuXHRcdFx0fSBlbHNlIHtcclxuXHRcdFx0XHRpdGVtLmNsYXNzTGlzdC5yZW1vdmUoXCJzZWxlY3RlZFwiKTtcclxuXHRcdFx0fVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRzZWxlY3REcm9wZG93bkl0ZW0oaXRlbTogRWxlbWVudCx2aWV3OiBFZGl0b3JWaWV3KSB7XHJcblx0XHR0aGlzLnJlbW92ZVN1Z2dlc3RvcigpXHJcblx0XHRpZighdGhpcy5jb250ZXh0KXJldHVybiA7XHJcblx0XHRjb25zdCBzZWxlY3RlZFRleHQgPSBpdGVtLnRleHRDb250ZW50IHx8IFwiXCI7XHJcblx0XHRjb25zdCBwb3M9dGhpcy5jb250ZXh0LnBvcztcclxuXHRcdHF1ZXVlU25pcHBldCh2aWV3LHBvcy10aGlzLnRyaWdnZXIudGV4dC5sZW5ndGgscG9zLHNlbGVjdGVkVGV4dClcclxuXHRcdGNvbnN0IHN1Y2Nlc3MgPSBleHBhbmRTbmlwcGV0cyh2aWV3KTtcclxuXHRcdC8vdmlldy5mb2N1cygpO1xyXG5cdFx0Ly9zZXRDdXJzb3IodmlldyxjYWxjdWxhdGVOZXdDdXJzb3JQb3NpdGlvbih0aGlzLnRyaWdnZXIudGV4dCxzZWxlY3RlZFRleHQscG9zKSlcclxuXHRcdGNvbnNvbGUubG9nKGBTZWxlY3RlZDogJHtzZWxlY3RlZFRleHR9YCk7XHJcblx0fVxyXG59XHJcbmZ1bmN0aW9uIGNhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uKHRyaWdnZXJUZXh0OiBzdHJpbmcsIHNlbGVjdGVkVGV4dDogc3RyaW5nLCBvcmlnaW5hbFBvczogbnVtYmVyKTogbnVtYmVyIHtcclxuICAgIGNvbnN0IGxlbmd0aERpZmZlcmVuY2UgPSBzZWxlY3RlZFRleHQubGVuZ3RoIC0gdHJpZ2dlclRleHQubGVuZ3RoO1xyXG4gICAgcmV0dXJuIG9yaWdpbmFsUG9zICsgbGVuZ3RoRGlmZmVyZW5jZTtcclxufVxyXG5cclxuZnVuY3Rpb24gY3JlYXRlRmxvYXRpbmdTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnM6IGFueVtdLGVkaXRvclZpZXc6IEVkaXRvclZpZXcsIHBvc2l0aW9uOiBudW1iZXIpIHtcclxuXHJcbiAgICBjb25zdCBjb29yZGluYXRlcyA9IGVkaXRvclZpZXcuY29vcmRzQXRQb3MocG9zaXRpb24pO1xyXG4gICAgaWYgKCFjb29yZGluYXRlcykgcmV0dXJuO1xyXG5cclxuICAgIGNvbnN0IHN1Z2dlc3Rpb25Ecm9wZG93biA9IGNyZWF0ZVN1Z2dlc3Rpb25Ecm9wZG93bihzdWdnZXN0aW9ucyk7XHJcblxyXG4gICAgc3VnZ2VzdGlvbkRyb3Bkb3duLnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xyXG4gICAgc3VnZ2VzdGlvbkRyb3Bkb3duLnN0eWxlLmxlZnQgPSBgJHtjb29yZGluYXRlcy5sZWZ0fXB4YDtcclxuICAgIHN1Z2dlc3Rpb25Ecm9wZG93bi5zdHlsZS50b3AgPSBgJHtjb29yZGluYXRlcy5ib3R0b219cHhgO1xyXG5cdHJldHVybiBzdWdnZXN0aW9uRHJvcGRvd247XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBjcmVhdGVTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnM6IHN0cmluZ1tdKSB7XHJcbiAgICBjb25zdCBkcm9wZG93bkNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcbiAgICBkcm9wZG93bkNvbnRhaW5lci5jbGFzc05hbWUgPSBcInN1Z2dlc3Rpb24tZHJvcGRvd25cIjtcclxuXHJcbiAgICBzdWdnZXN0aW9ucy5mb3JFYWNoKChzdWdnZXN0aW9uKSA9PiB7XHJcbiAgICAgICAgY29uc3QgaXRlbSA9IGNyZWF0ZVN1Z2dlc3Rpb25JdGVtKHN1Z2dlc3Rpb24pXHJcblx0XHRkcm9wZG93bkNvbnRhaW5lci5hcHBlbmRDaGlsZChpdGVtKVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGRyb3Bkb3duQ29udGFpbmVyO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjcmVhdGVTdWdnZXN0aW9uSXRlbShkaXNwbGF5VGV4dDogc3RyaW5nKTogSFRNTEVsZW1lbnQge1xyXG5cdC8vIENyZWF0ZSB0aGUgb3V0ZXIgc3VnZ2VzdGlvbiBpdGVtIGNvbnRhaW5lclxyXG5cdGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XHJcblx0Y29udGFpbmVyLmNsYXNzTGlzdC5hZGQoXCJzdWdnZXN0aW9uLWl0ZW1cIik7XHJcblx0Y29udGFpbmVyLmlubmVyVGV4dD1kaXNwbGF5VGV4dFxyXG4gIFx0cmV0dXJuIGNvbnRhaW5lclxyXG5cdC8vIENyZWF0ZSB0aGUgaWNvbiBjb250YWluZXJcclxuXHRjb25zdCBpY29uID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuXHRpY29uLmNsYXNzTGlzdC5hZGQoXCJpY29uXCIpO1xyXG5cdGljb24udGV4dENvbnRlbnQgPSBcIsaSXCI7IC8vIFBsYWNlaG9sZGVyIGljb24gY29udGVudFxyXG4gIFxyXG5cdC8vIENyZWF0ZSB0aGUgZGV0YWlscyBjb250YWluZXJcclxuXHRjb25zdCBkZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcclxuXHRkZXRhaWxzLmNsYXNzTGlzdC5hZGQoXCJkZXRhaWxzXCIpO1xyXG4gIFxyXG5cdC8vIEFkZCBhIG5hbWUgc3BhbiB0byBkZXRhaWxzXHJcblx0Y29uc3QgbmFtZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzcGFuXCIpO1xyXG5cdG5hbWUuY2xhc3NMaXN0LmFkZChcIm5hbWVcIik7XHJcblx0bmFtZS50ZXh0Q29udGVudCA9IFwiZnVuY3Rpb25cIjsgLy8gUGxhY2Vob2xkZXIgbmFtZSBjb250ZW50XHJcbiAgXHJcblx0Ly8gQWRkIGEgdHlwZSBzcGFuIHRvIGRldGFpbHNcclxuXHRjb25zdCB0eXBlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XHJcblx0dHlwZS5jbGFzc0xpc3QuYWRkKFwidHlwZVwiKTtcclxuXHR0eXBlLnRleHRDb250ZW50ID0gXCJLZXl3b3JkXCI7IC8vIFBsYWNlaG9sZGVyIHR5cGUgY29udGVudFxyXG4gIFxyXG5cdC8vIEFwcGVuZCBuYW1lIGFuZCB0eXBlIHRvIGRldGFpbHNcclxuXHRkZXRhaWxzLmFwcGVuZENoaWxkKG5hbWUpO1xyXG5cdGRldGFpbHMuYXBwZW5kQ2hpbGQodHlwZSk7XHJcbiAgXHJcblx0Ly8gQXBwZW5kIGljb24gYW5kIGRldGFpbHMgdG8gdGhlIGNvbnRhaW5lclxyXG5cdGNvbnRhaW5lci5hcHBlbmRDaGlsZChpY29uKTtcclxuXHRjb250YWluZXIuYXBwZW5kQ2hpbGQoZGV0YWlscyk7XHJcbiAgXHJcblx0cmV0dXJuIGNvbnRhaW5lcjtcclxufVxyXG5cclxuXHJcblxyXG5cclxuXHJcblxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGdldENoYXJhY3RlckF0UG9zKHZpZXdPclN0YXRlOiBFZGl0b3JWaWV3IHwgRWRpdG9yU3RhdGUsIHBvczogbnVtYmVyKSB7XHJcblx0Y29uc3Qgc3RhdGUgPSB2aWV3T3JTdGF0ZSBpbnN0YW5jZW9mIEVkaXRvclZpZXcgPyB2aWV3T3JTdGF0ZS5zdGF0ZSA6IHZpZXdPclN0YXRlO1xyXG5cdGNvbnN0IGRvYyA9IHN0YXRlLmRvYztcclxuXHRyZXR1cm4gZG9jLnNsaWNlKHBvcywgcG9zKzEpLnRvU3RyaW5nKCk7XHJcbn1cclxuXHJcbiJdfQ==