import { getTikzSuggestions, } from "./utilities";
import { EditorView, } from "@codemirror/view";
import { expandSnippets } from "./snippets/snippet_management";
import { queueSnippet } from "./snippets/codemirror/snippet_queue_state_field";
import { BasicTikzTokens } from "./tikzjax/interpret/tokenizeTikzjax";
class SuggestorTrigger {
    text;
    codeBlockText;
    constructor(ctx, view) {
        this.text = this.getCurrentLineText(ctx.pos, view);
        const source = this.getCodeBlockText(ctx, view);
        if (!source)
            return;
        const tokens = new BasicTikzTokens(source);
        console.log(tokens);
    }
    setTrigger(trigger) {
    }
    getCurrentLineText(pos, view) {
        const line = view.state.doc.lineAt(pos);
        //const cursorOffsetInLine = (pos+2) - line.from;I don't know why I had this here
        const textUpToCursor = line.text.slice(0, pos - line.from).trim();
        const words = textUpToCursor.split(/([\s,\[\](){};]|--\+\+|--\+|--)+/);
        const word = words[words.length - 1] || '';
        console.log(word);
        /* Checks that need to be made
        1. In what command are we in if any.
        2. Are we inputting a Variable a coordinate or formatting.
        3. if Formatting Are we starting to type a command or are we inputting a value to a command
        */
        return words[words.length - 1] || "";
    }
    getCodeBlockText(ctx, view) {
        const doc = view.state.doc;
        const { number } = doc.lineAt(ctx.pos);
        const beforeLine = findLine(view.state, number, -1, '```');
        const afterLine = findLine(view.state, number, 1, '```');
        ;
        if (!beforeLine || !afterLine)
            return null;
        const betweenText = doc.sliceString(beforeLine.to, afterLine.from).trim();
        const relativePos = ctx.pos - beforeLine.to;
        return betweenText;
    }
}
const findLine = (state, lineNumber, dir, startsWith) => {
    const { doc } = state;
    for (let i = lineNumber + dir; i > 0 && i <= doc.lines; i += dir) {
        const line = doc.line(i).text.trim();
        if (line.startsWith(startsWith))
            return doc.line(i);
    }
    return null;
};
export class Suggestor {
    trigger;
    selectionIndex;
    context;
    isSuggesterDeployed = false;
    deploySuggestor(context, view) {
        console.log("sjdsjd");
        this.removeSuggestor();
        this.context = context;
        const suggestions = this.getSuggestions(view);
        if (suggestions.length < 1)
            return;
        const suggestionDropdown = createFloatingSuggestionDropdown(suggestions, view, this.context.pos);
        if (!suggestionDropdown)
            return;
        document.body.appendChild(suggestionDropdown);
        this.isSuggesterDeployed = true;
        this.selectionIndex = 0;
        this.updateSelection(this.getAlldropdownItems());
    }
    updateSuggestorPosition() {
    }
    removeSuggestor() {
        document.body.querySelectorAll(".suggestion-item").forEach(node => node.remove());
        document.body.querySelector(".suggestion-dropdown")?.remove();
        this.isSuggesterDeployed = false;
    }
    getAlldropdownItems() { return document.body.querySelectorAll(".suggestion-item"); }
    dropdownifAnyDeployed() { return document.body.querySelector(".suggestion-dropdown"); }
    handleDropdownNavigation(event, view) {
        const dropdown = this.dropdownifAnyDeployed();
        if (!dropdown || this.selectionIndex === undefined)
            return;
        const items = this.getAlldropdownItems();
        if (items.length === 0)
            return;
    }
    getSuggestions(view) {
        this.trigger = new SuggestorTrigger(this.context, view);
        const allSuggestions = getTikzSuggestions().map(s => s.trigger || s.replacement);
        const filteredSuggestions = allSuggestions.filter((suggestion) => suggestion.toLowerCase().startsWith(this.trigger.text.toLowerCase()));
        const sortedSuggestions = filteredSuggestions.sort((a, b) => {
            const lowerLastWord = this.trigger.text.toLowerCase();
            const aLower = a.toLowerCase();
            const bLower = b.toLowerCase();
            const aExactMatch = aLower === lowerLastWord ? -1 : 0;
            const bExactMatch = bLower === lowerLastWord ? -1 : 0;
            if (aExactMatch !== bExactMatch)
                return aExactMatch - bExactMatch;
            if (a.length !== b.length)
                return a.length - b.length;
            return aLower.localeCompare(bLower);
        });
        return sortedSuggestions;
    }
    updateSelection(items) {
        items.forEach((item, index) => {
            if (index === this.selectionIndex) {
                item.classList.add("selected");
                item.scrollIntoView({ block: "nearest" });
            }
            else {
                item.classList.remove("selected");
            }
        });
    }
    selectDropdownItem(item, view) {
        this.removeSuggestor();
        if (!this.context)
            return;
        const selectedText = item.textContent || "";
        const pos = this.context.pos;
        queueSnippet(view, pos - this.trigger.text.length, pos, selectedText);
        const success = expandSnippets(view);
        //view.focus();
        //setCursor(view,calculateNewCursorPosition(this.trigger.text,selectedText,pos))
        console.log(`Selected: ${selectedText}`);
    }
}
function calculateNewCursorPosition(triggerText, selectedText, originalPos) {
    const lengthDifference = selectedText.length - triggerText.length;
    return originalPos + lengthDifference;
}
function createFloatingSuggestionDropdown(suggestions, editorView, position) {
    const coordinates = editorView.coordsAtPos(position);
    if (!coordinates)
        return;
    const suggestionDropdown = createSuggestionDropdown(suggestions);
    suggestionDropdown.style.position = "absolute";
    suggestionDropdown.style.left = `${coordinates.left}px`;
    suggestionDropdown.style.top = `${coordinates.bottom}px`;
    return suggestionDropdown;
}
function createSuggestionDropdown(suggestions) {
    const dropdownContainer = document.createElement("div");
    dropdownContainer.className = "suggestion-dropdown";
    suggestions.forEach((suggestion) => {
        const item = createSuggestionItem(suggestion);
        dropdownContainer.appendChild(item);
    });
    return dropdownContainer;
}
function createSuggestionItem(displayText) {
    // Create the outer suggestion item container
    const container = document.createElement("div");
    container.classList.add("suggestion-item");
    container.innerText = displayText;
    return container;
    // Create the icon container
    const icon = document.createElement("div");
    icon.classList.add("icon");
    icon.textContent = "Æ’"; // Placeholder icon content
    // Create the details container
    const details = document.createElement("div");
    details.classList.add("details");
    // Add a name span to details
    const name = document.createElement("span");
    name.classList.add("name");
    name.textContent = "function"; // Placeholder name content
    // Add a type span to details
    const type = document.createElement("span");
    type.classList.add("type");
    type.textContent = "Keyword"; // Placeholder type content
    // Append name and type to details
    details.appendChild(name);
    details.appendChild(type);
    // Append icon and details to the container
    container.appendChild(icon);
    container.appendChild(details);
    return container;
}
export function getCharacterAtPos(viewOrState, pos) {
    const state = viewOrState instanceof EditorView ? viewOrState.state : viewOrState;
    const doc = state.doc;
    return doc.slice(pos, pos + 1).toString();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3VnZ2VzdG9yLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3N1Z2dlc3Rvci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsa0JBQWtCLEdBQUksTUFBTSxhQUFhLENBQUM7QUFDbkQsT0FBTyxFQUFFLFVBQVUsR0FBRyxNQUFNLGtCQUFrQixDQUFDO0FBTy9DLE9BQU8sRUFBRSxjQUFjLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUMvRCxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0saURBQWlELENBQUM7QUFDL0UsT0FBTyxFQUFrQixlQUFlLEVBQUUsTUFBTSxxQ0FBcUMsQ0FBQztBQUd0RixNQUFNLGdCQUFnQjtJQUNyQixJQUFJLENBQVE7SUFDWixhQUFhLENBQVM7SUFDdEIsWUFBWSxHQUFZLEVBQUUsSUFBZ0I7UUFDekMsSUFBSSxDQUFDLElBQUksR0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxJQUFJLENBQUMsQ0FBQTtRQUNoRCxNQUFNLE1BQU0sR0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxFQUFDLElBQUksQ0FBQyxDQUFBO1FBQzVDLElBQUcsQ0FBQyxNQUFNO1lBQUMsT0FBTTtRQUNqQixNQUFNLE1BQU0sR0FBQyxJQUFJLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQTtRQUN4QyxPQUFPLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQ3BCLENBQUM7SUFDRCxVQUFVLENBQUMsT0FBZTtJQUUxQixDQUFDO0lBQ0Qsa0JBQWtCLENBQUMsR0FBVyxFQUFFLElBQWdCO1FBQy9DLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUN4QyxpRkFBaUY7UUFDakYsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFF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LFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUUxQiwyQ0FBMkM7SUFDM0MsU0FBUyxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUM1QixTQUFTLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBRS9CLE9BQU8sU0FBUyxDQUFDO0FBQ2xCLENBQUM7QUFRRCxNQUFNLFVBQVUsaUJBQWlCLENBQUMsV0FBcUMsRUFBRSxHQUFXO0lBQ25GLE1BQU0sS0FBSyxHQUFHLFdBQVcsWUFBWSxVQUFVLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQztJQUNsRixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQ3RCLE9BQU8sR0FBRyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxHQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ3pDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRUaWt6U3VnZ2VzdGlvbnMsICB9IGZyb20gXCIuL3V0aWxpdGllc1wiO1xuaW1wb3J0IHsgRWRpdG9yVmlldywgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xuaW1wb3J0IHsgc3ludGF4VHJlZSB9IGZyb20gXCJAY29kZW1pcnJvci9sYW5ndWFnZVwiO1xuaW1wb3J0IHsgRWRpdG9yU3RhdGV9IGZyb20gXCJAY29kZW1pcnJvci9zdGF0ZVwiO1xuaW1wb3J0IHsgU3ludGF4Tm9kZSwgVHJlZUN1cnNvciB9IGZyb20gXCJAbGV6ZXIvY29tbW9uXCI7XG5pbXBvcnQgTW9zaGUgZnJvbSBcIi4vbWFpblwiO1xuaW1wb3J0IHsgQ29udGV4dCB9IGZyb20gXCIuL3V0aWxzL2NvbnRleHRcIjtcbmltcG9ydCB7IHJlcGxhY2VSYW5nZSwgc2V0Q3Vyc29yIH0gZnJvbSBcIi4vZWRpdG9yIHV0aWxpdGllcy9lZGl0b3JfdXRpbHNcIjtcbmltcG9ydCB7IGV4cGFuZFNuaXBwZXRzIH0gZnJvbSBcIi4vc25pcHBldHMvc25pcHBldF9tYW5hZ2VtZW50XCI7XG5pbXBvcnQgeyBxdWV1ZVNuaXBwZXQgfSBmcm9tIFwiLi9zbmlwcGV0cy9jb2RlbWlycm9yL3NuaXBwZXRfcXVldWVfc3RhdGVfZmllbGRcIjtcbmltcG9ydCB7IEJhc2ljVGlrelRva2VuLCBCYXNpY1Rpa3pUb2tlbnMgfSBmcm9tIFwiLi90aWt6amF4L2ludGVycHJldC90b2tlbml6ZVRpa3pqYXhcIjtcblxuXG5jbGFzcyBTdWdnZXN0b3JUcmlnZ2Vye1xuXHR0ZXh0OiBzdHJpbmdcblx0Y29kZUJsb2NrVGV4dDogc3RyaW5nO1xuXHRjb25zdHJ1Y3RvcihjdHg6IENvbnRleHQsIHZpZXc6IEVkaXRvclZpZXcpe1xuXHRcdHRoaXMudGV4dD10aGlzLmdldEN1cnJlbnRMaW5lVGV4dChjdHgucG9zLCB2aWV3KVxuXHRcdGNvbnN0IHNvdXJjZT10aGlzLmdldENvZGVCbG9ja1RleHQoY3R4LHZpZXcpXG5cdFx0aWYoIXNvdXJjZSlyZXR1cm5cblx0XHRjb25zdCB0b2tlbnM9bmV3IEJhc2ljVGlrelRva2Vucyhzb3VyY2UpXG5cdFx0Y29uc29sZS5sb2codG9rZW5zKVxuXHR9XG5cdHNldFRyaWdnZXIodHJpZ2dlcjogc3RyaW5nKXtcblxuXHR9XG5cdGdldEN1cnJlbnRMaW5lVGV4dChwb3M6IG51bWJlciwgdmlldzogRWRpdG9yVmlldyk6IHN0cmluZyB7XG5cdFx0Y29uc3QgbGluZSA9IHZpZXcuc3RhdGUuZG9jLmxpbmVBdChwb3MpO1xuXHRcdC8vY29uc3QgY3Vyc29yT2Zmc2V0SW5MaW5lID0gKHBvcysyKSAtIGxpbmUuZnJvbTtJIGRvbid0IGtub3cgd2h5IEkgaGFkIHRoaXMgaGVyZVxuXHRcdGNvbnN0IHRleHRVcFRvQ3Vyc29yID0gbGluZS50ZXh0LnNsaWNlKDAsIHBvcy0gbGluZS5mcm9tKS50cmltKCk7XG5cdFx0Y29uc3Qgd29yZHMgPSB0ZXh0VXBUb0N1cnNvci5zcGxpdCgvKFtcXHMsXFxbXFxdKCl7fTtdfC0tXFwrXFwrfC0tXFwrfC0tKSsvKTtcblx0XHRjb25zdCB3b3JkPXdvcmRzW3dvcmRzLmxlbmd0aCAtIDFdfHwnJztcblx0XHRjb25zb2xlLmxvZyh3b3JkKVxuXHRcdC8qIENoZWNrcyB0aGF0IG5lZWQgdG8gYmUgbWFkZVxuXHRcdDEuIEluIHdoYXQgY29tbWFuZCBhcmUgd2UgaW4gaWYgYW55LlxuXHRcdDIuIEFyZSB3ZSBpbnB1dHRpbmcgYSBWYXJpYWJsZSBhIGNvb3JkaW5hdGUgb3IgZm9ybWF0dGluZy5cblx0XHQzLiBpZiBGb3JtYXR0aW5nIEFyZSB3ZSBzdGFydGluZyB0byB0eXBlIGEgY29tbWFuZCBvciBhcmUgd2UgaW5wdXR0aW5nIGEgdmFsdWUgdG8gYSBjb21tYW5kXG5cdFx0Ki9cblx0XHRyZXR1cm4gd29yZHNbd29yZHMubGVuZ3RoIC0gMV0gfHwgXCJcIjtcblx0fVxuXHRnZXRDb2RlQmxvY2tUZXh0KGN0eDogQ29udGV4dCx2aWV3OiBFZGl0b3JWaWV3KXtcblx0XHRjb25zdCBkb2MgPSB2aWV3LnN0YXRlLmRvYztcblx0XHRjb25zdCB7IG51bWJlciB9ID0gZG9jLmxpbmVBdChjdHgucG9zKTtcblxuXHRcdGNvbnN0IGJlZm9yZUxpbmUgPSBmaW5kTGluZSh2aWV3LnN0YXRlLG51bWJlciwtMSwnYGBgJyk7XG5cdFx0Y29uc3QgYWZ0ZXJMaW5lID0gIGZpbmRMaW5lKHZpZXcuc3RhdGUsbnVtYmVyLDEsJ2BgYCcpOztcblx0XHRpZiAoIWJlZm9yZUxpbmUgfHwgIWFmdGVyTGluZSkgcmV0dXJuIG51bGw7XG5cdFx0Y29uc3QgYmV0d2VlblRleHQgPSBkb2Muc2xpY2VTdHJpbmcoYmVmb3JlTGluZS50bywgYWZ0ZXJMaW5lLmZyb20pLnRyaW0oKTtcblx0XHRjb25zdCByZWxhdGl2ZVBvcyA9IGN0eC5wb3MgLSBiZWZvcmVMaW5lLnRvO1xuXHRcdHJldHVybiBiZXR3ZWVuVGV4dFxuXHR9XG59XG5cbmNvbnN0IGZpbmRMaW5lID0gKHN0YXRlOiBFZGl0b3JTdGF0ZSwgbGluZU51bWJlcjogbnVtYmVyLGRpcjogbnVtYmVyLCBzdGFydHNXaXRoOiBzdHJpbmcpID0+IHtcblx0Y29uc3Qge2RvY309c3RhdGVcblx0Zm9yIChsZXQgaSA9IGxpbmVOdW1iZXIgKyBkaXI7IGkgPiAwICYmIGkgPD0gZG9jLmxpbmVzOyBpICs9IGRpcikge1xuXHRjb25zdCBsaW5lID0gZG9jLmxpbmUoaSkudGV4dC50cmltKCk7XG5cdGlmIChsaW5lLnN0YXJ0c1dpdGgoc3RhcnRzV2l0aCkpIHJldHVybiBkb2MubGluZShpKTtcblx0fVxuXHRyZXR1cm4gbnVsbDtcbn07XG5cbmV4cG9ydCBjbGFzcyBTdWdnZXN0b3Ige1xuXHRwcml2YXRlIHRyaWdnZXI6IFN1Z2dlc3RvclRyaWdnZXI7XG5cdHNlbGVjdGlvbkluZGV4OiBudW1iZXI7XG5cdHByaXZhdGUgY29udGV4dDogQ29udGV4dDtcblx0aXNTdWdnZXN0ZXJEZXBsb3llZDogYm9vbGVhbj1mYWxzZTtcblxuXHRkZXBsb3lTdWdnZXN0b3IoY29udGV4dDogQ29udGV4dCx2aWV3OiBFZGl0b3JWaWV3KXtcblx0XHRjb25zb2xlLmxvZyhcInNqZHNqZFwiKVxuXHRcdHRoaXMucmVtb3ZlU3VnZ2VzdG9yKClcblx0XHR0aGlzLmNvbnRleHQ9Y29udGV4dDtcblx0XHRjb25zdCBzdWdnZXN0aW9ucz10aGlzLmdldFN1Z2dlc3Rpb25zKHZpZXcpXG5cdFx0aWYoc3VnZ2VzdGlvbnMubGVuZ3RoPDEpcmV0dXJuO1xuXG5cdFx0Y29uc3Qgc3VnZ2VzdGlvbkRyb3Bkb3duID0gY3JlYXRlRmxvYXRpbmdTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnMsdmlldywgdGhpcy5jb250ZXh0LnBvcyk7XG5cdFx0aWYgKCFzdWdnZXN0aW9uRHJvcGRvd24pIHJldHVybjtcblx0XHRkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHN1Z2dlc3Rpb25Ecm9wZG93bik7XG5cdFx0dGhpcy5pc1N1Z2dlc3RlckRlcGxveWVkPXRydWU7XG5cdFx0dGhpcy5zZWxlY3Rpb25JbmRleD0wO1xuXHRcdHRoaXMudXBkYXRlU2VsZWN0aW9uKHRoaXMuZ2V0QWxsZHJvcGRvd25JdGVtcygpKTtcblxuXHR9XG5cdHVwZGF0ZVN1Z2dlc3RvclBvc2l0aW9uKCl7XG5cblx0fVxuXG5cdHJlbW92ZVN1Z2dlc3RvcigpIHtcblx0XHRkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3VnZ2VzdGlvbi1pdGVtXCIpLmZvckVhY2gobm9kZSA9PiBub2RlLnJlbW92ZSgpKTtcblx0XHRkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3IoXCIuc3VnZ2VzdGlvbi1kcm9wZG93blwiKT8ucmVtb3ZlKClcblx0XHR0aGlzLmlzU3VnZ2VzdGVyRGVwbG95ZWQ9ZmFsc2U7XG5cdH1cblxuXHRnZXRBbGxkcm9wZG93bkl0ZW1zKCl7cmV0dXJuIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvckFsbChcIi5zdWdnZXN0aW9uLWl0ZW1cIil9XG5cdHByaXZhdGUgZHJvcGRvd25pZkFueURlcGxveWVkKCl7cmV0dXJuIGRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcihcIi5zdWdnZXN0aW9uLWRyb3Bkb3duXCIpfVxuXG5cdHByaXZhdGUgaGFuZGxlRHJvcGRvd25OYXZpZ2F0aW9uKGV2ZW50OiBLZXlib2FyZEV2ZW50LHZpZXc6RWRpdG9yVmlldykge1xuXHRcdGNvbnN0IGRyb3Bkb3duID0gdGhpcy5kcm9wZG93bmlmQW55RGVwbG95ZWQoKTtcblx0XHRpZiAoIWRyb3Bkb3duIHx8IHRoaXMuc2VsZWN0aW9uSW5kZXggPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xuXHRcblx0XHRjb25zdCBpdGVtcyA9IHRoaXMuZ2V0QWxsZHJvcGRvd25JdGVtcygpO1xuXG5cdFx0aWYgKGl0ZW1zLmxlbmd0aCA9PT0gMCkgcmV0dXJuO1xuXHRcdFxuXHR9XG5cblx0cHJpdmF0ZSBnZXRTdWdnZXN0aW9ucyh2aWV3OiBFZGl0b3JWaWV3KSB7XG5cdFx0dGhpcy50cmlnZ2VyPW5ldyBTdWdnZXN0b3JUcmlnZ2VyKHRoaXMuY29udGV4dCwgdmlldylcblx0XHRjb25zdCBhbGxTdWdnZXN0aW9ucyA9IGdldFRpa3pTdWdnZXN0aW9ucygpLm1hcChzID0+IHMudHJpZ2dlcnx8cy5yZXBsYWNlbWVudCk7XG5cdFxuXHRcdGNvbnN0IGZpbHRlcmVkU3VnZ2VzdGlvbnMgPSBhbGxTdWdnZXN0aW9ucy5maWx0ZXIoKHN1Z2dlc3Rpb24pID0+XG5cdFx0XHRzdWdnZXN0aW9uLnRvTG93ZXJDYXNlKCkuc3RhcnRzV2l0aCh0aGlzLnRyaWdnZXIudGV4dC50b0xvd2VyQ2FzZSgpKVxuXHRcdCk7XG5cdFxuXHRcdGNvbnN0IHNvcnRlZFN1Z2dlc3Rpb25zID0gZmlsdGVyZWRTdWdnZXN0aW9ucy5zb3J0KChhLCBiKSA9PiB7XG5cdFx0XHRjb25zdCBsb3dlckxhc3RXb3JkID0gdGhpcy50cmlnZ2VyLnRleHQudG9Mb3dlckNhc2UoKTtcblx0XHRcdGNvbnN0IGFMb3dlciA9IGEudG9Mb3dlckNhc2UoKTtcblx0XHRcdGNvbnN0IGJMb3dlciA9IGIudG9Mb3dlckNhc2UoKTtcblx0XG5cblx0XHRcdGNvbnN0IGFFeGFjdE1hdGNoID0gYUxvd2VyID09PSBsb3dlckxhc3RXb3JkID8gLTEgOiAwO1xuXHRcdFx0Y29uc3QgYkV4YWN0TWF0Y2ggPSBiTG93ZXIgPT09IGxvd2VyTGFzdFdvcmQgPyAtMSA6IDA7XG5cdFx0XHRpZiAoYUV4YWN0TWF0Y2ggIT09IGJFeGFjdE1hdGNoKSByZXR1cm4gYUV4YWN0TWF0Y2ggLSBiRXhhY3RNYXRjaDtcblx0XG5cdFx0XHRpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSByZXR1cm4gYS5sZW5ndGggLSBiLmxlbmd0aDtcblx0XG5cdFx0XHRyZXR1cm4gYUxvd2VyLmxvY2FsZUNvbXBhcmUoYkxvd2VyKTtcblx0XHR9KTtcblx0XHRyZXR1cm4gc29ydGVkU3VnZ2VzdGlvbnM7XG5cdH1cblxuXHRcblxuXHR1cGRhdGVTZWxlY3Rpb24oaXRlbXM6IE5vZGVMaXN0T2Y8RWxlbWVudD4pIHtcblx0XHRpdGVtcy5mb3JFYWNoKChpdGVtLCBpbmRleCkgPT4ge1xuXHRcdFx0aWYgKGluZGV4ID09PSB0aGlzLnNlbGVjdGlvbkluZGV4KSB7XG5cdFx0XHRcdGl0ZW0uY2xhc3NMaXN0LmFkZChcInNlbGVjdGVkXCIpO1xuXHRcdFx0XHRpdGVtLnNjcm9sbEludG9WaWV3KHsgYmxvY2s6IFwibmVhcmVzdFwiIH0pO1xuXHRcdFx0fSBlbHNlIHtcblx0XHRcdFx0aXRlbS5jbGFzc0xpc3QucmVtb3ZlKFwic2VsZWN0ZWRcIik7XG5cdFx0XHR9XG5cdFx0fSk7XG5cdH1cblxuXHRzZWxlY3REcm9wZG93bkl0ZW0oaXRlbTogRWxlbWVudCx2aWV3OiBFZGl0b3JWaWV3KSB7XG5cdFx0dGhpcy5yZW1vdmVTdWdnZXN0b3IoKVxuXHRcdGlmKCF0aGlzLmNvbnRleHQpcmV0dXJuIDtcblx0XHRjb25zdCBzZWxlY3RlZFRleHQgPSBpdGVtLnRleHRDb250ZW50IHx8IFwiXCI7XG5cdFx0Y29uc3QgcG9zPXRoaXMuY29udGV4dC5wb3M7XG5cdFx0cXVldWVTbmlwcGV0KHZpZXcscG9zLXRoaXMudHJpZ2dlci50ZXh0Lmxlbmd0aCxwb3Msc2VsZWN0ZWRUZXh0KVxuXHRcdGNvbnN0IHN1Y2Nlc3MgPSBleHBhbmRTbmlwcGV0cyh2aWV3KTtcblx0XHQvL3ZpZXcuZm9jdXMoKTtcblx0XHQvL3NldEN1cnNvcih2aWV3LGNhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uKHRoaXMudHJpZ2dlci50ZXh0LHNlbGVjdGVkVGV4dCxwb3MpKVxuXHRcdGNvbnNvbGUubG9nKGBTZWxlY3RlZDogJHtzZWxlY3RlZFRleHR9YCk7XG5cdH1cbn1cbmZ1bmN0aW9uIGNhbGN1bGF0ZU5ld0N1cnNvclBvc2l0aW9uKHRyaWdnZXJUZXh0OiBzdHJpbmcsIHNlbGVjdGVkVGV4dDogc3RyaW5nLCBvcmlnaW5hbFBvczogbnVtYmVyKTogbnVtYmVyIHtcbiAgICBjb25zdCBsZW5ndGhEaWZmZXJlbmNlID0gc2VsZWN0ZWRUZXh0Lmxlbmd0aCAtIHRyaWdnZXJUZXh0Lmxlbmd0aDtcbiAgICByZXR1cm4gb3JpZ2luYWxQb3MgKyBsZW5ndGhEaWZmZXJlbmNlO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVGbG9hdGluZ1N1Z2dlc3Rpb25Ecm9wZG93bihzdWdnZXN0aW9uczogYW55W10sZWRpdG9yVmlldzogRWRpdG9yVmlldywgcG9zaXRpb246IG51bWJlcikge1xuXG4gICAgY29uc3QgY29vcmRpbmF0ZXMgPSBlZGl0b3JWaWV3LmNvb3Jkc0F0UG9zKHBvc2l0aW9uKTtcbiAgICBpZiAoIWNvb3JkaW5hdGVzKSByZXR1cm47XG5cbiAgICBjb25zdCBzdWdnZXN0aW9uRHJvcGRvd24gPSBjcmVhdGVTdWdnZXN0aW9uRHJvcGRvd24oc3VnZ2VzdGlvbnMpO1xuXG4gICAgc3VnZ2VzdGlvbkRyb3Bkb3duLnN0eWxlLnBvc2l0aW9uID0gXCJhYnNvbHV0ZVwiO1xuICAgIHN1Z2dlc3Rpb25Ecm9wZG93bi5zdHlsZS5sZWZ0ID0gYCR7Y29vcmRpbmF0ZXMubGVmdH1weGA7XG4gICAgc3VnZ2VzdGlvbkRyb3Bkb3duLnN0eWxlLnRvcCA9IGAke2Nvb3JkaW5hdGVzLmJvdHRvbX1weGA7XG5cdHJldHVybiBzdWdnZXN0aW9uRHJvcGRvd247XG59XG5cblxuZnVuY3Rpb24gY3JlYXRlU3VnZ2VzdGlvbkRyb3Bkb3duKHN1Z2dlc3Rpb25zOiBzdHJpbmdbXSkge1xuICAgIGNvbnN0IGRyb3Bkb3duQ29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImRpdlwiKTtcbiAgICBkcm9wZG93bkNvbnRhaW5lci5jbGFzc05hbWUgPSBcInN1Z2dlc3Rpb24tZHJvcGRvd25cIjtcblxuICAgIHN1Z2dlc3Rpb25zLmZvckVhY2goKHN1Z2dlc3Rpb24pID0+IHtcbiAgICAgICAgY29uc3QgaXRlbSA9IGNyZWF0ZVN1Z2dlc3Rpb25JdGVtKHN1Z2dlc3Rpb24pXG5cdFx0ZHJvcGRvd25Db250YWluZXIuYXBwZW5kQ2hpbGQoaXRlbSlcbiAgICB9KTtcblxuICAgIHJldHVybiBkcm9wZG93bkNvbnRhaW5lcjtcbn1cblxuZnVuY3Rpb24gY3JlYXRlU3VnZ2VzdGlvbkl0ZW0oZGlzcGxheVRleHQ6IHN0cmluZyk6IEhUTUxFbGVtZW50IHtcblx0Ly8gQ3JlYXRlIHRoZSBvdXRlciBzdWdnZXN0aW9uIGl0ZW0gY29udGFpbmVyXG5cdGNvbnN0IGNvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG5cdGNvbnRhaW5lci5jbGFzc0xpc3QuYWRkKFwic3VnZ2VzdGlvbi1pdGVtXCIpO1xuXHRjb250YWluZXIuaW5uZXJUZXh0PWRpc3BsYXlUZXh0XG4gIFx0cmV0dXJuIGNvbnRhaW5lclxuXHQvLyBDcmVhdGUgdGhlIGljb24gY29udGFpbmVyXG5cdGNvbnN0IGljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KFwiZGl2XCIpO1xuXHRpY29uLmNsYXNzTGlzdC5hZGQoXCJpY29uXCIpO1xuXHRpY29uLnRleHRDb250ZW50ID0gXCLGklwiOyAvLyBQbGFjZWhvbGRlciBpY29uIGNvbnRlbnRcbiAgXG5cdC8vIENyZWF0ZSB0aGUgZGV0YWlscyBjb250YWluZXJcblx0Y29uc3QgZGV0YWlscyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG5cdGRldGFpbHMuY2xhc3NMaXN0LmFkZChcImRldGFpbHNcIik7XG4gIFxuXHQvLyBBZGQgYSBuYW1lIHNwYW4gdG8gZGV0YWlsc1xuXHRjb25zdCBuYW1lID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNwYW5cIik7XG5cdG5hbWUuY2xhc3NMaXN0LmFkZChcIm5hbWVcIik7XG5cdG5hbWUudGV4dENvbnRlbnQgPSBcImZ1bmN0aW9uXCI7IC8vIFBsYWNlaG9sZGVyIG5hbWUgY29udGVudFxuICBcblx0Ly8gQWRkIGEgdHlwZSBzcGFuIHRvIGRldGFpbHNcblx0Y29uc3QgdHlwZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJzcGFuXCIpO1xuXHR0eXBlLmNsYXNzTGlzdC5hZGQoXCJ0eXBlXCIpO1xuXHR0eXBlLnRleHRDb250ZW50ID0gXCJLZXl3b3JkXCI7IC8vIFBsYWNlaG9sZGVyIHR5cGUgY29udGVudFxuICBcblx0Ly8gQXBwZW5kIG5hbWUgYW5kIHR5cGUgdG8gZGV0YWlsc1xuXHRkZXRhaWxzLmFwcGVuZENoaWxkKG5hbWUpO1xuXHRkZXRhaWxzLmFwcGVuZENoaWxkKHR5cGUpO1xuICBcblx0Ly8gQXBwZW5kIGljb24gYW5kIGRldGFpbHMgdG8gdGhlIGNvbnRhaW5lclxuXHRjb250YWluZXIuYXBwZW5kQ2hpbGQoaWNvbik7XG5cdGNvbnRhaW5lci5hcHBlbmRDaGlsZChkZXRhaWxzKTtcbiAgXG5cdHJldHVybiBjb250YWluZXI7XG59XG5cblxuXG5cblxuXG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRDaGFyYWN0ZXJBdFBvcyh2aWV3T3JTdGF0ZTogRWRpdG9yVmlldyB8IEVkaXRvclN0YXRlLCBwb3M6IG51bWJlcikge1xuXHRjb25zdCBzdGF0ZSA9IHZpZXdPclN0YXRlIGluc3RhbmNlb2YgRWRpdG9yVmlldyA/IHZpZXdPclN0YXRlLnN0YXRlIDogdmlld09yU3RhdGU7XG5cdGNvbnN0IGRvYyA9IHN0YXRlLmRvYztcblx0cmV0dXJuIGRvYy5zbGljZShwb3MsIHBvcysxKS50b1N0cmluZygpO1xufVxuXG4iXX0=