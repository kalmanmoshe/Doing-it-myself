import { Notice, PluginSettingTab, Setting } from "obsidian";
import * as localForage from "localforage";
export const DEFAULT_SETTINGS = {
    invertColorsInDarkMode: true,
    numberFormatting: ".000",
    background: "#44475A",
    evenRowBackground: "#f9f9f9",
    oddRowBackground: "#747688",
    infoModalBackground: "#002B36",
    fontSize: "0.85em",
    rowPadding: "5px 10px",
    iconSize: "14px",
    sessionHistory: []
};
export class MathPluginSettingTab extends PluginSettingTab {
    plugin;
    settings;
    constructor(app, plugin) {
        super(app, plugin);
        try {
            localForage.config({ name: "TikzJax", storeName: "svgImages" });
        }
        catch (error) {
            console.log(error);
        }
    }
    updateStyles() {
        const root = document.documentElement;
        root.style.setProperty("--row-background", this.settings.background);
        root.style.setProperty("--even-row-background", this.settings.evenRowBackground);
        root.style.setProperty("--odd-row-background", this.settings.oddRowBackground);
        root.style.setProperty("--info-modal-column-background", this.settings.infoModalBackground);
        root.style.setProperty("--font-size", this.settings.fontSize);
        root.style.setProperty("--row-padding", this.settings.rowPadding);
        root.style.setProperty("--icon-size", this.settings.iconSize);
    }
    display() {
        const { containerEl } = this;
        const toSetOptions = [
            { value: 1000, display: "formatted .000" },
            { value: 10000, display: "formatted .0000" },
            { value: 100000, display: "formatted .00000" },
        ];
        containerEl.empty();
        containerEl.createEl("h2", { text: "Math Plugin Settings" });
        new Setting(containerEl)
            .setName("Invert dark colors in dark mode")
            .setDesc("Invert dark colors in diagrams (e.g. axes, arrows) when in dark mode, so that they are visible.")
            .addToggle(toggle => toggle
            .setValue(this.plugin.settings.invertColorsInDarkMode)
            .onChange(async (value) => {
            this.plugin.settings.invertColorsInDarkMode = value;
            await this.plugin.saveSettings();
        }));
        new Setting(containerEl)
            .setName("Clear cached SVGs")
            .setDesc("SVGs rendered with TikZJax are stored in a database, so diagrams don't have to be re-rendered from scratch every time you open a page. Use this to clear the cache and force all diagrams to be re-rendered.")
            .addButton(button => button
            .setIcon("trash")
            .setTooltip("Clear cached SVGs")
            .onClick(async () => {
            localForage.clear((err) => {
                if (err) {
                    console.log(err);
                    new Notice(err, 3000);
                }
                else {
                    new Notice("TikZJax: Successfully cleared cached SVGs.", 3000);
                }
            });
        }));
        this.addMultiChoiceSetting(containerEl, "Rendered number format", "Choose how to format numbers in the result", toSetOptions, "numberFormatting");
        containerEl.createEl("h2", { text: "Math Plugin style" });
        // Add various settings
        this.addColorSetting(containerEl, "Background Color", "Set the background color.", "background");
        this.addColorSetting(containerEl, "Even Row Background Color", "Set the background color for even rows.", "evenRowBackground");
        this.addColorSetting(containerEl, "Odd Row Background Color", "Set the background color for odd rows.", "oddRowBackground");
        this.addColorSetting(containerEl, "infoModal Background Color", "Set the background color for the info modal.", "infoModalBackground");
        this.addFontSetting(containerEl, "Font Size", "Set the font size for the rows.", "fontSize");
        this.addFontSetting(containerEl, "Row Padding", "Set the padding for the rows.", "rowPadding");
        this.addFontSetting(containerEl, "Icon Size", "Set the size of the icons.", "iconSize");
        new Setting(containerEl)
            .addButton(button => button
            .setButtonText("Wipe History Module")
            .setTooltip("Reset all settings to their default values")
            .onClick(async () => {
            this.plugin.settings.sessionHistory = [];
            new Notice("History was wiped.");
        }));
        new Setting(containerEl)
            .addButton(button => button
            .setButtonText("Reset to Default")
            .setTooltip("Reset all settings to their default values")
            .onClick(async () => {
            await this.resetToDefault();
        }));
    }
    addMultiChoiceSetting(containerEl, name, description, choices, settingKey) {
        if (settingKey === "sessionHistory") {
            console.error("sessionHistory cannot be modified with addFontSetting (string expected).");
            return;
        }
        new Setting(containerEl)
            .setName(name)
            .setDesc(description)
            .addDropdown(dropdown => {
            choices.forEach((choice) => {
                dropdown.addOption(choice.value, choice.display);
            });
            dropdown.onChange(async (value) => {
                this.plugin.settings[settingKey] = value;
                await this.plugin.saveSettings();
                this.updateStyles();
            });
        });
    }
    addColorSetting(containerEl, name, description, settingKey) {
        if (settingKey === "sessionHistory") {
            console.error("sessionHistory cannot be modified with addSetting (string expected).");
            return;
        }
        new Setting(containerEl)
            .setName(name)
            .setDesc(description)
            .addColorPicker(colorPicker => {
            const settingValue = this.plugin.settings[settingKey];
            if (typeof settingValue === "string") {
                colorPicker.setValue(settingValue);
            }
            colorPicker.onChange(async (value) => {
                if (typeof this.plugin.settings[settingKey] === "string") {
                    this.plugin.settings[settingKey] = value;
                    await this.plugin.saveSettings();
                    this.updateStyles();
                }
                else {
                    console.error(`Cannot assign a string value to ${settingKey} (non-string setting).`);
                }
            });
        });
    }
    addFontSetting(containerEl, name, description, settingKey) {
        // Ensure that 'sessionHistory' is not being processed by addFontSetting
        if (settingKey === "sessionHistory") {
            console.error("sessionHistory cannot be modified with addFontSetting (string expected).");
            return;
        }
        new Setting(containerEl)
            .setName(name)
            .setDesc(description)
            .addText((text) => {
            const settingValue = this.plugin.settings[settingKey];
            // Ensure that the setting is a string
            if (typeof settingValue === "string") {
                text.setPlaceholder(settingValue).setValue(settingValue);
            }
            text.onChange(async (value) => {
                // Ensure we are only assigning to string settings
                if (typeof this.plugin.settings[settingKey] === "string") {
                    this.plugin.settings[settingKey] = value;
                    await this.plugin.saveSettings();
                    this.updateStyles();
                }
                else {
                    console.error(`Cannot assign a string value to ${settingKey} (non-string setting).`);
                }
            });
        });
    }
    // Reset settings to default values
    async resetToDefault() {
        this.plugin.settings = { ...DEFAULT_SETTINGS };
        await this.plugin.saveSettings();
        this.updateStyles();
        new Notice("Settings have been reset to default.");
        this.display();
    }
}
export function createTextInputSetting(container, name, description, placeholder = "", settingKey, additionalClass) {
    let currentValue = settingKey || "";
    const setting = new Setting(container)
        .setName(name || "")
        .setDesc(description || "")
        .addText(text => {
        text.setPlaceholder(placeholder);
        text.setValue(currentValue);
        text.onChange(value => {
            currentValue = value;
            if (settingKey !== undefined)
                settingKey = currentValue; // only update if settingKey is passed
        });
    });
    if (additionalClass) {
        setting.settingEl.addClass(additionalClass);
    }
    return settingKey ? currentValue : undefined;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2V0dGluZ3MuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvc2V0dGluZ3MudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFPLE1BQU0sRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQVksTUFBTSxVQUFVLENBQUM7QUFHNUUsT0FBTyxLQUFLLFdBQVcsTUFBTSxhQUFhLENBQUM7QUFlM0MsTUFBTSxDQUFDLE1BQU0sZ0JBQWdCLEdBQXVCO0lBQ2hELHNCQUFzQixFQUFFLElBQUk7SUFDNUIsZ0JBQWdCLEVBQUUsTUFBTTtJQUN4QixVQUFVLEVBQUUsU0FBUztJQUNyQixpQkFBaUIsRUFBRSxTQUFTO0lBQzVCLGdCQUFnQixFQUFFLFNBQVM7SUFDM0IsbUJBQW1CLEVBQUUsU0FBUztJQUM5QixRQUFRLEVBQUUsUUFBUTtJQUNsQixVQUFVLEVBQUUsVUFBVTtJQUN0QixRQUFRLEVBQUUsTUFBTTtJQUNoQixjQUFjLEVBQUUsRUFBRTtDQUNyQixDQUFDO0FBSUYsTUFBTSxPQUFPLG9CQUFxQixTQUFRLGdCQUFnQjtJQUN0RCxNQUFNLENBQWE7SUFDbkIsUUFBUSxDQUFxQjtJQUU3QixZQUFZLEdBQVEsRUFBQyxNQUFrQjtRQUNyQyxLQUFLLENBQUMsR0FBRyxFQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ2xCLElBQUksQ0FBQztZQUNILFdBQVcsQ0FBQyxNQUFNLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDO1FBQ2xFLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNyQixDQUFDO0lBQ0gsQ0FBQztJQUVELFlBQVk7UUFDUixNQUFNLElBQUksR0FBRyxRQUFRLENBQUMsZUFBZSxDQUFDO1FBQ3RDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLGtCQUFrQixFQUFFLElB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O0FBQy9DLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcHAsIE5vdGljZSwgUGx1Z2luU2V0dGluZ1RhYiwgU2V0dGluZyAsQ29tcG9uZW50fSBmcm9tIFwib2JzaWRpYW5cIjtcbmltcG9ydCBNYXRoUGx1Z2luIGZyb20gXCIuL21haW5cIjtcbmltcG9ydCB7IEludGVyZmFjZSB9IGZyb20gXCJyZWFkbGluZVwiO1xuaW1wb3J0ICogYXMgbG9jYWxGb3JhZ2UgZnJvbSBcImxvY2FsZm9yYWdlXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgTWF0aFBsdWdpblNldHRpbmdzIHtcbiAgICBpbnZlcnRDb2xvcnNJbkRhcmtNb2RlOiBib29sZWFuO1xuICAgIG51bWJlckZvcm1hdHRpbmc6IHN0cmluZ1xuICAgIGJhY2tncm91bmQ6IHN0cmluZztcbiAgICBldmVuUm93QmFja2dyb3VuZDogc3RyaW5nO1xuICAgIG9kZFJvd0JhY2tncm91bmQ6IHN0cmluZztcbiAgICBpbmZvTW9kYWxCYWNrZ3JvdW5kOiBzdHJpbmc7XG4gICAgZm9udFNpemU6IHN0cmluZztcbiAgICByb3dQYWRkaW5nOiBzdHJpbmc7XG4gICAgaWNvblNpemU6IHN0cmluZztcbiAgICBzZXNzaW9uSGlzdG9yeTogeyBpbnB1dDogc3RyaW5nLCByZXN1bHQ6IHN0cmluZyB9W107IFxufVxuXG5leHBvcnQgY29uc3QgREVGQVVMVF9TRVRUSU5HUzogTWF0aFBsdWdpblNldHRpbmdzID0ge1xuICAgIGludmVydENvbG9yc0luRGFya01vZGU6IHRydWUsXG4gICAgbnVtYmVyRm9ybWF0dGluZzogXCIuMDAwXCIsXG4gICAgYmFja2dyb3VuZDogXCIjNDQ0NzVBXCIsXG4gICAgZXZlblJvd0JhY2tncm91bmQ6IFwiI2Y5ZjlmOVwiLFxuICAgIG9kZFJvd0JhY2tncm91bmQ6IFwiIzc0NzY4OFwiLFxuICAgIGluZm9Nb2RhbEJhY2tncm91bmQ6IFwiIzAwMkIzNlwiLFxuICAgIGZvbnRTaXplOiBcIjAuODVlbVwiLFxuICAgIHJvd1BhZGRpbmc6IFwiNXB4IDEwcHhcIixcbiAgICBpY29uU2l6ZTogXCIxNHB4XCIsXG4gICAgc2Vzc2lvbkhpc3Rvcnk6IFtdXG59O1xuXG4gIFxuXG5leHBvcnQgY2xhc3MgTWF0aFBsdWdpblNldHRpbmdUYWIgZXh0ZW5kcyBQbHVnaW5TZXR0aW5nVGFiIHtcbiAgICBwbHVnaW46IE1hdGhQbHVnaW47XG4gICAgc2V0dGluZ3M6IE1hdGhQbHVnaW5TZXR0aW5ncztcbiAgICBcbiAgICBjb25zdHJ1Y3RvcihhcHA6IEFwcCxwbHVnaW46IE1hdGhQbHVnaW4pIHtcbiAgICAgIHN1cGVyKGFwcCxwbHVnaW4pO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbG9jYWxGb3JhZ2UuY29uZmlnKHsgbmFtZTogXCJUaWt6SmF4XCIsIHN0b3JlTmFtZTogXCJzdmdJbWFnZXNcIiB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgdXBkYXRlU3R5bGVzKCkge1xuICAgICAgICBjb25zdCByb290ID0gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50O1xuICAgICAgICByb290LnN0eWxlLnNldFByb3BlcnR5KFwiLS1yb3ctYmFja2dyb3VuZFwiLCB0aGlzLnNldHRpbmdzLmJhY2tncm91bmQpO1xuICAgICAgICByb290LnN0eWxlLnNldFByb3BlcnR5KFwiLS1ldmVuLXJvdy1iYWNrZ3JvdW5kXCIsIHRoaXMuc2V0dGluZ3MuZXZlblJvd0JhY2tncm91bmQpO1xuICAgICAgICByb290LnN0eWxlLnNldFByb3BlcnR5KFwiLS1vZGQtcm93LWJhY2tncm91bmRcIiwgdGhpcy5zZXR0aW5ncy5vZGRSb3dCYWNrZ3JvdW5kKTtcbiAgICAgICAgcm9vdC5zdHlsZS5zZXRQcm9wZXJ0eShcIi0taW5mby1tb2RhbC1jb2x1bW4tYmFja2dyb3VuZFwiLCB0aGlzLnNldHRpbmdzLmluZm9Nb2RhbEJhY2tncm91bmQpO1xuICAgICAgICByb290LnN0eWxlLnNldFByb3BlcnR5KFwiLS1mb250LXNpemVcIiwgdGhpcy5zZXR0aW5ncy5mb250U2l6ZSk7XG4gICAgICAgIHJvb3Quc3R5bGUuc2V0UHJvcGVydHkoXCItLXJvdy1wYWRkaW5nXCIsIHRoaXMuc2V0dGluZ3Mucm93UGFkZGluZyk7XG4gICAgICAgIHJvb3Quc3R5bGUuc2V0UHJvcGVydHkoXCItLWljb24tc2l6ZVwiLCB0aGlzLnNldHRpbmdzLmljb25TaXplKTtcbiAgICB9XG5cbiAgICBkaXNwbGF5KCk6IHZvaWQge1xuICAgICAgY29uc3QgeyBjb250YWluZXJFbCB9ID0gdGhpcztcbiAgICAgIGNvbnN0IHRvU2V0T3B0aW9ucz1bXG4gICAgICAgIHt2YWx1ZTogMTAwMCxkaXNwbGF5OiBcImZvcm1hdHRlZCAuMDAwXCIgfSxcbiAgICAgICAge3ZhbHVlOiAxMDAwMCxkaXNwbGF5OiBcImZvcm1hdHRlZCAuMDAwMFwiIH0sXG4gICAgICAgIHt2YWx1ZTogMTAwMDAwLGRpc3BsYXk6IFwiZm9ybWF0dGVkIC4wMDAwMFwiIH0sXG4gICAgICBdXG4gIFxuICAgICAgY29udGFpbmVyRWwuZW1wdHkoKTtcbiAgICAgIGNvbnRhaW5lckVsLmNyZWF0ZUVsKFwiaDJcIiwgeyB0ZXh0OiBcIk1hdGggUGx1Z2luIFNldHRpbmdzXCIgfSk7XG4gICAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcblx0XHRcdC5zZXROYW1lKFwiSW52ZXJ0IGRhcmsgY29sb3JzIGluIGRhcmsgbW9kZVwiKVxuXHRcdFx0LnNldERlc2MoXCJJbnZlcnQgZGFyayBjb2xvcnMgaW4gZGlhZ3JhbXMgKGUuZy4gYXhlcywgYXJyb3dzKSB3aGVuIGluIGRhcmsgbW9kZSwgc28gdGhhdCB0aGV5IGFyZSB2aXNpYmxlLlwiKVxuXHRcdFx0LmFkZFRvZ2dsZSh0b2dnbGUgPT4gdG9nZ2xlXG5cdFx0XHRcdC5zZXRWYWx1ZSh0aGlzLnBsdWdpbi5zZXR0aW5ncy5pbnZlcnRDb2xvcnNJbkRhcmtNb2RlKVxuXHRcdFx0XHQub25DaGFuZ2UoYXN5bmMgKHZhbHVlKSA9PiB7XG5cdFx0XHRcdFx0dGhpcy5wbHVnaW4uc2V0dGluZ3MuaW52ZXJ0Q29sb3JzSW5EYXJrTW9kZSA9IHZhbHVlO1xuXG5cdFx0XHRcdFx0YXdhaXQgdGhpcy5wbHVnaW4uc2F2ZVNldHRpbmdzKCk7XG5cdFx0XHRcdH0pKTtcblxuXG5cdFx0bmV3IFNldHRpbmcoY29udGFpbmVyRWwpXG5cdFx0XHQuc2V0TmFtZShcIkNsZWFyIGNhY2hlZCBTVkdzXCIpXG5cdFx0XHQuc2V0RGVzYyhcIlNWR3MgcmVuZGVyZWQgd2l0aCBUaWtaSmF4IGFyZSBzdG9yZWQgaW4gYSBkYXRhYmFzZSwgc28gZGlhZ3JhbXMgZG9uJ3QgaGF2ZSB0byBiZSByZS1yZW5kZXJlZCBmcm9tIHNjcmF0Y2ggZXZlcnkgdGltZSB5b3Ugb3BlbiBhIHBhZ2UuIFVzZSB0aGlzIHRvIGNsZWFyIHRoZSBjYWNoZSBhbmQgZm9yY2UgYWxsIGRpYWdyYW1zIHRvIGJlIHJlLXJlbmRlcmVkLlwiKVxuXHRcdFx0LmFkZEJ1dHRvbihidXR0b24gPT4gYnV0dG9uXG5cdFx0XHRcdC5zZXRJY29uKFwidHJhc2hcIilcblx0XHRcdFx0LnNldFRvb2x0aXAoXCJDbGVhciBjYWNoZWQgU1ZHc1wiKVxuXHRcdFx0XHQub25DbGljayhhc3luYyAoKSA9PiB7XG5cdFx0XHRcdFx0bG9jYWxGb3JhZ2UuY2xlYXIoKGVycikgPT4ge1xuXHRcdFx0XHRcdFx0aWYgKGVycikge1xuXHRcdFx0XHRcdFx0XHRjb25zb2xlLmxvZyhlcnIpO1xuXHRcdFx0XHRcdFx0XHRuZXcgTm90aWNlKGVyciwgMzAwMCk7XG5cdFx0XHRcdFx0XHR9XG5cdFx0XHRcdFx0XHRlbHNlIHtcblx0XHRcdFx0XHRcdFx0bmV3IE5vdGljZShcIlRpa1pKYXg6IFN1Y2Nlc3NmdWxseSBjbGVhcmVkIGNhY2hlZCBTVkdzLlwiLCAzMDAwKTtcblx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSkpO1xuICAgICAgdGhpcy5hZGRNdWx0aUNob2ljZVNldHRpbmcoY29udGFpbmVyRWwsIFwiUmVuZGVyZWQgbnVtYmVyIGZvcm1hdFwiLCBcIkNob29zZSBob3cgdG8gZm9ybWF0IG51bWJlcnMgaW4gdGhlIHJlc3VsdFwiLCB0b1NldE9wdGlvbnMsXCJudW1iZXJGb3JtYXR0aW5nXCIpO1xuICAgICAgY29udGFpbmVyRWwuY3JlYXRlRWwoXCJoMlwiLCB7IHRleHQ6IFwiTWF0aCBQbHVnaW4gc3R5bGVcIiB9KTtcbiAgICAgIFxuICAgICAgLy8gQWRkIHZhcmlvdXMgc2V0dGluZ3NcbiAgICAgIHRoaXMuYWRkQ29sb3JTZXR0aW5nKGNvbnRhaW5lckVsLCBcIkJhY2tncm91bmQgQ29sb3JcIiwgXCJTZXQgdGhlIGJhY2tncm91bmQgY29sb3IuXCIsIFwiYmFja2dyb3VuZFwiKTtcbiAgICAgIHRoaXMuYWRkQ29sb3JTZXR0aW5nKGNvbnRhaW5lckVsLCBcIkV2ZW4gUm93IEJhY2tncm91bmQgQ29sb3JcIiwgXCJTZXQgdGhlIGJhY2tncm91bmQgY29sb3IgZm9yIGV2ZW4gcm93cy5cIiwgXCJldmVuUm93QmFja2dyb3VuZFwiKTtcbiAgICAgIHRoaXMuYWRkQ29sb3JTZXR0aW5nKGNvbnRhaW5lckVsLCBcIk9kZCBSb3cgQmFja2dyb3VuZCBDb2xvclwiLCBcIlNldCB0aGUgYmFja2dyb3VuZCBjb2xvciBmb3Igb2RkIHJvd3MuXCIsIFwib2RkUm93QmFja2dyb3VuZFwiKTtcbiAgICAgIHRoaXMuYWRkQ29sb3JTZXR0aW5nKGNvbnRhaW5lckVsLCBcImluZm9Nb2RhbCBCYWNrZ3JvdW5kIENvbG9yXCIsIFwiU2V0IHRoZSBiYWNrZ3JvdW5kIGNvbG9yIGZvciB0aGUgaW5mbyBtb2RhbC5cIiwgXCJpbmZvTW9kYWxCYWNrZ3JvdW5kXCIpO1xuICAgICAgXG4gICAgICB0aGlzLmFkZEZvbnRTZXR0aW5nKGNvbnRhaW5lckVsLCBcIkZvbnQgU2l6ZVwiLCBcIlNldCB0aGUgZm9udCBzaXplIGZvciB0aGUgcm93cy5cIiwgXCJmb250U2l6ZVwiKTtcbiAgICAgIHRoaXMuYWRkRm9udFNldHRpbmcoY29udGFpbmVyRWwsIFwiUm93IFBhZGRpbmdcIiwgXCJTZXQgdGhlIHBhZGRpbmcgZm9yIHRoZSByb3dzLlwiLCBcInJvd1BhZGRpbmdcIik7XG4gICAgICB0aGlzLmFkZEZvbnRTZXR0aW5nKGNvbnRhaW5lckVsLCBcIkljb24gU2l6ZVwiLCBcIlNldCB0aGUgc2l6ZSBvZiB0aGUgaWNvbnMuXCIsIFwiaWNvblNpemVcIik7XG4gIFxuICAgICAgbmV3IFNldHRpbmcoY29udGFpbmVyRWwpXG4gICAgICAgIC5hZGRCdXR0b24oYnV0dG9uID0+XG4gICAgICAgICAgYnV0dG9uXG4gICAgICAgICAgICAuc2V0QnV0dG9uVGV4dChcIldpcGUgSGlzdG9yeSBNb2R1bGVcIilcbiAgICAgICAgICAgIC5zZXRUb29sdGlwKFwiUmVzZXQgYWxsIHNldHRpbmdzIHRvIHRoZWlyIGRlZmF1bHQgdmFsdWVzXCIpXG4gICAgICAgICAgICAub25DbGljayhhc3luYyAoKSA9PiB7XG4gICAgICAgICAgICAgIHRoaXMucGx1Z2luLnNldHRpbmdzLnNlc3Npb25IaXN0b3J5ID0gW107XG4gICAgICAgICAgICAgbmV3IE5vdGljZShcIkhpc3Rvcnkgd2FzIHdpcGVkLlwiKVxuICAgICAgICAgICAgfSkpO1xuXG4gICAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgIC5hZGRCdXR0b24oYnV0dG9uID0+XG4gICAgICAgIGJ1dHRvblxuICAgICAgICAgIC5zZXRCdXR0b25UZXh0KFwiUmVzZXQgdG8gRGVmYXVsdFwiKVxuICAgICAgICAgIC5zZXRUb29sdGlwKFwiUmVzZXQgYWxsIHNldHRpbmdzIHRvIHRoZWlyIGRlZmF1bHQgdmFsdWVzXCIpXG4gICAgICAgICAgLm9uQ2xpY2soYXN5bmMgKCkgPT4ge1xuICAgICAgICAgICAgYXdhaXQgdGhpcy5yZXNldFRvRGVmYXVsdCgpO1xuICAgICAgICAgIH0pKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGFkZE11bHRpQ2hvaWNlU2V0dGluZyhjb250YWluZXJFbDogSFRNTEVsZW1lbnQsIG5hbWU6IHN0cmluZywgZGVzY3JpcHRpb246IHN0cmluZywgY2hvaWNlczogYW55LHNldHRpbmdLZXk6IGtleW9mIE1hdGhQbHVnaW5TZXR0aW5ncykge1xuICAgICAgaWYgKHNldHRpbmdLZXkgPT09IFwic2Vzc2lvbkhpc3RvcnlcIikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwic2Vzc2lvbkhpc3RvcnkgY2Fubm90IGJlIG1vZGlmaWVkIHdpdGggYWRkRm9udFNldHRpbmcgKHN0cmluZyBleHBlY3RlZCkuXCIpO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gIFxuICAgICAgICBuZXcgU2V0dGluZyhjb250YWluZXJFbClcbiAgICAgICAgLnNldE5hbWUobmFtZSlcbiAgICAgICAgLnNldERlc2MoZGVzY3JpcHRpb24pXG4gICAgICAgIC5hZGREcm9wZG93bihkcm9wZG93biA9PiB7XG4gICAgICAgICAgY2hvaWNlcy5mb3JFYWNoKChjaG9pY2U6IGFueSkgPT4ge1xuICAgICAgICAgICAgZHJvcGRvd24uYWRkT3B0aW9uKGNob2ljZS52YWx1ZSxjaG9pY2UuZGlzcGxheSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgICAgZHJvcGRvd24ub25DaGFuZ2UoYXN5bmMgKHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgKHRoaXMucGx1Z2luLnNldHRpbmdzW3NldHRpbmdLZXldYXMgc3RyaW5nKSA9IHZhbHVlO1xuICAgICAgICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi5zYXZlU2V0dGluZ3MoKTtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVTdHlsZXMoKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICBcbiAgICBwcml2YXRlIGFkZENvbG9yU2V0dGluZyhjb250YWluZXJFbDogSFRNTEVsZW1lbnQsIG5hbWU6IHN0cmluZywgZGVzY3JpcHRpb246IHN0cmluZywgc2V0dGluZ0tleToga2V5b2YgTWF0aFBsdWdpblNldHRpbmdzKSB7XG4gICAgICBpZiAoc2V0dGluZ0tleSA9PT0gXCJzZXNzaW9uSGlzdG9yeVwiKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJzZXNzaW9uSGlzdG9yeSBjYW5ub3QgYmUgbW9kaWZpZWQgd2l0aCBhZGRTZXR0aW5nIChzdHJpbmcgZXhwZWN0ZWQpLlwiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIFxuICAgICAgbmV3IFNldHRpbmcoY29udGFpbmVyRWwpXG4gICAgICAgIC5zZXROYW1lKG5hbWUpXG4gICAgICAgIC5zZXREZXNjKGRlc2NyaXB0aW9uKVxuICAgICAgICAuYWRkQ29sb3JQaWNrZXIoY29sb3JQaWNrZXIgPT4ge1xuICAgICAgICAgIGNvbnN0IHNldHRpbmdWYWx1ZSA9IHRoaXMucGx1Z2luLnNldHRpbmdzW3NldHRpbmdLZXldO1xuICAgICAgICAgIFxuICAgICAgICAgIGlmICh0eXBlb2Ygc2V0dGluZ1ZhbHVlID09PSBcInN0cmluZ1wiKSB7IFxuICAgICAgICAgICAgY29sb3JQaWNrZXIuc2V0VmFsdWUoc2V0dGluZ1ZhbHVlKTtcbiAgICAgICAgICB9XG4gICAgICAgICAgXG4gICAgICAgICAgY29sb3JQaWNrZXIub25DaGFuZ2UoYXN5bmMgKHZhbHVlKSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHRoaXMucGx1Z2luLnNldHRpbmdzW3NldHRpbmdLZXldID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICAgICh0aGlzLnBsdWdpbi5zZXR0aW5nc1tzZXR0aW5nS2V5XWFzIHN0cmluZykgID0gdmFsdWU7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMucGx1Z2luLnNhdmVTZXR0aW5ncygpO1xuICAgICAgICAgICAgICB0aGlzLnVwZGF0ZVN0eWxlcygpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihgQ2Fubm90IGFzc2lnbiBhIHN0cmluZyB2YWx1ZSB0byAke3NldHRpbmdLZXl9IChub24tc3RyaW5nIHNldHRpbmcpLmApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgXG4gICAgcHJpdmF0ZSBhZGRGb250U2V0dGluZyhjb250YWluZXJFbDogSFRNTEVsZW1lbnQsIG5hbWU6IHN0cmluZywgZGVzY3JpcHRpb246IHN0cmluZywgc2V0dGluZ0tleToga2V5b2YgTWF0aFBsdWdpblNldHRpbmdzKSB7XG4gICAgICAvLyBFbnN1cmUgdGhhdCAnc2Vzc2lvbkhpc3RvcnknIGlzIG5vdCBiZWluZyBwcm9jZXNzZWQgYnkgYWRkRm9udFNldHRpbmdcbiAgICAgIGlmIChzZXR0aW5nS2V5ID09PSBcInNlc3Npb25IaXN0b3J5XCIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcInNlc3Npb25IaXN0b3J5IGNhbm5vdCBiZSBtb2RpZmllZCB3aXRoIGFkZEZvbnRTZXR0aW5nIChzdHJpbmcgZXhwZWN0ZWQpLlwiKTtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIFxuICAgICAgbmV3IFNldHRpbmcoY29udGFpbmVyRWwpXG4gICAgICAgIC5zZXROYW1lKG5hbWUpXG4gICAgICAgIC5zZXREZXNjKGRlc2NyaXB0aW9uKVxuICAgICAgICAuYWRkVGV4dCgodGV4dDogYW55KSA9PiB7XG4gICAgICAgICAgY29uc3Qgc2V0dGluZ1ZhbHVlID0gdGhpcy5wbHVnaW4uc2V0dGluZ3Nbc2V0dGluZ0tleV07XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gRW5zdXJlIHRoYXQgdGhlIHNldHRpbmcgaXMgYSBzdHJpbmdcbiAgICAgICAgICBpZiAodHlwZW9mIHNldHRpbmdWYWx1ZSA9PT0gXCJzdHJpbmdcIikgeyBcbiAgICAgICAgICAgIHRleHQuc2V0UGxhY2Vob2xkZXIoc2V0dGluZ1ZhbHVlKS5zZXRWYWx1ZShzZXR0aW5nVmFsdWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICBcbiAgICAgICAgICB0ZXh0Lm9uQ2hhbmdlKGFzeW5jICh2YWx1ZTogc3RyaW5nKSA9PiB7XG4gICAgICAgICAgICAvLyBFbnN1cmUgd2UgYXJlIG9ubHkgYXNzaWduaW5nIHRvIHN0cmluZyBzZXR0aW5nc1xuICAgICAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnBsdWdpbi5zZXR0aW5nc1tzZXR0aW5nS2V5XSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICAodGhpcy5wbHVnaW4uc2V0dGluZ3Nbc2V0dGluZ0tleV1hcyBzdHJpbmcpICA9IHZhbHVlO1xuICAgICAgICAgICAgICBhd2FpdCB0aGlzLnBsdWdpbi5zYXZlU2V0dGluZ3MoKTtcbiAgICAgICAgICAgICAgdGhpcy51cGRhdGVTdHlsZXMoKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYENhbm5vdCBhc3NpZ24gYSBzdHJpbmcgdmFsdWUgdG8gJHtzZXR0aW5nS2V5fSAobm9uLXN0cmluZyBzZXR0aW5nKS5gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8vIFJlc2V0IHNldHRpbmdzIHRvIGRlZmF1bHQgdmFsdWVzXG4gICAgcHJpdmF0ZSBhc3luYyByZXNldFRvRGVmYXVsdCgpIHtcbiAgICAgIHRoaXMucGx1Z2luLnNldHRpbmdzID0geyAuLi5ERUZBVUxUX1NFVFRJTkdTIH07XG4gICAgICBhd2FpdCB0aGlzLnBsdWdpbi5zYXZlU2V0dGluZ3MoKTtcbiAgICAgIHRoaXMudXBkYXRlU3R5bGVzKCk7XG4gICAgICBuZXcgTm90aWNlKFwiU2V0dGluZ3MgaGF2ZSBiZWVuIHJlc2V0IHRvIGRlZmF1bHQuXCIpO1xuICAgICAgdGhpcy5kaXNwbGF5KCk7XG4gICAgfVxuICB9XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVUZXh0SW5wdXRTZXR0aW5nKFxuICAgIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQsXG4gICAgbmFtZTogc3RyaW5nLFxuICAgIGRlc2NyaXB0aW9uOiBzdHJpbmcsXG4gICAgcGxhY2Vob2xkZXIgPSBcIlwiLFxuICAgIHNldHRpbmdLZXk/OiBzdHJpbmcsXG4gICAgYWRkaXRpb25hbENsYXNzPzogc3RyaW5nXG4gICk6IHN0cmluZyB8IHZvaWQge1xuICAgIGxldCBjdXJyZW50VmFsdWUgPSBzZXR0aW5nS2V5IHx8IFwiXCI7XG4gIFxuICAgIGNvbnN0IHNldHRpbmcgPSBuZXcgU2V0dGluZyhjb250YWluZXIpXG4gICAgICAuc2V0TmFtZShuYW1lIHx8IFwiXCIpXG4gICAgICAuc2V0RGVzYyhkZXNjcmlwdGlvbiB8fCBcIlwiKVxuICAgICAgLmFkZFRleHQodGV4dCA9PiB7XG4gICAgICAgIHRleHQuc2V0UGxhY2Vob2xkZXIocGxhY2Vob2xkZXIpO1xuICAgICAgICB0ZXh0LnNldFZhbHVlKGN1cnJlbnRWYWx1ZSk7XG4gICAgICAgIHRleHQub25DaGFuZ2UodmFsdWUgPT4ge1xuICAgICAgICAgIGN1cnJlbnRWYWx1ZSA9IHZhbHVlO1xuICAgICAgICAgIGlmIChzZXR0aW5nS2V5ICE9PSB1bmRlZmluZWQpIHNldHRpbmdLZXkgPSBjdXJyZW50VmFsdWU7IC8vIG9ubHkgdXBkYXRlIGlmIHNldHRpbmdLZXkgaXMgcGFzc2VkXG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gIFxuICAgIGlmIChhZGRpdGlvbmFsQ2xhc3MpIHtcbiAgICAgIHNldHRpbmcuc2V0dGluZ0VsLmFkZENsYXNzKGFkZGl0aW9uYWxDbGFzcyk7XG4gICAgfVxuICBcbiAgICByZXR1cm4gc2V0dGluZ0tleSA/IGN1cnJlbnRWYWx1ZSA6IHVuZGVmaW5lZDtcbiAgfVxuICAiXX0=