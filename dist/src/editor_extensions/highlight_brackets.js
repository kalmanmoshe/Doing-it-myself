import { Decoration, ViewPlugin } from "@codemirror/view";
import { Prec } from "@codemirror/state";
import { findMatchingBracket, getOpenBracket, getCloseBracket } from "../utils/editor_utils";
import { syntaxTree } from "@codemirror/language";
import { Context, getEquationBounds } from "src/utils/context";
const Ncolors = 3;
function getHighlightBracketMark(pos, className) {
    return Decoration.mark({
        inclusive: true,
        attributes: {},
        class: className
    }).range(pos, pos + 1);
}
function colorPairedBrackets(view) {
    const widgets = [];
    for (const { from, to } of view.visibleRanges) {
        syntaxTree(view.state).iterate({ from, to, enter: (node) => {
                const type = node.type;
                const to = node.to;
                if (!(type.name.contains("begin") && type.name.contains("math"))) {
                    return;
                }
                const bounds = getEquationBounds(view.state, to);
                if (!bounds)
                    return;
                const eqn = view.state.doc.sliceString(bounds.start, bounds.end);
                const openBrackets = ["{", "[", "("];
                const closeBrackets = ["}", "]", ")"];
                const bracketsStack = [];
                const bracketsPosStack = [];
                for (let i = 0; i < eqn.length; i++) {
                    const char = eqn.charAt(i);
                    if (openBrackets.contains(char)) {
                        bracketsStack.push(char);
                        bracketsPosStack.push(i);
                    }
                    else if (closeBrackets.contains(char)) {
                        const lastBracket = bracketsStack.at(-1);
                        const lastBracketPos = bracketsPosStack.at(-1);
                        if (lastBracket !== undefined && lastBracketPos !== undefined && getCloseBracket(lastBracket) === char) {
                            bracketsStack.pop();
                            bracketsPosStack.pop();
                            const depth = bracketsStack.length % Ncolors;
                            const className = "latex-suite-color-bracket-" + depth;
                            const j = lastBracketPos + bounds.start;
                            const k = i + bounds.start;
                            widgets.push(getHighlightBracketMark(j, className));
                            widgets.push(getHighlightBracketMark(k, className));
                        }
                    }
                }
            }
        });
    }
    return Decoration.set(widgets, true);
}
function getEnclosingBracketsPos(view, pos) {
    const result = getEquationBounds(view.state);
    if (!result)
        return -1;
    const { start, end } = result;
    const text = view.state.doc.sliceString(start, end);
    for (let i = pos - start; i > 0; i--) {
        let curChar = text.charAt(i);
        if ([")", "]", "}"].contains(curChar)) {
            const closeBracket = curChar;
            const openBracket = getOpenBracket(closeBracket);
            const j = findMatchingBracket(text, i, openBracket, closeBracket, true);
            if (j === -1)
                return -1;
            // Skip to the beginnning of the bracket
            i = j;
            curChar = text.charAt(i);
        }
        else {
            if (!["{", "(", "["].contains(curChar))
                continue;
            const j = findMatchingBracket(text, i, curChar, getCloseBracket(curChar), false);
            if (j === -1)
                continue;
            return { left: i + start, right: j + start };
        }
    }
    return -1;
}
function highlightCursorBrackets(view) {
    const widgets = [];
    const selection = view.state.selection;
    const ranges = selection.ranges;
    const text = view.state.doc.toString();
    const ctx = Context.fromView(view);
    if (!ctx.mode.inMath()) {
        return Decoration.none;
    }
    const bounds = ctx.getBounds(selection.main.to);
    if (!bounds)
        return Decoration.none;
    const eqn = view.state.doc.sliceString(bounds.start, bounds.end);
    const openBrackets = ["{", "[", "("];
    const brackets = ["{", "[", "(", "}", "]", ")"];
    let done = false;
    for (const range of ranges) {
        for (let i = range.to; i > range.from - 2; i--) {
            const char = text.charAt(i);
            if (!brackets.contains(char))
                continue;
            let openBracket, closeBracket;
            let backwards = false;
            if (openBrackets.contains(char)) {
                openBracket = char;
                closeBracket = getCloseBracket(openBracket);
            }
            else {
                closeBracket = char;
                openBracket = getOpenBracket(char);
                backwards = true;
            }
            let j = findMatchingBracket(eqn, i - bounds.start, openBracket, closeBracket, backwards);
            if (j === -1)
                continue;
            j = j + bounds.start;
            widgets.push(getHighlightBracketMark(i, "latex-suite-highlighted-bracket"));
            widgets.push(getHighlightBracketMark(j, "latex-suite-highlighted-bracket"));
            done = true;
            break;
        }
        if (done)
            break;
        // Highlight brackets enclosing the cursor
        if (range.empty) {
            const pos = range.from - 1;
            const result = getEnclosingBracketsPos(view, pos);
            if (result === -1)
                continue;
            widgets.push(getHighlightBracketMark(result.left, "latex-suite-highlighted-bracket"));
            widgets.push(getHighlightBracketMark(result.right, "latex-suite-highlighted-bracket"));
            done = true;
            break;
        }
        if (done)
            break;
    }
    return Decoration.set(widgets, true);
}
export const colorPairedBracketsPlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = colorPairedBrackets(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = colorPairedBrackets(update.view);
        }
    }
}, { decorations: v => v.decorations, });
export const colorPairedBracketsPluginLowestPrec = Prec.lowest(colorPairedBracketsPlugin.extension);
export const highlightCursorBracketsPlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = highlightCursorBrackets(view);
    }
    update(update) {
        if (update.docChanged || update.selectionSet)
            this.decorations = highlightCursorBrackets(update.view);
    }
}, { decorations: v => v.decorations, });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0X2JyYWNrZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2VkaXRvcl9leHRlbnNpb25zL2hpZ2hsaWdodF9icmFja2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQTBCLFVBQVUsRUFBaUIsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakcsT0FBTyxFQUFFLElBQUksRUFBUyxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0YsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUUvRCxNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFFbEIsU0FBUyx1QkFBdUIsQ0FBQyxHQUFXLEVBQUUsU0FBaUI7SUFDOUQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3RCLFNBQVMsRUFBRSxJQUFJO1FBQ2YsVUFBVSxFQUFFLEVBQUU7UUFDZCxLQUFLLEVBQUUsU0FBUztLQUNoQixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsSUFBZ0I7SUFDNUMsTUFBTSxPQUFPLEdBQXdCLEVBQUUsQ0FBQztJQUV4QyxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRS9DLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDMUQsTUFBTSxJQUFJLEdB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RUFBRSxDQUFDO1lBQ2pELElBQUksQ0FBQyxXQUFXLEdBQUcsbUJBQW1CLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JELENBQUM7SUFDRixDQUFDO0NBRUQsRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBR3pDLE1BQU0sQ0FBQyxNQUFNLG1DQUFtQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMseUJBQXlCLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFcEcsTUFBTSxDQUFDLE1BQU0sNkJBQTZCLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztJQUNqRSxXQUFXLENBQWdCO0lBRTNCLFlBQVksSUFBZ0I7UUFDM0IsSUFBSSxDQUFDLFdBQVcsR0FBRyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQsTUFBTSxDQUFDLE1BQWtCO1FBQ3hCLElBQUksTUFBTSxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUMsWUFBWTtZQUMzQyxJQUFJLENBQUMsV0FBVyxHQUFHLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxRCxDQUFDO0NBRUQsRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldywgVmlld1VwZGF0ZSwgRGVjb3JhdGlvbiwgRGVjb3JhdGlvblNldCwgVmlld1BsdWdpbiB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XHJcbmltcG9ydCB7IFByZWMsIFJhbmdlIH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XHJcbmltcG9ydCB7IGZpbmRNYXRjaGluZ0JyYWNrZXQsIGdldE9wZW5CcmFja2V0LCBnZXRDbG9zZUJyYWNrZXQgfSBmcm9tIFwiLi4vdXRpbHMvZWRpdG9yX3V0aWxzXCI7XHJcbmltcG9ydCB7IHN5bnRheFRyZWUgfSBmcm9tIFwiQGNvZGVtaXJyb3IvbGFuZ3VhZ2VcIjtcclxuaW1wb3J0IHsgQ29udGV4dCwgZ2V0RXF1YXRpb25Cb3VuZHMgfSBmcm9tIFwic3JjL3V0aWxzL2NvbnRleHRcIjtcclxuXHJcbmNvbnN0IE5jb2xvcnMgPSAzO1xyXG5cclxuZnVuY3Rpb24gZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsocG9zOiBudW1iZXIsIGNsYXNzTmFtZTogc3RyaW5nKTpSYW5nZTxEZWNvcmF0aW9uPiB7XHJcblx0cmV0dXJuIERlY29yYXRpb24ubWFyayh7XHJcblx0XHRpbmNsdXNpdmU6IHRydWUsXHJcblx0XHRhdHRyaWJ1dGVzOiB7fSxcclxuXHRcdGNsYXNzOiBjbGFzc05hbWVcclxuXHR9KS5yYW5nZShwb3MsIHBvcysxKTtcclxufVxyXG5cclxuZnVuY3Rpb24gY29sb3JQYWlyZWRCcmFja2V0cyh2aWV3OiBFZGl0b3JWaWV3KSB7XHJcblx0Y29uc3Qgd2lkZ2V0czogUmFuZ2U8RGVjb3JhdGlvbj5bXSA9IFtdO1xyXG5cclxuXHRmb3IgKGNvbnN0IHsgZnJvbSwgdG8gfSBvZiB2aWV3LnZpc2libGVSYW5nZXMpIHtcclxuXHJcblx0XHRzeW50YXhUcmVlKHZpZXcuc3RhdGUpLml0ZXJhdGUoeyBmcm9tLCB0bywgZW50ZXI6IChub2RlKSA9PiB7XHJcblx0XHRcdGNvbnN0IHR5cGUgPSBub2RlLnR5cGU7XHJcblx0XHRcdGNvbnN0IHRvID0gbm9kZS50bztcclxuXHJcblx0XHRcdGlmICghKHR5cGUubmFtZS5jb250YWlucyhcImJlZ2luXCIpICYmIHR5cGUubmFtZS5jb250YWlucyhcIm1hdGhcIikpKSB7XHJcblx0XHRcdFx0cmV0dXJuO1xyXG5cdFx0XHR9XHJcblxyXG5cdFx0XHRjb25zdCBib3VuZHMgPSBnZXRFcXVhdGlvbkJvdW5kcyh2aWV3LnN0YXRlLCB0byk7XHJcblx0XHRcdGlmICghYm91bmRzKSByZXR1cm47XHJcblxyXG5cclxuXHRcdFx0Y29uc3QgZXFuID0gdmlldy5zdGF0ZS5kb2Muc2xpY2VTdHJpbmcoYm91bmRzLnN0YXJ0LCBib3VuZHMuZW5kKTtcclxuXHJcblxyXG5cdFx0XHRjb25zdCBvcGVuQnJhY2tldHMgPSBbXCJ7XCIsIFwiW1wiLCBcIihcIl07XHJcblx0XHRcdGNvbnN0IGNsb3NlQnJhY2tldHMgPSBbXCJ9XCIsIFwiXVwiLCBcIilcIl07XHJcblxyXG5cdFx0XHRjb25zdCBicmFja2V0c1N0YWNrID0gW107XHJcblx0XHRcdGNvbnN0IGJyYWNrZXRzUG9zU3RhY2sgPSBbXTtcclxuXHJcblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgZXFuLmxlbmd0aDsgaSsrKSB7XHJcblx0XHRcdFx0Y29uc3QgY2hhciA9IGVxbi5jaGFyQXQoaSk7XHJcblxyXG5cdFx0XHRcdGlmIChvcGVuQnJhY2tldHMuY29udGFpbnMoY2hhcikpIHtcclxuXHRcdFx0XHRcdGJyYWNrZXRzU3RhY2sucHVzaChjaGFyKTtcclxuXHRcdFx0XHRcdGJyYWNrZXRzUG9zU3RhY2sucHVzaChpKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0ZWxzZSBpZiAoY2xvc2VCcmFja2V0cy5jb250YWlucyhjaGFyKSkge1xyXG5cdFx0XHRcdFx0Y29uc3QgbGFzdEJyYWNrZXQgPSBicmFja2V0c1N0YWNrLmF0KC0xKTtcclxuXHRcdFx0XHRcdGNvbnN0IGxhc3RCcmFja2V0UG9zID0gYnJhY2tldHNQb3NTdGFjay5hdCgtMSk7XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0XHRpZiAobGFzdEJyYWNrZXQgIT09IHVuZGVmaW5lZCAmJiBsYXN0QnJhY2tldFBvcyAhPT0gdW5kZWZpbmVkICYmIGdldENsb3NlQnJhY2tldChsYXN0QnJhY2tldCkgPT09IGNoYXIpIHtcclxuXHRcdFx0XHRcdFx0YnJhY2tldHNTdGFjay5wb3AoKTtcclxuXHRcdFx0XHRcdFx0YnJhY2tldHNQb3NTdGFjay5wb3AoKTtcclxuXHRcdFx0XHRcdFx0Y29uc3QgZGVwdGggPSBicmFja2V0c1N0YWNrLmxlbmd0aCAlIE5jb2xvcnM7XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0XHRcdGNvbnN0IGNsYXNzTmFtZSA9IFwibGF0ZXgtc3VpdGUtY29sb3ItYnJhY2tldC1cIiArIGRlcHRoO1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdFx0XHRjb25zdCBqID0gbGFzdEJyYWNrZXRQb3MgKyBib3VuZHMuc3RhcnQ7XHJcblx0XHRcdFx0XHRcdGNvbnN0IGsgPSBpICsgYm91bmRzLnN0YXJ0O1xyXG5cdFx0XHRcdFxyXG5cdFx0XHRcdFx0XHR3aWRnZXRzLnB1c2goZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsoaiwgY2xhc3NOYW1lKSk7XHJcblx0XHRcdFx0XHRcdHdpZGdldHMucHVzaChnZXRIaWdobGlnaHRCcmFja2V0TWFyayhrLCBjbGFzc05hbWUpKTtcclxuXHRcdFx0XHRcdH1cclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0XHJcblx0XHRcdH1cclxuXHJcblx0XHR9XHJcblxyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gRGVjb3JhdGlvbi5zZXQod2lkZ2V0cywgdHJ1ZSlcclxufVxyXG5cclxuZnVuY3Rpb24gZ2V0RW5jbG9zaW5nQnJhY2tldHNQb3ModmlldzogRWRpdG9yVmlldywgcG9zOiBudW1iZXIpIHtcclxuXHJcblx0Y29uc3QgcmVzdWx0ID0gZ2V0RXF1YXRpb25Cb3VuZHModmlldy5zdGF0ZSk7XHJcblx0aWYgKCFyZXN1bHQpIHJldHVybiAtMTtcclxuXHRjb25zdCB7c3RhcnQsIGVuZH0gPSByZXN1bHQ7XHJcblx0Y29uc3QgdGV4dCA9IHZpZXcuc3RhdGUuZG9jLnNsaWNlU3RyaW5nKHN0YXJ0LCBlbmQpO1xyXG5cclxuXHJcblx0Zm9yIChsZXQgaSA9IHBvcy1zdGFydDsgaSA+IDA7IGktLSkge1xyXG5cdFx0bGV0IGN1ckNoYXIgPSB0ZXh0LmNoYXJBdChpKTtcclxuXHJcblxyXG5cdFx0aWYgKFtcIilcIiwgXCJdXCIsIFwifVwiXS5jb250YWlucyhjdXJDaGFyKSkge1xyXG5cdFx0XHRjb25zdCBjbG9zZUJyYWNrZXQgPSBjdXJDaGFyO1xyXG5cdFx0XHRjb25zdCBvcGVuQnJhY2tldCA9IGdldE9wZW5CcmFja2V0KGNsb3NlQnJhY2tldCk7XHJcblxyXG5cdFx0XHRjb25zdCBqID0gZmluZE1hdGNoaW5nQnJhY2tldCh0ZXh0LCBpLCBvcGVuQnJhY2tldCwgY2xvc2VCcmFja2V0LCB0cnVlKTtcclxuXHJcblx0XHRcdGlmIChqID09PSAtMSkgcmV0dXJuIC0xO1xyXG5cclxuXHRcdFx0Ly8gU2tpcCB0byB0aGUgYmVnaW5ubmluZyBvZiB0aGUgYnJhY2tldFxyXG5cdFx0XHRpID0gajtcclxuXHRcdFx0Y3VyQ2hhciA9IHRleHQuY2hhckF0KGkpO1xyXG5cdFx0fVxyXG5cdFx0ZWxzZSB7XHJcblxyXG5cdFx0XHRpZiAoIVtcIntcIiwgXCIoXCIsIFwiW1wiXS5jb250YWlucyhjdXJDaGFyKSkgY29udGludWU7XHJcblxyXG5cdFx0XHRjb25zdCBqID0gZmluZE1hdGNoaW5nQnJhY2tldCh0ZXh0LCBpLCBjdXJDaGFyLCBnZXRDbG9zZUJyYWNrZXQoY3VyQ2hhciksIGZhbHNlKTtcclxuXHRcdFx0aWYgKGogPT09IC0xKSBjb250aW51ZTtcclxuXHJcblx0XHRcdHJldHVybiB7bGVmdDogaSArIHN0YXJ0LCByaWdodDogaiArIHN0YXJ0fTtcclxuXHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gLTE7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGhpZ2hsaWdodEN1cnNvckJyYWNrZXRzKHZpZXc6IEVkaXRvclZpZXcpIHtcclxuXHJcblx0Y29uc3Qgd2lkZ2V0czogUmFuZ2U8RGVjb3JhdGlvbj5bXSA9IFtdXHJcblx0Y29uc3Qgc2VsZWN0aW9uID0gdmlldy5zdGF0ZS5zZWxlY3Rpb247XHJcblx0Y29uc3QgcmFuZ2VzID0gc2VsZWN0aW9uLnJhbmdlcztcclxuXHRjb25zdCB0ZXh0ID0gdmlldy5zdGF0ZS5kb2MudG9TdHJpbmcoKTtcclxuXHRjb25zdCBjdHggPSBDb250ZXh0LmZyb21WaWV3KHZpZXcpO1xyXG5cclxuXHRpZiAoIWN0eC5tb2RlLmluTWF0aCgpKSB7XHJcblx0XHRyZXR1cm4gRGVjb3JhdGlvbi5ub25lO1xyXG5cdH1cclxuXHJcblx0Y29uc3QgYm91bmRzID0gY3R4LmdldEJvdW5kcyhzZWxlY3Rpb24ubWFpbi50byk7XHJcblx0aWYgKCFib3VuZHMpIHJldHVybiBEZWNvcmF0aW9uLm5vbmU7XHJcblx0Y29uc3QgZXFuID0gdmlldy5zdGF0ZS5kb2Muc2xpY2VTdHJpbmcoYm91bmRzLnN0YXJ0LCBib3VuZHMuZW5kKTtcclxuXHJcblx0Y29uc3Qgb3BlbkJyYWNrZXRzID0gW1wie1wiLCBcIltcIiwgXCIoXCJdO1xyXG5cdGNvbnN0IGJyYWNrZXRzID0gW1wie1wiLCBcIltcIiwgXCIoXCIsIFwifVwiLCBcIl1cIiwgXCIpXCJdO1xyXG5cclxuXHRsZXQgZG9uZSA9IGZhbHNlO1xyXG5cclxuXHRmb3IgKGNvbnN0IHJhbmdlIG9mIHJhbmdlcykge1xyXG5cclxuXHRcdGZvciAobGV0IGkgPSByYW5nZS50bzsgaSA+IHJhbmdlLmZyb20gLSAyOyBpLS0pIHtcclxuXHRcdFx0Y29uc3QgY2hhciA9IHRleHQuY2hhckF0KGkpO1xyXG5cdFx0XHRpZiAoIWJyYWNrZXRzLmNvbnRhaW5zKGNoYXIpKSBjb250aW51ZTtcclxuXHJcblx0XHRcdGxldCBvcGVuQnJhY2tldCwgY2xvc2VCcmFja2V0O1xyXG5cdFx0XHRsZXQgYmFja3dhcmRzID0gZmFsc2U7XHJcblxyXG5cdFx0XHRpZiAob3BlbkJyYWNrZXRzLmNvbnRhaW5zKGNoYXIpKSB7XHJcblx0XHRcdFx0b3BlbkJyYWNrZXQgPSBjaGFyO1xyXG5cdFx0XHRcdGNsb3NlQnJhY2tldCA9IGdldENsb3NlQnJhY2tldChvcGVuQnJhY2tldCk7XHJcblx0XHRcdH1cclxuXHRcdFx0ZWxzZSB7XHJcblx0XHRcdFx0Y2xvc2VCcmFja2V0ID0gY2hhcjtcclxuXHRcdFx0XHRvcGVuQnJhY2tldCA9IGdldE9wZW5CcmFja2V0KGNoYXIpO1xyXG5cdFx0XHRcdGJhY2t3YXJkcyA9IHRydWU7XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGxldCBqID0gZmluZE1hdGNoaW5nQnJhY2tldChlcW4sIGkgLSBib3VuZHMuc3RhcnQsIG9wZW5CcmFja2V0LCBjbG9zZUJyYWNrZXQsIGJhY2t3YXJkcyk7XHJcblxyXG5cdFx0XHRpZiAoaiA9PT0gLTEpIGNvbnRpbnVlO1xyXG5cdFx0XHRqID0gaiArIGJvdW5kcy5zdGFydDtcclxuXHJcblxyXG5cdFx0XHR3aWRnZXRzLnB1c2goZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsoaSwgXCJsYXRleC1zdWl0ZS1oaWdobGlnaHRlZC1icmFja2V0XCIpKTtcclxuXHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKGosIFwibGF0ZXgtc3VpdGUtaGlnaGxpZ2h0ZWQtYnJhY2tldFwiKSk7XHJcblx0XHRcdGRvbmUgPSB0cnVlO1xyXG5cdFx0XHRicmVhaztcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoZG9uZSkgYnJlYWs7XHJcblxyXG5cdFx0Ly8gSGlnaGxpZ2h0IGJyYWNrZXRzIGVuY2xvc2luZyB0aGUgY3Vyc29yXHJcblx0XHRpZiAocmFuZ2UuZW1wdHkpIHtcclxuXHRcdFx0Y29uc3QgcG9zID0gcmFuZ2UuZnJvbSAtIDE7XHJcblxyXG5cdFx0XHRjb25zdCByZXN1bHQgPSBnZXRFbmNsb3NpbmdCcmFja2V0c1Bvcyh2aWV3LCBwb3MpO1xyXG5cdFx0XHRpZiAocmVzdWx0ID09PSAtMSkgY29udGludWU7XHJcblxyXG5cdFx0XHR3aWRnZXRzLnB1c2goZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsocmVzdWx0LmxlZnQsIFwibGF0ZXgtc3VpdGUtaGlnaGxpZ2h0ZWQtYnJhY2tldFwiKSk7XHJcblx0XHRcdHdpZGdldHMucHVzaChnZXRIaWdobGlnaHRCcmFja2V0TWFyayhyZXN1bHQucmlnaHQsIFwibGF0ZXgtc3VpdGUtaGlnaGxpZ2h0ZWQtYnJhY2tldFwiKSk7XHJcblx0XHRcdGRvbmUgPSB0cnVlO1xyXG5cdFx0XHRicmVhaztcclxuXHRcdH1cclxuXHJcblx0XHRpZiAoZG9uZSkgYnJlYWs7XHJcblx0fVxyXG5cclxuXHRyZXR1cm4gRGVjb3JhdGlvbi5zZXQod2lkZ2V0cywgdHJ1ZSk7XHJcbn1cclxuXHJcblxyXG5leHBvcnQgY29uc3QgY29sb3JQYWlyZWRCcmFja2V0c1BsdWdpbiA9IFZpZXdQbHVnaW4uZnJvbUNsYXNzKGNsYXNzIHtcclxuXHRkZWNvcmF0aW9uczogRGVjb3JhdGlvblNldDtcclxuXHJcblx0Y29uc3RydWN0b3IodmlldzogRWRpdG9yVmlldykge1xyXG5cdFx0dGhpcy5kZWNvcmF0aW9ucyA9IGNvbG9yUGFpcmVkQnJhY2tldHModmlldyk7XHJcblx0fVxyXG5cclxuXHR1cGRhdGUodXBkYXRlOiBWaWV3VXBkYXRlKSB7XHJcblx0XHRpZiAodXBkYXRlLmRvY0NoYW5nZWQgfHwgdXBkYXRlLnZpZXdwb3J0Q2hhbmdlZCkge1xyXG5cdFx0XHR0aGlzLmRlY29yYXRpb25zID0gY29sb3JQYWlyZWRCcmFja2V0cyh1cGRhdGUudmlldyk7XHJcblx0XHR9XHJcblx0fVxyXG5cclxufSwgeyBkZWNvcmF0aW9uczogdiA9PiB2LmRlY29yYXRpb25zLCB9KTtcclxuXHJcblxyXG5leHBvcnQgY29uc3QgY29sb3JQYWlyZWRCcmFja2V0c1BsdWdpbkxvd2VzdFByZWMgPSBQcmVjLmxvd2VzdChjb2xvclBhaXJlZEJyYWNrZXRzUGx1Z2luLmV4dGVuc2lvbik7XHJcblxyXG5leHBvcnQgY29uc3QgaGlnaGxpZ2h0Q3Vyc29yQnJhY2tldHNQbHVnaW4gPSBWaWV3UGx1Z2luLmZyb21DbGFzcyhjbGFzcyB7XHJcblx0ZGVjb3JhdGlvbnM6IERlY29yYXRpb25TZXQ7XHJcblxyXG5cdGNvbnN0cnVjdG9yKHZpZXc6IEVkaXRvclZpZXcpIHtcclxuXHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBoaWdobGlnaHRDdXJzb3JCcmFja2V0cyh2aWV3KTtcclxuXHR9XHJcblxyXG5cdHVwZGF0ZSh1cGRhdGU6IFZpZXdVcGRhdGUpIHtcclxuXHRcdGlmICh1cGRhdGUuZG9jQ2hhbmdlZCB8fCB1cGRhdGUuc2VsZWN0aW9uU2V0KVxyXG5cdFx0XHR0aGlzLmRlY29yYXRpb25zID0gaGlnaGxpZ2h0Q3Vyc29yQnJhY2tldHModXBkYXRlLnZpZXcpO1xyXG5cdH1cclxuXHJcbn0sIHsgZGVjb3JhdGlvbnM6IHYgPT4gdi5kZWNvcmF0aW9ucywgfSk7XHJcbiJdfQ==