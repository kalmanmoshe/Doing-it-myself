import { Decoration, ViewPlugin } from "@codemirror/view";
import { Prec } from "@codemirror/state";
import { findMatchingBracket, getOpenBracket, getCloseBracket } from "../utils/editor_utils";
import { syntaxTree } from "@codemirror/language";
import { Context, getEquationBounds } from "src/utils/context";
const Ncolors = 3;
function getHighlightBracketMark(pos, className) {
    return Decoration.mark({
        inclusive: true,
        attributes: {},
        class: className
    }).range(pos, pos + 1);
}
function colorPairedBrackets(view) {
    const widgets = [];
    for (const { from, to } of view.visibleRanges) {
        syntaxTree(view.state).iterate({ from, to, enter: (node) => {
                const type = node.type;
                const to = node.to;
                if (!(type.name.contains("begin") && type.name.contains("math"))) {
                    return;
                }
                const bounds = getEquationBounds(view.state, to);
                if (!bounds)
                    return;
                const eqn = view.state.doc.sliceString(bounds.start, bounds.end);
                const openBrackets = ["{", "[", "("];
                const closeBrackets = ["}", "]", ")"];
                const bracketsStack = [];
                const bracketsPosStack = [];
                for (let i = 0; i < eqn.length; i++) {
                    const char = eqn.charAt(i);
                    if (openBrackets.contains(char)) {
                        bracketsStack.push(char);
                        bracketsPosStack.push(i);
                    }
                    else if (closeBrackets.contains(char)) {
                        const lastBracket = bracketsStack.at(-1);
                        const lastBracketPos = bracketsPosStack.at(-1);
                        if (lastBracket !== undefined && lastBracketPos !== undefined && getCloseBracket(lastBracket) === char) {
                            bracketsStack.pop();
                            bracketsPosStack.pop();
                            const depth = bracketsStack.length % Ncolors;
                            const className = "latex-suite-color-bracket-" + depth;
                            const j = lastBracketPos + bounds.start;
                            const k = i + bounds.start;
                            widgets.push(getHighlightBracketMark(j, className));
                            widgets.push(getHighlightBracketMark(k, className));
                        }
                    }
                }
            }
        });
    }
    return Decoration.set(widgets, true);
}
function getEnclosingBracketsPos(view, pos) {
    const result = getEquationBounds(view.state);
    if (!result)
        return -1;
    const { start, end } = result;
    const text = view.state.doc.sliceString(start, end);
    for (let i = pos - start; i > 0; i--) {
        let curChar = text.charAt(i);
        if ([")", "]", "}"].contains(curChar)) {
            const closeBracket = curChar;
            const openBracket = getOpenBracket(closeBracket);
            const j = findMatchingBracket(text, i, openBracket, closeBracket, true);
            if (j === -1)
                return -1;
            // Skip to the beginnning of the bracket
            i = j;
            curChar = text.charAt(i);
        }
        else {
            if (!["{", "(", "["].contains(curChar))
                continue;
            const j = findMatchingBracket(text, i, curChar, getCloseBracket(curChar), false);
            if (j === -1)
                continue;
            return { left: i + start, right: j + start };
        }
    }
    return -1;
}
function highlightCursorBrackets(view) {
    const widgets = [];
    const selection = view.state.selection;
    const ranges = selection.ranges;
    const text = view.state.doc.toString();
    const ctx = Context.fromView(view);
    if (!ctx.mode.inMath()) {
        return Decoration.none;
    }
    const bounds = ctx.getBounds(selection.main.to);
    if (!bounds)
        return Decoration.none;
    const eqn = view.state.doc.sliceString(bounds.start, bounds.end);
    const openBrackets = ["{", "[", "("];
    const brackets = ["{", "[", "(", "}", "]", ")"];
    let done = false;
    for (const range of ranges) {
        for (let i = range.to; i > range.from - 2; i--) {
            const char = text.charAt(i);
            if (!brackets.contains(char))
                continue;
            let openBracket, closeBracket;
            let backwards = false;
            if (openBrackets.contains(char)) {
                openBracket = char;
                closeBracket = getCloseBracket(openBracket);
            }
            else {
                closeBracket = char;
                openBracket = getOpenBracket(char);
                backwards = true;
            }
            let j = findMatchingBracket(eqn, i - bounds.start, openBracket, closeBracket, backwards);
            if (j === -1)
                continue;
            j = j + bounds.start;
            widgets.push(getHighlightBracketMark(i, "latex-suite-highlighted-bracket"));
            widgets.push(getHighlightBracketMark(j, "latex-suite-highlighted-bracket"));
            done = true;
            break;
        }
        if (done)
            break;
        // Highlight brackets enclosing the cursor
        if (range.empty) {
            const pos = range.from - 1;
            const result = getEnclosingBracketsPos(view, pos);
            if (result === -1)
                continue;
            widgets.push(getHighlightBracketMark(result.left, "latex-suite-highlighted-bracket"));
            widgets.push(getHighlightBracketMark(result.right, "latex-suite-highlighted-bracket"));
            done = true;
            break;
        }
        if (done)
            break;
    }
    return Decoration.set(widgets, true);
}
export const colorPairedBracketsPlugin = ViewPlugin.fromClass(class {
    constructor(view) {
        this.decorations = colorPairedBrackets(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = colorPairedBrackets(update.view);
        }
    }
}, { decorations: v => v.decorations, });
export const colorPairedBracketsPluginLowestPrec = Prec.lowest(colorPairedBracketsPlugin.extension);
export const highlightCursorBracketsPlugin = ViewPlugin.fromClass(class {
    constructor(view) {
        this.decorations = highlightCursorBrackets(view);
    }
    update(update) {
        if (update.docChanged || update.selectionSet)
            this.decorations = highlightCursorBrackets(update.view);
    }
}, { decorations: v => v.decorations, });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0X2JyYWNrZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2VkaXRvcl9leHRlbnNpb25zL2hpZ2hsaWdodF9icmFja2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQTBCLFVBQVUsRUFBaUIsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakcsT0FBTyxFQUFFLElBQUksRUFBUyxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0YsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUUvRCxNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFFbEIsU0FBUyx1QkFBdUIsQ0FBQyxHQUFXLEVBQUUsU0FBaUI7SUFDOUQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3RCLFNBQVMsRUFBRSxJQUFJO1FBQ2YsVUFBVSxFQUFFLEVBQUU7UUFDZCxLQUFLLEVBQUUsU0FBUztLQUNoQixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsSUFBZ0I7SUFDNUMsTUFBTSxPQUFPLEdBQXdCLEVBQUUsQ0FBQztJQUV4QyxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRS9DLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDMUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDdkIsTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEVBQUUsQ0FBQztnQkFFbkIsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDO29CQUNsRSxPQUFPO2dCQUNSLENBQUM7Z0JBRUQsTUFBTSxNQUFNLEdBQUcsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFDakQsSUFBSSxDQUFDLE1BQU07b0JBQUUsT0FBTztnQkFHcEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUdqRSxNQUFNLFlBQVksR0FBRyxDQUFDLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7Z0JBQ3JDLE1BQU0sYUFBYSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztnQkFFdEMsTUFBTSxhQUFhLEdBQUcsRUFBRSxDQUFDO2dCQUN6QixNQUFNLGdCQUFnQixHQUFHLEVBQUUsQ0FBQztnQkFFNUIsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEdBQUcsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztvQkFDckMsTUFBTSxJQUFJLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFFM0IsSUFBSSxZQUFZLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7d0JBQ2pDLGFBQWEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7d0JBQ3pCLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDMUIsQ0FBQzt5QkFDSSxJQUFJLGFBQWEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQzt3QkFDdkMsTUFBTSxXQUFXLEdBQUcsYUFBYSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO3dCQUN6QyxNQUFNLGNBQWMsR0FBRyxnQkFBZ0IsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFFL0MsSUFBSSxXQUFXLEtBQUssU0FBUyxJQUFJLGNBQWMsS0FBSyxTQUFTLElBQUksZUFBZSxDQUFDLFdBQVcsQ0FBQyxLQUFLLElBQUksRUFBRSxDQUFDOzRCQUN4RyxhQUFhLENBQUMsR0FBRyxFQUFFLENBQUM7NEJBQ3BCLGdCQUFnQixDQUFDLEdBQUcsRUFBRSxDQUFDOzRCQUN2QixNQUFNLEtBQUssR0FBRyxhQUFhLENBQUMsTUFBTSxHQUFHLE9BQU8sQ0FBQzs0QkFFN0MsTUFBTSxTQUFTLEdBQUcsNEJBQTRCLEdBQUcsS0FBSyxDQUFDOzRCQUV2RCxNQUFNLENBQUMsR0FBRyxjQUFjLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQzs0QkFDeEMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7NEJBRTNCLE9BQU8sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7NEJBQ3BELE9BQU8sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDLENBQUM7d0JBQ3JELENBQUM7b0JBQ0YsQ0FBQztnQkFFRixDQUFDO1lBRUYsQ0FBQztTQUVBLENBQUMsQ0FBQztJQUNKLENBQUM7SUFFRCxPQUFPLFVBQVUsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxDQUFBO0FBQ3JDLENBQUM7QUFFRCxTQUFTLHVCQUF1QixDQUFDLElBQWdCLEVBQUUsR0FBVztJQUU3RCxNQUFNLE1BQU0sR0FBRyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0MsSUFBSSxDQUFDLE1BQU07UUFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQ3ZCLE1BQU0sRUFBQyxLQUFLLEVBQUUsR0FBRyxFQUFDLEdBQUcsTUFBTSxDQUFDO0lBQzVCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFHcEQsS0FBSyxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUMsS0FBSyxFQUFFLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztRQUNwQyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRzdCLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDO1lBQ3ZDLE1BQU0sWUFBWSxHQUFHLE9BQU8sQ0FBQztZQUM3QixNQUFNLFdBQVcsR0FBRyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7WUFFakQsTUFBTSxDQUFDLEdBQUcsbUJBQW1CLENBQUMsSUFBSSxFQUFFLENBQUMsRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRXhFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztnQkFBRSxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBRXhCLHdDQUF3QztZQUN4QyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ04sT0FBTyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDMUIsQ0FBQzthQUNJLENBQUM7WUFFTCxJQUFJLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUM7Z0JBQUUsU0FBUztZQUVqRCxNQUFNLENBQUMsR0FBRyxtQkFBbUIsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxFQUFFLE9BQU8sRUFBRSxlQUFlLENBQUMsT0FBTyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDakYsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUFFLFNBQVM7WUFFdkIsT0FBTyxFQUFDLElBQUksRUFBRSxDQUFDLEdBQUcsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLEdBQUcsS0FBSyxFQUFDLENBQUM7UUFFNUMsQ0FBQztJQUNGLENBQUM7SUFFRCxPQUFPLENBQUMsQ0FBQyxDQUFDO0FBQ1gsQ0FBQztBQUVELFNBQVMsdUJBQXVCLENBQUMsSUFBZ0I7SUFFaEQsTUFBTSxPQUFPLEdBQXdCLEVBQUUsQ0FBQTtJQUN2QyxNQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQztJQUN2QyxNQUFNLE1BQU0sR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDO0lBQ2hDLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ3ZDLE1BQU0sR0FBRyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7SUFFbkMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQztRQUN4QixPQUFPLFVBQVUsQ0FBQyxJQUFJLENBQUM7SUFDeEIsQ0FBQztJQUVELE1BQU0sTUFBTSxHQUFHLEdBQUcsQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUNoRCxJQUFJLENBQUMsTUFBTTtRQUFFLE9BQU8sVUFBVSxDQUFDLElBQUksQ0FBQztJQUNwQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7SUFFakUsTUFBTSxZQUFZLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0lBQ3JDLE1BQU0sUUFBUSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUVoRCxJQUFJLElBQUksR0FBRyxLQUFLLENBQUM7SUFFakIsS0FBSyxNQUFNLEtBQUssSUFBSSxNQUFNLEVBQUUsQ0FBQztRQUU1QixLQUFLLElBQUksQ0FBQyxHQUFHLEtBQUssQ0FBQyxFQUFFLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDaEQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QixJQUFJLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUM7Z0JBQUUsU0FBUztZQUV2QyxJQUFJLFdBQVcsRUFBRSxZQUFZLENBQUM7WUFDOUIsSUFBSSxTQUFTLEdBQUcsS0FBSyxDQUFDO1lBRXRCLElBQUksWUFBWSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDO2dCQUNqQyxXQUFXLEdBQUcsSUFBSSxDQUFDO2dCQUNuQixZQUFZLEdBQUcsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzdDLENBQUM7aUJBQ0ksQ0FBQztnQkFDTCxZQUFZLEdBQUcsSUFBSSxDQUFDO2dCQUNwQixXQUFXLEdBQUcsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNuQyxTQUFTLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLENBQUM7WUFFRCxJQUFJLENBQUMsR0FBRyxtQkFBbUIsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLEVBQUUsV0FBVyxFQUFFLFlBQVksRUFBRSxTQUFTLENBQUMsQ0FBQztZQUV6RixJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQUUsU0FBUztZQUN2QixDQUFDLEdBQUcsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFHckIsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDLEVBQUUsaUNBQWlDLENBQUMsQ0FBQyxDQUFDO1lBQzVFLE9BQU8sQ0FBQyxJQUFJLENBQUMsdUJBQXVCLENBQUMsQ0FBQyxFQUFFLGlDQUFpQyxDQUFDLENBQUMsQ0FBQztZQUM1RSxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBQ1osTUFBTTtRQUNQLENBQUM7UUFFRCxJQUFJLElBQUk7WUFBRSxNQUFNO1FBRWhCLDBDQUEwQztRQUMxQyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNqQixNQUFNLEdBQUcsR0FBRyxLQUFLLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztZQUUzQixNQUFNLE1BQU0sR0FBRyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFDbEQsSUFBSSxNQUFNLEtBQUssQ0FBQyxDQUFDO2dCQUFFLFNBQVM7WUFFNUIsT0FBTyxDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLGlDQUFpQyxDQUFDLENBQUMsQ0FBQztZQUN0RixPQUFPLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxLQUFLLEVBQUUsaUNBQWlDLENBQUMsQ0FBQyxDQUFDO1lBQ3ZGLElBQUksR0FBRyxJQUFJLENBQUM7WUFDWixNQUFNO1FBQ1AsQ0FBQztRQUVELElBQUksSUFBSTtZQUFFLE1BQU07SUFDakIsQ0FBQztJQUVELE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDdEMsQ0FBQztBQUdELE1BQU0sQ0FBQyxNQUFNLHlCQUF5QixHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7SUFHN0QsWUFBWSxJQUFnQjtRQUMzQixJQUFJLENBQUMsV0FBVyxHQUFHLG1CQUFtQixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzlDLENBQUM7SUFFRCxNQUFNLENBQUMsTUFBa0I7UUFDeEIsSUFBSSxNQUFNLENBQUMsVUFBVSxJQUFJLE1BQU0sQ0FBQyxlQUFlLEVBQUUsQ0FBQztZQUNqRCxJQUFJLENBQUMsV0FBVyxHQUFHLG1CQUFtQixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNyRCxDQUFDO0lBQ0YsQ0FBQztDQUVELEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztBQUd6QyxNQUFNLENBQUMsTUFBTSxtQ0FBbUMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRXBHLE1BQU0sQ0FBQyxNQUFNLDZCQUE2QixHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7SUFHakUsWUFBWSxJQUFnQjtRQUMzQixJQUFJLENBQUMsV0FBVyxHQUFHLHVCQUF1QixDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2xELENBQUM7SUFFRCxNQUFNLENBQUMsTUFBa0I7UUFDeEIsSUFBSSxNQUFNLENBQUMsVUFBVSxJQUFJLE1BQU0sQ0FBQyxZQUFZO1lBQzNDLElBQUksQ0FBQyxXQUFXLEdBQUcsdUJBQXVCLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzFELENBQUM7Q0FFRCxFQUFFLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLFdBQVcsR0FBRyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBFZGl0b3JWaWV3LCBWaWV3VXBkYXRlLCBEZWNvcmF0aW9uLCBEZWNvcmF0aW9uU2V0LCBWaWV3UGx1Z2luIH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcclxuaW1wb3J0IHsgUHJlYywgUmFuZ2UgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcclxuaW1wb3J0IHsgZmluZE1hdGNoaW5nQnJhY2tldCwgZ2V0T3BlbkJyYWNrZXQsIGdldENsb3NlQnJhY2tldCB9IGZyb20gXCIuLi91dGlscy9lZGl0b3JfdXRpbHNcIjtcclxuaW1wb3J0IHsgc3ludGF4VHJlZSB9IGZyb20gXCJAY29kZW1pcnJvci9sYW5ndWFnZVwiO1xyXG5pbXBvcnQgeyBDb250ZXh0LCBnZXRFcXVhdGlvbkJvdW5kcyB9IGZyb20gXCJzcmMvdXRpbHMvY29udGV4dFwiO1xyXG5cclxuY29uc3QgTmNvbG9ycyA9IDM7XHJcblxyXG5mdW5jdGlvbiBnZXRIaWdobGlnaHRCcmFja2V0TWFyayhwb3M6IG51bWJlciwgY2xhc3NOYW1lOiBzdHJpbmcpOlJhbmdlPERlY29yYXRpb24+IHtcclxuXHRyZXR1cm4gRGVjb3JhdGlvbi5tYXJrKHtcclxuXHRcdGluY2x1c2l2ZTogdHJ1ZSxcclxuXHRcdGF0dHJpYnV0ZXM6IHt9LFxyXG5cdFx0Y2xhc3M6IGNsYXNzTmFtZVxyXG5cdH0pLnJhbmdlKHBvcywgcG9zKzEpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBjb2xvclBhaXJlZEJyYWNrZXRzKHZpZXc6IEVkaXRvclZpZXcpIHtcclxuXHRjb25zdCB3aWRnZXRzOiBSYW5nZTxEZWNvcmF0aW9uPltdID0gW107XHJcblxyXG5cdGZvciAoY29uc3QgeyBmcm9tLCB0byB9IG9mIHZpZXcudmlzaWJsZVJhbmdlcykge1xyXG5cclxuXHRcdHN5bnRheFRyZWUodmlldy5zdGF0ZSkuaXRlcmF0ZSh7IGZyb20sIHRvLCBlbnRlcjogKG5vZGUpID0+IHtcclxuXHRcdFx0Y29uc3QgdHlwZSA9IG5vZGUudHlwZTtcclxuXHRcdFx0Y29uc3QgdG8gPSBub2RlLnRvO1xyXG5cclxuXHRcdFx0aWYgKCEodHlwZS5uYW1lLmNvbnRhaW5zKFwiYmVnaW5cIikgJiYgdHlwZS5uYW1lLmNvbnRhaW5zKFwibWF0aFwiKSkpIHtcclxuXHRcdFx0XHRyZXR1cm47XHJcblx0XHRcdH1cclxuXHJcblx0XHRcdGNvbnN0IGJvdW5kcyA9IGdldEVxdWF0aW9uQm91bmRzKHZpZXcuc3RhdGUsIHRvKTtcclxuXHRcdFx0aWYgKCFib3VuZHMpIHJldHVybjtcclxuXHJcblxyXG5cdFx0XHRjb25zdCBlcW4gPSB2aWV3LnN0YXRlLmRvYy5zbGljZVN0cmluZyhib3VuZHMuc3RhcnQsIGJvdW5kcy5lbmQpO1xyXG5cclxuXHJcblx0XHRcdGNvbnN0IG9wZW5CcmFja2V0cyA9IFtcIntcIiwgXCJbXCIsIFwiKFwiXTtcclxuXHRcdFx0Y29uc3QgY2xvc2VCcmFja2V0cyA9IFtcIn1cIiwgXCJdXCIsIFwiKVwiXTtcclxuXHJcblx0XHRcdGNvbnN0IGJyYWNrZXRzU3RhY2sgPSBbXTtcclxuXHRcdFx0Y29uc3QgYnJhY2tldHNQb3NTdGFjayA9IFtdO1xyXG5cclxuXHRcdFx0Zm9yIChsZXQgaSA9IDA7IGkgPCBlcW4ubGVuZ3RoOyBpKyspIHtcclxuXHRcdFx0XHRjb25zdCBjaGFyID0gZXFuLmNoYXJBdChpKTtcclxuXHJcblx0XHRcdFx0aWYgKG9wZW5CcmFja2V0cy5jb250YWlucyhjaGFyKSkge1xyXG5cdFx0XHRcdFx0YnJhY2tldHNTdGFjay5wdXNoKGNoYXIpO1xyXG5cdFx0XHRcdFx0YnJhY2tldHNQb3NTdGFjay5wdXNoKGkpO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRlbHNlIGlmIChjbG9zZUJyYWNrZXRzLmNvbnRhaW5zKGNoYXIpKSB7XHJcblx0XHRcdFx0XHRjb25zdCBsYXN0QnJhY2tldCA9IGJyYWNrZXRzU3RhY2suYXQoLTEpO1xyXG5cdFx0XHRcdFx0Y29uc3QgbGFzdEJyYWNrZXRQb3MgPSBicmFja2V0c1Bvc1N0YWNrLmF0KC0xKTtcclxuXHRcdFx0XHRcclxuXHRcdFx0XHRcdGlmIChsYXN0QnJhY2tldCAhPT0gdW5kZWZpbmVkICYmIGxhc3RCcmFja2V0UG9zICE9PSB1bmRlZmluZWQgJiYgZ2V0Q2xvc2VCcmFja2V0KGxhc3RCcmFja2V0KSA9PT0gY2hhcikge1xyXG5cdFx0XHRcdFx0XHRicmFja2V0c1N0YWNrLnBvcCgpO1xyXG5cdFx0XHRcdFx0XHRicmFja2V0c1Bvc1N0YWNrLnBvcCgpO1xyXG5cdFx0XHRcdFx0XHRjb25zdCBkZXB0aCA9IGJyYWNrZXRzU3RhY2subGVuZ3RoICUgTmNvbG9ycztcclxuXHRcdFx0XHRcclxuXHRcdFx0XHRcdFx0Y29uc3QgY2xhc3NOYW1lID0gXCJsYXRleC1zdWl0ZS1jb2xvci1icmFja2V0LVwiICsgZGVwdGg7XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0XHRcdGNvbnN0IGogPSBsYXN0QnJhY2tldFBvcyArIGJvdW5kcy5zdGFydDtcclxuXHRcdFx0XHRcdFx0Y29uc3QgayA9IGkgKyBib3VuZHMuc3RhcnQ7XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0XHRcdHdpZGdldHMucHVzaChnZXRIaWdobGlnaHRCcmFja2V0TWFyayhqLCBjbGFzc05hbWUpKTtcclxuXHRcdFx0XHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKGssIGNsYXNzTmFtZSkpO1xyXG5cdFx0XHRcdFx0fVxyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRcclxuXHRcdFx0fVxyXG5cclxuXHRcdH1cclxuXHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHJldHVybiBEZWNvcmF0aW9uLnNldCh3aWRnZXRzLCB0cnVlKVxyXG59XHJcblxyXG5mdW5jdGlvbiBnZXRFbmNsb3NpbmdCcmFja2V0c1Bvcyh2aWV3OiBFZGl0b3JWaWV3LCBwb3M6IG51bWJlcikge1xyXG5cclxuXHRjb25zdCByZXN1bHQgPSBnZXRFcXVhdGlvbkJvdW5kcyh2aWV3LnN0YXRlKTtcclxuXHRpZiAoIXJlc3VsdCkgcmV0dXJuIC0xO1xyXG5cdGNvbnN0IHtzdGFydCwgZW5kfSA9IHJlc3VsdDtcclxuXHRjb25zdCB0ZXh0ID0gdmlldy5zdGF0ZS5kb2Muc2xpY2VTdHJpbmcoc3RhcnQsIGVuZCk7XHJcblxyXG5cclxuXHRmb3IgKGxldCBpID0gcG9zLXN0YXJ0OyBpID4gMDsgaS0tKSB7XHJcblx0XHRsZXQgY3VyQ2hhciA9IHRleHQuY2hhckF0KGkpO1xyXG5cclxuXHJcblx0XHRpZiAoW1wiKVwiLCBcIl1cIiwgXCJ9XCJdLmNvbnRhaW5zKGN1ckNoYXIpKSB7XHJcblx0XHRcdGNvbnN0IGNsb3NlQnJhY2tldCA9IGN1ckNoYXI7XHJcblx0XHRcdGNvbnN0IG9wZW5CcmFja2V0ID0gZ2V0T3BlbkJyYWNrZXQoY2xvc2VCcmFja2V0KTtcclxuXHJcblx0XHRcdGNvbnN0IGogPSBmaW5kTWF0Y2hpbmdCcmFja2V0KHRleHQsIGksIG9wZW5CcmFja2V0LCBjbG9zZUJyYWNrZXQsIHRydWUpO1xyXG5cclxuXHRcdFx0aWYgKGogPT09IC0xKSByZXR1cm4gLTE7XHJcblxyXG5cdFx0XHQvLyBTa2lwIHRvIHRoZSBiZWdpbm5uaW5nIG9mIHRoZSBicmFja2V0XHJcblx0XHRcdGkgPSBqO1xyXG5cdFx0XHRjdXJDaGFyID0gdGV4dC5jaGFyQXQoaSk7XHJcblx0XHR9XHJcblx0XHRlbHNlIHtcclxuXHJcblx0XHRcdGlmICghW1wie1wiLCBcIihcIiwgXCJbXCJdLmNvbnRhaW5zKGN1ckNoYXIpKSBjb250aW51ZTtcclxuXHJcblx0XHRcdGNvbnN0IGogPSBmaW5kTWF0Y2hpbmdCcmFja2V0KHRleHQsIGksIGN1ckNoYXIsIGdldENsb3NlQnJhY2tldChjdXJDaGFyKSwgZmFsc2UpO1xyXG5cdFx0XHRpZiAoaiA9PT0gLTEpIGNvbnRpbnVlO1xyXG5cclxuXHRcdFx0cmV0dXJuIHtsZWZ0OiBpICsgc3RhcnQsIHJpZ2h0OiBqICsgc3RhcnR9O1xyXG5cclxuXHRcdH1cclxuXHR9XHJcblxyXG5cdHJldHVybiAtMTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGlnaGxpZ2h0Q3Vyc29yQnJhY2tldHModmlldzogRWRpdG9yVmlldykge1xyXG5cclxuXHRjb25zdCB3aWRnZXRzOiBSYW5nZTxEZWNvcmF0aW9uPltdID0gW11cclxuXHRjb25zdCBzZWxlY3Rpb24gPSB2aWV3LnN0YXRlLnNlbGVjdGlvbjtcclxuXHRjb25zdCByYW5nZXMgPSBzZWxlY3Rpb24ucmFuZ2VzO1xyXG5cdGNvbnN0IHRleHQgPSB2aWV3LnN0YXRlLmRvYy50b1N0cmluZygpO1xyXG5cdGNvbnN0IGN0eCA9IENvbnRleHQuZnJvbVZpZXcodmlldyk7XHJcblxyXG5cdGlmICghY3R4Lm1vZGUuaW5NYXRoKCkpIHtcclxuXHRcdHJldHVybiBEZWNvcmF0aW9uLm5vbmU7XHJcblx0fVxyXG5cclxuXHRjb25zdCBib3VuZHMgPSBjdHguZ2V0Qm91bmRzKHNlbGVjdGlvbi5tYWluLnRvKTtcclxuXHRpZiAoIWJvdW5kcykgcmV0dXJuIERlY29yYXRpb24ubm9uZTtcclxuXHRjb25zdCBlcW4gPSB2aWV3LnN0YXRlLmRvYy5zbGljZVN0cmluZyhib3VuZHMuc3RhcnQsIGJvdW5kcy5lbmQpO1xyXG5cclxuXHRjb25zdCBvcGVuQnJhY2tldHMgPSBbXCJ7XCIsIFwiW1wiLCBcIihcIl07XHJcblx0Y29uc3QgYnJhY2tldHMgPSBbXCJ7XCIsIFwiW1wiLCBcIihcIiwgXCJ9XCIsIFwiXVwiLCBcIilcIl07XHJcblxyXG5cdGxldCBkb25lID0gZmFsc2U7XHJcblxyXG5cdGZvciAoY29uc3QgcmFuZ2Ugb2YgcmFuZ2VzKSB7XHJcblxyXG5cdFx0Zm9yIChsZXQgaSA9IHJhbmdlLnRvOyBpID4gcmFuZ2UuZnJvbSAtIDI7IGktLSkge1xyXG5cdFx0XHRjb25zdCBjaGFyID0gdGV4dC5jaGFyQXQoaSk7XHJcblx0XHRcdGlmICghYnJhY2tldHMuY29udGFpbnMoY2hhcikpIGNvbnRpbnVlO1xyXG5cclxuXHRcdFx0bGV0IG9wZW5CcmFja2V0LCBjbG9zZUJyYWNrZXQ7XHJcblx0XHRcdGxldCBiYWNrd2FyZHMgPSBmYWxzZTtcclxuXHJcblx0XHRcdGlmIChvcGVuQnJhY2tldHMuY29udGFpbnMoY2hhcikpIHtcclxuXHRcdFx0XHRvcGVuQnJhY2tldCA9IGNoYXI7XHJcblx0XHRcdFx0Y2xvc2VCcmFja2V0ID0gZ2V0Q2xvc2VCcmFja2V0KG9wZW5CcmFja2V0KTtcclxuXHRcdFx0fVxyXG5cdFx0XHRlbHNlIHtcclxuXHRcdFx0XHRjbG9zZUJyYWNrZXQgPSBjaGFyO1xyXG5cdFx0XHRcdG9wZW5CcmFja2V0ID0gZ2V0T3BlbkJyYWNrZXQoY2hhcik7XHJcblx0XHRcdFx0YmFja3dhcmRzID0gdHJ1ZTtcclxuXHRcdFx0fVxyXG5cclxuXHRcdFx0bGV0IGogPSBmaW5kTWF0Y2hpbmdCcmFja2V0KGVxbiwgaSAtIGJvdW5kcy5zdGFydCwgb3BlbkJyYWNrZXQsIGNsb3NlQnJhY2tldCwgYmFja3dhcmRzKTtcclxuXHJcblx0XHRcdGlmIChqID09PSAtMSkgY29udGludWU7XHJcblx0XHRcdGogPSBqICsgYm91bmRzLnN0YXJ0O1xyXG5cclxuXHJcblx0XHRcdHdpZGdldHMucHVzaChnZXRIaWdobGlnaHRCcmFja2V0TWFyayhpLCBcImxhdGV4LXN1aXRlLWhpZ2hsaWdodGVkLWJyYWNrZXRcIikpO1xyXG5cdFx0XHR3aWRnZXRzLnB1c2goZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsoaiwgXCJsYXRleC1zdWl0ZS1oaWdobGlnaHRlZC1icmFja2V0XCIpKTtcclxuXHRcdFx0ZG9uZSA9IHRydWU7XHJcblx0XHRcdGJyZWFrO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmIChkb25lKSBicmVhaztcclxuXHJcblx0XHQvLyBIaWdobGlnaHQgYnJhY2tldHMgZW5jbG9zaW5nIHRoZSBjdXJzb3JcclxuXHRcdGlmIChyYW5nZS5lbXB0eSkge1xyXG5cdFx0XHRjb25zdCBwb3MgPSByYW5nZS5mcm9tIC0gMTtcclxuXHJcblx0XHRcdGNvbnN0IHJlc3VsdCA9IGdldEVuY2xvc2luZ0JyYWNrZXRzUG9zKHZpZXcsIHBvcyk7XHJcblx0XHRcdGlmIChyZXN1bHQgPT09IC0xKSBjb250aW51ZTtcclxuXHJcblx0XHRcdHdpZGdldHMucHVzaChnZXRIaWdobGlnaHRCcmFja2V0TWFyayhyZXN1bHQubGVmdCwgXCJsYXRleC1zdWl0ZS1oaWdobGlnaHRlZC1icmFja2V0XCIpKTtcclxuXHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKHJlc3VsdC5yaWdodCwgXCJsYXRleC1zdWl0ZS1oaWdobGlnaHRlZC1icmFja2V0XCIpKTtcclxuXHRcdFx0ZG9uZSA9IHRydWU7XHJcblx0XHRcdGJyZWFrO1xyXG5cdFx0fVxyXG5cclxuXHRcdGlmIChkb25lKSBicmVhaztcclxuXHR9XHJcblxyXG5cdHJldHVybiBEZWNvcmF0aW9uLnNldCh3aWRnZXRzLCB0cnVlKTtcclxufVxyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBjb2xvclBhaXJlZEJyYWNrZXRzUGx1Z2luID0gVmlld1BsdWdpbi5mcm9tQ2xhc3MoY2xhc3Mge1xyXG5cdGRlY29yYXRpb25zOiBEZWNvcmF0aW9uU2V0O1xyXG5cclxuXHRjb25zdHJ1Y3Rvcih2aWV3OiBFZGl0b3JWaWV3KSB7XHJcblx0XHR0aGlzLmRlY29yYXRpb25zID0gY29sb3JQYWlyZWRCcmFja2V0cyh2aWV3KTtcclxuXHR9XHJcblxyXG5cdHVwZGF0ZSh1cGRhdGU6IFZpZXdVcGRhdGUpIHtcclxuXHRcdGlmICh1cGRhdGUuZG9jQ2hhbmdlZCB8fCB1cGRhdGUudmlld3BvcnRDaGFuZ2VkKSB7XHJcblx0XHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBjb2xvclBhaXJlZEJyYWNrZXRzKHVwZGF0ZS52aWV3KTtcclxuXHRcdH1cclxuXHR9XHJcblxyXG59LCB7IGRlY29yYXRpb25zOiB2ID0+IHYuZGVjb3JhdGlvbnMsIH0pO1xyXG5cclxuXHJcbmV4cG9ydCBjb25zdCBjb2xvclBhaXJlZEJyYWNrZXRzUGx1Z2luTG93ZXN0UHJlYyA9IFByZWMubG93ZXN0KGNvbG9yUGFpcmVkQnJhY2tldHNQbHVnaW4uZXh0ZW5zaW9uKTtcclxuXHJcbmV4cG9ydCBjb25zdCBoaWdobGlnaHRDdXJzb3JCcmFja2V0c1BsdWdpbiA9IFZpZXdQbHVnaW4uZnJvbUNsYXNzKGNsYXNzIHtcclxuXHRkZWNvcmF0aW9uczogRGVjb3JhdGlvblNldDtcclxuXHJcblx0Y29uc3RydWN0b3IodmlldzogRWRpdG9yVmlldykge1xyXG5cdFx0dGhpcy5kZWNvcmF0aW9ucyA9IGhpZ2hsaWdodEN1cnNvckJyYWNrZXRzKHZpZXcpO1xyXG5cdH1cclxuXHJcblx0dXBkYXRlKHVwZGF0ZTogVmlld1VwZGF0ZSkge1xyXG5cdFx0aWYgKHVwZGF0ZS5kb2NDaGFuZ2VkIHx8IHVwZGF0ZS5zZWxlY3Rpb25TZXQpXHJcblx0XHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBoaWdobGlnaHRDdXJzb3JCcmFja2V0cyh1cGRhdGUudmlldyk7XHJcblx0fVxyXG5cclxufSwgeyBkZWNvcmF0aW9uczogdiA9PiB2LmRlY29yYXRpb25zLCB9KTtcclxuIl19