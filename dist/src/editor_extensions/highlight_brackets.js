import { Decoration, ViewPlugin } from "@codemirror/view";
import { Prec } from "@codemirror/state";
import { findMatchingBracket, getOpenBracket, getCloseBracket } from "../utils/editor_utils";
import { syntaxTree } from "@codemirror/language";
import { Context, getEquationBounds } from "src/utils/context";
const Ncolors = 3;
function getHighlightBracketMark(pos, className) {
    return Decoration.mark({
        inclusive: true,
        attributes: {},
        class: className
    }).range(pos, pos + 1);
}
function colorPairedBrackets(view) {
    const widgets = [];
    for (const { from, to } of view.visibleRanges) {
        syntaxTree(view.state).iterate({ from, to, enter: (node) => {
                const type = node.type;
                const to = node.to;
                if (!(type.name.contains("begin") && type.name.contains("math"))) {
                    return;
                }
                const bounds = getEquationBounds(view.state, to);
                if (!bounds)
                    return;
                const eqn = view.state.doc.sliceString(bounds.start, bounds.end);
                const openBrackets = ["{", "[", "("];
                const closeBrackets = ["}", "]", ")"];
                const bracketsStack = [];
                const bracketsPosStack = [];
                for (let i = 0; i < eqn.length; i++) {
                    const char = eqn.charAt(i);
                    if (openBrackets.contains(char)) {
                        bracketsStack.push(char);
                        bracketsPosStack.push(i);
                    }
                    else if (closeBrackets.contains(char)) {
                        const lastBracket = bracketsStack.at(-1);
                        const lastBracketPos = bracketsPosStack.at(-1);
                        if (lastBracket !== undefined && lastBracketPos !== undefined && getCloseBracket(lastBracket) === char) {
                            bracketsStack.pop();
                            bracketsPosStack.pop();
                            const depth = bracketsStack.length % Ncolors;
                            const className = "latex-suite-color-bracket-" + depth;
                            const j = lastBracketPos + bounds.start;
                            const k = i + bounds.start;
                            widgets.push(getHighlightBracketMark(j, className));
                            widgets.push(getHighlightBracketMark(k, className));
                        }
                    }
                }
            }
        });
    }
    return Decoration.set(widgets, true);
}
function getEnclosingBracketsPos(view, pos) {
    const result = getEquationBounds(view.state);
    if (!result)
        return -1;
    const { start, end } = result;
    const text = view.state.doc.sliceString(start, end);
    for (let i = pos - start; i > 0; i--) {
        let curChar = text.charAt(i);
        if ([")", "]", "}"].contains(curChar)) {
            const closeBracket = curChar;
            const openBracket = getOpenBracket(closeBracket);
            const j = findMatchingBracket(text, i, openBracket, closeBracket, true);
            if (j === -1)
                return -1;
            // Skip to the beginnning of the bracket
            i = j;
            curChar = text.charAt(i);
        }
        else {
            if (!["{", "(", "["].contains(curChar))
                continue;
            const j = findMatchingBracket(text, i, curChar, getCloseBracket(curChar), false);
            if (j === -1)
                continue;
            return { left: i + start, right: j + start };
        }
    }
    return -1;
}
function highlightCursorBrackets(view) {
    const widgets = [];
    const selection = view.state.selection;
    const ranges = selection.ranges;
    const text = view.state.doc.toString();
    const ctx = Context.fromView(view);
    if (!ctx.mode.inMath()) {
        return Decoration.none;
    }
    const bounds = ctx.getBounds(selection.main.to);
    if (!bounds)
        return Decoration.none;
    const eqn = view.state.doc.sliceString(bounds.start, bounds.end);
    const openBrackets = ["{", "[", "("];
    const brackets = ["{", "[", "(", "}", "]", ")"];
    let done = false;
    for (const range of ranges) {
        for (let i = range.to; i > range.from - 2; i--) {
            const char = text.charAt(i);
            if (!brackets.contains(char))
                continue;
            let openBracket, closeBracket;
            let backwards = false;
            if (openBrackets.contains(char)) {
                openBracket = char;
                closeBracket = getCloseBracket(openBracket);
            }
            else {
                closeBracket = char;
                openBracket = getOpenBracket(char);
                backwards = true;
            }
            let j = findMatchingBracket(eqn, i - bounds.start, openBracket, closeBracket, backwards);
            if (j === -1)
                continue;
            j = j + bounds.start;
            widgets.push(getHighlightBracketMark(i, "latex-suite-highlighted-bracket"));
            widgets.push(getHighlightBracketMark(j, "latex-suite-highlighted-bracket"));
            done = true;
            break;
        }
        if (done)
            break;
        // Highlight brackets enclosing the cursor
        if (range.empty) {
            const pos = range.from - 1;
            const result = getEnclosingBracketsPos(view, pos);
            if (result === -1)
                continue;
            widgets.push(getHighlightBracketMark(result.left, "latex-suite-highlighted-bracket"));
            widgets.push(getHighlightBracketMark(result.right, "latex-suite-highlighted-bracket"));
            done = true;
            break;
        }
        if (done)
            break;
    }
    return Decoration.set(widgets, true);
}
export const colorPairedBracketsPlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = colorPairedBrackets(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = colorPairedBrackets(update.view);
        }
    }
}, { decorations: v => v.decorations, });
export const colorPairedBracketsPluginLowestPrec = Prec.lowest(colorPairedBracketsPlugin.extension);
export const highlightCursorBracketsPlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = highlightCursorBrackets(view);
    }
    update(update) {
        if (update.docChanged || update.selectionSet)
            this.decorations = highlightCursorBrackets(update.view);
    }
}, { decorations: v => v.decorations, });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0X2JyYWNrZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2VkaXRvcl9leHRlbnNpb25zL2hpZ2hsaWdodF9icmFja2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQTBCLFVBQVUsRUFBaUIsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakcsT0FBTyxFQUFFLElBQUksRUFBUyxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0YsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUUvRCxNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFFbEIsU0FBUyx1QkFBdUIsQ0FBQyxHQUFXLEVBQUUsU0FBaUI7SUFDOUQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3RCLFNBQVMsRUFBRSxJQUFJO1FBQ2YsVUFBVSxFQUFFLEVBQUU7UUFDZCxLQUFLLEVBQUUsU0FBUztLQUNoQixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsSUFBZ0I7SUFDNUMsTUFBTSxPQUFPLEdBQXdCLEVBQUUsQ0FBQztJQUV4QyxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRS9DLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDMUQsTUFBTSxJQUFJLEdB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RUFBRSxDQUFDO1lBQ2pELElBQUksQ0FBQyxXQUFXLEdBQUcsbUJBQW1CLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3JELENBQUM7SUFDRixDQUFDO0NBRUQsRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDO0FBR3pDLE1BQU0sQ0FBQyxNQUFNLG1DQUFtQyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMseUJBQXlCLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFcEcsTUFBTSxDQUFDLE1BQU0sNkJBQTZCLEdBQUcsVUFBVSxDQUFDLFNBQVMsQ0FBQztJQUNqRSxXQUFXLENBQWdCO0lBRTNCLFlBQVksSUFBZ0I7UUFDM0IsSUFBSSxDQUFDLFdBQVcsR0FBRyx1QkFBdUIsQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUNsRCxDQUFDO0lBRUQsTUFBTSxDQUFDLE1BQWtCO1FBQ3hCLElBQUksTUFBTSxDQUFDLFVBQVUsSUFBSSxNQUFNLENBQUMsWUFBWTtZQUMzQyxJQUFJLENBQUMsV0FBVyxHQUFHLHVCQUF1QixDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMxRCxDQUFDO0NBRUQsRUFBRSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRWRpdG9yVmlldywgVmlld1VwZGF0ZSwgRGVjb3JhdGlvbiwgRGVjb3JhdGlvblNldCwgVmlld1BsdWdpbiB9IGZyb20gXCJAY29kZW1pcnJvci92aWV3XCI7XG5pbXBvcnQgeyBQcmVjLCBSYW5nZSB9IGZyb20gXCJAY29kZW1pcnJvci9zdGF0ZVwiO1xuaW1wb3J0IHsgZmluZE1hdGNoaW5nQnJhY2tldCwgZ2V0T3BlbkJyYWNrZXQsIGdldENsb3NlQnJhY2tldCB9IGZyb20gXCIuLi91dGlscy9lZGl0b3JfdXRpbHNcIjtcbmltcG9ydCB7IHN5bnRheFRyZWUgfSBmcm9tIFwiQGNvZGVtaXJyb3IvbGFuZ3VhZ2VcIjtcbmltcG9ydCB7IENvbnRleHQsIGdldEVxdWF0aW9uQm91bmRzIH0gZnJvbSBcInNyYy91dGlscy9jb250ZXh0XCI7XG5cbmNvbnN0IE5jb2xvcnMgPSAzO1xuXG5mdW5jdGlvbiBnZXRIaWdobGlnaHRCcmFja2V0TWFyayhwb3M6IG51bWJlciwgY2xhc3NOYW1lOiBzdHJpbmcpOlJhbmdlPERlY29yYXRpb24+IHtcblx0cmV0dXJuIERlY29yYXRpb24ubWFyayh7XG5cdFx0aW5jbHVzaXZlOiB0cnVlLFxuXHRcdGF0dHJpYnV0ZXM6IHt9LFxuXHRcdGNsYXNzOiBjbGFzc05hbWVcblx0fSkucmFuZ2UocG9zLCBwb3MrMSk7XG59XG5cbmZ1bmN0aW9uIGNvbG9yUGFpcmVkQnJhY2tldHModmlldzogRWRpdG9yVmlldykge1xuXHRjb25zdCB3aWRnZXRzOiBSYW5nZTxEZWNvcmF0aW9uPltdID0gW107XG5cblx0Zm9yIChjb25zdCB7IGZyb20sIHRvIH0gb2Ygdmlldy52aXNpYmxlUmFuZ2VzKSB7XG5cblx0XHRzeW50YXhUcmVlKHZpZXcuc3RhdGUpLml0ZXJhdGUoeyBmcm9tLCB0bywgZW50ZXI6IChub2RlKSA9PiB7XG5cdFx0XHRjb25zdCB0eXBlID0gbm9kZS50eXBlO1xuXHRcdFx0Y29uc3QgdG8gPSBub2RlLnRvO1xuXG5cdFx0XHRpZiAoISh0eXBlLm5hbWUuY29udGFpbnMoXCJiZWdpblwiKSAmJiB0eXBlLm5hbWUuY29udGFpbnMoXCJtYXRoXCIpKSkge1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdGNvbnN0IGJvdW5kcyA9IGdldEVxdWF0aW9uQm91bmRzKHZpZXcuc3RhdGUsIHRvKTtcblx0XHRcdGlmICghYm91bmRzKSByZXR1cm47XG5cblxuXHRcdFx0Y29uc3QgZXFuID0gdmlldy5zdGF0ZS5kb2Muc2xpY2VTdHJpbmcoYm91bmRzLnN0YXJ0LCBib3VuZHMuZW5kKTtcblxuXG5cdFx0XHRjb25zdCBvcGVuQnJhY2tldHMgPSBbXCJ7XCIsIFwiW1wiLCBcIihcIl07XG5cdFx0XHRjb25zdCBjbG9zZUJyYWNrZXRzID0gW1wifVwiLCBcIl1cIiwgXCIpXCJdO1xuXG5cdFx0XHRjb25zdCBicmFja2V0c1N0YWNrID0gW107XG5cdFx0XHRjb25zdCBicmFja2V0c1Bvc1N0YWNrID0gW107XG5cblx0XHRcdGZvciAobGV0IGkgPSAwOyBpIDwgZXFuLmxlbmd0aDsgaSsrKSB7XG5cdFx0XHRcdGNvbnN0IGNoYXIgPSBlcW4uY2hhckF0KGkpO1xuXG5cdFx0XHRcdGlmIChvcGVuQnJhY2tldHMuY29udGFpbnMoY2hhcikpIHtcblx0XHRcdFx0XHRicmFja2V0c1N0YWNrLnB1c2goY2hhcik7XG5cdFx0XHRcdFx0YnJhY2tldHNQb3NTdGFjay5wdXNoKGkpO1xuXHRcdFx0XHR9XG5cdFx0XHRcdGVsc2UgaWYgKGNsb3NlQnJhY2tldHMuY29udGFpbnMoY2hhcikpIHtcblx0XHRcdFx0XHRjb25zdCBsYXN0QnJhY2tldCA9IGJyYWNrZXRzU3RhY2suYXQoLTEpO1xuXHRcdFx0XHRcdGNvbnN0IGxhc3RCcmFja2V0UG9zID0gYnJhY2tldHNQb3NTdGFjay5hdCgtMSk7XG5cdFx0XHRcdFxuXHRcdFx0XHRcdGlmIChsYXN0QnJhY2tldCAhPT0gdW5kZWZpbmVkICYmIGxhc3RCcmFja2V0UG9zICE9PSB1bmRlZmluZWQgJiYgZ2V0Q2xvc2VCcmFja2V0KGxhc3RCcmFja2V0KSA9PT0gY2hhcikge1xuXHRcdFx0XHRcdFx0YnJhY2tldHNTdGFjay5wb3AoKTtcblx0XHRcdFx0XHRcdGJyYWNrZXRzUG9zU3RhY2sucG9wKCk7XG5cdFx0XHRcdFx0XHRjb25zdCBkZXB0aCA9IGJyYWNrZXRzU3RhY2subGVuZ3RoICUgTmNvbG9ycztcblx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjb25zdCBjbGFzc05hbWUgPSBcImxhdGV4LXN1aXRlLWNvbG9yLWJyYWNrZXQtXCIgKyBkZXB0aDtcblx0XHRcdFx0XG5cdFx0XHRcdFx0XHRjb25zdCBqID0gbGFzdEJyYWNrZXRQb3MgKyBib3VuZHMuc3RhcnQ7XG5cdFx0XHRcdFx0XHRjb25zdCBrID0gaSArIGJvdW5kcy5zdGFydDtcblx0XHRcdFx0XG5cdFx0XHRcdFx0XHR3aWRnZXRzLnB1c2goZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsoaiwgY2xhc3NOYW1lKSk7XG5cdFx0XHRcdFx0XHR3aWRnZXRzLnB1c2goZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsoaywgY2xhc3NOYW1lKSk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0XHR9XG5cdFx0XHRcdFxuXHRcdFx0fVxuXG5cdFx0fVxuXG5cdFx0fSk7XG5cdH1cblxuXHRyZXR1cm4gRGVjb3JhdGlvbi5zZXQod2lkZ2V0cywgdHJ1ZSlcbn1cblxuZnVuY3Rpb24gZ2V0RW5jbG9zaW5nQnJhY2tldHNQb3ModmlldzogRWRpdG9yVmlldywgcG9zOiBudW1iZXIpIHtcblxuXHRjb25zdCByZXN1bHQgPSBnZXRFcXVhdGlvbkJvdW5kcyh2aWV3LnN0YXRlKTtcblx0aWYgKCFyZXN1bHQpIHJldHVybiAtMTtcblx0Y29uc3Qge3N0YXJ0LCBlbmR9ID0gcmVzdWx0O1xuXHRjb25zdCB0ZXh0ID0gdmlldy5zdGF0ZS5kb2Muc2xpY2VTdHJpbmcoc3RhcnQsIGVuZCk7XG5cblxuXHRmb3IgKGxldCBpID0gcG9zLXN0YXJ0OyBpID4gMDsgaS0tKSB7XG5cdFx0bGV0IGN1ckNoYXIgPSB0ZXh0LmNoYXJBdChpKTtcblxuXG5cdFx0aWYgKFtcIilcIiwgXCJdXCIsIFwifVwiXS5jb250YWlucyhjdXJDaGFyKSkge1xuXHRcdFx0Y29uc3QgY2xvc2VCcmFja2V0ID0gY3VyQ2hhcjtcblx0XHRcdGNvbnN0IG9wZW5CcmFja2V0ID0gZ2V0T3BlbkJyYWNrZXQoY2xvc2VCcmFja2V0KTtcblxuXHRcdFx0Y29uc3QgaiA9IGZpbmRNYXRjaGluZ0JyYWNrZXQodGV4dCwgaSwgb3BlbkJyYWNrZXQsIGNsb3NlQnJhY2tldCwgdHJ1ZSk7XG5cblx0XHRcdGlmIChqID09PSAtMSkgcmV0dXJuIC0xO1xuXG5cdFx0XHQvLyBTa2lwIHRvIHRoZSBiZWdpbm5uaW5nIG9mIHRoZSBicmFja2V0XG5cdFx0XHRpID0gajtcblx0XHRcdGN1ckNoYXIgPSB0ZXh0LmNoYXJBdChpKTtcblx0XHR9XG5cdFx0ZWxzZSB7XG5cblx0XHRcdGlmICghW1wie1wiLCBcIihcIiwgXCJbXCJdLmNvbnRhaW5zKGN1ckNoYXIpKSBjb250aW51ZTtcblxuXHRcdFx0Y29uc3QgaiA9IGZpbmRNYXRjaGluZ0JyYWNrZXQodGV4dCwgaSwgY3VyQ2hhciwgZ2V0Q2xvc2VCcmFja2V0KGN1ckNoYXIpLCBmYWxzZSk7XG5cdFx0XHRpZiAoaiA9PT0gLTEpIGNvbnRpbnVlO1xuXG5cdFx0XHRyZXR1cm4ge2xlZnQ6IGkgKyBzdGFydCwgcmlnaHQ6IGogKyBzdGFydH07XG5cblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gLTE7XG59XG5cbmZ1bmN0aW9uIGhpZ2hsaWdodEN1cnNvckJyYWNrZXRzKHZpZXc6IEVkaXRvclZpZXcpIHtcblxuXHRjb25zdCB3aWRnZXRzOiBSYW5nZTxEZWNvcmF0aW9uPltdID0gW11cblx0Y29uc3Qgc2VsZWN0aW9uID0gdmlldy5zdGF0ZS5zZWxlY3Rpb247XG5cdGNvbnN0IHJhbmdlcyA9IHNlbGVjdGlvbi5yYW5nZXM7XG5cdGNvbnN0IHRleHQgPSB2aWV3LnN0YXRlLmRvYy50b1N0cmluZygpO1xuXHRjb25zdCBjdHggPSBDb250ZXh0LmZyb21WaWV3KHZpZXcpO1xuXG5cdGlmICghY3R4Lm1vZGUuaW5NYXRoKCkpIHtcblx0XHRyZXR1cm4gRGVjb3JhdGlvbi5ub25lO1xuXHR9XG5cblx0Y29uc3QgYm91bmRzID0gY3R4LmdldEJvdW5kcyhzZWxlY3Rpb24ubWFpbi50byk7XG5cdGlmICghYm91bmRzKSByZXR1cm4gRGVjb3JhdGlvbi5ub25lO1xuXHRjb25zdCBlcW4gPSB2aWV3LnN0YXRlLmRvYy5zbGljZVN0cmluZyhib3VuZHMuc3RhcnQsIGJvdW5kcy5lbmQpO1xuXG5cdGNvbnN0IG9wZW5CcmFja2V0cyA9IFtcIntcIiwgXCJbXCIsIFwiKFwiXTtcblx0Y29uc3QgYnJhY2tldHMgPSBbXCJ7XCIsIFwiW1wiLCBcIihcIiwgXCJ9XCIsIFwiXVwiLCBcIilcIl07XG5cblx0bGV0IGRvbmUgPSBmYWxzZTtcblxuXHRmb3IgKGNvbnN0IHJhbmdlIG9mIHJhbmdlcykge1xuXG5cdFx0Zm9yIChsZXQgaSA9IHJhbmdlLnRvOyBpID4gcmFuZ2UuZnJvbSAtIDI7IGktLSkge1xuXHRcdFx0Y29uc3QgY2hhciA9IHRleHQuY2hhckF0KGkpO1xuXHRcdFx0aWYgKCFicmFja2V0cy5jb250YWlucyhjaGFyKSkgY29udGludWU7XG5cblx0XHRcdGxldCBvcGVuQnJhY2tldCwgY2xvc2VCcmFja2V0O1xuXHRcdFx0bGV0IGJhY2t3YXJkcyA9IGZhbHNlO1xuXG5cdFx0XHRpZiAob3BlbkJyYWNrZXRzLmNvbnRhaW5zKGNoYXIpKSB7XG5cdFx0XHRcdG9wZW5CcmFja2V0ID0gY2hhcjtcblx0XHRcdFx0Y2xvc2VCcmFja2V0ID0gZ2V0Q2xvc2VCcmFja2V0KG9wZW5CcmFja2V0KTtcblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRjbG9zZUJyYWNrZXQgPSBjaGFyO1xuXHRcdFx0XHRvcGVuQnJhY2tldCA9IGdldE9wZW5CcmFja2V0KGNoYXIpO1xuXHRcdFx0XHRiYWNrd2FyZHMgPSB0cnVlO1xuXHRcdFx0fVxuXG5cdFx0XHRsZXQgaiA9IGZpbmRNYXRjaGluZ0JyYWNrZXQoZXFuLCBpIC0gYm91bmRzLnN0YXJ0LCBvcGVuQnJhY2tldCwgY2xvc2VCcmFja2V0LCBiYWNrd2FyZHMpO1xuXG5cdFx0XHRpZiAoaiA9PT0gLTEpIGNvbnRpbnVlO1xuXHRcdFx0aiA9IGogKyBib3VuZHMuc3RhcnQ7XG5cblxuXHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKGksIFwibGF0ZXgtc3VpdGUtaGlnaGxpZ2h0ZWQtYnJhY2tldFwiKSk7XG5cdFx0XHR3aWRnZXRzLnB1c2goZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsoaiwgXCJsYXRleC1zdWl0ZS1oaWdobGlnaHRlZC1icmFja2V0XCIpKTtcblx0XHRcdGRvbmUgPSB0cnVlO1xuXHRcdFx0YnJlYWs7XG5cdFx0fVxuXG5cdFx0aWYgKGRvbmUpIGJyZWFrO1xuXG5cdFx0Ly8gSGlnaGxpZ2h0IGJyYWNrZXRzIGVuY2xvc2luZyB0aGUgY3Vyc29yXG5cdFx0aWYgKHJhbmdlLmVtcHR5KSB7XG5cdFx0XHRjb25zdCBwb3MgPSByYW5nZS5mcm9tIC0gMTtcblxuXHRcdFx0Y29uc3QgcmVzdWx0ID0gZ2V0RW5jbG9zaW5nQnJhY2tldHNQb3ModmlldywgcG9zKTtcblx0XHRcdGlmIChyZXN1bHQgPT09IC0xKSBjb250aW51ZTtcblxuXHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKHJlc3VsdC5sZWZ0LCBcImxhdGV4LXN1aXRlLWhpZ2hsaWdodGVkLWJyYWNrZXRcIikpO1xuXHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKHJlc3VsdC5yaWdodCwgXCJsYXRleC1zdWl0ZS1oaWdobGlnaHRlZC1icmFja2V0XCIpKTtcblx0XHRcdGRvbmUgPSB0cnVlO1xuXHRcdFx0YnJlYWs7XG5cdFx0fVxuXG5cdFx0aWYgKGRvbmUpIGJyZWFrO1xuXHR9XG5cblx0cmV0dXJuIERlY29yYXRpb24uc2V0KHdpZGdldHMsIHRydWUpO1xufVxuXG5cbmV4cG9ydCBjb25zdCBjb2xvclBhaXJlZEJyYWNrZXRzUGx1Z2luID0gVmlld1BsdWdpbi5mcm9tQ2xhc3MoY2xhc3Mge1xuXHRkZWNvcmF0aW9uczogRGVjb3JhdGlvblNldDtcblxuXHRjb25zdHJ1Y3Rvcih2aWV3OiBFZGl0b3JWaWV3KSB7XG5cdFx0dGhpcy5kZWNvcmF0aW9ucyA9IGNvbG9yUGFpcmVkQnJhY2tldHModmlldyk7XG5cdH1cblxuXHR1cGRhdGUodXBkYXRlOiBWaWV3VXBkYXRlKSB7XG5cdFx0aWYgKHVwZGF0ZS5kb2NDaGFuZ2VkIHx8IHVwZGF0ZS52aWV3cG9ydENoYW5nZWQpIHtcblx0XHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBjb2xvclBhaXJlZEJyYWNrZXRzKHVwZGF0ZS52aWV3KTtcblx0XHR9XG5cdH1cblxufSwgeyBkZWNvcmF0aW9uczogdiA9PiB2LmRlY29yYXRpb25zLCB9KTtcblxuXG5leHBvcnQgY29uc3QgY29sb3JQYWlyZWRCcmFja2V0c1BsdWdpbkxvd2VzdFByZWMgPSBQcmVjLmxvd2VzdChjb2xvclBhaXJlZEJyYWNrZXRzUGx1Z2luLmV4dGVuc2lvbik7XG5cbmV4cG9ydCBjb25zdCBoaWdobGlnaHRDdXJzb3JCcmFja2V0c1BsdWdpbiA9IFZpZXdQbHVnaW4uZnJvbUNsYXNzKGNsYXNzIHtcblx0ZGVjb3JhdGlvbnM6IERlY29yYXRpb25TZXQ7XG5cblx0Y29uc3RydWN0b3IodmlldzogRWRpdG9yVmlldykge1xuXHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBoaWdobGlnaHRDdXJzb3JCcmFja2V0cyh2aWV3KTtcblx0fVxuXG5cdHVwZGF0ZSh1cGRhdGU6IFZpZXdVcGRhdGUpIHtcblx0XHRpZiAodXBkYXRlLmRvY0NoYW5nZWQgfHwgdXBkYXRlLnNlbGVjdGlvblNldClcblx0XHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBoaWdobGlnaHRDdXJzb3JCcmFja2V0cyh1cGRhdGUudmlldyk7XG5cdH1cblxufSwgeyBkZWNvcmF0aW9uczogdiA9PiB2LmRlY29yYXRpb25zLCB9KTtcbiJdfQ==