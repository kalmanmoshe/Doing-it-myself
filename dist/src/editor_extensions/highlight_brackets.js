import { Decoration, ViewPlugin } from "@codemirror/view";
import { Prec } from "@codemirror/state";
import { findMatchingBracket, getOpenBracket, getCloseBracket } from "../utils/editor_utils";
import { syntaxTree } from "@codemirror/language";
import { Context, getEquationBounds } from "src/utils/context";
const Ncolors = 3;
function getHighlightBracketMark(pos, className) {
    return Decoration.mark({
        inclusive: true,
        attributes: {},
        class: className
    }).range(pos, pos + 1);
}
function colorPairedBrackets(view) {
    const widgets = [];
    for (const { from, to } of view.visibleRanges) {
        syntaxTree(view.state).iterate({ from, to, enter: (node) => {
                const type = node.type;
                const to = node.to;
                if (!(type.name.contains("begin") && type.name.contains("math"))) {
                    return;
                }
                const bounds = getEquationBounds(view.state, to);
                if (!bounds)
                    return;
                const eqn = view.state.doc.sliceString(bounds.start, bounds.end);
                const openBrackets = ["{", "[", "("];
                const closeBrackets = ["}", "]", ")"];
                const bracketsStack = [];
                const bracketsPosStack = [];
                for (let i = 0; i < eqn.length; i++) {
                    const char = eqn.charAt(i);
                    if (openBrackets.contains(char)) {
                        bracketsStack.push(char);
                        bracketsPosStack.push(i);
                    }
                    else if (closeBrackets.contains(char)) {
                        const lastBracket = bracketsStack.at(-1);
                        if (getCloseBracket(lastBracket) === char) {
                            bracketsStack.pop();
                            const lastBracketPos = bracketsPosStack.pop();
                            const depth = bracketsStack.length % Ncolors;
                            const className = "latex-suite-color-bracket-" + depth;
                            const j = lastBracketPos + bounds.start;
                            const k = i + bounds.start;
                            widgets.push(getHighlightBracketMark(j, className));
                            widgets.push(getHighlightBracketMark(k, className));
                        }
                    }
                }
            }
        });
    }
    return Decoration.set(widgets, true);
}
function getEnclosingBracketsPos(view, pos) {
    const result = getEquationBounds(view.state);
    if (!result)
        return -1;
    const { start, end } = result;
    const text = view.state.doc.sliceString(start, end);
    for (let i = pos - start; i > 0; i--) {
        let curChar = text.charAt(i);
        if ([")", "]", "}"].contains(curChar)) {
            const closeBracket = curChar;
            const openBracket = getOpenBracket(closeBracket);
            const j = findMatchingBracket(text, i, openBracket, closeBracket, true);
            if (j === -1)
                return -1;
            // Skip to the beginnning of the bracket
            i = j;
            curChar = text.charAt(i);
        }
        else {
            if (!["{", "(", "["].contains(curChar))
                continue;
            const j = findMatchingBracket(text, i, curChar, getCloseBracket(curChar), false);
            if (j === -1)
                continue;
            return { left: i + start, right: j + start };
        }
    }
    return -1;
}
function highlightCursorBrackets(view) {
    const widgets = [];
    const selection = view.state.selection;
    const ranges = selection.ranges;
    const text = view.state.doc.toString();
    const ctx = Context.fromView(view);
    if (!ctx.mode.inMath()) {
        return Decoration.none;
    }
    const bounds = ctx.getBounds(selection.main.to);
    if (!bounds)
        return Decoration.none;
    const eqn = view.state.doc.sliceString(bounds.start, bounds.end);
    const openBrackets = ["{", "[", "("];
    const brackets = ["{", "[", "(", "}", "]", ")"];
    let done = false;
    for (const range of ranges) {
        for (let i = range.to; i > range.from - 2; i--) {
            const char = text.charAt(i);
            if (!brackets.contains(char))
                continue;
            let openBracket, closeBracket;
            let backwards = false;
            if (openBrackets.contains(char)) {
                openBracket = char;
                closeBracket = getCloseBracket(openBracket);
            }
            else {
                closeBracket = char;
                openBracket = getOpenBracket(char);
                backwards = true;
            }
            let j = findMatchingBracket(eqn, i - bounds.start, openBracket, closeBracket, backwards);
            if (j === -1)
                continue;
            j = j + bounds.start;
            widgets.push(getHighlightBracketMark(i, "latex-suite-highlighted-bracket"));
            widgets.push(getHighlightBracketMark(j, "latex-suite-highlighted-bracket"));
            done = true;
            break;
        }
        if (done)
            break;
        // Highlight brackets enclosing the cursor
        if (range.empty) {
            const pos = range.from - 1;
            const result = getEnclosingBracketsPos(view, pos);
            if (result === -1)
                continue;
            widgets.push(getHighlightBracketMark(result.left, "latex-suite-highlighted-bracket"));
            widgets.push(getHighlightBracketMark(result.right, "latex-suite-highlighted-bracket"));
            done = true;
            break;
        }
        if (done)
            break;
    }
    return Decoration.set(widgets, true);
}
export const colorPairedBracketsPlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = colorPairedBrackets(view);
    }
    update(update) {
        if (update.docChanged || update.viewportChanged) {
            this.decorations = colorPairedBrackets(update.view);
        }
    }
}, { decorations: v => v.decorations, });
export const colorPairedBracketsPluginLowestPrec = Prec.lowest(colorPairedBracketsPlugin.extension);
export const highlightCursorBracketsPlugin = ViewPlugin.fromClass(class {
    decorations;
    constructor(view) {
        this.decorations = highlightCursorBrackets(view);
    }
    update(update) {
        if (update.docChanged || update.selectionSet)
            this.decorations = highlightCursorBrackets(update.view);
    }
}, { decorations: v => v.decorations, });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGlnaGxpZ2h0X2JyYWNrZXRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2VkaXRvcl9leHRlbnNpb25zL2hpZ2hsaWdodF9icmFja2V0cy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQTBCLFVBQVUsRUFBaUIsVUFBVSxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFDakcsT0FBTyxFQUFFLElBQUksRUFBUyxNQUFNLG1CQUFtQixDQUFDO0FBQ2hELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxjQUFjLEVBQUUsZUFBZSxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDN0YsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQUUvRCxNQUFNLE9BQU8sR0FBRyxDQUFDLENBQUM7QUFFbEIsU0FBUyx1QkFBdUIsQ0FBQyxHQUFXLEVBQUUsU0FBaUI7SUFDOUQsT0FBTyxVQUFVLENBQUMsSUFBSSxDQUFDO1FBQ3RCLFNBQVMsRUFBRSxJQUFJO1FBQ2YsVUFBVSxFQUFFLEVBQUU7UUFDZCxLQUFLLEVBQUUsU0FBUztLQUNoQixDQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxHQUFHLEdBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdEIsQ0FBQztBQUVELFNBQVMsbUJBQW1CLENBQUMsSUFBZ0I7SUFDNUMsTUFBTSxPQUFPLEdBQXdCLEVBQUUsQ0FBQztJQUV4QyxLQUFLLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLElBQUksSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBRS9DLFVBQVUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsT0FBTyxDQUFDLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxJQUFJLEVBQUUsRUFBRTtnQkFDMUQsTUFBTSxJQUFJLEdB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Q0FBQztDQUVELEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztBQUd6QyxNQUFNLENBQUMsTUFBTSxtQ0FBbUMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRXBHLE1BQU0sQ0FBQyxNQUFNLDZCQUE2QixHQUFHLFVBQVUsQ0FBQyxTQUFTLENBQUM7SUFDakUsV0FBVyxDQUFnQjtJQUUzQixZQUFZLElBQWdCO1FBQzNCLElBQUksQ0FBQyxXQUFXLEdBQUcsdUJBQXVCLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDbEQsQ0FBQztJQUVELE1BQU0sQ0FBQyxNQUFrQjtRQUN4QixJQUFJLE1BQU0sQ0FBQyxVQUFVLElBQUksTUFBTSxDQUFDLFlBQVk7WUFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRyx1QkFBdUIsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDMUQsQ0FBQztDQUVELEVBQUUsRUFBRSxXQUFXLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVkaXRvclZpZXcsIFZpZXdVcGRhdGUsIERlY29yYXRpb24sIERlY29yYXRpb25TZXQsIFZpZXdQbHVnaW4gfSBmcm9tIFwiQGNvZGVtaXJyb3Ivdmlld1wiO1xuaW1wb3J0IHsgUHJlYywgUmFuZ2UgfSBmcm9tIFwiQGNvZGVtaXJyb3Ivc3RhdGVcIjtcbmltcG9ydCB7IGZpbmRNYXRjaGluZ0JyYWNrZXQsIGdldE9wZW5CcmFja2V0LCBnZXRDbG9zZUJyYWNrZXQgfSBmcm9tIFwiLi4vdXRpbHMvZWRpdG9yX3V0aWxzXCI7XG5pbXBvcnQgeyBzeW50YXhUcmVlIH0gZnJvbSBcIkBjb2RlbWlycm9yL2xhbmd1YWdlXCI7XG5pbXBvcnQgeyBDb250ZXh0LCBnZXRFcXVhdGlvbkJvdW5kcyB9IGZyb20gXCJzcmMvdXRpbHMvY29udGV4dFwiO1xuXG5jb25zdCBOY29sb3JzID0gMztcblxuZnVuY3Rpb24gZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsocG9zOiBudW1iZXIsIGNsYXNzTmFtZTogc3RyaW5nKTpSYW5nZTxEZWNvcmF0aW9uPiB7XG5cdHJldHVybiBEZWNvcmF0aW9uLm1hcmsoe1xuXHRcdGluY2x1c2l2ZTogdHJ1ZSxcblx0XHRhdHRyaWJ1dGVzOiB7fSxcblx0XHRjbGFzczogY2xhc3NOYW1lXG5cdH0pLnJhbmdlKHBvcywgcG9zKzEpO1xufVxuXG5mdW5jdGlvbiBjb2xvclBhaXJlZEJyYWNrZXRzKHZpZXc6IEVkaXRvclZpZXcpIHtcblx0Y29uc3Qgd2lkZ2V0czogUmFuZ2U8RGVjb3JhdGlvbj5bXSA9IFtdO1xuXG5cdGZvciAoY29uc3QgeyBmcm9tLCB0byB9IG9mIHZpZXcudmlzaWJsZVJhbmdlcykge1xuXG5cdFx0c3ludGF4VHJlZSh2aWV3LnN0YXRlKS5pdGVyYXRlKHsgZnJvbSwgdG8sIGVudGVyOiAobm9kZSkgPT4ge1xuXHRcdFx0Y29uc3QgdHlwZSA9IG5vZGUudHlwZTtcblx0XHRcdGNvbnN0IHRvID0gbm9kZS50bztcblxuXHRcdFx0aWYgKCEodHlwZS5uYW1lLmNvbnRhaW5zKFwiYmVnaW5cIikgJiYgdHlwZS5uYW1lLmNvbnRhaW5zKFwibWF0aFwiKSkpIHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRjb25zdCBib3VuZHMgPSBnZXRFcXVhdGlvbkJvdW5kcyh2aWV3LnN0YXRlLCB0byk7XG5cdFx0XHRpZiAoIWJvdW5kcykgcmV0dXJuO1xuXG5cblx0XHRcdGNvbnN0IGVxbiA9IHZpZXcuc3RhdGUuZG9jLnNsaWNlU3RyaW5nKGJvdW5kcy5zdGFydCwgYm91bmRzLmVuZCk7XG5cblxuXHRcdFx0Y29uc3Qgb3BlbkJyYWNrZXRzID0gW1wie1wiLCBcIltcIiwgXCIoXCJdO1xuXHRcdFx0Y29uc3QgY2xvc2VCcmFja2V0cyA9IFtcIn1cIiwgXCJdXCIsIFwiKVwiXTtcblxuXHRcdFx0Y29uc3QgYnJhY2tldHNTdGFjayA9IFtdO1xuXHRcdFx0Y29uc3QgYnJhY2tldHNQb3NTdGFjayA9IFtdO1xuXG5cdFx0XHRmb3IgKGxldCBpID0gMDsgaSA8IGVxbi5sZW5ndGg7IGkrKykge1xuXHRcdFx0XHRjb25zdCBjaGFyID0gZXFuLmNoYXJBdChpKTtcblxuXHRcdFx0XHRpZiAob3BlbkJyYWNrZXRzLmNvbnRhaW5zKGNoYXIpKSB7XG5cdFx0XHRcdFx0YnJhY2tldHNTdGFjay5wdXNoKGNoYXIpO1xuXHRcdFx0XHRcdGJyYWNrZXRzUG9zU3RhY2sucHVzaChpKTtcblx0XHRcdFx0fVxuXHRcdFx0XHRlbHNlIGlmIChjbG9zZUJyYWNrZXRzLmNvbnRhaW5zKGNoYXIpKSB7XG5cdFx0XHRcdFx0Y29uc3QgbGFzdEJyYWNrZXQgPSBicmFja2V0c1N0YWNrLmF0KC0xKTtcblxuXHRcdFx0XHRcdGlmIChnZXRDbG9zZUJyYWNrZXQobGFzdEJyYWNrZXQpID09PSBjaGFyKSB7XG5cdFx0XHRcdFx0XHRicmFja2V0c1N0YWNrLnBvcCgpO1xuXHRcdFx0XHRcdFx0Y29uc3QgbGFzdEJyYWNrZXRQb3MgPSBicmFja2V0c1Bvc1N0YWNrLnBvcCgpO1xuXHRcdFx0XHRcdFx0Y29uc3QgZGVwdGggPSBicmFja2V0c1N0YWNrLmxlbmd0aCAlIE5jb2xvcnM7XG5cblx0XHRcdFx0XHRcdGNvbnN0IGNsYXNzTmFtZSA9IFwibGF0ZXgtc3VpdGUtY29sb3ItYnJhY2tldC1cIiArIGRlcHRoO1xuXG5cdFx0XHRcdFx0XHRjb25zdCBqID0gbGFzdEJyYWNrZXRQb3MgKyBib3VuZHMuc3RhcnQ7XG5cdFx0XHRcdFx0XHRjb25zdCBrID0gaSArIGJvdW5kcy5zdGFydDtcblxuXHRcdFx0XHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKGosIGNsYXNzTmFtZSkpO1xuXHRcdFx0XHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKGssIGNsYXNzTmFtZSkpO1xuXHRcdFx0XHRcdH1cblx0XHRcdFx0fVxuXHRcdFx0fVxuXG5cdFx0fVxuXG5cdFx0fSk7XG5cdH1cblxuXHRyZXR1cm4gRGVjb3JhdGlvbi5zZXQod2lkZ2V0cywgdHJ1ZSlcbn1cblxuZnVuY3Rpb24gZ2V0RW5jbG9zaW5nQnJhY2tldHNQb3ModmlldzogRWRpdG9yVmlldywgcG9zOiBudW1iZXIpIHtcblxuXHRjb25zdCByZXN1bHQgPSBnZXRFcXVhdGlvbkJvdW5kcyh2aWV3LnN0YXRlKTtcblx0aWYgKCFyZXN1bHQpIHJldHVybiAtMTtcblx0Y29uc3Qge3N0YXJ0LCBlbmR9ID0gcmVzdWx0O1xuXHRjb25zdCB0ZXh0ID0gdmlldy5zdGF0ZS5kb2Muc2xpY2VTdHJpbmcoc3RhcnQsIGVuZCk7XG5cblxuXHRmb3IgKGxldCBpID0gcG9zLXN0YXJ0OyBpID4gMDsgaS0tKSB7XG5cdFx0bGV0IGN1ckNoYXIgPSB0ZXh0LmNoYXJBdChpKTtcblxuXG5cdFx0aWYgKFtcIilcIiwgXCJdXCIsIFwifVwiXS5jb250YWlucyhjdXJDaGFyKSkge1xuXHRcdFx0Y29uc3QgY2xvc2VCcmFja2V0ID0gY3VyQ2hhcjtcblx0XHRcdGNvbnN0IG9wZW5CcmFja2V0ID0gZ2V0T3BlbkJyYWNrZXQoY2xvc2VCcmFja2V0KTtcblxuXHRcdFx0Y29uc3QgaiA9IGZpbmRNYXRjaGluZ0JyYWNrZXQodGV4dCwgaSwgb3BlbkJyYWNrZXQsIGNsb3NlQnJhY2tldCwgdHJ1ZSk7XG5cblx0XHRcdGlmIChqID09PSAtMSkgcmV0dXJuIC0xO1xuXG5cdFx0XHQvLyBTa2lwIHRvIHRoZSBiZWdpbm5uaW5nIG9mIHRoZSBicmFja2V0XG5cdFx0XHRpID0gajtcblx0XHRcdGN1ckNoYXIgPSB0ZXh0LmNoYXJBdChpKTtcblx0XHR9XG5cdFx0ZWxzZSB7XG5cblx0XHRcdGlmICghW1wie1wiLCBcIihcIiwgXCJbXCJdLmNvbnRhaW5zKGN1ckNoYXIpKSBjb250aW51ZTtcblxuXHRcdFx0Y29uc3QgaiA9IGZpbmRNYXRjaGluZ0JyYWNrZXQodGV4dCwgaSwgY3VyQ2hhciwgZ2V0Q2xvc2VCcmFja2V0KGN1ckNoYXIpLCBmYWxzZSk7XG5cdFx0XHRpZiAoaiA9PT0gLTEpIGNvbnRpbnVlO1xuXG5cdFx0XHRyZXR1cm4ge2xlZnQ6IGkgKyBzdGFydCwgcmlnaHQ6IGogKyBzdGFydH07XG5cblx0XHR9XG5cdH1cblxuXHRyZXR1cm4gLTE7XG59XG5cbmZ1bmN0aW9uIGhpZ2hsaWdodEN1cnNvckJyYWNrZXRzKHZpZXc6IEVkaXRvclZpZXcpIHtcblxuXHRjb25zdCB3aWRnZXRzOiBSYW5nZTxEZWNvcmF0aW9uPltdID0gW11cblx0Y29uc3Qgc2VsZWN0aW9uID0gdmlldy5zdGF0ZS5zZWxlY3Rpb247XG5cdGNvbnN0IHJhbmdlcyA9IHNlbGVjdGlvbi5yYW5nZXM7XG5cdGNvbnN0IHRleHQgPSB2aWV3LnN0YXRlLmRvYy50b1N0cmluZygpO1xuXHRjb25zdCBjdHggPSBDb250ZXh0LmZyb21WaWV3KHZpZXcpO1xuXG5cdGlmICghY3R4Lm1vZGUuaW5NYXRoKCkpIHtcblx0XHRyZXR1cm4gRGVjb3JhdGlvbi5ub25lO1xuXHR9XG5cblx0Y29uc3QgYm91bmRzID0gY3R4LmdldEJvdW5kcyhzZWxlY3Rpb24ubWFpbi50byk7XG5cdGlmICghYm91bmRzKSByZXR1cm4gRGVjb3JhdGlvbi5ub25lO1xuXHRjb25zdCBlcW4gPSB2aWV3LnN0YXRlLmRvYy5zbGljZVN0cmluZyhib3VuZHMuc3RhcnQsIGJvdW5kcy5lbmQpO1xuXG5cdGNvbnN0IG9wZW5CcmFja2V0cyA9IFtcIntcIiwgXCJbXCIsIFwiKFwiXTtcblx0Y29uc3QgYnJhY2tldHMgPSBbXCJ7XCIsIFwiW1wiLCBcIihcIiwgXCJ9XCIsIFwiXVwiLCBcIilcIl07XG5cblx0bGV0IGRvbmUgPSBmYWxzZTtcblxuXHRmb3IgKGNvbnN0IHJhbmdlIG9mIHJhbmdlcykge1xuXG5cdFx0Zm9yIChsZXQgaSA9IHJhbmdlLnRvOyBpID4gcmFuZ2UuZnJvbSAtIDI7IGktLSkge1xuXHRcdFx0Y29uc3QgY2hhciA9IHRleHQuY2hhckF0KGkpO1xuXHRcdFx0aWYgKCFicmFja2V0cy5jb250YWlucyhjaGFyKSkgY29udGludWU7XG5cblx0XHRcdGxldCBvcGVuQnJhY2tldCwgY2xvc2VCcmFja2V0O1xuXHRcdFx0bGV0IGJhY2t3YXJkcyA9IGZhbHNlO1xuXG5cdFx0XHRpZiAob3BlbkJyYWNrZXRzLmNvbnRhaW5zKGNoYXIpKSB7XG5cdFx0XHRcdG9wZW5CcmFja2V0ID0gY2hhcjtcblx0XHRcdFx0Y2xvc2VCcmFja2V0ID0gZ2V0Q2xvc2VCcmFja2V0KG9wZW5CcmFja2V0KTtcblx0XHRcdH1cblx0XHRcdGVsc2Uge1xuXHRcdFx0XHRjbG9zZUJyYWNrZXQgPSBjaGFyO1xuXHRcdFx0XHRvcGVuQnJhY2tldCA9IGdldE9wZW5CcmFja2V0KGNoYXIpO1xuXHRcdFx0XHRiYWNrd2FyZHMgPSB0cnVlO1xuXHRcdFx0fVxuXG5cdFx0XHRsZXQgaiA9IGZpbmRNYXRjaGluZ0JyYWNrZXQoZXFuLCBpIC0gYm91bmRzLnN0YXJ0LCBvcGVuQnJhY2tldCwgY2xvc2VCcmFja2V0LCBiYWNrd2FyZHMpO1xuXG5cdFx0XHRpZiAoaiA9PT0gLTEpIGNvbnRpbnVlO1xuXHRcdFx0aiA9IGogKyBib3VuZHMuc3RhcnQ7XG5cblxuXHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKGksIFwibGF0ZXgtc3VpdGUtaGlnaGxpZ2h0ZWQtYnJhY2tldFwiKSk7XG5cdFx0XHR3aWRnZXRzLnB1c2goZ2V0SGlnaGxpZ2h0QnJhY2tldE1hcmsoaiwgXCJsYXRleC1zdWl0ZS1oaWdobGlnaHRlZC1icmFja2V0XCIpKTtcblx0XHRcdGRvbmUgPSB0cnVlO1xuXHRcdFx0YnJlYWs7XG5cdFx0fVxuXG5cdFx0aWYgKGRvbmUpIGJyZWFrO1xuXG5cdFx0Ly8gSGlnaGxpZ2h0IGJyYWNrZXRzIGVuY2xvc2luZyB0aGUgY3Vyc29yXG5cdFx0aWYgKHJhbmdlLmVtcHR5KSB7XG5cdFx0XHRjb25zdCBwb3MgPSByYW5nZS5mcm9tIC0gMTtcblxuXHRcdFx0Y29uc3QgcmVzdWx0ID0gZ2V0RW5jbG9zaW5nQnJhY2tldHNQb3ModmlldywgcG9zKTtcblx0XHRcdGlmIChyZXN1bHQgPT09IC0xKSBjb250aW51ZTtcblxuXHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKHJlc3VsdC5sZWZ0LCBcImxhdGV4LXN1aXRlLWhpZ2hsaWdodGVkLWJyYWNrZXRcIikpO1xuXHRcdFx0d2lkZ2V0cy5wdXNoKGdldEhpZ2hsaWdodEJyYWNrZXRNYXJrKHJlc3VsdC5yaWdodCwgXCJsYXRleC1zdWl0ZS1oaWdobGlnaHRlZC1icmFja2V0XCIpKTtcblx0XHRcdGRvbmUgPSB0cnVlO1xuXHRcdFx0YnJlYWs7XG5cdFx0fVxuXG5cdFx0aWYgKGRvbmUpIGJyZWFrO1xuXHR9XG5cblx0cmV0dXJuIERlY29yYXRpb24uc2V0KHdpZGdldHMsIHRydWUpO1xufVxuXG5cbmV4cG9ydCBjb25zdCBjb2xvclBhaXJlZEJyYWNrZXRzUGx1Z2luID0gVmlld1BsdWdpbi5mcm9tQ2xhc3MoY2xhc3Mge1xuXHRkZWNvcmF0aW9uczogRGVjb3JhdGlvblNldDtcblxuXHRjb25zdHJ1Y3Rvcih2aWV3OiBFZGl0b3JWaWV3KSB7XG5cdFx0dGhpcy5kZWNvcmF0aW9ucyA9IGNvbG9yUGFpcmVkQnJhY2tldHModmlldyk7XG5cdH1cblxuXHR1cGRhdGUodXBkYXRlOiBWaWV3VXBkYXRlKSB7XG5cdFx0aWYgKHVwZGF0ZS5kb2NDaGFuZ2VkIHx8IHVwZGF0ZS52aWV3cG9ydENoYW5nZWQpIHtcblx0XHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBjb2xvclBhaXJlZEJyYWNrZXRzKHVwZGF0ZS52aWV3KTtcblx0XHR9XG5cdH1cblxufSwgeyBkZWNvcmF0aW9uczogdiA9PiB2LmRlY29yYXRpb25zLCB9KTtcblxuXG5leHBvcnQgY29uc3QgY29sb3JQYWlyZWRCcmFja2V0c1BsdWdpbkxvd2VzdFByZWMgPSBQcmVjLmxvd2VzdChjb2xvclBhaXJlZEJyYWNrZXRzUGx1Z2luLmV4dGVuc2lvbik7XG5cbmV4cG9ydCBjb25zdCBoaWdobGlnaHRDdXJzb3JCcmFja2V0c1BsdWdpbiA9IFZpZXdQbHVnaW4uZnJvbUNsYXNzKGNsYXNzIHtcblx0ZGVjb3JhdGlvbnM6IERlY29yYXRpb25TZXQ7XG5cblx0Y29uc3RydWN0b3IodmlldzogRWRpdG9yVmlldykge1xuXHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBoaWdobGlnaHRDdXJzb3JCcmFja2V0cyh2aWV3KTtcblx0fVxuXG5cdHVwZGF0ZSh1cGRhdGU6IFZpZXdVcGRhdGUpIHtcblx0XHRpZiAodXBkYXRlLmRvY0NoYW5nZWQgfHwgdXBkYXRlLnNlbGVjdGlvblNldClcblx0XHRcdHRoaXMuZGVjb3JhdGlvbnMgPSBoaWdobGlnaHRDdXJzb3JCcmFja2V0cyh1cGRhdGUudmlldyk7XG5cdH1cblxufSwgeyBkZWNvcmF0aW9uczogdiA9PiB2LmRlY29yYXRpb25zLCB9KTtcbiJdfQ==