import { ViewPlugin, } from "@codemirror/view";
import { Context } from "./utils/context";
import { isComposing, replaceRange, setCursor } from "./editor utilities/editor_utils";
import { keyboardAutoReplaceHebrewToEnglishTriggers } from "./utils/staticData";
import { Suggestor } from "./suggestor";
import { RtlForc } from "./editorDecorations";
import { setSelectionToNextTabstop } from "./snippets/snippet_management";
import { tabstopsStateField } from "./codemirror/tabstops_state_field";
import { snippetQueueStateField } from "./codemirror/snippet_queue_state_field";
import { snippetInvertedEffects } from "./codemirror/history";
import { runSnippets } from "./features/run_snippets";
export class EditorExtensions {
    shouldListenForTransaction = false;
    activeEditorView = null;
    suggestionActive = false;
    suggestor = new Suggestor();
    isSuggesterDeployed() {
        return !!document.body.querySelector(".suggestion-dropdown");
    }
    setEditorExtensions(app) {
        while (app.editorExtensions.length)
            app.editorExtensions.pop(); // Clear existing extensions
        this.monitor(app);
        this.snippetExtensions(app);
        const flatExtensions = app.editorExtensions.flat();
        app.registerEditorExtension(flatExtensions);
    }
    monitor(app) {
    }
    snippetExtensions(app) {
        app.editorExtensions.push([
            tabstopsStateField.extension,
            snippetQueueStateField.extension,
            snippetInvertedEffects,
        ]);
    }
    registerDecorations(app) {
        app.registerEditorExtension(ViewPlugin.fromClass(RtlForc, {
            decorations: (v) => v.decorations,
        }));
    }
    onClick = (event, view) => {
        const suggestionItems = document.body.querySelectorAll(".suggestion-item");
        // Check if the click is on a suggestion item
        const clickedSuggestion = Array.from(suggestionItems).find((item) => item.contains(event.target));
        if (clickedSuggestion) {
            this.suggestor.selectDropdownItem(clickedSuggestion, view);
        }
    };
    onTransaction = (view) => {
        const ctx = Context.fromView(view);
        if (ctx.codeblockLanguage === "tikz") {
            this.suggestor.deploySuggestor(ctx, view);
        }
    };
    onKeydown = (event, view) => {
        let key = event.key;
        const ctx = Context.fromView(view);
        if (!(event.ctrlKey || event.metaKey) && (ctx.mode.inMath() && (!ctx.inTextEnvironment() || ctx.codeblockLanguage.match(/(tikz)/)))) {
            const trigger = keyboardAutoReplaceHebrewToEnglishTriggers.find((trigger2) => trigger2.key === event.key && trigger2.code === event.code);
            if (trigger) {
                event.preventDefault();
                key = trigger.replacement;
                replaceRange(view, view.state.selection.main.from, view.state.selection.main.to, key);
                setCursor(view, view.state.selection.main.from + key.length);
            }
        }
        if (this.suggestor.isSuggesterDeployed) {
            handleDropdownNavigation(event, view, this.suggestor);
        }
        const success = handleKeydown(key, event.shiftKey, event.ctrlKey || event.metaKey, isComposing(view, event), view, ctx);
        if (success)
            event.preventDefault();
    };
    decorat() {
    }
}
const handleDropdownNavigation = (event, view, suggestor) => {
    const items = suggestor.getAlldropdownItems();
    if (event.key === "ArrowDown") {
        suggestor.selectionIndex = (suggestor.selectionIndex + 1) % items.length;
        suggestor.updateSelection(items);
        event.preventDefault();
    }
    else if (event.key === "ArrowUp") {
        suggestor.selectionIndex = (suggestor.selectionIndex - 1 + items.length) % items.length;
        suggestor.updateSelection(items);
        event.preventDefault();
    }
    else if (event.key === "Enter") {
        const selectedItem = items[suggestor.selectionIndex];
        suggestor.selectDropdownItem(selectedItem, view);
        event.preventDefault();
    } /*else if (event.key === "Escape") {
        dropdown.remove();
        event.preventDefault();
    }*/
};
const handleKeydown = (key, shiftKey, ctrlKey, isIME, view, ctx) => {
    const settings = { autoDelete$: false,
        snippetsEnabled: false,
        suppressSnippetTriggerOnIME: false,
        autofractionEnabled: false,
        matrixShortcutsEnabled: false,
        taboutEnabled: false,
    };
    //getLatexSuiteConfig(view);
    let success = false;
    if (settings.autoDelete$ && key === "Backspace" && ctx.mode.inMath()) { /*
      const charAtPos = getCharacterAtPos(view, ctx.pos);
      const charAtPrevPos = getCharacterAtPos(view, ctx.pos - 1);
      if (charAtPos === "$" && charAtPrevPos === "$") {
        //replaceRange(view, ctx.pos - 1, ctx.pos + 1, "");
        //removeAllTabstops(view);
        return true;
      }*/
    }
    if (settings.snippetsEnabled) {
        if (settings.suppressSnippetTriggerOnIME && isIME)
            return;
        if (!ctrlKey) {
            try {
                success = runSnippets(view, ctx, key);
                if (success)
                    return true;
            }
            catch (e) {
                //clearSnippetQueue(view);
                console.error(e);
            }
        }
    }
    if (key === "Tab") {
        //Finally found it.
        success = setSelectionToNextTabstop(view);
        if (success)
            return true;
    }
    if (settings.autofractionEnabled && ctx.mode.strictlyInMath()) {
        if (key === "/") {
            //success = runAutoFraction(view, ctx);
            if (success)
                return true;
        }
    }
    if (settings.matrixShortcutsEnabled && ctx.mode.blockMath) {
        if (["Tab", "Enter"].contains(key)) {
            //success = runMatrixShortcuts(view, ctx, key, shiftKey);
            if (success)
                return true;
        }
    }
    if (settings.taboutEnabled) {
        if (key === "Tab" /* || shouldTaboutByCloseBracket(view, key)*/) {
            //success = tabout(view, ctx);
            if (success)
                return true;
        }
    }
    return false;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZWRpdG9yRXh0ZW5zaW9ucy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9lZGl0b3JFeHRlbnNpb25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBYyxVQUFVLEdBQTJCLE1BQU0sa0JBQWtCLENBQUM7QUFFbkYsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQzFDLE9BQU8sRUFBRSxXQUFXLEVBQUUsWUFBWSxFQUFFLFNBQVMsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ3ZGLE9BQU8sRUFBRSwwQ0FBMEMsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2hGLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDeEMsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQzlDLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLCtCQUErQixDQUFDO0FBQzFFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ2hGLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzlELE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx5QkFBeUIsQ0FBQztBQUd0RCxNQUFNLE9BQU8sZ0JBQWdCO0lBQ2pCLDBCQUEwQixHQUFZLEtBQUssQ0FBQztJQUM1QyxnQkFBZ0IsR0FBc0IsSUFBSSxDQUFDO0lBQzNDLGdCQUFnQixHQUFZLEtBQUssQ0FBQztJQUNsQyxTQUFTLEdBQWMsSUFBSSxTQUFTLEVBQUUsQ0FBQztJQUV2QyxtQkFBbUI7UUFDdkIsT0FBTyxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsc0JBQXNCLENBQUMsQ0FBQztJQUNqRSxDQUFDO0lBRUQsbUJBQW1CLENBQUMsR0FBVTtRQUNoQyxPQUFPLEdBQUcs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QkFDVCxPQUFPLElBQUksQ0FBQztRQUNiLENBQUM7SUFDSCxDQUFDO0lBQ0QsSUFBSSxRQUFRLENBQUMsYUFBYSxFQUFFLENBQUM7UUFDM0IsSUFBSSxHQUFHLEtBQUssS0FBSyxDQUFBLDZDQUE2QyxFQUFFLENBQUM7WUFDbEUsOEJBQThCO1lBQzlCLElBQUksT0FBTztnQkFDVCxPQUFPLElBQUksQ0FBQztRQUNiLENBQUM7SUFDSCxDQUFDO0lBQ0QsT0FBTyxLQUFLLENBQUM7QUFDZCxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgTW9zaGUgZnJvbSBcIi4vbWFpblwiO1xyXG5pbXBvcnQgeyBnZXRUaWt6U3VnZ2VzdGlvbnMsIExhdGV4IH0gZnJvbSBcIi4vdXRpbGl0aWVzXCI7XHJcbmltcG9ydCB7IEVkaXRvclZpZXcsIFZpZXdQbHVnaW4sIFZpZXdVcGRhdGUgLERlY29yYXRpb24sIH0gZnJvbSBcIkBjb2RlbWlycm9yL3ZpZXdcIjtcclxuaW1wb3J0IHsgRWRpdG9yU3RhdGUsIFByZWMsRXh0ZW5zaW9uIH0gZnJvbSBcIkBjb2RlbWlycm9yL3N0YXRlXCI7XHJcbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi91dGlscy9jb250ZXh0XCI7XHJcbmltcG9ydCB7IGlzQ29tcG9zaW5nLCByZXBsYWNlUmFuZ2UsIHNldEN1cnNvciB9IGZyb20gXCIuL2VkaXRvciB1dGlsaXRpZXMvZWRpdG9yX3V0aWxzXCI7XHJcbmltcG9ydCB7IGtleWJvYXJkQXV0b1JlcGxhY2VIZWJyZXdUb0VuZ2xpc2hUcmlnZ2VycyB9IGZyb20gXCIuL3V0aWxzL3N0YXRpY0RhdGFcIjtcclxuaW1wb3J0IHsgU3VnZ2VzdG9yIH0gZnJvbSBcIi4vc3VnZ2VzdG9yXCI7XHJcbmltcG9ydCB7IFJ0bEZvcmMgfSBmcm9tIFwiLi9lZGl0b3JEZWNvcmF0aW9uc1wiO1xyXG5pbXBvcnQgeyBzZXRTZWxlY3Rpb25Ub05leHRUYWJzdG9wIH0gZnJvbSBcIi4vc25pcHBldHMvc25pcHBldF9tYW5hZ2VtZW50XCI7XHJcbmltcG9ydCB7IHRhYnN0b3BzU3RhdGVGaWVsZCB9IGZyb20gXCIuL2NvZGVtaXJyb3IvdGFic3RvcHNfc3RhdGVfZmllbGRcIjtcclxuaW1wb3J0IHsgc25pcHBldFF1ZXVlU3RhdGVGaWVsZCB9IGZyb20gXCIuL2NvZGVtaXJyb3Ivc25pcHBldF9xdWV1ZV9zdGF0ZV9maWVsZFwiO1xyXG5pbXBvcnQgeyBzbmlwcGV0SW52ZXJ0ZWRFZmZlY3RzIH0gZnJvbSBcIi4vY29kZW1pcnJvci9oaXN0b3J5XCI7XHJcbmltcG9ydCB7IHJ1blNuaXBwZXRzIH0gZnJvbSBcIi4vZmVhdHVyZXMvcnVuX3NuaXBwZXRzXCI7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIEVkaXRvckV4dGVuc2lvbnMge1xyXG4gICAgcHJpdmF0ZSBzaG91bGRMaXN0ZW5Gb3JUcmFuc2FjdGlvbjogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgcHJpdmF0ZSBhY3RpdmVFZGl0b3JWaWV3OiBFZGl0b3JWaWV3IHwgbnVsbCA9IG51bGw7XHJcbiAgICBwcml2YXRlIHN1Z2dlc3Rpb25BY3RpdmU6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByaXZhdGUgc3VnZ2VzdG9yOiBTdWdnZXN0b3IgPSBuZXcgU3VnZ2VzdG9yKCk7XHJcblxyXG4gICAgcHJpdmF0ZSBpc1N1Z2dlc3RlckRlcGxveWVkKCk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhIWRvY3VtZW50LmJvZHkucXVlcnlTZWxlY3RvcihcIi5zdWdnZXN0aW9uLWRyb3Bkb3duXCIpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldEVkaXRvckV4dGVuc2lvbnMoYXBwOiBNb3NoZSkge1xyXG5cdFx0d2hpbGUgKGFwcC5lZGl0b3JFeHRlbnNpb25zLmxlbmd0aCkgYXBwLmVkaXRvckV4dGVuc2lvbnMucG9wKCk7IC8vIENsZWFyIGV4aXN0aW5nIGV4dGVuc2lvbnNcclxuXHRcdHRoaXMubW9uaXRvcihhcHApOyBcclxuXHRcdHRoaXMuc25pcHBldEV4dGVuc2lvbnMoYXBwKTtcclxuXHRcclxuXHRcdGNvbnN0IGZsYXRFeHRlbnNpb25zID0gYXBwLmVkaXRvckV4dGVuc2lvbnMuZmxhdCgpO1xyXG5cdFxyXG5cdFx0YXBwLnJlZ2lzdGVyRWRpdG9yRXh0ZW5zaW9uKGZsYXRFeHRlbnNpb25zKTtcclxuXHR9XHJcblx0XHJcblxyXG4gICAgcHJpdmF0ZSBtb25pdG9yKGFwcDogTW9zaGUpIHsvKlxyXG4gICAgICAgIGFwcC5yZWdpc3RlckVkaXRvckV4dGVuc2lvbihbXHJcbiAgICAgICAgICAgIFByZWMuaGlnaGVzdChcclxuICAgICAgICAgICAgICAgIEVkaXRvclZpZXcuZG9tRXZlbnRIYW5kbGVycyh7XHJcbiAgICAgICAgICAgICAgICAgICAga2V5ZG93bjogKGV2ZW50LCB2aWV3KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25LZXlkb3duKGV2ZW50LCB2aWV3KTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC8vIFN0YXJ0IGxpc3RlbmluZyBmb3IgdHJhbnNhY3Rpb25zIG9ubHkgaWYgYSBrZXkgaXMgcHJlc3NlZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQuY29kZS5zdGFydHNXaXRoKFwiS2V5XCIpICYmICFldmVudC5jdHJsS2V5KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNob3VsZExpc3RlbkZvclRyYW5zYWN0aW9uID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgZm9jdXM6IChldmVudCwgdmlldykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBUcmFjayB0aGUgYWN0aXZlIGVkaXRvciB2aWV3XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlRWRpdG9yVmlldyA9IHZpZXc7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgIEVkaXRvclZpZXcudXBkYXRlTGlzdGVuZXIub2YoKHVwZGF0ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgLy8gVHJpZ2dlciB0cmFuc2FjdGlvbiBsb2dpYyBpZiBkb2NDaGFuZ2VkIGFuZCBsaXN0ZW5pbmcgaXMgYWN0aXZlXHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5zaG91bGRMaXN0ZW5Gb3JUcmFuc2FjdGlvbiAmJiB1cGRhdGUuZG9jQ2hhbmdlZCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub25UcmFuc2FjdGlvbih1cGRhdGUudmlldyk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zaG91bGRMaXN0ZW5Gb3JUcmFuc2FjdGlvbiA9IGZhbHNlOyAvLyBSZXNldCBsaXN0ZW5lclxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICBdKTtcclxuXHJcbiAgICAgICAgLy8gR2xvYmFsIGNsaWNrIGxpc3RlbmVyIHRvIGhhbmRsZSBzdWdnZXN0aW9uc1xyXG4gICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoXCJjbGlja1wiLCAoZXZlbnQpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5zdWdnZXN0aW9uQWN0aXZlID0gdGhpcy5pc1N1Z2dlc3RlckRlcGxveWVkKCk7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLnN1Z2dlc3Rpb25BY3RpdmUgJiYgdGhpcy5hY3RpdmVFZGl0b3JWaWV3KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLm9uQ2xpY2soZXZlbnQsIHRoaXMuYWN0aXZlRWRpdG9yVmlldyk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9KTsqL1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgc25pcHBldEV4dGVuc2lvbnMoYXBwOiBNb3NoZSkge1xyXG5cdFx0YXBwLmVkaXRvckV4dGVuc2lvbnMucHVzaChbXHJcblx0XHRcdHRhYnN0b3BzU3RhdGVGaWVsZC5leHRlbnNpb24sXHJcblx0XHRcdHNuaXBwZXRRdWV1ZVN0YXRlRmllbGQuZXh0ZW5zaW9uLFxyXG5cdFx0XHRzbmlwcGV0SW52ZXJ0ZWRFZmZlY3RzLFxyXG5cdFx0XSk7XHJcblx0fVxyXG5cdFxyXG5cclxuICAgIHByaXZhdGUgcmVnaXN0ZXJEZWNvcmF0aW9ucyhhcHA6IE1vc2hlKXtcclxuICAgICAgICBhcHAucmVnaXN0ZXJFZGl0b3JFeHRlbnNpb24oXHJcbiAgICAgICAgICAgIFZpZXdQbHVnaW4uZnJvbUNsYXNzKFJ0bEZvcmMsIHtcclxuICAgICAgICAgICAgZGVjb3JhdGlvbnM6ICh2KSA9PiB2LmRlY29yYXRpb25zLFxyXG4gICAgICAgICAgfVxyXG4gICAgICAgICkpO1xyXG4gICAgfVxyXG5cclxuXHRwcml2YXRlIG9uQ2xpY2s9KGV2ZW50OiBNb3VzZUV2ZW50LHZpZXc6IEVkaXRvclZpZXcpPT57XHJcblx0XHRjb25zdCBzdWdnZXN0aW9uSXRlbXMgPSBkb2N1bWVudC5ib2R5LnF1ZXJ5U2VsZWN0b3JBbGwoXCIuc3VnZ2VzdGlvbi1pdGVtXCIpO1xyXG5cdFxyXG5cdFx0Ly8gQ2hlY2sgaWYgdGhlIGNsaWNrIGlzIG9uIGEgc3VnZ2VzdGlvbiBpdGVtXHJcblx0XHRjb25zdCBjbGlja2VkU3VnZ2VzdGlvbiA9IEFycmF5LmZyb20oc3VnZ2VzdGlvbkl0ZW1zKS5maW5kKChpdGVtKSA9PlxyXG5cdFx0XHRpdGVtLmNvbnRhaW5zKGV2ZW50LnRhcmdldCBhcyBOb2RlKVxyXG5cdFx0KTtcclxuXHRcclxuXHRcdGlmIChjbGlja2VkU3VnZ2VzdGlvbikge1xyXG5cdFx0XHR0aGlzLnN1Z2dlc3Rvci5zZWxlY3REcm9wZG93bkl0ZW0oY2xpY2tlZFN1Z2dlc3Rpb24sdmlldyk7XHJcblx0XHR9XHJcblx0XHRcclxuXHR9XHJcblx0cHJpdmF0ZSBvblRyYW5zYWN0aW9uPSh2aWV3OiBFZGl0b3JWaWV3KT0+IHtcclxuXHRcdGNvbnN0IGN0eCA9IENvbnRleHQuZnJvbVZpZXcodmlldyk7XHJcblx0XHRpZiAoY3R4LmNvZGVibG9ja0xhbmd1YWdlID09PSBcInRpa3pcIikge1xyXG5cdFx0XHR0aGlzLnN1Z2dlc3Rvci5kZXBsb3lTdWdnZXN0b3IoY3R4LHZpZXcpXHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRwcml2YXRlIG9uS2V5ZG93biA9IChldmVudDogS2V5Ym9hcmRFdmVudCwgdmlldzogRWRpdG9yVmlldykgPT4ge1xyXG5cdFx0bGV0IGtleSA9IGV2ZW50LmtleTtcclxuXHRcdGNvbnN0IGN0eCA9IENvbnRleHQuZnJvbVZpZXcodmlldyk7XHJcblx0XHRpZiAoIShldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpICYmIChjdHgubW9kZS5pbk1hdGgoKSAmJiAoIWN0eC5pblRleHRFbnZpcm9ubWVudCgpIHx8IGN0eC5jb2RlYmxvY2tMYW5ndWFnZS5tYXRjaCgvKHRpa3opLykpKSkge1xyXG5cdFx0ICBjb25zdCB0cmlnZ2VyID0ga2V5Ym9hcmRBdXRvUmVwbGFjZUhlYnJld1RvRW5nbGlzaFRyaWdnZXJzLmZpbmQoKHRyaWdnZXIyKSA9PiB0cmlnZ2VyMi5rZXkgPT09IGV2ZW50LmtleSAmJiB0cmlnZ2VyMi5jb2RlID09PSBldmVudC5jb2RlKTtcclxuXHRcdCAgaWYgKHRyaWdnZXIpIHtcclxuXHRcdFx0XHRldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG5cdFx0XHRcdGtleSA9IHRyaWdnZXIucmVwbGFjZW1lbnQ7XHJcblx0XHRcdFx0cmVwbGFjZVJhbmdlKHZpZXcsdmlldy5zdGF0ZS5zZWxlY3Rpb24ubWFpbi5mcm9tLHZpZXcuc3RhdGUuc2VsZWN0aW9uLm1haW4udG8sa2V5KVxyXG5cdFx0XHRcdHNldEN1cnNvcih2aWV3LHZpZXcuc3RhdGUuc2VsZWN0aW9uLm1haW4uZnJvbStrZXkubGVuZ3RoKVxyXG5cdFx0ICB9XHJcblx0XHR9XHJcblx0XHRpZih0aGlzLnN1Z2dlc3Rvci5pc1N1Z2dlc3RlckRlcGxveWVkKXtcclxuXHRcdFx0aGFuZGxlRHJvcGRvd25OYXZpZ2F0aW9uKGV2ZW50LHZpZXcsdGhpcy5zdWdnZXN0b3IpXHJcblx0XHR9XHJcblx0XHRjb25zdCBzdWNjZXNzID0gaGFuZGxlS2V5ZG93bihrZXksIGV2ZW50LnNoaWZ0S2V5LCBldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXksIGlzQ29tcG9zaW5nKHZpZXcsIGV2ZW50KSwgdmlldywgY3R4KTtcclxuXHRcdGlmIChzdWNjZXNzKSBcclxuXHRcdCAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuXHR9O1xyXG5cclxuXHRwcml2YXRlIGRlY29yYXQoKXtcclxuXHJcblx0fVxyXG59XHJcblxyXG5cclxuY29uc3QgaGFuZGxlRHJvcGRvd25OYXZpZ2F0aW9uPShldmVudDogS2V5Ym9hcmRFdmVudCx2aWV3OkVkaXRvclZpZXcsc3VnZ2VzdG9yOiBTdWdnZXN0b3IpPT57XHJcblx0Y29uc3QgaXRlbXMgPSBzdWdnZXN0b3IuZ2V0QWxsZHJvcGRvd25JdGVtcygpO1xyXG5cclxuXHRpZiAoZXZlbnQua2V5ID09PSBcIkFycm93RG93blwiKSB7XHJcblx0XHRzdWdnZXN0b3Iuc2VsZWN0aW9uSW5kZXggPSAoc3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4ICsgMSkgJSBpdGVtcy5sZW5ndGg7XHJcblx0XHRzdWdnZXN0b3IudXBkYXRlU2VsZWN0aW9uKGl0ZW1zKTtcclxuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0fSBlbHNlIGlmIChldmVudC5rZXkgPT09IFwiQXJyb3dVcFwiKSB7XHJcblx0XHRzdWdnZXN0b3Iuc2VsZWN0aW9uSW5kZXggPSAoc3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4IC0gMSArIGl0ZW1zLmxlbmd0aCkgJSBpdGVtcy5sZW5ndGg7XHJcblx0XHRzdWdnZXN0b3IudXBkYXRlU2VsZWN0aW9uKGl0ZW1zKTtcclxuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0fSBlbHNlIGlmIChldmVudC5rZXkgPT09IFwiRW50ZXJcIikge1xyXG5cdFx0Y29uc3Qgc2VsZWN0ZWRJdGVtID0gaXRlbXNbc3VnZ2VzdG9yLnNlbGVjdGlvbkluZGV4XTtcclxuXHRcdHN1Z2dlc3Rvci5zZWxlY3REcm9wZG93bkl0ZW0oc2VsZWN0ZWRJdGVtLHZpZXcpO1xyXG5cdFx0ZXZlbnQucHJldmVudERlZmF1bHQoKTtcclxuXHR9IC8qZWxzZSBpZiAoZXZlbnQua2V5ID09PSBcIkVzY2FwZVwiKSB7XHJcblx0XHRkcm9wZG93bi5yZW1vdmUoKTtcclxuXHRcdGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XHJcblx0fSovXHJcbn1cclxuXHJcblxyXG5jb25zdCBoYW5kbGVLZXlkb3duID0gKGtleTogc3RyaW5nLCBzaGlmdEtleTogYm9vbGVhbiwgY3RybEtleTogYm9vbGVhbiwgaXNJTUU6IGFueSwgdmlldzogRWRpdG9yVmlldywgY3R4OiBDb250ZXh0KSA9PiB7XHJcblx0Y29uc3Qgc2V0dGluZ3MgPSB7YXV0b0RlbGV0ZSQ6IGZhbHNlLFxyXG5cdFx0c25pcHBldHNFbmFibGVkOmZhbHNlLFxyXG5cdFx0c3VwcHJlc3NTbmlwcGV0VHJpZ2dlck9uSU1FOiBmYWxzZSxcclxuXHRcdGF1dG9mcmFjdGlvbkVuYWJsZWQ6IGZhbHNlLFxyXG5cdFx0bWF0cml4U2hvcnRjdXRzRW5hYmxlZDogZmFsc2UsXHJcblx0XHR0YWJvdXRFbmFibGVkOiBmYWxzZSxcclxuXHR9XHJcblx0XHQvL2dldExhdGV4U3VpdGVDb25maWcodmlldyk7XHJcblx0bGV0IHN1Y2Nlc3MgPSBmYWxzZTtcclxuXHRpZiAoc2V0dGluZ3MuYXV0b0RlbGV0ZSQgJiYga2V5ID09PSBcIkJhY2tzcGFjZVwiICYmIGN0eC5tb2RlLmluTWF0aCgpKSB7LypcclxuXHQgIGNvbnN0IGNoYXJBdFBvcyA9IGdldENoYXJhY3RlckF0UG9zKHZpZXcsIGN0eC5wb3MpO1xyXG5cdCAgY29uc3QgY2hhckF0UHJldlBvcyA9IGdldENoYXJhY3RlckF0UG9zKHZpZXcsIGN0eC5wb3MgLSAxKTtcclxuXHQgIGlmIChjaGFyQXRQb3MgPT09IFwiJFwiICYmIGNoYXJBdFByZXZQb3MgPT09IFwiJFwiKSB7XHJcblx0XHQvL3JlcGxhY2VSYW5nZSh2aWV3LCBjdHgucG9zIC0gMSwgY3R4LnBvcyArIDEsIFwiXCIpO1xyXG5cdFx0Ly9yZW1vdmVBbGxUYWJzdG9wcyh2aWV3KTtcclxuXHRcdHJldHVybiB0cnVlO1xyXG5cdCAgfSovXHJcblx0fVxyXG5cdGlmIChzZXR0aW5ncy5zbmlwcGV0c0VuYWJsZWQpIHtcclxuXHQgIGlmIChzZXR0aW5ncy5zdXBwcmVzc1NuaXBwZXRUcmlnZ2VyT25JTUUgJiYgaXNJTUUpXHJcblx0XHRyZXR1cm47XHJcblx0ICBpZiAoIWN0cmxLZXkpIHtcclxuXHRcdHRyeSB7XHJcblx0XHQgIHN1Y2Nlc3MgPSBydW5TbmlwcGV0cyh2aWV3LCBjdHgsIGtleSk7XHJcblx0XHQgIGlmIChzdWNjZXNzKVxyXG5cdFx0XHRyZXR1cm4gdHJ1ZTtcclxuXHRcdH0gY2F0Y2ggKGUpIHtcclxuXHRcdCAgLy9jbGVhclNuaXBwZXRRdWV1ZSh2aWV3KTtcclxuXHRcdCAgY29uc29sZS5lcnJvcihlKTtcclxuXHRcdH1cclxuXHQgIH1cclxuXHR9XHJcblx0aWYgKGtleSA9PT0gXCJUYWJcIikge1xyXG5cdFx0Ly9GaW5hbGx5IGZvdW5kIGl0LlxyXG5cdCAgc3VjY2VzcyA9IHNldFNlbGVjdGlvblRvTmV4dFRhYnN0b3Aodmlldyk7XHJcblx0ICBpZiAoc3VjY2VzcylcclxuXHRcdHJldHVybiB0cnVlO1xyXG5cdH1cclxuXHRpZiAoc2V0dGluZ3MuYXV0b2ZyYWN0aW9uRW5hYmxlZCAmJiBjdHgubW9kZS5zdHJpY3RseUluTWF0aCgpKSB7XHJcblx0ICBpZiAoa2V5ID09PSBcIi9cIikge1xyXG5cdFx0Ly9zdWNjZXNzID0gcnVuQXV0b0ZyYWN0aW9uKHZpZXcsIGN0eCk7XHJcblx0XHRpZiAoc3VjY2VzcylcclxuXHRcdCAgcmV0dXJuIHRydWU7XHJcblx0ICB9XHJcblx0fVxyXG5cdGlmIChzZXR0aW5ncy5tYXRyaXhTaG9ydGN1dHNFbmFibGVkICYmIGN0eC5tb2RlLmJsb2NrTWF0aCkge1xyXG5cdCAgaWYgKFtcIlRhYlwiLCBcIkVudGVyXCJdLmNvbnRhaW5zKGtleSkpIHtcclxuXHRcdC8vc3VjY2VzcyA9IHJ1bk1hdHJpeFNob3J0Y3V0cyh2aWV3LCBjdHgsIGtleSwgc2hpZnRLZXkpO1xyXG5cdFx0aWYgKHN1Y2Nlc3MpXHJcblx0XHQgIHJldHVybiB0cnVlO1xyXG5cdCAgfVxyXG5cdH1cclxuXHRpZiAoc2V0dGluZ3MudGFib3V0RW5hYmxlZCkge1xyXG5cdCAgaWYgKGtleSA9PT0gXCJUYWJcIi8qIHx8IHNob3VsZFRhYm91dEJ5Q2xvc2VCcmFja2V0KHZpZXcsIGtleSkqLykge1xyXG5cdFx0Ly9zdWNjZXNzID0gdGFib3V0KHZpZXcsIGN0eCk7XHJcblx0XHRpZiAoc3VjY2VzcylcclxuXHRcdCAgcmV0dXJuIHRydWU7XHJcblx0ICB9XHJcblx0fVxyXG5cdHJldHVybiBmYWxzZTtcclxufTsiXX0=